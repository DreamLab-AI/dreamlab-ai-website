const u=self.__WB_MANIFEST,l="v2",m=`nostr-bbs-static-${l}`,d=`nostr-bbs-dynamic-${l}`,f=`nostr-bbs-profiles-${l}`,W=`nostr-bbs-fonts-${l}`,g=`nostr-bbs-api-${l}`,y=100,S=200,b=50,A=(u==null?void 0:u.length)>0?u.map(t=>t.url):["/","/index.html","/manifest.json","/favicon.ico"],C="nostr-bbs-queue",r="outgoing-messages",_=1;async function w(){return new Promise((t,e)=>{const s=indexedDB.open(C,_);s.onerror=()=>e(s.error),s.onsuccess=()=>t(s.result),s.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(r)||a.createObjectStore(r,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1})}})}async function k(t){const e=await w();return new Promise((s,n)=>{const o=e.transaction([r],"readwrite").objectStore(r).add(t);o.onsuccess=()=>s(),o.onerror=()=>n(o.error)})}async function E(){const t=await w();return new Promise((e,s)=>{const c=t.transaction([r],"readonly").objectStore(r).getAll();c.onsuccess=()=>e(c.result),c.onerror=()=>s(c.error)})}async function I(t){const e=await w();return new Promise((s,n)=>{const o=e.transaction([r],"readwrite").objectStore(r).delete(t);o.onsuccess=()=>s(),o.onerror=()=>n(o.error)})}async function M(){const t=await w();return new Promise((e,s)=>{const c=t.transaction([r],"readwrite").objectStore(r).clear();c.onsuccess=()=>e(),c.onerror=()=>s(c.error)})}self.addEventListener("install",t=>{console.log("[SW] Installing service worker..."),t.waitUntil((async()=>{await(await caches.open(m)).addAll(A),await self.skipWaiting()})())});self.addEventListener("activate",t=>{console.log("[SW] Activating service worker...");const e=[m,d,f,W,g];t.waitUntil((async()=>{const s=await caches.keys();await Promise.all(s.filter(n=>n.startsWith("nostr-bbs-")&&!e.includes(n)).map(n=>(console.log("[SW] Deleting old cache:",n),caches.delete(n)))),await self.clients.claim(),console.log("[SW] Service worker activated and claimed all clients")})())});function U(t){const e=t.pathname,s=t.hostname;return t.protocol==="wss:"||t.protocol==="ws:"?"network-only":s.includes("fonts.googleapis.com")||s.includes("fonts.gstatic.com")||e.endsWith(".woff2")||e.endsWith(".woff")||e.endsWith(".ttf")||e.endsWith(".otf")||e.endsWith(".js")||e.endsWith(".css")||e.endsWith(".html")||e.endsWith(".ico")||e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")||e.endsWith(".webp")||e.endsWith(".svg")||e.endsWith(".json")||e.endsWith(".webmanifest")?"cache-first":e==="/"||e.startsWith("/chat")||e.startsWith("/dm")||e.startsWith("/settings")||e.startsWith("/events")||e.startsWith("/login")||e.startsWith("/signup")||e.includes("/avatar")||e.includes("/profile")||e.includes("/metadata")||e.includes("/user")||e.startsWith("/api")?"stale-while-revalidate":"network-first"}async function N(t,e){const s=await caches.match(t);if(s)return s;try{const n=await fetch(t);return n.ok&&(await caches.open(e)).put(t,n.clone()),n}catch(n){return console.error("[SW] Cache-first fetch failed:",n),new Response("Offline",{status:503})}}async function P(t,e){try{const s=await fetch(t);return s.ok&&(await caches.open(e)).put(t,s.clone()),s}catch{console.log("[SW] Network failed, trying cache...");const n=await caches.match(t);return n||new Response("Offline",{status:503})}}async function T(t,e){const s=await caches.match(t),n=fetch(t).then(a=>(a.ok&&caches.open(e).then(o=>o.put(t,a.clone())),a)).catch(()=>s||new Response("Offline",{status:503}));return s||n}function j(t){const e=t.hostname,s=t.pathname;return e.includes("fonts.googleapis.com")||e.includes("fonts.gstatic.com")||s.endsWith(".woff2")||s.endsWith(".woff")?W:s.includes("/avatar")||s.includes("/profile")||s.includes("/metadata")?f:s.startsWith("/api")?g:s.endsWith(".js")||s.endsWith(".css")||s.endsWith(".html")||s.endsWith(".png")||s.endsWith(".jpg")||s.endsWith(".svg")?m:d}async function p(t,e){const s=await caches.open(t),n=await s.keys();if(n.length>e){const a=n.slice(0,n.length-e);await Promise.all(a.map(c=>s.delete(c)))}}self.addEventListener("fetch",t=>{const e=new URL(t.request.url);if(t.request.method!=="GET")return;const s=U(e);if(s==="network-only")return;const n=j(e);t.respondWith((async()=>{switch(s){case"cache-first":return N(t.request,n);case"network-first":return P(t.request,n);case"stale-while-revalidate":return T(t.request,n);default:return fetch(t.request)}})()),t.waitUntil((async()=>{n===d?await p(d,y):n===f?await p(f,S):n===g&&await p(g,b)})())});async function O(t,e){return new Promise(s=>{let n=!1,a;try{a=new WebSocket(t)}catch{s(!1);return}const c=i=>{if(!n){n=!0,clearTimeout(o);try{a.close()}catch{}s(i)}},o=setTimeout(()=>c(!1),1e4);a.onopen=()=>{try{a.send(JSON.stringify(["EVENT",e]))}catch{c(!1)}},a.onmessage=i=>{try{const h=JSON.parse(i.data);Array.isArray(h)&&h[0]==="OK"&&h[1]===e.id&&h[2]===!0&&c(!0)}catch{}},a.onerror=()=>c(!1),a.onclose=()=>c(!1)})}self.addEventListener("sync",t=>{const e=t;e.tag==="sync-messages"&&e.waitUntil((async()=>{console.log("[SW] Background sync triggered");try{const s=await E();for(const a of s)try{(await Promise.allSettled(a.relayUrls.map(i=>O(i,a.event)))).some(i=>i.status==="fulfilled"&&i.value===!0)&&await I(a.id)}catch(c){console.error("[SW] Failed to sync message:",c)}(await self.clients.matchAll()).forEach(a=>{a.postMessage({type:"SYNC_COMPLETE",count:s.length})})}catch(s){console.error("[SW] Background sync failed:",s)}})())});self.addEventListener("message",t=>{const{type:e,payload:s}=t.data;switch(e){case"QUEUE_MESSAGE":k(s).then(()=>{var n;(n=t.ports[0])==null||n.postMessage({success:!0})}).catch(n=>{var a;(a=t.ports[0])==null||a.postMessage({success:!1,error:n.message})});break;case"GET_QUEUE":E().then(n=>{var a;(a=t.ports[0])==null||a.postMessage({messages:n})}).catch(n=>{var a;(a=t.ports[0])==null||a.postMessage({error:n.message})});break;case"CLEAR_QUEUE":M().then(()=>{var n;(n=t.ports[0])==null||n.postMessage({success:!0})}).catch(n=>{var a;(a=t.ports[0])==null||a.postMessage({success:!1,error:n.message})});break;case"SKIP_WAITING":self.skipWaiting();break}});self.addEventListener("push",t=>{if(!t.data)return;const e=t.data.json();t.waitUntil(self.registration.showNotification(e.title,{body:e.body,icon:"/icon-192x192.png",badge:"/icon-192x192.png",tag:e.tag||"nostr-bbs",data:e.url}))});self.addEventListener("notificationclick",t=>{t.notification.close(),t.waitUntil(self.clients.matchAll({type:"window"}).then(e=>{const s=t.notification.data||"/";for(const n of e)if(n.url===s&&"focus"in n)return n.focus();if(self.clients.openWindow)return self.clients.openWindow(s)}))});console.log("[SW] Service worker loaded");
