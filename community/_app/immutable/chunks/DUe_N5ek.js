import{n as d,N as f,S as v}from"./DxD0Wn3l.js";import"./aZ5XzadJ.js";const p=9022,g=9023,m=30079,b=1059;async function S(e,n){if(e==="dreamlab-lobby")return{success:!1,error:"This section does not require approval"};try{const s=d();if(!s)return{success:!1,error:"NDK not initialized"};const a=s.signer;if(!a)return{success:!1,error:"No signer available"};if(!(await a.user())?.pubkey)return{success:!1,error:"Unable to get user pubkey"};const r="11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c".split(",").map(u=>u.trim()).filter(Boolean);if(r.length===0)return{success:!1,error:"No admin configured"};const t=new f(s);return t.kind=p,t.content=n||"",t.tags=[["section",e],...r.map(u=>["p",u])],await t.sign(a),await t.publish(),{success:!0,eventId:t.id}}catch(s){return console.error("[Sections] Failed to request access:",s),{success:!1,error:s instanceof Error?s.message:"Failed to publish request"}}}async function E(e){try{const n=d();if(!n)return{success:!1,error:"NDK not initialized"};const s=n.signer;if(!s)return{success:!1,error:"No signer available"};if(!(await s.user())?.pubkey)return{success:!1,error:"Unable to get admin pubkey"};const o=new f(n);o.kind=g,o.content=JSON.stringify({section:e.section,approvedAt:Date.now()}),o.tags=[["section",e.section],["p",e.requesterPubkey],["e",e.id]],await o.sign(s),await o.publish();const t=`Welcome to ${v[e.section].name}! Your access request has been approved. You can now join public channels in this area.`;return await y(e.requesterPubkey,t),{success:!0}}catch(n){return console.error("[Sections] Failed to approve access:",n),{success:!1,error:n instanceof Error?n.message:"Failed to approve"}}}async function y(e,n){try{const s=d();if(!s){console.warn("[Sections] Cannot send DM: NDK not initialized");return}const a=s.signer;if(!a){console.warn("[Sections] Cannot send DM: no signer");return}if(await a.user()){const r=new f(s);r.kind=13,r.tags=[["p",e]],r.content=n,r.created_at=Math.floor(Date.now()/1e3),await r.sign(a);const t=new f(s);t.kind=b,t.tags=[["p",e]],t.content=await a.encrypt({pubkey:e},JSON.stringify(r.rawEvent())),t.created_at=Math.floor(Date.now()/1e3),await t.sign(a),await t.publish()}}catch(s){console.error("[Sections] Failed to send approval DM:",s)}}async function N(){try{const e=d();if(!e)return[];const n="11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c".split(",").map(c=>c.trim()).filter(Boolean);if(n.length===0)return[];const s={kinds:[p],"#p":n,limit:100},a=await e.fetchEvents(s),o=[],r={kinds:[g],limit:500},t=await e.fetchEvents(r),u=new Set(Array.from(t).flatMap(c=>c.tags.filter(i=>i[0]==="e").map(i=>i[1])));for(const c of a){if(u.has(c.id))continue;const i=c.tags.find(l=>l[0]==="section")?.[1];i&&o.push({id:c.id,section:i,requesterPubkey:c.pubkey,requestedAt:(c.created_at||0)*1e3,message:c.content||void 0,status:"pending"})}return o}catch(e){return console.error("[Sections] Failed to fetch requests:",e),[]}}async function A(e){if(!e)return[];try{const n=d();if(!n)return[];const s={kinds:[g],"#p":[e],limit:50},a=await n.fetchEvents(s),o=[];o.push({section:"dreamlab-lobby",status:"approved"});for(const c of a){const i=c.tags.find(h=>h[0]==="section")?.[1];if(!i)continue;let l={};try{l=JSON.parse(c.content)}catch{}o.push({section:i,status:"approved",approvedAt:l.approvedAt||(c.created_at||0)*1e3,approvedBy:c.pubkey})}const r={kinds:[p],authors:[e],limit:10},t=await n.fetchEvents(r),u=new Set(o.map(c=>c.section));for(const c of t){const i=c.tags.find(l=>l[0]==="section")?.[1];!i||u.has(i)||o.push({section:i,status:"pending",requestedAt:(c.created_at||0)*1e3})}return o}catch(n){return console.error("[Sections] Failed to fetch user access:",n),[]}}async function I(){try{const e=d();if(!e)return[];const n={kinds:[m],limit:10},s=await e.fetchEvents(n),a=[];for(const o of s){const r=o.tags.find(u=>u[0]==="d")?.[1];if(!r)continue;let t={};try{t=JSON.parse(o.content)}catch{}a.push({section:r,channelCount:t.channelCount||0,memberCount:t.memberCount||0,messageCount:t.messageCount||0,lastActivity:t.lastActivity||(o.created_at||0)*1e3})}return a}catch(e){return console.error("[Sections] Failed to fetch stats:",e),[]}}function C(e){try{const n=d();if(!n)return null;const s="11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c".split(",").map(r=>r.trim()).filter(Boolean);if(s.length===0)return null;const a={kinds:[p],"#p":s,since:Math.floor(Date.now()/1e3)},o=n.subscribe(a,{closeOnEose:!1});return o.on("event",r=>{const t=r.tags.find(u=>u[0]==="section")?.[1];t&&e({id:r.id,section:t,requesterPubkey:r.pubkey,requestedAt:(r.created_at||0)*1e3,message:r.content||void 0,status:"pending"})}),o}catch(n){return console.error("[Sections] Failed to subscribe to requests:",n),null}}export{E as approveSectionAccess,N as fetchPendingRequests,I as fetchSectionStats,A as fetchUserAccess,S as requestSectionAccess,C as subscribeAccessRequests};
