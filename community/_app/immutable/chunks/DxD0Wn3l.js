const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CF3XGpNG.js","./xKPZ-4ZK.js","./0ZVSoAEn.js","./BPZifr_e.js","./CmsKOCeN.js","./D7m-JnSU.js","./Bk9P-LIi.js","./aZ5XzadJ.js","./DSxRyr52.js","./DFQe3-5X.js","./CTVLmyHZ.js"])))=>i.map(i=>d[i]);
import{_ as __vitePreload}from"./CmsKOCeN.js";import{d as derived,w as writable,b as base}from"./xKPZ-4ZK.js";import{B as get_store_value}from"./0ZVSoAEn.js";import{p as parse$1}from"./BToyndCo.js";function _mergeNamespaces(t,e){for(var n=0;n<e.length;n++){const r=e[n];if(typeof r!="string"&&!Array.isArray(r)){for(const s in r)if(s!=="default"&&!(s in t)){const a=Object.getOwnPropertyDescriptor(r,s);a&&Object.defineProperty(t,s,a.get?a:{enumerable:!0,get:()=>r[s]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}const installPrompt=writable(null),updateAvailable=writable(!1),isOnline=writable(typeof navigator<"u"?navigator.onLine:!0),swRegistration=writable(null),isPWAInstalled=writable(!1);function checkIfPWA(){return typeof window>"u"?!1:!!(window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches||window.matchMedia("(display-mode: minimal-ui)").matches||navigator.standalone===!0||document.referrer.includes("android-app://"))}const PWA_MODE_KEY="nostr_bbs_pwa_mode",queuedMessageCount=writable(0);function initPWA(){if(typeof window>"u")return;window.addEventListener("online",()=>{isOnline.set(!0),triggerBackgroundSync()}),window.addEventListener("offline",()=>{isOnline.set(!1)}),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),installPrompt.set(e)}),window.addEventListener("appinstalled",()=>{isPWAInstalled.set(!0),installPrompt.set(null),localStorage.setItem(PWA_MODE_KEY,"true")}),(checkIfPWA()||localStorage.getItem(PWA_MODE_KEY)==="true")&&(isPWAInstalled.set(!0),localStorage.setItem(PWA_MODE_KEY,"true")),navigator.serviceWorker?.addEventListener("message",e=>{const{type:n,count:r}=e.data;n==="SYNC_COMPLETE"&&(console.log(`[PWA] Background sync completed: ${r} messages`),queuedMessageCount.set(0))})}async function triggerInstall(){const t=get_store_value(installPrompt);if(!t)return console.warn("[PWA] Install prompt not available"),!1;try{await t.prompt();const{outcome:e}=await t.userChoice;return e==="accepted"?(isPWAInstalled.set(!0),installPrompt.set(null),!0):!1}catch(e){return console.error("[PWA] Install prompt failed:",e),!1}}const UPDATE_CHECK_INTERVAL_PWA=60*60*1e3,UPDATE_CHECK_INTERVAL_BROWSER=4*60*60*1e3;let updateCheckInterval=null;async function registerServiceWorker(){if(typeof navigator>"u"||!("serviceWorker"in navigator))return console.warn("[PWA] Service workers not supported"),null;try{const t=`${base}/service-worker.js`,e=`${base}/`,n=await navigator.serviceWorker.register(t,{scope:e});return console.log("[PWA] Service worker registered:",n),swRegistration.set(n),n.addEventListener("updatefound",()=>{const r=n.installing;r&&(console.log("[PWA] New service worker installing..."),r.addEventListener("statechange",()=>{r.state==="installed"&&(navigator.serviceWorker.controller?(console.log("[PWA] New version available"),updateAvailable.set(!0)):console.log("[PWA] Service worker installed for the first time"))}))}),startUpdateChecks(n),n}catch(t){return console.error("[PWA] Service worker registration failed:",t),null}}function startUpdateChecks(t){updateCheckInterval&&clearInterval(updateCheckInterval);const n=checkIfPWA()||localStorage.getItem(PWA_MODE_KEY)==="true"?UPDATE_CHECK_INTERVAL_PWA:UPDATE_CHECK_INTERVAL_BROWSER;updateCheckInterval=setInterval(()=>{checkForUpdates(t)},n),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&checkForUpdates(t)})}async function checkForUpdates(t){const e=t||get_store_value(swRegistration);if(e)try{await e.update(),console.log("[PWA] Update check completed")}catch(n){console.error("[PWA] Update check failed:",n)}}async function updateServiceWorker(){const t=get_store_value(swRegistration);if(!t?.waiting){console.warn("[PWA] No waiting service worker");return}t.waiting.postMessage({type:"SKIP_WAITING"}),navigator.serviceWorker.addEventListener("controllerchange",()=>{window.location.reload()})}async function getQueuedMessages(){const t=get_store_value(swRegistration);return t?.active?new Promise((e,n)=>{const r=new MessageChannel;r.port1.onmessage=s=>{s.data.messages?(queuedMessageCount.set(s.data.messages.length),e(s.data.messages)):n(new Error(s.data.error))},t.active.postMessage({type:"GET_QUEUE"},[r.port2])}):[]}async function triggerBackgroundSync(){const t=get_store_value(swRegistration);if(!t||!("sync"in t)){console.warn("[PWA] Background sync not supported");return}try{const e=t.sync;e&&(await e.register("sync-messages"),console.log("[PWA] Background sync registered"))}catch(e){console.error("[PWA] Background sync failed:",e)}}const canInstall=derived([installPrompt,isPWAInstalled],([t,e])=>t!==null&&!e);function hasNip07Extension(){return typeof window.nostr<"u"}async function waitForNip07(t=2e3){return hasNip07Extension()?!0:new Promise(e=>{const n=Date.now(),r=()=>{hasNip07Extension()?e(!0):Date.now()-n>t?e(!1):setTimeout(r,100)};r()})}async function getPublicKeyFromExtension(){if(!window.nostr)throw new Error("No NIP-07 extension available");try{const t=await window.nostr.getPublicKey();if(!/^[0-9a-f]{64}$/i.test(t))throw new Error("Invalid public key format from extension");return t}catch(t){throw t instanceof Error&&t.message.includes("User rejected")?new Error("Extension access denied by user"):t}}function getExtensionName(){if(!window.nostr)return"Unknown";const t=window.nostr;return t?._name?t._name:t?.isAlby?"Alby":t?.nos2x?"nos2x":"Browser Extension"}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var lib$1={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},utils$3={};Object.defineProperty(utils$3,"__esModule",{value:!0});utils$3._fast_remove_single=void 0;function _fast_remove_single(t,e){e!==-1&&(e===0?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}utils$3._fast_remove_single=_fast_remove_single;var bakeCollection={};(function(exports$1){Object.defineProperty(exports$1,"__esModule",{value:!0}),exports$1.bakeCollectionVariadic=exports$1.bakeCollectionAwait=exports$1.bakeCollection=exports$1.BAKED_EMPTY_FUNC=void 0,exports$1.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(t){var e="";if(t===0)return e;for(var n=0;n<t-1;++n)e+="arg"+String(n)+", ";return e+="arg"+String(t-1),e}function generateBodyPartsCode(t,e){for(var n="",r="",s=0;s<e;++s)n+="var f".concat(s," = collection[").concat(s,`];
`),r+="f".concat(s,"(").concat(t,`)
`);return{funcDefCode:n,funcCallCode:r}}function generateBodyPartsVariadicCode(t){for(var e="",n="",r=0;r<t;++r)e+="var f".concat(r," = collection[").concat(r,`];
`),n+="f".concat(r,`.apply(undefined, arguments)
`);return{funcDefCode:e,funcCallCode:n}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,a;r<s;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return t.concat(a||Array.prototype.slice.call(e))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=void 0;var utils_1$1=utils$3,bake_collection_1=bakeCollection;function push_norebuild(t,e){var n=this.length;if(n>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++}function push_rebuild(t,e){var n=this.length;if(n>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function removeLast_norebuild(t){this.length!==0&&(this.length===1?this._tasks===t&&(this.length=0):((0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(t){if(this.length!==0){if(this.length===1)if(this._tasks===t&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length)}function insert_rebuild(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function t(e,n,r,s){n===void 0&&(n=!0),r===void 0&&(r=null),s===void 0&&(s=!1),this.awaitTasks=s,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=e,this.firstEmitBuildStrategy=!0,s?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(n),r?typeof r=="function"?(this._tasks=r,this.length=1):(this._tasks=r,this.length=r.length):(this._tasks=null,this.length=0),n&&this.rebuild()}return t}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(t){this.argsNum<t&&(this.argsNum=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(t){t?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(t){t.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):t.length===1?(this.length=1,this.call=t[0],this._tasks=t[0]):(this.length=t.length,this._tasks=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,a,o){o===void 0&&(o=a);var l=Object.getOwnPropertyDescriptor(s,a);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[a]}}),Object.defineProperty(r,o,l)}:function(r,s,a,o){o===void 0&&(o=a),r[o]=s[a]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var a in r)a!=="default"&&!Object.prototype.hasOwnProperty.call(s,a)&&e(s,r,a)};Object.defineProperty(t,"__esModule",{value:!0}),n(taskCollection,t)})(taskCollection$1);var utils$2={};Object.defineProperty(utils$2,"__esModule",{value:!0});utils$2.nullObj=void 0;function nullObj(){var t={};return t.__proto__=null,t}utils$2.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,a;r<s;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return t.concat(a||Array.prototype.slice.call(e))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils$3,utils_2=utils$2;function emit(t,e,n,r,s,a){var o=this.events[t];if(o){if(o.length===0)return!1;if(o.argsNum<6)o.call(e,n,r,s,a);else{for(var l=new Array(o.argsNum),h=0,y=l.length;h<y;++h)l[h]=arguments[h+1];o.call.apply(void 0,l)}return!0}return!1}function emitHasOnce(t,e,n,r,s,a){var o=this.events[t],l;if(o!==void 0){if(o.length===0)return!1;if(o.argsNum<6)o.call(e,n,r,s,a);else{l=new Array(o.argsNum);for(var h=0,y=l.length;h<y;++h)l[h]=arguments[h+1];o.call.apply(void 0,l)}}var p=this.onceEvents[t];if(p){if(typeof p=="function")if(this.onceEvents[t]=void 0,arguments.length<6)p(e,n,r,s,a);else{if(l===void 0){l=new Array(arguments.length-1);for(var h=0,y=l.length;h<y;++h)l[h]=arguments[h+1]}p.apply(void 0,l)}else{var m=p;if(this.onceEvents[t]=void 0,arguments.length<6)for(var h=0;h<m.length;++h)m[h](e,n,r,s,a);else{if(l===void 0){l=new Array(arguments.length-1);for(var h=0,y=l.length;h<y;++h)l[h]=arguments[h+1]}for(var h=0;h<m.length;++h)m[h].apply(void 0,l)}}return!0}return o!==void 0}var EventEmitter=function(){function t(){this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(t.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),t}();ee.EventEmitter=EventEmitter;function once(t,e){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[t]){case"undefined":this.onceEvents[t]=e,typeof t=="symbol"&&this._symbolKeys.add(t);break;case"function":this.onceEvents[t]=[this.onceEvents[t],e];break;case"object":this.onceEvents[t].push(e)}return this}function addListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[t];return r?(r.push(e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeListener(t,e){var n=this.events[t];n&&n.removeLast(e);var r=this.onceEvents[t];return r&&(typeof r=="function"?this.onceEvents[t]=void 0:typeof r=="object"&&(r.length===1&&r[0]===e?this.onceEvents[t]=void 0:(0,utils_1._fast_remove_single)(r,r.lastIndexOf(e)))),this}function addListenerBound(t,e,n,r){n===void 0&&(n=this),r===void 0&&(r=e.length),this.boundFuncs||(this.boundFuncs=new Map);var s=e.bind(n);return this.boundFuncs.set(e,s),this.addListener(t,s,r)}function removeListenerBound(t,e){var n,r,s=(n=this.boundFuncs)===null||n===void 0?void 0:n.get(e);return(r=this.boundFuncs)===null||r===void 0||r.delete(e),this.removeListener(t,s)}function hasListeners(t){return this.events[t]&&!!this.events[t].length}function prependListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[t];return!r||!(r instanceof task_collection_1.TaskCollection)?(r=this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)):(r.insert(0,e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))),this}function prependOnceListener(t,e){this.emit===emit&&(this.emit=emitHasOnce);var n=this.onceEvents[t];return n?typeof n!="object"?(this.onceEvents[t]=[e,n],typeof t=="symbol"&&this._symbolKeys.add(t)):(n.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" once event!'))):(this.onceEvents[t]=[e],typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeAllListeners(t){return t===void 0?(this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set):(this.events[t]=void 0,this.onceEvents[t]=void 0,typeof t=="symbol"&&this._symbolKeys.delete(t)),this}function setMaxListeners(t){return this.maxListeners=t,this}function getMaxListeners(){return this.maxListeners}function listeners(t){return this.emit===emit?this.events[t]?this.events[t].tasksAsArray().slice():[]:this.events[t]&&this.onceEvents[t]?__spreadArray(__spreadArray([],this.events[t].tasksAsArray(),!0),typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t],!0):this.events[t]?this.events[t].tasksAsArray():this.onceEvents[t]?typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t]:[]}function eventNames(){var t=this;if(this.emit===emit){var e=Object.keys(this.events);return __spreadArray(__spreadArray([],e,!0),Array.from(this._symbolKeys),!0).filter(function(r){return r in t.events&&t.events[r]&&t.events[r].length})}else{var e=Object.keys(this.events).filter(function(s){return t.events[s]&&t.events[s].length}),n=Object.keys(this.onceEvents).filter(function(s){return t.onceEvents[s]&&t.onceEvents[s].length});return __spreadArray(__spreadArray(__spreadArray([],e,!0),n,!0),Array.from(this._symbolKeys).filter(function(s){return s in t.events&&t.events[s]&&t.events[s].length||s in t.onceEvents&&t.onceEvents[s]&&t.onceEvents[s].length}),!0)}}function listenerCount(t){return this.emit===emit?this.events[t]&&this.events[t].length||0:(this.events[t]&&this.events[t].length||0)+(this.onceEvents[t]&&this.onceEvents[t].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,a,o){o===void 0&&(o=a);var l=Object.getOwnPropertyDescriptor(s,a);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[a]}}),Object.defineProperty(r,o,l)}:function(r,s,a,o){o===void 0&&(o=a),r[o]=s[a]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var a in r)a!=="default"&&!Object.prototype.hasOwnProperty.call(s,a)&&e(s,r,a)};Object.defineProperty(t,"__esModule",{value:!0}),n(types,t),n(ee,t)})(lib$1);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var t=1e3,e=t*60,n=e*60,r=n*24,s=r*7,a=r*365.25;ms=function(p,m){m=m||{};var v=typeof p;if(v==="string"&&p.length>0)return o(p);if(v==="number"&&isFinite(p))return m.long?h(p):l(p);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(p))};function o(p){if(p=String(p),!(p.length>100)){var m=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(p);if(m){var v=parseFloat(m[1]),_=(m[2]||"ms").toLowerCase();switch(_){case"years":case"year":case"yrs":case"yr":case"y":return v*a;case"weeks":case"week":case"w":return v*s;case"days":case"day":case"d":return v*r;case"hours":case"hour":case"hrs":case"hr":case"h":return v*n;case"minutes":case"minute":case"mins":case"min":case"m":return v*e;case"seconds":case"second":case"secs":case"sec":case"s":return v*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return v;default:return}}}}function l(p){var m=Math.abs(p);return m>=r?Math.round(p/r)+"d":m>=n?Math.round(p/n)+"h":m>=e?Math.round(p/e)+"m":m>=t?Math.round(p/t)+"s":p+"ms"}function h(p){var m=Math.abs(p);return m>=r?y(p,m,r,"day"):m>=n?y(p,m,n,"hour"):m>=e?y(p,m,e,"minute"):m>=t?y(p,m,t,"second"):p+" ms"}function y(p,m,v,_){var S=m>=v*1.5;return Math.round(p/v)+" "+_+(S?"s":"")}return ms}function setup(t){n.debug=n,n.default=n,n.coerce=h,n.disable=o,n.enable=s,n.enabled=l,n.humanize=requireMs(),n.destroy=y,Object.keys(t).forEach(p=>{n[p]=t[p]}),n.names=[],n.skips=[],n.formatters={};function e(p){let m=0;for(let v=0;v<p.length;v++)m=(m<<5)-m+p.charCodeAt(v),m|=0;return n.colors[Math.abs(m)%n.colors.length]}n.selectColor=e;function n(p){let m,v=null,_,S;function T(...k){if(!T.enabled)return;const O=T,q=Number(new Date),z=q-(m||q);O.diff=z,O.prev=m,O.curr=q,m=q,k[0]=n.coerce(k[0]),typeof k[0]!="string"&&k.unshift("%O");let Q=0;k[0]=k[0].replace(/%([a-zA-Z%])/g,(ie,te)=>{if(ie==="%%")return"%";Q++;const ae=n.formatters[te];if(typeof ae=="function"){const ne=k[Q];ie=ae.call(O,ne),k.splice(Q,1),Q--}return ie}),n.formatArgs.call(O,k),(O.log||n.log).apply(O,k)}return T.namespace=p,T.useColors=n.useColors(),T.color=n.selectColor(p),T.extend=r,T.destroy=n.destroy,Object.defineProperty(T,"enabled",{enumerable:!0,configurable:!1,get:()=>v!==null?v:(_!==n.namespaces&&(_=n.namespaces,S=n.enabled(p)),S),set:k=>{v=k}}),typeof n.init=="function"&&n.init(T),T}function r(p,m){const v=n(this.namespace+(typeof m>"u"?":":m)+p);return v.log=this.log,v}function s(p){n.save(p),n.namespaces=p,n.names=[],n.skips=[];const m=(typeof p=="string"?p:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const v of m)v[0]==="-"?n.skips.push(v.slice(1)):n.names.push(v)}function a(p,m){let v=0,_=0,S=-1,T=0;for(;v<p.length;)if(_<m.length&&(m[_]===p[v]||m[_]==="*"))m[_]==="*"?(S=_,T=v,_++):(v++,_++);else if(S!==-1)_=S+1,T++,v=T;else return!1;for(;_<m.length&&m[_]==="*";)_++;return _===m.length}function o(){const p=[...n.names,...n.skips.map(m=>"-"+m)].join(",");return n.enable(""),p}function l(p){for(const m of n.skips)if(a(p,m))return!1;for(const m of n.names)if(a(p,m))return!0;return!1}function h(p){return p instanceof Error?p.stack||p.message:p}function y(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}var common=setup;(function(t,e){var n={};e.formatArgs=s,e.save=a,e.load=o,e.useColors=r,e.storage=l(),e.destroy=(()=>{let y=!1;return()=>{y||(y=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let y;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(y=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(y[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(y){if(y[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+y[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const p="color: "+this.color;y.splice(1,0,p,"color: inherit");let m=0,v=0;y[0].replace(/%[a-zA-Z%]/g,_=>{_!=="%%"&&(m++,_==="%c"&&(v=m))}),y.splice(v,0,p)}e.log=console.debug||console.log||(()=>{});function a(y){try{y?e.storage.setItem("debug",y):e.storage.removeItem("debug")}catch{}}function o(){let y;try{y=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!y&&typeof process<"u"&&"env"in process&&(y=n.DEBUG),y}function l(){try{return localStorage}catch{}}t.exports=common(e);const{formatters:h}=t.exports;h.j=function(y){try{return JSON.stringify(y)}catch(p){return"[UnexpectedJSONParseError]: "+p.message}}})(browser,browser.exports);var browserExports=browser.exports;const createDebug2=getDefaultExportFromCjs(browserExports);var sha256$1={},sha2={},_md={},utils$1={},crypto$1={};Object.defineProperty(crypto$1,"__esModule",{value:!0});crypto$1.crypto=void 0;crypto$1.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;(function(t){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(t,"__esModule",{value:!0}),t.wrapXOFConstructorWithOpts=t.wrapConstructorWithOpts=t.wrapConstructor=t.Hash=t.nextTick=t.swap32IfBE=t.byteSwapIfBE=t.swap8IfBE=t.isLE=void 0,t.isBytes=n,t.anumber=r,t.abytes=s,t.ahash=a,t.aexists=o,t.aoutput=l,t.u8=h,t.u32=y,t.clean=p,t.createView=m,t.rotr=v,t.rotl=_,t.byteSwap=S,t.byteSwap32=T,t.bytesToHex=q,t.hexToBytes=ye,t.asyncLoop=te,t.utf8ToBytes=ae,t.bytesToUtf8=ne,t.toBytes=me,t.kdfInputToBytes=B,t.concatBytes=F,t.checkOpts=j,t.createHasher=V,t.createOptHasher=W,t.createXOFer=Z,t.randomBytes=oe;const e=crypto$1;function n(A){return A instanceof Uint8Array||ArrayBuffer.isView(A)&&A.constructor.name==="Uint8Array"}function r(A){if(!Number.isSafeInteger(A)||A<0)throw new Error("positive integer expected, got "+A)}function s(A,...J){if(!n(A))throw new Error("Uint8Array expected");if(J.length>0&&!J.includes(A.length))throw new Error("Uint8Array expected of length "+J+", got length="+A.length)}function a(A){if(typeof A!="function"||typeof A.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");r(A.outputLen),r(A.blockLen)}function o(A,J=!0){if(A.destroyed)throw new Error("Hash instance has been destroyed");if(J&&A.finished)throw new Error("Hash#digest() has already been called")}function l(A,J){s(A);const X=J.outputLen;if(A.length<X)throw new Error("digestInto() expects output buffer of length at least "+X)}function h(A){return new Uint8Array(A.buffer,A.byteOffset,A.byteLength)}function y(A){return new Uint32Array(A.buffer,A.byteOffset,Math.floor(A.byteLength/4))}function p(...A){for(let J=0;J<A.length;J++)A[J].fill(0)}function m(A){return new DataView(A.buffer,A.byteOffset,A.byteLength)}function v(A,J){return A<<32-J|A>>>J}function _(A,J){return A<<J|A>>>32-J>>>0}t.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function S(A){return A<<24&4278190080|A<<8&16711680|A>>>8&65280|A>>>24&255}t.swap8IfBE=t.isLE?A=>A:A=>S(A),t.byteSwapIfBE=t.swap8IfBE;function T(A){for(let J=0;J<A.length;J++)A[J]=S(A[J]);return A}t.swap32IfBE=t.isLE?A=>A:T;const k=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",O=Array.from({length:256},(A,J)=>J.toString(16).padStart(2,"0"));function q(A){if(s(A),k)return A.toHex();let J="";for(let X=0;X<A.length;X++)J+=O[A[X]];return J}const z={_0:48,_9:57,A:65,F:70,a:97,f:102};function Q(A){if(A>=z._0&&A<=z._9)return A-z._0;if(A>=z.A&&A<=z.F)return A-(z.A-10);if(A>=z.a&&A<=z.f)return A-(z.a-10)}function ye(A){if(typeof A!="string")throw new Error("hex string expected, got "+typeof A);if(k)return Uint8Array.fromHex(A);const J=A.length,X=J/2;if(J%2)throw new Error("hex string expected, got unpadded hex of length "+J);const de=new Uint8Array(X);for(let ve=0,we=0;ve<X;ve++,we+=2){const $e=Q(A.charCodeAt(we)),Re=Q(A.charCodeAt(we+1));if($e===void 0||Re===void 0){const De=A[we]+A[we+1];throw new Error('hex string expected, got non-hex character "'+De+'" at index '+we)}de[ve]=$e*16+Re}return de}const ie=async()=>{};t.nextTick=ie;async function te(A,J,X){let de=Date.now();for(let ve=0;ve<A;ve++){X(ve);const we=Date.now()-de;we>=0&&we<J||(await(0,t.nextTick)(),de+=we)}}function ae(A){if(typeof A!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(A))}function ne(A){return new TextDecoder().decode(A)}function me(A){return typeof A=="string"&&(A=ae(A)),s(A),A}function B(A){return typeof A=="string"&&(A=ae(A)),s(A),A}function F(...A){let J=0;for(let de=0;de<A.length;de++){const ve=A[de];s(ve),J+=ve.length}const X=new Uint8Array(J);for(let de=0,ve=0;de<A.length;de++){const we=A[de];X.set(we,ve),ve+=we.length}return X}function j(A,J){if(J!==void 0&&{}.toString.call(J)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(A,J)}class H{}t.Hash=H;function V(A){const J=de=>A().update(me(de)).digest(),X=A();return J.outputLen=X.outputLen,J.blockLen=X.blockLen,J.create=()=>A(),J}function W(A){const J=(de,ve)=>A(ve).update(me(de)).digest(),X=A({});return J.outputLen=X.outputLen,J.blockLen=X.blockLen,J.create=de=>A(de),J}function Z(A){const J=(de,ve)=>A(ve).update(me(de)).digest(),X=A({});return J.outputLen=X.outputLen,J.blockLen=X.blockLen,J.create=de=>A(de),J}t.wrapConstructor=V,t.wrapConstructorWithOpts=W,t.wrapXOFConstructorWithOpts=Z;function oe(A=32){if(e.crypto&&typeof e.crypto.getRandomValues=="function")return e.crypto.getRandomValues(new Uint8Array(A));if(e.crypto&&typeof e.crypto.randomBytes=="function")return Uint8Array.from(e.crypto.randomBytes(A));throw new Error("crypto.getRandomValues must be defined")}})(utils$1);const utils=_mergeNamespaces({__proto__:null},[utils$1]);Object.defineProperty(_md,"__esModule",{value:!0});_md.SHA512_IV=_md.SHA384_IV=_md.SHA224_IV=_md.SHA256_IV=_md.HashMD=void 0;_md.setBigUint64=setBigUint64$1;_md.Chi=Chi;_md.Maj=Maj;const utils_ts_1$4=utils$1;function setBigUint64$1(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),a=BigInt(4294967295),o=Number(n>>s&a),l=Number(n&a),h=r?4:0,y=r?0:4;t.setUint32(e+h,o,r),t.setUint32(e+y,l,r)}function Chi(t,e,n){return t&e^~t&n}function Maj(t,e,n){return t&e^t&n^e&n}class HashMD extends utils_ts_1$4.Hash{constructor(e,n,r,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(e),this.view=(0,utils_ts_1$4.createView)(this.buffer)}update(e){(0,utils_ts_1$4.aexists)(this),e=(0,utils_ts_1$4.toBytes)(e),(0,utils_ts_1$4.abytes)(e);const{view:n,buffer:r,blockLen:s}=this,a=e.length;for(let o=0;o<a;){const l=Math.min(s-this.pos,a-o);if(l===s){const h=(0,utils_ts_1$4.createView)(e);for(;s<=a-o;o+=s)this.process(h,o);continue}r.set(e.subarray(o,o+l),this.pos),this.pos+=l,o+=l,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){(0,utils_ts_1$4.aexists)(this),(0,utils_ts_1$4.aoutput)(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:a}=this;let{pos:o}=this;n[o++]=128,(0,utils_ts_1$4.clean)(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(r,0),o=0);for(let m=o;m<s;m++)n[m]=0;setBigUint64$1(r,s-8,BigInt(this.length*8),a),this.process(r,0);const l=(0,utils_ts_1$4.createView)(e),h=this.outputLen;if(h%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const y=h/4,p=this.get();if(y>p.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<y;m++)l.setUint32(4*m,p[m],a)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:a,destroyed:o,pos:l}=this;return e.destroyed=o,e.finished=a,e.length=s,e.pos=l,s%n&&e.buffer.set(r),e}clone(){return this._cloneInto()}}_md.HashMD=HashMD;_md.SHA256_IV=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);_md.SHA224_IV=Uint32Array.from([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]);_md.SHA384_IV=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]);_md.SHA512_IV=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var _u64={};Object.defineProperty(_u64,"__esModule",{value:!0});_u64.toBig=_u64.shrSL=_u64.shrSH=_u64.rotrSL=_u64.rotrSH=_u64.rotrBL=_u64.rotrBH=_u64.rotr32L=_u64.rotr32H=_u64.rotlSL=_u64.rotlSH=_u64.rotlBL=_u64.rotlBH=_u64.add5L=_u64.add5H=_u64.add4L=_u64.add4H=_u64.add3L=_u64.add3H=void 0;_u64.add=add$1;_u64.fromBig=fromBig;_u64.split=split;const U32_MASK64=BigInt(2**32-1),_32n=BigInt(32);function fromBig(t,e=!1){return e?{h:Number(t&U32_MASK64),l:Number(t>>_32n&U32_MASK64)}:{h:Number(t>>_32n&U32_MASK64)|0,l:Number(t&U32_MASK64)|0}}function split(t,e=!1){const n=t.length;let r=new Uint32Array(n),s=new Uint32Array(n);for(let a=0;a<n;a++){const{h:o,l}=fromBig(t[a],e);[r[a],s[a]]=[o,l]}return[r,s]}const toBig=(t,e)=>BigInt(t>>>0)<<_32n|BigInt(e>>>0);_u64.toBig=toBig;const shrSH=(t,e,n)=>t>>>n;_u64.shrSH=shrSH;const shrSL=(t,e,n)=>t<<32-n|e>>>n;_u64.shrSL=shrSL;const rotrSH=(t,e,n)=>t>>>n|e<<32-n;_u64.rotrSH=rotrSH;const rotrSL=(t,e,n)=>t<<32-n|e>>>n;_u64.rotrSL=rotrSL;const rotrBH=(t,e,n)=>t<<64-n|e>>>n-32;_u64.rotrBH=rotrBH;const rotrBL=(t,e,n)=>t>>>n-32|e<<64-n;_u64.rotrBL=rotrBL;const rotr32H=(t,e)=>e;_u64.rotr32H=rotr32H;const rotr32L=(t,e)=>t;_u64.rotr32L=rotr32L;const rotlSH=(t,e,n)=>t<<n|e>>>32-n;_u64.rotlSH=rotlSH;const rotlSL=(t,e,n)=>e<<n|t>>>32-n;_u64.rotlSL=rotlSL;const rotlBH=(t,e,n)=>e<<n-32|t>>>64-n;_u64.rotlBH=rotlBH;const rotlBL=(t,e,n)=>t<<n-32|e>>>64-n;_u64.rotlBL=rotlBL;function add$1(t,e,n,r){const s=(e>>>0)+(r>>>0);return{h:t+n+(s/2**32|0)|0,l:s|0}}const add3L=(t,e,n)=>(t>>>0)+(e>>>0)+(n>>>0);_u64.add3L=add3L;const add3H=(t,e,n,r)=>e+n+r+(t/2**32|0)|0;_u64.add3H=add3H;const add4L=(t,e,n,r)=>(t>>>0)+(e>>>0)+(n>>>0)+(r>>>0);_u64.add4L=add4L;const add4H=(t,e,n,r,s)=>e+n+r+s+(t/2**32|0)|0;_u64.add4H=add4H;const add5L=(t,e,n,r,s)=>(t>>>0)+(e>>>0)+(n>>>0)+(r>>>0)+(s>>>0);_u64.add5L=add5L;const add5H=(t,e,n,r,s,a)=>e+n+r+s+a+(t/2**32|0)|0;_u64.add5H=add5H;const u64$1={fromBig,split,toBig,shrSH,shrSL,rotrSH,rotrSL,rotrBH,rotrBL,rotr32H,rotr32L,rotlSH,rotlSL,rotlBH,rotlBL,add:add$1,add3L,add3H,add4L,add4H,add5H,add5L};_u64.default=u64$1;Object.defineProperty(sha2,"__esModule",{value:!0});sha2.sha512_224=sha2.sha512_256=sha2.sha384=sha512=sha2.sha512=sha2.sha224=sha256=sha2.sha256=sha2.SHA512_256=sha2.SHA512_224=sha2.SHA384=sha2.SHA512=sha2.SHA224=sha2.SHA256=void 0;const _md_ts_1=_md,u64=_u64,utils_ts_1$3=utils$1,SHA256_K=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_W=new Uint32Array(64);class SHA256 extends _md_ts_1.HashMD{constructor(e=32){super(64,e,8,!1),this.A=_md_ts_1.SHA256_IV[0]|0,this.B=_md_ts_1.SHA256_IV[1]|0,this.C=_md_ts_1.SHA256_IV[2]|0,this.D=_md_ts_1.SHA256_IV[3]|0,this.E=_md_ts_1.SHA256_IV[4]|0,this.F=_md_ts_1.SHA256_IV[5]|0,this.G=_md_ts_1.SHA256_IV[6]|0,this.H=_md_ts_1.SHA256_IV[7]|0}get(){const{A:e,B:n,C:r,D:s,E:a,F:o,G:l,H:h}=this;return[e,n,r,s,a,o,l,h]}set(e,n,r,s,a,o,l,h){this.A=e|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=a|0,this.F=o|0,this.G=l|0,this.H=h|0}process(e,n){for(let m=0;m<16;m++,n+=4)SHA256_W[m]=e.getUint32(n,!1);for(let m=16;m<64;m++){const v=SHA256_W[m-15],_=SHA256_W[m-2],S=(0,utils_ts_1$3.rotr)(v,7)^(0,utils_ts_1$3.rotr)(v,18)^v>>>3,T=(0,utils_ts_1$3.rotr)(_,17)^(0,utils_ts_1$3.rotr)(_,19)^_>>>10;SHA256_W[m]=T+SHA256_W[m-7]+S+SHA256_W[m-16]|0}let{A:r,B:s,C:a,D:o,E:l,F:h,G:y,H:p}=this;for(let m=0;m<64;m++){const v=(0,utils_ts_1$3.rotr)(l,6)^(0,utils_ts_1$3.rotr)(l,11)^(0,utils_ts_1$3.rotr)(l,25),_=p+v+(0,_md_ts_1.Chi)(l,h,y)+SHA256_K[m]+SHA256_W[m]|0,T=((0,utils_ts_1$3.rotr)(r,2)^(0,utils_ts_1$3.rotr)(r,13)^(0,utils_ts_1$3.rotr)(r,22))+(0,_md_ts_1.Maj)(r,s,a)|0;p=y,y=h,h=l,l=o+_|0,o=a,a=s,s=r,r=_+T|0}r=r+this.A|0,s=s+this.B|0,a=a+this.C|0,o=o+this.D|0,l=l+this.E|0,h=h+this.F|0,y=y+this.G|0,p=p+this.H|0,this.set(r,s,a,o,l,h,y,p)}roundClean(){(0,utils_ts_1$3.clean)(SHA256_W)}destroy(){this.set(0,0,0,0,0,0,0,0),(0,utils_ts_1$3.clean)(this.buffer)}}sha2.SHA256=SHA256;class SHA224 extends SHA256{constructor(){super(28),this.A=_md_ts_1.SHA224_IV[0]|0,this.B=_md_ts_1.SHA224_IV[1]|0,this.C=_md_ts_1.SHA224_IV[2]|0,this.D=_md_ts_1.SHA224_IV[3]|0,this.E=_md_ts_1.SHA224_IV[4]|0,this.F=_md_ts_1.SHA224_IV[5]|0,this.G=_md_ts_1.SHA224_IV[6]|0,this.H=_md_ts_1.SHA224_IV[7]|0}}sha2.SHA224=SHA224;const K512=u64.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(t=>BigInt(t))),SHA512_Kh=K512[0],SHA512_Kl=K512[1],SHA512_W_H=new Uint32Array(80),SHA512_W_L=new Uint32Array(80);class SHA512 extends _md_ts_1.HashMD{constructor(e=64){super(128,e,16,!1),this.Ah=_md_ts_1.SHA512_IV[0]|0,this.Al=_md_ts_1.SHA512_IV[1]|0,this.Bh=_md_ts_1.SHA512_IV[2]|0,this.Bl=_md_ts_1.SHA512_IV[3]|0,this.Ch=_md_ts_1.SHA512_IV[4]|0,this.Cl=_md_ts_1.SHA512_IV[5]|0,this.Dh=_md_ts_1.SHA512_IV[6]|0,this.Dl=_md_ts_1.SHA512_IV[7]|0,this.Eh=_md_ts_1.SHA512_IV[8]|0,this.El=_md_ts_1.SHA512_IV[9]|0,this.Fh=_md_ts_1.SHA512_IV[10]|0,this.Fl=_md_ts_1.SHA512_IV[11]|0,this.Gh=_md_ts_1.SHA512_IV[12]|0,this.Gl=_md_ts_1.SHA512_IV[13]|0,this.Hh=_md_ts_1.SHA512_IV[14]|0,this.Hl=_md_ts_1.SHA512_IV[15]|0}get(){const{Ah:e,Al:n,Bh:r,Bl:s,Ch:a,Cl:o,Dh:l,Dl:h,Eh:y,El:p,Fh:m,Fl:v,Gh:_,Gl:S,Hh:T,Hl:k}=this;return[e,n,r,s,a,o,l,h,y,p,m,v,_,S,T,k]}set(e,n,r,s,a,o,l,h,y,p,m,v,_,S,T,k){this.Ah=e|0,this.Al=n|0,this.Bh=r|0,this.Bl=s|0,this.Ch=a|0,this.Cl=o|0,this.Dh=l|0,this.Dl=h|0,this.Eh=y|0,this.El=p|0,this.Fh=m|0,this.Fl=v|0,this.Gh=_|0,this.Gl=S|0,this.Hh=T|0,this.Hl=k|0}process(e,n){for(let z=0;z<16;z++,n+=4)SHA512_W_H[z]=e.getUint32(n),SHA512_W_L[z]=e.getUint32(n+=4);for(let z=16;z<80;z++){const Q=SHA512_W_H[z-15]|0,ye=SHA512_W_L[z-15]|0,ie=u64.rotrSH(Q,ye,1)^u64.rotrSH(Q,ye,8)^u64.shrSH(Q,ye,7),te=u64.rotrSL(Q,ye,1)^u64.rotrSL(Q,ye,8)^u64.shrSL(Q,ye,7),ae=SHA512_W_H[z-2]|0,ne=SHA512_W_L[z-2]|0,me=u64.rotrSH(ae,ne,19)^u64.rotrBH(ae,ne,61)^u64.shrSH(ae,ne,6),B=u64.rotrSL(ae,ne,19)^u64.rotrBL(ae,ne,61)^u64.shrSL(ae,ne,6),F=u64.add4L(te,B,SHA512_W_L[z-7],SHA512_W_L[z-16]),j=u64.add4H(F,ie,me,SHA512_W_H[z-7],SHA512_W_H[z-16]);SHA512_W_H[z]=j|0,SHA512_W_L[z]=F|0}let{Ah:r,Al:s,Bh:a,Bl:o,Ch:l,Cl:h,Dh:y,Dl:p,Eh:m,El:v,Fh:_,Fl:S,Gh:T,Gl:k,Hh:O,Hl:q}=this;for(let z=0;z<80;z++){const Q=u64.rotrSH(m,v,14)^u64.rotrSH(m,v,18)^u64.rotrBH(m,v,41),ye=u64.rotrSL(m,v,14)^u64.rotrSL(m,v,18)^u64.rotrBL(m,v,41),ie=m&_^~m&T,te=v&S^~v&k,ae=u64.add5L(q,ye,te,SHA512_Kl[z],SHA512_W_L[z]),ne=u64.add5H(ae,O,Q,ie,SHA512_Kh[z],SHA512_W_H[z]),me=ae|0,B=u64.rotrSH(r,s,28)^u64.rotrBH(r,s,34)^u64.rotrBH(r,s,39),F=u64.rotrSL(r,s,28)^u64.rotrBL(r,s,34)^u64.rotrBL(r,s,39),j=r&a^r&l^a&l,H=s&o^s&h^o&h;O=T|0,q=k|0,T=_|0,k=S|0,_=m|0,S=v|0,{h:m,l:v}=u64.add(y|0,p|0,ne|0,me|0),y=l|0,p=h|0,l=a|0,h=o|0,a=r|0,o=s|0;const V=u64.add3L(me,F,H);r=u64.add3H(V,ne,B,j),s=V|0}({h:r,l:s}=u64.add(this.Ah|0,this.Al|0,r|0,s|0)),{h:a,l:o}=u64.add(this.Bh|0,this.Bl|0,a|0,o|0),{h:l,l:h}=u64.add(this.Ch|0,this.Cl|0,l|0,h|0),{h:y,l:p}=u64.add(this.Dh|0,this.Dl|0,y|0,p|0),{h:m,l:v}=u64.add(this.Eh|0,this.El|0,m|0,v|0),{h:_,l:S}=u64.add(this.Fh|0,this.Fl|0,_|0,S|0),{h:T,l:k}=u64.add(this.Gh|0,this.Gl|0,T|0,k|0),{h:O,l:q}=u64.add(this.Hh|0,this.Hl|0,O|0,q|0),this.set(r,s,a,o,l,h,y,p,m,v,_,S,T,k,O,q)}roundClean(){(0,utils_ts_1$3.clean)(SHA512_W_H,SHA512_W_L)}destroy(){(0,utils_ts_1$3.clean)(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}sha2.SHA512=SHA512;class SHA384 extends SHA512{constructor(){super(48),this.Ah=_md_ts_1.SHA384_IV[0]|0,this.Al=_md_ts_1.SHA384_IV[1]|0,this.Bh=_md_ts_1.SHA384_IV[2]|0,this.Bl=_md_ts_1.SHA384_IV[3]|0,this.Ch=_md_ts_1.SHA384_IV[4]|0,this.Cl=_md_ts_1.SHA384_IV[5]|0,this.Dh=_md_ts_1.SHA384_IV[6]|0,this.Dl=_md_ts_1.SHA384_IV[7]|0,this.Eh=_md_ts_1.SHA384_IV[8]|0,this.El=_md_ts_1.SHA384_IV[9]|0,this.Fh=_md_ts_1.SHA384_IV[10]|0,this.Fl=_md_ts_1.SHA384_IV[11]|0,this.Gh=_md_ts_1.SHA384_IV[12]|0,this.Gl=_md_ts_1.SHA384_IV[13]|0,this.Hh=_md_ts_1.SHA384_IV[14]|0,this.Hl=_md_ts_1.SHA384_IV[15]|0}}sha2.SHA384=SHA384;const T224_IV=Uint32Array.from([2352822216,424955298,1944164710,2312950998,502970286,855612546,1738396948,1479516111,258812777,2077511080,2011393907,79989058,1067287976,1780299464,286451373,2446758561]),T256_IV=Uint32Array.from([573645204,4230739756,2673172387,3360449730,596883563,1867755857,2520282905,1497426621,2519219938,2827943907,3193839141,1401305490,721525244,746961066,246885852,2177182882]);class SHA512_224 extends SHA512{constructor(){super(28),this.Ah=T224_IV[0]|0,this.Al=T224_IV[1]|0,this.Bh=T224_IV[2]|0,this.Bl=T224_IV[3]|0,this.Ch=T224_IV[4]|0,this.Cl=T224_IV[5]|0,this.Dh=T224_IV[6]|0,this.Dl=T224_IV[7]|0,this.Eh=T224_IV[8]|0,this.El=T224_IV[9]|0,this.Fh=T224_IV[10]|0,this.Fl=T224_IV[11]|0,this.Gh=T224_IV[12]|0,this.Gl=T224_IV[13]|0,this.Hh=T224_IV[14]|0,this.Hl=T224_IV[15]|0}}sha2.SHA512_224=SHA512_224;class SHA512_256 extends SHA512{constructor(){super(32),this.Ah=T256_IV[0]|0,this.Al=T256_IV[1]|0,this.Bh=T256_IV[2]|0,this.Bl=T256_IV[3]|0,this.Ch=T256_IV[4]|0,this.Cl=T256_IV[5]|0,this.Dh=T256_IV[6]|0,this.Dl=T256_IV[7]|0,this.Eh=T256_IV[8]|0,this.El=T256_IV[9]|0,this.Fh=T256_IV[10]|0,this.Fl=T256_IV[11]|0,this.Gh=T256_IV[12]|0,this.Gl=T256_IV[13]|0,this.Hh=T256_IV[14]|0,this.Hl=T256_IV[15]|0}}sha2.SHA512_256=SHA512_256;var sha256=sha2.sha256=(0,utils_ts_1$3.createHasher)(()=>new SHA256);sha2.sha224=(0,utils_ts_1$3.createHasher)(()=>new SHA224);var sha512=sha2.sha512=(0,utils_ts_1$3.createHasher)(()=>new SHA512);sha2.sha384=(0,utils_ts_1$3.createHasher)(()=>new SHA384);sha2.sha512_256=(0,utils_ts_1$3.createHasher)(()=>new SHA512_256);sha2.sha512_224=(0,utils_ts_1$3.createHasher)(()=>new SHA512_224);Object.defineProperty(sha256$1,"__esModule",{value:!0});sha256$1.sha224=sha256$1.SHA224=sha256_1=sha256$1.sha256=sha256$1.SHA256=void 0;const sha2_ts_1$1=sha2;sha256$1.SHA256=sha2_ts_1$1.SHA256;var sha256_1=sha256$1.sha256=sha2_ts_1$1.sha256;sha256$1.SHA224=sha2_ts_1$1.SHA224;sha256$1.sha224=sha2_ts_1$1.sha224;var hmac={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.hmac=t.HMAC=void 0;const e=utils$1;class n extends e.Hash{constructor(a,o){super(),this.finished=!1,this.destroyed=!1,(0,e.ahash)(a);const l=(0,e.toBytes)(o);if(this.iHash=a.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const h=this.blockLen,y=new Uint8Array(h);y.set(l.length>h?a.create().update(l).digest():l);for(let p=0;p<y.length;p++)y[p]^=54;this.iHash.update(y),this.oHash=a.create();for(let p=0;p<y.length;p++)y[p]^=106;this.oHash.update(y),(0,e.clean)(y)}update(a){return(0,e.aexists)(this),this.iHash.update(a),this}digestInto(a){(0,e.aexists)(this),(0,e.abytes)(a,this.outputLen),this.finished=!0,this.iHash.digestInto(a),this.oHash.update(a),this.oHash.digestInto(a),this.destroy()}digest(){const a=new Uint8Array(this.oHash.outputLen);return this.digestInto(a),a}_cloneInto(a){a||(a=Object.create(Object.getPrototypeOf(this),{}));const{oHash:o,iHash:l,finished:h,destroyed:y,blockLen:p,outputLen:m}=this;return a=a,a.finished=h,a.destroyed=y,a.blockLen=p,a.outputLen=m,a.oHash=o._cloneInto(a.oHash),a.iHash=l._cloneInto(a.iHash),a}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}t.HMAC=n;const r=(s,a,o)=>new n(s,a).update(o).digest();t.hmac=r,t.hmac.create=(s,a)=>new n(s,a)})(hmac);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1),_2n$2=BigInt(2);function isBytes$1(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function abytes(t){if(!isBytes$1(t))throw new Error("Uint8Array expected")}function abool(t,e){if(typeof e!="boolean")throw new Error(t+" boolean expected, got "+e)}const hexes$1=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$1(t){abytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes$1[t[n]];return e}function numberToHexUnpadded(t){const e=t.toString(16);return e.length&1?"0"+e:e}function hexToNumber(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?_0n$4:BigInt("0x"+t)}const asciis$1={_0:48,_9:57,A:65,F:70,a:97,f:102};function asciiToBase16$1(t){if(t>=asciis$1._0&&t<=asciis$1._9)return t-asciis$1._0;if(t>=asciis$1.A&&t<=asciis$1.F)return t-(asciis$1.A-10);if(t>=asciis$1.a&&t<=asciis$1.f)return t-(asciis$1.a-10)}function hexToBytes$1(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let s=0,a=0;s<n;s++,a+=2){const o=asciiToBase16$1(t.charCodeAt(a)),l=asciiToBase16$1(t.charCodeAt(a+1));if(o===void 0||l===void 0){const h=t[a]+t[a+1];throw new Error('hex string expected, got non-hex character "'+h+'" at index '+a)}r[s]=o*16+l}return r}function bytesToNumberBE(t){return hexToNumber(bytesToHex$1(t))}function bytesToNumberLE(t){return abytes(t),hexToNumber(bytesToHex$1(Uint8Array.from(t).reverse()))}function numberToBytesBE(t,e){return hexToBytes$1(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE(t,e){return numberToBytesBE(t,e).reverse()}function numberToVarBytesBE(t){return hexToBytes$1(numberToHexUnpadded(t))}function ensureBytes(t,e,n){let r;if(typeof e=="string")try{r=hexToBytes$1(e)}catch(a){throw new Error(t+" must be hex string or Uint8Array, cause: "+a)}else if(isBytes$1(e))r=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(t+" of length "+n+" expected, got "+s);return r}function concatBytes(...t){let e=0;for(let r=0;r<t.length;r++){const s=t[r];abytes(s),e+=s.length}const n=new Uint8Array(e);for(let r=0,s=0;r<t.length;r++){const a=t[r];n.set(a,s),s+=a.length}return n}function equalBytes$1(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}function utf8ToBytes$1(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}const isPosBig=t=>typeof t=="bigint"&&_0n$4<=t;function inRange(t,e,n){return isPosBig(t)&&isPosBig(e)&&isPosBig(n)&&e<=t&&t<n}function aInRange(t,e,n,r){if(!inRange(e,n,r))throw new Error("expected valid "+t+": "+n+" <= n < "+r+", got "+e)}function bitLen(t){let e;for(e=0;t>_0n$4;t>>=_1n$4,e+=1);return e}function bitGet(t,e){return t>>BigInt(e)&_1n$4}function bitSet(t,e,n){return t|(n?_1n$4:_0n$4)<<BigInt(e)}const bitMask=t=>(_2n$2<<BigInt(t-1))-_1n$4,u8n=t=>new Uint8Array(t),u8fr=t=>Uint8Array.from(t);function createHmacDrbg(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=u8n(t),s=u8n(t),a=0;const o=()=>{r.fill(1),s.fill(0),a=0},l=(...m)=>n(s,r,...m),h=(m=u8n())=>{s=l(u8fr([0]),m),r=l(),m.length!==0&&(s=l(u8fr([1]),m),r=l())},y=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let m=0;const v=[];for(;m<e;){r=l();const _=r.slice();v.push(_),m+=r.length}return concatBytes(...v)};return(m,v)=>{o(),h(m);let _;for(;!(_=v(y()));)h();return o(),_}}const validatorFns={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||isBytes$1(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function validateObject(t,e,n={}){const r=(s,a,o)=>{const l=validatorFns[a];if(typeof l!="function")throw new Error("invalid validator function");const h=t[s];if(!(o&&h===void 0)&&!l(h,t))throw new Error("param "+String(s)+" is invalid. Expected "+a+", got "+h)};for(const[s,a]of Object.entries(e))r(s,a,!1);for(const[s,a]of Object.entries(n))r(s,a,!0);return t}const notImplemented=()=>{throw new Error("not implemented")};function memoized(t){const e=new WeakMap;return(n,...r)=>{const s=e.get(n);if(s!==void 0)return s;const a=t(n,...r);return e.set(n,a),a}}const ut=Object.freeze(Object.defineProperty({__proto__:null,aInRange,abool,abytes,bitGet,bitLen,bitMask,bitSet,bytesToHex:bytesToHex$1,bytesToNumberBE,bytesToNumberLE,concatBytes,createHmacDrbg,ensureBytes,equalBytes:equalBytes$1,hexToBytes:hexToBytes$1,hexToNumber,inRange,isBytes:isBytes$1,memoized,notImplemented,numberToBytesBE,numberToBytesLE,numberToHexUnpadded,numberToVarBytesBE,utf8ToBytes:utf8ToBytes$1,validateObject},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$1=BigInt(2),_3n$1=BigInt(3),_4n=BigInt(4),_5n=BigInt(5),_8n=BigInt(8);function mod(t,e){const n=t%e;return n>=_0n$3?n:e+n}function pow(t,e,n){if(e<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(n<=_0n$3)throw new Error("invalid modulus");if(n===_1n$3)return _0n$3;let r=_1n$3;for(;e>_0n$3;)e&_1n$3&&(r=r*t%n),t=t*t%n,e>>=_1n$3;return r}function pow2(t,e,n){let r=t;for(;e-- >_0n$3;)r*=r,r%=n;return r}function invert(t,e){if(t===_0n$3)throw new Error("invert: expected non-zero number");if(e<=_0n$3)throw new Error("invert: expected positive modulus, got "+e);let n=mod(t,e),r=e,s=_0n$3,a=_1n$3;for(;n!==_0n$3;){const l=r/n,h=r%n,y=s-a*l;r=n,n=h,s=a,a=y}if(r!==_1n$3)throw new Error("invert: does not exist");return mod(s,e)}function tonelliShanks(t){const e=(t-_1n$3)/_2n$1;let n,r,s;for(n=t-_1n$3,r=0;n%_2n$1===_0n$3;n/=_2n$1,r++);for(s=_2n$1;s<t&&pow(s,e,t)!==t-_1n$3;s++)if(s>1e3)throw new Error("Cannot find square root: likely non-prime P");if(r===1){const o=(t+_1n$3)/_4n;return function(h,y){const p=h.pow(y,o);if(!h.eql(h.sqr(p),y))throw new Error("Cannot find square root");return p}}const a=(n+_1n$3)/_2n$1;return function(l,h){if(l.pow(h,e)===l.neg(l.ONE))throw new Error("Cannot find square root");let y=r,p=l.pow(l.mul(l.ONE,s),n),m=l.pow(h,a),v=l.pow(h,n);for(;!l.eql(v,l.ONE);){if(l.eql(v,l.ZERO))return l.ZERO;let _=1;for(let T=l.sqr(v);_<y&&!l.eql(T,l.ONE);_++)T=l.sqr(T);const S=l.pow(p,_1n$3<<BigInt(y-_-1));p=l.sqr(S),m=l.mul(m,S),v=l.mul(v,p),y=_}return m}}function FpSqrt(t){if(t%_4n===_3n$1){const e=(t+_1n$3)/_4n;return function(r,s){const a=r.pow(s,e);if(!r.eql(r.sqr(a),s))throw new Error("Cannot find square root");return a}}if(t%_8n===_5n){const e=(t-_5n)/_8n;return function(r,s){const a=r.mul(s,_2n$1),o=r.pow(a,e),l=r.mul(s,o),h=r.mul(r.mul(l,_2n$1),o),y=r.mul(l,r.sub(h,r.ONE));if(!r.eql(r.sqr(y),s))throw new Error("Cannot find square root");return y}}return tonelliShanks(t)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS.reduce((r,s)=>(r[s]="function",r),e);return validateObject(t,n)}function FpPow(t,e,n){if(n<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(n===_0n$3)return t.ONE;if(n===_1n$3)return e;let r=t.ONE,s=e;for(;n>_0n$3;)n&_1n$3&&(r=t.mul(r,s)),s=t.sqr(s),n>>=_1n$3;return r}function FpInvertBatch(t,e){const n=new Array(e.length),r=e.reduce((a,o,l)=>t.is0(o)?a:(n[l]=a,t.mul(a,o)),t.ONE),s=t.inv(r);return e.reduceRight((a,o,l)=>t.is0(o)?a:(n[l]=t.mul(a,n[l]),t.mul(a,o)),s),n}function nLength(t,e){const n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Field(t,e,n=!1,r={}){if(t<=_0n$3)throw new Error("invalid field: expected ORDER > 0, got "+t);const{nBitLength:s,nByteLength:a}=nLength(t,e);if(a>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const l=Object.freeze({ORDER:t,isLE:n,BITS:s,BYTES:a,MASK:bitMask(s),ZERO:_0n$3,ONE:_1n$3,create:h=>mod(h,t),isValid:h=>{if(typeof h!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof h);return _0n$3<=h&&h<t},is0:h=>h===_0n$3,isOdd:h=>(h&_1n$3)===_1n$3,neg:h=>mod(-h,t),eql:(h,y)=>h===y,sqr:h=>mod(h*h,t),add:(h,y)=>mod(h+y,t),sub:(h,y)=>mod(h-y,t),mul:(h,y)=>mod(h*y,t),pow:(h,y)=>FpPow(l,h,y),div:(h,y)=>mod(h*invert(y,t),t),sqrN:h=>h*h,addN:(h,y)=>h+y,subN:(h,y)=>h-y,mulN:(h,y)=>h*y,inv:h=>invert(h,t),sqrt:r.sqrt||(h=>(o||(o=FpSqrt(t)),o(l,h))),invertBatch:h=>FpInvertBatch(l,h),cmov:(h,y,p)=>p?y:h,toBytes:h=>n?numberToBytesLE(h,a):numberToBytesBE(h,a),fromBytes:h=>{if(h.length!==a)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+h.length);return n?bytesToNumberLE(h):bytesToNumberBE(h)}});return Object.freeze(l)}function getFieldBytesLength(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength(t){const e=getFieldBytesLength(t);return e+Math.ceil(e/2)}function mapHashToField(t,e,n=!1){const r=t.length,s=getFieldBytesLength(e),a=getMinHashLength(e);if(r<16||r<a||r>1024)throw new Error("expected "+a+"-1024 bytes of input, got "+r);const o=n?bytesToNumberLE(t):bytesToNumberBE(t),l=mod(o,e-_1n$3)+_1n$3;return n?numberToBytesLE(l,s):numberToBytesBE(l,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1);function constTimeNegate(t,e){const n=e.negate();return t?n:e}function validateW(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function calcWOpts(t,e){validateW(t,e);const n=Math.ceil(e/t)+1,r=2**(t-1);return{windows:n,windowSize:r}}function validateMSMPoints(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((n,r)=>{if(!(n instanceof e))throw new Error("invalid point at index "+r)})}function validateMSMScalars(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((n,r)=>{if(!e.isValid(n))throw new Error("invalid scalar at index "+r)})}const pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function getW(t){return pointWindowSizes.get(t)||1}function wNAF(t,e){return{constTimeNegate,hasPrecomputes(n){return getW(n)!==1},unsafeLadder(n,r,s=t.ZERO){let a=n;for(;r>_0n$2;)r&_1n$2&&(s=s.add(a)),a=a.double(),r>>=_1n$2;return s},precomputeWindow(n,r){const{windows:s,windowSize:a}=calcWOpts(r,e),o=[];let l=n,h=l;for(let y=0;y<s;y++){h=l,o.push(h);for(let p=1;p<a;p++)h=h.add(l),o.push(h);l=h.double()}return o},wNAF(n,r,s){const{windows:a,windowSize:o}=calcWOpts(n,e);let l=t.ZERO,h=t.BASE;const y=BigInt(2**n-1),p=2**n,m=BigInt(n);for(let v=0;v<a;v++){const _=v*o;let S=Number(s&y);s>>=m,S>o&&(S-=p,s+=_1n$2);const T=_,k=_+Math.abs(S)-1,O=v%2!==0,q=S<0;S===0?h=h.add(constTimeNegate(O,r[T])):l=l.add(constTimeNegate(q,r[k]))}return{p:l,f:h}},wNAFUnsafe(n,r,s,a=t.ZERO){const{windows:o,windowSize:l}=calcWOpts(n,e),h=BigInt(2**n-1),y=2**n,p=BigInt(n);for(let m=0;m<o;m++){const v=m*l;if(s===_0n$2)break;let _=Number(s&h);if(s>>=p,_>l&&(_-=y,s+=_1n$2),_===0)continue;let S=r[v+Math.abs(_)-1];_<0&&(S=S.negate()),a=a.add(S)}return a},getPrecomputes(n,r,s){let a=pointPrecomputes.get(r);return a||(a=this.precomputeWindow(r,n),n!==1&&pointPrecomputes.set(r,s(a))),a},wNAFCached(n,r,s){const a=getW(n);return this.wNAF(a,this.getPrecomputes(a,n,s),r)},wNAFCachedUnsafe(n,r,s,a){const o=getW(n);return o===1?this.unsafeLadder(n,r,a):this.wNAFUnsafe(o,this.getPrecomputes(o,n,s),r,a)},setWindowSize(n,r){validateW(r,e),pointWindowSizes.set(n,r),pointPrecomputes.delete(n)}}}function pippenger(t,e,n,r){if(validateMSMPoints(n,t),validateMSMScalars(r,e),n.length!==r.length)throw new Error("arrays of points and scalars must have equal length");const s=t.ZERO,a=bitLen(BigInt(n.length)),o=a>12?a-3:a>4?a-2:a?2:1,l=(1<<o)-1,h=new Array(l+1).fill(s),y=Math.floor((e.BITS-1)/o)*o;let p=s;for(let m=y;m>=0;m-=o){h.fill(s);for(let _=0;_<r.length;_++){const S=r[_],T=Number(S>>BigInt(m)&BigInt(l));h[T]=h[T].add(n[_])}let v=s;for(let _=h.length-1,S=s;_>0;_--)S=S.add(h[_]),v=v.add(S);if(p=p.add(v),m!==0)for(let _=0;_<o;_++)p=p.double()}return p}function validateBasic(t){return validateField(t.Fp),validateObject(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validateSigVerOpts(t){t.lowS!==void 0&&abool("lowS",t.lowS),t.prehash!==void 0&&abool("prehash",t.prehash)}function validatePointOpts(t){const e=validateBasic(t);validateObject(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=e;if(n){if(!r.eql(s,r.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:b2n,hexToBytes:h2b}=ut;class DERErr extends Error{constructor(e=""){super(e)}}const DER={Err:DERErr,_tlv:{encode:(t,e)=>{const{Err:n}=DER;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length&1)throw new n("tlv.encode: unpadded data");const r=e.length/2,s=numberToHexUnpadded(r);if(s.length/2&128)throw new n("tlv.encode: long form length too big");const a=r>127?numberToHexUnpadded(s.length/2|128):"";return numberToHexUnpadded(t)+a+s+e},decode(t,e){const{Err:n}=DER;let r=0;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length<2||e[r++]!==t)throw new n("tlv.decode: wrong tlv");const s=e[r++],a=!!(s&128);let o=0;if(!a)o=s;else{const h=s&127;if(!h)throw new n("tlv.decode(long): indefinite length not supported");if(h>4)throw new n("tlv.decode(long): byte length is too big");const y=e.subarray(r,r+h);if(y.length!==h)throw new n("tlv.decode: length bytes not complete");if(y[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(const p of y)o=o<<8|p;if(r+=h,o<128)throw new n("tlv.decode(long): not minimal encoding")}const l=e.subarray(r,r+o);if(l.length!==o)throw new n("tlv.decode: wrong value length");return{v:l,l:e.subarray(r+o)}}},_int:{encode(t){const{Err:e}=DER;if(t<_0n$1)throw new e("integer: negative integers are not allowed");let n=numberToHexUnpadded(t);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return n},decode(t){const{Err:e}=DER;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return b2n(t)}},toSig(t){const{Err:e,_int:n,_tlv:r}=DER,s=typeof t=="string"?h2b(t):t;abytes(s);const{v:a,l:o}=r.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:l,l:h}=r.decode(2,a),{v:y,l:p}=r.decode(2,h);if(p.length)throw new e("invalid signature: left bytes after parsing");return{r:n.decode(l),s:n.decode(y)}},hexFromSig(t){const{_tlv:e,_int:n}=DER,r=e.encode(2,n.encode(t.r)),s=e.encode(2,n.encode(t.s)),a=r+s;return e.encode(48,a)}},_0n$1=BigInt(0),_1n$1=BigInt(1);BigInt(2);const _3n=BigInt(3);BigInt(4);function weierstrassPoints(t){const e=validatePointOpts(t),{Fp:n}=e,r=Field(e.n,e.nBitLength),s=e.toBytes||((T,k,O)=>{const q=k.toAffine();return concatBytes(Uint8Array.from([4]),n.toBytes(q.x),n.toBytes(q.y))}),a=e.fromBytes||(T=>{const k=T.subarray(1),O=n.fromBytes(k.subarray(0,n.BYTES)),q=n.fromBytes(k.subarray(n.BYTES,2*n.BYTES));return{x:O,y:q}});function o(T){const{a:k,b:O}=e,q=n.sqr(T),z=n.mul(q,T);return n.add(n.add(z,n.mul(T,k)),O)}if(!n.eql(n.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function l(T){return inRange(T,_1n$1,e.n)}function h(T){const{allowedPrivateKeyLengths:k,nByteLength:O,wrapPrivateKey:q,n:z}=e;if(k&&typeof T!="bigint"){if(isBytes$1(T)&&(T=bytesToHex$1(T)),typeof T!="string"||!k.includes(T.length))throw new Error("invalid private key");T=T.padStart(O*2,"0")}let Q;try{Q=typeof T=="bigint"?T:bytesToNumberBE(ensureBytes("private key",T,O))}catch{throw new Error("invalid private key, expected hex or "+O+" bytes, got "+typeof T)}return q&&(Q=mod(Q,z)),aInRange("private key",Q,_1n$1,z),Q}function y(T){if(!(T instanceof v))throw new Error("ProjectivePoint expected")}const p=memoized((T,k)=>{const{px:O,py:q,pz:z}=T;if(n.eql(z,n.ONE))return{x:O,y:q};const Q=T.is0();k==null&&(k=Q?n.ONE:n.inv(z));const ye=n.mul(O,k),ie=n.mul(q,k),te=n.mul(z,k);if(Q)return{x:n.ZERO,y:n.ZERO};if(!n.eql(te,n.ONE))throw new Error("invZ was invalid");return{x:ye,y:ie}}),m=memoized(T=>{if(T.is0()){if(e.allowInfinityPoint&&!n.is0(T.py))return;throw new Error("bad point: ZERO")}const{x:k,y:O}=T.toAffine();if(!n.isValid(k)||!n.isValid(O))throw new Error("bad point: x or y not FE");const q=n.sqr(O),z=o(k);if(!n.eql(q,z))throw new Error("bad point: equation left != right");if(!T.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class v{constructor(k,O,q){if(this.px=k,this.py=O,this.pz=q,k==null||!n.isValid(k))throw new Error("x required");if(O==null||!n.isValid(O))throw new Error("y required");if(q==null||!n.isValid(q))throw new Error("z required");Object.freeze(this)}static fromAffine(k){const{x:O,y:q}=k||{};if(!k||!n.isValid(O)||!n.isValid(q))throw new Error("invalid affine point");if(k instanceof v)throw new Error("projective point not allowed");const z=Q=>n.eql(Q,n.ZERO);return z(O)&&z(q)?v.ZERO:new v(O,q,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(k){const O=n.invertBatch(k.map(q=>q.pz));return k.map((q,z)=>q.toAffine(O[z])).map(v.fromAffine)}static fromHex(k){const O=v.fromAffine(a(ensureBytes("pointHex",k)));return O.assertValidity(),O}static fromPrivateKey(k){return v.BASE.multiply(h(k))}static msm(k,O){return pippenger(v,r,k,O)}_setWindowSize(k){S.setWindowSize(this,k)}assertValidity(){m(this)}hasEvenY(){const{y:k}=this.toAffine();if(n.isOdd)return!n.isOdd(k);throw new Error("Field doesn't support isOdd")}equals(k){y(k);const{px:O,py:q,pz:z}=this,{px:Q,py:ye,pz:ie}=k,te=n.eql(n.mul(O,ie),n.mul(Q,z)),ae=n.eql(n.mul(q,ie),n.mul(ye,z));return te&&ae}negate(){return new v(this.px,n.neg(this.py),this.pz)}double(){const{a:k,b:O}=e,q=n.mul(O,_3n),{px:z,py:Q,pz:ye}=this;let ie=n.ZERO,te=n.ZERO,ae=n.ZERO,ne=n.mul(z,z),me=n.mul(Q,Q),B=n.mul(ye,ye),F=n.mul(z,Q);return F=n.add(F,F),ae=n.mul(z,ye),ae=n.add(ae,ae),ie=n.mul(k,ae),te=n.mul(q,B),te=n.add(ie,te),ie=n.sub(me,te),te=n.add(me,te),te=n.mul(ie,te),ie=n.mul(F,ie),ae=n.mul(q,ae),B=n.mul(k,B),F=n.sub(ne,B),F=n.mul(k,F),F=n.add(F,ae),ae=n.add(ne,ne),ne=n.add(ae,ne),ne=n.add(ne,B),ne=n.mul(ne,F),te=n.add(te,ne),B=n.mul(Q,ye),B=n.add(B,B),ne=n.mul(B,F),ie=n.sub(ie,ne),ae=n.mul(B,me),ae=n.add(ae,ae),ae=n.add(ae,ae),new v(ie,te,ae)}add(k){y(k);const{px:O,py:q,pz:z}=this,{px:Q,py:ye,pz:ie}=k;let te=n.ZERO,ae=n.ZERO,ne=n.ZERO;const me=e.a,B=n.mul(e.b,_3n);let F=n.mul(O,Q),j=n.mul(q,ye),H=n.mul(z,ie),V=n.add(O,q),W=n.add(Q,ye);V=n.mul(V,W),W=n.add(F,j),V=n.sub(V,W),W=n.add(O,z);let Z=n.add(Q,ie);return W=n.mul(W,Z),Z=n.add(F,H),W=n.sub(W,Z),Z=n.add(q,z),te=n.add(ye,ie),Z=n.mul(Z,te),te=n.add(j,H),Z=n.sub(Z,te),ne=n.mul(me,W),te=n.mul(B,H),ne=n.add(te,ne),te=n.sub(j,ne),ne=n.add(j,ne),ae=n.mul(te,ne),j=n.add(F,F),j=n.add(j,F),H=n.mul(me,H),W=n.mul(B,W),j=n.add(j,H),H=n.sub(F,H),H=n.mul(me,H),W=n.add(W,H),F=n.mul(j,W),ae=n.add(ae,F),F=n.mul(Z,W),te=n.mul(V,te),te=n.sub(te,F),F=n.mul(V,j),ne=n.mul(Z,ne),ne=n.add(ne,F),new v(te,ae,ne)}subtract(k){return this.add(k.negate())}is0(){return this.equals(v.ZERO)}wNAF(k){return S.wNAFCached(this,k,v.normalizeZ)}multiplyUnsafe(k){const{endo:O,n:q}=e;aInRange("scalar",k,_0n$1,q);const z=v.ZERO;if(k===_0n$1)return z;if(this.is0()||k===_1n$1)return this;if(!O||S.hasPrecomputes(this))return S.wNAFCachedUnsafe(this,k,v.normalizeZ);let{k1neg:Q,k1:ye,k2neg:ie,k2:te}=O.splitScalar(k),ae=z,ne=z,me=this;for(;ye>_0n$1||te>_0n$1;)ye&_1n$1&&(ae=ae.add(me)),te&_1n$1&&(ne=ne.add(me)),me=me.double(),ye>>=_1n$1,te>>=_1n$1;return Q&&(ae=ae.negate()),ie&&(ne=ne.negate()),ne=new v(n.mul(ne.px,O.beta),ne.py,ne.pz),ae.add(ne)}multiply(k){const{endo:O,n:q}=e;aInRange("scalar",k,_1n$1,q);let z,Q;if(O){const{k1neg:ye,k1:ie,k2neg:te,k2:ae}=O.splitScalar(k);let{p:ne,f:me}=this.wNAF(ie),{p:B,f:F}=this.wNAF(ae);ne=S.constTimeNegate(ye,ne),B=S.constTimeNegate(te,B),B=new v(n.mul(B.px,O.beta),B.py,B.pz),z=ne.add(B),Q=me.add(F)}else{const{p:ye,f:ie}=this.wNAF(k);z=ye,Q=ie}return v.normalizeZ([z,Q])[0]}multiplyAndAddUnsafe(k,O,q){const z=v.BASE,Q=(ie,te)=>te===_0n$1||te===_1n$1||!ie.equals(z)?ie.multiplyUnsafe(te):ie.multiply(te),ye=Q(this,O).add(Q(k,q));return ye.is0()?void 0:ye}toAffine(k){return p(this,k)}isTorsionFree(){const{h:k,isTorsionFree:O}=e;if(k===_1n$1)return!0;if(O)return O(v,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:k,clearCofactor:O}=e;return k===_1n$1?this:O?O(v,this):this.multiplyUnsafe(e.h)}toRawBytes(k=!0){return abool("isCompressed",k),this.assertValidity(),s(v,this,k)}toHex(k=!0){return abool("isCompressed",k),bytesToHex$1(this.toRawBytes(k))}}v.BASE=new v(e.Gx,e.Gy,n.ONE),v.ZERO=new v(n.ZERO,n.ONE,n.ZERO);const _=e.nBitLength,S=wNAF(v,e.endo?Math.ceil(_/2):_);return{CURVE:e,ProjectivePoint:v,normPrivateKeyToScalar:h,weierstrassEquation:o,isWithinCurveOrder:l}}function validateOpts(t){const e=validateBasic(t);return validateObject(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function weierstrass(t){const e=validateOpts(t),{Fp:n,n:r}=e,s=n.BYTES+1,a=2*n.BYTES+1;function o(H){return mod(H,r)}function l(H){return invert(H,r)}const{ProjectivePoint:h,normPrivateKeyToScalar:y,weierstrassEquation:p,isWithinCurveOrder:m}=weierstrassPoints({...e,toBytes(H,V,W){const Z=V.toAffine(),oe=n.toBytes(Z.x),A=concatBytes;return abool("isCompressed",W),W?A(Uint8Array.from([V.hasEvenY()?2:3]),oe):A(Uint8Array.from([4]),oe,n.toBytes(Z.y))},fromBytes(H){const V=H.length,W=H[0],Z=H.subarray(1);if(V===s&&(W===2||W===3)){const oe=bytesToNumberBE(Z);if(!inRange(oe,_1n$1,n.ORDER))throw new Error("Point is not on curve");const A=p(oe);let J;try{J=n.sqrt(A)}catch(ve){const we=ve instanceof Error?": "+ve.message:"";throw new Error("Point is not on curve"+we)}const X=(J&_1n$1)===_1n$1;return(W&1)===1!==X&&(J=n.neg(J)),{x:oe,y:J}}else if(V===a&&W===4){const oe=n.fromBytes(Z.subarray(0,n.BYTES)),A=n.fromBytes(Z.subarray(n.BYTES,2*n.BYTES));return{x:oe,y:A}}else{const oe=s,A=a;throw new Error("invalid Point, expected length of "+oe+", or uncompressed "+A+", got "+V)}}}),v=H=>bytesToHex$1(numberToBytesBE(H,e.nByteLength));function _(H){const V=r>>_1n$1;return H>V}function S(H){return _(H)?o(-H):H}const T=(H,V,W)=>bytesToNumberBE(H.slice(V,W));class k{constructor(V,W,Z){this.r=V,this.s=W,this.recovery=Z,this.assertValidity()}static fromCompact(V){const W=e.nByteLength;return V=ensureBytes("compactSignature",V,W*2),new k(T(V,0,W),T(V,W,2*W))}static fromDER(V){const{r:W,s:Z}=DER.toSig(ensureBytes("DER",V));return new k(W,Z)}assertValidity(){aInRange("r",this.r,_1n$1,r),aInRange("s",this.s,_1n$1,r)}addRecoveryBit(V){return new k(this.r,this.s,V)}recoverPublicKey(V){const{r:W,s:Z,recovery:oe}=this,A=ie(ensureBytes("msgHash",V));if(oe==null||![0,1,2,3].includes(oe))throw new Error("recovery id invalid");const J=oe===2||oe===3?W+e.n:W;if(J>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const X=oe&1?"03":"02",de=h.fromHex(X+v(J)),ve=l(J),we=o(-A*ve),$e=o(Z*ve),Re=h.BASE.multiplyAndAddUnsafe(de,we,$e);if(!Re)throw new Error("point at infinify");return Re.assertValidity(),Re}hasHighS(){return _(this.s)}normalizeS(){return this.hasHighS()?new k(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes$1(this.toDERHex())}toDERHex(){return DER.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes$1(this.toCompactHex())}toCompactHex(){return v(this.r)+v(this.s)}}const O={isValidPrivateKey(H){try{return y(H),!0}catch{return!1}},normPrivateKeyToScalar:y,randomPrivateKey:()=>{const H=getMinHashLength(e.n);return mapHashToField(e.randomBytes(H),e.n)},precompute(H=8,V=h.BASE){return V._setWindowSize(H),V.multiply(BigInt(3)),V}};function q(H,V=!0){return h.fromPrivateKey(H).toRawBytes(V)}function z(H){const V=isBytes$1(H),W=typeof H=="string",Z=(V||W)&&H.length;return V?Z===s||Z===a:W?Z===2*s||Z===2*a:H instanceof h}function Q(H,V,W=!0){if(z(H))throw new Error("first arg must be private key");if(!z(V))throw new Error("second arg must be public key");return h.fromHex(V).multiply(y(H)).toRawBytes(W)}const ye=e.bits2int||function(H){if(H.length>8192)throw new Error("input is too large");const V=bytesToNumberBE(H),W=H.length*8-e.nBitLength;return W>0?V>>BigInt(W):V},ie=e.bits2int_modN||function(H){return o(ye(H))},te=bitMask(e.nBitLength);function ae(H){return aInRange("num < 2^"+e.nBitLength,H,_0n$1,te),numberToBytesBE(H,e.nByteLength)}function ne(H,V,W=me){if(["recovered","canonical"].some(Ke=>Ke in W))throw new Error("sign() legacy options not supported");const{hash:Z,randomBytes:oe}=e;let{lowS:A,prehash:J,extraEntropy:X}=W;A==null&&(A=!0),H=ensureBytes("msgHash",H),validateSigVerOpts(W),J&&(H=ensureBytes("prehashed msgHash",Z(H)));const de=ie(H),ve=y(V),we=[ae(ve),ae(de)];if(X!=null&&X!==!1){const Ke=X===!0?oe(n.BYTES):X;we.push(ensureBytes("extraEntropy",Ke))}const $e=concatBytes(...we),Re=de;function De(Ke){const pe=ye(Ke);if(!m(pe))return;const wt=l(pe),We=h.BASE.multiply(pe).toAffine(),Te=o(We.x);if(Te===_0n$1)return;const je=o(wt*o(Re+Te*ve));if(je===_0n$1)return;let Qe=(We.x===Te?0:2)|Number(We.y&_1n$1),qe=je;return A&&_(je)&&(qe=S(je),Qe^=1),new k(Te,qe,Qe)}return{seed:$e,k2sig:De}}const me={lowS:e.lowS,prehash:!1},B={lowS:e.lowS,prehash:!1};function F(H,V,W=me){const{seed:Z,k2sig:oe}=ne(H,V,W),A=e;return createHmacDrbg(A.hash.outputLen,A.nByteLength,A.hmac)(Z,oe)}h.BASE._setWindowSize(8);function j(H,V,W,Z=B){const oe=H;V=ensureBytes("msgHash",V),W=ensureBytes("publicKey",W);const{lowS:A,prehash:J,format:X}=Z;if(validateSigVerOpts(Z),"strict"in Z)throw new Error("options.strict was renamed to lowS");if(X!==void 0&&X!=="compact"&&X!=="der")throw new Error("format must be compact or der");const de=typeof oe=="string"||isBytes$1(oe),ve=!de&&!X&&typeof oe=="object"&&oe!==null&&typeof oe.r=="bigint"&&typeof oe.s=="bigint";if(!de&&!ve)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let we,$e;try{if(ve&&(we=new k(oe.r,oe.s)),de){try{X!=="compact"&&(we=k.fromDER(oe))}catch(Qe){if(!(Qe instanceof DER.Err))throw Qe}!we&&X!=="der"&&(we=k.fromCompact(oe))}$e=h.fromHex(W)}catch{return!1}if(!we||A&&we.hasHighS())return!1;J&&(V=e.hash(V));const{r:Re,s:De}=we,Ke=ie(V),pe=l(De),wt=o(Ke*pe),We=o(Re*pe),Te=h.BASE.multiplyAndAddUnsafe($e,wt,We)?.toAffine();return Te?o(Te.x)===Re:!1}return{CURVE:e,getPublicKey:q,getSharedSecret:Q,sign:F,verify:j,ProjectivePoint:h,Signature:k,utils:O}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash(t){return{hash:t,hmac:(e,...n)=>hmac.hmac(t,e,utils$1.concatBytes(...n)),randomBytes:utils$1.randomBytes}}function createCurve(t,e){const n=r=>weierstrass({...t,...getHash(r)});return{...n(e),create:n}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n=BigInt(1),_2n=BigInt(2),divNearest=(t,e)=>(t+e/_2n)/e;function sqrtMod(t){const e=secp256k1P,n=BigInt(3),r=BigInt(6),s=BigInt(11),a=BigInt(22),o=BigInt(23),l=BigInt(44),h=BigInt(88),y=t*t*t%e,p=y*y*t%e,m=pow2(p,n,e)*p%e,v=pow2(m,n,e)*p%e,_=pow2(v,_2n,e)*y%e,S=pow2(_,s,e)*_%e,T=pow2(S,a,e)*S%e,k=pow2(T,l,e)*T%e,O=pow2(k,h,e)*k%e,q=pow2(O,l,e)*T%e,z=pow2(q,n,e)*p%e,Q=pow2(z,o,e)*S%e,ye=pow2(Q,r,e)*y%e,ie=pow2(ye,_2n,e);if(!Fpk1.eql(Fpk1.sqr(ie),t))throw new Error("Cannot find square root");return ie}const Fpk1=Field(secp256k1P,void 0,void 0,{sqrt:sqrtMod}),secp256k1=createCurve({a:BigInt(0),b:BigInt(7),Fp:Fpk1,n:secp256k1N,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=secp256k1N,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_1n*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),a=n,o=BigInt("0x100000000000000000000000000000000"),l=divNearest(a*t,e),h=divNearest(-r*t,e);let y=mod(t-l*n-h*s,e),p=mod(-l*r-h*a,e);const m=y>o,v=p>o;if(m&&(y=e-y),v&&(p=e-p),y>o||p>o)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:m,k1:y,k2neg:v,k2:p}}}},sha256_1),_0n=BigInt(0),TAGGED_HASH_PREFIXES={};function taggedHash(t,...e){let n=TAGGED_HASH_PREFIXES[t];if(n===void 0){const r=sha256_1(Uint8Array.from(t,s=>s.charCodeAt(0)));n=concatBytes(r,r),TAGGED_HASH_PREFIXES[t]=n}return sha256_1(concatBytes(n,...e))}const pointToBytes=t=>t.toRawBytes(!0).slice(1),numTo32b=t=>numberToBytesBE(t,32),modP=t=>mod(t,secp256k1P),modN=t=>mod(t,secp256k1N),Point=secp256k1.ProjectivePoint,GmulAdd=(t,e,n)=>Point.BASE.multiplyAndAddUnsafe(t,e,n);function schnorrGetExtPubKey(t){let e=secp256k1.utils.normPrivateKeyToScalar(t),n=Point.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:modN(-e),bytes:pointToBytes(n)}}function lift_x(t){aInRange("x",t,_1n,secp256k1P);const e=modP(t*t),n=modP(e*t+BigInt(7));let r=sqrtMod(n);r%_2n!==_0n&&(r=modP(-r));const s=new Point(t,r,_1n);return s.assertValidity(),s}const num=bytesToNumberBE;function challenge(...t){return modN(num(taggedHash("BIP0340/challenge",...t)))}function schnorrGetPublicKey(t){return schnorrGetExtPubKey(t).bytes}function schnorrSign(t,e,n=utils$1.randomBytes(32)){const r=ensureBytes("message",t),{bytes:s,scalar:a}=schnorrGetExtPubKey(e),o=ensureBytes("auxRand",n,32),l=numTo32b(a^num(taggedHash("BIP0340/aux",o))),h=taggedHash("BIP0340/nonce",l,s,r),y=modN(num(h));if(y===_0n)throw new Error("sign failed: k is zero");const{bytes:p,scalar:m}=schnorrGetExtPubKey(y),v=challenge(p,s,r),_=new Uint8Array(64);if(_.set(p,0),_.set(numTo32b(modN(m+v*a)),32),!schnorrVerify(_,r,s))throw new Error("sign: Invalid signature produced");return _}function schnorrVerify(t,e,n){const r=ensureBytes("signature",t,64),s=ensureBytes("message",e),a=ensureBytes("publicKey",n,32);try{const o=lift_x(num(a)),l=num(r.subarray(0,32));if(!inRange(l,_1n,secp256k1P))return!1;const h=num(r.subarray(32,64));if(!inRange(h,_1n,secp256k1N))return!1;const y=challenge(numTo32b(l),pointToBytes(o),s),p=GmulAdd(o,h,modN(-y));return!(!p||!p.hasEvenY()||p.toAffine().x!==l)}catch{return!1}}const schnorr={getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,utils:{randomPrivateKey:secp256k1.utils.randomPrivateKey,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,taggedHash,mod}};/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function assertNumber(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function chain(...t){const e=(s,a)=>o=>s(a(o)),n=Array.from(t).reverse().reduce((s,a)=>s?e(s,a.encode):a.encode,void 0),r=t.reduce((s,a)=>s?e(s,a.decode):a.decode,void 0);return{encode:n,decode:r}}function alphabet(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(n=>{if(assertNumber(n),n<0||n>=t.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${t.length})`);return t[n]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const r=t.indexOf(n);if(r===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${t}`);return r})}}}function join(t=""){if(typeof t!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of e)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return e.join(t)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(t)}}}function padding(t,e="="){if(assertNumber(t),typeof e!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let r of n)if(typeof r!="string")throw new Error(`padding.encode: non-string input=${r}`);for(;n.length*t%8;)n.push(e);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let s of n)if(typeof s!="string")throw new Error(`padding.decode: non-string input=${s}`);let r=n.length;if(r*t%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;r>0&&n[r-1]===e;r--)if(!((r-1)*t%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,r)}}}function normalize$1(t){if(typeof t!="function")throw new Error("normalize fn should be function");return{encode:e=>e,decode:e=>t(e)}}function convertRadix(t,e,n){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(t))throw new Error("convertRadix: data should be array");if(!t.length)return[];let r=0;const s=[],a=Array.from(t);for(a.forEach(o=>{if(assertNumber(o),o<0||o>=e)throw new Error(`Wrong integer: ${o}`)});;){let o=0,l=!0;for(let h=r;h<a.length;h++){const y=a[h],p=e*o+y;if(!Number.isSafeInteger(p)||e*o/e!==o||p-y!==e*o)throw new Error("convertRadix: carry overflow");if(o=p%n,a[h]=Math.floor(p/n),!Number.isSafeInteger(a[h])||a[h]*n+o!==p)throw new Error("convertRadix: carry overflow");if(l)a[h]?l=!1:r=h;else continue}if(s.push(o),l)break}for(let o=0;o<t.length-1&&t[o]===0;o++)s.push(0);return s.reverse()}const gcd=(t,e)=>e?gcd(e,t%e):t,radix2carry=(t,e)=>t+(e-gcd(t,e));function convertRadix2(t,e,n,r){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(radix2carry(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${radix2carry(e,n)}`);let s=0,a=0;const o=2**n-1,l=[];for(const h of t){if(assertNumber(h),h>=2**e)throw new Error(`convertRadix2: invalid data word=${h} from=${e}`);if(s=s<<e|h,a+e>32)throw new Error(`convertRadix2: carry overflow pos=${a} from=${e}`);for(a+=e;a>=n;a-=n)l.push((s>>a-n&o)>>>0);s&=2**a-1}if(s=s<<n-a&o,!r&&a>=e)throw new Error("Excess padding");if(!r&&s)throw new Error(`Non-zero padding: ${s}`);return r&&a>0&&l.push(s>>>0),l}function radix(t){return assertNumber(t),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return convertRadix(Array.from(e),2**8,t)},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(convertRadix(e,t,2**8))}}}function radix2(t,e=!1){if(assertNumber(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(radix2carry(8,t)>32||radix2carry(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return convertRadix2(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(convertRadix2(n,t,8,e))}}}function unsafeWrapper(t){if(typeof t!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch{}}}const base16=chain(radix2(4),alphabet("0123456789ABCDEF"),join("")),base32=chain(radix2(5),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),padding(5),join(""));chain(radix2(5),alphabet("0123456789ABCDEFGHIJKLMNOPQRSTUV"),padding(5),join(""));chain(radix2(5),alphabet("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),join(""),normalize$1(t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const base64=chain(radix2(6),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),padding(6),join("")),base64url=chain(radix2(6),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),padding(6),join("")),genBase58=t=>chain(radix(58),alphabet(t),join("")),base58=genBase58("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");genBase58("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");genBase58("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const XMR_BLOCK_LEN=[0,2,3,5,6,7,9,10,11],base58xmr={encode(t){let e="";for(let n=0;n<t.length;n+=8){const r=t.subarray(n,n+8);e+=base58.encode(r).padStart(XMR_BLOCK_LEN[r.length],"1")}return e},decode(t){let e=[];for(let n=0;n<t.length;n+=11){const r=t.slice(n,n+11),s=XMR_BLOCK_LEN.indexOf(r.length),a=base58.decode(r);for(let o=0;o<a.length-s;o++)if(a[o]!==0)throw new Error("base58xmr: wrong padding");e=e.concat(Array.from(a.slice(a.length-s)))}return Uint8Array.from(e)}},BECH_ALPHABET=chain(alphabet("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),join("")),POLYMOD_GENERATORS=[996825010,642813549,513874426,1027748829,705979059];function bech32Polymod(t){const e=t>>25;let n=(t&33554431)<<5;for(let r=0;r<POLYMOD_GENERATORS.length;r++)(e>>r&1)===1&&(n^=POLYMOD_GENERATORS[r]);return n}function bechChecksum(t,e,n=1){const r=t.length;let s=1;for(let a=0;a<r;a++){const o=t.charCodeAt(a);if(o<33||o>126)throw new Error(`Invalid prefix (${t})`);s=bech32Polymod(s)^o>>5}s=bech32Polymod(s);for(let a=0;a<r;a++)s=bech32Polymod(s)^t.charCodeAt(a)&31;for(let a of e)s=bech32Polymod(s)^a;for(let a=0;a<6;a++)s=bech32Polymod(s);return s^=n,BECH_ALPHABET.encode(convertRadix2([s%2**30],30,5,!1))}function genBech32(t){const e=t==="bech32"?1:734539939,n=radix2(5),r=n.decode,s=n.encode,a=unsafeWrapper(r);function o(p,m,v=90){if(typeof p!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof p}`);if(!Array.isArray(m)||m.length&&typeof m[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof m}`);const _=p.length+7+m.length;if(v!==!1&&_>v)throw new TypeError(`Length ${_} exceeds limit ${v}`);return p=p.toLowerCase(),`${p}1${BECH_ALPHABET.encode(m)}${bechChecksum(p,m,e)}`}function l(p,m=90){if(typeof p!="string")throw new Error(`bech32.decode input should be string, not ${typeof p}`);if(p.length<8||m!==!1&&p.length>m)throw new TypeError(`Wrong string length: ${p.length} (${p}). Expected (8..${m})`);const v=p.toLowerCase();if(p!==v&&p!==p.toUpperCase())throw new Error("String must be lowercase or uppercase");p=v;const _=p.lastIndexOf("1");if(_===0||_===-1)throw new Error('Letter "1" must be present between prefix and data only');const S=p.slice(0,_),T=p.slice(_+1);if(T.length<6)throw new Error("Data must be at least 6 characters long");const k=BECH_ALPHABET.decode(T).slice(0,-6),O=bechChecksum(S,k,e);if(!T.endsWith(O))throw new Error(`Invalid checksum in ${p}: expected "${O}"`);return{prefix:S,words:k}}const h=unsafeWrapper(l);function y(p){const{prefix:m,words:v}=l(p,!1);return{prefix:m,words:v,bytes:r(v)}}return{encode:o,decode:l,decodeToBytes:y,decodeUnsafe:h,fromWords:r,fromWordsUnsafe:a,toWords:s}}const bech32$1=genBech32("bech32");genBech32("bech32m");const utf8$1={encode:t=>new TextDecoder().decode(t),decode:t=>new TextEncoder().encode(t)},hex$1=chain(radix2(4),alphabet("0123456789abcdef"),join(""),normalize$1(t=>{if(typeof t!="string"||t.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()})),CODERS={utf8:utf8$1,hex:hex$1,base16,base32,base64,base64url,base58,base58xmr};`${Object.keys(CODERS).join(", ")}`;function number(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function bool(t){if(typeof t!="boolean")throw new Error(`boolean expected, not ${t}`)}function isBytes(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function bytes(t,...e){if(!isBytes(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}function exists(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output(t,e){bytes(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const u32=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),createView=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE)throw new Error("Non little-endian hardware is not supported");const hexes=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex(t){bytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes[t[n]];return e}const asciis={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16(t){if(t>=asciis._0&&t<=asciis._9)return t-asciis._0;if(t>=asciis._A&&t<=asciis._F)return t-(asciis._A-10);if(t>=asciis._a&&t<=asciis._f)return t-(asciis._a-10)}function hexToBytes(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let s=0,a=0;s<n;s++,a+=2){const o=asciiToBase16(t.charCodeAt(a)),l=asciiToBase16(t.charCodeAt(a+1));if(o===void 0||l===void 0){const h=t[a]+t[a+1];throw new Error('hex string expected, got non-hex character "'+h+'" at index '+a)}r[s]=o*16+l}return r}function utf8ToBytes(t){if(typeof t!="string")throw new Error(`string expected, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes(t){if(typeof t=="string")t=utf8ToBytes(t);else if(isBytes(t))t=t.slice();else throw new Error(`Uint8Array expected, got ${typeof t}`);return t}function checkOpts(t,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(t,e)}function equalBytes(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}const wrapCipher=(t,e)=>(Object.assign(e,t),e);function setBigUint64(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),a=BigInt(4294967295),o=Number(n>>s&a),l=Number(n&a),h=4,y=0;t.setUint32(e+h,o,r),t.setUint32(e+y,l,r)}const BLOCK_SIZE=16,POLY=283;function mul2(t){return t<<1^POLY&-(t>>7)}function mul(t,e){let n=0;for(;e>0;e>>=1)n^=t&-(e&1),t=mul2(t);return n}const sbox=(()=>{let t=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=mul2(r))t[n]=r;const e=new Uint8Array(256);e[0]=99;for(let n=0;n<255;n++){let r=t[255-n];r|=r<<8,e[t[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return e})(),invSbox=sbox.map((t,e)=>sbox.indexOf(e)),rotr32_8=t=>t<<24|t>>>8,rotl32_8=t=>t<<8|t>>>24;function genTtable(t,e){if(t.length!==256)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map((y,p)=>e(t[p])),r=n.map(rotl32_8),s=r.map(rotl32_8),a=s.map(rotl32_8),o=new Uint32Array(256*256),l=new Uint32Array(256*256),h=new Uint16Array(256*256);for(let y=0;y<256;y++)for(let p=0;p<256;p++){const m=y*256+p;o[m]=n[y]^r[p],l[m]=s[y]^a[p],h[m]=t[y]<<8|t[p]}return{sbox:t,sbox2:h,T0:n,T1:r,T2:s,T3:a,T01:o,T23:l}}const tableEncoding=genTtable(sbox,t=>mul(t,3)<<24|t<<16|t<<8|mul(t,2)),tableDecoding=genTtable(invSbox,t=>mul(t,11)<<24|mul(t,13)<<16|mul(t,9)<<8|mul(t,14)),xPowers=(()=>{const t=new Uint8Array(16);for(let e=0,n=1;e<16;e++,n=mul2(n))t[e]=n;return t})();function expandKeyLE(t){bytes(t);const e=t.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:n}=tableEncoding,r=u32(t),s=r.length,a=l=>applySbox(n,l,l,l,l),o=new Uint32Array(e+28);o.set(r);for(let l=s;l<o.length;l++){let h=o[l-1];l%s===0?h=a(rotr32_8(h))^xPowers[l/s-1]:s>6&&l%s===4&&(h=a(h)),o[l]=o[l-s]^h}return o}function expandKeyDecLE(t){const e=expandKeyLE(t),n=e.slice(),r=e.length,{sbox2:s}=tableEncoding,{T0:a,T1:o,T2:l,T3:h}=tableDecoding;for(let y=0;y<r;y+=4)for(let p=0;p<4;p++)n[y+p]=e[r-y-4+p];e.fill(0);for(let y=4;y<r-4;y++){const p=n[y],m=applySbox(s,p,p,p,p);n[y]=a[m&255]^o[m>>>8&255]^l[m>>>16&255]^h[m>>>24]}return n}function apply0123(t,e,n,r,s,a){return t[n<<8&65280|r>>>8&255]^e[s>>>8&65280|a>>>24&255]}function applySbox(t,e,n,r,s){return t[e&255|n&65280]|t[r>>>16&255|s>>>16&65280]<<16}function encrypt$4(t,e,n,r,s){const{sbox2:a,T01:o,T23:l}=tableEncoding;let h=0;e^=t[h++],n^=t[h++],r^=t[h++],s^=t[h++];const y=t.length/4-2;for(let S=0;S<y;S++){const T=t[h++]^apply0123(o,l,e,n,r,s),k=t[h++]^apply0123(o,l,n,r,s,e),O=t[h++]^apply0123(o,l,r,s,e,n),q=t[h++]^apply0123(o,l,s,e,n,r);e=T,n=k,r=O,s=q}const p=t[h++]^applySbox(a,e,n,r,s),m=t[h++]^applySbox(a,n,r,s,e),v=t[h++]^applySbox(a,r,s,e,n),_=t[h++]^applySbox(a,s,e,n,r);return{s0:p,s1:m,s2:v,s3:_}}function decrypt$4(t,e,n,r,s){const{sbox2:a,T01:o,T23:l}=tableDecoding;let h=0;e^=t[h++],n^=t[h++],r^=t[h++],s^=t[h++];const y=t.length/4-2;for(let S=0;S<y;S++){const T=t[h++]^apply0123(o,l,e,s,r,n),k=t[h++]^apply0123(o,l,n,e,s,r),O=t[h++]^apply0123(o,l,r,n,e,s),q=t[h++]^apply0123(o,l,s,r,n,e);e=T,n=k,r=O,s=q}const p=t[h++]^applySbox(a,e,s,r,n),m=t[h++]^applySbox(a,n,e,s,r),v=t[h++]^applySbox(a,r,n,e,s),_=t[h++]^applySbox(a,s,r,n,e);return{s0:p,s1:m,s2:v,s3:_}}function getDst(t,e){if(!e)return new Uint8Array(t);if(bytes(e),e.length<t)throw new Error(`aes: wrong destination length, expected at least ${t}, got: ${e.length}`);return e}function validateBlockDecrypt(t){if(bytes(t),t.length%BLOCK_SIZE!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${BLOCK_SIZE}`)}function validateBlockEncrypt(t,e,n){let r=t.length;const s=r%BLOCK_SIZE;if(!e&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const a=u32(t);if(e){let h=BLOCK_SIZE-s;h||(h=BLOCK_SIZE),r=r+h}const o=getDst(r,n),l=u32(o);return{b:a,o:l,out:o}}function validatePCKS(t,e){if(!e)return t;const n=t.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const r=t[n-1];if(r<=0||r>16)throw new Error(`aes/pcks5: wrong padding byte: ${r}`);const s=t.subarray(0,-r);for(let a=0;a<r;a++)if(t[n-a-1]!==r)throw new Error("aes/pcks5: wrong padding");return s}function padPCKS(t){const e=new Uint8Array(16),n=u32(e);e.set(t);const r=BLOCK_SIZE-t.length;for(let s=BLOCK_SIZE-r;s<BLOCK_SIZE;s++)e[s]=r;return n}const cbc=wrapCipher({blockSize:16,nonceLength:16},function t(e,n,r={}){bytes(e),bytes(n,16);const s=!r.disablePadding;return{encrypt:(a,o)=>{const l=expandKeyLE(e),{b:h,o:y,out:p}=validateBlockEncrypt(a,s,o),m=u32(n);let v=m[0],_=m[1],S=m[2],T=m[3],k=0;for(;k+4<=h.length;)v^=h[k+0],_^=h[k+1],S^=h[k+2],T^=h[k+3],{s0:v,s1:_,s2:S,s3:T}=encrypt$4(l,v,_,S,T),y[k++]=v,y[k++]=_,y[k++]=S,y[k++]=T;if(s){const O=padPCKS(a.subarray(k*4));v^=O[0],_^=O[1],S^=O[2],T^=O[3],{s0:v,s1:_,s2:S,s3:T}=encrypt$4(l,v,_,S,T),y[k++]=v,y[k++]=_,y[k++]=S,y[k++]=T}return l.fill(0),p},decrypt:(a,o)=>{validateBlockDecrypt(a);const l=expandKeyDecLE(e),h=u32(n),y=getDst(a.length,o),p=u32(a),m=u32(y);let v=h[0],_=h[1],S=h[2],T=h[3];for(let k=0;k+4<=p.length;){const O=v,q=_,z=S,Q=T;v=p[k+0],_=p[k+1],S=p[k+2],T=p[k+3];const{s0:ye,s1:ie,s2:te,s3:ae}=decrypt$4(l,v,_,S,T);m[k++]=ye^O,m[k++]=ie^q,m[k++]=te^z,m[k++]=ae^Q}return l.fill(0),validatePCKS(y,s)}}}),u8to16=(t,e)=>t[e++]&255|(t[e++]&255)<<8;class Poly1305{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=toBytes(e),bytes(e,32);const n=u8to16(e,0),r=u8to16(e,2),s=u8to16(e,4),a=u8to16(e,6),o=u8to16(e,8),l=u8to16(e,10),h=u8to16(e,12),y=u8to16(e,14);this.r[0]=n&8191,this.r[1]=(n>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|a<<9)&8191,this.r[4]=(a>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|l<<2)&8191,this.r[7]=(l>>>11|h<<5)&8065,this.r[8]=(h>>>8|y<<8)&8191,this.r[9]=y>>>5&127;for(let p=0;p<8;p++)this.pad[p]=u8to16(e,16+2*p)}process(e,n,r=!1){const s=r?0:2048,{h:a,r:o}=this,l=o[0],h=o[1],y=o[2],p=o[3],m=o[4],v=o[5],_=o[6],S=o[7],T=o[8],k=o[9],O=u8to16(e,n+0),q=u8to16(e,n+2),z=u8to16(e,n+4),Q=u8to16(e,n+6),ye=u8to16(e,n+8),ie=u8to16(e,n+10),te=u8to16(e,n+12),ae=u8to16(e,n+14);let ne=a[0]+(O&8191),me=a[1]+((O>>>13|q<<3)&8191),B=a[2]+((q>>>10|z<<6)&8191),F=a[3]+((z>>>7|Q<<9)&8191),j=a[4]+((Q>>>4|ye<<12)&8191),H=a[5]+(ye>>>1&8191),V=a[6]+((ye>>>14|ie<<2)&8191),W=a[7]+((ie>>>11|te<<5)&8191),Z=a[8]+((te>>>8|ae<<8)&8191),oe=a[9]+(ae>>>5|s),A=0,J=A+ne*l+me*(5*k)+B*(5*T)+F*(5*S)+j*(5*_);A=J>>>13,J&=8191,J+=H*(5*v)+V*(5*m)+W*(5*p)+Z*(5*y)+oe*(5*h),A+=J>>>13,J&=8191;let X=A+ne*h+me*l+B*(5*k)+F*(5*T)+j*(5*S);A=X>>>13,X&=8191,X+=H*(5*_)+V*(5*v)+W*(5*m)+Z*(5*p)+oe*(5*y),A+=X>>>13,X&=8191;let de=A+ne*y+me*h+B*l+F*(5*k)+j*(5*T);A=de>>>13,de&=8191,de+=H*(5*S)+V*(5*_)+W*(5*v)+Z*(5*m)+oe*(5*p),A+=de>>>13,de&=8191;let ve=A+ne*p+me*y+B*h+F*l+j*(5*k);A=ve>>>13,ve&=8191,ve+=H*(5*T)+V*(5*S)+W*(5*_)+Z*(5*v)+oe*(5*m),A+=ve>>>13,ve&=8191;let we=A+ne*m+me*p+B*y+F*h+j*l;A=we>>>13,we&=8191,we+=H*(5*k)+V*(5*T)+W*(5*S)+Z*(5*_)+oe*(5*v),A+=we>>>13,we&=8191;let $e=A+ne*v+me*m+B*p+F*y+j*h;A=$e>>>13,$e&=8191,$e+=H*l+V*(5*k)+W*(5*T)+Z*(5*S)+oe*(5*_),A+=$e>>>13,$e&=8191;let Re=A+ne*_+me*v+B*m+F*p+j*y;A=Re>>>13,Re&=8191,Re+=H*h+V*l+W*(5*k)+Z*(5*T)+oe*(5*S),A+=Re>>>13,Re&=8191;let De=A+ne*S+me*_+B*v+F*m+j*p;A=De>>>13,De&=8191,De+=H*y+V*h+W*l+Z*(5*k)+oe*(5*T),A+=De>>>13,De&=8191;let Ke=A+ne*T+me*S+B*_+F*v+j*m;A=Ke>>>13,Ke&=8191,Ke+=H*p+V*y+W*h+Z*l+oe*(5*k),A+=Ke>>>13,Ke&=8191;let pe=A+ne*k+me*T+B*S+F*_+j*v;A=pe>>>13,pe&=8191,pe+=H*m+V*p+W*y+Z*h+oe*l,A+=pe>>>13,pe&=8191,A=(A<<2)+A|0,A=A+J|0,J=A&8191,A=A>>>13,X+=A,a[0]=J,a[1]=X,a[2]=de,a[3]=ve,a[4]=we,a[5]=$e,a[6]=Re,a[7]=De,a[8]=Ke,a[9]=pe}finalize(){const{h:e,pad:n}=this,r=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let l=2;l<10;l++)e[l]+=s,s=e[l]>>>13,e[l]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,r[0]=e[0]+5,s=r[0]>>>13,r[0]&=8191;for(let l=1;l<10;l++)r[l]=e[l]+s,s=r[l]>>>13,r[l]&=8191;r[9]-=8192;let a=(s^1)-1;for(let l=0;l<10;l++)r[l]&=a;a=~a;for(let l=0;l<10;l++)e[l]=e[l]&a|r[l];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+n[0];e[0]=o&65535;for(let l=1;l<8;l++)o=(e[l]+n[l]|0)+(o>>>16)|0,e[l]=o&65535}update(e){exists(this);const{buffer:n,blockLen:r}=this;e=toBytes(e);const s=e.length;for(let a=0;a<s;){const o=Math.min(r-this.pos,s-a);if(o===r){for(;r<=s-a;a+=r)this.process(e,a);continue}n.set(e.subarray(a,a+o),this.pos),this.pos+=o,a+=o,this.pos===r&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){exists(this),output(e,this),this.finished=!0;const{buffer:n,h:r}=this;let{pos:s}=this;if(s){for(n[s++]=1;s<16;s++)n[s]=0;this.process(n,0,!0)}this.finalize();let a=0;for(let o=0;o<8;o++)e[a++]=r[o]>>>0,e[a++]=r[o]>>>8;return e}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}}function wrapConstructorWithKey(t){const e=(r,s)=>t(s).update(toBytes(r)).digest(),n=t(new Uint8Array(32));return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=r=>t(r),e}const poly1305=wrapConstructorWithKey(t=>new Poly1305(t)),_utf8ToBytes=t=>Uint8Array.from(t.split("").map(e=>e.charCodeAt(0))),sigma16=_utf8ToBytes("expand 16-byte k"),sigma32=_utf8ToBytes("expand 32-byte k"),sigma16_32=u32(sigma16),sigma32_32=u32(sigma32);sigma32_32.slice();function rotl(t,e){return t<<e|t>>>32-e}function isAligned32(t){return t.byteOffset%4===0}const BLOCK_LEN=64,BLOCK_LEN32=16,MAX_COUNTER=2**32-1,U32_EMPTY=new Uint32Array;function runCipher(t,e,n,r,s,a,o,l){const h=s.length,y=new Uint8Array(BLOCK_LEN),p=u32(y),m=isAligned32(s)&&isAligned32(a),v=m?u32(s):U32_EMPTY,_=m?u32(a):U32_EMPTY;for(let S=0;S<h;o++){if(t(e,n,r,p,o,l),o>=MAX_COUNTER)throw new Error("arx: counter overflow");const T=Math.min(BLOCK_LEN,h-S);if(m&&T===BLOCK_LEN){const k=S/4;if(S%4!==0)throw new Error("arx: invalid block position");for(let O=0,q;O<BLOCK_LEN32;O++)q=k+O,_[q]=v[q]^p[O];S+=BLOCK_LEN;continue}for(let k=0,O;k<T;k++)O=S+k,a[O]=s[O]^y[k];S+=T}}function createCipher(t,e){const{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:a,rounds:o}=checkOpts({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof t!="function")throw new Error("core must be a function");return number(s),number(o),bool(a),bool(n),(l,h,y,p,m=0)=>{bytes(l),bytes(h),bytes(y);const v=y.length;if(p||(p=new Uint8Array(v)),bytes(p),number(m),m<0||m>=MAX_COUNTER)throw new Error("arx: counter overflow");if(p.length<v)throw new Error(`arx: output (${p.length}) is shorter than data (${v})`);const _=[];let S=l.length,T,k;if(S===32)T=l.slice(),_.push(T),k=sigma32_32;else if(S===16&&n)T=new Uint8Array(32),T.set(l),T.set(l,16),k=sigma16_32,_.push(T);else throw new Error(`arx: invalid 32-byte key, got length=${S}`);isAligned32(h)||(h=h.slice(),_.push(h));const O=u32(T);if(r){if(h.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(k,O,u32(h.subarray(0,16)),O),h=h.subarray(16)}const q=16-s;if(q!==h.length)throw new Error(`arx: nonce must be ${q} or 16 bytes`);if(q!==12){const Q=new Uint8Array(12);Q.set(h,a?0:12-h.length),h=Q,_.push(h)}const z=u32(h);for(runCipher(t,k,O,z,y,p,m,o);_.length>0;)_.pop().fill(0);return p}}function chachaCore(t,e,n,r,s,a=20){let o=t[0],l=t[1],h=t[2],y=t[3],p=e[0],m=e[1],v=e[2],_=e[3],S=e[4],T=e[5],k=e[6],O=e[7],q=s,z=n[0],Q=n[1],ye=n[2],ie=o,te=l,ae=h,ne=y,me=p,B=m,F=v,j=_,H=S,V=T,W=k,Z=O,oe=q,A=z,J=Q,X=ye;for(let ve=0;ve<a;ve+=2)ie=ie+me|0,oe=rotl(oe^ie,16),H=H+oe|0,me=rotl(me^H,12),ie=ie+me|0,oe=rotl(oe^ie,8),H=H+oe|0,me=rotl(me^H,7),te=te+B|0,A=rotl(A^te,16),V=V+A|0,B=rotl(B^V,12),te=te+B|0,A=rotl(A^te,8),V=V+A|0,B=rotl(B^V,7),ae=ae+F|0,J=rotl(J^ae,16),W=W+J|0,F=rotl(F^W,12),ae=ae+F|0,J=rotl(J^ae,8),W=W+J|0,F=rotl(F^W,7),ne=ne+j|0,X=rotl(X^ne,16),Z=Z+X|0,j=rotl(j^Z,12),ne=ne+j|0,X=rotl(X^ne,8),Z=Z+X|0,j=rotl(j^Z,7),ie=ie+B|0,X=rotl(X^ie,16),W=W+X|0,B=rotl(B^W,12),ie=ie+B|0,X=rotl(X^ie,8),W=W+X|0,B=rotl(B^W,7),te=te+F|0,oe=rotl(oe^te,16),Z=Z+oe|0,F=rotl(F^Z,12),te=te+F|0,oe=rotl(oe^te,8),Z=Z+oe|0,F=rotl(F^Z,7),ae=ae+j|0,A=rotl(A^ae,16),H=H+A|0,j=rotl(j^H,12),ae=ae+j|0,A=rotl(A^ae,8),H=H+A|0,j=rotl(j^H,7),ne=ne+me|0,J=rotl(J^ne,16),V=V+J|0,me=rotl(me^V,12),ne=ne+me|0,J=rotl(J^ne,8),V=V+J|0,me=rotl(me^V,7);let de=0;r[de++]=o+ie|0,r[de++]=l+te|0,r[de++]=h+ae|0,r[de++]=y+ne|0,r[de++]=p+me|0,r[de++]=m+B|0,r[de++]=v+F|0,r[de++]=_+j|0,r[de++]=S+H|0,r[de++]=T+V|0,r[de++]=k+W|0,r[de++]=O+Z|0,r[de++]=q+oe|0,r[de++]=z+A|0,r[de++]=Q+J|0,r[de++]=ye+X|0}function hchacha(t,e,n,r){let s=t[0],a=t[1],o=t[2],l=t[3],h=e[0],y=e[1],p=e[2],m=e[3],v=e[4],_=e[5],S=e[6],T=e[7],k=n[0],O=n[1],q=n[2],z=n[3];for(let ye=0;ye<20;ye+=2)s=s+h|0,k=rotl(k^s,16),v=v+k|0,h=rotl(h^v,12),s=s+h|0,k=rotl(k^s,8),v=v+k|0,h=rotl(h^v,7),a=a+y|0,O=rotl(O^a,16),_=_+O|0,y=rotl(y^_,12),a=a+y|0,O=rotl(O^a,8),_=_+O|0,y=rotl(y^_,7),o=o+p|0,q=rotl(q^o,16),S=S+q|0,p=rotl(p^S,12),o=o+p|0,q=rotl(q^o,8),S=S+q|0,p=rotl(p^S,7),l=l+m|0,z=rotl(z^l,16),T=T+z|0,m=rotl(m^T,12),l=l+m|0,z=rotl(z^l,8),T=T+z|0,m=rotl(m^T,7),s=s+y|0,z=rotl(z^s,16),S=S+z|0,y=rotl(y^S,12),s=s+y|0,z=rotl(z^s,8),S=S+z|0,y=rotl(y^S,7),a=a+p|0,k=rotl(k^a,16),T=T+k|0,p=rotl(p^T,12),a=a+p|0,k=rotl(k^a,8),T=T+k|0,p=rotl(p^T,7),o=o+m|0,O=rotl(O^o,16),v=v+O|0,m=rotl(m^v,12),o=o+m|0,O=rotl(O^o,8),v=v+O|0,m=rotl(m^v,7),l=l+h|0,q=rotl(q^l,16),_=_+q|0,h=rotl(h^_,12),l=l+h|0,q=rotl(q^l,8),_=_+q|0,h=rotl(h^_,7);let Q=0;r[Q++]=s,r[Q++]=a,r[Q++]=o,r[Q++]=l,r[Q++]=k,r[Q++]=O,r[Q++]=q,r[Q++]=z}const chacha20=createCipher(chachaCore,{counterRight:!1,counterLength:4,allowShortKeys:!1}),xchacha20=createCipher(chachaCore,{counterRight:!1,counterLength:8,extendNonceFn:hchacha,allowShortKeys:!1}),ZEROS16=new Uint8Array(16),updatePadded=(t,e)=>{t.update(e);const n=e.length%16;n&&t.update(ZEROS16.subarray(n))},ZEROS32=new Uint8Array(32);function computeTag(t,e,n,r,s){const a=t(e,n,ZEROS32),o=poly1305.create(a);s&&updatePadded(o,s),updatePadded(o,r);const l=new Uint8Array(16),h=createView(l);setBigUint64(h,0,BigInt(s?s.length:0),!0),setBigUint64(h,8,BigInt(r.length),!0),o.update(l);const y=o.digest();return a.fill(0),y}const _poly1305_aead=t=>(e,n,r)=>(bytes(e,32),bytes(n),{encrypt:(a,o)=>{const l=a.length,h=l+16;o?bytes(o,h):o=new Uint8Array(h),t(e,n,a,o,1);const y=computeTag(t,e,n,o.subarray(0,-16),r);return o.set(y,l),o},decrypt:(a,o)=>{const l=a.length,h=l-16;if(l<16)throw new Error("encrypted data must be at least 16 bytes");o?bytes(o,h):o=new Uint8Array(h);const y=a.subarray(0,-16),p=a.subarray(-16),m=computeTag(t,e,n,y,r);if(!equalBytes(p,m))throw new Error("invalid tag");return t(e,n,y,o,1),o}}),xchacha20poly1305=wrapCipher({blockSize:64,nonceLength:24,tagLength:16},_poly1305_aead(xchacha20));var hkdf$1={};Object.defineProperty(hkdf$1,"__esModule",{value:!0});hkdf$1.hkdf=void 0;var extract_1=hkdf$1.extract=extract,expand_1=hkdf$1.expand=expand;const hmac_ts_1$1=hmac,utils_ts_1$2=utils$1;function extract(t,e,n){return(0,utils_ts_1$2.ahash)(t),n===void 0&&(n=new Uint8Array(t.outputLen)),(0,hmac_ts_1$1.hmac)(t,(0,utils_ts_1$2.toBytes)(n),(0,utils_ts_1$2.toBytes)(e))}const HKDF_COUNTER=Uint8Array.from([0]),EMPTY_BUFFER=Uint8Array.of();function expand(t,e,n,r=32){(0,utils_ts_1$2.ahash)(t),(0,utils_ts_1$2.anumber)(r);const s=t.outputLen;if(r>255*s)throw new Error("Length should be <= 255*HashLen");const a=Math.ceil(r/s);n===void 0&&(n=EMPTY_BUFFER);const o=new Uint8Array(a*s),l=hmac_ts_1$1.hmac.create(t,e),h=l._cloneInto(),y=new Uint8Array(l.outputLen);for(let p=0;p<a;p++)HKDF_COUNTER[0]=p+1,h.update(p===0?EMPTY_BUFFER:y).update(n).update(HKDF_COUNTER).digestInto(y),o.set(y,s*p),l._cloneInto(h);return l.destroy(),h.destroy(),(0,utils_ts_1$2.clean)(y,HKDF_COUNTER),o.slice(0,r)}const hkdf=(t,e,n,r,s)=>expand(t,extract(t,e,n),r,s);hkdf$1.hkdf=hkdf;var __defProp$2=Object.defineProperty,__export=(t,e)=>{for(var n in e)__defProp$2(t,n,{get:e[n],enumerable:!0})},verifiedSymbol$1=Symbol("verified"),isRecord$1=t=>t instanceof Object;function validateEvent$1(t){if(!isRecord$1(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}var utils_exports={};__export(utils_exports,{Queue:()=>Queue$1,QueueNode:()=>QueueNode,binarySearch:()=>binarySearch,bytesToHex:()=>utils$1.bytesToHex,hexToBytes:()=>utils$1.hexToBytes,insertEventIntoAscendingList:()=>insertEventIntoAscendingList,insertEventIntoDescendingList:()=>insertEventIntoDescendingList,normalizeURL:()=>normalizeURL,utf8Decoder:()=>utf8Decoder$1,utf8Encoder:()=>utf8Encoder$2});var utf8Decoder$1=new TextDecoder("utf-8"),utf8Encoder$2=new TextEncoder;function normalizeURL(t){try{t.indexOf("://")===-1&&(t="wss://"+t);let e=new URL(t);return e.protocol==="http:"?e.protocol="ws:":e.protocol==="https:"&&(e.protocol="wss:"),e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}catch{throw new Error(`Invalid URL: ${t}`)}}function insertEventIntoDescendingList(t,e){const[n,r]=binarySearch(t,s=>e.id===s.id?0:e.created_at===s.created_at?-1:s.created_at-e.created_at);return r||t.splice(n,0,e),t}function insertEventIntoAscendingList(t,e){const[n,r]=binarySearch(t,s=>e.id===s.id?0:e.created_at===s.created_at?-1:e.created_at-s.created_at);return r||t.splice(n,0,e),t}function binarySearch(t,e){let n=0,r=t.length-1;for(;n<=r;){const s=Math.floor((n+r)/2),a=e(t[s]);if(a===0)return[s,!0];a<0?r=s-1:n=s+1}return[n,!1]}var QueueNode=class{value;next=null;prev=null;constructor(t){this.value=t}},Queue$1=class{first;last;constructor(){this.first=null,this.last=null}enqueue(e){const n=new QueueNode(e);return this.last?this.last===this.first?(this.last=n,this.last.prev=this.first,this.first.next=n):(n.prev=this.last,this.last.next=n,this.last=n):(this.first=n,this.last=n),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const n=this.first;return this.first=null,this.last=null,n.value}const e=this.first;return this.first=e.next,this.first&&(this.first.prev=null),e.value}},JS$1=class{generateSecretKey(){return schnorr.utils.randomPrivateKey()}getPublicKey(e){return utils$1.bytesToHex(schnorr.getPublicKey(e))}finalizeEvent(e,n){const r=e;return r.pubkey=utils$1.bytesToHex(schnorr.getPublicKey(n)),r.id=getEventHash$3(r),r.sig=utils$1.bytesToHex(schnorr.sign(getEventHash$3(r),n)),r[verifiedSymbol$1]=!0,r}verifyEvent(e){if(typeof e[verifiedSymbol$1]=="boolean")return e[verifiedSymbol$1];const n=getEventHash$3(e);if(n!==e.id)return e[verifiedSymbol$1]=!1,!1;try{const r=schnorr.verify(e.sig,n,e.pubkey);return e[verifiedSymbol$1]=r,r}catch{return e[verifiedSymbol$1]=!1,!1}}};function serializeEvent$1(t){if(!validateEvent$1(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function getEventHash$3(t){let e=sha256_1(utf8Encoder$2.encode(serializeEvent$1(t)));return utils$1.bytesToHex(e)}var i$1=new JS$1,generateSecretKey=i$1.generateSecretKey,getPublicKey=i$1.getPublicKey,finalizeEvent=i$1.finalizeEvent,verifyEvent=i$1.verifyEvent,kinds_exports={};__export(kinds_exports,{Application:()=>Application,BadgeAward:()=>BadgeAward,BadgeDefinition:()=>BadgeDefinition,BlockedRelaysList:()=>BlockedRelaysList,BlossomServerList:()=>BlossomServerList,BookmarkList:()=>BookmarkList,Bookmarksets:()=>Bookmarksets,Calendar:()=>Calendar,CalendarEventRSVP:()=>CalendarEventRSVP,ChannelCreation:()=>ChannelCreation,ChannelHideMessage:()=>ChannelHideMessage,ChannelMessage:()=>ChannelMessage,ChannelMetadata:()=>ChannelMetadata,ChannelMuteUser:()=>ChannelMuteUser,ChatMessage:()=>ChatMessage,ClassifiedListing:()=>ClassifiedListing,ClientAuth:()=>ClientAuth,Comment:()=>Comment,CommunitiesList:()=>CommunitiesList,CommunityDefinition:()=>CommunityDefinition,CommunityPostApproval:()=>CommunityPostApproval,Contacts:()=>Contacts,CreateOrUpdateProduct:()=>CreateOrUpdateProduct,CreateOrUpdateStall:()=>CreateOrUpdateStall,Curationsets:()=>Curationsets,Date:()=>Date2,DirectMessageRelaysList:()=>DirectMessageRelaysList,DraftClassifiedListing:()=>DraftClassifiedListing,DraftLong:()=>DraftLong,Emojisets:()=>Emojisets,EncryptedDirectMessage:()=>EncryptedDirectMessage,EventDeletion:()=>EventDeletion,FavoriteRelays:()=>FavoriteRelays,FileMessage:()=>FileMessage,FileMetadata:()=>FileMetadata,FileServerPreference:()=>FileServerPreference,Followsets:()=>Followsets,ForumThread:()=>ForumThread,GenericRepost:()=>GenericRepost,Genericlists:()=>Genericlists,GiftWrap:()=>GiftWrap,GroupMetadata:()=>GroupMetadata,HTTPAuth:()=>HTTPAuth$1,Handlerinformation:()=>Handlerinformation,Handlerrecommendation:()=>Handlerrecommendation,Highlights:()=>Highlights,InterestsList:()=>InterestsList,Interestsets:()=>Interestsets,JobFeedback:()=>JobFeedback,JobRequest:()=>JobRequest,JobResult:()=>JobResult,Label:()=>Label,LightningPubRPC:()=>LightningPubRPC,LiveChatMessage:()=>LiveChatMessage,LiveEvent:()=>LiveEvent,LongFormArticle:()=>LongFormArticle,Metadata:()=>Metadata,Mutelist:()=>Mutelist,NWCWalletInfo:()=>NWCWalletInfo,NWCWalletRequest:()=>NWCWalletRequest,NWCWalletResponse:()=>NWCWalletResponse,NormalVideo:()=>NormalVideo,NostrConnect:()=>NostrConnect,OpenTimestamps:()=>OpenTimestamps,Photo:()=>Photo,Pinlist:()=>Pinlist,Poll:()=>Poll,PollResponse:()=>PollResponse,PrivateDirectMessage:()=>PrivateDirectMessage,ProblemTracker:()=>ProblemTracker,ProfileBadges:()=>ProfileBadges,PublicChatsList:()=>PublicChatsList,Reaction:()=>Reaction,RecommendRelay:()=>RecommendRelay,RelayList:()=>RelayList,RelayReview:()=>RelayReview,Relaysets:()=>Relaysets,Report:()=>Report,Reporting:()=>Reporting,Repost:()=>Repost,Seal:()=>Seal,SearchRelaysList:()=>SearchRelaysList,ShortTextNote:()=>ShortTextNote,ShortVideo:()=>ShortVideo,Time:()=>Time,UserEmojiList:()=>UserEmojiList,UserStatuses:()=>UserStatuses,Voice:()=>Voice,VoiceComment:()=>VoiceComment,Zap:()=>Zap,ZapGoal:()=>ZapGoal,ZapRequest:()=>ZapRequest,classifyKind:()=>classifyKind,isAddressableKind:()=>isAddressableKind,isEphemeralKind:()=>isEphemeralKind,isKind:()=>isKind,isRegularKind:()=>isRegularKind,isReplaceableKind:()=>isReplaceableKind});function isRegularKind(t){return t<1e4&&t!==0&&t!==3}function isReplaceableKind(t){return t===0||t===3||1e4<=t&&t<2e4}function isEphemeralKind(t){return 2e4<=t&&t<3e4}function isAddressableKind(t){return 3e4<=t&&t<4e4}function classifyKind(t){return isRegularKind(t)?"regular":isReplaceableKind(t)?"replaceable":isEphemeralKind(t)?"ephemeral":isAddressableKind(t)?"parameterized":"unknown"}function isKind(t,e){const n=e instanceof Array?e:[e];return validateEvent$1(t)&&n.includes(t.kind)||!1}var Metadata=0,ShortTextNote=1,RecommendRelay=2,Contacts=3,EncryptedDirectMessage=4,EventDeletion=5,Repost=6,Reaction=7,BadgeAward=8,ChatMessage=9,ForumThread=11,Seal=13,PrivateDirectMessage=14,FileMessage=15,GenericRepost=16,Photo=20,NormalVideo=21,ShortVideo=22,ChannelCreation=40,ChannelMetadata=41,ChannelMessage=42,ChannelHideMessage=43,ChannelMuteUser=44,OpenTimestamps=1040,GiftWrap=1059,Poll=1068,FileMetadata=1063,Comment=1111,LiveChatMessage=1311,Voice=1222,VoiceComment=1244,ProblemTracker=1971,Report=1984,Reporting=1984,Label=1985,CommunityPostApproval=4550,JobRequest=5999,JobResult=6999,JobFeedback=7e3,ZapGoal=9041,ZapRequest=9734,Zap=9735,Highlights=9802,PollResponse=1018,Mutelist=1e4,Pinlist=10001,RelayList=10002,BookmarkList=10003,CommunitiesList=10004,PublicChatsList=10005,BlockedRelaysList=10006,SearchRelaysList=10007,FavoriteRelays=10012,InterestsList=10015,UserEmojiList=10030,DirectMessageRelaysList=10050,FileServerPreference=10096,BlossomServerList=10063,NWCWalletInfo=13194,LightningPubRPC=21e3,ClientAuth=22242,NWCWalletRequest=23194,NWCWalletResponse=23195,NostrConnect=24133,HTTPAuth$1=27235,Followsets=3e4,Genericlists=30001,Relaysets=30002,Bookmarksets=30003,Curationsets=30004,ProfileBadges=30008,BadgeDefinition=30009,Interestsets=30015,CreateOrUpdateStall=30017,CreateOrUpdateProduct=30018,LongFormArticle=30023,DraftLong=30024,Emojisets=30030,Application=30078,LiveEvent=30311,UserStatuses=30315,ClassifiedListing=30402,DraftClassifiedListing=30403,Date2=31922,Time=31923,Calendar=31924,CalendarEventRSVP=31925,RelayReview=31987,Handlerrecommendation=31989,Handlerinformation=31990,CommunityDefinition=34550,GroupMetadata=39e3;function matchFilter(t,e){if(t.ids&&t.ids.indexOf(e.id)===-1||t.kinds&&t.kinds.indexOf(e.kind)===-1||t.authors&&t.authors.indexOf(e.pubkey)===-1)return!1;for(let n in t)if(n[0]==="#"){let r=n.slice(1),s=t[`#${r}`];if(s&&!e.tags.find(([a,o])=>a===n.slice(1)&&s.indexOf(o)!==-1))return!1}return!(t.since&&e.created_at<t.since||t.until&&e.created_at>t.until)}function matchFilters(t,e){for(let n=0;n<t.length;n++)if(matchFilter(t[n],e))return!0;return!1}var fakejson_exports={};__export(fakejson_exports,{getHex64:()=>getHex64,getInt:()=>getInt,getSubscriptionId:()=>getSubscriptionId,matchEventId:()=>matchEventId,matchEventKind:()=>matchEventKind,matchEventPubkey:()=>matchEventPubkey});function getHex64(t,e){let n=e.length+3,r=t.indexOf(`"${e}":`)+n,s=t.slice(r).indexOf('"')+r+1;return t.slice(s,s+64)}function getInt(t,e){let n=e.length,r=t.indexOf(`"${e}":`)+n+3,s=t.slice(r),a=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,a),10)}function getSubscriptionId(t){let e=t.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let n=t.slice(e+7+1).indexOf('"');if(n===-1)return null;let r=e+7+1+n,s=t.slice(r+1,80).indexOf('"');if(s===-1)return null;let a=r+1+s;return t.slice(r+1,a)}function matchEventId(t,e){return e===getHex64(t,"id")}function matchEventPubkey(t,e){return e===getHex64(t,"pubkey")}function matchEventKind(t,e){return e===getInt(t,"kind")}var nip42_exports={};__export(nip42_exports,{makeAuthEvent:()=>makeAuthEvent});function makeAuthEvent(t,e){return{kind:ClientAuth,created_at:Math.floor(Date.now()/1e3),tags:[["relay",t],["challenge",e]],content:""}}var _WebSocket;try{_WebSocket=WebSocket}catch{}var _WebSocket2;try{_WebSocket2=WebSocket}catch{}var nip19_exports$2={};__export(nip19_exports$2,{BECH32_REGEX:()=>BECH32_REGEX$2,Bech32MaxSize:()=>Bech32MaxSize$2,NostrTypeGuard:()=>NostrTypeGuard$1,decode:()=>decode$1,decodeNostrURI:()=>decodeNostrURI$1,encodeBytes:()=>encodeBytes$2,naddrEncode:()=>naddrEncode$1,neventEncode:()=>neventEncode$1,noteEncode:()=>noteEncode$1,nprofileEncode:()=>nprofileEncode$1,npubEncode:()=>npubEncode$1,nsecEncode:()=>nsecEncode$1});var NostrTypeGuard$1={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize$2=5e3,BECH32_REGEX$2=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array$1(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI$1(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode$1(t)}catch{return{type:"invalid",data:null}}}function decode$1(t){let{prefix:e,words:n}=bech32$1.decode(t,Bech32MaxSize$2),r=new Uint8Array(bech32$1.fromWords(n));switch(e){case"nprofile":{let s=parseTLV$1(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:utils$1.bytesToHex(s[0][0]),relays:s[1]?s[1].map(a=>utf8Decoder$1.decode(a)):[]}}}case"nevent":{let s=parseTLV$1(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:utils$1.bytesToHex(s[0][0]),relays:s[1]?s[1].map(a=>utf8Decoder$1.decode(a)):[],author:s[2]?.[0]?utils$1.bytesToHex(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(utils$1.bytesToHex(s[3][0]),16):void 0}}}case"naddr":{let s=parseTLV$1(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder$1.decode(s[0][0]),pubkey:utils$1.bytesToHex(s[2][0]),kind:parseInt(utils$1.bytesToHex(s[3][0]),16),relays:s[1]?s[1].map(a=>utf8Decoder$1.decode(a)):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:utils$1.bytesToHex(r)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV$1(t){let e={},n=t;for(;n.length>0;){let r=n[0],s=n[1],a=n.slice(2,2+s);if(n=n.slice(2+s),a.length<s)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(a)}return e}function nsecEncode$1(t){return encodeBytes$2("nsec",t)}function npubEncode$1(t){return encodeBytes$2("npub",utils$1.hexToBytes(t))}function noteEncode$1(t){return encodeBytes$2("note",utils$1.hexToBytes(t))}function encodeBech32$2(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize$2)}function encodeBytes$2(t,e){return encodeBech32$2(t,e)}function nprofileEncode$1(t){let e=encodeTLV$1({0:[utils$1.hexToBytes(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder$2.encode(n))});return encodeBech32$2("nprofile",e)}function neventEncode$1(t){let e;t.kind!==void 0&&(e=integerToUint8Array$1(t.kind));let n=encodeTLV$1({0:[utils$1.hexToBytes(t.id)],1:(t.relays||[]).map(r=>utf8Encoder$2.encode(r)),2:t.author?[utils$1.hexToBytes(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32$2("nevent",n)}function naddrEncode$1(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV$1({0:[utf8Encoder$2.encode(t.identifier)],1:(t.relays||[]).map(r=>utf8Encoder$2.encode(r)),2:[utils$1.hexToBytes(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32$2("naddr",n)}function encodeTLV$1(t){let e=[];return Object.entries(t).reverse().forEach(([n,r])=>{r.forEach(s=>{let a=new Uint8Array(s.length+2);a.set([parseInt(n)],0),a.set([s.length],1),a.set(s,2),e.push(a)})}),utils$1.concatBytes(...e)}var nip04_exports={};__export(nip04_exports,{decrypt:()=>decrypt$3,encrypt:()=>encrypt$3});function encrypt$3(t,e,n){const r=t instanceof Uint8Array?utils$1.bytesToHex(t):t,s=secp256k1.getSharedSecret(r,"02"+e),a=getNormalizedX(s);let o=Uint8Array.from(utils$1.randomBytes(16)),l=utf8Encoder$2.encode(n),h=cbc(a,o).encrypt(l),y=base64.encode(new Uint8Array(h)),p=base64.encode(new Uint8Array(o.buffer));return`${y}?iv=${p}`}function decrypt$3(t,e,n){const r=t instanceof Uint8Array?utils$1.bytesToHex(t):t;let[s,a]=n.split("?iv="),o=secp256k1.getSharedSecret(r,"02"+e),l=getNormalizedX(o),h=base64.decode(a),y=base64.decode(s),p=cbc(l,h).decrypt(y);return utf8Decoder$1.decode(p)}function getNormalizedX(t){return t.slice(1,33)}var nip05_exports={};__export(nip05_exports,{NIP05_REGEX:()=>NIP05_REGEX$2,isNip05:()=>isNip05,isValid:()=>isValid,queryProfile:()=>queryProfile,searchDomain:()=>searchDomain,useFetchImplementation:()=>useFetchImplementation});var NIP05_REGEX$2=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,isNip05=t=>NIP05_REGEX$2.test(t||""),_fetch;try{_fetch=fetch}catch(t){}function useFetchImplementation(t){_fetch=t}async function searchDomain(t,e=""){try{const n=`https://${t}/.well-known/nostr.json?name=${e}`,r=await _fetch(n,{redirect:"manual"});if(r.status!==200)throw Error("Wrong response code");return(await r.json()).names}catch{return{}}}async function queryProfile(t){const e=t.match(NIP05_REGEX$2);if(!e)return null;const[,n="_",r]=e;try{const s=`https://${r}/.well-known/nostr.json?name=${n}`,a=await _fetch(s,{redirect:"manual"});if(a.status!==200)throw Error("Wrong response code");const o=await a.json(),l=o.names[n];return l?{pubkey:l,relays:o.relays?.[l]}:null}catch{return null}}async function isValid(t,e){const n=await queryProfile(e);return n?n.pubkey===t:!1}var nip10_exports={};__export(nip10_exports,{parse:()=>parse});function parse(t){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let n,r;for(let s=t.tags.length-1;s>=0;s--){const a=t.tags[s];if(a[0]==="e"&&a[1]){const[o,l,h,y,p]=a,m={id:l,relays:h?[h]:[],author:p};if(y==="root"){e.root=m;continue}if(y==="reply"){e.reply=m;continue}if(y==="mention"){e.mentions.push(m);continue}n?r=m:n=m,e.mentions.push(m);continue}if(a[0]==="q"&&a[1]){const[o,l,h]=a;e.quotes.push({id:l,relays:h?[h]:[]})}if(a[0]==="p"&&a[1]){e.profiles.push({pubkey:a[1],relays:a[2]?[a[2]]:[]});continue}}return e.root||(e.root=r||n||e.reply),e.reply||(e.reply=n||e.root),[e.reply,e.root].forEach(s=>{if(!s)return;let a=e.mentions.indexOf(s);if(a!==-1&&e.mentions.splice(a,1),s.author){let o=e.profiles.find(l=>l.pubkey===s.author);o&&o.relays&&(s.relays||(s.relays=[]),o.relays.forEach(l=>{s.relays?.indexOf(l)===-1&&s.relays.push(l)}),o.relays=s.relays)}}),e.mentions.forEach(s=>{if(s.author){let a=e.profiles.find(o=>o.pubkey===s.author);a&&a.relays&&(s.relays||(s.relays=[]),a.relays.forEach(o=>{s.relays.indexOf(o)===-1&&s.relays.push(o)}),a.relays=s.relays)}}),e}var nip11_exports={};__export(nip11_exports,{fetchRelayInformation:()=>fetchRelayInformation$1,useFetchImplementation:()=>useFetchImplementation2});var _fetch2;try{_fetch2=fetch}catch{}function useFetchImplementation2(t){_fetch2=t}async function fetchRelayInformation$1(t){return await(await fetch(t.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var nip13_exports={};__export(nip13_exports,{fastEventHash:()=>fastEventHash,getPow:()=>getPow,minePow:()=>minePow});function getPow(t){let e=0;for(let n=0;n<64;n+=8){const r=parseInt(t.substring(n,n+8),16);if(r===0)e+=32;else{e+=Math.clz32(r);break}}return e}function minePow(t,e){let n=0;const r=t,s=["nonce",n.toString(),e.toString()];for(r.tags.push(s);;){const a=Math.floor(new Date().getTime()/1e3);if(a!==r.created_at&&(n=0,r.created_at=a),s[1]=(++n).toString(),r.id=fastEventHash(r),getPow(r.id)>=e)break}return r}function fastEventHash(t){return utils$1.bytesToHex(sha256_1(utf8Encoder$2.encode(JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]))))}var nip17_exports={};__export(nip17_exports,{unwrapEvent:()=>unwrapEvent2,unwrapManyEvents:()=>unwrapManyEvents2,wrapEvent:()=>wrapEvent2,wrapManyEvents:()=>wrapManyEvents2});var nip59_exports={};__export(nip59_exports,{createRumor:()=>createRumor,createSeal:()=>createSeal,createWrap:()=>createWrap,unwrapEvent:()=>unwrapEvent,unwrapManyEvents:()=>unwrapManyEvents,wrapEvent:()=>wrapEvent$1,wrapManyEvents:()=>wrapManyEvents});var nip44_exports={};__export(nip44_exports,{decrypt:()=>decrypt2,encrypt:()=>encrypt2,getConversationKey:()=>getConversationKey,v2:()=>v2});var minPlaintextSize=1,maxPlaintextSize=65535;function getConversationKey(t,e){const n=secp256k1.getSharedSecret(t,"02"+e).subarray(1,33);return extract_1(sha256_1,n,"nip44-v2")}function getMessageKeys(t,e){const n=expand_1(sha256_1,t,e,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function calcPaddedLen(t){if(!Number.isSafeInteger(t)||t<1)throw new Error("expected positive integer");if(t<=32)return 32;const e=1<<Math.floor(Math.log2(t-1))+1,n=e<=256?32:e/8;return n*(Math.floor((t-1)/n)+1)}function writeU16BE(t){if(!Number.isSafeInteger(t)||t<minPlaintextSize||t>maxPlaintextSize)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),e}function pad(t){const e=utf8Encoder$2.encode(t),n=e.length,r=writeU16BE(n),s=new Uint8Array(calcPaddedLen(n)-n);return utils$1.concatBytes(r,e,s)}function unpad(t){const e=new DataView(t.buffer).getUint16(0),n=t.subarray(2,2+e);if(e<minPlaintextSize||e>maxPlaintextSize||n.length!==e||t.length!==2+calcPaddedLen(e))throw new Error("invalid padding");return utf8Decoder$1.decode(n)}function hmacAad(t,e,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const r=utils$1.concatBytes(n,e);return hmac.hmac(sha256_1,t,r)}function decodePayload(t){if(typeof t!="string")throw new Error("payload must be a valid string");const e=t.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(t[0]==="#")throw new Error("unknown encryption version");let n;try{n=base64.decode(t)}catch(a){throw new Error("invalid base64: "+a.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const s=n[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function encrypt2(t,e,n=utils$1.randomBytes(32)){const{chacha_key:r,chacha_nonce:s,hmac_key:a}=getMessageKeys(e,n),o=pad(t),l=chacha20(r,s,o),h=hmacAad(a,l,n);return base64.encode(utils$1.concatBytes(new Uint8Array([2]),n,l,h))}function decrypt2(t,e){const{nonce:n,ciphertext:r,mac:s}=decodePayload(t),{chacha_key:a,chacha_nonce:o,hmac_key:l}=getMessageKeys(e,n),h=hmacAad(l,r,n);if(!equalBytes(h,s))throw new Error("invalid MAC");const y=chacha20(a,o,r);return unpad(y)}var v2={utils:{getConversationKey,calcPaddedLen},encrypt:encrypt2,decrypt:decrypt2},TWO_DAYS=2*24*60*60,now=()=>Math.round(Date.now()/1e3),randomNow=()=>Math.round(now()-Math.random()*TWO_DAYS),nip44ConversationKey=(t,e)=>getConversationKey(t,e),nip44Encrypt=(t,e,n)=>encrypt2(JSON.stringify(t),nip44ConversationKey(e,n)),nip44Decrypt=(t,e)=>JSON.parse(decrypt2(t.content,nip44ConversationKey(e,t.pubkey)));function createRumor(t,e){const n={created_at:now(),content:"",tags:[],...t,pubkey:getPublicKey(e)};return n.id=getEventHash$3(n),n}function createSeal(t,e,n){return finalizeEvent({kind:Seal,content:nip44Encrypt(t,e,n),created_at:randomNow(),tags:[]},e)}function createWrap(t,e){const n=generateSecretKey();return finalizeEvent({kind:GiftWrap,content:nip44Encrypt(t,n,e),created_at:randomNow(),tags:[["p",e]]},n)}function wrapEvent$1(t,e,n){const r=createRumor(t,e),s=createSeal(r,e,n);return createWrap(s,n)}function wrapManyEvents(t,e,n){if(!n||n.length===0)throw new Error("At least one recipient is required.");const r=getPublicKey(e),s=[wrapEvent$1(t,e,r)];return n.forEach(a=>{s.push(wrapEvent$1(t,e,a))}),s}function unwrapEvent(t,e){const n=nip44Decrypt(t,e);return nip44Decrypt(n,e)}function unwrapManyEvents(t,e){let n=[];return t.forEach(r=>{n.push(unwrapEvent(r,e))}),n.sort((r,s)=>r.created_at-s.created_at),n}function createEvent(t,e,n,r){const s={created_at:Math.ceil(Date.now()/1e3),kind:PrivateDirectMessage,tags:[],content:e};return(Array.isArray(t)?t:[t]).forEach(({publicKey:o,relayUrl:l})=>{s.tags.push(l?["p",o,l]:["p",o])}),r&&s.tags.push(["e",r.eventId,r.relayUrl||"","reply"]),n&&s.tags.push(["subject",n]),s}function wrapEvent2(t,e,n,r,s){const a=createEvent(e,n,r,s);return wrapEvent$1(a,t,e.publicKey)}function wrapManyEvents2(t,e,n,r,s){if(!e||e.length===0)throw new Error("At least one recipient is required.");return[{publicKey:getPublicKey(t)},...e].map(o=>wrapEvent2(t,o,n,r,s))}var unwrapEvent2=unwrapEvent,unwrapManyEvents2=unwrapManyEvents,nip18_exports={};__export(nip18_exports,{finishRepostEvent:()=>finishRepostEvent,getRepostedEvent:()=>getRepostedEvent,getRepostedEventPointer:()=>getRepostedEventPointer});function finishRepostEvent(t,e,n,r){let s;const a=[...t.tags??[],["e",e.id,n],["p",e.pubkey]];return e.kind===ShortTextNote?s=Repost:(s=GenericRepost,a.push(["k",String(e.kind)])),finalizeEvent({kind:s,tags:a,content:t.content===""||e.tags?.find(o=>o[0]==="-")?"":JSON.stringify(e),created_at:t.created_at},r)}function getRepostedEventPointer(t){if(![Repost,GenericRepost].includes(t.kind))return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const s=t.tags[r];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&n===void 0&&(n=s))}if(e!==void 0)return{id:e[1],relays:[e[2],n?.[2]].filter(r=>typeof r=="string"),author:n?.[1]}}function getRepostedEvent(t,{skipVerification:e}={}){const n=getRepostedEventPointer(t);if(n===void 0||t.content==="")return;let r;try{r=JSON.parse(t.content)}catch{return}if(r.id===n.id&&!(!e&&!verifyEvent(r)))return r}var nip21_exports={};__export(nip21_exports,{NOSTR_URI_REGEX:()=>NOSTR_URI_REGEX,parse:()=>parse2,test:()=>test});var NOSTR_URI_REGEX=new RegExp(`nostr:(${BECH32_REGEX$2.source})`);function test(t){return typeof t=="string"&&new RegExp(`^${NOSTR_URI_REGEX.source}$`).test(t)}function parse2(t){const e=t.match(new RegExp(`^${NOSTR_URI_REGEX.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${t}`);return{uri:e[0],value:e[1],decoded:decode$1(e[1])}}var nip25_exports={};__export(nip25_exports,{finishReactionEvent:()=>finishReactionEvent,getReactedEventPointer:()=>getReactedEventPointer});function finishReactionEvent(t,e,n){const r=e.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return finalizeEvent({...t,kind:Reaction,tags:[...t.tags??[],...r,["e",e.id],["p",e.pubkey]],content:t.content??"+"},n)}function getReactedEventPointer(t){if(t.kind!==Reaction)return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const s=t.tags[r];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&n===void 0&&(n=s))}if(!(e===void 0||n===void 0))return{id:e[1],relays:[e[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var nip27_exports={};__export(nip27_exports,{parse:()=>parse3});var noCharacter=/\W/m,noURLCharacter=/[^\w\/] |[^\w\/]$|$|,| /m,MAX_HASHTAG_LENGTH=42;function*parse3(t){let e=[];if(typeof t!="string"){for(let a=0;a<t.tags.length;a++){const o=t.tags[a];o[0]==="emoji"&&o.length>=3&&e.push({type:"emoji",shortcode:o[1],url:o[2]})}t=t.content}const n=t.length;let r=0,s=0;e:for(;s<n;){const a=t.indexOf(":",s),o=t.indexOf("#",s);if(a===-1&&o===-1)break e;if(a===-1||o>=0&&o<a){if(o===0||t[o-1]===" "){const l=t.slice(o+1,o+MAX_HASHTAG_LENGTH).match(noCharacter),h=l?o+1+l.index:n;yield{type:"text",text:t.slice(r,o)},yield{type:"hashtag",value:t.slice(o+1,h)},s=h,r=s;continue e}s=o+1;continue e}if(t.slice(a-5,a)==="nostr"){const l=t.slice(a+60).match(noCharacter),h=l?a+60+l.index:n;try{let y,{data:p,type:m}=decode$1(t.slice(a+1,h));switch(m){case"npub":y={pubkey:p};break;case"note":y={id:p};break;case"nsec":s=h+1;continue;default:y=p}r!==a-5&&(yield{type:"text",text:t.slice(r,a-5)}),yield{type:"reference",pointer:y},s=h,r=s;continue e}catch{s=a+1;continue e}}else if(t.slice(a-5,a)==="https"||t.slice(a-4,a)==="http"){const l=t.slice(a+4).match(noURLCharacter),h=l?a+4+l.index:n,y=t[a-1]==="s"?5:4;try{let p=new URL(t.slice(a-y,h));if(p.hostname.indexOf(".")===-1)throw new Error("invalid url");if(r!==a-y&&(yield{type:"text",text:t.slice(r,a-y)}),/\.(png|jpe?g|gif|webp|heic|svg)$/i.test(p.pathname)){yield{type:"image",url:p.toString()},s=h,r=s;continue e}if(/\.(mp4|avi|webm|mkv|mov)$/i.test(p.pathname)){yield{type:"video",url:p.toString()},s=h,r=s;continue e}if(/\.(mp3|aac|ogg|opus|wav|flac)$/i.test(p.pathname)){yield{type:"audio",url:p.toString()},s=h,r=s;continue e}yield{type:"url",url:p.toString()},s=h,r=s;continue e}catch{s=h+1;continue e}}else if(t.slice(a-3,a)==="wss"||t.slice(a-2,a)==="ws"){const l=t.slice(a+4).match(noURLCharacter),h=l?a+4+l.index:n,y=t[a-1]==="s"?3:2;try{let p=new URL(t.slice(a-y,h));if(p.hostname.indexOf(".")===-1)throw new Error("invalid ws url");r!==a-y&&(yield{type:"text",text:t.slice(r,a-y)}),yield{type:"relay",url:p.toString()},s=h,r=s;continue e}catch{s=h+1;continue e}}else{for(let l=0;l<e.length;l++){const h=e[l];if(t[a+h.shortcode.length+1]===":"&&t.slice(a+1,a+h.shortcode.length+1)===h.shortcode){r!==a&&(yield{type:"text",text:t.slice(r,a)}),yield h,s=a+h.shortcode.length+2,r=s;continue e}}s=a+1;continue e}}r!==n&&(yield{type:"text",text:t.slice(r)})}var nip28_exports={};__export(nip28_exports,{channelCreateEvent:()=>channelCreateEvent,channelHideMessageEvent:()=>channelHideMessageEvent,channelMessageEvent:()=>channelMessageEvent,channelMetadataEvent:()=>channelMetadataEvent,channelMuteUserEvent:()=>channelMuteUserEvent});var channelCreateEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelCreation,tags:[...t.tags??[]],content:n,created_at:t.created_at},e)},channelMetadataEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMetadata,tags:[["e",t.channel_create_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMessageEvent=(t,e)=>{const n=[["e",t.channel_create_event_id,t.relay_url,"root"]];return t.reply_to_channel_message_event_id&&n.push(["e",t.reply_to_channel_message_event_id,t.relay_url,"reply"]),finalizeEvent({kind:ChannelMessage,tags:[...n,...t.tags??[]],content:t.content,created_at:t.created_at},e)},channelHideMessageEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelHideMessage,tags:[["e",t.channel_message_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMuteUserEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMuteUser,tags:[["p",t.pubkey_to_mute],...t.tags??[]],content:n,created_at:t.created_at},e)},nip30_exports={};__export(nip30_exports,{EMOJI_SHORTCODE_REGEX:()=>EMOJI_SHORTCODE_REGEX,matchAll:()=>matchAll,regex:()=>regex,replaceAll:()=>replaceAll});var EMOJI_SHORTCODE_REGEX=/:(\w+):/,regex=()=>new RegExp(`\\B${EMOJI_SHORTCODE_REGEX.source}\\B`,"g");function*matchAll(t){const e=t.matchAll(regex());for(const n of e)try{const[r,s]=n;yield{shortcode:r,name:s,start:n.index,end:n.index+r.length}}catch{}}function replaceAll(t,e){return t.replaceAll(regex(),(n,r)=>e({shortcode:n,name:r}))}var nip39_exports={};__export(nip39_exports,{useFetchImplementation:()=>useFetchImplementation3,validateGithub:()=>validateGithub});var _fetch3;try{_fetch3=fetch}catch{}function useFetchImplementation3(t){_fetch3=t}async function validateGithub(t,e,n){try{return await(await _fetch3(`https://gist.github.com/${e}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${t}`}catch{return!1}}var nip47_exports={};__export(nip47_exports,{makeNwcRequestEvent:()=>makeNwcRequestEvent,parseConnectionString:()=>parseConnectionString});function parseConnectionString(t){const{host:e,pathname:n,searchParams:r}=new URL(t),s=n||e,a=r.get("relay"),o=r.get("secret");if(!s||!a||!o)throw new Error("invalid connection string");return{pubkey:s,relay:a,secret:o}}async function makeNwcRequestEvent(t,e,n){const s=encrypt$3(e,t,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),a={kind:NWCWalletRequest,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",t]]};return finalizeEvent(a,e)}var nip54_exports={};__export(nip54_exports,{normalizeIdentifier:()=>normalizeIdentifier});function normalizeIdentifier(t){return t=t.trim().toLowerCase(),t=t.normalize("NFKC"),Array.from(t).map(e=>/\p{Letter}/u.test(e)||/\p{Number}/u.test(e)?e:"-").join("")}var nip57_exports={};__export(nip57_exports,{getSatoshisAmountFromBolt11:()=>getSatoshisAmountFromBolt11,getZapEndpoint:()=>getZapEndpoint,makeZapReceipt:()=>makeZapReceipt,makeZapRequest:()=>makeZapRequest,useFetchImplementation:()=>useFetchImplementation4,validateZapRequest:()=>validateZapRequest});var _fetch4;try{_fetch4=fetch}catch{}function useFetchImplementation4(t){_fetch4=t}async function getZapEndpoint(t){try{let e="",{lud06:n,lud16:r}=JSON.parse(t.content);if(r){let[o,l]=r.split("@");e=new URL(`/.well-known/lnurlp/${o}`,`https://${l}`).toString()}else if(n){let{words:o}=bech32$1.decode(n,1e3),l=bech32$1.fromWords(o);e=utf8Decoder$1.decode(l)}else return null;let a=await(await _fetch4(e)).json();if(a.allowsNostr&&a.nostrPubkey)return a.callback}catch{}return null}function makeZapRequest(t){let e={kind:9734,created_at:Math.round(Date.now()/1e3),content:t.comment||"",tags:[["p","pubkey"in t?t.pubkey:t.event.pubkey],["amount",t.amount.toString()],["relays",...t.relays]]};if("event"in t){if(e.tags.push(["e",t.event.id]),isReplaceableKind(t.event.kind)){const n=["a",`${t.event.kind}:${t.event.pubkey}:`];e.tags.push(n)}else if(isAddressableKind(t.event.kind)){let n=t.event.tags.find(([s,a])=>s==="d"&&a);if(!n)throw new Error("d tag not found or is empty");const r=["a",`${t.event.kind}:${t.event.pubkey}:${n[1]}`];e.tags.push(r)}e.tags.push(["k",t.event.kind.toString()])}return e}function validateZapRequest(t){let e;try{e=JSON.parse(t)}catch{return"Invalid zap request JSON."}if(!validateEvent$1(e))return"Zap request is not a valid Nostr event.";if(!verifyEvent(e))return"Invalid signature on zap request.";let n=e.tags.find(([a,o])=>a==="p"&&o);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=e.tags.find(([a,o])=>a==="e"&&o);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([a,o])=>a==="relays"&&o)?null:"Zap request doesn't have a 'relays' tag."}function makeZapReceipt({zapRequest:t,preimage:e,bolt11:n,paidAt:r}){let s=JSON.parse(t),a=s.tags.filter(([l])=>l==="e"||l==="p"||l==="a"),o={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...a,["P",s.pubkey],["bolt11",n],["description",t]]};return e&&o.tags.push(["preimage",e]),o}function getSatoshisAmountFromBolt11(t){if(t.length<50)return 0;t=t.substring(0,50);const e=t.lastIndexOf("1");if(e===-1)return 0;const n=t.substring(0,e);if(!n.startsWith("lnbc"))return 0;const r=n.substring(4);if(r.length<1)return 0;const s=r[r.length-1],a=s.charCodeAt(0)-48,o=a>=0&&a<=9;let l=r.length-1;if(o&&l++,l<1)return 0;const h=parseInt(r.substring(0,l));switch(s){case"m":return h*1e5;case"u":return h*100;case"n":return h/10;case"p":return h/1e4;default:return h*1e8}}var nip77_exports={};__export(nip77_exports,{Negentropy:()=>Negentropy,NegentropyStorageVector:()=>NegentropyStorageVector,NegentropySync:()=>NegentropySync});var PROTOCOL_VERSION=97,ID_SIZE=32,FINGERPRINT_SIZE=16,Mode={Skip:0,Fingerprint:1,IdList:2},WrappedBuffer=class{_raw;length;constructor(t){typeof t=="number"?(this._raw=new Uint8Array(t),this.length=0):t instanceof Uint8Array?(this._raw=new Uint8Array(t),this.length=t.length):(this._raw=new Uint8Array(512),this.length=0)}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(t){if(t instanceof WrappedBuffer&&(t=t.unwrap()),typeof t.length!="number")throw Error("bad length");const e=t.length+this.length;if(this.capacity<e){const n=this._raw,r=Math.max(this.capacity*2,e);this._raw=new Uint8Array(r),this._raw.set(n)}this._raw.set(t,this.length),this.length+=t.length}shift(){const t=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,t}shiftN(t=1){const e=this._raw.subarray(0,t);return this._raw=this._raw.subarray(t),this.length-=t,e}};function decodeVarInt(t){let e=0;for(;;){if(t.length===0)throw Error("parse ends prematurely");let n=t.shift();if(e=e<<7|n&127,!(n&128))break}return e}function encodeVarInt(t){if(t===0)return new WrappedBuffer(new Uint8Array([0]));let e=[];for(;t!==0;)e.push(t&127),t>>>=7;e.reverse();for(let n=0;n<e.length-1;n++)e[n]|=128;return new WrappedBuffer(new Uint8Array(e))}function getByte(t){return getBytes(t,1)[0]}function getBytes(t,e){if(t.length<e)throw Error("parse ends prematurely");return t.shiftN(e)}var Accumulator=class{buf;constructor(){this.setToZero()}setToZero(){this.buf=new Uint8Array(ID_SIZE)}add(t){let e=0,n=0,r=new DataView(this.buf.buffer),s=new DataView(t.buffer);for(let a=0;a<8;a++){let o=a*4,l=r.getUint32(o,!0),h=s.getUint32(o,!0),y=l;y+=e,y+=h,y>4294967295&&(n=1),r.setUint32(o,y&4294967295,!0),e=n,n=0}}negate(){let t=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let r=n*4;t.setUint32(r,~t.getUint32(r,!0))}let e=new Uint8Array(ID_SIZE);e[0]=1,this.add(e)}getFingerprint(t){let e=new WrappedBuffer;return e.extend(this.buf),e.extend(encodeVarInt(t)),sha256_1(e.unwrap()).subarray(0,FINGERPRINT_SIZE)}},NegentropyStorageVector=class{items;sealed;constructor(){this.items=[],this.sealed=!1}insert(t,e){if(this.sealed)throw Error("already sealed");const n=hexToBytes(e);if(n.byteLength!==ID_SIZE)throw Error("bad id size for added item");this.items.push({timestamp:t,id:n})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(itemCompare);for(let t=1;t<this.items.length;t++)if(itemCompare(this.items[t-1],this.items[t])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(t){if(this._checkSealed(),t>=this.items.length)throw Error("out of range");return this.items[t]}iterate(t,e,n){this._checkSealed(),this._checkBounds(t,e);for(let r=t;r<e&&n(this.items[r],r);++r);}findLowerBound(t,e,n){return this._checkSealed(),this._checkBounds(t,e),this._binarySearch(this.items,t,e,r=>itemCompare(r,n)<0)}fingerprint(t,e){let n=new Accumulator;return n.setToZero(),this.iterate(t,e,r=>(n.add(r.id),!0)),n.getFingerprint(e-t)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(t,e){if(t>e||e>this.items.length)throw Error("bad range")}_binarySearch(t,e,n,r){let s=n-e;for(;s>0;){let a=e,o=Math.floor(s/2);a+=o,r(t[a])?(e=++a,s-=o+1):s=o}return e}},Negentropy=class{storage;frameSizeLimit;lastTimestampIn;lastTimestampOut;constructor(t,e=6e4){if(e<4096)throw Error("frameSizeLimit too small");this.storage=t,this.frameSizeLimit=e,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(t,e){return{timestamp:t,id:e||new Uint8Array(0)}}initiate(){let t=new WrappedBuffer;return t.extend(new Uint8Array([PROTOCOL_VERSION])),this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),t),bytesToHex(t.unwrap())}reconcile(t,e,n){const r=new WrappedBuffer(hexToBytes(t));this.lastTimestampIn=this.lastTimestampOut=0;let s=new WrappedBuffer;s.extend(new Uint8Array([PROTOCOL_VERSION]));let a=getByte(r);if(a<96||a>111)throw Error("invalid negentropy protocol version byte");if(a!==PROTOCOL_VERSION)throw Error("unsupported negentropy protocol version requested: "+(a-96));let o=this.storage.size(),l=this._bound(0),h=0,y=!1;for(;r.length!==0;){let p=new WrappedBuffer,m=()=>{y&&(y=!1,p.extend(this.encodeBound(l)),p.extend(encodeVarInt(Mode.Skip)))},v=this.decodeBound(r),_=decodeVarInt(r),S=h,T=this.storage.findLowerBound(h,o,v);if(_===Mode.Skip)y=!0;else if(_===Mode.Fingerprint){let k=getBytes(r,FINGERPRINT_SIZE),O=this.storage.fingerprint(S,T);compareUint8Array(k,O)!==0?(m(),this.splitRange(S,T,v,p)):y=!0}else if(_===Mode.IdList){let k=decodeVarInt(r),O={};for(let q=0;q<k;q++){let z=getBytes(r,ID_SIZE);O[bytesToHex(z)]=z}if(y=!0,this.storage.iterate(S,T,q=>{let z=q.id;const Q=bytesToHex(z);return O[Q]?delete O[bytesToHex(z)]:e?.(Q),!0}),n)for(let q of Object.values(O))n(bytesToHex(q))}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(s.length+p.length)){let k=this.storage.fingerprint(T,o);s.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),s.extend(encodeVarInt(Mode.Fingerprint)),s.extend(k);break}else s.extend(p);h=T,l=v}return s.length===1?null:bytesToHex(s.unwrap())}splitRange(t,e,n,r){let s=e-t,a=16;if(s<a*2)r.extend(this.encodeBound(n)),r.extend(encodeVarInt(Mode.IdList)),r.extend(encodeVarInt(s)),this.storage.iterate(t,e,o=>(r.extend(o.id),!0));else{let o=Math.floor(s/a),l=s%a,h=t;for(let y=0;y<a;y++){let p=o+(y<l?1:0),m=this.storage.fingerprint(h,h+p);h+=p;let v;if(h===e)v=n;else{let _,S;this.storage.iterate(h-1,h+1,(T,k)=>(k===h-1?_=T:S=T,!0)),v=this.getMinimalBound(_,S)}r.extend(this.encodeBound(v)),r.extend(encodeVarInt(Mode.Fingerprint)),r.extend(m)}}}exceededFrameSizeLimit(t){return t>this.frameSizeLimit-200}decodeTimestampIn(t){let e=decodeVarInt(t);return e=e===0?Number.MAX_VALUE:e-1,this.lastTimestampIn===Number.MAX_VALUE||e===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(e+=this.lastTimestampIn,this.lastTimestampIn=e,e)}decodeBound(t){let e=this.decodeTimestampIn(t),n=decodeVarInt(t);if(n>ID_SIZE)throw Error("bound key too long");let r=getBytes(t,n);return{timestamp:e,id:r}}encodeTimestampOut(t){if(t===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,encodeVarInt(0);let e=t;return t-=this.lastTimestampOut,this.lastTimestampOut=e,encodeVarInt(t+1)}encodeBound(t){let e=new WrappedBuffer;return e.extend(this.encodeTimestampOut(t.timestamp)),e.extend(encodeVarInt(t.id.length)),e.extend(t.id),e}getMinimalBound(t,e){if(e.timestamp!==t.timestamp)return this._bound(e.timestamp);{let n=0,r=e.id,s=t.id;for(let a=0;a<ID_SIZE&&r[a]===s[a];a++)n++;return this._bound(e.timestamp,e.id.subarray(0,n+1))}}};function compareUint8Array(t,e){for(let n=0;n<t.byteLength;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return t.byteLength>e.byteLength?1:t.byteLength<e.byteLength?-1:0}function itemCompare(t,e){return t.timestamp===e.timestamp?compareUint8Array(t.id,e.id):t.timestamp-e.timestamp}var NegentropySync=class{relay;storage;neg;filter;subscription;onhave;onneed;constructor(t,e,n,r={}){this.relay=t,this.storage=e,this.neg=new Negentropy(e),this.onhave=r.onhave,this.onneed=r.onneed,this.filter=n,this.subscription=this.relay.prepareSubscription([{}],{label:r.label||"negentropy"}),this.subscription.oncustom=s=>{switch(s[0]){case"NEG-MSG":{s.length<3&&console.warn(`got invalid NEG-MSG from ${this.relay.url}: ${s}`);try{const a=this.neg.reconcile(s[2],this.onhave,this.onneed);a?this.relay.send(`["NEG-MSG", "${this.subscription.id}", "${a}"]`):(this.close(),r.onclose?.())}catch(a){console.error("negentropy reconcile error:",a),r?.onclose?.(`reconcile error: ${a}`)}break}case"NEG-CLOSE":{const a=s[2];console.warn("negentropy error:",a),r.onclose?.(a);break}case"NEG-ERR":r.onclose?.()}}}async start(){const t=this.neg.initiate();this.relay.send(`["NEG-OPEN","${this.subscription.id}",${JSON.stringify(this.filter)},"${t}"]`)}close(){this.relay.send(`["NEG-CLOSE","${this.subscription.id}"]`),this.subscription.close()}},nip98_exports={};__export(nip98_exports,{getToken:()=>getToken$1,hashPayload:()=>hashPayload$1,unpackEventFromToken:()=>unpackEventFromToken,validateEvent:()=>validateEvent2,validateEventKind:()=>validateEventKind,validateEventMethodTag:()=>validateEventMethodTag,validateEventPayloadTag:()=>validateEventPayloadTag,validateEventTimestamp:()=>validateEventTimestamp,validateEventUrlTag:()=>validateEventUrlTag,validateToken:()=>validateToken});var _authorizationScheme$1="Nostr ";async function getToken$1(t,e,n,r=!1,s){const a={kind:HTTPAuth$1,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&a.tags.push(["payload",hashPayload$1(s)]);const o=await n(a);return(r?_authorizationScheme$1:"")+base64.encode(utf8Encoder$2.encode(JSON.stringify(o)))}async function validateToken(t,e,n){const r=await unpackEventFromToken(t).catch(a=>{throw a});return await validateEvent2(r,e,n).catch(a=>{throw a})}async function unpackEventFromToken(t){if(!t)throw new Error("Missing token");t=t.replace(_authorizationScheme$1,"");const e=utf8Decoder$1.decode(base64.decode(t));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function validateEventTimestamp(t){return t.created_at?Math.round(new Date().getTime()/1e3)-t.created_at<60:!1}function validateEventKind(t){return t.kind===HTTPAuth$1}function validateEventUrlTag(t,e){const n=t.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===e:!1}function validateEventMethodTag(t,e){const n=t.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===e.toLowerCase():!1}function hashPayload$1(t){const e=sha256_1(utf8Encoder$2.encode(JSON.stringify(t)));return utils$1.bytesToHex(e)}function validateEventPayloadTag(t,e){const n=t.tags.find(s=>s[0]==="payload");if(!n)return!1;const r=hashPayload$1(e);return n.length>0&&n[1]===r}async function validateEvent2(t,e,n,r){if(!verifyEvent(t))throw new Error("Invalid nostr event, signature invalid");if(!validateEventKind(t))throw new Error("Invalid nostr event, kind invalid");if(!validateEventTimestamp(t))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!validateEventUrlTag(t,e))throw new Error("Invalid nostr event, url tag invalid");if(!validateEventMethodTag(t,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!validateEventPayloadTag(t,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(e,n,r){const{entryExpirationTimeInMS:s=null,next:a=null,prev:o=null,onEntryEvicted:l,onEntryMarkedAsMostRecentlyUsed:h,clone:y,cloneFn:p}=r??{};if(typeof s=="number"&&(s<=0||Number.isNaN(s)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=y??!1,this.cloneFn=p??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(n):n,this.created=Date.now(),this.entryExpirationTimeInMS=s,this.next=a,this.prev=o,this.onEntryEvicted=l,this.onEntryMarkedAsMostRecentlyUsed=h}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:n,isExpired:r}=this;this.onEntryEvicted({key:e,value:n,isExpired:r})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:n}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:n})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(e){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:n=25,entryExpirationTimeInMS:r=null,onEntryEvicted:s,onEntryMarkedAsMostRecentlyUsed:a,cloneFn:o,clone:l}=e??{};if(Number.isNaN(n)||n<=0)throw new Error("maxSize must be greater than 0.");if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=n,this.entryExpirationTimeInMS=r,this.onEntryEvicted=s,this.onEntryMarkedAsMostRecentlyUsed=a,this.clone=l,this.cloneFn=o}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(e){if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=e,this.enforceSizeLimit()}set(e,n,r){const s=this.lookupTable.get(e);s&&this.removeNodeFromListAndLookupTable(s);const a=new LRUCacheNode_1.LRUCacheNode(e,n,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...r});return this.setNodeAsHead(a),this.lookupTable.set(e,a),this.enforceSizeLimit(),this}get(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):(this.setNodeAsHead(n),n.value):null}peek(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):n.value:null}delete(e){const n=this.lookupTable.get(e);return n?this.removeNodeFromListAndLookupTable(n):!1}has(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(e){let n=this.head;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}const r=this.mapNodeToEntry(n);if(e(r))return this.setNodeAsHead(n),r;n=n.next}return null}forEach(e){let n=this.head,r=0;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}e(n.value,n.key,r),n=n.next,r++}}*values(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.value,e=e.next}}*keys(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.key,e=e.next}}*entries(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}*[Symbol.iterator](){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}enforceSizeLimit(){let e=this.tail;for(;e!==null&&this.size>this.maxSizeInternal;){const n=e.prev;this.removeNodeFromListAndLookupTable(e),e=n}}mapNodeToEntry({key:e,value:n}){return{key:e,value:n}}setNodeAsHead(e){this.removeNodeFromList(e),this.head?(e.next=this.head,this.head.prev=e,this.head=e):(this.head=e,this.tail=e),e.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(e){e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.head===e&&(this.head=e.next),this.tail===e&&(this.tail=e.prev),e.next=null,e.prev=null}removeNodeFromListAndLookupTable(e){return e.invokeOnEvicted(),this.removeNodeFromList(e),this.lookupTable.delete(e.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const e=[];for(const n of this.lookupTable.values())n.isExpired&&e.push(n);e.forEach(n=>this.removeNodeFromListAndLookupTable(n))}}LRUCache$1.LRUCache=LRUCache;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,a,o){o===void 0&&(o=a);var l=Object.getOwnPropertyDescriptor(s,a);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[a]}}),Object.defineProperty(r,o,l)}:function(r,s,a,o){o===void 0&&(o=a),r[o]=s[a]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var a in r)a!=="default"&&!Object.prototype.hasOwnProperty.call(s,a)&&e(s,r,a)};Object.defineProperty(t,"__esModule",{value:!0}),n(LRUCache$1,t)})(dist);var scrypt$1={},pbkdf2$1={};Object.defineProperty(pbkdf2$1,"__esModule",{value:!0});pbkdf2$1.pbkdf2=pbkdf2;var pbkdf2Async_1=pbkdf2$1.pbkdf2Async=pbkdf2Async;const hmac_ts_1=hmac,utils_ts_1$1=utils$1;function pbkdf2Init(t,e,n,r){(0,utils_ts_1$1.ahash)(t);const s=(0,utils_ts_1$1.checkOpts)({dkLen:32,asyncTick:10},r),{c:a,dkLen:o,asyncTick:l}=s;if((0,utils_ts_1$1.anumber)(a),(0,utils_ts_1$1.anumber)(o),(0,utils_ts_1$1.anumber)(l),a<1)throw new Error("iterations (c) should be >= 1");const h=(0,utils_ts_1$1.kdfInputToBytes)(e),y=(0,utils_ts_1$1.kdfInputToBytes)(n),p=new Uint8Array(o),m=hmac_ts_1.hmac.create(t,h),v=m._cloneInto().update(y);return{c:a,dkLen:o,asyncTick:l,DK:p,PRF:m,PRFSalt:v}}function pbkdf2Output(t,e,n,r,s){return t.destroy(),e.destroy(),r&&r.destroy(),(0,utils_ts_1$1.clean)(s),n}function pbkdf2(t,e,n,r){const{c:s,dkLen:a,DK:o,PRF:l,PRFSalt:h}=pbkdf2Init(t,e,n,r);let y;const p=new Uint8Array(4),m=(0,utils_ts_1$1.createView)(p),v=new Uint8Array(l.outputLen);for(let _=1,S=0;S<a;_++,S+=l.outputLen){const T=o.subarray(S,S+l.outputLen);m.setInt32(0,_,!1),(y=h._cloneInto(y)).update(p).digestInto(v),T.set(v.subarray(0,T.length));for(let k=1;k<s;k++){l._cloneInto(y).update(v).digestInto(v);for(let O=0;O<T.length;O++)T[O]^=v[O]}}return pbkdf2Output(l,h,o,y,v)}async function pbkdf2Async(t,e,n,r){const{c:s,dkLen:a,asyncTick:o,DK:l,PRF:h,PRFSalt:y}=pbkdf2Init(t,e,n,r);let p;const m=new Uint8Array(4),v=(0,utils_ts_1$1.createView)(m),_=new Uint8Array(h.outputLen);for(let S=1,T=0;T<a;S++,T+=h.outputLen){const k=l.subarray(T,T+h.outputLen);v.setInt32(0,S,!1),(p=y._cloneInto(p)).update(m).digestInto(_),k.set(_.subarray(0,k.length)),await(0,utils_ts_1$1.asyncLoop)(s-1,o,()=>{h._cloneInto(p).update(_).digestInto(_);for(let O=0;O<k.length;O++)k[O]^=_[O]})}return pbkdf2Output(h,y,l,p,_)}Object.defineProperty(scrypt$1,"__esModule",{value:!0});var scrypt_2=scrypt$1.scrypt=scrypt;scrypt$1.scryptAsync=scryptAsync;const pbkdf2_ts_1=pbkdf2$1,sha2_ts_1=sha2,utils_ts_1=utils$1;function XorAndSalsa(t,e,n,r,s,a){let o=t[e++]^n[r++],l=t[e++]^n[r++],h=t[e++]^n[r++],y=t[e++]^n[r++],p=t[e++]^n[r++],m=t[e++]^n[r++],v=t[e++]^n[r++],_=t[e++]^n[r++],S=t[e++]^n[r++],T=t[e++]^n[r++],k=t[e++]^n[r++],O=t[e++]^n[r++],q=t[e++]^n[r++],z=t[e++]^n[r++],Q=t[e++]^n[r++],ye=t[e++]^n[r++],ie=o,te=l,ae=h,ne=y,me=p,B=m,F=v,j=_,H=S,V=T,W=k,Z=O,oe=q,A=z,J=Q,X=ye;for(let de=0;de<8;de+=2)me^=(0,utils_ts_1.rotl)(ie+oe|0,7),H^=(0,utils_ts_1.rotl)(me+ie|0,9),oe^=(0,utils_ts_1.rotl)(H+me|0,13),ie^=(0,utils_ts_1.rotl)(oe+H|0,18),V^=(0,utils_ts_1.rotl)(B+te|0,7),A^=(0,utils_ts_1.rotl)(V+B|0,9),te^=(0,utils_ts_1.rotl)(A+V|0,13),B^=(0,utils_ts_1.rotl)(te+A|0,18),J^=(0,utils_ts_1.rotl)(W+F|0,7),ae^=(0,utils_ts_1.rotl)(J+W|0,9),F^=(0,utils_ts_1.rotl)(ae+J|0,13),W^=(0,utils_ts_1.rotl)(F+ae|0,18),ne^=(0,utils_ts_1.rotl)(X+Z|0,7),j^=(0,utils_ts_1.rotl)(ne+X|0,9),Z^=(0,utils_ts_1.rotl)(j+ne|0,13),X^=(0,utils_ts_1.rotl)(Z+j|0,18),te^=(0,utils_ts_1.rotl)(ie+ne|0,7),ae^=(0,utils_ts_1.rotl)(te+ie|0,9),ne^=(0,utils_ts_1.rotl)(ae+te|0,13),ie^=(0,utils_ts_1.rotl)(ne+ae|0,18),F^=(0,utils_ts_1.rotl)(B+me|0,7),j^=(0,utils_ts_1.rotl)(F+B|0,9),me^=(0,utils_ts_1.rotl)(j+F|0,13),B^=(0,utils_ts_1.rotl)(me+j|0,18),Z^=(0,utils_ts_1.rotl)(W+V|0,7),H^=(0,utils_ts_1.rotl)(Z+W|0,9),V^=(0,utils_ts_1.rotl)(H+Z|0,13),W^=(0,utils_ts_1.rotl)(V+H|0,18),oe^=(0,utils_ts_1.rotl)(X+J|0,7),A^=(0,utils_ts_1.rotl)(oe+X|0,9),J^=(0,utils_ts_1.rotl)(A+oe|0,13),X^=(0,utils_ts_1.rotl)(J+A|0,18);s[a++]=o+ie|0,s[a++]=l+te|0,s[a++]=h+ae|0,s[a++]=y+ne|0,s[a++]=p+me|0,s[a++]=m+B|0,s[a++]=v+F|0,s[a++]=_+j|0,s[a++]=S+H|0,s[a++]=T+V|0,s[a++]=k+W|0,s[a++]=O+Z|0,s[a++]=q+oe|0,s[a++]=z+A|0,s[a++]=Q+J|0,s[a++]=ye+X|0}function BlockMix(t,e,n,r,s){let a=r+0,o=r+16*s;for(let l=0;l<16;l++)n[o+l]=t[e+(2*s-1)*16+l];for(let l=0;l<s;l++,a+=16,e+=16)XorAndSalsa(n,o,t,e,n,a),l>0&&(o+=16),XorAndSalsa(n,a,t,e+=16,n,o)}function scryptInit(t,e,n){const r=(0,utils_ts_1.checkOpts)({dkLen:32,asyncTick:10,maxmem:1073742848},n),{N:s,r:a,p:o,dkLen:l,asyncTick:h,maxmem:y,onProgress:p}=r;if((0,utils_ts_1.anumber)(s),(0,utils_ts_1.anumber)(a),(0,utils_ts_1.anumber)(o),(0,utils_ts_1.anumber)(l),(0,utils_ts_1.anumber)(h),(0,utils_ts_1.anumber)(y),p!==void 0&&typeof p!="function")throw new Error("progressCb should be function");const m=128*a,v=m/4,_=Math.pow(2,32);if(s<=1||s&s-1||s>_)throw new Error("Scrypt: N must be larger than 1, a power of 2, and less than 2^32");if(o<0||o>(_-1)*32/m)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(l<0||l>(_-1)*32)throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");if(m*(s+o)>y)throw new Error("Scrypt: memused is bigger than maxMem. Expected 128 * r * (N + p) > maxmem of "+y);const T=(0,pbkdf2_ts_1.pbkdf2)(sha2_ts_1.sha256,t,e,{c:1,dkLen:m*o}),k=(0,utils_ts_1.u32)(T),O=(0,utils_ts_1.u32)(new Uint8Array(m*s)),q=(0,utils_ts_1.u32)(new Uint8Array(m));let z=()=>{};if(p){const Q=2*s*o,ye=Math.max(Math.floor(Q/1e4),1);let ie=0;z=()=>{ie++,p&&(!(ie%ye)||ie===Q)&&p(ie/Q)}}return{N:s,r:a,p:o,dkLen:l,blockSize32:v,V:O,B32:k,B:T,tmp:q,blockMixCb:z,asyncTick:h}}function scryptOutput(t,e,n,r,s){const a=(0,pbkdf2_ts_1.pbkdf2)(sha2_ts_1.sha256,t,n,{c:1,dkLen:e});return(0,utils_ts_1.clean)(n,r,s),a}function scrypt(t,e,n){const{N:r,r:s,p:a,dkLen:o,blockSize32:l,V:h,B32:y,B:p,tmp:m,blockMixCb:v}=scryptInit(t,e,n);(0,utils_ts_1.swap32IfBE)(y);for(let _=0;_<a;_++){const S=l*_;for(let T=0;T<l;T++)h[T]=y[S+T];for(let T=0,k=0;T<r-1;T++)BlockMix(h,k,h,k+=l,s),v();BlockMix(h,(r-1)*l,y,S,s),v();for(let T=0;T<r;T++){const k=y[S+l-16]%r;for(let O=0;O<l;O++)m[O]=y[S+O]^h[k*l+O];BlockMix(m,0,y,S,s),v()}}return(0,utils_ts_1.swap32IfBE)(y),scryptOutput(t,o,p,h,m)}async function scryptAsync(t,e,n){const{N:r,r:s,p:a,dkLen:o,blockSize32:l,V:h,B32:y,B:p,tmp:m,blockMixCb:v,asyncTick:_}=scryptInit(t,e,n);(0,utils_ts_1.swap32IfBE)(y);for(let S=0;S<a;S++){const T=l*S;for(let O=0;O<l;O++)h[O]=y[T+O];let k=0;await(0,utils_ts_1.asyncLoop)(r-1,_,()=>{BlockMix(h,k,h,k+=l,s),v()}),BlockMix(h,(r-1)*l,y,T,s),v(),await(0,utils_ts_1.asyncLoop)(r,_,()=>{const O=y[T+l-16]%r;for(let q=0;q<l;q++)m[q]=y[T+q]^h[O*l+q];BlockMix(m,0,y,T,s),v()})}return(0,utils_ts_1.swap32IfBE)(y),scryptOutput(t,o,p,h,m)}var Bech32MaxSize$1=5e3;function encodeBech32$1(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize$1)}function encodeBytes$1(t,e){return encodeBech32$1(t,e)}function encrypt$2(t,e,n=16,r=2){let s=utils$1.randomBytes(16),a=2**n,o=scrypt_2(e.normalize("NFKC"),s,{N:a,r:8,p:1,dkLen:32}),l=utils$1.randomBytes(24),h=Uint8Array.from([r]),p=xchacha20poly1305(o,l,h).encrypt(t),m=utils$1.concatBytes(Uint8Array.from([2]),Uint8Array.from([n]),s,l,h,p);return encodeBytes$1("ncryptsec",m)}function decrypt$2(t,e){let{prefix:n,words:r}=bech32$1.decode(t,Bech32MaxSize$1);if(n!=="ncryptsec")throw new Error(`invalid prefix ${n}, expected 'ncryptsec'`);let s=new Uint8Array(bech32$1.fromWords(r)),a=s[0];if(a!==2)throw new Error(`invalid version ${a}, expected 0x02`);let l=2**s[1],h=s.slice(2,18),y=s.slice(18,42),p=s[42],m=Uint8Array.from([p]),v=s.slice(43),_=scrypt_2(e.normalize("NFKC"),h,{N:l,r:8,p:1,dkLen:32});return xchacha20poly1305(_,y,m).decrypt(v)}const nip49_star=Object.freeze(Object.defineProperty({__proto__:null,decrypt:decrypt$2,encrypt:encrypt$2},Symbol.toStringTag,{value:"Module"}));var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder$1=new TextEncoder,NostrTypeGuard={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode(t)}catch{return{type:"invalid",data:null}}}function decode(t){let{prefix:e,words:n}=bech32$1.decode(t,Bech32MaxSize),r=new Uint8Array(bech32$1.fromWords(n));switch(e){case"nprofile":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:utils$1.bytesToHex(s[0][0]),relays:s[1]?s[1].map(a=>utf8Decoder.decode(a)):[]}}}case"nevent":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:utils$1.bytesToHex(s[0][0]),relays:s[1]?s[1].map(a=>utf8Decoder.decode(a)):[],author:s[2]?.[0]?utils$1.bytesToHex(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(utils$1.bytesToHex(s[3][0]),16):void 0}}}case"naddr":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(s[0][0]),pubkey:utils$1.bytesToHex(s[2][0]),kind:parseInt(utils$1.bytesToHex(s[3][0]),16),relays:s[1]?s[1].map(a=>utf8Decoder.decode(a)):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:utils$1.bytesToHex(r)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV(t){let e={},n=t;for(;n.length>0;){let r=n[0],s=n[1],a=n.slice(2,2+s);if(n=n.slice(2+s),a.length<s)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(a)}return e}function nsecEncode(t){return encodeBytes("nsec",t)}function npubEncode(t){return encodeBytes("npub",utils$1.hexToBytes(t))}function noteEncode(t){return encodeBytes("note",utils$1.hexToBytes(t))}function encodeBech32(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize)}function encodeBytes(t,e){return encodeBech32(t,e)}function nprofileEncode(t){let e=encodeTLV({0:[utils$1.hexToBytes(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder$1.encode(n))});return encodeBech32("nprofile",e)}function neventEncode(t){let e;t.kind!==void 0&&(e=integerToUint8Array(t.kind));let n=encodeTLV({0:[utils$1.hexToBytes(t.id)],1:(t.relays||[]).map(r=>utf8Encoder$1.encode(r)),2:t.author?[utils$1.hexToBytes(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32("nevent",n)}function naddrEncode(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV({0:[utf8Encoder$1.encode(t.identifier)],1:(t.relays||[]).map(r=>utf8Encoder$1.encode(r)),2:[utils$1.hexToBytes(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32("naddr",n)}function encodeTLV(t){let e=[];return Object.entries(t).reverse().forEach(([n,r])=>{r.forEach(s=>{let a=new Uint8Array(s.length+2);a.set([parseInt(n)],0),a.set([s.length],1),a.set(s,2),e.push(a)})}),utils$1.concatBytes(...e)}const nip19_star=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX:BECH32_REGEX$1,Bech32MaxSize,NostrTypeGuard,decode,decodeNostrURI,encodeBytes,naddrEncode,neventEncode,noteEncode,nprofileEncode,npubEncode,nsecEncode},Symbol.toStringTag,{value:"Module"}));var lib={};(function(t){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(t,"__esModule",{value:!0}),t.bytes=t.stringToBytes=t.str=t.bytesToString=t.hex=t.utf8=t.bech32m=t.bech32=t.base58check=t.base58xmr=t.base58xrp=t.base58flickr=t.base58=t.base64url=t.base64=t.base32crockford=t.base32hex=t.base32=t.base16=t.utils=t.assertNumber=void 0;function e(B){if(!Number.isSafeInteger(B))throw new Error(`Wrong integer: ${B}`)}t.assertNumber=e;function n(...B){const F=(V,W)=>Z=>V(W(Z)),j=Array.from(B).reverse().reduce((V,W)=>V?F(V,W.encode):W.encode,void 0),H=B.reduce((V,W)=>V?F(V,W.decode):W.decode,void 0);return{encode:j,decode:H}}function r(B){return{encode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return F.map(j=>{if(e(j),j<0||j>=B.length)throw new Error(`Digit index outside alphabet: ${j} (alphabet: ${B.length})`);return B[j]})},decode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="string")throw new Error("alphabet.decode input should be array of strings");return F.map(j=>{if(typeof j!="string")throw new Error(`alphabet.decode: not string element=${j}`);const H=B.indexOf(j);if(H===-1)throw new Error(`Unknown letter: "${j}". Allowed: ${B}`);return H})}}}function s(B=""){if(typeof B!="string")throw new Error("join separator should be string");return{encode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="string")throw new Error("join.encode input should be array of strings");for(let j of F)if(typeof j!="string")throw new Error(`join.encode: non-string input=${j}`);return F.join(B)},decode:F=>{if(typeof F!="string")throw new Error("join.decode input should be string");return F.split(B)}}}function a(B,F="="){if(e(B),typeof F!="string")throw new Error("padding chr should be string");return{encode(j){if(!Array.isArray(j)||j.length&&typeof j[0]!="string")throw new Error("padding.encode input should be array of strings");for(let H of j)if(typeof H!="string")throw new Error(`padding.encode: non-string input=${H}`);for(;j.length*B%8;)j.push(F);return j},decode(j){if(!Array.isArray(j)||j.length&&typeof j[0]!="string")throw new Error("padding.encode input should be array of strings");for(let V of j)if(typeof V!="string")throw new Error(`padding.decode: non-string input=${V}`);let H=j.length;if(H*B%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;H>0&&j[H-1]===F;H--)if(!((H-1)*B%8))throw new Error("Invalid padding: string has too much padding");return j.slice(0,H)}}}function o(B){if(typeof B!="function")throw new Error("normalize fn should be function");return{encode:F=>F,decode:F=>B(F)}}function l(B,F,j){if(F<2)throw new Error(`convertRadix: wrong from=${F}, base cannot be less than 2`);if(j<2)throw new Error(`convertRadix: wrong to=${j}, base cannot be less than 2`);if(!Array.isArray(B))throw new Error("convertRadix: data should be array");if(!B.length)return[];let H=0;const V=[],W=Array.from(B);for(W.forEach(Z=>{if(e(Z),Z<0||Z>=F)throw new Error(`Wrong integer: ${Z}`)});;){let Z=0,oe=!0;for(let A=H;A<W.length;A++){const J=W[A],X=F*Z+J;if(!Number.isSafeInteger(X)||F*Z/F!==Z||X-J!==F*Z)throw new Error("convertRadix: carry overflow");if(Z=X%j,W[A]=Math.floor(X/j),!Number.isSafeInteger(W[A])||W[A]*j+Z!==X)throw new Error("convertRadix: carry overflow");if(oe)W[A]?oe=!1:H=A;else continue}if(V.push(Z),oe)break}for(let Z=0;Z<B.length-1&&B[Z]===0;Z++)V.push(0);return V.reverse()}const h=(B,F)=>F?h(F,B%F):B,y=(B,F)=>B+(F-h(B,F));function p(B,F,j,H){if(!Array.isArray(B))throw new Error("convertRadix2: data should be array");if(F<=0||F>32)throw new Error(`convertRadix2: wrong from=${F}`);if(j<=0||j>32)throw new Error(`convertRadix2: wrong to=${j}`);if(y(F,j)>32)throw new Error(`convertRadix2: carry overflow from=${F} to=${j} carryBits=${y(F,j)}`);let V=0,W=0;const Z=2**j-1,oe=[];for(const A of B){if(e(A),A>=2**F)throw new Error(`convertRadix2: invalid data word=${A} from=${F}`);if(V=V<<F|A,W+F>32)throw new Error(`convertRadix2: carry overflow pos=${W} from=${F}`);for(W+=F;W>=j;W-=j)oe.push((V>>W-j&Z)>>>0);V&=2**W-1}if(V=V<<j-W&Z,!H&&W>=F)throw new Error("Excess padding");if(!H&&V)throw new Error(`Non-zero padding: ${V}`);return H&&W>0&&oe.push(V>>>0),oe}function m(B){return e(B),{encode:F=>{if(!(F instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return l(Array.from(F),2**8,B)},decode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(l(F,B,2**8))}}}function v(B,F=!1){if(e(B),B<=0||B>32)throw new Error("radix2: bits should be in (0..32]");if(y(8,B)>32||y(B,8)>32)throw new Error("radix2: carry overflow");return{encode:j=>{if(!(j instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return p(Array.from(j),8,B,!F)},decode:j=>{if(!Array.isArray(j)||j.length&&typeof j[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(p(j,B,8,F))}}}function _(B){if(typeof B!="function")throw new Error("unsafeWrapper fn should be function");return function(...F){try{return B.apply(null,F)}catch{}}}function S(B,F){if(e(B),typeof F!="function")throw new Error("checksum fn should be function");return{encode(j){if(!(j instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const H=F(j).slice(0,B),V=new Uint8Array(j.length+B);return V.set(j),V.set(H,j.length),V},decode(j){if(!(j instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const H=j.slice(0,-B),V=F(H).slice(0,B),W=j.slice(-B);for(let Z=0;Z<B;Z++)if(V[Z]!==W[Z])throw new Error("Invalid checksum");return H}}}t.utils={alphabet:r,chain:n,checksum:S,radix:m,radix2:v,join:s,padding:a},t.base16=n(v(4),r("0123456789ABCDEF"),s("")),t.base32=n(v(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),a(5),s("")),t.base32hex=n(v(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),a(5),s("")),t.base32crockford=n(v(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),o(B=>B.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),t.base64=n(v(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),a(6),s("")),t.base64url=n(v(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),a(6),s(""));const T=B=>n(m(58),r(B),s(""));t.base58=T("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.base58flickr=T("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),t.base58xrp=T("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const k=[0,2,3,5,6,7,9,10,11];t.base58xmr={encode(B){let F="";for(let j=0;j<B.length;j+=8){const H=B.subarray(j,j+8);F+=t.base58.encode(H).padStart(k[H.length],"1")}return F},decode(B){let F=[];for(let j=0;j<B.length;j+=11){const H=B.slice(j,j+11),V=k.indexOf(H.length),W=t.base58.decode(H);for(let Z=0;Z<W.length-V;Z++)if(W[Z]!==0)throw new Error("base58xmr: wrong padding");F=F.concat(Array.from(W.slice(W.length-V)))}return Uint8Array.from(F)}};const O=B=>n(S(4,F=>B(B(F))),t.base58);t.base58check=O;const q=n(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),z=[996825010,642813549,513874426,1027748829,705979059];function Q(B){const F=B>>25;let j=(B&33554431)<<5;for(let H=0;H<z.length;H++)(F>>H&1)===1&&(j^=z[H]);return j}function ye(B,F,j=1){const H=B.length;let V=1;for(let W=0;W<H;W++){const Z=B.charCodeAt(W);if(Z<33||Z>126)throw new Error(`Invalid prefix (${B})`);V=Q(V)^Z>>5}V=Q(V);for(let W=0;W<H;W++)V=Q(V)^B.charCodeAt(W)&31;for(let W of F)V=Q(V)^W;for(let W=0;W<6;W++)V=Q(V);return V^=j,q.encode(p([V%2**30],30,5,!1))}function ie(B){const F=B==="bech32"?1:734539939,j=v(5),H=j.decode,V=j.encode,W=_(H);function Z(X,de,ve=90){if(typeof X!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof X}`);if(!Array.isArray(de)||de.length&&typeof de[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof de}`);const we=X.length+7+de.length;if(ve!==!1&&we>ve)throw new TypeError(`Length ${we} exceeds limit ${ve}`);return X=X.toLowerCase(),`${X}1${q.encode(de)}${ye(X,de,F)}`}function oe(X,de=90){if(typeof X!="string")throw new Error(`bech32.decode input should be string, not ${typeof X}`);if(X.length<8||de!==!1&&X.length>de)throw new TypeError(`Wrong string length: ${X.length} (${X}). Expected (8..${de})`);const ve=X.toLowerCase();if(X!==ve&&X!==X.toUpperCase())throw new Error("String must be lowercase or uppercase");X=ve;const we=X.lastIndexOf("1");if(we===0||we===-1)throw new Error('Letter "1" must be present between prefix and data only');const $e=X.slice(0,we),Re=X.slice(we+1);if(Re.length<6)throw new Error("Data must be at least 6 characters long");const De=q.decode(Re).slice(0,-6),Ke=ye($e,De,F);if(!Re.endsWith(Ke))throw new Error(`Invalid checksum in ${X}: expected "${Ke}"`);return{prefix:$e,words:De}}const A=_(oe);function J(X){const{prefix:de,words:ve}=oe(X,!1);return{prefix:de,words:ve,bytes:H(ve)}}return{encode:Z,decode:oe,decodeToBytes:J,decodeUnsafe:A,fromWords:H,fromWordsUnsafe:W,toWords:V}}t.bech32=ie("bech32"),t.bech32m=ie("bech32m"),t.utf8={encode:B=>new TextDecoder().decode(B),decode:B=>new TextEncoder().encode(B)},t.hex=n(v(4),r("0123456789abcdef"),s(""),o(B=>{if(typeof B!="string"||B.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof B} with length ${B.length}`);return B.toLowerCase()}));const te={utf8:t.utf8,hex:t.hex,base16:t.base16,base32:t.base32,base64:t.base64,base64url:t.base64url,base58:t.base58,base58xmr:t.base58xmr},ae=`Invalid encoding type. Available types: ${Object.keys(te).join(", ")}`,ne=(B,F)=>{if(typeof B!="string"||!te.hasOwnProperty(B))throw new TypeError(ae);if(!(F instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return te[B].encode(F)};t.bytesToString=ne,t.str=t.bytesToString;const me=(B,F)=>{if(!te.hasOwnProperty(B))throw new TypeError(ae);if(typeof F!="string")throw new TypeError("stringToBytes() expects string");return te[B].decode(F)};t.stringToBytes=me,t.bytes=t.stringToBytes})(lib);const{bech32,hex,utf8}=lib;BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let t=0,e=Object.keys(TAGCODES);t<e.length;t++)e[t],TAGCODES[e[t]].toString();var __defProp$1=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__getOwnPropNames$1=Object.getOwnPropertyNames,__hasOwnProp$1=Object.prototype.hasOwnProperty,__copyProps$1=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of __getOwnPropNames$1(e))!__hasOwnProp$1.call(t,s)&&s!==n&&__defProp$1(t,s,{get:()=>e[s],enumerable:!(r=__getOwnPropDesc$1(e,s))||r.enumerable});return t},__reExport$1=(t,e,n)=>(__copyProps$1(t,e,"default"),n);function getRelaysForSync$1(t,e,n="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);if(r)return n==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor$1(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync$1(t,e,n)}function getTopRelaysForAuthors$1(t,e){const n=new Map;return e.forEach(s=>{const a=getRelaysForSync$1(t,s);a&&a.forEach(o=>{const l=n.get(o)||0;n.set(o,l+1)})}),Array.from(n.entries()).sort((s,a)=>a[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys$1(t,e,n="read"){const r=new Map,s=new Set;return e.forEach(a=>{const o=getRelaysForSync$1(t,a,n);o&&o.size>0?(o.forEach(l=>{(r.get(l)||new Set).add(a)}),r.set(a,o)):s.add(a)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys$1(t,e,n,{count:r,preferredRelays:s}={}){r??=2,s??=new Set;const a=t.pool,o=a.connectedRelays();o.forEach(v=>{s?.add(v.url)});const l=new Map,{pubkeysToRelays:h,authorsMissingRelays:y}=getAllRelaysForAllPubkeys$1(t,e,n),p=getTopRelaysForAuthors$1(t,e),m=(v,_)=>{const S=l.get(_)||[];S.push(v),l.set(_,S)};for(const[v,_]of h.entries()){let S=r;const T=new Set;for(const k of o)_.has(k.url)&&(m(v,k.url),T.add(k.url),S--);for(const k of _)T.has(k)||l.has(k)&&(m(v,k),T.add(k),S--);if(!(S<=0))for(const k of p){if(S<=0)break;T.has(k)||_.has(k)&&(m(v,k),T.add(k),S--)}}for(const v of y)a.permanentAndConnectedRelays().forEach(_=>{const S=l.get(_.url)||[];S.push(v),l.set(_.url,S)});return l}function getRelaysForFilterWithAuthors(t,e,n=2){return chooseRelayCombinationForPubkeys$1(t,e,"write",{count:n})}function tryNormalizeRelayUrl(t){try{return normalizeRelayUrl$1(t)}catch{return}}function normalizeRelayUrl$1(t){let e=normalizeUrl$1(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function normalize(t){const e=new Set;for(const n of t)try{e.add(normalizeRelayUrl$1(n))}catch{}return Array.from(e)}var DATA_URL_DEFAULT_MIME_TYPE$1="text/plain",DATA_URL_DEFAULT_CHARSET$1="us-ascii",testParameter$1=(t,e)=>e.some(n=>n instanceof RegExp?n.test(t):n===t),supportedProtocols$1=new Set(["https:","http:","file:"]),hasCustomProtocol$1=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols$1.has(e)}catch{return!1}},normalizeDataURL$1=(t,{stripHash:e})=>{const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);const r=n.groups?.type??"",s=n.groups?.data??"";let a=n.groups?.hash??"";const o=r.split(";");a=e?"":a;let l=!1;o[o.length-1]==="base64"&&(o.pop(),l=!0);const h=o.shift()?.toLowerCase()??"",p=[...o.map(m=>{let[v,_=""]=m.split("=").map(S=>S.trim());return v==="charset"&&(_=_.toLowerCase(),_===DATA_URL_DEFAULT_CHARSET$1)?"":`${v}${_?`=${_}`:""}`}).filter(Boolean)];return l&&p.push("base64"),(p.length>0||h&&h!==DATA_URL_DEFAULT_MIME_TYPE$1)&&p.unshift(h),`data:${p.join(";")},${l?s.trim():s}${a?`#${a}`:""}`};function normalizeUrl$1(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL$1(t,e);if(hasCustomProtocol$1(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(t);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const o=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let l=0,h="";for(;;){const p=o.exec(s.pathname);if(!p)break;const m=p[0],v=p.index,_=s.pathname.slice(l,v);h+=_.replace(/\/{2,}/g,"/"),h+=m,l=v+m.length}const y=s.pathname.slice(l,s.pathname.length);h+=y.replace(/\/{2,}/g,"/"),s.pathname=h}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let o=s.pathname.split("/");const l=o[o.length-1];testParameter$1(l,e.removeDirectoryIndex)&&(o=o.slice(0,-1),s.pathname=`${o.slice(1).join("/")}/`)}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const o of[...s.searchParams.keys()])testParameter$1(o,e.removeQueryParameters)&&s.searchParams.delete(o);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const o of[...s.searchParams.keys()])testParameter$1(o,e.keepQueryParameters)||s.searchParams.delete(o);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const a=t;return t=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!a.endsWith("/")&&s.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var NDKRelayKeepalive$1=class{constructor(e=3e4,n){this.onSilenceDetected=n,this.timeout=e}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const e=Date.now()-this.lastActivity;if(e>=this.timeout)this.onSilenceDetected();else{const n=this.timeout-e;this.timer=setTimeout(()=>{this.onSilenceDetected()},n)}},this.timeout)}};async function probeRelayConnection$1(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(n=>{let r=!1;const s=setTimeout(()=>{r||(r=!0,t.send(["CLOSE",e]),n(!1))},5e3),a=()=>{r||(r=!0,clearTimeout(s),t.send(["CLOSE",e]),n(!0))};t.once("message",a),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS$1=5,FLAPPING_THRESHOLD_MS$1=1e3,NDKRelayConnectivity$1=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;pendingAuthPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(e,n){this.ndkRelay=e,this._status=1;const r=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${r}`),this.ndk=n,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive$1(12e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection$1({send:n=>this.send(JSON.stringify(n)),once:(n,r)=>{const s=a=>{try{const o=JSON.parse(a.data);(o[0]==="EOSE"||o[0]==="EVENT"||o[0]==="NOTICE")&&(r(),this.ws?.removeEventListener("message",s))}catch{}};this.ws?.addEventListener("message",s)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const e=Date.now(),n=e-this.lastSleepCheck;n>15e3&&(this.debug(`Detected possible sleep/wake (${n}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=e},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection$1({send:e=>this.send(JSON.stringify(e)),once:(e,n)=>{const r=s=>{try{const a=JSON.parse(s.data);(a[0]==="EOSE"||a[0]==="EVENT"||a[0]==="NOTICE")&&(n(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}}).then(e=>{e||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(e,n=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),e??=this.timeoutMs,!this.timeoutMs&&e&&(this.timeoutMs=e),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(n),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(r){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,r),this._status=1,n?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),r}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(e){this.debug("Failed to disconnect",e),this._status=1}}onConnectionError(e){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),e&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this.clearPendingPublishes(new Error(`Relay ${this.ndkRelay.url} disconnected`)),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(e){this.netDebug?.(e.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const n=JSON.parse(e.data),[r,s,...a]=n,o=this.ndkRelay.getProtocolHandler(r);if(o){o(this.ndkRelay,n);return}switch(r){case"EVENT":{const l=this.openSubs.get(s),h=n[2];if(!l){this.debug(`Received event for unknown subscription ${s}`);return}l.onevent(h);return}case"COUNT":{const l=n[2],h=this.openCountRequests.get(s);h&&(h.resolve(l.count),this.openCountRequests.delete(s));return}case"EOSE":{const l=this.openSubs.get(s);if(!l)return;l.oneose(s);return}case"OK":{const l=n[2],h=n[3],y=this.openEventPublishes.get(s),p=y?.pop();if(!y||!p){this.debug("Received OK for unknown event publish",s);return}l?(p.resolve(h),this.pendingAuthPublishes.delete(s)):h&&(h.toLowerCase().includes("auth-required")||h.toLowerCase().includes("not authorized")||h.toLowerCase().includes("blocked: not authorized"))?this.pendingAuthPublishes.get(s)?(this.debug("Publish failed due to auth-required, will retry after auth",s),y.push(p),this.openEventPublishes.set(s,y)):p.reject(new Error(h)):(p.reject(new Error(h)),this.pendingAuthPublishes.delete(s)),y.length===0?this.openEventPublishes.delete(s):!l&&!(h?.toLowerCase().includes("auth-required")||h?.toLowerCase().includes("not authorized")||h?.toLowerCase().includes("blocked: not authorized"))&&this.openEventPublishes.set(s,y);return}case"CLOSED":{const l=this.openSubs.get(s);if(!l)return;l.onclosed(n[2]);return}case"NOTICE":this.onNotice(n[1]);return;case"AUTH":{this.onAuthRequested(n[1]);return}}}catch(n){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${n.message}`,n?.stack);return}}async onAuthRequested(e){const n=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!n}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,n){if(this._status>=5){this._status=7;let r;try{r=await n(this.ndkRelay,e)}catch(s){this.debug("Authentication policy threw an error",s),r=!1}if(this.debug("Authentication policy returned",!!r),r instanceof NDKEvent$1||r===!0){r instanceof NDKEvent$1&&await this.auth(r);const s=async()=>{if(this._status>=5&&this._status<8){const a=new NDKEvent$1(this.ndk);a.kind=22242,a.tags=[["relay",this.ndkRelay.url],["challenge",e]],await a.sign(),this.auth(a).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful"),this.retryPendingAuthPublishes()}).catch(o=>{this._status=6,this.ndkRelay.emit("auth:failed",o),this.debug("Authentication failed",o),this.rejectPendingAuthPublishes(o)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};r===!0&&(this.ndk?.signer?s().catch(a=>{console.error("Error authenticating",a)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",s))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",e)}onError(e){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,e)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const e=this._connectionStats.durations;if(e.length%3!==0)return!1;const r=e.reduce((l,h)=>l+h,0)/e.length,s=e.map(l=>(l-r)**2).reduce((l,h)=>l+h,0)/e.length;return Math.sqrt(s)<FLAPPING_THRESHOLD_MS$1}async onNotice(e){this.ndkRelay.emit("notice",e)}handleReconnection(e=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let n;if(this.wasIdle){const r=[0,1e3,2e3,5e3,1e4,3e4];n=r[Math.min(e,r.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${e}, delay ${n}ms`)}else this.connectedAt?n=Math.max(0,6e4-(Date.now()-this.connectedAt)):(n=Math.min(1e3*2**e,3e4),this.debug(`Using standard backoff, attempt ${e}, delay ${n}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(r=>{e<MAX_RECONNECT_ATTEMPTS$1?this.handleReconnection(e+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},n),this.ndkRelay.emit("delayed-connect",n),this.debug("Reconnecting in",n),this._connectionStats.nextReconnectAt=Date.now()+n}async send(e){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(e),this.netDebug?.(e,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${e}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(e){const n=new Promise((r,s)=>{const a=this.openEventPublishes.get(e.id)??[];a.push({resolve:r,reject:s}),this.openEventPublishes.set(e.id,a)});return this.send(`["AUTH",${JSON.stringify(e.rawEvent())}]`),n}clearPendingPublishes(e){this.rejectPendingAuthPublishes(e);for(const[n,r]of this.openEventPublishes.entries()){for(;r.length>0;){const s=r.shift();s&&s.reject(e)}this.openEventPublishes.delete(n)}}retryPendingAuthPublishes(){if(this.pendingAuthPublishes.size!==0){this.debug(`Retrying ${this.pendingAuthPublishes.size} pending publishes after auth`);for(const[e,n]of this.pendingAuthPublishes.entries())this.debug(`Retrying publish for event ${e}`),this.send(`["EVENT",${JSON.stringify(n)}]`);this.pendingAuthPublishes.clear()}}rejectPendingAuthPublishes(e){if(this.pendingAuthPublishes.size!==0){this.debug(`Rejecting ${this.pendingAuthPublishes.size} pending publishes due to auth failure`);for(const[n]of this.pendingAuthPublishes.entries()){const r=this.openEventPublishes.get(n);if(r&&r.length>0){const s=r.pop();s&&s.reject(new Error(`Authentication failed: ${e.message}`)),r.length===0&&this.openEventPublishes.delete(n)}}this.pendingAuthPublishes.clear()}}async publish(e){const n=new Promise((r,s)=>{const a=this.openEventPublishes.get(e.id)??[];a.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${e.id} twice`),a.push({resolve:r,reject:s}),this.openEventPublishes.set(e.id,a)});return this.pendingAuthPublishes.set(e.id,e),this.send(`["EVENT",${JSON.stringify(e)}]`),n}async count(e,n){this.serial++;const r=n?.id||`count:${this.serial}`,s=new Promise((a,o)=>{this.openCountRequests.set(r,{resolve:a,reject:o})});return this.send(`["COUNT","${r}",${JSON.stringify(e).substring(1)}`),s}close(e,n){this.send(`["CLOSE","${e}"]`);const r=this.openSubs.get(e);this.openSubs.delete(e),r&&r.onclose(n)}req(e){`${this.send(`["REQ","${e.subId}",${JSON.stringify(e.executeFilters).substring(1)}`)}`,this.openSubs.set(e.subId,e)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}};async function fetchRelayInformation(t){const e=t.replace(/^wss:\/\//,"https://").replace(/^ws:\/\//,"http://"),n=await fetch(e,{headers:{Accept:"application/nostr+json"}});if(!n.ok)throw new Error(`Failed to fetch relay information: ${n.status} ${n.statusText}`);return await n.json()}var NDKRelayPublisher$1=class{ndkRelay;debug;constructor(e){this.ndkRelay=e,this.debug=e.debug.extend("publisher")}async publish(e,n=2500){let r;const s=()=>new Promise((m,v)=>{try{this.publishEvent(e).then(_=>{this.ndkRelay.emit("published",e),e.emit("relay:published",this.ndkRelay),m(!0)}).catch(v)}catch(_){v(_)}}),a=new Promise((m,v)=>{r=setTimeout(()=>{r=void 0,v(new Error(`Timeout: ${n}ms`))},n)}),o=()=>{s().then(m=>l(m)).catch(m=>h(m))};let l,h;const y=m=>{throw this.ndkRelay.debug("Publish failed",m,e.id),this.ndkRelay.emit("publish:failed",e,m),e.emit("relay:publish:failed",this.ndkRelay,m),m},p=()=>{r&&clearTimeout(r),this.ndkRelay.removeListener("connect",o)};return this.ndkRelay.status>=5?Promise.race([s(),a]).catch(y).finally(p):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((m,v)=>{l=m,h=v,this.ndkRelay.on("connect",o)}),a]).catch(y).finally(p))}async publishEvent(e){return this.ndkRelay.connectivity.publish(e.rawEvent())}};function filterFingerprint$1(t,e){const n=[];for(const s of t){const a=Object.entries(s||{}).map(([o,l])=>["since","until"].includes(o)?`${o}:${l}`:o).sort().join("-");n.push(a)}let r=e?"+":"";return r+=n.join("|"),r}function mergeFilters$1(t){const e=[],n={};return t.filter(r=>!!r.limit).forEach(r=>e.push(r)),t=t.filter(r=>!r.limit),t.length===0?e:(t.forEach(r=>{Object.entries(r).forEach(([s,a])=>{Array.isArray(a)?n[s]===void 0?n[s]=[...a]:n[s]=Array.from(new Set([...n[s],...a])):n[s]=a})}),[...e,n])}var MAX_ITEMS=3;function formatArray(t,e){const r=(e?t.slice(0,MAX_ITEMS).map(e):t.slice(0,MAX_ITEMS)).join(",");return t.length>MAX_ITEMS?`${r}+${t.length-MAX_ITEMS}`:r}function formatFilters(t){return t.map(e=>{const n=[];e.ids?.length&&n.push(`ids:[${formatArray(e.ids,r=>String(r).slice(0,8))}]`),e.kinds?.length&&n.push(`kinds:[${formatArray(e.kinds)}]`),e.authors?.length&&n.push(`authors:[${formatArray(e.authors,r=>String(r).slice(0,8))}]`),e.since&&n.push(`since:${e.since}`),e.until&&n.push(`until:${e.until}`),e.limit&&n.push(`limit:${e.limit}`),e.search&&n.push(`search:"${String(e.search).slice(0,20)}"`);for(const[r,s]of Object.entries(e))r.startsWith("#")&&Array.isArray(s)&&s.length>0&&n.push(`${r}:[${formatArray(s,a=>String(a).slice(0,8))}]`);return`{${n.join(" ")}}`}).join(", ")}var NDKRelaySubscription$1=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(e,n,r){this.relay=e,this.topSubManager=r,this.debug=e.debug.extend(`sub[${this.id}]`),this.fingerprint=n||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(e){this.subIdParts.add(e)}addItem(e,n){if(this.debug("Adding item",{filters:formatFilters(n),internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,itemsSize:this.items.size}),!this.items.has(e.internalId))switch(e.on("close",this.removeItem.bind(this,e)),this.items.set(e.internalId,{subscription:e,filters:n}),this.status!==3&&e.subId&&(!this._subId||this._subId.length<25)&&(this.status===0||this.status===1)&&this.addSubIdPart(e.subId),this.status){case 0:this.evaluateExecutionPlan(e);break;case 3:break;case 1:this.evaluateExecutionPlan(e);break;case 4:throw this.debug("Subscription is closed, cannot add new items",{filters:formatFilters(n),subId:e.subId,internalId:e.internalId}),new Error("Cannot add new items to a closed subscription")}}removeItem(e){if(this.items.delete(e.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const e=this.status;if(this.status=4,e===3)try{this.relay.close(this.subId)}catch(n){this.debug("Error closing subscription",n,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:e,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(e){if(!e.isGroupable()){this.status=1,this.execute();return}if(e.filters.find(s=>!!s.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const n=e.groupableDelay,r=e.groupableDelayType;if(!n)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(n,r);else{const s=this.delayType,a=this.fireTime-Date.now();if(s==="at-least"&&r==="at-least")a<n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else if(s==="at-least"&&r==="at-most")a>n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else if(s==="at-most"&&r==="at-most")a>n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else if(s==="at-most"&&r==="at-least")a>n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else throw new Error(`Unknown delay type combination ${s} ${r}`)}}schedule(e,n){this.status=1;const r=Date.now();this.fireTime=r+e,this.delayType=n;const s=setTimeout(this.execute.bind(this),e);n==="at-least"&&(this.executionTimer=s)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size,filters:formatFilters(this.compileFilters())}),this.status=1,this.execute()}};finalizeSubId(){if(this.subIdParts.size>0){let n=Array.from(this.subIdParts).map(r=>r.substring(0,10)).join("-");n.length>20&&(n=n.substring(0,20)),this._subId=n}else this._subId=this.fingerprint.slice(0,15);this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const e=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:e}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",e,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(e){this.topSubManager.dispatchEvent(e,this.relay)}oneose(e){if(this.eosed=!0,e!==this.subId){this.debug("Received EOSE for an abandoned subscription",e,this.subId),this.relay.close(e);return}this.items.size===0&&this.close();for(const{subscription:n}of this.items.values())n.eoseReceived(this.relay),n.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:formatFilters(n.filters),internalId:n.internalId,status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.removeItem(n))}onclose(e){this.status=4}onclosed(e){if(e)for(const{subscription:n}of this.items.values())n.closedReceived(this.relay,e)}compileFilters(){const e=[],n=Array.from(this.items.values()).map(s=>s.filters);if(!n[0])return this.debug(" No filters to merge",{itemsSize:this.items.size}),[];const r=n[0].length;for(let s=0;s<r;s++){const a=n.map(l=>l[s]),o=mergeFilters$1(a);e.push(...o)}return e}},NDKRelaySubscriptionManager$1=class{relay;subscriptions;generalSubManager;constructor(e,n){this.relay=e,this.subscriptions=new Map,this.generalSubManager=n}addSubscription(e,n){let r;if(!e.isGroupable())r=this.createSubscription(e,n);else{const s=filterFingerprint$1(n,e.closeOnEose);s&&(r=(this.subscriptions.get(s)||[]).find(o=>o.status<3)),r??=this.createSubscription(e,n,s)}r.addItem(e,n)}createSubscription(e,n,r){const s=new NDKRelaySubscription$1(this.relay,r||null,this.generalSubManager);s.onClose=this.onRelaySubscriptionClose.bind(this);const a=this.subscriptions.get(s.fingerprint)??[];return this.subscriptions.set(s.fingerprint,[...a,s]),s}onRelaySubscriptionClose(e){let n=this.subscriptions.get(e.fingerprint)??[];n?n.length===1?this.subscriptions.delete(e.fingerprint):(n=n.filter(r=>r.id!==e.id),this.subscriptions.set(e.fingerprint,n)):console.warn("Unexpectedly did not find a subscription with fingerprint",e.fingerprint)}},NDKRelay$1=class Ur extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;protocolHandlers=new Map;_relayInfo;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,n,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let s=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const a=n/100;s=Math.max(e.lowestValidationRatio,e.validationRatio-a)}return s<e.validationRatio?s:e.validationRatio};constructor(e,n,r){super(),this.url=normalizeRelayUrl$1(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity$1(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager$1(this,r.subManager),this.publisher=new NDKRelayPublisher$1(this),this.authPolicy=n,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??Ur.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,n=!0){return this.connectivity.connect(e,n)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,n){this.subs.addSubscription(e,n)}async publish(e,n=2500){return this.publisher.publish(e,n)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close;registerProtocolHandler(e,n){this.protocolHandlers.set(e,n)}unregisterProtocolHandler(e){this.protocolHandlers.delete(e)}getProtocolHandler(e){return this.protocolHandlers.get(e)}async fetchInfo(e=!1){const r=this.connectivity.ndk;if(!e&&r?.cacheAdapter?.getRelayStatus){const s=await r.cacheAdapter.getRelayStatus(this.url);if(s?.nip11&&Date.now()-s.nip11.fetchedAt<864e5)return this._relayInfo=s.nip11.data,s.nip11.data}return!e&&this._relayInfo?this._relayInfo:(this._relayInfo=await fetchRelayInformation(this.url),r?.cacheAdapter?.updateRelayStatus&&await r.cacheAdapter.updateRelayStatus(this.url,{nip11:{data:this._relayInfo,fetchedAt:Date.now()}}),this._relayInfo)}get info(){return this._relayInfo}},NDKPublishError$1=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(e,n,r,s){super(e),this.errors=n,this.publishedToRelays=r,this.intendedRelaySet=s}get relayErrors(){const e=[];for(const[n,r]of this.errors)e.push(`${n.url}: ${r}`);return e.join(`
`)}},NDKRelaySet$1=class Fr{relays;debug;ndk;pool;constructor(e,n,r){this.relays=e,this.ndk=n,this.pool=r??n.pool,this.debug=n.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,n,r=!0,s){if(s=s??n.pool,!s)throw new Error("No pool provided");const a=new Set;for(const o of e){const l=s.relays.get(normalizeRelayUrl$1(o));if(l)l.status<5&&r&&l.connect(),a.add(l);else{const h=new NDKRelay$1(normalizeRelayUrl$1(o),n?.relayAuthDefaultPolicy,n);s.useTemporaryRelay(h,void 0,`requested from fromRelayUrls ${e}`),a.add(h)}}return new Fr(new Set(a),n,s)}async publish(e,n,r=1){const s=new Set,a=new Map,o=e.isEphemeral();e.publishStatus="pending";const l=h=>{s.add(h)};e.on("relay:published",l);try{const h=Array.from(this.relays).map(y=>new Promise(p=>{const m=n?setTimeout(()=>{s.has(y)||(a.set(y,new Error(`Publish timeout after ${n}ms`)),p(!1))},n):null;y.publish(e,n).then(v=>{m&&clearTimeout(m),v?(s.add(y),p(!0)):p(!1)}).catch(v=>{m&&clearTimeout(m),o||a.set(y,v),p(!1)})}));if(await Promise.all(h),s.size<r){if(!o){const y=new NDKPublishError$1("Not enough relays received the event ("+s.size+" published, "+r+" required)",a,s,this);throw e.publishStatus="error",e.publishError=y,this.ndk?.emit("event:publish-failed",e,y,this.relayUrls),y}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:s});return s}finally{e.off("relay:published",l)}}get size(){return this.relays.size}},d$2=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent$1(t,e,n){const r=new Set,s=await getWriteRelaysFor$1(t,e.pubkey);s&&s.forEach(l=>{const h=t.pool?.getRelay(l);h&&r.add(h)});let a=e.tags.filter(l=>["a","e"].includes(l[0])).map(l=>l[2]).filter(l=>l?.startsWith("wss://")).filter(l=>{try{return new URL(l),!0}catch{return!1}}).map(l=>normalizeRelayUrl$1(l));a=Array.from(new Set(a)).slice(0,5),a.forEach(l=>{const h=t.pool?.getRelay(l,!0,!0);h&&(d$2("Adding relay hint %s",l),r.add(h))});const o=e.getMatchingTags("p").map(l=>l[1]);return o.length<5?Array.from(chooseRelayCombinationForPubkeys$1(t,o,"read",{preferredRelays:new Set(s)}).keys()).forEach(h=>{const y=t.pool?.getRelay(h,!1,!0);y&&(d$2("Adding p-tagged relay %s",h),r.add(y))}):d$2("Too many p-tags to consider %d",o.length),t.pool?.permanentAndConnectedRelays().forEach(l=>r.add(l)),n&&r.size<n&&t.explicitRelayUrls?.filter(h=>!Array.from(r).some(y=>y.url===h)).slice(0,n-r.size)?.forEach(h=>{const y=t.pool?.getRelay(h,!1,!0);y&&(d$2("Adding explicit relay %s",h),r.add(y))}),new NDKRelaySet$1(r,t)}function calculateRelaySetsFromFilter(t,e,n,r){const s=new Map,a=new Set;if(e.forEach(o=>{o.authors&&o.authors.forEach(l=>a.add(l))}),a.size>0){const o=getRelaysForFilterWithAuthors(t,Array.from(a),r);for(const l of o.keys())s.set(l,[]);for(const l of e)if(l.authors)for(const[h,y]of o.entries()){const p=l.authors.filter(m=>y.includes(m));s.set(h,[...s.get(h),{...l,authors:p}])}else for(const h of o.keys())s.set(h,[...s.get(h),l])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(o=>{s.set(o,e)});return s.size===0&&n.permanentAndConnectedRelays().slice(0,5).forEach(o=>{s.set(o.url,e)}),s}function calculateRelaySetsFromFilters(t,e,n,r){return calculateRelaySetsFromFilter(t,e,n,r)}function isValidHex64(t){if(typeof t!="string"||t.length!==64)return!1;for(let e=0;e<64;e++){const n=t.charCodeAt(e);if(!(n>=48&&n<=57||n>=97&&n<=102||n>=65&&n<=70))return!1}return!0}function isValidPubkey(t){return isValidHex64(t)}function isValidNip05(t){if(typeof t!="string")return!1;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)===46)return!0;return!1}function mergeTags$1(t,e){const n=new Map,r=o=>o.join(","),s=(o,l)=>o.every((h,y)=>h===l[y]),a=o=>{for(const[l,h]of n)if(s(h,o)||s(o,h)){o.length>=h.length&&n.set(l,o);return}n.set(r(o),o)};return t.concat(e).forEach(a),Array.from(n.values())}var hashtagRegex$1=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags$1(t){const e=t.match(hashtagRegex$1),n=new Set,r=new Set;if(e)for(const s of e)n.has(s.slice(1))||(r.add(s.slice(1)),n.add(s.slice(1)));return Array.from(r)}async function generateContentTags$1(t,e=[],n,r){if(n?.skipContentTagging)return{content:t,tags:e};const s=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,a=[],o=l=>{e.find(h=>["q",l[0]].includes(h[0])&&h[1]===l[1])||e.push(l)};if(t=t.replace(s,l=>{try{const h=l.split(/(@|nostr:)/)[2],{type:y,data:p}=nip19_exports$2.decode(h);let m;if(n?.filters){const v=!n.filters.includeTypes||n.filters.includeTypes.includes(y),_=n.filters.excludeTypes?.includes(y);if(!v||_)return l}switch(y){case"npub":n?.pTags!==!1&&(m=["p",p]);break;case"nprofile":n?.pTags!==!1&&(m=["p",p.pubkey]);break;case"note":a.push(new Promise(async v=>{const _=await maybeGetEventRelayUrl$1(h);o(["q",p,_]),v()}));break;case"nevent":a.push(new Promise(async v=>{const{id:_,author:S}=p;let{relays:T}=p;(!T||T.length===0)&&(T=[await maybeGetEventRelayUrl$1(h)]),o(["q",_,T[0]]),S&&n?.pTags!==!1&&n?.pTagOnQTags!==!1&&o(["p",S]),v()}));break;case"naddr":a.push(new Promise(async v=>{const _=[p.kind,p.pubkey,p.identifier].join(":");let S=p.relays??[];S.length===0&&(S=[await maybeGetEventRelayUrl$1(h)]),o(["q",_,S[0]]),n?.pTags!==!1&&n?.pTagOnQTags!==!1&&n?.pTagOnATags!==!1&&o(["p",p.pubkey]),v()}));break;default:return l}return m&&o(m),`nostr:${h}`}catch{return l}}),await Promise.all(a),!n?.filters?.excludeTypes?.includes("hashtag")){const l=generateHashtags$1(t).map(h=>["t",h]);e=mergeTags$1(e,l)}if(n?.pTags!==!1&&n?.copyPTagsFromTarget&&r){const l=r.getMatchingTags("p");for(const h of l)!h[1]||!isValidPubkey(h[1])||e.find(y=>y[0]==="p"&&y[1]===h[1])||e.push(h)}return{content:t,tags:e}}async function maybeGetEventRelayUrl$1(t){return""}async function encrypt$1(t,e,n="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const a=t||(()=>{const o=this.getMatchingTags("p");if(o.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:o[0][1]})})();if(n==="nip44"&&await isEncryptionEnabled$1(s,"nip44")&&(r=await s.encrypt(a,this.content,"nip44")),(!r||n==="nip04")&&await isEncryptionEnabled$1(s,"nip04")&&(r=await s.encrypt(a,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function decrypt$1(t,e,n){if(this.ndk?.cacheAdapter?.getDecryptedEvent){const l=await this.ndk.cacheAdapter.getDecryptedEvent(this.id);if(l){this.content=l.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const a=t||this.author;if(!a)throw new Error("No sender provided and no author available");const o=n||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((o==="nip04"||this.kind===4)&&await isEncryptionEnabled$1(s,"nip04")&&this.content.search("\\?iv=")&&(r=await s.decrypt(a,this.content,"nip04")),!r&&o==="nip44"&&await isEncryptionEnabled$1(s,"nip44")&&(r=await s.decrypt(a,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this.id,this)}async function isEncryptionEnabled$1(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function eventHasETagMarkers$1(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag$1(t,e){e??=t.tagType();const n=t.tags.find(isTagRootTag$1);if(!n){if(eventHasETagMarkers$1(t))return;const r=t.getMatchingTags(e);if(r.length<3)return r[0]}return n}var nip22RootTags$1=new Set(["A","E","I"]),nip22ReplyTags$1=new Set(["a","e","i"]);function getReplyTag$1(t,e){if(t.kind===1111){let s;for(const a of t.tags)if(nip22RootTags$1.has(a[0]))s=a;else if(nip22ReplyTags$1.has(a[0])){s=a;break}return s}e??=t.tagType();let n=!1,r;for(const s of t.tags)if(s[0]===e){if((s[3]??"").length>0&&(n=!0),n&&s[3]==="reply")return s;n&&s[3]==="root"&&(r=s),n||(r=s)}return r}function isTagRootTag$1(t){return t[0]==="E"||t[3]==="root"}async function fetchTaggedEvent$1(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(n.length===0)return;const[r,s,a]=n[0],o=a!==""?this.ndk.pool.getRelay(a):void 0;return await this.ndk.fetchEvent(s,{},o)}async function fetchRootEvent$1(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag$1(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent$1(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag$1(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function isReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT$1=2;function encode$1(t=DEFAULT_RELAY_COUNT$1){let e=[];return this.onRelays.length>0?e=this.onRelays.map(n=>n.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost$1(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new NDKEvent$1(this.ndk,{kind:getKind$1(this)});return this.isProtected||(n.content=JSON.stringify(this.rawEvent())),n.tag(this),this.kind!==1&&n.tags.push(["k",`${this.kind}`]),e&&await n.sign(e),t&&await n.publish(),n}function getKind$1(t){return t.kind===1?6:16}function getEventDetails(t){return"inspect"in t&&typeof t.inspect=="string"?t.inspect:JSON.stringify(t)}function validateForSerialization(t){if(typeof t.kind!="number")throw new Error(`Can't serialize event with invalid properties: kind (must be number, got ${typeof t.kind}). Event: ${getEventDetails(t)}`);if(typeof t.content!="string")throw new Error(`Can't serialize event with invalid properties: content (must be string, got ${typeof t.content}). Event: ${getEventDetails(t)}`);if(typeof t.created_at!="number")throw new Error(`Can't serialize event with invalid properties: created_at (must be number, got ${typeof t.created_at}). Event: ${getEventDetails(t)}`);if(typeof t.pubkey!="string")throw new Error(`Can't serialize event with invalid properties: pubkey (must be string, got ${typeof t.pubkey}). Event: ${getEventDetails(t)}`);if(!Array.isArray(t.tags))throw new Error(`Can't serialize event with invalid properties: tags (must be array, got ${typeof t.tags}). Event: ${getEventDetails(t)}`);for(let e=0;e<t.tags.length;e++){const n=t.tags[e];if(!Array.isArray(n))throw new Error(`Can't serialize event with invalid properties: tags[${e}] (must be array, got ${typeof n}). Event: ${getEventDetails(t)}`);for(let r=0;r<n.length;r++)if(typeof n[r]!="string")throw new Error(`Can't serialize event with invalid properties: tags[${e}][${r}] (must be string, got ${typeof n[r]}). Event: ${getEventDetails(t)}`)}}function serialize$1(t=!1,e=!1){validateForSerialization(this);const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}function deserialize$1(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],s=e[7];r&&r.length===128?(n.sig=r,s&&s.length===64&&(n.id=s)):r&&r.length===64&&(n.id=r,s&&s.length===128&&(n.sig=s))}return n}var worker,processingQueue$1={};function signatureVerificationInit(t){worker=t,worker.onmessage=e=>{if(!Array.isArray(e.data)||e.data.length!==2){console.error("[NDK]  Signature verification worker received incompatible message format.",`

 Expected format: [eventId, boolean]`,`
 Received:`,e.data,`

 This likely means:`,`
  1. You have a STALE worker.js file that needs updating`,`
  2. Version mismatch between @nostr-dev-kit/ndk and deployed worker`,`
  3. Wrong worker is being used for signature verification`,`

 Solution: Update your worker files:`,`
  cp node_modules/@nostr-dev-kit/ndk/dist/workers/sig-verification.js public/`,`
  cp node_modules/@nostr-dev-kit/cache-sqlite-wasm/dist/worker.js public/`,`

 Or use Vite/bundler imports instead of static files:`,`
  import SigWorker from "@nostr-dev-kit/ndk/workers/sig-verification?worker"`);return}const[n,r]=e.data,s=processingQueue$1[n];if(!s){console.error("No record found for event",n);return}delete processingQueue$1[n];for(const a of s.resolves)a(r)}}async function verifySignatureAsync$1(t,e,n){const r=t.ndk,s=Date.now();let a;return r.signatureVerificationFunction?a=await r.signatureVerificationFunction(t):a=await new Promise(o=>{const l=t.serialize();let h=!1;processingQueue$1[t.id]||(processingQueue$1[t.id]={event:t,resolves:[],relay:n},h=!0),processingQueue$1[t.id].resolves.push(o),h&&worker?.postMessage({serialized:l,id:t.id,sig:t.sig,pubkey:t.pubkey})}),r.signatureVerificationTimeMs+=Date.now()-s,a}var PUBKEY_REGEX$1=/^[a-f0-9]{64}$/;function validate$1(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX$1)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(typeof e[n]=="object")return!1}return!0}var verifiedSignatures$1=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature$1(t){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures$1.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification){const n=this.relay;verifySignatureAsync$1(this,t,n).then(r=>{t&&(this.signatureVerified=r,r&&verifiedSignatures$1.set(this.id,this.sig)),r?n&&n.addValidatedEvent():(n?this.ndk?.reportInvalidSignature(this,n):this.ndk?.reportInvalidSignature(this),verifiedSignatures$1.set(this.id,!1))}).catch(r=>{console.error("signature verification error",this.id,r)})}else{const n=sha256_1(new TextEncoder().encode(this.serialize())),r=schnorr.verify(this.sig,n,this.pubkey);return r?verifiedSignatures$1.set(this.id,this.sig):verifiedSignatures$1.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash$2(){return getEventHashFromSerializedEvent$1(this.serialize())}function getEventHashFromSerializedEvent$1(t){const e=sha256_1(new TextEncoder().encode(t));return utils$1.bytesToHex(e)}var skipClientTagOnKinds$1=new Set([0,4,1059,13,3,9734,5]),NDKEvent$1=class bt extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,n){super(),this.ndk=e,this.created_at=n?.created_at,this.content=n?.content||"",this.tags=n?.tags||[],this.id=n?.id||"",this.sig=n?.sig,this.pubkey=n?.pubkey||"",this.kind=n?.kind,n instanceof bt&&(this.relay&&(this.relay=n.relay,this.ndk?.subManager.seenEvent(n.id,this.relay)),this.publishStatus=n.publishStatus,this.publishError=n.publishError)}static deserialize(e,n){return new bt(e,deserialize$1(n))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,n,r){const s=["i"],a=["k"];switch(n){case"url":{const o=new URL(e);o.hash="",s.push(o.toString()),a.push(`${o.protocol}//${o.host}`);break}case"hashtag":s.push(`#${e.toLowerCase()}`),a.push("#");break;case"geohash":s.push(`geo:${e.toLowerCase()}`),a.push("geo");break;case"isbn":s.push(`isbn:${e.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${e}`),a.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${e}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${e}`),a.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${e.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":s.push(`doi:${e.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${n}`)}r&&s.push(r),this.tags.push(s),this.tags.push(a)}tag(e,n,r,s,a){let o=[];if(e.fetchProfile!==void 0){if(s??="p",s==="p"&&a?.pTags===!1)return;const h=[s,e.pubkey];n&&h.push("",n),o.push(h)}else if(e instanceof bt){const h=e;if(r??=h?.pubkey===this.pubkey,o=h.referenceTags(n,r,s,a),a?.pTags!==!1)for(const y of h.getMatchingTags("p"))!y[1]||!isValidPubkey(y[1])||y[1]!==this.pubkey&&(this.tags.find(p=>p[0]==="p"&&p[1]===y[1])||this.tags.push(["p",y[1]]))}else if(Array.isArray(e))o=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags$1(this.tags,o)}async toNostrEvent(e,n){if(!e&&this.pubkey===""){const a=await this.ndk?.signer?.user();this.pubkey=a?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags(n);this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize$1.bind(this);getEventHash=getEventHash$2.bind(this);validate=validate$1.bind(this);verifySignature=verifySignature$1.bind(this);isReplaceable=isReplaceable$1.bind(this);isEphemeral=isEphemeral$1.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable$1.bind(this);encode=encode$1.bind(this);encrypt=encrypt$1.bind(this);decrypt=decrypt$1.bind(this);getMatchingTags(e,n){const r=this.tags.filter(s=>s[0]===e);return n===void 0?r:r.filter(s=>s[3]===n)}hasTag(e,n){return this.tags.some(r=>r[0]===e&&(!n||r[3]===n))}tagValue(e,n){const r=this.getMatchingTags(e,n);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,n){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(s=>{const a=r.includes(s[0]),o=n?s[3]===n:!0;return!(a&&o)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,n){this.ndk?.aiGuardrails?.event?.signing(this),e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,n);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,n,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,n,r)}async publish(e,n,r,s){if(r||(r=1),this.sig||await this.sign(void 0,s),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if(this.ndk.aiGuardrails?.event?.publishing(this),(!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent$1(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const l=this.getMatchingTags("e").map(h=>h[1]);this.ndk.cacheAdapter.deleteEventIds(l)}const a=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent$1(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(l){console.error("Error adding unpublished event to cache",l)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(l=>l[1])),this.ndk.subManager.dispatchEvent(a,void 0,!0);const o=await e.publish(this,n,r);return o.forEach(l=>this.ndk?.subManager.seenEvent(this.id,l)),o}async generateTags(e){let n=[];const r=await generateContentTags$1(this.content,this.tags,e,this),s=r.content;if(n=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const o=this.tagValue("title");let h=[...Array(o?6:16)].map(()=>Math.random().toString(36)[2]).join("");o&&o.length>0&&(h=`${o.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${h}`),n.push(["d",h])}if(this.shouldAddClientTag){const a=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&a.push(this.ndk?.clientNip89),n.push(a)}else this.shouldStripClientTag&&(n=n.filter(a=>a[0]!=="client"));return{content:s||"",tags:n}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds$1.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds$1.has(this.kind)}muted(){return this.ndk?.muteFilter&&this.ndk.muteFilter(this)?"muted":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let n;return this.isParamReplaceable()?n=["a",this.tagAddress()]:n=["e",this.tagId()],this.relay?n.push(this.relay.url):n.push(""),n.push(e??""),this.isParamReplaceable()||n.push(this.pubkey),n}referenceTags(e,n,r,s){let a=[];return this.isParamReplaceable()?a=[[r??"a",this.tagAddress()],[r??"e",this.id]]:a=[[r??"e",this.id]],a=a.map(o=>(o[0]==="e"||e?o.push(this.relay?.url??""):this.relay?.url&&o.push(this.relay?.url),o)),a.forEach(o=>{o[0]==="e"?(o.push(e??""),o.push(this.pubkey)):e&&o.push(e)}),a=[...a,...this.getMatchingTags("h")],!n&&s?.pTags!==!1&&a.push(...this.author.referenceTags()),a}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new bt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),n&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent$1.bind(this);fetchRootEvent=fetchRootEvent$1.bind(this);fetchReplyEvent=fetchReplyEvent$1.bind(this);repost=repost$1.bind(this);async react(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new bt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),n&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,n){const r=new bt(this.ndk);if(this.ndk?.aiGuardrails?.event?.creatingReply(r),this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,n)]:r.tag(this,"root",!1,void 0,n);else{r.kind=1111;const s=["A","E","I","P"],a=this.tags.filter(o=>s.includes(o[0]));if(a.length>0){const o=this.tagValue("K");r.tags.push(...a),o&&r.tags.push(["K",o]);let l;if(this.isParamReplaceable()){l=["a",this.tagAddress()];const h=this.relay?.url??"";h&&l.push(h)}else{l=["e",this.tagId()];const h=this.relay?.url??"";l.push(h),l.push(this.pubkey)}r.tags.push(l)}else{let o,l;const h=this.relay?.url??"";this.isParamReplaceable()?(o=["a",this.tagAddress(),h],l=["A",this.tagAddress(),h]):(o=["e",this.tagId(),h,this.pubkey],l=["E",this.tagId(),h,this.pubkey]),r.tags.push(o),r.tags.push(l),r.tags.push(["K",this.kind?.toString()]),n?.pTags!==!1&&n?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),n?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents$1=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent$1(t){return!untrackedUnpublishedEvents$1.has(t.kind)}var NDKPool$1=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;constructor(e,n,{debug:r,name:s}={}){super(),this.debug=r??n.debug.extend("pool"),s&&(this._name=s),this.ndk=n,this.relayUrls=e,this.ndk.pools&&this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(e){this._relays.clear();for(const n of e){const r=new NDKRelay$1(n,void 0,this.ndk);r.connectivity.netDebug=this.ndk.netDebug,this.addRelay(r)}}_name="unnamed";get name(){return this._name}set name(e){this._name=e,this.debug=this.debug.extend(e)}useTemporaryRelay(e,n=3e4,r){const s=this.relays.has(e.url);s||(this.addRelay(e),this.debug("Adding temporary relay %s for filters %o",e.url,r));const a=this.temporaryRelayTimers.get(e.url);if(a&&clearTimeout(a),!s||a){const o=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(e.url)||this.removeRelay(e.url)},n);this.temporaryRelayTimers.set(e.url,o)}}addRelay(e,n=!0){const r=this.relays.has(e.url),s=e.url.includes("/npub1");let a=!0;const o=e.url;if(r)return;if(this.ndk.relayConnectionFilter&&!this.ndk.relayConnectionFilter(o)){this.debug(`Refusing to add relay ${o}: blocked by relayConnectionFilter`);return}if(s){this.debug(`Refusing to add relay ${o}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const S=this.ndk.cacheAdapter.getRelayStatus(o),T=S instanceof Promise?void 0:S;if(T?.dontConnectBefore){if(T.dontConnectBefore>Date.now()){const k=T.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${o}: delayed connect for ${k}ms`),setTimeout(()=>{this.addRelay(e,n)},k);return}a=!1}}const l=S=>this.emit("notice",e,S),h=()=>this.handleRelayConnect(o),y=()=>this.handleRelayReady(e),p=()=>{this.recordDisconnection(e),this.emit("relay:disconnect",e)},m=()=>this.handleFlapping(e),v=S=>this.emit("relay:auth",e,S),_=()=>this.emit("relay:authed",e);e.off("notice",l),e.off("connect",h),e.off("ready",y),e.off("disconnect",p),e.off("flapping",m),e.off("auth",v),e.off("authed",_),e.on("notice",l),e.on("connect",h),e.on("ready",y),e.on("disconnect",p),e.on("flapping",m),e.on("auth",v),e.on("authed",_),e.on("delayed-connect",S=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+S})}),this._relays.set(o,e),n&&this.autoConnectRelays.add(o),n&&this.status==="active"&&(this.emit("relay:connecting",e),e.connect(void 0,a).catch(S=>{this.debug(`Failed to connect to relay ${o}`,S)}))}removeRelay(e){const n=this.relays.get(e);if(n)return n.disconnect(),this.relays.delete(e),this.autoConnectRelays.delete(e),this.emit("relay:disconnect",n),!0;const r=this.temporaryRelayTimers.get(e);return r&&(clearTimeout(r),this.temporaryRelayTimers.delete(e)),!1}isRelayConnected(e){const n=normalizeRelayUrl$1(e),r=this.relays.get(n);return r?r.status===5:!1}getRelay(e,n=!0,r=!1,s){let a=this.relays.get(normalizeRelayUrl$1(e));return a||(a=new NDKRelay$1(e,void 0,this.ndk),a.connectivity.netDebug=this.ndk.netDebug,r?this.useTemporaryRelay(a,3e4,s):this.addRelay(a,n)),a}handleRelayConnect(e){const n=this.relays.get(e);if(!n){console.error("NDK BUG: relay not found in pool",{relayUrl:e});return}this.emit("relay:connect",n),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.emit("relay:ready",e)}async connect(e){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}ms`:""}...`);const n=Array.from(this.autoConnectRelays.keys()).map(o=>this.relays.get(o)).filter(o=>!!o);for(const o of n)o.status!==5&&o.status!==4&&(this.emit("relay:connecting",o),o.connect().catch(l=>{this.debug(`Failed to connect to relay ${o.url}: ${l??"No reason specified"}`)}));const r=()=>n.every(o=>o.status===5),s=new Promise(o=>{if(r()){o();return}const l=[];for(const h of n){const y=()=>{if(r()){for(let p=0;p<n.length;p++)n[p].off("connect",l[p]);o()}};l.push(y),h.on("connect",y)}}),a=typeof e=="number"?new Promise(o=>setTimeout(o,e)):new Promise(()=>{});await Promise.race([s,a])}checkOnFlappingRelays(){const e=this.flappingRelays.size,n=this.relays.size;if(e/n>=.8)for(const r of this.flappingRelays)this.backoffTimes.set(r,0)}recordDisconnection(e){const n=Date.now();this.disconnectionTimes.set(e.url,n);for(const[r,s]of this.disconnectionTimes.entries())n-s>1e4&&this.disconnectionTimes.delete(r);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const e=Date.now(),n=[];for(const r of this.disconnectionTimes.values())e-r<5e3&&n.push(r);n.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${n.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){if(this.systemEventDetector){this.debug("System-wide reconnection already in progress, skipping");return}this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const e of this.relays.values())e.connectivity&&(e.connectivity.resetReconnectionState(),e.status!==5&&e.status!==4&&e.connect().catch(n=>{this.debug(`Failed to reconnect relay ${e.url} after system event: ${n}`)}));this.disconnectionTimes.clear()}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let n=this.backoffTimes.get(e.url)||5e3;n=n*2,this.backoffTimes.set(e.url,n),this.debug(`Backoff time for ${e.url} is ${n}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},n),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){const e={total:0,connected:0,disconnected:0,connecting:0};for(const n of this.relays.values())e.total++,n.status===5?e.connected++:n.status===1?e.disconnected++:n.status===4&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5&&!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}},NDKDVMJobFeedback=class Br extends NDKEvent$1{static kinds=[7e3];constructor(e,n){super(e,n),this.kind??=7e3}static async from(e){const n=new Br(e.ndk,e.rawEvent());return n.encrypted&&await n.dvmDecrypt(),n}get status(){return this.tagValue("status")}set status(e){this.removeTag("status"),e!==void 0&&this.tags.push(["status",e])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();const e=JSON.parse(this.content);this.tags.push(...e)}},NDKCashuMintList$1=class Lr extends NDKEvent$1{static kind=10019;static kinds=[10019];_p2pk;constructor(e,n){super(e,n),this.kind??=10019}static from(e){return new Lr(e.ndk,e)}set relays(e){this.tags=this.tags.filter(n=>n[0]!=="relay");for(const n of e)this.tags.push(["relay",n])}get relays(){const e=[];for(const n of this.tags)n[0]==="relay"&&e.push(n[1]);return e}set mints(e){this.tags=this.tags.filter(n=>n[0]!=="mint");for(const n of e)this.tags.push(["mint",n])}get mints(){const e=[];for(const n of this.tags)n[0]==="mint"&&e.push(n[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet$1.fromRelayUrls(this.relays,this.ndk)}},NDKArticle=class Mr extends NDKEvent$1{static kind=30023;static kinds=[30023];constructor(e,n){super(e,n),this.kind??=30023}static from(e){return new Mr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e){let n=Number.parseInt(e);return n>1e12&&(n=Math.floor(n/1e3)),n}}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(e){e?this.tags.push(["url",e]):this.removeTag("url")}},NDKBlossomList=class Hr extends NDKEvent$1{static kinds=[10063];constructor(e,n){super(e,n),this.kind??=10063}static from(e){return new Hr(e.ndk,e.rawEvent())}get servers(){return this.tags.filter(e=>e[0]==="server").map(e=>e[1])}set servers(e){this.tags=this.tags.filter(n=>n[0]!=="server");for(const n of e)this.tags.push(["server",n])}get default(){const e=this.servers;return e.length>0?e[0]:void 0}set default(e){if(!e)return;const r=this.servers.filter(s=>s!==e);this.servers=[e,...r]}addServer(e){if(!e)return;const n=this.servers;n.includes(e)||(this.servers=[...n,e])}removeServer(e){if(!e)return;const n=this.servers;this.servers=n.filter(r=>r!==e)}},NDKFedimintMint=class Vr extends NDKEvent$1{static kind=38173;static kinds=[38173];constructor(e,n){super(e,n),this.kind??=38173}static async from(e){return new Vr(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get inviteCodes(){return this.getMatchingTags("u").map(e=>e[1])}set inviteCodes(e){this.removeTag("u");for(const n of e)this.tags.push(["u",n])}get modules(){return this.getMatchingTags("modules").map(e=>e[1])}set modules(e){this.removeTag("modules");for(const n of e)this.tags.push(["modules",n])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKCashuMintAnnouncement=class zr extends NDKEvent$1{static kind=38172;static kinds=[38172];constructor(e,n){super(e,n),this.kind??=38172}static async from(e){return new zr(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get url(){return this.tagValue("u")}set url(e){this.removeTag("u"),e&&this.tags.push(["u",e])}get nuts(){return this.getMatchingTags("nuts").map(e=>e[1])}set nuts(e){this.removeTag("nuts");for(const n of e)this.tags.push(["nuts",n])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKMintRecommendation=class jr extends NDKEvent$1{static kind=38e3;static kinds=[38e3];constructor(e,n){super(e,n),this.kind??=38e3}static async from(e){return new jr(e.ndk,e)}get recommendedKind(){const e=this.tagValue("k");return e?Number(e):void 0}set recommendedKind(e){this.removeTag("k"),e&&this.tags.push(["k",e.toString()])}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get urls(){return this.getMatchingTags("u").map(e=>e[1])}set urls(e){this.removeTag("u");for(const n of e)this.tags.push(["u",n])}get mintEventPointers(){return this.getMatchingTags("a").map(e=>({kind:Number(e[1].split(":")[0]),identifier:e[1].split(":")[2],relay:e[2]}))}addMintEventPointer(e,n,r,s){const a=["a",`${e}:${n}:${r}`];s&&a.push(s),this.tags.push(a)}get review(){return this.content}set review(e){this.content=e}},NDKClassified=class Wr extends NDKEvent$1{static kinds=[30402];constructor(e,n){super(e,n),this.kind??=30402}static from(e){return new Wr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}get location(){return this.tagValue("location")}set location(e){this.removeTag("location"),e&&this.tags.push(["location",e])}get price(){const e=this.tags.find(n=>n[0]==="price");if(e)return{amount:Number.parseFloat(e[1]),currency:e[2],frequency:e[3]}}set price(e){if(typeof e=="string"&&(e={amount:Number.parseFloat(e)}),e?.amount){const n=["price",e.amount.toString()];e.currency&&n.push(e.currency),e.frequency&&n.push(e.frequency),this.tags.push(n)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},NDKDraft=class qr extends NDKEvent$1{_event;static kind=31234;static kinds=[31234,1234];counterparty;constructor(e,n){super(e,n),this.kind??=31234}static from(e){return new qr(e.ndk,e)}set identifier(e){this.removeTag("d"),this.tags.push(["d",e])}get identifier(){return this.dTag}set event(e){e instanceof NDKEvent$1?this._event=e:this._event=new NDKEvent$1(void 0,e),this.prepareEvent()}set checkpoint(e){e?(this.tags.push(e.tagReference()),this.kind=1234):(this.removeTag("a"),this.kind=31234)}get isCheckpoint(){return this.kind===1234}get isProposal(){const e=this.tagValue("p");return!!e&&e!==this.pubkey}async getEvent(e){if(this._event)return this._event;if(e??=this.ndk?.signer,!e)throw new Error("No signer available");if(this.content&&this.content.length>0)try{const n=e.pubkey,s=[this.tagValue("p"),this.pubkey].filter(Boolean).find(l=>l!==n);let a;a=new NDKUser$1({pubkey:s??n}),await this.decrypt(a,e);const o=JSON.parse(this.content);return this._event=await wrapEvent(new NDKEvent$1(this.ndk,o)),this._event}catch(n){console.error(n);return}else return null}prepareEvent(){if(!this._event)throw new Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event.rawEvent())}async save({signer:e,publish:n,relaySet:r}){if(e??=this.ndk?.signer,!e)throw new Error("No signer available");const s=this.counterparty||await e.user();if(await this.encrypt(s,e),this.counterparty){const a=this.counterparty.pubkey;this.removeTag("p"),this.tags.push(["p",a])}if(n!==!1)return this.publishReplaceable(r)}};function mapImetaTag(t){const e={};if(t.length===2){const r=t[1].split(" ");for(let s=0;s<r.length;s+=2){const a=r[s],o=r[s+1];a==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(o)):e[a]=o}return e}const n=t.slice(1);for(const r of n){const s=r.split(" "),a=s[0],o=s.slice(1).join(" ");a==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(o)):e[a]=o}return e}function imetaTagToTag(t){const e=["imeta"];for(const[n,r]of Object.entries(t))if(Array.isArray(r))for(const s of r)e.push(`${n} ${s}`);else r&&e.push(`${n} ${r}`);return e}var NDKFollowPack=class Gr extends NDKEvent$1{static kind=39089;static kinds=[39089,39092];constructor(e,n){super(e,n),this.kind??=39089}static from(e){return new Gr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){const e=this.tags.find(n=>n[0]==="imeta");if(e){const n=mapImetaTag(e);if(n.url)return n.url}return this.tagValue("image")}set image(e){this.tags=this.tags.filter(n=>n[0]!=="imeta"&&n[0]!=="image"),typeof e=="string"?e!==void 0&&this.tags.push(["image",e]):e&&typeof e=="object"&&(this.tags.push(imetaTagToTag(e)),e.url&&this.tags.push(["image",e.url]))}get pubkeys(){return Array.from(new Set(this.tags.filter(e=>e[0]==="p"&&e[1]&&isValidPubkey(e[1])).map(e=>e[1])))}set pubkeys(e){this.tags=this.tags.filter(n=>n[0]!=="p");for(const n of e)this.tags.push(["p",n])}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}},NDKHighlight=class Jr extends NDKEvent$1{_article;static kind=9802;static kinds=[9802];constructor(e,n){super(e,n),this.kind??=9802}static from(e){return new Jr(e.ndk,e)}get url(){return this.tagValue("r")}set context(e){e===void 0?this.tags=this.tags.filter(([n,r])=>n!=="context"):(this.tags=this.tags.filter(([n,r])=>n!=="context"),this.tags.push(["context",e]))}get context(){return this.tags.find(([e,n])=>e==="context")?.[1]??void 0}get article(){return this._article}set article(e){this._article=e,typeof e=="string"?this.tags.push(["r",e]):this.tag(e)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){if(this._article!==void 0)return this._article;let e;const n=this.getArticleTag();if(n){switch(n[0]){case"a":{const[r,s,a]=n[1].split(":");e=nip19_exports$2.naddrEncode({kind:Number.parseInt(r),pubkey:s,identifier:a});break}case"e":e=nip19_exports$2.noteEncode(n[1]);break;case"r":this._article=n[1];break}if(e){let r=await this.ndk?.fetchEvent(e);r&&(r.kind===30023&&(r=NDKArticle.from(r)),this._article=r)}return this._article}}},NDKImage=class Yr extends NDKEvent$1{static kind=20;static kinds=[20];_imetas;constructor(e,n){super(e,n),this.kind??=20}static from(e){return new Yr(e.ndk,e.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag).filter(e=>!!e.url),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(n=>n[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}},NDKList=class Zr extends NDKEvent$1{_encryptedTags;static kinds=[30001,10004,10050,10030,10015,10001,10002,10007,10006,10003];encryptedTagsLength;constructor(e,n){super(e,n),this.kind??=30001}static from(e){return new Zr(e.ndk,e)}get title(){const e=this.tagValue("title")||this.tagValue("name");return e||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(e){this.removeTag(["title","name"]),e&&this.tags.push(["title",e])}get name(){return this.title}set name(e){this.title=e}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const n=await this.ndk.signer.user();try{if(this.content.length>0)try{const r=await this.ndk.signer.decrypt(n,this.content),s=JSON.parse(r);return s?.[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=s):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{}}catch{}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(n=>n[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,n=void 0,r=!1,s="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let a;if(e instanceof NDKEvent$1)a=[e.tagReference(n)];else if(e instanceof NDKUser$1)a=e.referenceTags();else if(e instanceof NDKRelay$1)a=e.referenceTags();else if(Array.isArray(e))a=[e];else throw new Error("Invalid object type");if(n&&a[0].push(n),r){const o=await this.ndk.signer.user(),l=await this.encryptedTags();s==="top"?l.unshift(...a):l.push(...a),this._encryptedTags=l,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(l),await this.encrypt(o)}else s==="top"?this.tags.unshift(...a):this.tags.push(...a);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(e,n=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const r=this.tags.findIndex(l=>l[1]===e);r>=0&&this.tags.splice(r,1);const s=await this.ndk.signer.user(),a=await this.encryptedTags(),o=a.findIndex(l=>l[1]===e);if(o>=0&&(a.splice(o,1),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(s)),n)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,n){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(n){const r=await this.ndk.signer.user(),s=await this.encryptedTags();s.splice(e,1),this._encryptedTags=s,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(s),await this.encrypt(r)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(e){return this.items.some(n=>n[1]===e)}filterForItems(){const e=new Set,n=new Map,r=[];for(const s of this.items)if(s[0]==="e"&&s[1])e.add(s[1]);else if(s[0]==="a"&&s[1]){const[a,o,l]=s[1].split(":");if(!a||!o)continue;const h=`${a}:${o}`,y=n.get(h)||[];y.push(l||""),n.set(h,y)}if(e.size>0&&r.push({ids:Array.from(e)}),n.size>0)for(const[s,a]of n.entries()){const[o,l]=s.split(":");r.push({kinds:[Number.parseInt(o)],authors:[l],"#d":a})}return r}},NDKAppHandlerEvent=class Xr extends NDKEvent$1{profile;static kinds=[31990];constructor(e,n){super(e,n),this.kind??=31990}static from(e){const n=new Xr(e.ndk,e.rawEvent());return n.isValid?n:null}get isValid(){const e=new Map,n=s=>[s[0],s[2]].join(":").toLowerCase(),r=["web","android","ios"];for(const s of this.tags)if(r.includes(s[0])){const a=n(s);if(e.has(a)&&e.get(a)!==s[1].toLowerCase())return!1;e.set(a,s[1].toLowerCase())}return!0}async fetchProfile(){if(this.profile===void 0&&this.content.length>0)try{const e=JSON.parse(this.content);if(e?.name)return e;this.profile=null}catch{this.profile=null}return new Promise((e,n)=>{const r=this.author;r.fetchProfile().then(()=>{e(r.profile)}).catch(n)})}},NDKNutzap=class Qn extends NDKEvent$1{debug;_proofs=[];static kind=9321;static kinds=[Qn.kind];constructor(e,n){super(e,n),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(s=>JSON.parse(s[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const n=new Qn(e.ndk,e);if(!(!n._proofs||!n._proofs.length))return n}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(n=>n[0]!=="proof");for(const n of e)this.tags.push(["proof",JSON.stringify(n)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const n=JSON.parse(e.secret);let r;if(typeof n=="string"?(r=JSON.parse(n),this.debug("stringified payload",e.secret)):typeof n=="object"&&(r=n),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(n){this.debug("error parsing p2pk pubkey",n,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((n,r)=>n+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(n=>n[0]!=="p"),e instanceof NDKEvent$1&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser$1({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,n=0,r=0;for(const s of this.tags)s[0]==="e"&&e++,s[0]==="p"&&n++,s[0]==="u"&&r++;return n===1&&r===1&&e<=1&&this.proofs.length>0}},NDKProject=class Qr extends NDKEvent$1{static kind=31933;static kinds=[31933];_signer;constructor(e,n){super(e,n),this.kind=31933}static from(e){return new Qr(e.ndk,e.rawEvent())}set repo(e){this.removeTag("repo"),e&&this.tags.push(["repo",e])}set hashtags(e){this.removeTag("hashtags"),e.filter(n=>n.length>0).length&&this.tags.push(["hashtags",...e])}get hashtags(){const e=this.tags.find(n=>n[0]==="hashtags");return e?e.slice(1):[]}get repo(){return this.tagValue("repo")}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get picture(){return this.tagValue("picture")}set picture(e){this.removeTag("picture"),e&&this.tags.push(["picture",e])}set description(e){this.content=e}get description(){return this.content}get slug(){return this.dTag??"empty-dtag"}async getSigner(){if(this._signer)return this._signer;const e=this.tagValue("key");if(!e)this._signer=NDKPrivateKeySigner$1.generate(),await this.encryptAndSaveNsec();else{const n=await this.ndk?.signer?.decrypt(this.ndk.activeUser,e);if(!n)throw new Error("Failed to decrypt project key or missing signer context.");this._signer=new NDKPrivateKeySigner$1(n)}return this._signer}async getNsec(){return(await this.getSigner()).privateKey}async setNsec(e){this._signer=new NDKPrivateKeySigner$1(e),await this.encryptAndSaveNsec()}async encryptAndSaveNsec(){if(!this._signer)throw new Error("Signer is not set.");const e=this._signer.privateKey,n=await this.ndk?.signer?.encrypt(this.ndk.activeUser,e);n&&(this.removeTag("key"),this.tags.push(["key",n]))}},NDKProjectTemplate=class ei extends NDKEvent$1{static kind=30717;static kinds=[30717];constructor(e,n){super(e,n),this.kind=30717}static from(e){return new ei(e.ndk,e.rawEvent())}get templateId(){return this.dTag??""}set templateId(e){this.dTag=e}get name(){return this.tagValue("title")??""}set name(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get description(){return this.tagValue("description")??""}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get repoUrl(){return this.tagValue("uri")??""}set repoUrl(e){this.removeTag("uri"),e&&this.tags.push(["uri",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get command(){return this.tagValue("command")}set command(e){this.removeTag("command"),e&&this.tags.push(["command",e])}get agentConfig(){const e=this.tagValue("agent");if(e)try{return JSON.parse(e)}catch{return}}set agentConfig(e){this.removeTag("agent"),e&&this.tags.push(["agent",JSON.stringify(e)])}get templateTags(){return this.getMatchingTags("t").map(e=>e[1]).filter(Boolean)}set templateTags(e){this.tags=this.tags.filter(n=>n[0]!=="t"),e.forEach(n=>{n&&this.tags.push(["t",n])})}},READ_MARKER="read",WRITE_MARKER="write",NDKRelayList=class ti extends NDKEvent$1{static kinds=[10002];constructor(e,n){super(e,n),this.kind??=10002}static from(e){return new ti(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===READ_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set readRelayUrls(e){for(const n of e)this.tags.push(["r",n,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===WRITE_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set writeRelayUrls(e){for(const n of e)this.tags.push(["r",n,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(const n of e)this.tags.push(["r",n])}get relays(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").map(e=>e[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet$1(new Set(this.relays.map(e=>this.ndk?.pool.getRelay(e)).filter(e=>!!e)),this.ndk)}};function relayListFromKind3(t,e){try{const n=JSON.parse(e.content),r=new NDKRelayList(t),s=new Set,a=new Set;for(let[o,l]of Object.entries(n)){try{o=normalizeRelayUrl$1(o)}catch{continue}if(!l)s.add(o),a.add(o);else{const h=l;h.write&&a.add(o),h.read&&s.add(o)}}return r.readRelayUrls=Array.from(s),r.writeRelayUrls=Array.from(a),r}catch{}}var NDKRepost=class ni extends NDKEvent$1{_repostedEvents;static kinds=[6,16];static from(e){return new ni(e.ndk,e.rawEvent())}async repostedEvents(e,n){const r=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const s of this.repostedEventIds()){const a=filterForId(s),o=await this.ndk.fetchEvent(a,n);o&&r.push(e?e.from(o):o)}return r}repostedEventIds(){return this.tags.filter(e=>e[0]==="e"||e[0]==="a").map(e=>e[1])}};function filterForId(t){if(t.match(/:/)){const[e,n,r]=t.split(":");return{kinds:[Number.parseInt(e)],authors:[n],"#d":[r]}}return{ids:[t]}}var NDKSimpleGroupMemberList=class ri extends NDKEvent$1{relaySet;memberSet=new Set;static kind=39002;static kinds=[39002];constructor(e,n){super(e,n),this.kind??=39002,this.memberSet=new Set(this.members)}static from(e){return new ri(e.ndk,e)}get members(){return this.getMatchingTags("p").map(e=>e[1])}hasMember(e){return this.memberSet.has(e)}async publish(e,n,r){return e??=this.relaySet,super.publishReplaceable(e,n,r)}},NDKSimpleGroupMetadata=class ii extends NDKEvent$1{static kind=39e3;static kinds=[39e3];constructor(e,n){super(e,n),this.kind??=39e3}static from(e){return new ii(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){if(this.getMatchingTags("public").length>0)return"public";if(this.getMatchingTags("public").length>0)return"private"}set scope(e){this.removeTag("public"),this.removeTag("private"),e==="public"?this.tags.push(["public",""]):e==="private"&&this.tags.push(["private",""])}get access(){if(this.getMatchingTags("open").length>0)return"open";if(this.getMatchingTags("closed").length>0)return"closed"}set access(e){this.removeTag("open"),this.removeTag("closed"),e==="open"?this.tags.push(["open",""]):e==="closed"&&this.tags.push(["closed",""])}};function strToPosition(t){const[e,n]=t.split(",").map(Number);return{x:e,y:n}}function strToDimension(t){const[e,n]=t.split("x").map(Number);return{width:e,height:n}}var NDKStorySticker=class si{static Text="text";static Pubkey="pubkey";static Event="event";static Prompt="prompt";static Countdown="countdown";type;value;position;dimension;properties;constructor(e){if(Array.isArray(e)){const n=e;if(n[0]!=="sticker"||n.length<5)throw new Error("Invalid sticker tag");this.type=n[1],this.value=n[2],this.position=strToPosition(n[3]),this.dimension=strToDimension(n[4]);const r={};for(let s=5;s<n.length;s++){const[a,...o]=n[s].split(" ");r[a]=o.join(" ")}Object.keys(r).length>0&&(this.properties=r)}else this.type=e,this.value=void 0,this.position={x:0,y:0},this.dimension={width:0,height:0}}static fromTag(e){try{return new si(e)}catch{return null}}get style(){return this.properties?.style}set style(e){e?this.properties={...this.properties,style:e}:delete this.properties?.style}get rotation(){return this.properties?.rot?Number.parseFloat(this.properties.rot):void 0}set rotation(e){e!==void 0?this.properties={...this.properties,rot:e.toString()}:delete this.properties?.rot}get isValid(){return this.hasValidDimensions()&&this.hasValidPosition()}hasValidDimensions=()=>typeof this.dimension.width=="number"&&typeof this.dimension.height=="number"&&!Number.isNaN(this.dimension.width)&&!Number.isNaN(this.dimension.height);hasValidPosition=()=>typeof this.position.x=="number"&&typeof this.position.y=="number"&&!Number.isNaN(this.position.x)&&!Number.isNaN(this.position.y);toTag(){if(!this.isValid){const r=[this.hasValidDimensions()?void 0:"dimensions is invalid",this.hasValidPosition()?void 0:"position is invalid"].filter(Boolean);throw new Error(`Invalid sticker: ${r.join(", ")}`)}let e;switch(this.type){case"event":e=this.value.tagId();break;case"pubkey":e=this.value.pubkey;break;default:e=this.value}const n=["sticker",this.type,e,coordinates(this.position),dimension(this.dimension)];if(this.properties)for(const[r,s]of Object.entries(this.properties))n.push(`${r} ${s}`);return n}},NDKStory=class ai extends NDKEvent$1{static kind=23;static kinds=[23];_imeta;_dimensions;constructor(e,n){if(super(e,n),this.kind??=23,n)for(const r of n.tags)switch(r[0]){case"imeta":this._imeta=mapImetaTag(r);break;case"dim":this.dimensions=strToDimension(r[1]);break}}static from(e){return new ai(e.ndk,e)}get isValid(){return!!this.imeta}get imeta(){return this._imeta}set imeta(e){this._imeta=e,this.tags=this.tags.filter(n=>n[0]!=="imeta"),e&&this.tags.push(imetaTagToTag(e))}get dimensions(){const e=this.tagValue("dim");if(e)return strToDimension(e)}set dimensions(e){this.removeTag("dim"),e&&this.tags.push(["dim",`${e.width}x${e.height}`])}get duration(){const e=this.tagValue("dur");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("dur"),e!==void 0&&this.tags.push(["dur",e.toString()])}get stickers(){const e=[];for(const n of this.tags){if(n[0]!=="sticker"||n.length<5)continue;const r=NDKStorySticker.fromTag(n);r&&e.push(r)}return e}addSticker(e){let n;if(e instanceof NDKStorySticker)n=e;else{const r=["sticker",e.type,typeof e.value=="string"?e.value:"",coordinates(e.position),dimension(e.dimension)];if(e.properties)for(const[s,a]of Object.entries(e.properties))r.push(`${s} ${a}`);n=new NDKStorySticker(r),n.value=e.value}n.type==="pubkey"?this.tag(n.value):n.type==="event"&&this.tag(n.value),this.tags.push(n.toTag())}removeSticker(e){const n=this.stickers;if(e<0||e>=n.length)return;let r=0;for(let s=0;s<this.tags.length;s++)if(this.tags[s][0]==="sticker"){if(r===e){this.tags.splice(s,1);break}r++}}},coordinates=t=>`${t.x},${t.y}`,dimension=t=>`${t.width}x${t.height}`,NDKSubscriptionReceipt=class oi extends NDKEvent$1{debug;static kinds=[7003];constructor(e,n){super(e,n),this.kind??=7003,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new oi(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get subscriber(){const e=this.getMatchingTags("P")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set subscriber(e){this.removeTag("P"),e&&this.tags.push(["P",e.pubkey])}set subscriptionStart(e){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(e,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){return this.getMatchingTags("tier")?.[0]?.[1]}get isValid(){const e=this.validPeriod;if(!e||e.start>e.end)return!1;const n=this.getMatchingTags("p"),r=this.getMatchingTags("P");return!(n.length!==1||r.length!==1)}get validPeriod(){const e=this.getMatchingTags("valid")?.[0];if(e)try{return{start:new Date(Number.parseInt(e[1])*1e3),end:new Date(Number.parseInt(e[2])*1e3)}}catch{return}}set validPeriod(e){this.removeTag("valid"),e&&this.tags.push(["valid",Math.floor(e.start.getTime()/1e3).toString(),Math.floor(e.end.getTime()/1e3).toString()])}get startPeriod(){return this.validPeriod?.start}get endPeriod(){return this.validPeriod?.end}isActive(e){e??=new Date;const n=this.validPeriod;return!(!n||e<n.start||e>n.end)}},possibleIntervalFrequencies=["daily","weekly","monthly","quarterly","yearly"];function newAmount(t,e,n){return["amount",t.toString(),e,n]}function parseTagToSubscriptionAmount(t){const e=Number.parseInt(t[1]);if(Number.isNaN(e)||e===void 0||e===null||e<=0)return;const n=t[2];if(n===void 0||n==="")return;const r=t[3];if(r!==void 0&&possibleIntervalFrequencies.includes(r))return{amount:e,currency:n,term:r}}var NDKSubscriptionTier=class ci extends NDKArticle{static kind=37001;static kinds=[37001];constructor(e,n){const r=n?.kind??37001;super(e,n),this.kind=r}static from(e){return new ci(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(e=>e[1]).filter(e=>e!==void 0)}addPerk(e){this.tags.push(["perk",e])}get amounts(){return this.getMatchingTags("amount").map(e=>parseTagToSubscriptionAmount(e)).filter(e=>e!==void 0)}addAmount(e,n,r){this.tags.push(newAmount(e,n,r))}set relayUrl(e){this.tags.push(["r",e])}get relayUrls(){return this.getMatchingTags("r").map(e=>e[1]).filter(e=>e!==void 0)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(e){this.removeTag("p"),e&&this.tags.push(["p",e])}get isValid(){return this.title!==void 0&&this.amounts.length>0}},NDKSubscriptionStart=class li extends NDKEvent$1{debug;static kinds=[7001];constructor(e,n){super(e,n),this.kind??=7001,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new li(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get amount(){const e=this.getMatchingTags("amount")?.[0];if(e)return parseTagToSubscriptionAmount(e)}set amount(e){this.removeTag("amount"),e&&this.tags.push(newAmount(e.amount,e.currency,e.term))}get tierId(){const e=this.getMatchingTags("e")?.[0],n=this.getMatchingTags("a")?.[0];if(!(!e||!n))return e[1]??n[1]}set tier(e){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),e&&(this.tag(e),this.removeTag("p"),this.tags.push(["p",e.pubkey]),this.tags.push(["event",JSON.stringify(e.rawEvent())]))}async fetchTier(){const e=this.tagValue("event");if(e)try{const s=JSON.parse(e);return new NDKSubscriptionTier(this.ndk,s)}catch{this.debug("Failed to parse event tag")}const n=this.tierId;if(!n)return;const r=await this.ndk?.fetchEvent(n);if(r)return NDKSubscriptionTier.from(r)}get isValid(){return this.getMatchingTags("amount").length!==1?(this.debug("Invalid # of amount tag"),!1):this.amount?this.getMatchingTags("p").length!==1?(this.debug("Invalid # of p tag"),!1):this.recipient?!0:(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},NDKTask=class ui extends NDKEvent$1{static kind=1934;static kinds=[1934];constructor(e,n){super(e,n),this.kind=1934}static from(e){return new ui(e.ndk,e.rawEvent())}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get title(){return this.tagValue("title")}set project(e){this.removeTag("a"),this.tags.push(e.tagReference())}get projectSlug(){const e=this.getMatchingTags("a")[0];return e?e[1].split(/:/)?.[2]:void 0}},NDKThread=class hi extends NDKEvent$1{static kind=11;static kinds=[11];constructor(e,n){super(e,n),this.kind??=11}static from(e){return new hi(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}},NDKVideo=class di extends NDKEvent$1{static kind=21;static kinds=[34235,34236,22,21];_imetas;static from(e){return new di(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get thumbnail(){let e;return this.imetas&&this.imetas.length>0&&(e=this.imetas[0].image?.[0]),e??this.tagValue("thumb")}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(n=>n[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}async generateTags(){if(super.generateTags(),!this.kind&&this.imetas?.[0]?.dim){const[e,n]=this.imetas[0].dim.split("x"),r=e&&n&&Number.parseInt(e)<Number.parseInt(n);this.duration&&this.duration<120&&r?this.kind=22:this.kind=21}return super.generateTags()}get duration(){const e=this.tagValue("duration");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("duration"),e!==void 0&&this.tags.push(["duration",Math.floor(e).toString()])}},NDKWiki=class fi extends NDKArticle{static kind=30818;static kinds=[30818];static from(e){return new fi(e.ndk,e.rawEvent())}get isDefered(){return this.hasTag("a","defer")}get deferedId(){return this.tagValue("a","defer")}set defer(e){this.removeTag("a","defer"),this.tag(e,"defer")}},NDKWikiMergeRequest=class pi extends NDKEvent$1{static kinds=[818];static from(e){return new pi(e.ndk,e.rawEvent())}get targetId(){return this.tagValue("a")}set target(e){this.tags=this.tags.filter(n=>{if(n[0]==="a"||n[0]==="e"&&n[3]!=="source")return!0}),this.tag(e)}get sourceId(){return this.tagValue("e","source")}set source(e){this.removeTag("e","source"),this.tag(e,"source",!1,"e")}},registeredEventClasses=new Set;function wrapEvent(t){const e=new Map,r=[...[NDKImage,NDKVideo,NDKCashuMintList$1,NDKArticle,NDKHighlight,NDKDraft,NDKWiki,NDKWikiMergeRequest,NDKNutzap,NDKProject,NDKTask,NDKProjectTemplate,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKSubscriptionTier,NDKSubscriptionStart,NDKSubscriptionReceipt,NDKList,NDKRelayList,NDKStory,NDKBlossomList,NDKFollowPack,NDKThread,NDKRepost,NDKClassified,NDKAppHandlerEvent,NDKDVMJobFeedback,NDKCashuMintAnnouncement,NDKFedimintMint,NDKMintRecommendation],...registeredEventClasses];for(const a of r)for(const o of a.kinds)e.set(o,a);const s=e.get(t.kind);return s?s.from(t):t}function checkMissingKind(t,e){(t.kind===void 0||t.kind===null)&&e("event-missing-kind",`Cannot sign event without 'kind'.

 Event data:
    content: ${t.content?`"${t.content.substring(0,50)}${t.content.length>50?"...":""}"`:"(empty)"}
    tags: ${t.tags.length} tag${t.tags.length!==1?"s":""}
    kind: ${t.kind} 

Set event.kind before signing.`,"Example: event.kind = 1; // for text note",!1)}function checkContentIsObject(t,e){if(typeof t.content=="object"){const n=JSON.stringify(t.content,null,2).substring(0,200);e("event-content-is-object",`Event content is an object. Content must be a string.

 Your content (${typeof t.content}):
${n}${JSON.stringify(t.content).length>200?"...":""}

 event.content = { ... }  // WRONG
 event.content = JSON.stringify({ ... })  // CORRECT`,"Use JSON.stringify() for structured data: event.content = JSON.stringify(data)",!1)}}function checkCreatedAtMilliseconds(t,e){if(t.created_at&&t.created_at>1e10){const n=Math.floor(t.created_at/1e3),r=new Date(t.created_at).toISOString();e("event-created-at-milliseconds",`Event created_at is in milliseconds, not seconds.

 Your value:
    created_at: ${t.created_at} 
    Interpreted as: ${r}
    Should be: ${n} 

Nostr timestamps MUST be in seconds since Unix epoch.`,"Use Math.floor(Date.now() / 1000) instead of Date.now()",!1)}}function checkInvalidPTags(t,e){t.getMatchingTags("p").forEach((r,s)=>{if(r[1]&&!/^[0-9a-f]{64}$/i.test(r[1])){const a=JSON.stringify(r);e("tag-invalid-p-tag",`p-tag[${s}] has invalid pubkey.

 Your tag:
   ${a}

 Invalid value: "${r[1]}"
    Length: ${r[1].length} (expected 64)
    Format: ${r[1].startsWith("npub")?"bech32 (npub)":"unknown"}

p-tags MUST contain 64-character hex pubkeys.`,r[1].startsWith("npub")?`Use ndkUser.pubkey instead of npub:
    event.tags.push(['p', ndkUser.pubkey])
    event.tags.push(['p', 'npub1...'])`:"p-tags must contain valid hex pubkeys (64 characters, 0-9a-f)",!1)}})}function checkInvalidETags(t,e){t.getMatchingTags("e").forEach((r,s)=>{if(r[1]&&!/^[0-9a-f]{64}$/i.test(r[1])){const a=JSON.stringify(r),o=r[1].startsWith("note")||r[1].startsWith("nevent");e("tag-invalid-e-tag",`e-tag[${s}] has invalid event ID.

 Your tag:
   ${a}

 Invalid value: "${r[1]}"
    Length: ${r[1].length} (expected 64)
    Format: ${o?"bech32 (note/nevent)":"unknown"}

e-tags MUST contain 64-character hex event IDs.`,o?`Use event.id instead of bech32:
    event.tags.push(['e', referencedEvent.id])
    event.tags.push(['e', 'note1...'])`:"e-tags must contain valid hex event IDs (64 characters, 0-9a-f)",!1)}})}function checkManualReplyMarkers(t,e,n){if(t.kind!==1||n.has(t))return;const r=t.tags.filter(s=>s[0]==="e"&&(s[3]==="reply"||s[3]==="root"));if(r.length>0){const s=r.map((a,o)=>`   ${o+1}. ${JSON.stringify(a)}`).join(`
`);e("event-manual-reply-markers",`Event has ${r.length} e-tag(s) with manual reply/root markers.

 Your tags with markers:
${s}

  Manual reply markers detected! This will cause incorrect threading.`,`Reply events MUST be created using .reply():

    CORRECT:
   const replyEvent = originalEvent.reply();
   replyEvent.content = 'good point!';
   await replyEvent.publish();

    WRONG:
   event.tags.push(['e', eventId, '', 'reply']);

NDK handles all reply threading automatically - never add reply/root markers manually.`)}}function checkHashtagsWithPrefix(t,e){t.getMatchingTags("t").forEach((r,s)=>{if(r[1]&&r[1].startsWith("#")){const a=JSON.stringify(r);e("tag-hashtag-with-prefix",`t-tag[${s}] contains hashtag with # prefix.

 Your tag:
   ${a}

 Invalid value: "${r[1]}"

Hashtag tags should NOT include the # symbol.`,`Remove the # prefix from hashtag tags:
    event.tags.push(['t', 'nostr'])
    event.tags.push(['t', '#nostr'])`,!1)}})}function checkReplaceableWithOldTimestamp(t,e){if(t.kind===void 0||t.kind===null||!t.created_at||!t.isReplaceable())return;const n=Math.floor(Date.now()/1e3),r=n-t.created_at;if(r>10){const a=Math.floor(r/60),o=a>0?`${a} minute${a!==1?"s":""}`:`${r} seconds`;e("event-replaceable-old-timestamp",`Publishing a replaceable event with an old created_at timestamp.

 Event details:
    kind: ${t.kind} (replaceable)
    created_at: ${t.created_at}
    age: ${o} old
    current time: ${n}

  This is wrong and will be rejected by relays.`,`For replaceable events, use publishReplaceable():

    CORRECT:
   await event.publishReplaceable();
   // Automatically updates created_at to now

    WRONG:
   await event.publish();
   // Uses old created_at`)}}function signing(t,e,n,r){checkMissingKind(t,e),checkContentIsObject(t,e),checkCreatedAtMilliseconds(t,e),checkInvalidPTags(t,e),checkInvalidETags(t,e),checkHashtagsWithPrefix(t,e),checkManualReplyMarkers(t,n,r)}function publishing(t,e){checkReplaceableWithOldTimestamp(t,e)}function isNip33Pattern(t){const e=Array.isArray(t)?t:[t];if(e.length!==1)return!1;const n=e[0];return n.kinds&&Array.isArray(n.kinds)&&n.kinds.length===1&&n.authors&&Array.isArray(n.authors)&&n.authors.length===1&&n["#d"]&&Array.isArray(n["#d"])&&n["#d"].length===1}function isReplaceableEventFilter(t){const e=Array.isArray(t)?t:[t];return e.length===0?!1:e.every(n=>!n.kinds||!Array.isArray(n.kinds)||n.kinds.length===0||!n.authors||!Array.isArray(n.authors)||n.authors.length===0?!1:n.kinds.every(s=>s===0||s===3||s>=1e4&&s<=19999))}function formatFilter(t){return JSON.stringify(t,null,2).split(`
`).map((n,r)=>r===0?n:`   ${n}`).join(`
`)}function fetchingEvents(t,e,n,r,s){if(s(),e?.cacheUsage==="ONLY_CACHE")return;const a=Array.isArray(t)?t:[t],o=a.map(formatFilter).join(`

   ---

   `);if(isNip33Pattern(t))a[0],n("fetch-events-usage",`For fetching a NIP-33 addressable event, use fetchEvent() with the naddr directly.

 Your filter:
   `+o+`

   BAD:  const decoded = nip19.decode(naddr);
           const events = await ndk.fetchEvents({
             kinds: [decoded.data.kind],
             authors: [decoded.data.pubkey],
             "#d": [decoded.data.identifier]
           });
           const event = Array.from(events)[0];

   GOOD: const event = await ndk.fetchEvent(naddr);
   GOOD: const event = await ndk.fetchEvent('naddr1...');

fetchEvent() handles naddr decoding automatically and returns the event directly.`);else{if(isReplaceableEventFilter(t))return;{if(!r())return;let l="";const h=a.some(m=>m.limit!==void 0),y=new Set(a.flatMap(m=>m.kinds||[])).size,p=new Set(a.flatMap(m=>m.authors||[])).size;if(h){const m=Math.max(...a.map(v=>v.limit||0));l+=`
    Limit: ${m} event${m!==1?"s":""}`}y>0&&(l+=`
    Kinds: ${y} type${y!==1?"s":""}`),p>0&&(l+=`
    Authors: ${p} author${p!==1?"s":""}`),n("fetch-events-usage",`fetchEvents() is a BLOCKING operation that waits for EOSE.
In most cases, you should use subscribe() instead.

 Your filter`+(a.length>1?"s":"")+`:
   `+o+(l?`

 Filter analysis:`+l:"")+`

   BAD:  const events = await ndk.fetchEvents(filter);
   GOOD: ndk.subscribe(filter, { onEvent: (e) => ... });

Only use fetchEvents() when you MUST block until data arrives.`,"For one-time queries, use fetchEvent() instead of fetchEvents() when expecting a single result.")}}}var GuardrailCheckId={NDK_NO_CACHE:"ndk-no-cache",FILTER_BECH32_IN_ARRAY:"filter-bech32-in-array",FILTER_INVALID_HEX:"filter-invalid-hex",FILTER_ONLY_LIMIT:"filter-only-limit",FILTER_EMPTY:"filter-empty",FILTER_SINCE_AFTER_UNTIL:"filter-since-after-until",FILTER_INVALID_A_TAG:"filter-invalid-a-tag",FILTER_HASHTAG_WITH_PREFIX:"filter-hashtag-with-prefix"};function checkCachePresence(t,e){e(GuardrailCheckId.NDK_NO_CACHE)&&setTimeout(()=>{if(!t.cacheAdapter){const s=`
 AI_GUARDRAILS WARNING: NDK initialized without a cache adapter. Apps perform significantly better with caching.

 ${typeof window<"u"?"Consider using @nostr-dev-kit/ndk-cache-dexie or @nostr-dev-kit/ndk-cache-sqlite-wasm":"Consider using @nostr-dev-kit/ndk-cache-redis or @nostr-dev-kit/ndk-cache-sqlite"}

 To disable this check:
   ndk.aiGuardrails.skip('${GuardrailCheckId.NDK_NO_CACHE}')
   or set: ndk.aiGuardrails = { skip: new Set(['${GuardrailCheckId.NDK_NO_CACHE}']) }`;console.warn(s)}},2500)}var AIGuardrails=class{enabled=!1;skipSet=new Set;extensions=new Map;_nextCallDisabled=null;_replyEvents=new WeakSet;_fetchEventsCount=0;_subscribeCount=0;constructor(t=!1){this.setMode(t)}register(t,e){this.extensions.has(t)&&console.warn(`AIGuardrails: Extension '${t}' already registered, overwriting`);const n={};for(const[r,s]of Object.entries(e))typeof s=="function"&&(n[r]=(...a)=>{this.enabled&&s(...a,this.shouldCheck.bind(this),this.error.bind(this),this.warn.bind(this))});this.extensions.set(t,n),this[t]=n}setMode(t){typeof t=="boolean"?(this.enabled=t,this.skipSet.clear()):t&&typeof t=="object"&&(this.enabled=!0,this.skipSet=t.skip||new Set)}isEnabled(){return this.enabled}shouldCheck(t){return!(!this.enabled||this.skipSet.has(t)||this._nextCallDisabled==="all"||this._nextCallDisabled&&this._nextCallDisabled.has(t))}skip(t){this.skipSet.add(t)}enable(t){this.skipSet.delete(t)}getSkipped(){return Array.from(this.skipSet)}captureAndClearNextCallDisabled(){const t=this._nextCallDisabled;return this._nextCallDisabled=null,t}incrementFetchEventsCount(){this._fetchEventsCount++}incrementSubscribeCount(){this._subscribeCount++}shouldWarnAboutFetchEventsRatio(){const t=this._fetchEventsCount+this._subscribeCount;return t<=6?!1:this._fetchEventsCount/t>.5}error(t,e,n,r=!0){if(!this.shouldCheck(t))return;const s=this.formatMessage(t,"ERROR",e,n,r);throw console.error(s),new Error(s)}warn(t,e,n){if(!this.shouldCheck(t))return;const r=this.formatMessage(t,"WARNING",e,n,!0);throw console.error(r),new Error(r)}formatMessage(t,e,n,r,s=!0){let a=`
 AI_GUARDRAILS ${e}: ${n}`;return r&&(a+=`

 ${r}`),s&&(a+=`

 To disable this check:
   ndk.guardrailOff('${t}').yourMethod()  // For one call`,a+=`
   ndk.aiGuardrails.skip('${t}')  // Permanently`,a+=`
   or set: ndk.aiGuardrails = { skip: new Set(['${t}']) }`),a}ndkInstantiated(t){this.enabled&&checkCachePresence(t,this.shouldCheck.bind(this))}ndk={fetchingEvents:(t,e)=>{this.enabled&&fetchingEvents(t,e,this.warn.bind(this),this.shouldWarnAboutFetchEventsRatio.bind(this),this.incrementFetchEventsCount.bind(this))}};event={signing:t=>{this.enabled&&signing(t,this.error.bind(this),this.warn.bind(this),this._replyEvents)},publishing:t=>{this.enabled&&publishing(t,this.warn.bind(this))},received:(t,e)=>{this.enabled},creatingReply:t=>{this.enabled&&this._replyEvents.add(t)}};subscription={created:(t,e)=>{this.enabled&&this.incrementSubscribeCount()}};relay={connected:t=>{this.enabled}}};function processFilters(t,e="validate",n,r){if(e==="ignore")return t;const s=[],a=t.map((o,l)=>(r?.aiGuardrails.isEnabled()&&runAIGuardrailsForFilter(o,l,r),processFilter(o,e,l,s,n)));if(e==="validate"&&s.length>0)throw new Error(`Invalid filter(s) detected:
${s.join(`
`)}`);return a}function processFilter(t,e,n,r,s){const a=e==="validate",o=a?t:{...t};if(t.ids){const l=[];t.ids.forEach((h,y)=>{h===void 0?a?r.push(`Filter[${n}].ids[${y}] is undefined`):s?.(`Fixed: Removed undefined value at ids[${y}]`):typeof h!="string"?a?r.push(`Filter[${n}].ids[${y}] is not a string (got ${typeof h})`):s?.(`Fixed: Removed non-string value at ids[${y}] (was ${typeof h})`):isValidHex64(h)?l.push(h):a?r.push(`Filter[${n}].ids[${y}] is not a valid 64-char hex string: "${h}"`):s?.(`Fixed: Removed invalid hex string at ids[${y}]`)}),a||(o.ids=l.length>0?l:void 0)}if(t.authors){const l=[];t.authors.forEach((h,y)=>{h===void 0?a?r.push(`Filter[${n}].authors[${y}] is undefined`):s?.(`Fixed: Removed undefined value at authors[${y}]`):typeof h!="string"?a?r.push(`Filter[${n}].authors[${y}] is not a string (got ${typeof h})`):s?.(`Fixed: Removed non-string value at authors[${y}] (was ${typeof h})`):isValidHex64(h)?l.push(h):a?r.push(`Filter[${n}].authors[${y}] is not a valid 64-char hex pubkey: "${h}"`):s?.(`Fixed: Removed invalid hex pubkey at authors[${y}]`)}),a||(o.authors=l.length>0?l:void 0)}if(t.kinds){const l=[];t.kinds.forEach((h,y)=>{h===void 0?a?r.push(`Filter[${n}].kinds[${y}] is undefined`):s?.(`Fixed: Removed undefined value at kinds[${y}]`):typeof h!="number"?a?r.push(`Filter[${n}].kinds[${y}] is not a number (got ${typeof h})`):s?.(`Fixed: Removed non-number value at kinds[${y}] (was ${typeof h})`):Number.isInteger(h)?h<0||h>65535?a?r.push(`Filter[${n}].kinds[${y}] is out of valid range (0-65535): ${h}`):s?.(`Fixed: Removed out-of-range kind at kinds[${y}]: ${h}`):l.push(h):a?r.push(`Filter[${n}].kinds[${y}] is not an integer: ${h}`):s?.(`Fixed: Removed non-integer value at kinds[${y}]: ${h}`)}),a||(o.kinds=l.length>0?l:void 0)}for(const l in t)if(l.startsWith("#")&&l.length===2){const h=t[l];if(Array.isArray(h)){const y=[];h.forEach((p,m)=>{p===void 0?a?r.push(`Filter[${n}].${l}[${m}] is undefined`):s?.(`Fixed: Removed undefined value at ${l}[${m}]`):typeof p!="string"?a?r.push(`Filter[${n}].${l}[${m}] is not a string (got ${typeof p})`):s?.(`Fixed: Removed non-string value at ${l}[${m}] (was ${typeof p})`):(l==="#e"||l==="#p")&&!isValidHex64(p)?a?r.push(`Filter[${n}].${l}[${m}] is not a valid 64-char hex string: "${p}"`):s?.(`Fixed: Removed invalid hex string at ${l}[${m}]`):y.push(p)}),a||(o[l]=y.length>0?y:void 0)}}return a||Object.keys(o).forEach(l=>{o[l]===void 0&&delete o[l]}),o}function runAIGuardrailsForFilter(t,e,n){const r=n.aiGuardrails,s=JSON.stringify(t,null,2);if(Object.keys(t).length===1&&t.limit!==void 0&&r.error(GuardrailCheckId.FILTER_ONLY_LIMIT,`Filter[${e}] contains only 'limit' without any filtering criteria.

 Your filter:
${s}

  This will fetch random events from relays without any criteria.`,`Add filtering criteria:
    { kinds: [1], limit: 10 }
    { authors: [pubkey], limit: 10 }
    { limit: 10 }`),Object.keys(t).length===0&&r.error(GuardrailCheckId.FILTER_EMPTY,`Filter[${e}] is empty.

 Your filter:
${s}

  This will request ALL events from relays, which is never what you want.`,"Add filtering criteria like 'kinds', 'authors', or tags.",!1),t.since!==void 0&&t.until!==void 0&&t.since>t.until){const o=new Date(t.since*1e3).toISOString(),l=new Date(t.until*1e3).toISOString();r.error(GuardrailCheckId.FILTER_SINCE_AFTER_UNTIL,`Filter[${e}] has 'since' AFTER 'until'.

 Your filter:
${s}

 since: ${t.since} (${o})
 until: ${t.until} (${l})

No events can match this time range!`,"'since' must be BEFORE 'until'. Both are Unix timestamps in seconds.",!1)}const a=/^n(addr|event|ote|pub|profile)1/;t.ids&&t.ids.forEach((o,l)=>{typeof o=="string"&&(a.test(o)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].ids[${l}] contains bech32: "${o}". IDs must be hex, not bech32.`,'Use filterFromId() to decode bech32 first: import { filterFromId } from "@nostr-dev-kit/ndk"',!1):isValidHex64(o)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].ids[${l}] is not a valid 64-char hex string: "${o}"`,`Event IDs must be 64-character hexadecimal strings. Invalid IDs often come from corrupted data in user-generated lists. Always validate hex strings before using them in filters:

   const validIds = ids.filter(id => /^[0-9a-f]{64}$/i.test(id));`,!1))}),t.authors&&t.authors.forEach((o,l)=>{typeof o=="string"&&(a.test(o)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].authors[${l}] contains bech32: "${o}". Authors must be hex pubkeys, not npub.`,"Use ndkUser.pubkey instead. Example: { authors: [ndkUser.pubkey] }",!1):isValidHex64(o)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].authors[${l}] is not a valid 64-char hex pubkey: "${o}"`,`Kind:3 follow lists can contain invalid entries like labels ("Follow List"), partial strings ("highlig"), or other corrupted data. You MUST validate all pubkeys before using them in filters.

   Example:
   const validPubkeys = pubkeys.filter(p => /^[0-9a-f]{64}$/i.test(p));
   ndk.subscribe({ authors: validPubkeys, kinds: [1] });`,!1))});for(const o in t)if(o.startsWith("#")&&o.length===2){const l=t[o];Array.isArray(l)&&l.forEach((h,y)=>{typeof h=="string"&&(o==="#e"||o==="#p")&&(a.test(h)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].${o}[${y}] contains bech32: "${h}". Tag values must be decoded.`,"Use filterFromId() or nip19.decode() to get the hex value first.",!1):isValidHex64(h)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].${o}[${y}] is not a valid 64-char hex string: "${h}"`,`${o==="#e"?"Event IDs":"Public keys"} in tag filters must be 64-character hexadecimal strings. Kind:3 follow lists and other user-generated content can contain invalid data. Always filter before using:

   const validValues = values.filter(v => /^[0-9a-f]{64}$/i.test(v));`,!1))})}t["#a"]&&t["#a"]?.forEach((l,h)=>{if(typeof l=="string")if(!/^\d+:[0-9a-f]{64}:.*$/.test(l))r.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${h}] has invalid format: "${l}". Must be "kind:pubkey:d-tag".`,'Example: "30023:fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52:my-article"',!1);else{const y=Number.parseInt(l.split(":")[0],10);(y<3e4||y>39999)&&r.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${h}] uses non-addressable kind ${y}: "${l}". #a filters are only for addressable events (kinds 30000-39999).`,`Addressable events include:
    30000-30039: Parameterized Replaceable Events (profiles, settings, etc.)
    30040-39999: Other addressable events

For regular events (kind ${y}), use:
    #e filter for specific event IDs
    kinds + authors filters for event queries`,!1)}}),t["#t"]&&t["#t"]?.forEach((l,h)=>{typeof l=="string"&&l.startsWith("#")&&r.error(GuardrailCheckId.FILTER_HASHTAG_WITH_PREFIX,`Filter[${e}].#t[${h}] contains hashtag with # prefix: "${l}". Hashtag values should NOT include the # symbol.`,`Remove the # prefix from hashtag filters:
    { "#t": ["nostr"] }
    { "#t": ["#nostr"] }`,!1)})}function queryFullyFilled(t){return!!(filterIncludesIds(t.filter)&&resultHasAllRequestedIds(t))}function filterIncludesIds(t){return!!t.ids}function resultHasAllRequestedIds(t){const e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}function filterFromId(t){let e;if(t.match(NIP33_A_REGEX)){const[n,r,s]=t.split(":"),a={authors:[r],kinds:[Number.parseInt(n)]};return s&&(a["#d"]=[s]),a}if(t.match(BECH32_REGEX))try{switch(e=nip19_exports$2.decode(t),e.type){case"nevent":{const n={ids:[e.data.id]};return e.data.author&&(n.authors=[e.data.author]),e.data.kind&&(n.kinds=[e.data.kind]),n}case"note":return{ids:[e.data]};case"naddr":{const n={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(n["#d"]=[e.data.identifier]),n}}}catch(n){console.error("Error decoding",t,n)}return{ids:[t]}}function isNip33AValue(t){return t.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(t,e){try{const n=nip19_exports$2.decode(t);if(["naddr","nevent"].includes(n?.type)){const r=n.data;if(r?.relays)return r.relays.map(s=>new NDKRelay$1(s,e.relayAuthDefaultPolicy,e))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"],includeMuted:!1},NDKSubscription=class extends lib$1.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;exclusiveRelay=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;mostRecentCacheEventTimestamp;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;cacheUnconstrainFilter;constructor(t,e,n,r){super(),this.ndk=t,this.opts={...defaultOpts,...n||{}},this.pool=this.opts.pool||t.pool;const s=Array.isArray(e)?e:[e],a=t.filterValidationMode==="validate"?"validate":t.filterValidationMode==="fix"?"fix":"ignore";if(this.filters=processFilters(s,a,t.debug,t),this.filters.length===0)throw new Error("Subscription must have at least one filter");this.subId=r||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.debug=t.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.opts.relaySet?this.relaySet=this.opts.relaySet:this.opts.relayUrls&&(this.relaySet=NDKRelaySet$1.fromRelayUrls(this.opts.relayUrls,this.ndk)),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter,this.exclusiveRelay=this.opts.exclusiveRelay||!1,this.opts.onEvent&&this.on("event",this.opts.onEvent),this.opts.onEose&&this.on("eose",this.opts.onEose),this.opts.onClose&&this.on("close",this.opts.onClose)}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters?.keys()).filter(e=>!this.eosesSeen.has(this.pool.getRelay(e,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts.addSinceFromCache?!0:this.opts?.cacheUsage==="ONLY_RELAY"?!1:(this.filters.some(e=>e.kinds?.some(n=>kindIsEphemeral(n))),!0)}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.addSinceFromCache?!0:!!this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&this.opts.cacheUsage!=="PARALLEL"}start(t=!0){let e;const n=s=>{for(const a of s)a.created_at&&(!this.mostRecentCacheEventTimestamp||a.created_at>this.mostRecentCacheEventTimestamp)&&(this.mostRecentCacheEventTimestamp=a.created_at),this.eventReceived(a,void 0,!0,!1);t||(e=s)},r=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(e=this.startWithCache(),e instanceof Promise?this.shouldWaitForCache()?(e.then(s=>{if(n(s),queryFullyFilled(this)){this.emit("eose",this);return}r()}),null):(e.then(s=>{n(s),this.shouldQueryRelays()||this.emit("eose",this)}),this.shouldQueryRelays()&&r(),null):(n(e),queryFullyFilled(this)?this.emit("eose",this):r(),e)):(r(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{if(this.relayFilters?.has(t.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor).get(t.url)&&(this.relayFilters?.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some(t=>t.authors?.length)}startWithCache(){return this.ndk.cacheAdapter?.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){let t=this.filters;if(this.opts.addSinceFromCache&&this.mostRecentCacheEventTimestamp){const e=this.mostRecentCacheEventTimestamp+1;t=t.map(n=>({...n,since:Math.max(n.since||0,e)}))}if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,t,this.pool,this.opts.relayGoalPerAuthor);else{this.relayFilters=new Map;for(const e of this.relaySet.relays)this.relayFilters.set(e.url,t)}for(const[e,n]of this.relayFilters)this.pool.getRelay(e,!0,!0,n).subscribe(this,n)}refreshRelayConnections(){if(this.relaySet&&this.relaySet.relays.size>0)return;const t=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor);for(const[e,n]of t)this.relayFilters?.has(e)||(this.relayFilters?.set(e,n),this.pool.getRelay(e,!0,!0,n).subscribe(this,n))}eventReceived(t,e,n=!1,r=!1){const s=t.id,a=this.eventFirstSeen.has(s);let o;if(t instanceof NDKEvent$1&&(o=t),a){const l=Date.now()-(this.eventFirstSeen.get(s)||0);if(this.emit("event:dup",t,e,l,this,n,r),this.opts?.onEventDup&&this.opts.onEventDup(t,e,l,this,n,r),!n&&!r&&e&&this.ndk.cacheAdapter?.setEventDup&&!this.opts.dontSaveToCache&&(o??=t instanceof NDKEvent$1?t:new NDKEvent$1(this.ndk,t),this.ndk.cacheAdapter.setEventDup(o,e)),e){const h=verifiedSignatures$1.get(s);if(h&&typeof h=="string")if(t.sig===h)e.addValidatedEvent();else{const y=t instanceof NDKEvent$1?t:new NDKEvent$1(this.ndk,t);this.ndk.reportInvalidSignature(y,e)}}}else{if(o??=new NDKEvent$1(this.ndk,t),o.ndk=this.ndk,o.relay=e,!n&&!r){if(!this.skipValidation&&!o.isValid){this.debug("Event failed validation %s from relay %s",s,e?.url);return}if(e)if(e.shouldValidateEvent()&&!this.skipVerification)if(o.relay=e,this.ndk.asyncSigVerification)o.verifySignature(!0);else{if(!o.verifySignature(!0)){this.debug("Event failed signature validation",t),this.ndk.reportInvalidSignature(o,e);return}e.addValidatedEvent()}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(o,this.filters,e)}if(!this.opts.includeMuted&&this.ndk.muteFilter&&this.ndk.muteFilter(o)){this.debug("Event muted, skipping");return}(!r||this.skipOptimisticPublishEvent!==!0)&&(this.emitEvent(this.opts?.wrap??!1,o,e,n,r),this.eventFirstSeen.set(s,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(t,e,n,r,s){const a=t?wrapEvent(e):e;a instanceof Promise?a.then(o=>this.emitEvent(!1,o,n,r,s)):a&&this.emit("event",a,n,this,r,s)}closedReceived(t,e){this.emit("closed",t,e)}eoseTimeout;eosed=!1;eoseReceived(t){this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const n=this.eosesSeen.size===this.relayFilters?.size,r=queryFullyFilled(this),s=a=>{this.debug("Performing EOSE: %s %d",a,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,this.opts?.closeOnEose&&this.stop())};if(r||n)s("query filled or seen all");else if(this.relayFilters){let a=1e3;const o=new Set(this.pool.connectedRelays().map(y=>y.url)),l=Array.from(this.relayFilters.keys()).filter(y=>o.has(y));if(l.length===0){this.debug("No connected relays, waiting for all relays to connect",Array.from(this.relayFilters.keys()).join(", "));return}const h=this.eosesSeen.size/l.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:h,seen:this.eosesSeen.size,total:l.length}),this.eosesSeen.size>=2&&h>=.5){if(a=a*(1-h),a===0){s("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const y=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,e!==void 0&&e<20?this.eoseTimeout=setTimeout(y,a):s(`send eose timeout: ${a}`)};this.eoseTimeout=setTimeout(y,a)}}}},kindIsEphemeral=t=>t>=2e4&&t<3e4;async function follows$1(t,e,n=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(r){const s=new Set;return r.tags.forEach(a=>{a[0]==="p"&&a[1]&&isValidPubkey(a[1])&&s.add(a[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(s)),[...s].reduce((a,o)=>{const l=new NDKUser$1({pubkey:o});return l.ndk=this.ndk,a.add(l),a},new Set)}return new Set}var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For$1(t,e,n=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter?.loadNip05){const h=await t.cacheAdapter.loadNip05(e);if(h!=="missing"){if(h){const y=new NDKUser$1({pubkey:h.pubkey,relayUrls:h.relays,nip46Urls:h.nip46});return y.ndk=t,y}if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX$1);if(!s)return null;const[a,o="_",l]=s;try{const h=await n(`https://${l}/.well-known/nostr.json?name=${o}`,r),{names:y,relays:p,nip46:m}=parseNIP05Result$1(await h.json()),v=y[o.toLowerCase()];let _=null;return v&&(_={pubkey:v,relays:p?.[v],nip46:m?.[v]}),t?.cacheAdapter?.saveNip05&&t.cacheAdapter.saveNip05(e,_),_}catch(h){return t?.cacheAdapter?.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,h),null}}})}function parseNIP05Result$1(t){const e={names:{}};for(const[n,r]of Object.entries(t.names))typeof n=="string"&&typeof r=="string"&&(e.names[n.toLowerCase()]=r);if(t.relays){e.relays={};for(const[n,r]of Object.entries(t.relays))typeof n=="string"&&Array.isArray(r)&&(e.relays[n]=r.filter(s=>typeof s=="string"))}if(t.nip46){e.nip46={};for(const[n,r]of Object.entries(t.nip46))typeof n=="string"&&Array.isArray(r)&&(e.nip46[n]=r.filter(s=>typeof s=="string"))}return e}function profileFromEvent$1(t){const e={};let n;try{n=JSON.parse(t.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const r of Object.keys(n))switch(r){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.picture=n.picture||n.image,e.image=e.picture;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"website":e.website=n.website;break;default:e[r]=n[r];break}return e.created_at=t.created_at,e}function serializeProfile$1(t){const e={};for(const[n,r]of Object.entries(t))switch(n){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[n]=r;break}return JSON.stringify(e)}var NDKUser$1=class yi{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const n=nip19_exports$2.decode(e.nprofile);n.type==="nprofile"&&(this._pubkey=n.data.pubkey,n.data.relays&&n.data.relays.length>0&&this.relayUrls.push(...n.data.relays))}catch(n){console.error("Failed to decode nprofile",n)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(n=>n.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const n=async o=>{if(!e)return o;let l;const h=new Promise((y,p)=>{l=setTimeout(()=>p(new Error("Timeout")),e)});try{const y=await Promise.race([o,h]);return l&&clearTimeout(l),y}catch(y){if(y instanceof Error&&y.message==="Timeout")try{return await o}catch{return}return}},[r,s]=await Promise.all([n(this.fetchProfile()),n(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),a=new Map;if(s){const o=NDKCashuMintList$1.from(s);o.mints.length>0&&a.set("nip61",{mints:o.mints,relays:o.relays,p2pk:o.p2pk})}if(r){const{lud06:o,lud16:l}=r;a.set("nip57",{lud06:o,lud16:l})}return a}static async fromNip05(e,n,r=!1){if(!n)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const a=await getNip05For$1(n,e,n?.httpFetch,s);if(a){const o=new yi({pubkey:a.pubkey,relayUrls:a.relays,nip46Urls:a.nip46});return o.ndk=n,o}}async fetchProfile(e,n=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let s=null;if(this.ndk.cacheAdapter.fetchProfileSync?s=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(s=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),s)return this.profile=s,s}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=profileFromEvent$1(r),n&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows$1.bind(this);async followSet(e,n,r=3){const s=await this.follows(e,n,r);return new Set(Array.from(s).map(a=>a.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const n=[["p",this.pubkey]];return e&&n[0].push("",e),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent$1(this.ndk,{kind:0,content:serializeProfile$1(this.profile)}).publish()}async follow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=typeof e=="string"?e:e.pubkey;if(Array.from(n).some(l=>typeof l=="string"?l===s:l.pubkey===s))return!1;n.add(e);const o=new NDKEvent$1(this.ndk,{kind:r});for(const l of n)typeof l=="string"?o.tags.push(["p",l]):o.tag(l);return await o.publish(),!0}async unfollow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=typeof e=="string"?e:e.pubkey,a=new Set;let o=!1;for(const h of n)(typeof h=="string"?h:h.pubkey)!==s?a.add(h):o=!0;if(!o)return!1;const l=new NDKEvent$1(this.ndk,{kind:r});for(const h of a)typeof h=="string"?l.tags.push(["p",h]):l.tag(h);return await l.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For$1(this.ndk,e);return n===null?null:n.pubkey===this.pubkey}},signerRegistry$1=new Map;function registerSigner$1(t,e){signerRegistry$1.set(t,e)}var NDKPrivateKeySigner$1=class yn{_user;_privateKey;_pubkey;constructor(e,n){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:s}=nip19_exports$2.decode(e);if(r==="nsec")this._privateKey=s;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=utils$1.hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),n&&(this._user=n.getUser({pubkey:this._pubkey})),this._user??=new NDKUser$1({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return utils$1.bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}encryptToNcryptsec(e,n=16,r=2){if(!this._privateKey)throw new Error("Private key not available");return encrypt$2(this._privateKey,e,n,r)}static generate(){const e=generateSecretKey();return new yn(e)}static fromNcryptsec(e,n,r){const s=decrypt$2(e,n);return new yn(s,r)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&n.push("nip04"),(!e||e==="nip44")&&n.push("nip44"),n}async encrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const s=e.pubkey;if(r==="nip44"){const a=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.encrypt(n,a)}return await nip04_exports.encrypt(this._privateKey,s,n)}async decrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const s=e.pubkey;if(r==="nip44"){const a=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.decrypt(n,a)}return await nip04_exports.decrypt(this._privateKey,s,n)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new yn(r.payload,n)}};registerSigner$1("private-key",NDKPrivateKeySigner$1);function dedup(t,e){return t.created_at>e.created_at?t:e}async function getRelayListForUser(t,e){return(await getRelayListForUsers([t],e)).get(t)}async function getRelayListForUsers(t,e,n=!1,r=1e3,s){const a=e.outboxPool||e.pool,o=new Set;for(const v of a.relays.values())o.add(v);if(s)for(const v of s.values())for(const _ of v){const S=a.getRelay(_,!0,!0);S&&o.add(S)}const l=new Map,h=new Map,y=new NDKRelaySet$1(o,e);if(e.cacheAdapter?.locking&&!n){const v=await e.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(t))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(const _ of v)_.kind===10002&&l.set(_.pubkey,NDKRelayList.from(_));for(const _ of v)if(_.kind===3){if(l.has(_.pubkey))continue;const S=relayListFromKind3(e,_);S&&h.set(_.pubkey,S)}t=t.filter(_=>!l.has(_)&&!h.has(_))}if(t.length===0)return l;const p=new Map,m=new Map;return new Promise(v=>{let _=!1;(async()=>{const T={closeOnEose:!0,pool:a,groupable:!0,subId:"ndk-relay-list-fetch",addSinceFromCache:!0,relaySet:y};y&&(T.relaySet=y),e.subscribe({kinds:[3,10002],authors:t},T,{onEvent:z=>{if(z.kind===10002){const Q=p.get(z.pubkey);if(Q&&Q.created_at>z.created_at)return;p.set(z.pubkey,z)}else if(z.kind===3){const Q=m.get(z.pubkey);if(Q&&Q.created_at>z.created_at)return;m.set(z.pubkey,z)}},onEose:()=>{if(!_){_=!0,e.debug(`[getRelayListForUsers] EOSE - relayListEvents: ${p.size}, contactListEvents: ${m.size}`);for(const z of p.values())l.set(z.pubkey,NDKRelayList.from(z));for(const z of t){if(l.has(z))continue;const Q=m.get(z);if(!Q)continue;const ye=relayListFromKind3(e,Q);ye&&l.set(z,ye)}e.debug(`[getRelayListForUsers] Returning ${l.size} relay lists for ${t.length} pubkeys`),v(l)}}});const k=Array.from(o).some(z=>z.status<=2),O=Array.from(o).some(z=>z.status===4);let q=r;(k||O)&&(q=r+3e3),e.debug(`[getRelayListForUsers] Setting fallback timeout to ${q}ms (disconnected: ${k}, connecting: ${O})`,{pubkeys:t}),setTimeout(()=>{_||(_=!0,e.debug(`[getRelayListForUsers] Timeout reached, returning ${l.size} relay lists`),v(l))},q)})()})}var OutboxItem=class{type;relayUrlScores;readRelays;writeRelays;constructor(t){this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib$1.EventEmitter{data;ndk;debug;constructor(t){super(),this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(t,e=!1){const n=[];for(let r=0;r<t.length;r+=400){const s=t.slice(r,r+400),a=s.map(l=>getKeyFromItem(l)).filter(l=>!this.data.has(l));if(a.length===0)continue;for(const l of a)this.data.set(l,new OutboxItem("user"));const o=new Map;for(const l of s)l instanceof NDKUser$1&&l.relayUrls.length>0&&o.set(l.pubkey,l.relayUrls);n.push(new Promise(l=>{getRelayListForUsers(a,this.ndk,e,1e3,o).then(h=>{this.debug(`Received relay lists for ${h.size} pubkeys out of ${a.length} requested`);for(const[y,p]of h){let m=this.data.get(y);if(m??=new OutboxItem("user"),p){if(m.readRelays=new Set(normalize(p.readRelayUrls)),m.writeRelays=new Set(normalize(p.writeRelayUrls)),this.ndk.relayConnectionFilter){for(const v of m.readRelays)this.ndk.relayConnectionFilter(v)||m.readRelays.delete(v);for(const v of m.writeRelays)this.ndk.relayConnectionFilter(v)||m.writeRelays.delete(v)}this.data.set(y,m),this.emit("user:relay-list-updated",y,m),this.debug(`Adding ${m.readRelays.size} read relays and ${m.writeRelays.size} write relays for ${y}`,p?.rawEvent())}}}).finally(l)}))}return Promise.all(n)}track(t,e,n=!0){const r=getKeyFromItem(t);e??=getTypeFromItem(t);let s=this.data.get(r);return s||(s=new OutboxItem(e),t instanceof NDKUser$1&&this.trackUsers([t])),s}};function getKeyFromItem(t){return t instanceof NDKUser$1?t.pubkey:t}function getTypeFromItem(t){return t instanceof NDKUser$1?"user":"kind"}function correctRelaySet(t,e){const n=e.connectedRelays();if(!Array.from(t.relays).some(s=>n.map(a=>a.url).includes(s.url)))for(const s of n)t.addRelay(s);if(n.length===0)for(const s of e.relays.values())t.addRelay(s);return t}var NDKSubscriptionManager=class{subscriptions;seenEvents=new dist.LRUCache({maxSize:1e4,entryExpirationTimeInMS:5*60*1e3});constructor(){this.subscriptions=new Map}add(t){this.subscriptions.set(t.internalId,t),t.onStopped,t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){const n=this.seenEvents.get(t)||[];n.some(r=>r.url===e.url)||n.push(e),this.seenEvents.set(t,n)}dispatchEvent(t,e,n=!1){e&&this.seenEvent(t.id,e);const r=this.subscriptions.values(),s=[];for(const a of r)matchFilters(a.filters,t)&&s.push(a);for(const a of s){if(a.exclusiveRelay&&a.relaySet){let o=!1;if(n?o=!a.skipOptimisticPublishEvent:e?o=a.relaySet.relays.has(e):o=(this.seenEvents.get(t.id)||[]).some(h=>a.relaySet.relays.has(h)),!o){a.debug.extend("exclusive-relay")("Rejected event %s from %s (relay not in exclusive set)",t.id,e?.url||(n?"optimistic":"cache"));continue}}a.eventReceived(t,e,!1,n)}}},debug6=createDebug2("ndk:active-user");async function getUserRelayList(t){if(!this.autoConnectUserRelays)return;const e=await getRelayListForUser(t.pubkey,this);if(e){for(const n of e.relays){let r=this.pool.relays.get(n);r||(r=new NDKRelay$1(n,this.relayAuthDefaultPolicy,this),this.pool.addRelay(r))}return debug6("Connected to %d user relays",e.relays.length),e}}async function setActiveUser(t){if(!this.autoConnectUserRelays)return;const e=this.outboxPool||this.pool;e.connectedRelays.length>0?await getUserRelayList.call(this,t):e.once("connect",async()=>{await getUserRelayList.call(this,t)})}function getEntity(t){try{const e=nip19_exports$2.decode(t);return e.type==="npub"?npub(this,e.data):e.type==="nprofile"?nprofile(this,e.data):e}catch{return null}}function npub(t,e){return t.getUser({pubkey:e})}function nprofile(t,e){const n=t.getUser({pubkey:e.pubkey});return e.relays&&(n.relayUrls=e.relays),n}function isValidHint(t){if(!t||t==="")return!1;try{return new URL(t),!0}catch{return!1}}async function fetchEventFromTag(t,e,n,r={type:"timeout"}){const s=this.debug.extend("fetch-event-from-tag"),[a,o,l]=t;n={},s("fetching event from tag",t,n,r);const h=getRelaysForSync$1(this,e.pubkey);if(h&&h.size>0){s("fetching event from author relays %o",Array.from(h));const T=NDKRelaySet$1.fromRelayUrls(Array.from(h),this),k=await this.fetchEvent(o,n,T);if(k)return k}else s("no author relays found for %s",e.pubkey,e);const y=calculateRelaySetsFromFilters(this,[{ids:[o]}],this.pool);s("fetching event without relay hint",y);const p=await this.fetchEvent(o,n);if(p)return p;if(l&&l!==""){const T=await this.fetchEvent(o,n,this.pool.getRelay(l,!0,!0,[{ids:[o]}]));if(T)return T}let m;const v=isValidHint(l)?this.pool.getRelay(l,!1,!0,[{ids:[o]}]):void 0,_=new Promise(T=>{this.fetchEvent(o,n,v).then(T)});if(!isValidHint(l)||r.type==="none")return _;const S=new Promise(async T=>{const k=r.relaySet,O=r.timeout??1500,q=new Promise(z=>setTimeout(z,O));if(r.type==="timeout"&&await q,m)T(m);else{s("fallback fetch triggered");const z=await this.fetchEvent(o,n,k);T(z)}});switch(r.type){case"timeout":return Promise.race([_,S]);case"eose":return m=await _,m||S}}var Queue=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(t,e){this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);const e=new Promise((n,r)=>{this.queue.push({...t,func:()=>t.func().then(s=>(n(s),s),s=>{throw r(s),s})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const t=this.queue.shift();!t||this.processing.has(t.id)||(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],NDK=class extends lib$1.EventEmitter{_explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;muteFilter;relayConnectionFilter;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=.1;validationRatioFn;filterValidationMode="validate";subManager;aiGuardrails;_signatureVerificationFunction;_signatureVerificationWorker;signatureVerificationTimeMs=0;publishingFailureHandled=!1;pools=[];relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;_wallet;walletConfig;constructor(t={}){super(),this.debug=t.debug||createDebug2("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager,this.pool=new NDKPool$1(t.explicitRelayUrls||[],this),this.pool.name="Main",this.pool.on("relay:auth",async(e,n)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,n)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel!==!1&&(this.outboxPool=new NDKPool$1(t.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new OutboxTracker(this),this.outboxTracker.on("user:relay-list-updated",(e,n)=>{this.debug(`Outbox relay list updated for ${e}`);for(const r of this.subManager.subscriptions.values())r.filters.some(a=>a.authors?.includes(e))&&typeof r.refreshRelayConnections=="function"&&(this.debug(`Refreshing relay connections for subscription ${r.internalId}`),r.refreshRelayConnections())})),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.muteFilter=t.muteFilter,this.relayConnectionFilter=t.relayConnectionFilter,t.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet$1.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),t.signatureVerificationWorker&&(this.signatureVerificationWorker=t.signatureVerificationWorker),t.signatureVerificationFunction&&(this.signatureVerificationFunction=t.signatureVerificationFunction),this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||.1,this.validationRatioFn=t.validationRatioFn||this.defaultValidationRatioFn,this.filterValidationMode=t.filterValidationMode||"validate",this.aiGuardrails=new AIGuardrails(t.aiGuardrails||!1),this.aiGuardrails.ndkInstantiated(this);try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t.map(normalizeRelayUrl$1),this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this._signatureVerificationWorker=t,t?(signatureVerificationInit(t),this.asyncSigVerification=!0):this.asyncSigVerification=!1}set signatureVerificationFunction(t){this._signatureVerificationFunction=t,this.asyncSigVerification=!!t}get signatureVerificationFunction(){return this._signatureVerificationFunction}addExplicitRelay(t,e,n=!0){let r;return typeof t=="string"?r=new NDKRelay$1(t,e,this):r=t,this.pool.addRelay(r,n),this.explicitRelayUrls?.push(r.url),r}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){const e=this._activeUser?.pubkey!==t?.pubkey;this._activeUser=t,e&&this.emit("activeUser:change",t),t&&e&&setActiveUser.call(this,t)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t?.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(t){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await this._signer.relays?.(this)),this._signer.relays&&(await this._signer.relays(this)).forEach(r=>this.pool.addRelay(r)));const e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.cacheAdapter?.initializeAsync&&e.push(this.cacheAdapter.initializeAsync(this)),Promise.allSettled(e).then(()=>{})}reportInvalidSignature(t,e){this.debug(`Invalid signature detected for event ${t.id}${e?` from relay ${e.url}`:""}`),this.emit("event:invalid-sig",t,e)}defaultValidationRatioFn(t,e,n){if(e<10)return this.initialValidationRatio;const r=Math.min(e/100,1),s=this.initialValidationRatio*(1-r)+this.lowestValidationRatio*r;return Math.max(s,this.lowestValidationRatio)}getUser(t){if(typeof t=="string")if(t.startsWith("npub1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="npub")throw new Error(`Invalid npub: ${t}`);return this.getUser({pubkey:r})}else if(t.startsWith("nprofile1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);return this.getUser({pubkey:r.pubkey,relayUrls:r.relays})}else return this.getUser({pubkey:t});const e=new NDKUser$1(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return NDKUser$1.fromNip05(t,this,e)}async fetchUser(t,e=!1){if(isValidNip05(t))return NDKUser$1.fromNip05(t,this,e);if(t.startsWith("npub1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="npub")throw new Error(`Invalid npub: ${t}`);const s=new NDKUser$1({pubkey:r});return s.ndk=this,s}else if(t.startsWith("nprofile1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);const s=new NDKUser$1({pubkey:r.pubkey,relayUrls:r.relays});return s.ndk=this,s}else{const n=new NDKUser$1({pubkey:t});return n.ndk=this,n}}subscribe(t,e,n=!0,r=!0){let s=e?.relaySet,a=r;n instanceof NDKRelaySet$1?(console.warn("relaySet is deprecated, use opts.relaySet instead. This will be removed in version v2.14.0"),s=n,a=r):(typeof n=="boolean"||typeof n=="object")&&(a=n);let o;const l={relaySet:s,...e};a&&typeof a=="object"&&(a.onEvent&&(l.onEvent=a.onEvent),a.onEose&&(l.onEose=a.onEose),a.onClose&&(l.onClose=a.onClose),a.onEvents&&(o=a.onEvents));const h=new NDKSubscription(this,t,l);this.subManager.add(h),this.aiGuardrails?.subscription?.created(Array.isArray(t)?t:[t],l);const y=h.pool;if(h.relaySet)for(const p of h.relaySet.relays)y.useTemporaryRelay(p,void 0,h.filters);if(this.outboxPool&&h.hasAuthorsFilter()){const p=h.filters.filter(m=>m.authors&&m.authors?.length>0).flatMap(m=>m.authors);this.outboxTracker?.trackUsers(p)}return a&&setTimeout(async()=>{this.cacheAdapter?.initializeAsync&&!this.cacheAdapter.ready&&await this.cacheAdapter.initializeAsync(this);const p=h.start(!o);p&&p.length>0&&o&&o(p)},0),h}fetchEventFromTag=fetchEventFromTag.bind(this);fetchEventSync(t){if(!this.cacheAdapter)throw new Error("Cache adapter not set");let e;typeof t=="string"?e=[filterFromId(t)]:e=t;const n=new NDKSubscription(this,e),r=this.cacheAdapter.query(n);if(r instanceof Promise)throw new Error("Cache adapter is async");return r.map(s=>(s.ndk=this,s))}async fetchEvent(t,e,n){let r,s;if(n instanceof NDKRelay$1?s=new NDKRelaySet$1(new Set([n]),this):n instanceof NDKRelaySet$1&&(s=n),!n&&typeof t=="string"&&!isNip33AValue(t)){const a=relaysFromBech32(t,this);a.length>0&&(s=new NDKRelaySet$1(new Set(a),this),s=correctRelaySet(s,this.pool))}if(typeof t=="string"?r=[filterFromId(t)]:Array.isArray(t)?r=t:r=[t],typeof t!="string"&&this.aiGuardrails?.ndk?.fetchingEvents(r),r.length===0)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise((a,o)=>{let l=null;const h={...e||{},closeOnEose:!0};s&&(h.relaySet=s);const y=setTimeout(()=>{p.stop(),this.aiGuardrails._nextCallDisabled=null,a(l)},1e4),p=this.subscribe(r,h,{onEvent:m=>{m.ndk=this,m.isReplaceable()?(!l||l.created_at<m.created_at)&&(l=m):(clearTimeout(y),this.aiGuardrails._nextCallDisabled=null,a(m))},onEose:()=>{clearTimeout(y),this.aiGuardrails._nextCallDisabled=null,a(l)}})})}async fetchEvents(t,e,n){return this.aiGuardrails?.ndk?.fetchingEvents(t,e),new Promise(r=>{const s=new Map,a={...e||{},closeOnEose:!0};n&&(a.relaySet=n);const o=l=>{let h;l instanceof NDKEvent$1?h=l:h=new NDKEvent$1(void 0,l);const y=h.deduplicationKey(),p=s.get(y);p&&(h=dedup(p,h)),h.ndk=this,s.set(y,h)};this.subscribe(t,{...a,onEvent:o,onEose:()=>{this.aiGuardrails._nextCallDisabled=null,r(new Set(s.values()))}})})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getEntity=getEntity.bind(this);guardrailOff(t){return t?typeof t=="string"?this.aiGuardrails._nextCallDisabled=new Set([t]):this.aiGuardrails._nextCallDisabled=new Set(t):this.aiGuardrails._nextCallDisabled="all",this}set wallet(t){if(!t){this._wallet=void 0,this.walletConfig=void 0;return}this._wallet=t,this.walletConfig??={},this.walletConfig.lnPay=t?.lnPay?.bind(t),this.walletConfig.cashuPay=t?.cashuPay?.bind(t)}get wallet(){return this._wallet}},nip19_exports$1={};__reExport$1(nip19_exports$1,nip19_star);var nip49_exports={};__reExport$1(nip49_exports,nip49_star);function disconnect$1(t,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async n=>{e?.(`Relay ${n.url} requested authentication, disconnecting`),t.removeRelay(n.url)}}async function signAndAuth$1(t,e,n,r,s,a){try{await t.sign(n),s(t)}catch(o){r?.(`Failed to publish auth event to relay ${e.url}`,o),a(t)}}function signIn$1({ndk:t,signer:e,debug:n}={}){return n??=createDebug2("ndk:auth-policies:signIn"),async(r,s)=>{n?.(`Relay ${r.url} requested authentication, signing in`);const a=new NDKEvent$1(t);return a.kind=22242,a.tags=[["relay",r.url],["challenge",s]],e??=t?.signer,new Promise(async(o,l)=>{e?await signAndAuth$1(a,r,e,n,o,l):t?.once("signer:ready",async h=>{await signAndAuth$1(a,r,h,n,o,l)})})}}var NDKRelayAuthPolicies$1={disconnect:disconnect$1,signIn:signIn$1};async function ndkSignerFromPayload$1(t,e){let n;try{n=JSON.parse(t)}catch(s){console.error("Failed to parse signer payload string",t,s);return}if(!n||typeof n.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const r=signerRegistry$1.get(n.type);if(!r)throw new Error(`Unknown signer type: ${n.type}`);try{return await r.fromPayload(t,e)}catch(s){const a=s instanceof Error?s.message:String(s);throw new Error(`Failed to deserialize signer type ${n.type}: ${a}`)}}var NDKNip07Signer$1=class gi{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,n){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=n}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let n;return this.ndk?n=this.ndk.getUser({pubkey:e}):n=new NDKUser$1({pubkey:e}),this._user=n,n}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const n=await window.nostr?.signEvent(e);if(!n)throw new Error("Failed to sign event");return n.sig}async relays(e){await this.waitForExtension();const n=await window.nostr?.getRelays?.()||{},r=[];for(const s of Object.keys(n))n[s].read&&n[s].write&&r.push(s);return r.map(s=>new NDKRelay$1(s,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&window.nostr?.nip04&&n.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&n.push("nip44"),n}async encrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"encrypt",s,n)}async decrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"decrypt",s,n)}async queueEncryption(e,n,r,s){return new Promise((a,o)=>{this.encryptionQueue.push({scheme:e,method:n,counterpartyHexpubkey:r,value:s,resolve:a,reject:o}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,n=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:s,method:a,counterpartyHexpubkey:o,value:l,resolve:h,reject:y}=r;this.debug("Processing encryption queue item",{method:a,counterpartyHexpubkey:o,value:l});try{const p=await window.nostr?.[s]?.[a](o,l);if(!p)throw new Error("Failed to encrypt/decrypt");h(p)}catch(p){const m=p instanceof Error?p.message:String(p);if(m.includes("call already executing")&&n<5){this.debug("Retrying encryption queue item",{method:a,counterpartyHexpubkey:o,value:l,retries:n}),setTimeout(()=>{this.processEncryptionQueue(r,n+1)},50*n);return}y(p instanceof Error?p:new Error(m))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,n)=>{if(window.nostr){e();return}let r;const s=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(s),e())},100);r=setTimeout(()=>{clearInterval(s),n(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new gi(void 0,n)}};registerSigner$1("nip07",NDKNip07Signer$1);var NDKNostrRpc$1=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(e,n,r,s){if(super(),this.ndk=e,this.signer=n,s){this.pool=new NDKPool$1(s,e,{debug:r.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet$1(new Set,e,this.pool);for(const a of s){const o=this.pool.getRelay(a,!1,!1);o.authPolicy=NDKRelayAuthPolicies$1.signIn({ndk:e,signer:n,debug:r}),this.relaySet.addRelay(o),o.connect()}}this.debug=r.extend("rpc")}subscribe(e){return new Promise(n=>{const r=this.ndk.subscribe(e,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet,onEvent:async s=>{try{const a=await this.parseEvent(s);a.method?this.emit("request",a):(this.emit(`response-${a.id}`,a),this.emit("response",a))}catch(a){this.debug("error parsing event",a,s.rawEvent())}},onEose:()=>{this.debug("eosed"),n(r)}})})}async parseEvent(e){this.encryptionType==="nip44"&&e.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!e.content.includes("?iv=")&&(this.encryptionType="nip44");const n=this.ndk.getUser({pubkey:e.pubkey});n.ndk=this.ndk;let r;try{r=await this.signer.decrypt(n,e.content,this.encryptionType)}catch{const m=this.encryptionType==="nip04"?"nip44":"nip04";r=await this.signer.decrypt(n,e.content,m),this.encryptionType=m}const s=JSON.parse(r),{id:a,method:o,params:l,result:h,error:y}=s;return o?{id:a,pubkey:e.pubkey,method:o,params:l,event:e}:{id:a,result:h,error:y,event:e}}async sendResponse(e,n,r,s=24133,a){const o={id:e,result:r};a&&(o.error=a);const l=await this.signer.user(),h=this.ndk.getUser({pubkey:n}),y=new NDKEvent$1(this.ndk,{kind:s,content:JSON.stringify(o),tags:[["p",n]],pubkey:l.pubkey});y.content=await this.signer.encrypt(h,y.content,this.encryptionType),await y.sign(this.signer),await y.publish(this.relaySet)}async sendRequest(e,n,r=[],s=24133,a){const o=Math.random().toString(36).substring(7),l=await this.signer.user(),h=this.ndk.getUser({pubkey:e}),y={id:o,method:n,params:r},p=new Promise(()=>{const v=_=>{_.result==="auth_url"?(this.once(`response-${o}`,v),this.emit("authUrl",_.error)):a&&a(_)};this.once(`response-${o}`,v)}),m=new NDKEvent$1(this.ndk,{kind:s,content:JSON.stringify(y),tags:[["p",e]],pubkey:l.pubkey});return m.content=await this.signer.encrypt(h,m.content,this.encryptionType),await m.sign(this.signer),await m.publish(this.relaySet),p}};function nostrConnectGenerateSecret$1(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri$1(t,e,n,r){const s={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let a=`nostrconnect://${t}?image=${s.image}&url=${s.url}&name=${s.name}&perms=${s.perms}&secret=${encodeURIComponent(e)}`;return n&&(a+=`&relay=${encodeURIComponent(n)}`),a}var NDKNip46Signer$1=class gn extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,n,r,s,a){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=s,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner$1(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner$1.generate(),n===!1||(n?n.startsWith("bunker://")?this.bunkerFlowInit(n):this.nip05Init(n):this.nostrconnectFlowInit(a)),this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,n,r){return new gn(e,n,r)}static nostrconnect(e,n,r,s){return new gn(e,void 0,r,[n],s)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret$1();const n=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri$1(n,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const n=new URL(e),r=n.hostname||n.pathname.replace(/^\/\//,""),s=n.searchParams.get("pubkey"),a=n.searchParams.getAll("relay"),o=n.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=s,this.relayUrls=a,this.secret=o}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,n)=>{const r=s=>{s.result===this.nostrConnectSecret&&(this._user=s.event.author,this.userPubkey=s.event.pubkey,this.bunkerPubkey=s.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser$1.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,n)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,s=>{s.result==="ack"?this.getPublicKey().then(a=>{this.userPubkey=a,this._user=this.ndk.getUser({pubkey:a}),e(this._user)}):n(s.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,n)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,n,r="nip04"){return this.encryption(e,n,r,"encrypt")}async decrypt(e,n,r="nip04"){return this.encryption(e,n,r,"decrypt")}async encryption(e,n,r,s){return new Promise((o,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${s}`,[e.pubkey,n],24133,h=>{h.error?l(h.error):o(h.result)})})}async sign(e){return new Promise((r,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,a=>{if(a.error)s(a.error);else{const o=JSON.parse(a.result);r(o.sig)}})})}async createAccount(e,n,r){await this.startListening();const s=[];return e&&s.push(e),n&&s.push(n),r&&s.push(r),new Promise((a,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",s,24133,l=>{if(l.error)o(l.error);else{const h=l.result;a(h)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,n){if(!n)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const s=r.payload;if(!s||typeof s!="object"||!s.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const a=await ndkSignerFromPayload$1(s.localSignerPayload,n);if(!a)throw new Error("Failed to deserialize local signer for NIP-46");if(!(a instanceof NDKPrivateKeySigner$1))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let o;return o=new gn(n,!1,a,s.relayUrls),o.userPubkey=s.userPubkey,o.bunkerPubkey=s.bunkerPubkey,o.relayUrls=s.relayUrls,o.secret=s.secret,s.userPubkey&&(o._user=new NDKUser$1({pubkey:s.userPubkey}),o._user&&(o._user.ndk=n)),o}};registerSigner$1("nip46",NDKNip46Signer$1);createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");const index=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX,NDKAppHandlerEvent,NDKArticle,NDKBlossomList,NDKCashuMintAnnouncement,NDKCashuMintList:NDKCashuMintList$1,NDKClassified,NDKDVMJobFeedback,NDKDraft,NDKEvent:NDKEvent$1,NDKFedimintMint,NDKFollowPack,NDKHighlight,NDKImage,NDKList,NDKMintRecommendation,NDKNip07Signer:NDKNip07Signer$1,NDKNip46Signer:NDKNip46Signer$1,NDKNostrRpc:NDKNostrRpc$1,NDKNutzap,NDKPool:NDKPool$1,NDKPrivateKeySigner:NDKPrivateKeySigner$1,NDKProject,NDKProjectTemplate,NDKPublishError:NDKPublishError$1,NDKRelay:NDKRelay$1,NDKRelayAuthPolicies:NDKRelayAuthPolicies$1,NDKRelayList,NDKRelaySet:NDKRelaySet$1,NDKRepost,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKStory,NDKStorySticker,NDKSubscription,NDKSubscriptionReceipt,NDKSubscriptionStart,NDKSubscriptionTier,NDKTask,NDKThread,NDKUser:NDKUser$1,NDKVideo,NDKWiki,NDKWikiMergeRequest,NIP33_A_REGEX,calculateRelaySetFromEvent:calculateRelaySetFromEvent$1,default:NDK,defaultOpts,deserialize:deserialize$1,eventHasETagMarkers:eventHasETagMarkers$1,fetchRelayInformation,filterFingerprint:filterFingerprint$1,filterFromId,generateContentTags:generateContentTags$1,generateHashtags:generateHashtags$1,getRelayListForUser,getRelayListForUsers,getReplyTag:getReplyTag$1,getRootTag:getRootTag$1,imetaTagToTag,isNip33AValue,isValidHex64,isValidNip05,isValidPubkey,mapImetaTag,mergeFilters:mergeFilters$1,mergeTags:mergeTags$1,ndkSignerFromPayload:ndkSignerFromPayload$1,newAmount,nip19:nip19_exports$1,nip49:nip49_exports,normalize,normalizeRelayUrl:normalizeRelayUrl$1,normalizeUrl:normalizeUrl$1,parseTagToSubscriptionAmount,possibleIntervalFrequencies,processFilters,profileFromEvent:profileFromEvent$1,queryFullyFilled,registerSigner:registerSigner$1,relayListFromKind3,relaysFromBech32,serialize:serialize$1,serializeProfile:serializeProfile$1,strToDimension,strToPosition,tryNormalizeRelayUrl,wrapEvent},Symbol.toStringTag,{value:"Module"}));var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of __getOwnPropNames(e))!__hasOwnProp.call(t,s)&&s!==n&&__defProp(t,s,{get:()=>e[s],enumerable:!(r=__getOwnPropDesc(e,s))||r.enumerable});return t},__reExport=(t,e,n)=>(__copyProps(t,e,"default"),n);function getRelaysForSync(t,e,n="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);if(r)return n==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync(t,e,n)}function getTopRelaysForAuthors(t,e){const n=new Map;return e.forEach(s=>{const a=getRelaysForSync(t,s);a&&a.forEach(o=>{const l=n.get(o)||0;n.set(o,l+1)})}),Array.from(n.entries()).sort((s,a)=>a[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys(t,e,n="read"){const r=new Map,s=new Set;return e.forEach(a=>{const o=getRelaysForSync(t,a,n);o&&o.size>0?(o.forEach(l=>{(r.get(l)||new Set).add(a)}),r.set(a,o)):s.add(a)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys(t,e,n,{count:r,preferredRelays:s}={}){r??=2,s??=new Set;const a=t.pool,o=a.connectedRelays();o.forEach(v=>{s?.add(v.url)});const l=new Map,{pubkeysToRelays:h,authorsMissingRelays:y}=getAllRelaysForAllPubkeys(t,e,n),p=getTopRelaysForAuthors(t,e),m=(v,_)=>{const S=l.get(_)||[];S.push(v),l.set(_,S)};for(const[v,_]of h.entries()){let S=r;const T=new Set;for(const k of o)_.has(k.url)&&(m(v,k.url),T.add(k.url),S--);for(const k of _)T.has(k)||l.has(k)&&(m(v,k),T.add(k),S--);if(!(S<=0))for(const k of p){if(S<=0)break;T.has(k)||_.has(k)&&(m(v,k),T.add(k),S--)}}for(const v of y)a.permanentAndConnectedRelays().forEach(_=>{const S=l.get(_.url)||[];S.push(v),l.set(_.url,S)});return l}function normalizeRelayUrl(t){let e=normalizeUrl(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(t,e)=>e.some(n=>n instanceof RegExp?n.test(t):n===t),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols.has(e)}catch{return!1}},normalizeDataURL=(t,{stripHash:e})=>{const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);const r=n.groups?.type??"",s=n.groups?.data??"";let a=n.groups?.hash??"";const o=r.split(";");a=e?"":a;let l=!1;o[o.length-1]==="base64"&&(o.pop(),l=!0);const h=o.shift()?.toLowerCase()??"",p=[...o.map(m=>{let[v,_=""]=m.split("=").map(S=>S.trim());return v==="charset"&&(_=_.toLowerCase(),_===DATA_URL_DEFAULT_CHARSET)?"":`${v}${_?`=${_}`:""}`}).filter(Boolean)];return l&&p.push("base64"),(p.length>0||h&&h!==DATA_URL_DEFAULT_MIME_TYPE)&&p.unshift(h),`data:${p.join(";")},${l?s.trim():s}${a?`#${a}`:""}`};function normalizeUrl(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL(t,e);if(hasCustomProtocol(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(t);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const o=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let l=0,h="";for(;;){const p=o.exec(s.pathname);if(!p)break;const m=p[0],v=p.index,_=s.pathname.slice(l,v);h+=_.replace(/\/{2,}/g,"/"),h+=m,l=v+m.length}const y=s.pathname.slice(l,s.pathname.length);h+=y.replace(/\/{2,}/g,"/"),s.pathname=h}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let o=s.pathname.split("/");const l=o[o.length-1];testParameter(l,e.removeDirectoryIndex)&&(o=o.slice(0,-1),s.pathname=`${o.slice(1).join("/")}/`)}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const o of[...s.searchParams.keys()])testParameter(o,e.removeQueryParameters)&&s.searchParams.delete(o);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const o of[...s.searchParams.keys()])testParameter(o,e.keepQueryParameters)||s.searchParams.delete(o);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const a=t;return t=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!a.endsWith("/")&&s.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var NDKRelayKeepalive=class{constructor(t=3e4,e){this.onSilenceDetected=e,this.timeout=t}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=Date.now()-this.lastActivity;if(t>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-t;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function probeRelayConnection(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(n=>{let r=!1;const s=setTimeout(()=>{r||(r=!0,t.send(["CLOSE",e]),n(!1))},5e3),a=()=>{r||(r=!0,clearTimeout(s),t.send(["CLOSE",e]),n(!0))};t.once("message",a),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(t,e){this.ndkRelay=t,this._status=1;const n=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${n}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive(3e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection({send:e=>this.send(JSON.stringify(e)),once:(e,n)=>{const r=s=>{try{const a=JSON.parse(s.data);(a[0]==="EOSE"||a[0]==="EVENT"||a[0]==="NOTICE")&&(n(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const t=Date.now(),e=t-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=t},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{const n=r=>{try{const s=JSON.parse(r.data);(s[0]==="EOSE"||s[0]==="EVENT"||s[0]==="NOTICE")&&(e(),this.ws?.removeEventListener("message",n))}catch{}};this.ws?.addEventListener("message",n)}}).then(t=>{t||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(t,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(n){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,n),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),n}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const e=JSON.parse(t.data),[n,r,...s]=e;switch(n){case"EVENT":{const a=this.openSubs.get(r),o=e[2];if(!a){this.debug(`Received event for unknown subscription ${r}`);return}a.onevent(o);return}case"COUNT":{const a=e[2],o=this.openCountRequests.get(r);o&&(o.resolve(a.count),this.openCountRequests.delete(r));return}case"EOSE":{const a=this.openSubs.get(r);if(!a)return;a.oneose(r);return}case"OK":{const a=e[2],o=e[3],l=this.openEventPublishes.get(r),h=l?.pop();if(!l||!h){this.debug("Received OK for unknown event publish",r);return}a?h.resolve(o):h.reject(new Error(o)),l.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,l);return}case"CLOSED":{const a=this.openSubs.get(r);if(!a)return;a.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":{this.onAuthRequested(e[1]);return}}}catch(e){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${e.message}`,e?.stack);return}}async onAuthRequested(t){const e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let n;try{n=await e(this.ndkRelay,t)}catch(r){this.debug("Authentication policy threw an error",r),n=!1}if(this.debug("Authentication policy returned",!!n),n instanceof NDKEvent||n===!0){n instanceof NDKEvent&&await this.auth(n);const r=async()=>{if(this._status>=5&&this._status<8){const s=new NDKEvent(this.ndk);s.kind=22242,s.tags=[["relay",this.ndkRelay.url],["challenge",t]],await s.sign(),this.auth(s).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(a=>{this._status=6,this.ndkRelay.emit("auth:failed",a),this.debug("Authentication failed",a)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};n===!0&&(this.ndk?.signer?r().catch(s=>{console.error("Error authenticating",s)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",r))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const n=t.reduce((o,l)=>o+l,0)/t.length,r=t.map(o=>(o-n)**2).reduce((o,l)=>o+l,0)/t.length;return Math.sqrt(r)<FLAPPING_THRESHOLD_MS}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const n=[0,1e3,2e3,5e3,1e4,3e4];e=n[Math.min(t,n.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${t}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*Math.pow(2,t),3e4),this.debug(`Using standard backoff, attempt ${t}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(n=>{t<MAX_RECONNECT_ATTEMPTS?this.handleReconnection(t+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(t){const e=new Promise((n,r)=>{const s=this.openEventPublishes.get(t.id)??[];s.push({resolve:n,reject:r}),this.openEventPublishes.set(t.id,s)});return this.send(`["AUTH",${JSON.stringify(t.rawEvent())}]`),e}async publish(t){const e=new Promise((n,r)=>{const s=this.openEventPublishes.get(t.id)??[];s.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${t.id} twice`),s.push({resolve:n,reject:r}),this.openEventPublishes.set(t.id,s)});return this.send(`["EVENT",${JSON.stringify(t)}]`),e}async count(t,e){this.serial++;const n=e?.id||`count:${this.serial}`,r=new Promise((s,a)=>{this.openCountRequests.set(n,{resolve:s,reject:a})});return this.send(`["COUNT","${n}",${JSON.stringify(t).substring(1)}`),r}close(t,e){this.send(`["CLOSE","${t}"]`);const n=this.openSubs.get(t);this.openSubs.delete(t),n&&n.onclose(e)}req(t){`${this.send(`["REQ","${t.subId}",${JSON.stringify(t.executeFilters).substring(1)}`)}`,this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},NDKRelayPublisher=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let n;const r=()=>new Promise((p,m)=>{try{this.publishEvent(t).then(v=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),p(!0)}).catch(m)}catch(v){m(v)}}),s=new Promise((p,m)=>{n=setTimeout(()=>{n=void 0,m(new Error(`Timeout: ${e}ms`))},e)}),a=()=>{r().then(p=>o(p)).catch(p=>l(p))};let o,l;const h=p=>{throw this.ndkRelay.debug("Publish failed",p,t.id),this.ndkRelay.emit("publish:failed",t,p),t.emit("relay:publish:failed",this.ndkRelay,p),p},y=()=>{n&&clearTimeout(n),this.ndkRelay.removeListener("connect",a)};return this.ndkRelay.status>=5?Promise.race([r(),s]).catch(h).finally(y):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((p,m)=>{o=p,l=m,this.ndkRelay.on("connect",a)}),s]).catch(h).finally(y))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function filterFingerprint(t,e){const n=[];for(const s of t){const a=Object.entries(s||{}).map(([o,l])=>["since","until"].includes(o)?`${o}:${l}`:o).sort().join("-");n.push(a)}let r=e?"+":"";return r+=n.join("|"),r}function mergeFilters(t){const e=[],n={};return t.filter(r=>!!r.limit).forEach(r=>e.push(r)),t=t.filter(r=>!r.limit),t.length===0?e:(t.forEach(r=>{Object.entries(r).forEach(([s,a])=>{Array.isArray(a)?n[s]===void 0?n[s]=[...a]:n[s]=Array.from(new Set([...n[s],...a])):n[s]=a})}),[...e,n])}var NDKRelaySubscription=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,n){this.relay=t,this.topSubManager=n,this.debug=t.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:e,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",t,e),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}if(t.filters.find(r=>!!r.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=t.groupableDelay,n=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,n);else{const r=this.delayType,s=this.fireTime-Date.now();if(r==="at-least"&&n==="at-least")s<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-least"&&n==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-most"&&n==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-most"&&n==="at-least")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else throw new Error(`Unknown delay type combination ${r} ${n}`)}}schedule(t,e){this.status=1;const n=Date.now();this.fireTime=n+t,this.delayType=e;const r=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=r)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",t,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:e.filters,internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(e))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(r=>r.filters);if(!e[0])return this.debug(" No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];const n=e[0].length;for(let r=0;r<n;r++){const s=e.map(a=>a[r]);t.push(...mergeFilters(s))}return t}},NDKRelaySubscriptionManager=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let n;if(!t.isGroupable())n=this.createSubscription(t,e);else{const r=filterFingerprint(e,t.closeOnEose);r&&(n=(this.subscriptions.get(r)||[]).find(a=>a.status<3)),n??=this.createSubscription(t,e,r)}n.addItem(t,e)}createSubscription(t,e,n){const r=new NDKRelaySubscription(this.relay,n||null,this.generalSubManager);r.onClose=this.onRelaySubscriptionClose.bind(this);const s=this.subscriptions.get(r.fingerprint)??[];return this.subscriptions.set(r.fingerprint,[...s,r]),r}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?e.length===1?this.subscriptions.delete(t.fingerprint):(e=e.filter(n=>n.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},NDKRelay=class mi extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,n,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let s=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const a=n/100;s=Math.max(e.lowestValidationRatio,e.validationRatio-a)}return s<e.validationRatio?s:e.validationRatio};constructor(e,n,r){super(),this.url=normalizeRelayUrl(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,r.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=n,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??mi.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,n=!0){return this.connectivity.connect(e,n)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,n){this.subs.addSubscription(e,n)}async publish(e,n=2500){return this.publisher.publish(e,n)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close},NDKPublishError=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,n,r){super(t),this.errors=e,this.publishedToRelays=n,this.intendedRelaySet=r}get relayErrors(){const t=[];for(const[e,n]of this.errors)t.push(`${e.url}: ${n}`);return t.join(`
`)}},NDKRelaySet=class bi{relays;debug;ndk;pool;constructor(e,n,r){this.relays=e,this.ndk=n,this.pool=r??n.pool,this.debug=n.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,n,r=!0,s){if(s=s??n.pool,!s)throw new Error("No pool provided");const a=new Set;for(const o of e){const l=s.relays.get(normalizeRelayUrl(o));if(l)l.status<5&&r&&l.connect(),a.add(l);else{const h=new NDKRelay(normalizeRelayUrl(o),n?.relayAuthDefaultPolicy,n);s.useTemporaryRelay(h,void 0,`requested from fromRelayUrls ${e}`),a.add(h)}}return new bi(new Set(a),n,s)}async publish(e,n,r=1){const s=new Set,a=new Map,o=e.isEphemeral();e.publishStatus="pending";const l=h=>{s.add(h)};e.on("relay:published",l);try{const h=Array.from(this.relays).map(y=>new Promise(p=>{const m=n?setTimeout(()=>{s.has(y)||(a.set(y,new Error(`Publish timeout after ${n}ms`)),p(!1))},n):null;y.publish(e,n).then(v=>{m&&clearTimeout(m),v?(s.add(y),p(!0)):p(!1)}).catch(v=>{m&&clearTimeout(m),o||a.set(y,v),p(!1)})}));if(await Promise.all(h),s.size<r){if(!o){const y=new NDKPublishError("Not enough relays received the event ("+s.size+" published, "+r+" required)",a,s,this);throw e.publishStatus="error",e.publishError=y,this.ndk?.emit("event:publish-failed",e,y,this.relayUrls),y}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:s});return s}finally{e.off("relay:published",l)}}get size(){return this.relays.size}},d$1=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent(t,e,n){const r=new Set,s=await getWriteRelaysFor(t,e.pubkey);s&&s.forEach(l=>{const h=t.pool?.getRelay(l);h&&r.add(h)});let a=e.tags.filter(l=>["a","e"].includes(l[0])).map(l=>l[2]).filter(l=>l?.startsWith("wss://")).filter(l=>{try{return new URL(l),!0}catch{return!1}}).map(l=>normalizeRelayUrl(l));a=Array.from(new Set(a)).slice(0,5),a.forEach(l=>{const h=t.pool?.getRelay(l,!0,!0);h&&(d$1("Adding relay hint %s",l),r.add(h))});const o=e.getMatchingTags("p").map(l=>l[1]);return o.length<5?Array.from(chooseRelayCombinationForPubkeys(t,o,"read",{preferredRelays:new Set(s)}).keys()).forEach(h=>{const y=t.pool?.getRelay(h,!1,!0);y&&(d$1("Adding p-tagged relay %s",h),r.add(y))}):d$1("Too many p-tags to consider %d",o.length),t.pool?.permanentAndConnectedRelays().forEach(l=>r.add(l)),n&&r.size<n&&t.explicitRelayUrls?.filter(h=>!Array.from(r).some(y=>y.url===h)).slice(0,n-r.size)?.forEach(h=>{const y=t.pool?.getRelay(h,!1,!0);y&&(d$1("Adding explicit relay %s",h),r.add(y))}),new NDKRelaySet(r,t)}function mergeTags(t,e){const n=new Map,r=o=>o.join(","),s=(o,l)=>o.every((h,y)=>h===l[y]),a=o=>{for(const[l,h]of n)if(s(h,o)||s(o,h)){o.length>=h.length&&n.set(l,o);return}n.set(r(o),o)};return t.concat(e).forEach(a),Array.from(n.values())}var hashtagRegex=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags(t){const e=t.match(hashtagRegex),n=new Set,r=new Set;if(e)for(const s of e)n.has(s.slice(1))||(r.add(s.slice(1)),n.add(s.slice(1)));return Array.from(r)}async function generateContentTags(t,e=[],n,r){if(n?.skipContentTagging)return{content:t,tags:e};const s=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,a=[],o=l=>{e.find(h=>["q",l[0]].includes(h[0])&&h[1]===l[1])||e.push(l)};if(t=t.replace(s,l=>{try{const h=l.split(/(@|nostr:)/)[2],{type:y,data:p}=nip19_exports$2.decode(h);let m;if(n?.filters){const v=!n.filters.includeTypes||n.filters.includeTypes.includes(y),_=n.filters.excludeTypes?.includes(y);if(!v||_)return l}switch(y){case"npub":n?.pTags!==!1&&(m=["p",p]);break;case"nprofile":n?.pTags!==!1&&(m=["p",p.pubkey]);break;case"note":a.push(new Promise(async v=>{const _=await maybeGetEventRelayUrl(h);o(["q",p,_]),v()}));break;case"nevent":a.push(new Promise(async v=>{const{id:_,author:S}=p;let{relays:T}=p;(!T||T.length===0)&&(T=[await maybeGetEventRelayUrl(h)]),o(["q",_,T[0]]),S&&n?.pTags!==!1&&n?.pTagOnQTags!==!1&&o(["p",S]),v()}));break;case"naddr":a.push(new Promise(async v=>{const _=[p.kind,p.pubkey,p.identifier].join(":");let S=p.relays??[];S.length===0&&(S=[await maybeGetEventRelayUrl(h)]),o(["q",_,S[0]]),n?.pTags!==!1&&n?.pTagOnQTags!==!1&&n?.pTagOnATags!==!1&&o(["p",p.pubkey]),v()}));break;default:return l}return m&&o(m),`nostr:${h}`}catch{return l}}),await Promise.all(a),!n?.filters?.excludeTypes?.includes("hashtag")){const l=generateHashtags(t).map(h=>["t",h]);e=mergeTags(e,l)}if(n?.pTags!==!1&&n?.copyPTagsFromTarget&&r){const l=r.getMatchingTags("p");for(const h of l)e.find(y=>y[0]==="p"&&y[1]===h[1])||e.push(h)}return{content:t,tags:e}}async function maybeGetEventRelayUrl(t){return""}async function encrypt(t,e,n="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const a=t||(()=>{const o=this.getMatchingTags("p");if(o.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:o[0][1]})})();if(n==="nip44"&&await isEncryptionEnabled(s,"nip44")&&(r=await s.encrypt(a,this.content,"nip44")),(!r||n==="nip04")&&await isEncryptionEnabled(s,"nip04")&&(r=await s.encrypt(a,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function decrypt(t,e,n){if(this.ndk?.cacheAdapter?.getDecryptedEvent){let l=null;if(typeof this.ndk.cacheAdapter.getDecryptedEvent=="function"&&(l=this.ndk.cacheAdapter.getDecryptedEvent(this.id)),l){this.content=l.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const a=t||this.author;if(!a)throw new Error("No sender provided and no author available");const o=n||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((o==="nip04"||this.kind===4)&&await isEncryptionEnabled(s,"nip04")&&this.content.search("\\?iv=")&&(r=await s.decrypt(a,this.content,"nip04")),!r&&o==="nip44"&&await isEncryptionEnabled(s,"nip44")&&(r=await s.decrypt(a,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this)}async function isEncryptionEnabled(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function eventHasETagMarkers(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag(t,e){e??=t.tagType();const n=t.tags.find(isTagRootTag);if(!n){if(eventHasETagMarkers(t))return;const r=t.getMatchingTags(e);if(r.length<3)return r[0]}return n}var nip22RootTags=new Set(["A","E","I"]),nip22ReplyTags=new Set(["a","e","i"]);function getReplyTag(t,e){if(t.kind===1111){let s;for(const a of t.tags)if(nip22RootTags.has(a[0]))s=a;else if(nip22ReplyTags.has(a[0])){s=a;break}return s}e??=t.tagType();let n=!1,r;for(const s of t.tags)if(s[0]===e){if((s[3]??"").length>0&&(n=!0),n&&s[3]==="reply")return s;n&&s[3]==="root"&&(r=s),n||(r=s)}return r}function isTagRootTag(t){return t[0]==="E"||t[3]==="root"}async function fetchTaggedEvent(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(n.length===0)return;const[r,s,a]=n[0];let o=a!==""?this.ndk.pool.getRelay(a):void 0;return await this.ndk.fetchEvent(s,{},o)}async function fetchRootEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT=2;function encode(t=DEFAULT_RELAY_COUNT){let e=[];return this.onRelays.length>0?e=this.onRelays.map(n=>n.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new NDKEvent(this.ndk,{kind:getKind(this)});return this.isProtected||(n.content=JSON.stringify(this.rawEvent())),n.tag(this),this.kind!==1&&n.tags.push(["k",`${this.kind}`]),e&&await n.sign(e),t&&await n.publish(),n}function getKind(t){return t.kind===1?6:16}function serialize(t=!1,e=!1){const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}function deserialize(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],s=e[7];r&&r.length===128?(n.sig=r,s&&s.length===64&&(n.id=s)):r&&r.length===64&&(n.id=r,s&&s.length===128&&(n.sig=s))}return n}var processingQueue={};async function verifySignatureAsync(t,e,n){const r=t.ndk,s=Date.now();let a;return r.signatureVerificationFunction?(console.log("[NDK-CORE] Using custom signature verification function async"),a=await r.signatureVerificationFunction(t),console.log("Custom signature verification result",t.id,{result:a})):(console.log("Using worker-based signature verification async"),a=await new Promise(o=>{t.serialize();let l=!1;processingQueue[t.id]||(processingQueue[t.id]={event:t,resolves:[],relay:n},l=!0),processingQueue[t.id].resolves.push(o)})),r.signatureVerificationTimeMs+=Date.now()-s,a}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(typeof e[n]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(t){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification)verifySignatureAsync(this,t,this.relay).then(n=>{t&&(this.signatureVerified=n,n&&verifiedSignatures.set(this.id,this.sig)),n||(this.relay?this.ndk?.reportInvalidSignature(this,this.relay):this.ndk?.reportInvalidSignature(this),verifiedSignatures.set(this.id,!1))}).catch(n=>{console.error("signature verification error",this.id,n)});else{const n=sha256_1(new TextEncoder().encode(this.serialize())),r=schnorr.verify(this.sig,n,this.pubkey);return r?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash$1(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(t){const e=sha256_1(new TextEncoder().encode(t));return utils$1.bytesToHex(e)}var skipClientTagOnKinds=new Set([0,4,1059,13,3,9734,5]),NDKEvent=class vt extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,n){super(),this.ndk=e,this.created_at=n?.created_at,this.content=n?.content||"",this.tags=n?.tags||[],this.id=n?.id||"",this.sig=n?.sig,this.pubkey=n?.pubkey||"",this.kind=n?.kind,n instanceof vt&&(this.relay&&(this.relay=n.relay,this.ndk?.subManager.seenEvent(n.id,this.relay)),this.publishStatus=n.publishStatus,this.publishError=n.publishError)}static deserialize(e,n){return new vt(e,deserialize(n))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,n,r){const s=["i"],a=["k"];switch(n){case"url":{const o=new URL(e);o.hash="",s.push(o.toString()),a.push(`${o.protocol}//${o.host}`);break}case"hashtag":s.push(`#${e.toLowerCase()}`),a.push("#");break;case"geohash":s.push(`geo:${e.toLowerCase()}`),a.push("geo");break;case"isbn":s.push(`isbn:${e.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${e}`),a.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${e}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${e}`),a.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${e.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":s.push(`doi:${e.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${n}`)}r&&s.push(r),this.tags.push(s),this.tags.push(a)}tag(e,n,r,s,a){let o=[];if(e.fetchProfile!==void 0){if(s??="p",s==="p"&&a?.pTags===!1)return;const h=[s,e.pubkey];n&&h.push("",n),o.push(h)}else if(e instanceof vt){const h=e;if(r??=h?.pubkey===this.pubkey,o=h.referenceTags(n,r,s,a),a?.pTags!==!1)for(const y of h.getMatchingTags("p"))y[1]!==this.pubkey&&(this.tags.find(p=>p[0]==="p"&&p[1]===y[1])||this.tags.push(["p",y[1]]))}else if(Array.isArray(e))o=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags(this.tags,o)}async toNostrEvent(e,n){if(!e&&this.pubkey===""){const a=await this.ndk?.signer?.user();this.pubkey=a?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags(n);this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize.bind(this);getEventHash=getEventHash$1.bind(this);validate=validate.bind(this);verifySignature=verifySignature.bind(this);isReplaceable=isReplaceable.bind(this);isEphemeral=isEphemeral.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable.bind(this);encode=encode.bind(this);encrypt=encrypt.bind(this);decrypt=decrypt.bind(this);getMatchingTags(e,n){const r=this.tags.filter(s=>s[0]===e);return n===void 0?r:r.filter(s=>s[3]===n)}hasTag(e,n){return this.tags.some(r=>r[0]===e&&(!n||r[3]===n))}tagValue(e,n){const r=this.getMatchingTags(e,n);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,n){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(s=>{const a=r.includes(s[0]),o=n?s[3]===n:!0;return!(a&&o)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,n){e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,n);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,n,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,n,r)}async publish(e,n,r,s){if(r||(r=1),this.sig||await this.sign(void 0,s),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const l=this.getMatchingTags("e").map(h=>h[1]);this.ndk.cacheAdapter.deleteEventIds(l)}const a=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(l){console.error("Error adding unpublished event to cache",l)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(l=>l[1])),this.ndk.subManager.dispatchEvent(a,void 0,!0);const o=await e.publish(this,n,r);return o.forEach(l=>this.ndk?.subManager.seenEvent(this.id,l)),o}async generateTags(e){let n=[];const r=await generateContentTags(this.content,this.tags,e,this),s=r.content;if(n=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const o=this.tagValue("title");let h=[...Array(o?6:16)].map(()=>Math.random().toString(36)[2]).join("");o&&o.length>0&&(h=`${o.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${h}`),n.push(["d",h])}if(this.shouldAddClientTag){const a=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&a.push(this.ndk?.clientNip89),n.push(a)}else this.shouldStripClientTag&&(n=n.filter(a=>a[0]!=="client"));return{content:s||"",tags:n}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds.has(this.kind)}muted(){const e=this.ndk?.mutedIds.get(this.pubkey);if(e&&e==="p")return"author";const n=this.tagReference(),r=this.ndk?.mutedIds.get(n[1]);return r&&r===n[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let n;return this.isParamReplaceable()?n=["a",this.tagAddress()]:n=["e",this.tagId()],this.relay?n.push(this.relay.url):n.push(""),n.push(e??""),this.isParamReplaceable()||n.push(this.pubkey),n}referenceTags(e,n,r,s){let a=[];return this.isParamReplaceable()?a=[[r??"a",this.tagAddress()],[r??"e",this.id]]:a=[[r??"e",this.id]],a=a.map(o=>(o[0]==="e"||e?o.push(this.relay?.url??""):this.relay?.url&&o.push(this.relay?.url),o)),a.forEach(o=>{o[0]==="e"?(o.push(e??""),o.push(this.pubkey)):e&&o.push(e)}),a=[...a,...this.getMatchingTags("h")],!n&&s?.pTags!==!1&&a.push(...this.author.referenceTags()),a}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new vt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),n&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent.bind(this);fetchRootEvent=fetchRootEvent.bind(this);fetchReplyEvent=fetchReplyEvent.bind(this);repost=repost.bind(this);async react(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new vt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),n&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,n){const r=new vt(this.ndk);if(this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,n)]:r.tag(this,"root",!1,void 0,n);else{r.kind=1111;const s=["A","E","I","P"],a=this.tags.filter(o=>s.includes(o[0]));if(a.length>0){const o=this.tagValue("K");r.tags.push(...a),o&&r.tags.push(["K",o]);let l;if(this.isParamReplaceable()){l=["a",this.tagAddress()];const h=this.relay?.url??"";h&&l.push(h)}else{l=["e",this.tagId()];const h=this.relay?.url??"";l.push(h),l.push(this.pubkey)}r.tags.push(l)}else{let o,l;const h=this.relay?.url??"";this.isParamReplaceable()?(o=["a",this.tagAddress(),h],l=["A",this.tagAddress(),h]):(o=["e",this.tagId(),h,this.pubkey],l=["E",this.tagId(),h,this.pubkey]),r.tags.push(o),r.tags.push(l),r.tags.push(["K",this.kind?.toString()]),n?.pTags!==!1&&n?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),n?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent(t){return!untrackedUnpublishedEvents.has(t.kind)}var NDKPool=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;poolBlacklistRelayUrls=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;get blacklistRelayUrls(){const t=new Set(this.ndk.blacklistRelayUrls);return this.poolBlacklistRelayUrls.forEach(e=>t.add(e)),t}constructor(t,e,n,{debug:r,name:s}={}){super(),this.debug=r??n.debug.extend("pool"),s&&(this._name=s),this.ndk=n,this.relayUrls=t,this.poolBlacklistRelayUrls=new Set(e),this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const n=new NDKRelay(e,void 0,this.ndk);n.connectivity.netDebug=this.ndk.netDebug,this.addRelay(n)}}_name="unnamed";get name(){return this._name}set name(t){this._name=t,this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,n){const r=this.relays.has(t.url);r||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,n));const s=this.temporaryRelayTimers.get(t.url);if(s&&clearTimeout(s),!r||s){const a=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,a)}}addRelay(t,e=!0){const n=this.relays.has(t.url),r=this.blacklistRelayUrls?.has(t.url),s=t.url.includes("/npub1");let a=!0;const o=t.url;if(n)return;if(r){this.debug(`Refusing to add relay ${o}: blacklisted`);return}if(s){this.debug(`Refusing to add relay ${o}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const S=this.ndk.cacheAdapter.getRelayStatus(o);if(S?.dontConnectBefore){if(S.dontConnectBefore>Date.now()){const T=S.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${o}: delayed connect for ${T}ms`),setTimeout(()=>{this.addRelay(t,e)},T);return}a=!1}}const l=S=>this.emit("notice",t,S),h=()=>this.handleRelayConnect(o),y=()=>this.handleRelayReady(t),p=()=>{this.recordDisconnection(t),this.emit("relay:disconnect",t)},m=()=>this.handleFlapping(t),v=S=>this.emit("relay:auth",t,S),_=()=>this.emit("relay:authed",t);t.off("notice",l),t.off("connect",h),t.off("ready",y),t.off("disconnect",p),t.off("flapping",m),t.off("auth",v),t.off("authed",_),t.on("notice",l),t.on("connect",h),t.on("ready",y),t.on("disconnect",p),t.on("flapping",m),t.on("auth",v),t.on("authed",_),t.on("delayed-connect",S=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+S})}),this._relays.set(o,t),e&&this.autoConnectRelays.add(o),e&&this.status==="active"&&(this.emit("relay:connecting",t),t.connect(void 0,a).catch(S=>{this.debug(`Failed to connect to relay ${o}`,S)}))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const n=this.temporaryRelayTimers.get(t);return n&&(clearTimeout(n),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=normalizeRelayUrl(t),n=this.relays.get(e);return n?n.status===5:!1}getRelay(t,e=!0,n=!1,r){let s=this.relays.get(normalizeRelayUrl(t));return s||(s=new NDKRelay(t,void 0,this.ndk),s.connectivity.netDebug=this.ndk.netDebug,n?this.useTemporaryRelay(s,3e4,r):this.addRelay(s,e)),s}handleRelayConnect(t){const e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}ms`:""}...`);const e=Array.from(this.autoConnectRelays.keys()).map(a=>this.relays.get(a)).filter(a=>!!a);for(const a of e)a.status!==5&&a.status!==4&&(this.emit("relay:connecting",a),a.connect().catch(o=>{this.debug(`Failed to connect to relay ${a.url}: ${o??"No reason specified"}`)}));const n=()=>e.every(a=>a.status===5),r=new Promise(a=>{if(n()){a();return}const o=[];for(const l of e){const h=()=>{if(n()){for(let y=0;y<e.length;y++)e[y].off("connect",o[y]);a()}};o.push(h),l.on("connect",h)}}),s=typeof t=="number"?new Promise(a=>setTimeout(a,t)):new Promise(()=>{});await Promise.race([r,s])}checkOnFlappingRelays(){const t=this.flappingRelays.size,e=this.relays.size;if(t/e>=.8)for(const n of this.flappingRelays)this.backoffTimes.set(n,0)}recordDisconnection(t){const e=Date.now();this.disconnectionTimes.set(t.url,e);for(const[n,r]of this.disconnectionTimes.entries())e-r>1e4&&this.disconnectionTimes.delete(n);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const t=Date.now(),e=[];for(const n of this.disconnectionTimes.values())t-n<5e3&&e.push(n);e.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${e.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector&&clearTimeout(this.systemEventDetector),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const t of this.relays.values())t.connectivity&&(t.connectivity.resetReconnectionState(),t.status!==5&&t.status!==4&&t.connect().catch(e=>{this.debug(`Failed to reconnect relay ${t.url} after system event: ${e}`)}));this.disconnectionTimes.clear()}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e=e*2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,e.status===5?t.connected++:e.status===1?t.disconnected++:e.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}},NDKCashuMintList=class vi extends NDKEvent{static kind=10019;static kinds=[10019];_p2pk;constructor(e,n){super(e,n),this.kind??=10019}static from(e){return new vi(e.ndk,e)}set relays(e){this.tags=this.tags.filter(n=>n[0]!=="relay");for(const n of e)this.tags.push(["relay",n])}get relays(){const e=[];for(const n of this.tags)n[0]==="relay"&&e.push(n[1]);return e}set mints(e){this.tags=this.tags.filter(n=>n[0]!=="mint");for(const n of e)this.tags.push(["mint",n])}get mints(){const e=[];for(const n of this.tags)n[0]==="mint"&&e.push(n[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}};(class er extends NDKEvent{debug;_proofs=[];static kind=9321;static kinds=[er.kind];constructor(e,n){super(e,n),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(s=>JSON.parse(s[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const n=new er(e.ndk,e);if(!(!n._proofs||!n._proofs.length))return n}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(n=>n[0]!=="proof");for(const n of e)this.tags.push(["proof",JSON.stringify(n)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const n=JSON.parse(e.secret);let r;if(typeof n=="string"?(r=JSON.parse(n),this.debug("stringified payload",e.secret)):typeof n=="object"&&(r=n),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(n){this.debug("error parsing p2pk pubkey",n,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((n,r)=>n+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(n=>n[0]!=="p"),e instanceof NDKEvent&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,n=0,r=0;for(const s of this.tags)s[0]==="e"&&e++,s[0]==="p"&&n++,s[0]==="u"&&r++;return n===1&&r===1&&e<=1&&this.proofs.length>0}});var signerRegistry=new Map;function registerSigner(t,e){signerRegistry.set(t,e)}var NDKPrivateKeySigner=class tr{_user;_privateKey;_pubkey;constructor(e,n){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:s}=nip19_exports$2.decode(e);if(r==="nsec")this._privateKey=s;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=utils$1.hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),n&&(this._user=n.getUser({pubkey:this._pubkey})),this._user??=new NDKUser({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return utils$1.bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}static generate(){const e=generateSecretKey();return new tr(e)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&n.push("nip04"),(!e||e==="nip44")&&n.push("nip44"),n}async encrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const s=e.pubkey;if(r==="nip44"){const a=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.encrypt(n,a)}return await nip04_exports.encrypt(this._privateKey,s,n)}async decrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const s=e.pubkey;if(r==="nip44"){const a=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.decrypt(n,a)}return await nip04_exports.decrypt(this._privateKey,s,n)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new tr(r.payload,n)}};registerSigner("private-key",NDKPrivateKeySigner);async function follows(t,e,n=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(r){const s=new Set;return r.tags.forEach(a=>{a[0]==="p"&&s.add(a[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(s)),[...s].reduce((a,o)=>{const l=new NDKUser({pubkey:o});return l.ndk=this.ndk,a.add(l),a},new Set)}return new Set}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(t,e,n=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter?.loadNip05){const h=await t.cacheAdapter.loadNip05(e);if(h!=="missing"){if(h){const y=new NDKUser({pubkey:h.pubkey,relayUrls:h.relays,nip46Urls:h.nip46});return y.ndk=t,y}if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX);if(!s)return null;const[a,o="_",l]=s;try{const h=await n(`https://${l}/.well-known/nostr.json?name=${o}`,r),{names:y,relays:p,nip46:m}=parseNIP05Result(await h.json()),v=y[o.toLowerCase()];let _=null;return v&&(_={pubkey:v,relays:p?.[v],nip46:m?.[v]}),t?.cacheAdapter?.saveNip05&&t.cacheAdapter.saveNip05(e,_),_}catch(h){return t?.cacheAdapter?.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,h),null}}})}function parseNIP05Result(t){const e={names:{}};for(const[n,r]of Object.entries(t.names))typeof n=="string"&&typeof r=="string"&&(e.names[n.toLowerCase()]=r);if(t.relays){e.relays={};for(const[n,r]of Object.entries(t.relays))typeof n=="string"&&Array.isArray(r)&&(e.relays[n]=r.filter(s=>typeof s=="string"))}if(t.nip46){e.nip46={};for(const[n,r]of Object.entries(t.nip46))typeof n=="string"&&Array.isArray(r)&&(e.nip46[n]=r.filter(s=>typeof s=="string"))}return e}function profileFromEvent(t){const e={};let n;try{n=JSON.parse(t.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const r of Object.keys(n))switch(r){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.picture=n.picture||n.image,e.image=e.picture;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"website":e.website=n.website;break;default:e[r]=n[r];break}return e.created_at=t.created_at,e}function serializeProfile(t){const e={};for(const[n,r]of Object.entries(t))switch(n){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[n]=r;break}return JSON.stringify(e)}var NDKUser=class wi{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const n=nip19_exports$2.decode(e.nprofile);n.type==="nprofile"&&(this._pubkey=n.data.pubkey,n.data.relays&&n.data.relays.length>0&&this.relayUrls.push(...n.data.relays))}catch(n){console.error("Failed to decode nprofile",n)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(n=>n.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const n=async o=>{if(!e)return o;let l;const h=new Promise((y,p)=>{l=setTimeout(()=>p(new Error("Timeout")),e)});try{const y=await Promise.race([o,h]);return l&&clearTimeout(l),y}catch(y){if(y instanceof Error&&y.message==="Timeout")try{return await o}catch{return}return}},[r,s]=await Promise.all([n(this.fetchProfile()),n(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),a=new Map;if(s){const o=NDKCashuMintList.from(s);o.mints.length>0&&a.set("nip61",{mints:o.mints,relays:o.relays,p2pk:o.p2pk})}if(r){const{lud06:o,lud16:l}=r;a.set("nip57",{lud06:o,lud16:l})}return a}static async fromNip05(e,n,r=!1){if(!n)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const a=await getNip05For(n,e,n?.httpFetch,s);if(a){const o=new wi({pubkey:a.pubkey,relayUrls:a.relays,nip46Urls:a.nip46});return o.ndk=n,o}}async fetchProfile(e,n=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let s=null;if(this.ndk.cacheAdapter.fetchProfileSync?s=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(s=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),s)return this.profile=s,s}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=profileFromEvent(r),n&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows.bind(this);async followSet(e,n,r=3){const s=await this.follows(e,n,r);return new Set(Array.from(s).map(a=>a.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const n=[["p",this.pubkey]];return e&&n[0].push("",e),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r)),n.has(e))return!1;n.add(e);const s=new NDKEvent(this.ndk,{kind:r});for(const a of n)s.tag(a);return await s.publish(),!0}async unfollow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=new Set;let a=!1;for(const l of n)l.pubkey!==e.pubkey?s.add(l):a=!0;if(!a)return!1;const o=new NDKEvent(this.ndk,{kind:r});for(const l of s)o.tag(l);return await o.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For(this.ndk,e);return n===null?null:n.pubkey===this.pubkey}};function disconnect(t,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async n=>{e?.(`Relay ${n.url} requested authentication, disconnecting`),t.removeRelay(n.url)}}async function signAndAuth(t,e,n,r,s,a){try{await t.sign(n),s(t)}catch(o){r?.(`Failed to publish auth event to relay ${e.url}`,o),a(t)}}function signIn({ndk:t,signer:e,debug:n}={}){return n??=createDebug2("ndk:auth-policies:signIn"),async(r,s)=>{n?.(`Relay ${r.url} requested authentication, signing in`);const a=new NDKEvent(t);return a.kind=22242,a.tags=[["relay",r.url],["challenge",s]],e??=t?.signer,new Promise(async(o,l)=>{e?await signAndAuth(a,r,e,n,o,l):t?.once("signer:ready",async h=>{await signAndAuth(a,r,h,n,o,l)})})}}var NDKRelayAuthPolicies={disconnect,signIn},NDKNip07Signer=class _i{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,n){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=n}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let n;return this.ndk?n=this.ndk.getUser({pubkey:e}):n=new NDKUser({pubkey:e}),this._user=n,n}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const n=await window.nostr?.signEvent(e);if(!n)throw new Error("Failed to sign event");return n.sig}async relays(e){await this.waitForExtension();const n=await window.nostr?.getRelays?.()||{},r=[];for(const s of Object.keys(n))n[s].read&&n[s].write&&r.push(s);return r.map(s=>new NDKRelay(s,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&window.nostr?.nip04&&n.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&n.push("nip44"),n}async encrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"encrypt",s,n)}async decrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"decrypt",s,n)}async queueEncryption(e,n,r,s){return new Promise((a,o)=>{this.encryptionQueue.push({scheme:e,method:n,counterpartyHexpubkey:r,value:s,resolve:a,reject:o}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,n=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:s,method:a,counterpartyHexpubkey:o,value:l,resolve:h,reject:y}=r;this.debug("Processing encryption queue item",{method:a,counterpartyHexpubkey:o,value:l});try{const p=await window.nostr?.[s]?.[a](o,l);if(!p)throw new Error("Failed to encrypt/decrypt");h(p)}catch(p){const m=p instanceof Error?p.message:String(p);if(m.includes("call already executing")&&n<5){this.debug("Retrying encryption queue item",{method:a,counterpartyHexpubkey:o,value:l,retries:n}),setTimeout(()=>{this.processEncryptionQueue(r,n+1)},50*n);return}y(p instanceof Error?p:new Error(m))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,n)=>{if(window.nostr){e();return}let r;const s=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(s),e())},100);r=setTimeout(()=>{clearInterval(s),n(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new _i(void 0,n)}};registerSigner("nip07",NDKNip07Signer);var NDKNostrRpc=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(t,e,n,r){if(super(),this.ndk=t,this.signer=e,r){this.pool=new NDKPool(r,[],t,{debug:n.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet(new Set,t,this.pool);for(const s of r){const a=this.pool.getRelay(s,!1,!1);a.authPolicy=NDKRelayAuthPolicies.signIn({ndk:t,signer:e,debug:n}),this.relaySet.addRelay(a),a.connect()}}this.debug=n.extend("rpc")}subscribe(t){const e=this.ndk.subscribe(t,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet},!1);return e.on("event",async n=>{try{const r=await this.parseEvent(n);r.method?this.emit("request",r):(this.emit(`response-${r.id}`,r),this.emit("response",r))}catch(r){this.debug("error parsing event",r,n.rawEvent())}}),new Promise(n=>{e.on("eose",()=>{this.debug("eosed"),n(e)}),e.start()})}async parseEvent(t){this.encryptionType==="nip44"&&t.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!t.content.includes("?iv=")&&(this.encryptionType="nip44");const e=this.ndk.getUser({pubkey:t.pubkey});e.ndk=this.ndk;let n;try{n=await this.signer.decrypt(e,t.content,this.encryptionType)}catch{const p=this.encryptionType==="nip04"?"nip44":"nip04";n=await this.signer.decrypt(e,t.content,p),this.encryptionType=p}const r=JSON.parse(n),{id:s,method:a,params:o,result:l,error:h}=r;return a?{id:s,pubkey:t.pubkey,method:a,params:o,event:t}:{id:s,result:l,error:h,event:t}}async sendResponse(t,e,n,r=24133,s){const a={id:t,result:n};s&&(a.error=s);const o=await this.signer.user(),l=this.ndk.getUser({pubkey:e}),h=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(a),tags:[["p",e]],pubkey:o.pubkey});h.content=await this.signer.encrypt(l,h.content,this.encryptionType),await h.sign(this.signer),await h.publish(this.relaySet)}async sendRequest(t,e,n=[],r=24133,s){const a=Math.random().toString(36).substring(7),o=await this.signer.user(),l=this.ndk.getUser({pubkey:t}),h={id:a,method:e,params:n},y=new Promise(()=>{const m=v=>{v.result==="auth_url"?(this.once(`response-${a}`,m),this.emit("authUrl",v.error)):s&&s(v)};this.once(`response-${a}`,m)}),p=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(h),tags:[["p",t]],pubkey:o.pubkey});return p.content=await this.signer.encrypt(l,p.content,this.encryptionType),await p.sign(this.signer),await p.publish(this.relaySet),y}};async function ndkSignerFromPayload(t,e){let n;try{n=JSON.parse(t)}catch(s){console.error("Failed to parse signer payload string",t,s);return}if(!n||typeof n.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const r=signerRegistry.get(n.type);if(!r)throw new Error(`Unknown signer type: ${n.type}`);try{return await r.fromPayload(t,e)}catch(s){const a=s instanceof Error?s.message:String(s);throw new Error(`Failed to deserialize signer type ${n.type}: ${a}`)}}function nostrConnectGenerateSecret(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri(t,e,n,r){const s={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let a=`nostrconnect://${t}?image=${s.image}&url=${s.url}&name=${s.name}&perms=${s.perms}&secret=${encodeURIComponent(e)}`;return n&&(a+=`&relay=${encodeURIComponent(n)}`),a}var NDKNip46Signer=class mn extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,n,r,s,a){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=s,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner.generate(),n===!1||(n?n.startsWith("bunker://")?this.bunkerFlowInit(n):this.nip05Init(n):this.nostrconnectFlowInit(a)),this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,n,r){return new mn(e,n,r)}static nostrconnect(e,n,r,s){return new mn(e,void 0,r,[n],s)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret();const n=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri(n,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const n=new URL(e),r=n.hostname||n.pathname.replace(/^\/\//,""),s=n.searchParams.get("pubkey"),a=n.searchParams.getAll("relay"),o=n.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=s,this.relayUrls=a,this.secret=o}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,n)=>{const r=s=>{s.result===this.nostrConnectSecret&&(this._user=s.event.author,this.userPubkey=s.event.pubkey,this.bunkerPubkey=s.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,n)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,s=>{s.result==="ack"?this.getPublicKey().then(a=>{this.userPubkey=a,this._user=this.ndk.getUser({pubkey:a}),e(this._user)}):n(s.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,n)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,n,r="nip04"){return this.encryption(e,n,r,"encrypt")}async decrypt(e,n,r="nip04"){return this.encryption(e,n,r,"decrypt")}async encryption(e,n,r,s){return new Promise((o,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${s}`,[e.pubkey,n],24133,h=>{h.error?l(h.error):o(h.result)})})}async sign(e){return new Promise((r,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,a=>{if(a.error)s(a.error);else{const o=JSON.parse(a.result);r(o.sig)}})})}async createAccount(e,n,r){await this.startListening();const s=[];return e&&s.push(e),n&&s.push(n),r&&s.push(r),new Promise((a,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",s,24133,l=>{if(l.error)o(l.error);else{const h=l.result;a(h)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,n){if(!n)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const s=r.payload;if(!s||typeof s!="object"||!s.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const a=await ndkSignerFromPayload(s.localSignerPayload,n);if(!a)throw new Error("Failed to deserialize local signer for NIP-46");if(!(a instanceof NDKPrivateKeySigner))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let o;return o=new mn(n,!1,a,s.relayUrls),o.userPubkey=s.userPubkey,o.bunkerPubkey=s.bunkerPubkey,o.relayUrls=s.relayUrls,o.secret=s.secret,s.userPubkey&&(o._user=new NDKUser({pubkey:s.userPubkey}),o._user&&(o._user.ndk=n)),o}};registerSigner("nip46",NDKNip46Signer);createDebug2("ndk:active-user");createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");var nip19_exports={};__reExport(nip19_exports,nip19_star);var dexie_min={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(commonjsGlobal,function(){var n=function(c,u){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(f,g){f.__proto__=g}||function(f,g){for(var b in g)Object.prototype.hasOwnProperty.call(g,b)&&(f[b]=g[b])})(c,u)},r=function(){return(r=Object.assign||function(c){for(var u,f=1,g=arguments.length;f<g;f++)for(var b in u=arguments[f])Object.prototype.hasOwnProperty.call(u,b)&&(c[b]=u[b]);return c}).apply(this,arguments)};function s(c,u,f){for(var g,b=0,w=u.length;b<w;b++)!g&&b in u||((g=g||Array.prototype.slice.call(u,0,b))[b]=u[b]);return c.concat(g||Array.prototype.slice.call(u))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:commonjsGlobal,o=Object.keys,l=Array.isArray;function h(c,u){return typeof u!="object"||o(u).forEach(function(f){c[f]=u[f]}),c}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var y=Object.getPrototypeOf,p={}.hasOwnProperty;function m(c,u){return p.call(c,u)}function v(c,u){typeof u=="function"&&(u=u(y(c))),(typeof Reflect>"u"?o:Reflect.ownKeys)(u).forEach(function(f){S(c,f,u[f])})}var _=Object.defineProperty;function S(c,u,f,g){_(c,u,h(f&&m(f,"get")&&typeof f.get=="function"?{get:f.get,set:f.set,configurable:!0}:{value:f,configurable:!0,writable:!0},g))}function T(c){return{from:function(u){return c.prototype=Object.create(u.prototype),S(c.prototype,"constructor",c),{extend:v.bind(null,c.prototype)}}}}var k=Object.getOwnPropertyDescriptor,O=[].slice;function q(c,u,f){return O.call(c,u,f)}function z(c,u){return u(c)}function Q(c){if(!c)throw new Error("Assertion Failed")}function ye(c){a.setImmediate?setImmediate(c):setTimeout(c,0)}function ie(c,u){if(typeof u=="string"&&m(c,u))return c[u];if(!u)return c;if(typeof u!="string"){for(var f=[],g=0,b=u.length;g<b;++g){var w=ie(c,u[g]);f.push(w)}return f}var E=u.indexOf(".");if(E!==-1){var x=c[u.substr(0,E)];return x==null?void 0:ie(x,u.substr(E+1))}}function te(c,u,f){if(c&&u!==void 0&&!("isFrozen"in Object&&Object.isFrozen(c)))if(typeof u!="string"&&"length"in u){Q(typeof f!="string"&&"length"in f);for(var g=0,b=u.length;g<b;++g)te(c,u[g],f[g])}else{var w,E,x=u.indexOf(".");x!==-1?(w=u.substr(0,x),(E=u.substr(x+1))===""?f===void 0?l(c)&&!isNaN(parseInt(w))?c.splice(w,1):delete c[w]:c[w]=f:te(x=!(x=c[w])||!m(c,w)?c[w]={}:x,E,f)):f===void 0?l(c)&&!isNaN(parseInt(u))?c.splice(u,1):delete c[u]:c[u]=f}}function ae(c){var u,f={};for(u in c)m(c,u)&&(f[u]=c[u]);return f}var ne=[].concat;function me(c){return ne.apply([],c)}var ot="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(me([8,16,32,64].map(function(c){return["Int","Uint","Float"].map(function(u){return u+c+"Array"})}))).filter(function(c){return a[c]}),B=new Set(ot.map(function(c){return a[c]})),F=null;function j(c){return F=new WeakMap,c=function u(f){if(!f||typeof f!="object")return f;var g=F.get(f);if(g)return g;if(l(f)){g=[],F.set(f,g);for(var b=0,w=f.length;b<w;++b)g.push(u(f[b]))}else if(B.has(f.constructor))g=f;else{var E,x=y(f);for(E in g=x===Object.prototype?{}:Object.create(x),F.set(f,g),f)m(f,E)&&(g[E]=u(f[E]))}return g}(c),F=null,c}var H={}.toString;function V(c){return H.call(c).slice(8,-1)}var W=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Z=typeof W=="symbol"?function(c){var u;return c!=null&&(u=c[W])&&u.apply(c)}:function(){return null};function oe(c,u){return u=c.indexOf(u),0<=u&&c.splice(u,1),0<=u}var A={};function J(c){var u,f,g,b;if(arguments.length===1){if(l(c))return c.slice();if(this===A&&typeof c=="string")return[c];if(b=Z(c)){for(f=[];!(g=b.next()).done;)f.push(g.value);return f}if(c==null)return[c];if(typeof(u=c.length)!="number")return[c];for(f=new Array(u);u--;)f[u]=c[u];return f}for(u=arguments.length,f=new Array(u);u--;)f[u]=arguments[u];return f}var X=typeof Symbol<"u"?function(c){return c[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},$t=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],ze=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat($t),de={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ve(c,u){this.name=c,this.message=u}function we(c,u){return c+". Errors: "+Object.keys(u).map(function(f){return u[f].toString()}).filter(function(f,g,b){return b.indexOf(f)===g}).join(`
`)}function $e(c,u,f,g){this.failures=u,this.failedKeys=g,this.successCount=f,this.message=we(c,u)}function Re(c,u){this.name="BulkError",this.failures=Object.keys(u).map(function(f){return u[f]}),this.failuresByPos=u,this.message=we(c,this.failures)}T(ve).from(Error).extend({toString:function(){return this.name+": "+this.message}}),T($e).from(ve),T(Re).from(ve);var De=ze.reduce(function(c,u){return c[u]=u+"Error",c},{}),Ke=ve,pe=ze.reduce(function(c,u){var f=u+"Error";function g(b,w){this.name=f,b?typeof b=="string"?(this.message="".concat(b).concat(w?`
 `+w:""),this.inner=w||null):typeof b=="object"&&(this.message="".concat(b.name," ").concat(b.message),this.inner=b):(this.message=de[u]||f,this.inner=null)}return T(g).from(Ke),c[u]=g,c},{});pe.Syntax=SyntaxError,pe.Type=TypeError,pe.Range=RangeError;var wt=$t.reduce(function(c,u){return c[u+"Error"]=pe[u],c},{}),We=ze.reduce(function(c,u){return["Syntax","Type","Range"].indexOf(u)===-1&&(c[u+"Error"]=pe[u]),c},{});function Te(){}function je(c){return c}function Qe(c,u){return c==null||c===je?u:function(f){return u(c(f))}}function qe(c,u){return function(){c.apply(this,arguments),u.apply(this,arguments)}}function Ei(c,u){return c===Te?u:function(){var f=c.apply(this,arguments);f!==void 0&&(arguments[0]=f);var g=this.onsuccess,b=this.onerror;this.onsuccess=null,this.onerror=null;var w=u.apply(this,arguments);return g&&(this.onsuccess=this.onsuccess?qe(g,this.onsuccess):g),b&&(this.onerror=this.onerror?qe(b,this.onerror):b),w!==void 0?w:f}}function ki(c,u){return c===Te?u:function(){c.apply(this,arguments);var f=this.onsuccess,g=this.onerror;this.onsuccess=this.onerror=null,u.apply(this,arguments),f&&(this.onsuccess=this.onsuccess?qe(f,this.onsuccess):f),g&&(this.onerror=this.onerror?qe(g,this.onerror):g)}}function Si(c,u){return c===Te?u:function(f){var g=c.apply(this,arguments);h(f,g);var b=this.onsuccess,w=this.onerror;return this.onsuccess=null,this.onerror=null,f=u.apply(this,arguments),b&&(this.onsuccess=this.onsuccess?qe(b,this.onsuccess):b),w&&(this.onerror=this.onerror?qe(w,this.onerror):w),g===void 0?f===void 0?void 0:f:h(g,f)}}function Ti(c,u){return c===Te?u:function(){return u.apply(this,arguments)!==!1&&c.apply(this,arguments)}}function bn(c,u){return c===Te?u:function(){var f=c.apply(this,arguments);if(f&&typeof f.then=="function"){for(var g=this,b=arguments.length,w=new Array(b);b--;)w[b]=arguments[b];return f.then(function(){return u.apply(g,w)})}return u.apply(this,arguments)}}We.ModifyError=$e,We.DexieError=ve,We.BulkError=Re;var Ge=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function nr(c){Ge=c}var Nt={},rr=100,ot=typeof Promise>"u"?[]:function(){var c=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[c,y(c),c];var u=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[u,y(u),c]}(),$t=ot[0],ze=ot[1],ot=ot[2],ze=ze&&ze.then,ct=$t&&$t.constructor,vn=!!ot,Ct=function(c,u){Pt.push([c,u]),Ht&&(queueMicrotask(Ai),Ht=!1)},wn=!0,Ht=!0,lt=[],Vt=[],_n=je,et={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Te,pgp:!1,env:{},finalize:Te},be=et,Pt=[],ht=0,zt=[];function fe(c){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var u=this._PSD=be;if(typeof c!="function"){if(c!==Nt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&kn(this,this._value))}this._state=null,this._value=null,++u.ref,function f(g,b){try{b(function(w){if(g._state===null){if(w===g)throw new TypeError("A promise cannot be resolved with itself.");var E=g._lib&&_t();w&&typeof w.then=="function"?f(g,function(x,N){w instanceof fe?w._then(x,N):w.then(x,N)}):(g._state=!0,g._value=w,sr(g)),E&&Et()}},kn.bind(null,g))}catch(w){kn(g,w)}}(this,c)}var En={get:function(){var c=be,u=Gt;function f(g,b){var w=this,E=!c.global&&(c!==be||u!==Gt),x=E&&!nt(),N=new fe(function($,D){Sn(w,new ir(or(g,c,E,x),or(b,c,E,x),$,D,c))});return this._consoleTask&&(N._consoleTask=this._consoleTask),N}return f.prototype=Nt,f},set:function(c){S(this,"then",c&&c.prototype===Nt?En:{get:function(){return c},set:En.set})}};function ir(c,u,f,g,b){this.onFulfilled=typeof c=="function"?c:null,this.onRejected=typeof u=="function"?u:null,this.resolve=f,this.reject=g,this.psd=b}function kn(c,u){var f,g;Vt.push(u),c._state===null&&(f=c._lib&&_t(),u=_n(u),c._state=!1,c._value=u,g=c,lt.some(function(b){return b._value===g._value})||lt.push(g),sr(c),f&&Et())}function sr(c){var u=c._listeners;c._listeners=[];for(var f=0,g=u.length;f<g;++f)Sn(c,u[f]);var b=c._PSD;--b.ref||b.finalize(),ht===0&&(++ht,Ct(function(){--ht==0&&Tn()},[]))}function Sn(c,u){if(c._state!==null){var f=c._state?u.onFulfilled:u.onRejected;if(f===null)return(c._state?u.resolve:u.reject)(c._value);++u.psd.ref,++ht,Ct(xi,[f,c,u])}else c._listeners.push(u)}function xi(c,u,f){try{var g,b=u._value;!u._state&&Vt.length&&(Vt=[]),g=Ge&&u._consoleTask?u._consoleTask.run(function(){return c(b)}):c(b),u._state||Vt.indexOf(b)!==-1||function(w){for(var E=lt.length;E;)if(lt[--E]._value===w._value)return lt.splice(E,1)}(u),f.resolve(g)}catch(w){f.reject(w)}finally{--ht==0&&Tn(),--f.psd.ref||f.psd.finalize()}}function Ai(){dt(et,function(){_t()&&Et()})}function _t(){var c=wn;return Ht=wn=!1,c}function Et(){var c,u,f;do for(;0<Pt.length;)for(c=Pt,Pt=[],f=c.length,u=0;u<f;++u){var g=c[u];g[0].apply(null,g[1])}while(0<Pt.length);Ht=wn=!0}function Tn(){var c=lt;lt=[],c.forEach(function(g){g._PSD.onunhandled.call(null,g._value,g)});for(var u=zt.slice(0),f=u.length;f;)u[--f]()}function jt(c){return new fe(Nt,!1,c)}function Ce(c,u){var f=be;return function(){var g=_t(),b=be;try{return rt(f,!0),c.apply(this,arguments)}catch(w){u&&u(w)}finally{rt(b,!1),g&&Et()}}}v(fe.prototype,{then:En,_then:function(c,u){Sn(this,new ir(null,null,c,u,be))},catch:function(c){if(arguments.length===1)return this.then(null,c);var u=c,f=arguments[1];return typeof u=="function"?this.then(null,function(g){return(g instanceof u?f:jt)(g)}):this.then(null,function(g){return(g&&g.name===u?f:jt)(g)})},finally:function(c){return this.then(function(u){return fe.resolve(c()).then(function(){return u})},function(u){return fe.resolve(c()).then(function(){return jt(u)})})},timeout:function(c,u){var f=this;return c<1/0?new fe(function(g,b){var w=setTimeout(function(){return b(new pe.Timeout(u))},c);f.then(g,b).finally(clearTimeout.bind(null,w))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&S(fe.prototype,Symbol.toStringTag,"Dexie.Promise"),et.env=ar(),v(fe,{all:function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(u,f){c.length===0&&u([]);var g=c.length;c.forEach(function(b,w){return fe.resolve(b).then(function(E){c[w]=E,--g||u(c)},f)})})},resolve:function(c){return c instanceof fe?c:c&&typeof c.then=="function"?new fe(function(u,f){c.then(u,f)}):new fe(Nt,!0,c)},reject:jt,race:function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(u,f){c.map(function(g){return fe.resolve(g).then(u,f)})})},PSD:{get:function(){return be},set:function(c){return be=c}},totalEchoes:{get:function(){return Gt}},newPSD:tt,usePSD:dt,scheduler:{get:function(){return Ct},set:function(c){Ct=c}},rejectionMapper:{get:function(){return _n},set:function(c){_n=c}},follow:function(c,u){return new fe(function(f,g){return tt(function(b,w){var E=be;E.unhandleds=[],E.onunhandled=w,E.finalize=qe(function(){var x,N=this;x=function(){N.unhandleds.length===0?b():w(N.unhandleds[0])},zt.push(function $(){x(),zt.splice(zt.indexOf($),1)}),++ht,Ct(function(){--ht==0&&Tn()},[])},E.finalize),c()},u,f,g)})}}),ct&&(ct.allSettled&&S(fe,"allSettled",function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(u){c.length===0&&u([]);var f=c.length,g=new Array(f);c.forEach(function(b,w){return fe.resolve(b).then(function(E){return g[w]={status:"fulfilled",value:E}},function(E){return g[w]={status:"rejected",reason:E}}).then(function(){return--f||u(g)})})})}),ct.any&&typeof AggregateError<"u"&&S(fe,"any",function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(u,f){c.length===0&&f(new AggregateError([]));var g=c.length,b=new Array(g);c.forEach(function(w,E){return fe.resolve(w).then(function(x){return u(x)},function(x){b[E]=x,--g||f(new AggregateError(b))})})})}),ct.withResolvers&&(fe.withResolvers=ct.withResolvers));var Oe={awaits:0,echoes:0,id:0},Ri=0,Wt=[],qt=0,Gt=0,Ni=0;function tt(c,u,f,g){var b=be,w=Object.create(b);return w.parent=b,w.ref=0,w.global=!1,w.id=++Ni,et.env,w.env=vn?{Promise:fe,PromiseProp:{value:fe,configurable:!0,writable:!0},all:fe.all,race:fe.race,allSettled:fe.allSettled,any:fe.any,resolve:fe.resolve,reject:fe.reject}:{},u&&h(w,u),++b.ref,w.finalize=function(){--this.parent.ref||this.parent.finalize()},g=dt(w,c,f,g),w.ref===0&&w.finalize(),g}function kt(){return Oe.id||(Oe.id=++Ri),++Oe.awaits,Oe.echoes+=rr,Oe.id}function nt(){return!!Oe.awaits&&(--Oe.awaits==0&&(Oe.id=0),Oe.echoes=Oe.awaits*rr,!0)}function Jt(c){return Oe.echoes&&c&&c.constructor===ct?(kt(),c.then(function(u){return nt(),u},function(u){return nt(),Pe(u)})):c}function $i(){var c=Wt[Wt.length-1];Wt.pop(),rt(c,!1)}function rt(c,u){var f,g=be;(u?!Oe.echoes||qt++&&c===be:!qt||--qt&&c===be)||queueMicrotask(u?function(b){++Gt,Oe.echoes&&--Oe.echoes!=0||(Oe.echoes=Oe.awaits=Oe.id=0),Wt.push(be),rt(b,!0)}.bind(null,c):$i),c!==be&&(be=c,g===et&&(et.env=ar()),vn&&(f=et.env.Promise,u=c.env,(g.global||c.global)&&(Object.defineProperty(a,"Promise",u.PromiseProp),f.all=u.all,f.race=u.race,f.resolve=u.resolve,f.reject=u.reject,u.allSettled&&(f.allSettled=u.allSettled),u.any&&(f.any=u.any))))}function ar(){var c=a.Promise;return vn?{Promise:c,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:c.all,race:c.race,allSettled:c.allSettled,any:c.any,resolve:c.resolve,reject:c.reject}:{}}function dt(c,u,f,g,b){var w=be;try{return rt(c,!0),u(f,g,b)}finally{rt(w,!1)}}function or(c,u,f,g){return typeof c!="function"?c:function(){var b=be;f&&kt(),rt(u,!0);try{return c.apply(this,arguments)}finally{rt(b,!1),g&&queueMicrotask(nt)}}}function xn(c){Promise===ct&&Oe.echoes===0?qt===0?c():enqueueNativeMicroTask(c):setTimeout(c,0)}(""+ze).indexOf("[native code]")===-1&&(kt=nt=Te);var Pe=fe.reject,ft="",Ze="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",cr="String expected.",St=[],Yt="__dbnames",An="readonly",Rn="readwrite";function pt(c,u){return c?u?function(){return c.apply(this,arguments)&&u.apply(this,arguments)}:c:u}var lr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Zt(c){return typeof c!="string"||/\./.test(c)?function(u){return u}:function(u){return u[c]===void 0&&c in u&&delete(u=j(u))[c],u}}function ur(){throw pe.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function xe(c,u){try{var f=hr(c),g=hr(u);if(f!==g)return f==="Array"?1:g==="Array"?-1:f==="binary"?1:g==="binary"?-1:f==="string"?1:g==="string"?-1:f==="Date"?1:g!=="Date"?NaN:-1;switch(f){case"number":case"Date":case"string":return u<c?1:c<u?-1:0;case"binary":return function(b,w){for(var E=b.length,x=w.length,N=E<x?E:x,$=0;$<N;++$)if(b[$]!==w[$])return b[$]<w[$]?-1:1;return E===x?0:E<x?-1:1}(dr(c),dr(u));case"Array":return function(b,w){for(var E=b.length,x=w.length,N=E<x?E:x,$=0;$<N;++$){var D=xe(b[$],w[$]);if(D!==0)return D}return E===x?0:E<x?-1:1}(c,u)}}catch{}return NaN}function hr(c){var u=typeof c;return u!="object"?u:ArrayBuffer.isView(c)?"binary":(c=V(c),c==="ArrayBuffer"?"binary":c)}function dr(c){return c instanceof Uint8Array?c:ArrayBuffer.isView(c)?new Uint8Array(c.buffer,c.byteOffset,c.byteLength):new Uint8Array(c)}function Xt(c,u,f){var g=c.schema.yProps;return g?(u&&0<f.numFailures&&(u=u.filter(function(b,w){return!f.failures[w]})),Promise.all(g.map(function(b){return b=b.updatesTable,u?c.db.table(b).where("k").anyOf(u).delete():c.db.table(b).clear()})).then(function(){return f})):f}var It=(fr.prototype.execute=function(c){var u=this["@@propmod"];if(u.add!==void 0){var f=u.add;if(l(f))return s(s([],l(c)?c:[],!0),f).sort();if(typeof f=="number")return(Number(c)||0)+f;if(typeof f=="bigint")try{return BigInt(c)+f}catch{return BigInt(0)+f}throw new TypeError("Invalid term ".concat(f))}if(u.remove!==void 0){var g=u.remove;if(l(g))return l(c)?c.filter(function(b){return!g.includes(b)}).sort():[];if(typeof g=="number")return Number(c)-g;if(typeof g=="bigint")try{return BigInt(c)-g}catch{return BigInt(0)-g}throw new TypeError("Invalid subtrahend ".concat(g))}return f=(f=u.replacePrefix)===null||f===void 0?void 0:f[0],f&&typeof c=="string"&&c.startsWith(f)?u.replacePrefix[1]+c.substring(f.length):c},fr);function fr(c){this["@@propmod"]=c}function pr(c,u){for(var f=o(u),g=f.length,b=!1,w=0;w<g;++w){var E=f[w],x=u[E],N=ie(c,E);x instanceof It?(te(c,E,x.execute(N)),b=!0):N!==x&&(te(c,E,x),b=!0)}return b}var yr=(Ne.prototype._trans=function(c,u,f){var g=this._tx||be.trans,b=this.name,w=Ge&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(c==="readonly"?"read":"write"," ").concat(this.name));function E($,D,R){if(!R.schema[b])throw new pe.NotFound("Table "+b+" not part of transaction");return u(R.idbtrans,R)}var x=_t();try{var N=g&&g.db._novip===this.db._novip?g===be.trans?g._promise(c,E,f):tt(function(){return g._promise(c,E,f)},{trans:g,transless:be.transless||be}):function $(D,R,U,C){if(D.idbdb&&(D._state.openComplete||be.letThrough||D._vip)){var P=D._createTransaction(R,U,D._dbSchema);try{P.create(),D._state.PR1398_maxLoop=3}catch(I){return I.name===De.InvalidState&&D.isOpen()&&0<--D._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),D.close({disableAutoOpen:!1}),D.open().then(function(){return $(D,R,U,C)})):Pe(I)}return P._promise(R,function(I,K){return tt(function(){return be.trans=P,C(I,K,P)})}).then(function(I){if(R==="readwrite")try{P.idbtrans.commit()}catch{}return R==="readonly"?I:P._completion.then(function(){return I})})}if(D._state.openComplete)return Pe(new pe.DatabaseClosed(D._state.dbOpenError));if(!D._state.isBeingOpened){if(!D._state.autoOpen)return Pe(new pe.DatabaseClosed);D.open().catch(Te)}return D._state.dbReadyPromise.then(function(){return $(D,R,U,C)})}(this.db,c,[this.name],E);return w&&(N._consoleTask=w,N=N.catch(function($){return console.trace($),Pe($)})),N}finally{x&&Et()}},Ne.prototype.get=function(c,u){var f=this;return c&&c.constructor===Object?this.where(c).first(u):c==null?Pe(new pe.Type("Invalid argument to Table.get()")):this._trans("readonly",function(g){return f.core.get({trans:g,key:c}).then(function(b){return f.hook.reading.fire(b)})}).then(u)},Ne.prototype.where=function(c){if(typeof c=="string")return new this.db.WhereClause(this,c);if(l(c))return new this.db.WhereClause(this,"[".concat(c.join("+"),"]"));var u=o(c);if(u.length===1)return this.where(u[0]).equals(c[u[0]]);var f=this.schema.indexes.concat(this.schema.primKey).filter(function(x){if(x.compound&&u.every(function($){return 0<=x.keyPath.indexOf($)})){for(var N=0;N<u.length;++N)if(u.indexOf(x.keyPath[N])===-1)return!1;return!0}return!1}).sort(function(x,N){return x.keyPath.length-N.keyPath.length})[0];if(f&&this.db._maxKey!==ft){var w=f.keyPath.slice(0,u.length);return this.where(w).equals(w.map(function(N){return c[N]}))}!f&&Ge&&console.warn("The query ".concat(JSON.stringify(c)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(u.join("+"),"]"));var g=this.schema.idxByName;function b(x,N){return xe(x,N)===0}var E=u.reduce(function(R,N){var $=R[0],D=R[1],R=g[N],U=c[N];return[$||R,$||!R?pt(D,R&&R.multi?function(C){return C=ie(C,N),l(C)&&C.some(function(P){return b(U,P)})}:function(C){return b(U,ie(C,N))}):D]},[null,null]),w=E[0],E=E[1];return w?this.where(w.name).equals(c[w.keyPath]).filter(E):f?this.filter(E):this.where(u).equals("")},Ne.prototype.filter=function(c){return this.toCollection().and(c)},Ne.prototype.count=function(c){return this.toCollection().count(c)},Ne.prototype.offset=function(c){return this.toCollection().offset(c)},Ne.prototype.limit=function(c){return this.toCollection().limit(c)},Ne.prototype.each=function(c){return this.toCollection().each(c)},Ne.prototype.toArray=function(c){return this.toCollection().toArray(c)},Ne.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Ne.prototype.orderBy=function(c){return new this.db.Collection(new this.db.WhereClause(this,l(c)?"[".concat(c.join("+"),"]"):c))},Ne.prototype.reverse=function(){return this.toCollection().reverse()},Ne.prototype.mapToClass=function(c){var u,f=this.db,g=this.name;function b(){return u!==null&&u.apply(this,arguments)||this}(this.schema.mappedClass=c).prototype instanceof ur&&(function(N,$){if(typeof $!="function"&&$!==null)throw new TypeError("Class extends value "+String($)+" is not a constructor or null");function D(){this.constructor=N}n(N,$),N.prototype=$===null?Object.create($):(D.prototype=$.prototype,new D)}(b,u=c),Object.defineProperty(b.prototype,"db",{get:function(){return f},enumerable:!1,configurable:!0}),b.prototype.table=function(){return g},c=b);for(var w=new Set,E=c.prototype;E;E=y(E))Object.getOwnPropertyNames(E).forEach(function(N){return w.add(N)});function x(N){if(!N)return N;var $,D=Object.create(c.prototype);for($ in N)if(!w.has($))try{D[$]=N[$]}catch{}return D}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=x,this.hook("reading",x),c},Ne.prototype.defineClass=function(){return this.mapToClass(function(c){h(this,c)})},Ne.prototype.add=function(c,u){var f=this,g=this.schema.primKey,b=g.auto,w=g.keyPath,E=c;return w&&b&&(E=Zt(w)(c)),this._trans("readwrite",function(x){return f.core.mutate({trans:x,type:"add",keys:u!=null?[u]:null,values:[E]})}).then(function(x){return x.numFailures?fe.reject(x.failures[0]):x.lastResult}).then(function(x){if(w)try{te(c,w,x)}catch{}return x})},Ne.prototype.upsert=function(c,u){var f=this,g=this.schema.primKey.keyPath;return this._trans("readwrite",function(b){return f.core.get({trans:b,key:c}).then(function(w){var E=w??{};return pr(E,u),g&&te(E,g,c),f.core.mutate({trans:b,type:"put",values:[E],keys:[c],upsert:!0,updates:{keys:[c],changeSpecs:[u]}}).then(function(x){return x.numFailures?fe.reject(x.failures[0]):!!w})})})},Ne.prototype.update=function(c,u){return typeof c!="object"||l(c)?this.where(":id").equals(c).modify(u):(c=ie(c,this.schema.primKey.keyPath),c===void 0?Pe(new pe.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(c).modify(u))},Ne.prototype.put=function(c,u){var f=this,g=this.schema.primKey,b=g.auto,w=g.keyPath,E=c;return w&&b&&(E=Zt(w)(c)),this._trans("readwrite",function(x){return f.core.mutate({trans:x,type:"put",values:[E],keys:u!=null?[u]:null})}).then(function(x){return x.numFailures?fe.reject(x.failures[0]):x.lastResult}).then(function(x){if(w)try{te(c,w,x)}catch{}return x})},Ne.prototype.delete=function(c){var u=this;return this._trans("readwrite",function(f){return u.core.mutate({trans:f,type:"delete",keys:[c]}).then(function(g){return Xt(u,[c],g)}).then(function(g){return g.numFailures?fe.reject(g.failures[0]):void 0})})},Ne.prototype.clear=function(){var c=this;return this._trans("readwrite",function(u){return c.core.mutate({trans:u,type:"deleteRange",range:lr}).then(function(f){return Xt(c,null,f)})}).then(function(u){return u.numFailures?fe.reject(u.failures[0]):void 0})},Ne.prototype.bulkGet=function(c){var u=this;return this._trans("readonly",function(f){return u.core.getMany({keys:c,trans:f}).then(function(g){return g.map(function(b){return u.hook.reading.fire(b)})})})},Ne.prototype.bulkAdd=function(c,u,f){var g=this,b=Array.isArray(u)?u:void 0,w=(f=f||(b?void 0:u))?f.allKeys:void 0;return this._trans("readwrite",function(E){var $=g.schema.primKey,x=$.auto,$=$.keyPath;if($&&b)throw new pe.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(b&&b.length!==c.length)throw new pe.InvalidArgument("Arguments objects and keys must have the same length");var N=c.length,$=$&&x?c.map(Zt($)):c;return g.core.mutate({trans:E,type:"add",keys:b,values:$,wantResults:w}).then(function(P){var R=P.numFailures,U=P.results,C=P.lastResult,P=P.failures;if(R===0)return w?U:C;throw new Re("".concat(g.name,".bulkAdd(): ").concat(R," of ").concat(N," operations failed"),P)})})},Ne.prototype.bulkPut=function(c,u,f){var g=this,b=Array.isArray(u)?u:void 0,w=(f=f||(b?void 0:u))?f.allKeys:void 0;return this._trans("readwrite",function(E){var $=g.schema.primKey,x=$.auto,$=$.keyPath;if($&&b)throw new pe.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(b&&b.length!==c.length)throw new pe.InvalidArgument("Arguments objects and keys must have the same length");var N=c.length,$=$&&x?c.map(Zt($)):c;return g.core.mutate({trans:E,type:"put",keys:b,values:$,wantResults:w}).then(function(P){var R=P.numFailures,U=P.results,C=P.lastResult,P=P.failures;if(R===0)return w?U:C;throw new Re("".concat(g.name,".bulkPut(): ").concat(R," of ").concat(N," operations failed"),P)})})},Ne.prototype.bulkUpdate=function(c){var u=this,f=this.core,g=c.map(function(E){return E.key}),b=c.map(function(E){return E.changes}),w=[];return this._trans("readwrite",function(E){return f.getMany({trans:E,keys:g,cache:"clone"}).then(function(x){var N=[],$=[];c.forEach(function(R,U){var C=R.key,P=R.changes,I=x[U];if(I){for(var K=0,L=Object.keys(P);K<L.length;K++){var M=L[K],G=P[M];if(M===u.schema.primKey.keyPath){if(xe(G,C)!==0)throw new pe.Constraint("Cannot update primary key in bulkUpdate()")}else te(I,M,G)}w.push(U),N.push(C),$.push(I)}});var D=N.length;return f.mutate({trans:E,type:"put",keys:N,values:$,updates:{keys:g,changeSpecs:b}}).then(function(R){var U=R.numFailures,C=R.failures;if(U===0)return D;for(var P=0,I=Object.keys(C);P<I.length;P++){var K,L=I[P],M=w[Number(L)];M!=null&&(K=C[L],delete C[L],C[M]=K)}throw new Re("".concat(u.name,".bulkUpdate(): ").concat(U," of ").concat(D," operations failed"),C)})})})},Ne.prototype.bulkDelete=function(c){var u=this,f=c.length;return this._trans("readwrite",function(g){return u.core.mutate({trans:g,type:"delete",keys:c}).then(function(b){return Xt(u,c,b)})}).then(function(E){var b=E.numFailures,w=E.lastResult,E=E.failures;if(b===0)return w;throw new Re("".concat(u.name,".bulkDelete(): ").concat(b," of ").concat(f," operations failed"),E)})},Ne);function Ne(){}function Dt(c){function u(E,x){if(x){for(var N=arguments.length,$=new Array(N-1);--N;)$[N-1]=arguments[N];return f[E].subscribe.apply(null,$),c}if(typeof E=="string")return f[E]}var f={};u.addEventType=w;for(var g=1,b=arguments.length;g<b;++g)w(arguments[g]);return u;function w(E,x,N){if(typeof E!="object"){var $;x=x||Ti;var D={subscribers:[],fire:N=N||Te,subscribe:function(R){D.subscribers.indexOf(R)===-1&&(D.subscribers.push(R),D.fire=x(D.fire,R))},unsubscribe:function(R){D.subscribers=D.subscribers.filter(function(U){return U!==R}),D.fire=D.subscribers.reduce(x,N)}};return f[E]=u[E]=D}o($=E).forEach(function(R){var U=$[R];if(l(U))w(R,$[R][0],$[R][1]);else{if(U!=="asap")throw new pe.InvalidArgument("Invalid event config");var C=w(R,je,function(){for(var P=arguments.length,I=new Array(P);P--;)I[P]=arguments[P];C.subscribers.forEach(function(K){ye(function(){K.apply(null,I)})})})}})}}function Kt(c,u){return T(u).from({prototype:c}),u}function Tt(c,u){return!(c.filter||c.algorithm||c.or)&&(u?c.justLimit:!c.replayFilter)}function Nn(c,u){c.filter=pt(c.filter,u)}function $n(c,u,f){var g=c.replayFilter;c.replayFilter=g?function(){return pt(g(),u())}:u,c.justLimit=f&&!g}function Qt(c,u){if(c.isPrimKey)return u.primaryKey;var f=u.getIndexByKeyPath(c.index);if(!f)throw new pe.Schema("KeyPath "+c.index+" on object store "+u.name+" is not indexed");return f}function gr(c,u,f){var g=Qt(c,u.schema);return u.openCursor({trans:f,values:!c.keysOnly,reverse:c.dir==="prev",unique:!!c.unique,query:{index:g,range:c.range}})}function en(c,u,f,g){var b=c.replayFilter?pt(c.filter,c.replayFilter()):c.filter;if(c.or){var w={},E=function(x,N,$){var D,R;b&&!b(N,$,function(U){return N.stop(U)},function(U){return N.fail(U)})||((R=""+(D=N.primaryKey))=="[object ArrayBuffer]"&&(R=""+new Uint8Array(D)),m(w,R)||(w[R]=!0,u(x,N,$)))};return Promise.all([c.or._iterate(E,f),mr(gr(c,g,f),c.algorithm,E,!c.keysOnly&&c.valueMapper)])}return mr(gr(c,g,f),pt(c.algorithm,b),u,!c.keysOnly&&c.valueMapper)}function mr(c,u,f,g){var b=Ce(g?function(w,E,x){return f(g(w),E,x)}:f);return c.then(function(w){if(w)return w.start(function(){var E=function(){return w.continue()};u&&!u(w,function(x){return E=x},function(x){w.stop(x),E=Te},function(x){w.fail(x),E=Te})||b(w.value,w,function(x){return E=x}),E()})})}var Ci=(Ae.prototype._read=function(c,u){var f=this._ctx;return f.error?f.table._trans(null,Pe.bind(null,f.error)):f.table._trans("readonly",c).then(u)},Ae.prototype._write=function(c){var u=this._ctx;return u.error?u.table._trans(null,Pe.bind(null,u.error)):u.table._trans("readwrite",c,"locked")},Ae.prototype._addAlgorithm=function(c){var u=this._ctx;u.algorithm=pt(u.algorithm,c)},Ae.prototype._iterate=function(c,u){return en(this._ctx,c,u,this._ctx.table.core)},Ae.prototype.clone=function(c){var u=Object.create(this.constructor.prototype),f=Object.create(this._ctx);return c&&h(f,c),u._ctx=f,u},Ae.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ae.prototype.each=function(c){var u=this._ctx;return this._read(function(f){return en(u,c,f,u.table.core)})},Ae.prototype.count=function(c){var u=this;return this._read(function(f){var g=u._ctx,b=g.table.core;if(Tt(g,!0))return b.count({trans:f,query:{index:Qt(g,b.schema),range:g.range}}).then(function(E){return Math.min(E,g.limit)});var w=0;return en(g,function(){return++w,!1},f,b).then(function(){return w})}).then(c)},Ae.prototype.sortBy=function(c,u){var f=c.split(".").reverse(),g=f[0],b=f.length-1;function w(N,$){return $?w(N[f[$]],$-1):N[g]}var E=this._ctx.dir==="next"?1:-1;function x(N,$){return xe(w(N,b),w($,b))*E}return this.toArray(function(N){return N.sort(x)}).then(u)},Ae.prototype.toArray=function(c){var u=this;return this._read(function(f){var g=u._ctx;if(g.dir==="next"&&Tt(g,!0)&&0<g.limit){var b=g.valueMapper,w=Qt(g,g.table.core.schema);return g.table.core.query({trans:f,limit:g.limit,values:!0,query:{index:w,range:g.range}}).then(function(x){return x=x.result,b?x.map(b):x})}var E=[];return en(g,function(x){return E.push(x)},f,g.table.core).then(function(){return E})},c)},Ae.prototype.offset=function(c){var u=this._ctx;return c<=0||(u.offset+=c,Tt(u)?$n(u,function(){var f=c;return function(g,b){return f===0||(f===1?--f:b(function(){g.advance(f),f=0}),!1)}}):$n(u,function(){var f=c;return function(){return--f<0}})),this},Ae.prototype.limit=function(c){return this._ctx.limit=Math.min(this._ctx.limit,c),$n(this._ctx,function(){var u=c;return function(f,g,b){return--u<=0&&g(b),0<=u}},!0),this},Ae.prototype.until=function(c,u){return Nn(this._ctx,function(f,g,b){return!c(f.value)||(g(b),u)}),this},Ae.prototype.first=function(c){return this.limit(1).toArray(function(u){return u[0]}).then(c)},Ae.prototype.last=function(c){return this.reverse().first(c)},Ae.prototype.filter=function(c){var u;return Nn(this._ctx,function(f){return c(f.value)}),(u=this._ctx).isMatch=pt(u.isMatch,c),this},Ae.prototype.and=function(c){return this.filter(c)},Ae.prototype.or=function(c){return new this.db.WhereClause(this._ctx.table,c,this)},Ae.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ae.prototype.desc=function(){return this.reverse()},Ae.prototype.eachKey=function(c){var u=this._ctx;return u.keysOnly=!u.isMatch,this.each(function(f,g){c(g.key,g)})},Ae.prototype.eachUniqueKey=function(c){return this._ctx.unique="unique",this.eachKey(c)},Ae.prototype.eachPrimaryKey=function(c){var u=this._ctx;return u.keysOnly=!u.isMatch,this.each(function(f,g){c(g.primaryKey,g)})},Ae.prototype.keys=function(c){var u=this._ctx;u.keysOnly=!u.isMatch;var f=[];return this.each(function(g,b){f.push(b.key)}).then(function(){return f}).then(c)},Ae.prototype.primaryKeys=function(c){var u=this._ctx;if(u.dir==="next"&&Tt(u,!0)&&0<u.limit)return this._read(function(g){var b=Qt(u,u.table.core.schema);return u.table.core.query({trans:g,values:!1,limit:u.limit,query:{index:b,range:u.range}})}).then(function(g){return g.result}).then(c);u.keysOnly=!u.isMatch;var f=[];return this.each(function(g,b){f.push(b.primaryKey)}).then(function(){return f}).then(c)},Ae.prototype.uniqueKeys=function(c){return this._ctx.unique="unique",this.keys(c)},Ae.prototype.firstKey=function(c){return this.limit(1).keys(function(u){return u[0]}).then(c)},Ae.prototype.lastKey=function(c){return this.reverse().firstKey(c)},Ae.prototype.distinct=function(){var c=this._ctx,c=c.index&&c.table.schema.idxByName[c.index];if(!c||!c.multi)return this;var u={};return Nn(this._ctx,function(b){var g=b.primaryKey.toString(),b=m(u,g);return u[g]=!0,!b}),this},Ae.prototype.modify=function(c){var u=this,f=this._ctx;return this._write(function(g){var b=typeof c=="function"?c:function(I){return pr(I,c)},w=f.table.core,$=w.schema.primaryKey,E=$.outbound,x=$.extractKey,N=200,$=u.db._options.modifyChunkSize;$&&(N=typeof $=="object"?$[w.name]||$["*"]||200:$);function D(I,M){var L=M.failures,M=M.numFailures;U+=I-M;for(var G=0,Y=o(L);G<Y.length;G++){var se=Y[G];R.push(L[se])}}var R=[],U=0,C=[],P=c===br;return u.clone().primaryKeys().then(function(I){function K(M){var G=Math.min(N,I.length-M),Y=I.slice(M,M+G);return(P?Promise.resolve([]):w.getMany({trans:g,keys:Y,cache:"immutable"})).then(function(se){var ue=[],re=[],ce=E?[]:null,he=P?Y:[];if(!P)for(var le=0;le<G;++le){var ge=se[le],Ee={value:j(ge),primKey:I[M+le]};b.call(Ee,Ee.value,Ee)!==!1&&(Ee.value==null?he.push(I[M+le]):E||xe(x(ge),x(Ee.value))===0?(re.push(Ee.value),E&&ce.push(I[M+le])):(he.push(I[M+le]),ue.push(Ee.value)))}return Promise.resolve(0<ue.length&&w.mutate({trans:g,type:"add",values:ue}).then(function(ke){for(var Se in ke.failures)he.splice(parseInt(Se),1);D(ue.length,ke)})).then(function(){return(0<re.length||L&&typeof c=="object")&&w.mutate({trans:g,type:"put",keys:ce,values:re,criteria:L,changeSpec:typeof c!="function"&&c,isAdditionalChunk:0<M}).then(function(ke){return D(re.length,ke)})}).then(function(){return(0<he.length||L&&P)&&w.mutate({trans:g,type:"delete",keys:he,criteria:L,isAdditionalChunk:0<M}).then(function(ke){return Xt(f.table,he,ke)}).then(function(ke){return D(he.length,ke)})}).then(function(){return I.length>M+G&&K(M+N)})})}var L=Tt(f)&&f.limit===1/0&&(typeof c!="function"||P)&&{index:f.index,range:f.range};return K(0).then(function(){if(0<R.length)throw new $e("Error modifying one or more objects",R,U,C);return I.length})})})},Ae.prototype.delete=function(){var c=this._ctx,u=c.range;return!Tt(c)||c.table.schema.yProps||!c.isPrimKey&&u.type!==3?this.modify(br):this._write(function(f){var g=c.table.core.schema.primaryKey,b=u;return c.table.core.count({trans:f,query:{index:g,range:b}}).then(function(w){return c.table.core.mutate({trans:f,type:"deleteRange",range:b}).then(function(N){var x=N.failures,N=N.numFailures;if(N)throw new $e("Could not delete some values",Object.keys(x).map(function($){return x[$]}),w-N);return w-N})})})},Ae);function Ae(){}var br=function(c,u){return u.value=null};function Pi(c,u){return c<u?-1:c===u?0:1}function Ii(c,u){return u<c?-1:c===u?0:1}function He(c,u,f){return c=c instanceof wr?new c.Collection(c):c,c._ctx.error=new(f||TypeError)(u),c}function xt(c){return new c.Collection(c,function(){return vr("")}).limit(0)}function tn(c,u,f,g){var b,w,E,x,N,$,D,R=f.length;if(!f.every(function(P){return typeof P=="string"}))return He(c,cr);function U(P){b=P==="next"?function(K){return K.toUpperCase()}:function(K){return K.toLowerCase()},w=P==="next"?function(K){return K.toLowerCase()}:function(K){return K.toUpperCase()},E=P==="next"?Pi:Ii;var I=f.map(function(K){return{lower:w(K),upper:b(K)}}).sort(function(K,L){return E(K.lower,L.lower)});x=I.map(function(K){return K.upper}),N=I.map(function(K){return K.lower}),D=($=P)==="next"?"":g}U("next"),c=new c.Collection(c,function(){return it(x[0],N[R-1]+g)}),c._ondirectionchange=function(P){U(P)};var C=0;return c._addAlgorithm(function(P,I,K){var L=P.key;if(typeof L!="string")return!1;var M=w(L);if(u(M,N,C))return!0;for(var G=null,Y=C;Y<R;++Y){var se=function(ue,re,ce,he,le,ge){for(var Ee=Math.min(ue.length,he.length),ke=-1,Se=0;Se<Ee;++Se){var Ve=re[Se];if(Ve!==he[Se])return le(ue[Se],ce[Se])<0?ue.substr(0,Se)+ce[Se]+ce.substr(Se+1):le(ue[Se],he[Se])<0?ue.substr(0,Se)+he[Se]+ce.substr(Se+1):0<=ke?ue.substr(0,ke)+re[ke]+ce.substr(ke+1):null;le(ue[Se],Ve)<0&&(ke=Se)}return Ee<he.length&&ge==="next"?ue+ce.substr(ue.length):Ee<ue.length&&ge==="prev"?ue.substr(0,ce.length):ke<0?null:ue.substr(0,ke)+he[ke]+ce.substr(ke+1)}(L,M,x[Y],N[Y],E,$);se===null&&G===null?C=Y+1:(G===null||0<E(G,se))&&(G=se)}return I(G!==null?function(){P.continue(G+D)}:K),!1}),c}function it(c,u,f,g){return{type:2,lower:c,upper:u,lowerOpen:f,upperOpen:g}}function vr(c){return{type:1,lower:c,upper:c}}var wr=(Object.defineProperty(Ue.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ue.prototype.between=function(c,u,f,g){f=f!==!1,g=g===!0;try{return 0<this._cmp(c,u)||this._cmp(c,u)===0&&(f||g)&&(!f||!g)?xt(this):new this.Collection(this,function(){return it(c,u,!f,!g)})}catch{return He(this,Ze)}},Ue.prototype.equals=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return vr(c)})},Ue.prototype.above=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(c,void 0,!0)})},Ue.prototype.aboveOrEqual=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(c,void 0,!1)})},Ue.prototype.below=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(void 0,c,!1,!0)})},Ue.prototype.belowOrEqual=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(void 0,c)})},Ue.prototype.startsWith=function(c){return typeof c!="string"?He(this,cr):this.between(c,c+ft,!0,!0)},Ue.prototype.startsWithIgnoreCase=function(c){return c===""?this.startsWith(c):tn(this,function(u,f){return u.indexOf(f[0])===0},[c],ft)},Ue.prototype.equalsIgnoreCase=function(c){return tn(this,function(u,f){return u===f[0]},[c],"")},Ue.prototype.anyOfIgnoreCase=function(){var c=J.apply(A,arguments);return c.length===0?xt(this):tn(this,function(u,f){return f.indexOf(u)!==-1},c,"")},Ue.prototype.startsWithAnyOfIgnoreCase=function(){var c=J.apply(A,arguments);return c.length===0?xt(this):tn(this,function(u,f){return f.some(function(g){return u.indexOf(g)===0})},c,ft)},Ue.prototype.anyOf=function(){var c=this,u=J.apply(A,arguments),f=this._cmp;try{u.sort(f)}catch{return He(this,Ze)}if(u.length===0)return xt(this);var g=new this.Collection(this,function(){return it(u[0],u[u.length-1])});g._ondirectionchange=function(w){f=w==="next"?c._ascending:c._descending,u.sort(f)};var b=0;return g._addAlgorithm(function(w,E,x){for(var N=w.key;0<f(N,u[b]);)if(++b===u.length)return E(x),!1;return f(N,u[b])===0||(E(function(){w.continue(u[b])}),!1)}),g},Ue.prototype.notEqual=function(c){return this.inAnyRange([[-1/0,c],[c,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ue.prototype.noneOf=function(){var c=J.apply(A,arguments);if(c.length===0)return new this.Collection(this);try{c.sort(this._ascending)}catch{return He(this,Ze)}var u=c.reduce(function(f,g){return f?f.concat([[f[f.length-1][1],g]]):[[-1/0,g]]},null);return u.push([c[c.length-1],this.db._maxKey]),this.inAnyRange(u,{includeLowers:!1,includeUppers:!1})},Ue.prototype.inAnyRange=function(L,u){var f=this,g=this._cmp,b=this._ascending,w=this._descending,E=this._min,x=this._max;if(L.length===0)return xt(this);if(!L.every(function(M){return M[0]!==void 0&&M[1]!==void 0&&b(M[0],M[1])<=0}))return He(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",pe.InvalidArgument);var N=!u||u.includeLowers!==!1,$=u&&u.includeUppers===!0,D,R=b;function U(M,G){return R(M[0],G[0])}try{(D=L.reduce(function(M,G){for(var Y=0,se=M.length;Y<se;++Y){var ue=M[Y];if(g(G[0],ue[1])<0&&0<g(G[1],ue[0])){ue[0]=E(ue[0],G[0]),ue[1]=x(ue[1],G[1]);break}}return Y===se&&M.push(G),M},[])).sort(U)}catch{return He(this,Ze)}var C=0,P=$?function(M){return 0<b(M,D[C][1])}:function(M){return 0<=b(M,D[C][1])},I=N?function(M){return 0<w(M,D[C][0])}:function(M){return 0<=w(M,D[C][0])},K=P,L=new this.Collection(this,function(){return it(D[0][0],D[D.length-1][1],!N,!$)});return L._ondirectionchange=function(M){R=M==="next"?(K=P,b):(K=I,w),D.sort(U)},L._addAlgorithm(function(M,G,Y){for(var se,ue=M.key;K(ue);)if(++C===D.length)return G(Y),!1;return!P(se=ue)&&!I(se)||(f._cmp(ue,D[C][1])===0||f._cmp(ue,D[C][0])===0||G(function(){R===b?M.continue(D[C][0]):M.continue(D[C][1])}),!1)}),L},Ue.prototype.startsWithAnyOf=function(){var c=J.apply(A,arguments);return c.every(function(u){return typeof u=="string"})?c.length===0?xt(this):this.inAnyRange(c.map(function(u){return[u,u+ft]})):He(this,"startsWithAnyOf() only works with strings")},Ue);function Ue(){}function Je(c){return Ce(function(u){return Ot(u),c(u.target.error),!1})}function Ot(c){c.stopPropagation&&c.stopPropagation(),c.preventDefault&&c.preventDefault()}var Ut="storagemutated",Cn="x-storagemutated-1",st=Dt(null,Ut),Di=(Ye.prototype._lock=function(){return Q(!be.global),++this._reculock,this._reculock!==1||be.global||(be.lockOwnerFor=this),this},Ye.prototype._unlock=function(){if(Q(!be.global),--this._reculock==0)for(be.global||(be.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var c=this._blockedFuncs.shift();try{dt(c[1],c[0])}catch{}}return this},Ye.prototype._locked=function(){return this._reculock&&be.lockOwnerFor!==this},Ye.prototype.create=function(c){var u=this;if(!this.mode)return this;var f=this.db.idbdb,g=this.db._state.dbOpenError;if(Q(!this.idbtrans),!c&&!f)switch(g&&g.name){case"DatabaseClosedError":throw new pe.DatabaseClosed(g);case"MissingAPIError":throw new pe.MissingAPI(g.message,g);default:throw new pe.OpenFailed(g)}if(!this.active)throw new pe.TransactionInactive;return Q(this._completion._state===null),(c=this.idbtrans=c||(this.db.core||f).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ce(function(b){Ot(b),u._reject(c.error)}),c.onabort=Ce(function(b){Ot(b),u.active&&u._reject(new pe.Abort(c.error)),u.active=!1,u.on("abort").fire(b)}),c.oncomplete=Ce(function(){u.active=!1,u._resolve(),"mutatedParts"in c&&st.storagemutated.fire(c.mutatedParts)}),this},Ye.prototype._promise=function(c,u,f){var g=this;if(c==="readwrite"&&this.mode!=="readwrite")return Pe(new pe.ReadOnly("Transaction is readonly"));if(!this.active)return Pe(new pe.TransactionInactive);if(this._locked())return new fe(function(w,E){g._blockedFuncs.push([function(){g._promise(c,u,f).then(w,E)},be])});if(f)return tt(function(){var w=new fe(function(E,x){g._lock();var N=u(E,x,g);N&&N.then&&N.then(E,x)});return w.finally(function(){return g._unlock()}),w._lib=!0,w});var b=new fe(function(w,E){var x=u(w,E,g);x&&x.then&&x.then(w,E)});return b._lib=!0,b},Ye.prototype._root=function(){return this.parent?this.parent._root():this},Ye.prototype.waitFor=function(c){var u,f=this._root(),g=fe.resolve(c);f._waitingFor?f._waitingFor=f._waitingFor.then(function(){return g}):(f._waitingFor=g,f._waitingQueue=[],u=f.idbtrans.objectStore(f.storeNames[0]),function w(){for(++f._spinCount;f._waitingQueue.length;)f._waitingQueue.shift()();f._waitingFor&&(u.get(-1/0).onsuccess=w)}());var b=f._waitingFor;return new fe(function(w,E){g.then(function(x){return f._waitingQueue.push(Ce(w.bind(null,x)))},function(x){return f._waitingQueue.push(Ce(E.bind(null,x)))}).finally(function(){f._waitingFor===b&&(f._waitingFor=null)})})},Ye.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new pe.Abort))},Ye.prototype.table=function(c){var u=this._memoizedTables||(this._memoizedTables={});if(m(u,c))return u[c];var f=this.schema[c];if(!f)throw new pe.NotFound("Table "+c+" not part of transaction");return f=new this.db.Table(c,f,this),f.core=this.db.core.table(c),u[c]=f},Ye);function Ye(){}function Pn(c,u,f,g,b,w,E,x){return{name:c,keyPath:u,unique:f,multi:g,auto:b,compound:w,src:(f&&!E?"&":"")+(g?"*":"")+(b?"++":"")+_r(u),type:x}}function _r(c){return typeof c=="string"?c:c?"["+[].join.call(c,"+")+"]":""}function In(c,u,f){return{name:c,primKey:u,indexes:f,mappedClass:null,idxByName:(g=function(b){return[b.name,b]},f.reduce(function(b,w,E){return E=g(w,E),E&&(b[E[0]]=E[1]),b},{}))};var g}var Ft=function(c){try{return c.only([[]]),Ft=function(){return[[]]},[[]]}catch{return Ft=function(){return ft},ft}};function Dn(c){return c==null?function(){}:typeof c=="string"?(u=c).split(".").length===1?function(f){return f[u]}:function(f){return ie(f,u)}:function(f){return ie(f,c)};var u}function Er(c){return[].slice.call(c)}var Ki=0;function Bt(c){return c==null?":id":typeof c=="string"?c:"[".concat(c.join("+"),"]")}function Oi(c,u,N){function g(K){if(K.type===3)return null;if(K.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var C=K.lower,P=K.upper,I=K.lowerOpen,K=K.upperOpen;return C===void 0?P===void 0?null:u.upperBound(P,!!K):P===void 0?u.lowerBound(C,!!I):u.bound(C,P,!!I,!!K)}function b(U){var C,P=U.name;return{name:P,schema:U,mutate:function(I){var K=I.trans,L=I.type,M=I.keys,G=I.values,Y=I.range;return new Promise(function(se,ue){se=Ce(se);var re=K.objectStore(P),ce=re.keyPath==null,he=L==="put"||L==="add";if(!he&&L!=="delete"&&L!=="deleteRange")throw new Error("Invalid operation type: "+L);var le,ge=(M||G||{length:1}).length;if(M&&G&&M.length!==G.length)throw new Error("Given keys array must have same length as given values array.");if(ge===0)return se({numFailures:0,failures:{},results:[],lastResult:void 0});function Ee(Me){++Ve,Ot(Me)}var ke=[],Se=[],Ve=0;if(L==="deleteRange"){if(Y.type===4)return se({numFailures:Ve,failures:Se,results:[],lastResult:void 0});Y.type===3?ke.push(le=re.clear()):ke.push(le=re.delete(g(Y)))}else{var ce=he?ce?[G,M]:[G,null]:[M,null],_e=ce[0],Be=ce[1];if(he)for(var Le=0;Le<ge;++Le)ke.push(le=Be&&Be[Le]!==void 0?re[L](_e[Le],Be[Le]):re[L](_e[Le])),le.onerror=Ee;else for(Le=0;Le<ge;++Le)ke.push(le=re[L](_e[Le])),le.onerror=Ee}function pn(Me){Me=Me.target.result,ke.forEach(function(mt,Xn){return mt.error!=null&&(Se[Xn]=mt.error)}),se({numFailures:Ve,failures:Se,results:L==="delete"?M:ke.map(function(mt){return mt.result}),lastResult:Me})}le.onerror=function(Me){Ee(Me),pn(Me)},le.onsuccess=pn})},getMany:function(I){var K=I.trans,L=I.keys;return new Promise(function(M,G){M=Ce(M);for(var Y,se=K.objectStore(P),ue=L.length,re=new Array(ue),ce=0,he=0,le=function(ke){ke=ke.target,re[ke._pos]=ke.result,++he===ce&&M(re)},ge=Je(G),Ee=0;Ee<ue;++Ee)L[Ee]!=null&&((Y=se.get(L[Ee]))._pos=Ee,Y.onsuccess=le,Y.onerror=ge,++ce);ce===0&&M(re)})},get:function(I){var K=I.trans,L=I.key;return new Promise(function(M,G){M=Ce(M);var Y=K.objectStore(P).get(L);Y.onsuccess=function(se){return M(se.target.result)},Y.onerror=Je(G)})},query:(C=$,function(I){return new Promise(function(K,L){K=Ce(K);var M,G,Y,ce=I.trans,se=I.values,ue=I.limit,le=I.query,re=ue===1/0?void 0:ue,he=le.index,le=le.range,ce=ce.objectStore(P),he=he.isPrimaryKey?ce:ce.index(he.name),le=g(le);if(ue===0)return K({result:[]});C?((re=se?he.getAll(le,re):he.getAllKeys(le,re)).onsuccess=function(ge){return K({result:ge.target.result})},re.onerror=Je(L)):(M=0,G=!se&&"openKeyCursor"in he?he.openKeyCursor(le):he.openCursor(le),Y=[],G.onsuccess=function(ge){var Ee=G.result;return Ee?(Y.push(se?Ee.value:Ee.primaryKey),++M===ue?K({result:Y}):void Ee.continue()):K({result:Y})},G.onerror=Je(L))})}),openCursor:function(I){var K=I.trans,L=I.values,M=I.query,G=I.reverse,Y=I.unique;return new Promise(function(se,ue){se=Ce(se);var he=M.index,re=M.range,ce=K.objectStore(P),ce=he.isPrimaryKey?ce:ce.index(he.name),he=G?Y?"prevunique":"prev":Y?"nextunique":"next",le=!L&&"openKeyCursor"in ce?ce.openKeyCursor(g(re),he):ce.openCursor(g(re),he);le.onerror=Je(ue),le.onsuccess=Ce(function(ge){var Ee,ke,Se,Ve,_e=le.result;_e?(_e.___id=++Ki,_e.done=!1,Ee=_e.continue.bind(_e),ke=(ke=_e.continuePrimaryKey)&&ke.bind(_e),Se=_e.advance.bind(_e),Ve=function(){throw new Error("Cursor not stopped")},_e.trans=K,_e.stop=_e.continue=_e.continuePrimaryKey=_e.advance=function(){throw new Error("Cursor not started")},_e.fail=Ce(ue),_e.next=function(){var Be=this,Le=1;return this.start(function(){return Le--?Be.continue():Be.stop()}).then(function(){return Be})},_e.start=function(Be){function Le(){if(le.result)try{Be()}catch(Me){_e.fail(Me)}else _e.done=!0,_e.start=function(){throw new Error("Cursor behind last entry")},_e.stop()}var pn=new Promise(function(Me,mt){Me=Ce(Me),le.onerror=Je(mt),_e.fail=mt,_e.stop=function(Xn){_e.stop=_e.continue=_e.continuePrimaryKey=_e.advance=Ve,Me(Xn)}});return le.onsuccess=Ce(function(Me){le.onsuccess=Le,Le()}),_e.continue=Ee,_e.continuePrimaryKey=ke,_e.advance=Se,Le(),pn},se(_e)):se(null)},ue)})},count:function(I){var K=I.query,L=I.trans,M=K.index,G=K.range;return new Promise(function(Y,se){var ue=L.objectStore(P),re=M.isPrimaryKey?ue:ue.index(M.name),ue=g(G),re=ue?re.count(ue):re.count();re.onsuccess=Ce(function(ce){return Y(ce.target.result)}),re.onerror=Je(se)})}}}var w,E,x,D=(E=N,x=Er((w=c).objectStoreNames),{schema:{name:w.name,tables:x.map(function(U){return E.objectStore(U)}).map(function(U){var C=U.keyPath,K=U.autoIncrement,P=l(C),I={},K={name:U.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:C==null,compound:P,keyPath:C,autoIncrement:K,unique:!0,extractKey:Dn(C)},indexes:Er(U.indexNames).map(function(L){return U.index(L)}).map(function(Y){var M=Y.name,G=Y.unique,se=Y.multiEntry,Y=Y.keyPath,se={name:M,compound:l(Y),keyPath:Y,unique:G,multiEntry:se,extractKey:Dn(Y)};return I[Bt(Y)]=se}),getIndexByKeyPath:function(L){return I[Bt(L)]}};return I[":id"]=K.primaryKey,C!=null&&(I[Bt(C)]=K.primaryKey),K})},hasGetAll:0<x.length&&"getAll"in E.objectStore(x[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),N=D.schema,$=D.hasGetAll,D=N.tables.map(b),R={};return D.forEach(function(U){return R[U.name]=U}),{stack:"dbcore",transaction:c.transaction.bind(c),table:function(U){if(!R[U])throw new Error("Table '".concat(U,"' not found"));return R[U]},MIN_KEY:-1/0,MAX_KEY:Ft(u),schema:N}}function Ui(c,u,f,g){var b=f.IDBKeyRange;return f.indexedDB,{dbcore:(g=Oi(u,b,g),c.dbcore.reduce(function(w,E){return E=E.create,r(r({},w),E(w))},g))}}function nn(c,g){var f=g.db,g=Ui(c._middlewares,f,c._deps,g);c.core=g.dbcore,c.tables.forEach(function(b){var w=b.name;c.core.schema.tables.some(function(E){return E.name===w})&&(b.core=c.core.table(w),c[w]instanceof c.Table&&(c[w].core=b.core))})}function rn(c,u,f,g){f.forEach(function(b){var w=g[b];u.forEach(function(E){var x=function N($,D){return k($,D)||($=y($))&&N($,D)}(E,b);(!x||"value"in x&&x.value===void 0)&&(E===c.Transaction.prototype||E instanceof c.Transaction?S(E,b,{get:function(){return this.table(b)},set:function(N){_(this,b,{value:N,writable:!0,configurable:!0,enumerable:!0})}}):E[b]=new c.Table(b,w))})})}function Kn(c,u){u.forEach(function(f){for(var g in f)f[g]instanceof c.Table&&delete f[g]})}function Fi(c,u){return c._cfg.version-u._cfg.version}function Bi(c,u,f,g){var b=c._dbSchema;f.objectStoreNames.contains("$meta")&&!b.$meta&&(b.$meta=In("$meta",Sr("")[0],[]),c._storeNames.push("$meta"));var w=c._createTransaction("readwrite",c._storeNames,b);w.create(f),w._completion.catch(g);var E=w._reject.bind(w),x=be.transless||be;tt(function(){return be.trans=w,be.transless=x,u!==0?(nn(c,f),$=u,((N=w).storeNames.includes("$meta")?N.table("$meta").get("version").then(function(D){return D??$}):fe.resolve($)).then(function(D){return U=D,C=w,P=f,I=[],D=(R=c)._versions,K=R._dbSchema=an(0,R.idbdb,P),(D=D.filter(function(L){return L._cfg.version>=U})).length!==0?(D.forEach(function(L){I.push(function(){var M=K,G=L._cfg.dbschema;on(R,M,P),on(R,G,P),K=R._dbSchema=G;var Y=On(M,G);Y.add.forEach(function(he){Un(P,he[0],he[1].primKey,he[1].indexes)}),Y.change.forEach(function(he){if(he.recreate)throw new pe.Upgrade("Not yet support for changing primary key");var le=P.objectStore(he.name);he.add.forEach(function(ge){return sn(le,ge)}),he.change.forEach(function(ge){le.deleteIndex(ge.name),sn(le,ge)}),he.del.forEach(function(ge){return le.deleteIndex(ge)})});var se=L._cfg.contentUpgrade;if(se&&L._cfg.version>U){nn(R,P),C._memoizedTables={};var ue=ae(G);Y.del.forEach(function(he){ue[he]=M[he]}),Kn(R,[R.Transaction.prototype]),rn(R,[R.Transaction.prototype],o(ue),ue),C.schema=ue;var re,ce=X(se);return ce&&kt(),Y=fe.follow(function(){var he;(re=se(C))&&ce&&(he=nt.bind(null,null),re.then(he,he))}),re&&typeof re.then=="function"?fe.resolve(re):Y.then(function(){return re})}}),I.push(function(M){var G,Y,se=L._cfg.dbschema;G=se,Y=M,[].slice.call(Y.db.objectStoreNames).forEach(function(ue){return G[ue]==null&&Y.db.deleteObjectStore(ue)}),Kn(R,[R.Transaction.prototype]),rn(R,[R.Transaction.prototype],R._storeNames,R._dbSchema),C.schema=R._dbSchema}),I.push(function(M){R.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(R.idbdb.version/10)===L._cfg.version?(R.idbdb.deleteObjectStore("$meta"),delete R._dbSchema.$meta,R._storeNames=R._storeNames.filter(function(G){return G!=="$meta"})):M.objectStore("$meta").put(L._cfg.version,"version"))})}),function L(){return I.length?fe.resolve(I.shift()(C.idbtrans)).then(L):fe.resolve()}().then(function(){kr(K,P)})):fe.resolve();var R,U,C,P,I,K}).catch(E)):(o(b).forEach(function(D){Un(f,D,b[D].primKey,b[D].indexes)}),nn(c,f),void fe.follow(function(){return c.on.populate.fire(w)}).catch(E));var N,$})}function Li(c,u){kr(c._dbSchema,u),u.db.version%10!=0||u.objectStoreNames.contains("$meta")||u.db.createObjectStore("$meta").add(Math.ceil(u.db.version/10-1),"version");var f=an(0,c.idbdb,u);on(c,c._dbSchema,u);for(var g=0,b=On(f,c._dbSchema).change;g<b.length;g++){var w=function(E){if(E.change.length||E.recreate)return console.warn("Unable to patch indexes of table ".concat(E.name," because it has changes on the type of index or primary key.")),{value:void 0};var x=u.objectStore(E.name);E.add.forEach(function(N){Ge&&console.debug("Dexie upgrade patch: Creating missing index ".concat(E.name,".").concat(N.src)),sn(x,N)})}(b[g]);if(typeof w=="object")return w.value}}function On(c,u){var f,g={del:[],add:[],change:[]};for(f in c)u[f]||g.del.push(f);for(f in u){var b=c[f],w=u[f];if(b){var E={name:f,def:w,recreate:!1,del:[],add:[],change:[]};if(""+(b.primKey.keyPath||"")!=""+(w.primKey.keyPath||"")||b.primKey.auto!==w.primKey.auto)E.recreate=!0,g.change.push(E);else{var x=b.idxByName,N=w.idxByName,$=void 0;for($ in x)N[$]||E.del.push($);for($ in N){var D=x[$],R=N[$];D?D.src!==R.src&&E.change.push(R):E.add.push(R)}(0<E.del.length||0<E.add.length||0<E.change.length)&&g.change.push(E)}}else g.add.push([f,w])}return g}function Un(c,u,f,g){var b=c.db.createObjectStore(u,f.keyPath?{keyPath:f.keyPath,autoIncrement:f.auto}:{autoIncrement:f.auto});return g.forEach(function(w){return sn(b,w)}),b}function kr(c,u){o(c).forEach(function(f){u.db.objectStoreNames.contains(f)||(Ge&&console.debug("Dexie: Creating missing table",f),Un(u,f,c[f].primKey,c[f].indexes))})}function sn(c,u){c.createIndex(u.name,u.keyPath,{unique:u.unique,multiEntry:u.multi})}function an(c,u,f){var g={};return q(u.objectStoreNames,0).forEach(function(b){for(var w=f.objectStore(b),E=Pn(_r($=w.keyPath),$||"",!0,!1,!!w.autoIncrement,$&&typeof $!="string",!0),x=[],N=0;N<w.indexNames.length;++N){var D=w.index(w.indexNames[N]),$=D.keyPath,D=Pn(D.name,$,!!D.unique,!!D.multiEntry,!1,$&&typeof $!="string",!1);x.push(D)}g[b]=In(b,E,x)}),g}function on(c,u,f){for(var g=f.db.objectStoreNames,b=0;b<g.length;++b){var w=g[b],E=f.objectStore(w);c._hasGetAll="getAll"in E;for(var x=0;x<E.indexNames.length;++x){var N=E.indexNames[x],$=E.index(N).keyPath,D=typeof $=="string"?$:"["+q($).join("+")+"]";!u[w]||($=u[w].idxByName[D])&&($.name=N,delete u[w].idxByName[D],u[w].idxByName[N]=$)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(c._hasGetAll=!1)}function Sr(c){return c.split(",").map(function(u,f){var w=u.split(":"),g=(b=w[1])===null||b===void 0?void 0:b.trim(),b=(u=w[0].trim()).replace(/([&*]|\+\+)/g,""),w=/^\[/.test(b)?b.match(/^\[(.*)\]$/)[1].split("+"):b;return Pn(b,w||null,/\&/.test(u),/\*/.test(u),/\+\+/.test(u),l(w),f===0,g)})}var Mi=(At.prototype._createTableSchema=In,At.prototype._parseIndexSyntax=Sr,At.prototype._parseStoresSpec=function(c,u){var f=this;o(c).forEach(function(g){if(c[g]!==null){var b=f._parseIndexSyntax(c[g]),w=b.shift();if(!w)throw new pe.Schema("Invalid schema for table "+g+": "+c[g]);if(w.unique=!0,w.multi)throw new pe.Schema("Primary key cannot be multiEntry*");b.forEach(function(E){if(E.auto)throw new pe.Schema("Only primary key can be marked as autoIncrement (++)");if(!E.keyPath)throw new pe.Schema("Index must have a name and cannot be an empty string")}),b=f._createTableSchema(g,w,b),u[g]=b}})},At.prototype.stores=function(f){var u=this.db;this._cfg.storesSource=this._cfg.storesSource?h(this._cfg.storesSource,f):f;var f=u._versions,g={},b={};return f.forEach(function(w){h(g,w._cfg.storesSource),b=w._cfg.dbschema={},w._parseStoresSpec(g,b)}),u._dbSchema=b,Kn(u,[u._allTables,u,u.Transaction.prototype]),rn(u,[u._allTables,u,u.Transaction.prototype,this._cfg.tables],o(b),b),u._storeNames=o(b),this},At.prototype.upgrade=function(c){return this._cfg.contentUpgrade=bn(this._cfg.contentUpgrade||Te,c),this},At);function At(){}function Fn(c,u){var f=c._dbNamesDB;return f||(f=c._dbNamesDB=new Xe(Yt,{addons:[],indexedDB:c,IDBKeyRange:u})).version(1).stores({dbnames:"name"}),f.table("dbnames")}function Bn(c){return c&&typeof c.databases=="function"}function Ln(c){return tt(function(){return be.letThrough=!0,c()})}function Mn(c){return!("from"in c)}var Fe=function(c,u){if(!this){var f=new Fe;return c&&"d"in c&&h(f,c),f}h(this,arguments.length?{d:1,from:c,to:1<arguments.length?u:c}:{d:0})};function Lt(c,u,f){var g=xe(u,f);if(!isNaN(g)){if(0<g)throw RangeError();if(Mn(c))return h(c,{from:u,to:f,d:1});var b=c.l,g=c.r;if(xe(f,c.from)<0)return b?Lt(b,u,f):c.l={from:u,to:f,d:1,l:null,r:null},xr(c);if(0<xe(u,c.to))return g?Lt(g,u,f):c.r={from:u,to:f,d:1,l:null,r:null},xr(c);xe(u,c.from)<0&&(c.from=u,c.l=null,c.d=g?g.d+1:1),0<xe(f,c.to)&&(c.to=f,c.r=null,c.d=c.l?c.l.d+1:1),f=!c.r,b&&!c.l&&Mt(c,b),g&&f&&Mt(c,g)}}function Mt(c,u){Mn(u)||function f(g,N){var w=N.from,E=N.to,x=N.l,N=N.r;Lt(g,w,E),x&&f(g,x),N&&f(g,N)}(c,u)}function Tr(c,u){var f=cn(u),g=f.next();if(g.done)return!1;for(var b=g.value,w=cn(c),E=w.next(b.from),x=E.value;!g.done&&!E.done;){if(xe(x.from,b.to)<=0&&0<=xe(x.to,b.from))return!0;xe(b.from,x.from)<0?b=(g=f.next(x.from)).value:x=(E=w.next(b.from)).value}return!1}function cn(c){var u=Mn(c)?null:{s:0,n:c};return{next:function(f){for(var g=0<arguments.length;u;)switch(u.s){case 0:if(u.s=1,g)for(;u.n.l&&xe(f,u.n.from)<0;)u={up:u,n:u.n.l,s:1};else for(;u.n.l;)u={up:u,n:u.n.l,s:1};case 1:if(u.s=2,!g||xe(f,u.n.to)<=0)return{value:u.n,done:!1};case 2:if(u.n.r){u.s=3,u={up:u,n:u.n.r,s:0};continue}case 3:u=u.up}return{done:!0}}}}function xr(c){var u,f,g=(((u=c.r)===null||u===void 0?void 0:u.d)||0)-(((f=c.l)===null||f===void 0?void 0:f.d)||0),b=1<g?"r":g<-1?"l":"";b&&(u=b=="r"?"l":"r",f=r({},c),g=c[b],c.from=g.from,c.to=g.to,c[b]=g[b],f[b]=g[u],(c[u]=f).d=Ar(f)),c.d=Ar(c)}function Ar(f){var u=f.r,f=f.l;return(u?f?Math.max(u.d,f.d):u.d:f?f.d:0)+1}function ln(c,u){return o(u).forEach(function(f){c[f]?Mt(c[f],u[f]):c[f]=function g(b){var w,E,x={};for(w in b)m(b,w)&&(E=b[w],x[w]=!E||typeof E!="object"||B.has(E.constructor)?E:g(E));return x}(u[f])}),c}function Hn(c,u){return c.all||u.all||Object.keys(c).some(function(f){return u[f]&&Tr(u[f],c[f])})}v(Fe.prototype,((ze={add:function(c){return Mt(this,c),this},addKey:function(c){return Lt(this,c,c),this},addKeys:function(c){var u=this;return c.forEach(function(f){return Lt(u,f,f)}),this},hasKey:function(c){var u=cn(this).next(c).value;return u&&xe(u.from,c)<=0&&0<=xe(u.to,c)}})[W]=function(){return cn(this)},ze));var yt={},Vn={},zn=!1;function un(c){ln(Vn,c),zn||(zn=!0,setTimeout(function(){zn=!1,jn(Vn,!(Vn={}))},0))}function jn(c,u){u===void 0&&(u=!1);var f=new Set;if(c.all)for(var g=0,b=Object.values(yt);g<b.length;g++)Rr(E=b[g],c,f,u);else for(var w in c){var E,x=/^idb\:\/\/(.*)\/(.*)\//.exec(w);x&&(w=x[1],x=x[2],(E=yt["idb://".concat(w,"/").concat(x)])&&Rr(E,c,f,u))}f.forEach(function(N){return N()})}function Rr(c,u,f,g){for(var b=[],w=0,E=Object.entries(c.queries.query);w<E.length;w++){for(var x=E[w],N=x[0],$=[],D=0,R=x[1];D<R.length;D++){var U=R[D];Hn(u,U.obsSet)?U.subscribers.forEach(function(K){return f.add(K)}):g&&$.push(U)}g&&b.push([N,$])}if(g)for(var C=0,P=b;C<P.length;C++){var I=P[C],N=I[0],$=I[1];c.queries.query[N]=$}}function Hi(c){var u=c._state,f=c._deps.indexedDB;if(u.isBeingOpened||c.idbdb)return u.dbReadyPromise.then(function(){return u.dbOpenError?Pe(u.dbOpenError):c});u.isBeingOpened=!0,u.dbOpenError=null,u.openComplete=!1;var g=u.openCanceller,b=Math.round(10*c.verno),w=!1;function E(){if(u.openCanceller!==g)throw new pe.DatabaseClosed("db.open() was cancelled")}function x(){return new fe(function(U,C){if(E(),!f)throw new pe.MissingAPI;var P=c.name,I=u.autoSchema||!b?f.open(P):f.open(P,b);if(!I)throw new pe.MissingAPI;I.onerror=Je(C),I.onblocked=Ce(c._fireOnBlocked),I.onupgradeneeded=Ce(function(K){var L;D=I.transaction,u.autoSchema&&!c._options.allowEmptyDB?(I.onerror=Ot,D.abort(),I.result.close(),(L=f.deleteDatabase(P)).onsuccess=L.onerror=Ce(function(){C(new pe.NoSuchDatabase("Database ".concat(P," doesnt exist")))})):(D.onerror=Je(C),K=K.oldVersion>Math.pow(2,62)?0:K.oldVersion,R=K<1,c.idbdb=I.result,w&&Li(c,D),Bi(c,K/10,D,C))},C),I.onsuccess=Ce(function(){D=null;var K,L,M,G,Y,se=c.idbdb=I.result,ue=q(se.objectStoreNames);if(0<ue.length)try{var re=se.transaction((G=ue).length===1?G[0]:G,"readonly");if(u.autoSchema)L=se,M=re,(K=c).verno=L.version/10,M=K._dbSchema=an(0,L,M),K._storeNames=q(L.objectStoreNames,0),rn(K,[K._allTables],o(M),M);else if(on(c,c._dbSchema,re),((Y=On(an(0,(Y=c).idbdb,re),Y._dbSchema)).add.length||Y.change.some(function(ce){return ce.add.length||ce.change.length}))&&!w)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),se.close(),b=se.version+1,w=!0,U(x());nn(c,re)}catch{}St.push(c),se.onversionchange=Ce(function(ce){u.vcFired=!0,c.on("versionchange").fire(ce)}),se.onclose=Ce(function(){c.close({disableAutoOpen:!1})}),R&&(Y=c._deps,re=P,se=Y.indexedDB,Y=Y.IDBKeyRange,Bn(se)||re===Yt||Fn(se,Y).put({name:re}).catch(Te)),U()},C)}).catch(function(U){switch(U?.name){case"UnknownError":if(0<u.PR1398_maxLoop)return u.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),x();break;case"VersionError":if(0<b)return b=0,x()}return fe.reject(U)})}var N,$=u.dbReadyResolve,D=null,R=!1;return fe.race([g,(typeof navigator>"u"?fe.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(U){function C(){return indexedDB.databases().finally(U)}N=setInterval(C,100),C()}).finally(function(){return clearInterval(N)}):Promise.resolve()).then(x)]).then(function(){return E(),u.onReadyBeingFired=[],fe.resolve(Ln(function(){return c.on.ready.fire(c.vip)})).then(function U(){if(0<u.onReadyBeingFired.length){var C=u.onReadyBeingFired.reduce(bn,Te);return u.onReadyBeingFired=[],fe.resolve(Ln(function(){return C(c.vip)})).then(U)}})}).finally(function(){u.openCanceller===g&&(u.onReadyBeingFired=null,u.isBeingOpened=!1)}).catch(function(U){u.dbOpenError=U;try{D&&D.abort()}catch{}return g===u.openCanceller&&c._close(),Pe(U)}).finally(function(){u.openComplete=!0,$()}).then(function(){var U;return R&&(U={},c.tables.forEach(function(C){C.schema.indexes.forEach(function(P){P.name&&(U["idb://".concat(c.name,"/").concat(C.name,"/").concat(P.name)]=new Fe(-1/0,[[[]]]))}),U["idb://".concat(c.name,"/").concat(C.name,"/")]=U["idb://".concat(c.name,"/").concat(C.name,"/:dels")]=new Fe(-1/0,[[[]]])}),st(Ut).fire(U),jn(U,!0)),c})}function Wn(c){function u(w){return c.next(w)}var f=b(u),g=b(function(w){return c.throw(w)});function b(w){return function(N){var x=w(N),N=x.value;return x.done?N:N&&typeof N.then=="function"?N.then(f,g):l(N)?Promise.all(N).then(f,g):f(N)}}return b(u)()}function hn(c,u,f){for(var g=l(c)?c.slice():[c],b=0;b<f;++b)g.push(u);return g}var Vi={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(c){return r(r({},c),{table:function(u){var f=c.table(u),g=f.schema,b={},w=[];function E(R,U,C){var P=Bt(R),I=b[P]=b[P]||[],K=R==null?0:typeof R=="string"?1:R.length,L=0<U,L=r(r({},C),{name:L?"".concat(P,"(virtual-from:").concat(C.name,")"):C.name,lowLevelIndex:C,isVirtual:L,keyTail:U,keyLength:K,extractKey:Dn(R),unique:!L&&C.unique});return I.push(L),L.isPrimaryKey||w.push(L),1<K&&E(K===2?R[0]:R.slice(0,K-1),U+1,C),I.sort(function(M,G){return M.keyTail-G.keyTail}),L}u=E(g.primaryKey.keyPath,0,g.primaryKey),b[":id"]=[u];for(var x=0,N=g.indexes;x<N.length;x++){var $=N[x];E($.keyPath,0,$)}function D(R){var U,C=R.query.index;return C.isVirtual?r(r({},R),{query:{index:C.lowLevelIndex,range:(U=R.query.range,C=C.keyTail,{type:U.type===1?2:U.type,lower:hn(U.lower,U.lowerOpen?c.MAX_KEY:c.MIN_KEY,C),lowerOpen:!0,upper:hn(U.upper,U.upperOpen?c.MIN_KEY:c.MAX_KEY,C),upperOpen:!0})}}):R}return r(r({},f),{schema:r(r({},g),{primaryKey:u,indexes:w,getIndexByKeyPath:function(R){return(R=b[Bt(R)])&&R[0]}}),count:function(R){return f.count(D(R))},query:function(R){return f.query(D(R))},openCursor:function(R){var U=R.query.index,C=U.keyTail,P=U.isVirtual,I=U.keyLength;return P?f.openCursor(D(R)).then(function(L){return L&&K(L)}):f.openCursor(R);function K(L){return Object.create(L,{continue:{value:function(M){M!=null?L.continue(hn(M,R.reverse?c.MAX_KEY:c.MIN_KEY,C)):R.unique?L.continue(L.key.slice(0,I).concat(R.reverse?c.MIN_KEY:c.MAX_KEY,C)):L.continue()}},continuePrimaryKey:{value:function(M,G){L.continuePrimaryKey(hn(M,c.MAX_KEY,C),G)}},primaryKey:{get:function(){return L.primaryKey}},key:{get:function(){var M=L.key;return I===1?M[0]:M.slice(0,I)}},value:{get:function(){return L.value}}})}}})}})}};function qn(c,u,f,g){return f=f||{},g=g||"",o(c).forEach(function(b){var w,E,x;m(u,b)?(w=c[b],E=u[b],typeof w=="object"&&typeof E=="object"&&w&&E?(x=V(w))!==V(E)?f[g+b]=u[b]:x==="Object"?qn(w,E,f,g+b+"."):w!==E&&(f[g+b]=u[b]):w!==E&&(f[g+b]=u[b])):f[g+b]=void 0}),o(u).forEach(function(b){m(c,b)||(f[g+b]=u[b])}),f}function Gn(c,u){return u.type==="delete"?u.keys:u.keys||u.values.map(c.extractKey)}var zi={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(c){return r(r({},c),{table:function(u){var f=c.table(u),g=f.schema.primaryKey;return r(r({},f),{mutate:function(b){var w=be.trans,E=w.table(u).hook,x=E.deleting,N=E.creating,$=E.updating;switch(b.type){case"add":if(N.fire===Te)break;return w._promise("readwrite",function(){return D(b)},!0);case"put":if(N.fire===Te&&$.fire===Te)break;return w._promise("readwrite",function(){return D(b)},!0);case"delete":if(x.fire===Te)break;return w._promise("readwrite",function(){return D(b)},!0);case"deleteRange":if(x.fire===Te)break;return w._promise("readwrite",function(){return function R(U,C,P){return f.query({trans:U,values:!1,query:{index:g,range:C},limit:P}).then(function(I){var K=I.result;return D({type:"delete",keys:K,trans:U}).then(function(L){return 0<L.numFailures?Promise.reject(L.failures[0]):K.length<P?{failures:[],numFailures:0,lastResult:void 0}:R(U,r(r({},C),{lower:K[K.length-1],lowerOpen:!0}),P)})})}(b.trans,b.range,1e4)},!0)}return f.mutate(b);function D(R){var U,C,P,I=be.trans,K=R.keys||Gn(g,R);if(!K)throw new Error("Keys missing");return(R=R.type==="add"||R.type==="put"?r(r({},R),{keys:K}):r({},R)).type!=="delete"&&(R.values=s([],R.values)),R.keys&&(R.keys=s([],R.keys)),U=f,P=K,((C=R).type==="add"?Promise.resolve([]):U.getMany({trans:C.trans,keys:P,cache:"immutable"})).then(function(L){var M=K.map(function(G,Y){var se,ue,re,ce=L[Y],he={onerror:null,onsuccess:null};return R.type==="delete"?x.fire.call(he,G,ce,I):R.type==="add"||ce===void 0?(se=N.fire.call(he,G,R.values[Y],I),G==null&&se!=null&&(R.keys[Y]=G=se,g.outbound||te(R.values[Y],g.keyPath,G))):(se=qn(ce,R.values[Y]),(ue=$.fire.call(he,se,G,ce,I))&&(re=R.values[Y],Object.keys(ue).forEach(function(le){m(re,le)?re[le]=ue[le]:te(re,le,ue[le])}))),he});return f.mutate(R).then(function(G){for(var Y=G.failures,se=G.results,ue=G.numFailures,G=G.lastResult,re=0;re<K.length;++re){var ce=(se||K)[re],he=M[re];ce==null?he.onerror&&he.onerror(Y[re]):he.onsuccess&&he.onsuccess(R.type==="put"&&L[re]?R.values[re]:ce)}return{failures:Y,results:se,numFailures:ue,lastResult:G}}).catch(function(G){return M.forEach(function(Y){return Y.onerror&&Y.onerror(G)}),Promise.reject(G)})})}}})}})}};function Nr(c,u,f){try{if(!u||u.keys.length<c.length)return null;for(var g=[],b=0,w=0;b<u.keys.length&&w<c.length;++b)xe(u.keys[b],c[w])===0&&(g.push(f?j(u.values[b]):u.values[b]),++w);return g.length===c.length?g:null}catch{return null}}var ji={stack:"dbcore",level:-1,create:function(c){return{table:function(u){var f=c.table(u);return r(r({},f),{getMany:function(g){if(!g.cache)return f.getMany(g);var b=Nr(g.keys,g.trans._cache,g.cache==="clone");return b?fe.resolve(b):f.getMany(g).then(function(w){return g.trans._cache={keys:g.keys,values:g.cache==="clone"?j(w):w},w})},mutate:function(g){return g.type!=="add"&&(g.trans._cache=null),f.mutate(g)}})}}}};function $r(c,u){return c.trans.mode==="readonly"&&!!c.subscr&&!c.trans.explicit&&c.trans.db._options.cache!=="disabled"&&!u.schema.primaryKey.outbound}function Cr(c,u){switch(c){case"query":return u.values&&!u.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Wi={stack:"dbcore",level:0,name:"Observability",create:function(c){var u=c.schema.name,f=new Fe(c.MIN_KEY,c.MAX_KEY);return r(r({},c),{transaction:function(g,b,w){if(be.subscr&&b!=="readonly")throw new pe.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(be.querier));return c.transaction(g,b,w)},table:function(g){var b=c.table(g),w=b.schema,E=w.primaryKey,R=w.indexes,x=E.extractKey,N=E.outbound,$=E.autoIncrement&&R.filter(function(C){return C.compound&&C.keyPath.includes(E.keyPath)}),D=r(r({},b),{mutate:function(C){function P(le){return le="idb://".concat(u,"/").concat(g,"/").concat(le),G[le]||(G[le]=new Fe)}var I,K,L,M=C.trans,G=C.mutatedParts||(C.mutatedParts={}),Y=P(""),se=P(":dels"),ue=C.type,he=C.type==="deleteRange"?[C.range]:C.type==="delete"?[C.keys]:C.values.length<50?[Gn(E,C).filter(function(le){return le}),C.values]:[],re=he[0],ce=he[1],he=C.trans._cache;return l(re)?(Y.addKeys(re),(he=ue==="delete"||re.length===ce.length?Nr(re,he):null)||se.addKeys(re),(he||ce)&&(I=P,K=he,L=ce,w.indexes.forEach(function(le){var ge=I(le.name||"");function Ee(Se){return Se!=null?le.extractKey(Se):null}function ke(Se){return le.multiEntry&&l(Se)?Se.forEach(function(Ve){return ge.addKey(Ve)}):ge.addKey(Se)}(K||L).forEach(function(Se,Be){var _e=K&&Ee(K[Be]),Be=L&&Ee(L[Be]);xe(_e,Be)!==0&&(_e!=null&&ke(_e),Be!=null&&ke(Be))})}))):re?(ce={from:(ce=re.lower)!==null&&ce!==void 0?ce:c.MIN_KEY,to:(ce=re.upper)!==null&&ce!==void 0?ce:c.MAX_KEY},se.add(ce),Y.add(ce)):(Y.add(f),se.add(f),w.indexes.forEach(function(le){return P(le.name).add(f)})),b.mutate(C).then(function(le){return!re||C.type!=="add"&&C.type!=="put"||(Y.addKeys(le.results),$&&$.forEach(function(ge){for(var Ee=C.values.map(function(_e){return ge.extractKey(_e)}),ke=ge.keyPath.findIndex(function(_e){return _e===E.keyPath}),Se=0,Ve=le.results.length;Se<Ve;++Se)Ee[Se][ke]=le.results[Se];P(ge.name).addKeys(Ee)})),M.mutatedParts=ln(M.mutatedParts||{},G),le})}}),R=function(P){var I=P.query,P=I.index,I=I.range;return[P,new Fe((P=I.lower)!==null&&P!==void 0?P:c.MIN_KEY,(I=I.upper)!==null&&I!==void 0?I:c.MAX_KEY)]},U={get:function(C){return[E,new Fe(C.key)]},getMany:function(C){return[E,new Fe().addKeys(C.keys)]},count:R,query:R,openCursor:R};return o(U).forEach(function(C){D[C]=function(P){var I=be.subscr,K=!!I,L=$r(be,b)&&Cr(C,P)?P.obsSet={}:I;if(K){var M=function(ce){return ce="idb://".concat(u,"/").concat(g,"/").concat(ce),L[ce]||(L[ce]=new Fe)},G=M(""),Y=M(":dels"),I=U[C](P),K=I[0],I=I[1];if((C==="query"&&K.isPrimaryKey&&!P.values?Y:M(K.name||"")).add(I),!K.isPrimaryKey){if(C!=="count"){var se=C==="query"&&N&&P.values&&b.query(r(r({},P),{values:!1}));return b[C].apply(this,arguments).then(function(ce){if(C==="query"){if(N&&P.values)return se.then(function(Ee){return Ee=Ee.result,G.addKeys(Ee),ce});var he=P.values?ce.result.map(x):ce.result;(P.values?G:Y).addKeys(he)}else if(C==="openCursor"){var le=ce,ge=P.values;return le&&Object.create(le,{key:{get:function(){return Y.addKey(le.primaryKey),le.key}},primaryKey:{get:function(){var Ee=le.primaryKey;return Y.addKey(Ee),Ee}},value:{get:function(){return ge&&G.addKey(le.primaryKey),le.value}}})}return ce})}Y.add(f)}}return b[C].apply(this,arguments)}}),D}})}};function Pr(c,u,f){if(f.numFailures===0)return u;if(u.type==="deleteRange")return null;var g=u.keys?u.keys.length:"values"in u&&u.values?u.values.length:1;return f.numFailures===g?null:(u=r({},u),l(u.keys)&&(u.keys=u.keys.filter(function(b,w){return!(w in f.failures)})),"values"in u&&l(u.values)&&(u.values=u.values.filter(function(b,w){return!(w in f.failures)})),u)}function Jn(c,u){return f=c,((g=u).lower===void 0||(g.lowerOpen?0<xe(f,g.lower):0<=xe(f,g.lower)))&&(c=c,(u=u).upper===void 0||(u.upperOpen?xe(c,u.upper)<0:xe(c,u.upper)<=0));var f,g}function Ir(c,u,U,g,b,w){if(!U||U.length===0)return c;var E=u.query.index,x=E.multiEntry,N=u.query.range,$=g.schema.primaryKey.extractKey,D=E.extractKey,R=(E.lowLevelIndex||E).extractKey,U=U.reduce(function(C,P){var I=C,K=[];if(P.type==="add"||P.type==="put")for(var L=new Fe,M=P.values.length-1;0<=M;--M){var G,Y=P.values[M],se=$(Y);L.hasKey(se)||(G=D(Y),(x&&l(G)?G.some(function(le){return Jn(le,N)}):Jn(G,N))&&(L.addKey(se),K.push(Y)))}switch(P.type){case"add":var ue=new Fe().addKeys(u.values?C.map(function(ge){return $(ge)}):C),I=C.concat(u.values?K.filter(function(ge){return ge=$(ge),!ue.hasKey(ge)&&(ue.addKey(ge),!0)}):K.map(function(ge){return $(ge)}).filter(function(ge){return!ue.hasKey(ge)&&(ue.addKey(ge),!0)}));break;case"put":var re=new Fe().addKeys(P.values.map(function(ge){return $(ge)}));I=C.filter(function(ge){return!re.hasKey(u.values?$(ge):ge)}).concat(u.values?K:K.map(function(ge){return $(ge)}));break;case"delete":var ce=new Fe().addKeys(P.keys);I=C.filter(function(ge){return!ce.hasKey(u.values?$(ge):ge)});break;case"deleteRange":var he=P.range;I=C.filter(function(ge){return!Jn($(ge),he)})}return I},c);return U===c?c:(U.sort(function(C,P){return xe(R(C),R(P))||xe($(C),$(P))}),u.limit&&u.limit<1/0&&(U.length>u.limit?U.length=u.limit:c.length===u.limit&&U.length<u.limit&&(b.dirty=!0)),w?Object.freeze(U):U)}function Dr(c,u){return xe(c.lower,u.lower)===0&&xe(c.upper,u.upper)===0&&!!c.lowerOpen==!!u.lowerOpen&&!!c.upperOpen==!!u.upperOpen}function qi(c,u){return function(f,g,b,w){if(f===void 0)return g!==void 0?-1:0;if(g===void 0)return 1;if((g=xe(f,g))===0){if(b&&w)return 0;if(b)return 1;if(w)return-1}return g}(c.lower,u.lower,c.lowerOpen,u.lowerOpen)<=0&&0<=function(f,g,b,w){if(f===void 0)return g!==void 0?1:0;if(g===void 0)return-1;if((g=xe(f,g))===0){if(b&&w)return 0;if(b)return-1;if(w)return 1}return g}(c.upper,u.upper,c.upperOpen,u.upperOpen)}function Gi(c,u,f,g){c.subscribers.add(f),g.addEventListener("abort",function(){var b,w;c.subscribers.delete(f),c.subscribers.size===0&&(b=c,w=u,setTimeout(function(){b.subscribers.size===0&&oe(w,b)},3e3))})}var Ji={stack:"dbcore",level:0,name:"Cache",create:function(c){var u=c.schema.name;return r(r({},c),{transaction:function(f,g,b){var w,E,x=c.transaction(f,g,b);return g==="readwrite"&&(E=(w=new AbortController).signal,b=function(N){return function(){if(w.abort(),g==="readwrite"){for(var $=new Set,D=0,R=f;D<R.length;D++){var U=R[D],C=yt["idb://".concat(u,"/").concat(U)];if(C){var P=c.table(U),I=C.optimisticOps.filter(function(ge){return ge.trans===x});if(x._explicit&&N&&x.mutatedParts)for(var K=0,L=Object.values(C.queries.query);K<L.length;K++)for(var M=0,G=(ue=L[K]).slice();M<G.length;M++)Hn((re=G[M]).obsSet,x.mutatedParts)&&(oe(ue,re),re.subscribers.forEach(function(ge){return $.add(ge)}));else if(0<I.length){C.optimisticOps=C.optimisticOps.filter(function(ge){return ge.trans!==x});for(var Y=0,se=Object.values(C.queries.query);Y<se.length;Y++)for(var ue,re,ce,he=0,le=(ue=se[Y]).slice();he<le.length;he++)(re=le[he]).res!=null&&x.mutatedParts&&(N&&!re.dirty?(ce=Object.isFrozen(re.res),ce=Ir(re.res,re.req,I,P,re,ce),re.dirty?(oe(ue,re),re.subscribers.forEach(function(ge){return $.add(ge)})):ce!==re.res&&(re.res=ce,re.promise=fe.resolve({result:ce}))):(re.dirty&&oe(ue,re),re.subscribers.forEach(function(ge){return $.add(ge)})))}}}$.forEach(function(ge){return ge()})}}},x.addEventListener("abort",b(!1),{signal:E}),x.addEventListener("error",b(!1),{signal:E}),x.addEventListener("complete",b(!0),{signal:E})),x},table:function(f){var g=c.table(f),b=g.schema.primaryKey;return r(r({},g),{mutate:function(w){var E=be.trans;if(b.outbound||E.db._options.cache==="disabled"||E.explicit||E.idbtrans.mode!=="readwrite")return g.mutate(w);var x=yt["idb://".concat(u,"/").concat(f)];return x?(E=g.mutate(w),w.type!=="add"&&w.type!=="put"||!(50<=w.values.length||Gn(b,w).some(function(N){return N==null}))?(x.optimisticOps.push(w),w.mutatedParts&&un(w.mutatedParts),E.then(function(N){0<N.numFailures&&(oe(x.optimisticOps,w),(N=Pr(0,w,N))&&x.optimisticOps.push(N),w.mutatedParts&&un(w.mutatedParts))}),E.catch(function(){oe(x.optimisticOps,w),w.mutatedParts&&un(w.mutatedParts)})):E.then(function(N){var $=Pr(0,r(r({},w),{values:w.values.map(function(D,R){var U;return N.failures[R]?D:(D=(U=b.keyPath)!==null&&U!==void 0&&U.includes(".")?j(D):r({},D),te(D,b.keyPath,N.results[R]),D)})}),N);x.optimisticOps.push($),queueMicrotask(function(){return w.mutatedParts&&un(w.mutatedParts)})}),E):g.mutate(w)},query:function(w){if(!$r(be,g)||!Cr("query",w))return g.query(w);var E=(($=be.trans)===null||$===void 0?void 0:$.db._options.cache)==="immutable",R=be,x=R.requery,N=R.signal,$=function(P,I,K,L){var M=yt["idb://".concat(P,"/").concat(I)];if(!M)return[];if(!(I=M.queries[K]))return[null,!1,M,null];var G=I[(L.query?L.query.index.name:null)||""];if(!G)return[null,!1,M,null];switch(K){case"query":var Y=G.find(function(se){return se.req.limit===L.limit&&se.req.values===L.values&&Dr(se.req.query.range,L.query.range)});return Y?[Y,!0,M,G]:[G.find(function(se){return("limit"in se.req?se.req.limit:1/0)>=L.limit&&(!L.values||se.req.values)&&qi(se.req.query.range,L.query.range)}),!1,M,G];case"count":return Y=G.find(function(se){return Dr(se.req.query.range,L.query.range)}),[Y,!!Y,M,G]}}(u,f,"query",w),D=$[0],R=$[1],U=$[2],C=$[3];return D&&R?D.obsSet=w.obsSet:(R=g.query(w).then(function(P){var I=P.result;if(D&&(D.res=I),E){for(var K=0,L=I.length;K<L;++K)Object.freeze(I[K]);Object.freeze(I)}else P.result=j(I);return P}).catch(function(P){return C&&D&&oe(C,D),Promise.reject(P)}),D={obsSet:w.obsSet,promise:R,subscribers:new Set,type:"query",req:w,dirty:!1},C?C.push(D):(C=[D],(U=U||(yt["idb://".concat(u,"/").concat(f)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[w.query.index.name||""]=C)),Gi(D,C,x,N),D.promise.then(function(P){return{result:Ir(P.result,w,U?.optimisticOps,g,D,E)}})}})}})}};function dn(c,u){return new Proxy(c,{get:function(f,g,b){return g==="db"?u:Reflect.get(f,g,b)}})}var Xe=(Ie.prototype.version=function(c){if(isNaN(c)||c<.1)throw new pe.Type("Given version is not a positive number");if(c=Math.round(10*c)/10,this.idbdb||this._state.isBeingOpened)throw new pe.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,c);var u=this._versions,f=u.filter(function(g){return g._cfg.version===c})[0];return f||(f=new this.Version(c),u.push(f),u.sort(Fi),f.stores({}),this._state.autoSchema=!1,f)},Ie.prototype._whenReady=function(c){var u=this;return this.idbdb&&(this._state.openComplete||be.letThrough||this._vip)?c():new fe(function(f,g){if(u._state.openComplete)return g(new pe.DatabaseClosed(u._state.dbOpenError));if(!u._state.isBeingOpened){if(!u._state.autoOpen)return void g(new pe.DatabaseClosed);u.open().catch(Te)}u._state.dbReadyPromise.then(f,g)}).then(c)},Ie.prototype.use=function(c){var u=c.stack,f=c.create,g=c.level,b=c.name;return b&&this.unuse({stack:u,name:b}),c=this._middlewares[u]||(this._middlewares[u]=[]),c.push({stack:u,create:f,level:g??10,name:b}),c.sort(function(w,E){return w.level-E.level}),this},Ie.prototype.unuse=function(c){var u=c.stack,f=c.name,g=c.create;return u&&this._middlewares[u]&&(this._middlewares[u]=this._middlewares[u].filter(function(b){return g?b.create!==g:!!f&&b.name!==f})),this},Ie.prototype.open=function(){var c=this;return dt(et,function(){return Hi(c)})},Ie.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var c=this._state,u=St.indexOf(this);if(0<=u&&St.splice(u,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}c.isBeingOpened||(c.dbReadyPromise=new fe(function(f){c.dbReadyResolve=f}),c.openCanceller=new fe(function(f,g){c.cancelOpen=g}))},Ie.prototype.close=function(f){var u=(f===void 0?{disableAutoOpen:!0}:f).disableAutoOpen,f=this._state;u?(f.isBeingOpened&&f.cancelOpen(new pe.DatabaseClosed),this._close(),f.autoOpen=!1,f.dbOpenError=new pe.DatabaseClosed):(this._close(),f.autoOpen=this._options.autoOpen||f.isBeingOpened,f.openComplete=!1,f.dbOpenError=null)},Ie.prototype.delete=function(c){var u=this;c===void 0&&(c={disableAutoOpen:!0});var f=0<arguments.length&&typeof arguments[0]!="object",g=this._state;return new fe(function(b,w){function E(){u.close(c);var x=u._deps.indexedDB.deleteDatabase(u.name);x.onsuccess=Ce(function(){var N,$,D;N=u._deps,$=u.name,D=N.indexedDB,N=N.IDBKeyRange,Bn(D)||$===Yt||Fn(D,N).delete($).catch(Te),b()}),x.onerror=Je(w),x.onblocked=u._fireOnBlocked}if(f)throw new pe.InvalidArgument("Invalid closeOptions argument to db.delete()");g.isBeingOpened?g.dbReadyPromise.then(E):E()})},Ie.prototype.backendDB=function(){return this.idbdb},Ie.prototype.isOpen=function(){return this.idbdb!==null},Ie.prototype.hasBeenClosed=function(){var c=this._state.dbOpenError;return c&&c.name==="DatabaseClosed"},Ie.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ie.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ie.prototype,"tables",{get:function(){var c=this;return o(this._allTables).map(function(u){return c._allTables[u]})},enumerable:!1,configurable:!0}),Ie.prototype.transaction=function(){var c=function(u,f,g){var b=arguments.length;if(b<2)throw new pe.InvalidArgument("Too few arguments");for(var w=new Array(b-1);--b;)w[b-1]=arguments[b];return g=w.pop(),[u,me(w),g]}.apply(this,arguments);return this._transaction.apply(this,c)},Ie.prototype._transaction=function(c,u,f){var g=this,b=be.trans;b&&b.db===this&&c.indexOf("!")===-1||(b=null);var w,E,x=c.indexOf("?")!==-1;c=c.replace("!","").replace("?","");try{if(E=u.map(function($){if($=$ instanceof g.Table?$.name:$,typeof $!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return $}),c=="r"||c===An)w=An;else{if(c!="rw"&&c!=Rn)throw new pe.InvalidArgument("Invalid transaction mode: "+c);w=Rn}if(b){if(b.mode===An&&w===Rn){if(!x)throw new pe.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");b=null}b&&E.forEach(function($){if(b&&b.storeNames.indexOf($)===-1){if(!x)throw new pe.SubTransaction("Table "+$+" not included in parent transaction.");b=null}}),x&&b&&!b.active&&(b=null)}}catch($){return b?b._promise(null,function(D,R){R($)}):Pe($)}var N=function $(D,R,U,C,P){return fe.resolve().then(function(){var I=be.transless||be,K=D._createTransaction(R,U,D._dbSchema,C);if(K.explicit=!0,I={trans:K,transless:I},C)K.idbtrans=C.idbtrans;else try{K.create(),K.idbtrans._explicit=!0,D._state.PR1398_maxLoop=3}catch(G){return G.name===De.InvalidState&&D.isOpen()&&0<--D._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),D.close({disableAutoOpen:!1}),D.open().then(function(){return $(D,R,U,null,P)})):Pe(G)}var L,M=X(P);return M&&kt(),I=fe.follow(function(){var G;(L=P.call(K,K))&&(M?(G=nt.bind(null,null),L.then(G,G)):typeof L.next=="function"&&typeof L.throw=="function"&&(L=Wn(L)))},I),(L&&typeof L.then=="function"?fe.resolve(L).then(function(G){return K.active?G:Pe(new pe.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):I.then(function(){return L})).then(function(G){return C&&K._resolve(),K._completion.then(function(){return G})}).catch(function(G){return K._reject(G),Pe(G)})})}.bind(null,this,w,E,b,f);return b?b._promise(w,N,"lock"):be.trans?dt(be.transless,function(){return g._whenReady(N)}):this._whenReady(N)},Ie.prototype.table=function(c){if(!m(this._allTables,c))throw new pe.InvalidTable("Table ".concat(c," does not exist"));return this._allTables[c]},Ie);function Ie(c,u){var f=this;this._middlewares={},this.verno=0;var g=Ie.dependencies;this._options=u=r({addons:Ie.addons,autoOpen:!0,indexedDB:g.indexedDB,IDBKeyRange:g.IDBKeyRange,cache:"cloned"},u),this._deps={indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange},g=u.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var b,w,E,x,N,$={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Te,dbReadyPromise:null,cancelOpen:Te,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:u.autoOpen};$.dbReadyPromise=new fe(function(R){$.dbReadyResolve=R}),$.openCanceller=new fe(function(R,U){$.cancelOpen=U}),this._state=$,this.name=c,this.on=Dt(this,"populate","blocked","versionchange","close",{ready:[bn,Te]}),this.once=function(R,U){var C=function(){for(var P=[],I=0;I<arguments.length;I++)P[I]=arguments[I];f.on(R).unsubscribe(C),U.apply(f,P)};return f.on(R,C)},this.on.ready.subscribe=z(this.on.ready.subscribe,function(R){return function(U,C){Ie.vip(function(){var P,I=f._state;I.openComplete?(I.dbOpenError||fe.resolve().then(U),C&&R(U)):I.onReadyBeingFired?(I.onReadyBeingFired.push(U),C&&R(U)):(R(U),P=f,C||R(function K(){P.on.ready.unsubscribe(U),P.on.ready.unsubscribe(K)}))})}}),this.Collection=(b=this,Kt(Ci.prototype,function(L,K){this.db=b;var C=lr,P=null;if(K)try{C=K()}catch(M){P=M}var I=L._ctx,K=I.table,L=K.hook.reading.fire;this._ctx={table:K,index:I.index,isPrimKey:!I.index||K.schema.primKey.keyPath&&I.index===K.schema.primKey.name,range:C,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:P,or:I.or,valueMapper:L!==je?L:null}})),this.Table=(w=this,Kt(yr.prototype,function(R,U,C){this.db=w,this._tx=C,this.name=R,this.schema=U,this.hook=w._allTables[R]?w._allTables[R].hook:Dt(null,{creating:[Ei,Te],reading:[Qe,je],updating:[Si,Te],deleting:[ki,Te]})})),this.Transaction=(E=this,Kt(Di.prototype,function(R,U,C,P,I){var K=this;R!=="readonly"&&U.forEach(function(L){L=(L=C[L])===null||L===void 0?void 0:L.yProps,L&&(U=U.concat(L.map(function(M){return M.updatesTable})))}),this.db=E,this.mode=R,this.storeNames=U,this.schema=C,this.chromeTransactionDurability=P,this.idbtrans=null,this.on=Dt(this,"complete","error","abort"),this.parent=I||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new fe(function(L,M){K._resolve=L,K._reject=M}),this._completion.then(function(){K.active=!1,K.on.complete.fire()},function(L){var M=K.active;return K.active=!1,K.on.error.fire(L),K.parent?K.parent._reject(L):M&&K.idbtrans&&K.idbtrans.abort(),Pe(L)})})),this.Version=(x=this,Kt(Mi.prototype,function(R){this.db=x,this._cfg={version:R,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(N=this,Kt(wr.prototype,function(R,U,C){if(this.db=N,this._ctx={table:R,index:U===":id"?null:U,or:C},this._cmp=this._ascending=xe,this._descending=function(P,I){return xe(I,P)},this._max=function(P,I){return 0<xe(P,I)?P:I},this._min=function(P,I){return xe(P,I)<0?P:I},this._IDBKeyRange=N._deps.IDBKeyRange,!this._IDBKeyRange)throw new pe.MissingAPI})),this.on("versionchange",function(R){0<R.newVersion?console.warn("Another connection wants to upgrade database '".concat(f.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(f.name,"'. Closing db now to resume the delete request.")),f.close({disableAutoOpen:!1})}),this.on("blocked",function(R){!R.newVersion||R.newVersion<R.oldVersion?console.warn("Dexie.delete('".concat(f.name,"') was blocked")):console.warn("Upgrade '".concat(f.name,"' blocked by other connection holding version ").concat(R.oldVersion/10))}),this._maxKey=Ft(u.IDBKeyRange),this._createTransaction=function(R,U,C,P){return new f.Transaction(R,U,C,f._options.chromeTransactionDurability,P)},this._fireOnBlocked=function(R){f.on("blocked").fire(R),St.filter(function(U){return U.name===f.name&&U!==f&&!U._state.vcFired}).map(function(U){return U.on("versionchange").fire(R)})},this.use(ji),this.use(Ji),this.use(Wi),this.use(Vi),this.use(zi);var D=new Proxy(this,{get:function(R,U,C){if(U==="_vip")return!0;if(U==="table")return function(I){return dn(f.table(I),D)};var P=Reflect.get(R,U,C);return P instanceof yr?dn(P,D):U==="tables"?P.map(function(I){return dn(I,D)}):U==="_createTransaction"?function(){return dn(P.apply(this,arguments),D)}:P}});this.vip=D,g.forEach(function(R){return R(f)})}var fn,ze=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Yi=(Yn.prototype.subscribe=function(c,u,f){return this._subscribe(c&&typeof c!="function"?c:{next:c,error:u,complete:f})},Yn.prototype[ze]=function(){return this},Yn);function Yn(c){this._subscribe=c}try{fn={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{fn={indexedDB:null,IDBKeyRange:null}}function Kr(c){var u,f=!1,g=new Yi(function(b){var w=X(c),E,x=!1,N={},$={},D={get closed(){return x},unsubscribe:function(){x||(x=!0,E&&E.abort(),R&&st.storagemutated.unsubscribe(C))}};b.start&&b.start(D);var R=!1,U=function(){return xn(P)},C=function(I){ln(N,I),Hn($,N)&&U()},P=function(){var I,K,L;!x&&fn.indexedDB&&(N={},I={},E&&E.abort(),E=new AbortController,L=function(M){var G=_t();try{w&&kt();var Y=tt(c,M);return Y=w?Y.finally(nt):Y}finally{G&&Et()}}(K={subscr:I,signal:E.signal,requery:U,querier:c,trans:null}),Promise.resolve(L).then(function(M){f=!0,u=M,x||K.signal.aborted||(N={},function(G){for(var Y in G)if(m(G,Y))return;return 1}($=I)||R||(st(Ut,C),R=!0),xn(function(){return!x&&b.next&&b.next(M)}))},function(M){f=!1,["DatabaseClosedError","AbortError"].includes(M?.name)||x||xn(function(){x||b.error&&b.error(M)})}))};return setTimeout(U,0),D});return g.hasValue=function(){return f},g.getValue=function(){return u},g}var gt=Xe;function Zn(c){var u=at;try{at=!0,st.storagemutated.fire(c),jn(c,!0)}finally{at=u}}v(gt,r(r({},We),{delete:function(c){return new gt(c,{addons:[]}).delete()},exists:function(c){return new gt(c,{addons:[]}).open().then(function(u){return u.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(c){try{return u=gt.dependencies,f=u.indexedDB,u=u.IDBKeyRange,(Bn(f)?Promise.resolve(f.databases()).then(function(g){return g.map(function(b){return b.name}).filter(function(b){return b!==Yt})}):Fn(f,u).toCollection().primaryKeys()).then(c)}catch{return Pe(new pe.MissingAPI)}var u,f},defineClass:function(){return function(c){h(this,c)}},ignoreTransaction:function(c){return be.trans?dt(be.transless,c):c()},vip:Ln,async:function(c){return function(){try{var u=Wn(c.apply(this,arguments));return u&&typeof u.then=="function"?u:fe.resolve(u)}catch(f){return Pe(f)}}},spawn:function(c,u,f){try{var g=Wn(c.apply(f,u||[]));return g&&typeof g.then=="function"?g:fe.resolve(g)}catch(b){return Pe(b)}},currentTransaction:{get:function(){return be.trans||null}},waitFor:function(c,u){return u=fe.resolve(typeof c=="function"?gt.ignoreTransaction(c):c).timeout(u||6e4),be.trans?be.trans.waitFor(u):u},Promise:fe,debug:{get:function(){return Ge},set:function(c){nr(c)}},derive:T,extend:h,props:v,override:z,Events:Dt,on:st,liveQuery:Kr,extendObservabilitySet:ln,getByKeyPath:ie,setByKeyPath:te,delByKeyPath:function(c,u){typeof u=="string"?te(c,u,void 0):"length"in u&&[].map.call(u,function(f){te(c,f,void 0)})},shallowClone:ae,deepClone:j,getObjectDiff:qn,cmp:xe,asap:ye,minKey:-1/0,addons:[],connections:St,errnames:De,dependencies:fn,cache:yt,semVer:"4.2.1",version:"4.2.1".split(".").map(function(c){return parseInt(c)}).reduce(function(c,u,f){return c+u/Math.pow(10,2*f)})})),gt.maxKey=Ft(gt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(st(Ut,function(c){at||(c=new CustomEvent(Cn,{detail:c}),at=!0,dispatchEvent(c),at=!1)}),addEventListener(Cn,function(c){c=c.detail,at||Zn(c)}));var Rt,at=!1,Or=function(){};return typeof BroadcastChannel<"u"&&((Or=function(){(Rt=new BroadcastChannel(Cn)).onmessage=function(c){return c.data&&Zn(c.data)}})(),typeof Rt.unref=="function"&&Rt.unref(),st(Ut,function(c){at||Rt.postMessage(c)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(c){if(!Xe.disableBfCache&&c.persisted){Ge&&console.debug("Dexie: handling persisted pagehide"),Rt?.close();for(var u=0,f=St;u<f.length;u++)f[u].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(c){!Xe.disableBfCache&&c.persisted&&(Ge&&console.debug("Dexie: handling persisted pageshow"),Or(),Zn({all:new Fe(-1/0,[[]])}))})),fe.rejectionMapper=function(c,u){return!c||c instanceof ve||c instanceof TypeError||c instanceof SyntaxError||!c.name||!wt[c.name]?c:(u=new wt[c.name](u||c.message,c),"stack"in c&&S(u,"stack",{get:function(){return this.inner.stack}}),u)},nr(Ge),r(Xe,Object.freeze({__proto__:null,Dexie:Xe,liveQuery:Kr,Entity:ur,cmp:xe,PropModification:It,replacePrefix:function(c,u){return new It({replacePrefix:[c,u]})},add:function(c){return new It({add:c})},remove:function(c){return new It({remove:c})},default:Xe,RangeSet:Fe,mergeRanges:Mt,rangesOverlap:Tr}),{default:Xe}),Xe})})(dexie_min);var dexie_minExports=dexie_min.exports;const _Dexie=getDefaultExportFromCjs(dexie_minExports),DexieSymbol=Symbol.for("Dexie"),Dexie=globalThis[DexieSymbol]||(globalThis[DexieSymbol]=_Dexie);if(_Dexie.semVer!==Dexie.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${_Dexie.semVer} and ${Dexie.semVer}`);const{liveQuery,mergeRanges,rangesOverlap,RangeSet,cmp,Entity,PropModification,replacePrefix,add,remove,DexieYProvider}=Dexie;async function eventTagsWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.add(r.tagValue,r.eventId,!1)}var eventTagsDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);if(o)for(const l of o)s.push({tagValue:a,eventId:l})}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await t.bulkPut(s)),n.clear()};async function eventsWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.id,r,!1)}var eventsDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);o&&s.push(o)}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await t.bulkPut(s)),n.clear()};async function nip05WarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.nip05,r,!1)}var nip05Dump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);o&&s.push({nip05:a,...o})}s.length&&(e(`Saving ${s.length} NIP-05 cache entries to database`),await t.bulkPut(s)),n.clear()},Database=class extends Dexie{profiles;events;eventTags;nip05;lnurl;relayStatus;unpublishedEvents;constructor(t){super(t),this.version(15).stores({profiles:"&pubkey",events:"&id, kind",eventTags:"&tagValue",nip05:"&nip05",lnurl:"&pubkey",relayStatus:"&url",unpublishedEvents:"&id"})}},db;function createDatabase(t){db=new Database(t)}var d=createDebug2("ndk:dexie-adapter:profiles");async function profilesWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n){const s=r;t.set(r.pubkey,s,!1)}d("Loaded %d profiles from database",t.size())}var profilesDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);o&&s.push(o)}s.length&&(e(`Saving ${s.length} users to database`),await t.bulkPut(s)),n.clear()};async function relayInfoWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.url,{url:r.url,updatedAt:r.updatedAt,lastConnectedAt:r.lastConnectedAt,dontConnectBefore:r.dontConnectBefore},!1)}var relayInfoDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);o&&s.push({url:a,updatedAt:o.updatedAt,lastConnectedAt:o.lastConnectedAt,dontConnectBefore:o.dontConnectBefore})}s.length>0&&(e(`Saving ${s.length} relay status cache entries to database`),await t.bulkPut(s)),n.clear()},WRITE_STATUS_THRESHOLD=3;async function unpublishedEventsWarmUp(t,e){await e.each(n=>{t.set(n.event.id,n,!1)})}function unpublishedEventsDump(t,e){return async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);o&&s.push(o)}s.length>0&&(e(`Saving ${s.length} unpublished events cache entries to database`),await t.bulkPut(s)),n.clear()}}async function discardUnpublishedEvent(t,e){await t.delete(e)}async function getUnpublishedEvents(t){const e=[];return await t.each(n=>{e.push({event:new NDKEvent(void 0,n.event),relays:Object.keys(n.relays),lastTryAt:n.lastTryAt})}),e}function addUnpublishedEvent(t,e){const n={};e.forEach(s=>n[s]=!1),this.unpublishedEvents.set(t.id,{id:t.id,event:t.rawEvent(),relays:n});const r=s=>{const a=s.url,o=this.unpublishedEvents.get(t.id);if(!o){t.off("publushed",r);return}o.relays[a]=!0,this.unpublishedEvents.set(t.id,o);const l=Object.values(o.relays).filter(y=>y).length,h=Object.values(o.relays).length-l;(l>=WRITE_STATUS_THRESHOLD||h===0)&&(this.unpublishedEvents.delete(t.id),t.off("published",r))};t.on("published",r)}async function zapperWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.pubkey,{document:r.document,fetchedAt:r.fetchedAt},!1)}var zapperDump=(t,e)=>async(n,r)=>{const s=[];for(const a of n){const o=r.get(a);o&&s.push({pubkey:a,...o})}s.length&&(e(`Saving ${s.length} zapper cache entries to database`),await t.bulkPut(s)),n.clear()},CacheHandler=class{cache;dirtyKeys=new Set;options;debug;indexes;isSet=!1;maxSize=0;constructor(t){this.debug=t.debug,this.options=t,this.maxSize=t.maxSize,t.maxSize>0&&(this.cache=new dist.LRUCache({maxSize:t.maxSize}),setInterval(()=>this.dump().catch(console.error),1e3*10)),this.indexes=new Map}getSet(t){return this.cache?.get(t)}getAllWithFilter(t){const e=new Map;return this.cache?.forEach((n,r)=>{t(r,n)&&e.set(r,n)}),e}get(t){return this.cache?.get(t)}async getWithFallback(t,e){let n=this.get(t);return n||(n=await e.get(t),n&&this.set(t,n)),n}async getManyWithFallback(t,e){const n=[],r=[];for(const s of t){const a=this.get(s);a?n.push(a):r.push(s)}if(n.length>0&&this.debug(`Cache hit for keys ${n.length} and miss for ${r.length} keys`),r.length>0){const s=Date.now(),a=await e.bulkGet(r),o=Date.now();let l=0;for(const h of a)h&&(this.set(h.id,h),n.push(h),l++);this.debug(`Time spent querying database: ${o-s}ms for ${r.length} keys, which added ${l} entries to the cache`)}return n}add(t,e,n=!0){const r=this.get(t)??new Set;r.add(e),this.cache?.set(t,r),n&&this.dirtyKeys.add(t)}set(t,e,n=!0){this.cache?.set(t,e),n&&this.dirtyKeys.add(t);for(const[r,s]of this.indexes.entries()){const a=e[r];if(a){const o=s.get(a)||new Set;o.add(t),s.set(a,o)}}}size(){return this.cache?.size||0}delete(t){this.cache?.delete(t),this.dirtyKeys.add(t)}async dump(){this.dirtyKeys.size>0&&this.cache&&(await this.options.dump(this.dirtyKeys,this.cache),this.dirtyKeys.clear())}addIndex(t){this.indexes.set(t,new dist.LRUCache({maxSize:this.options.maxSize}))}getFromIndex(t,e){const n=new Set,r=this.indexes.get(t);if(r){const s=r.get(e);if(s)for(const a of s.values()){const o=this.get(a);o&&n.add(o)}}return n}},INDEXABLE_TAGS_LIMIT=10,NDKCacheAdapterDexie=class{debug;locking=!1;ready=!1;profiles;zappers;nip05s;events;eventTags;relayInfo;unpublishedEvents;warmedUp=!1;warmUpPromise;devMode=!1;saveSig;_onReady;constructor(t={}){createDatabase(t.dbName||"ndk"),this.debug=t.debug||createDebug2("ndk:dexie-adapter"),this.saveSig=t.saveSig||!1,this.profiles=new CacheHandler({maxSize:t.profileCacheSize||1e5,dump:profilesDump(db.profiles,this.debug),debug:this.debug}),this.zappers=new CacheHandler({maxSize:t.zapperCacheSize||200,dump:zapperDump(db.lnurl,this.debug),debug:this.debug}),this.nip05s=new CacheHandler({maxSize:t.nip05CacheSize||1e3,dump:nip05Dump(db.nip05,this.debug),debug:this.debug}),this.events=new CacheHandler({maxSize:t.eventCacheSize||5e4,dump:eventsDump(db.events,this.debug),debug:this.debug}),this.events.addIndex("pubkey"),this.events.addIndex("kind"),this.eventTags=new CacheHandler({maxSize:t.eventTagsCacheSize||1e5,dump:eventTagsDump(db.eventTags,this.debug),debug:this.debug}),this.relayInfo=new CacheHandler({maxSize:500,debug:this.debug,dump:relayInfoDump(db.relayStatus,this.debug)}),this.unpublishedEvents=new CacheHandler({maxSize:5e3,debug:this.debug,dump:unpublishedEventsDump(db.unpublishedEvents,this.debug)});const e=(r,s)=>{const a=Date.now();return s().then(()=>{const o=Date.now();this.debug(r,"took",o-a,"ms")})},n=Date.now();this.warmUpPromise=Promise.allSettled([e("profilesWarmUp",()=>profilesWarmUp(this.profiles,db.profiles)),e("zapperWarmUp",()=>zapperWarmUp(this.zappers,db.lnurl)),e("nip05WarmUp",()=>nip05WarmUp(this.nip05s,db.nip05)),e("relayInfoWarmUp",()=>relayInfoWarmUp(this.relayInfo,db.relayStatus)),e("unpublishedEventsWarmUp",()=>unpublishedEventsWarmUp(this.unpublishedEvents,db.unpublishedEvents)),e("eventsWarmUp",()=>eventsWarmUp(this.events,db.events)),e("eventTagsWarmUp",()=>eventTagsWarmUp(this.eventTags,db.eventTags))]),this.warmUpPromise.then(()=>{const r=Date.now();this.warmedUp=!0,this.ready=!0,this.locking=!0,this.debug("Warm up completed, time",r-n,"ms"),this._onReady&&this._onReady()})}onReady(t){this._onReady=t}async query(t){if(!this.warmedUp){const r=Date.now();await this.warmUpPromise,this.debug("froze query for",Date.now()-r,"ms",t.filters)}const e=Date.now();t.filters.map(r=>this.processFilter(r,t));const n=Date.now()-e;return n>100&&this.debug("query took",n,"ms",t.filter),[]}async fetchProfile(t){return this.profiles?await this.profiles.getWithFallback(t,db.profiles):null}fetchProfileSync(t){return this.profiles?this.profiles.get(t):null}async getProfiles(t){if(this.profiles)return this.profiles.getAllWithFilter(t)}saveProfile(t,e){const n=this.profiles.get(t);if(n?.created_at&&e.created_at&&n.created_at>=e.created_at)return;const r=Math.floor(Date.now()/1e3);this.profiles.set(t,{pubkey:t,...e,cachedAt:r}),this.debug("Saved profile for pubkey",t,e)}async loadNip05(t,e=3600){const n=this.nip05s?.get(t);if(n){if(n.profile===null)return n.fetchedAt+e*1e3<Date.now()?"missing":null;try{return JSON.parse(n.profile)}catch{return"missing"}}const r=await db.nip05.get({nip05:t});if(!r)return"missing";const s=Date.now();if(r.profile===null)return r.fetchedAt+e*1e3<s?"missing":null;try{return JSON.parse(r.profile)}catch{return"missing"}}async saveNip05(t,e){try{const n=e?JSON.stringify(e):null;this.nip05s.set(t,{profile:n,fetchedAt:Date.now()})}catch(n){console.error("Failed to save NIP-05 profile for nip05:",t,n)}}async loadUsersLNURLDoc(t,e=86400,n=3600){const r=this.zappers?.get(t);if(r){if(r.document===null)return r.fetchedAt+n*1e3<Date.now()?"missing":null;try{return JSON.parse(r.document)}catch{return"missing"}}const s=await db.lnurl.get({pubkey:t});if(!s)return"missing";const a=Date.now();if(s.fetchedAt+e*1e3<a)return"missing";if(s.document===null)return s.fetchedAt+n*1e3<a?"missing":null;try{return JSON.parse(s.document)}catch{return"missing"}}async saveUsersLNURLDoc(t,e){try{const n=e?JSON.stringify(e):null;this.zappers?.set(t,{document:n,fetchedAt:Date.now()})}catch(n){console.error("Failed to save LNURL document for pubkey:",t,n)}}processFilter(t,e){const n={...t};n.limit=void 0;const r=new Set(Object.keys(n||{}));r.delete("since"),r.delete("limit"),r.delete("until");try{if(this.byNip33Query(r,t,e)||this.byAuthors(t,e)||this.byIdsQuery(t,e)||this.byTags(t,e)||this.byKinds(r,t,e))return}catch(s){console.error(s)}}async deleteEventIds(t){t.forEach(e=>this.events.delete(e)),await db.events.where({id:t}).delete()}addUnpublishedEvent=addUnpublishedEvent.bind(this);getUnpublishedEvents=()=>getUnpublishedEvents(db.unpublishedEvents);discardUnpublishedEvent=t=>discardUnpublishedEvent(db.unpublishedEvents,t);async setEvent(t,e,n){if(t.kind===0){if(!this.profiles)return;try{const s=profileFromEvent(t);this.saveProfile(t.pubkey,s)}catch{this.debug(`Failed to save profile for pubkey: ${t.pubkey}`)}}let r=!0;if(t.isParamReplaceable()){const s=this.events.get(t.tagId());s&&t.created_at&&s.createdAt>t.created_at&&(r=!1)}if(r){const s={id:t.tagId(),pubkey:t.pubkey,kind:t.kind,createdAt:t.created_at??Date.now(),relay:n?.url,event:t.serialize(this.saveSig,!0)};this.saveSig&&t.sig&&(s.sig=t.sig),this.events.set(t.tagId(),s);const a=getIndexableTags(t);for(const o of a)this.eventTags.add(o[0]+o[1],t.tagId())}}updateRelayStatus(t,e){const n={url:t,updatedAt:Date.now(),...e};this.relayInfo.set(t,n)}getRelayStatus(t){const e=this.relayInfo.get(t);if(e)return{lastConnectedAt:e.lastConnectedAt,dontConnectBefore:e.dontConnectBefore}}byAuthors(t,e){if(!t.authors)return!1;let n=0;for(const r of t.authors){let s=Array.from(this.events.getFromIndex("pubkey",r));t.kinds&&(s=s.filter(a=>t.kinds?.includes(a.kind))),foundEvents(e,s,t),n+=s.length}return!0}byIdsQuery(t,e){if(t.ids){for(const n of t.ids){const r=this.events.get(n);r&&foundEvent(e,r,r.relay,t)}return!0}return!1}byNip33Query(t,e,n){const r=["#d","authors","kinds"];if(t.size===r.length&&r.every(a=>t.has(a))&&e.kinds&&e.authors){for(const a of e.kinds)if(a>=3e4&&a<4e4)for(const l of e.authors)for(const h of e["#d"]){const y=`${a}:${l}:${h}`,p=this.events.get(y);p&&foundEvent(n,p,p.relay,e)}return!0}return!1}byTags(t,e){const n=Object.entries(t).filter(([r])=>r.startsWith("#")&&r.length===2).map(([r,s])=>[r[1],s]);if(n.length===0)return!1;for(const[r,s]of n)for(const a of s){const o=r+a,l=this.eventTags.getSet(o);l&&l.forEach(h=>{const y=this.events.get(h);y&&(!t.kinds||t.kinds.includes(y.kind))&&foundEvent(e,y,y.relay,t)})}return!0}byKinds(t,e,n){if(!e.kinds||t.size!==1||!t.has("kinds"))return!1;const r=e.limit||500;let s=0;const a=new Set,o=[...e.kinds].sort((l,h)=>(this.events.indexes.get("kind")?.get(l)?.size||0)-(this.events.indexes.get("kind")?.get(h)?.size||0));for(const l of o){const h=this.events.getFromIndex("kind",l);for(const y of h)if(!a.has(y.id)&&(a.add(y.id),foundEvent(n,y,y.relay,e),s++,s>=r))break;if(s>=r)break}return!0}};function foundEvents(t,e,n){n?.limit&&e.length>n.limit&&(e=e.sort((r,s)=>s.createdAt-r.createdAt).slice(0,n.limit));for(const r of e)foundEvent(t,r,r.relay,n)}function foundEvent(t,e,n,r){try{const s=deserialize(e.event);if(r&&!matchFilter(r,s))return;const a=new NDKEvent(void 0,s),o=n?t.pool.getRelay(n,!1):void 0;a.relay=o,t.eventReceived(a,o,!0)}catch(s){console.error("failed to deserialize event",s)}}function getIndexableTags(t){const e=[];if(t.kind===3)return[];for(const n of t.tags)if(n[0].length===1&&(e.push(n),e.length>=INDEXABLE_TAGS_LIMIT))return[];return e}const __vite_import_meta_env__={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_ADMIN_PUBKEY:"11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c",VITE_APP_NAME:"DreamLab Community",VITE_AUTH_API_URL:"https://dreamlab-auth-api.solitary-paper-764d.workers.dev",VITE_EMBEDDING_API_URL:"",VITE_IMAGE_API_URL:"",VITE_IMAGE_BUCKET:"",VITE_IMAGE_ENCRYPTION_ENABLED:"true",VITE_LINK_PREVIEW_API_URL:"",VITE_NDK_DEBUG:"false",VITE_RELAY_URL:"wss://dreamlab-nostr-relay.solitary-paper-764d.workers.dev"};var define_process_env_default={};function getEnv(t,e){if(typeof process<"u"&&define_process_env_default?.[t])return define_process_env_default[t];if(typeof import.meta<"u"&&__vite_import_meta_env__?.[t])return __vite_import_meta_env__[t];if(e!==void 0)return e;throw new Error(`Environment variable ${t} is required but not set`)}const RELAY_URL=getEnv("VITE_RELAY_URL","wss://dreamlab-nostr-relay.solitary-paper-764d.workers.dev");getEnv("VITE_ADMIN_PUBKEY","");getEnv("VITE_APP_NAME","Nostr BBS");const NDK_CONFIG={enableDebug:getEnv("VITE_NDK_DEBUG","false")==="true",cache:{name:"nostr-bbs-cache"}},TIMEOUTS={connect:1e4,auth:5e3,publish:5e3,subscribe:3e4},defaultConfigYaml=`# Fairfield Multi-Tenant Configuration
# Zone-based isolation for Family, Minimoonoir, and DreamLab
# Each zone has its own branding, visibility rules, and access control

# Application metadata
app:
  name: 'DreamLab Community'
  version: '2.0.0'
  defaultPath: '/dreamlab/dreamlab-lobby'

# Superuser configuration
superuser:
  pubkey: '11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c'
  name: 'Instance Owner'
  relayUrl: 'wss://dreamlab-nostr-relay.solitary-paper-764d.workers.dev'

# Deployment URLs
deployment:
  relayUrl: 'wss://dreamlab-nostr-relay.solitary-paper-764d.workers.dev'
  embeddingApiUrl: 'https://embedding-api-617806532906.us-central1.run.app'
  gcsEmbeddingsUrl: 'https://storage.googleapis.com/minimoonoir-vectors'
  frontendUrl: 'https://dreamlab-ai.github.io/fairfield'

# Role definitions (hierarchical from lowest to highest)
roles:
  - id: 'guest'
    name: 'Guest'
    level: 0
    description: 'Basic authenticated user'

  - id: 'member'
    name: 'Member'
    level: 1
    description: 'Approved zone member'

  - id: 'moderator'
    name: 'Moderator'
    level: 2
    description: 'Can manage channels and moderate content'
    capabilities:
      - 'forum.create'
      - 'forum.delete'
      - 'message.pin'
      - 'message.delete'

  - id: 'section-admin'
    name: 'Section Admin'
    level: 3
    description: 'Administrator for a specific section'
    capabilities:
      - 'section.manage'
      - 'member.approve'
      - 'member.remove'
      - 'forum.create'
      - 'forum.delete'
      - 'message.pin'
      - 'message.delete'

  - id: 'admin'
    name: 'Admin'
    level: 4
    description: 'Global administrator with cross-zone access'
    capabilities:
      - 'admin.global'
      - 'section.create'
      - 'section.delete'
      - 'section.manage'
      - 'member.approve'
      - 'member.remove'
      - 'forum.create'
      - 'forum.delete'
      - 'message.pin'
      - 'message.delete'
      - 'user.whitelist'

# Cohort definitions - Zone membership groups
cohorts:
  # Administrative cohorts
  - id: 'admin'
    name: 'Administrators'
    description: 'Global system administrators'

  # Cross-zone access (owners who see everything)
  - id: 'cross-access'
    name: 'Cross-Zone Access'
    description: 'Users who can access all zones (owners)'

  # Zone-specific cohorts
  - id: 'family'
    name: 'Family Members'
    description: 'Direct family with access to family zone'

  - id: 'family-only'
    name: 'Family Only'
    description: 'Family members who should NOT see business content'

  - id: 'minimoonoir'
    name: 'Minimoonoir Guests'
    description: 'Friends and guests staying at Fairfield'

  - id: 'minimoonoir-only'
    name: 'Minimoonoir Only'
    description: 'Guests who should NOT see business content'

  - id: 'minimoonoir-business'
    name: 'Minimoonoir with Business Access'
    description: 'Guests who can also access business/training boards'

  - id: 'business'
    name: 'Business Partners'
    description: 'DreamLab business collaborators and trainees'

  - id: 'business-only'
    name: 'Business Only'
    description: 'Business users who should NOT see family/friends content'

  - id: 'trainers'
    name: 'Trainers'
    description: 'Training providers and facilitators'

  - id: 'trainees'
    name: 'Trainees'
    description: 'Users receiving training'

  # AI Agent access cohorts
  - id: 'agent'
    name: 'AI Agents'
    description: 'VisionFlow AI agent service accounts'

  - id: 'visionflow-full'
    name: 'VisionFlow Full Access'
    description: 'Users with access to full VisionFlow intelligence (Tier 3)'

# 3-Tier Structure: Categories (Zones)  Sections  Forums
categories:
  # ============================================
  # ZONE 1: FAMILY (Completely Isolated)
  # ============================================
  - id: 'fairfield-family'
    name: 'Fairfield Family'
    description: 'Private family zone - visible only to family members'
    icon: ''
    order: 1

    # Zone-level access control
    access:
      visibleToCohorts: ['family', 'cross-access']
      hiddenFromCohorts: ['business-only']
      strictIsolation: true

    # Zone branding
    branding:
      displayName: 'Fairfield Home'
      tagline: 'Our Family Space'
      primaryColor: '#4a7c59'
      accentColor: '#8fbc8f'
      heroImageUrl: '/images/zones/family-hero.webp'
      logoUrl: '/images/zones/family-logo.webp'

    ui:
      color: '#4a7c59'

    sections:
      - id: 'family-home'
        name: 'Home'
        description: 'Main family discussion area'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['family', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['minimoonoir', 'dreamlab']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              minimoonoir: '#6366f1'
              dreamlab: '#c2410c'
        ui:
          color: '#4a7c59'
        showStats: true
        allowForumCreation: true

      - id: 'family-events'
        name: 'Family Events'
        description: 'Birthdays, gatherings, and family occasions'
        icon: ''
        order: 2
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['family', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['minimoonoir', 'dreamlab']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              minimoonoir: '#6366f1'
              dreamlab: '#c2410c'
        ui:
          color: '#6b8e23'
        showStats: true
        allowForumCreation: true

      - id: 'family-photos'
        name: 'Photos & Memories'
        description: 'Photo sharing and family memories'
        icon: ''
        order: 3
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['family', 'cross-access']
        calendar:
          access: 'none'
          canCreate: false
        ui:
          color: '#8b4513'
        showStats: false
        allowForumCreation: false

  # ============================================
  # ZONE 2: MINIMOONOIR (Friends & Visitors)
  # ============================================
  - id: 'minimoonoir'
    name: 'Minimoonoir'
    description: 'For friends and visitors staying with us'
    icon: ''
    order: 2

    # Zone-level access control
    access:
      visibleToCohorts: ['minimoonoir', 'minimoonoir-business', 'cross-access']
      hiddenFromCohorts: ['business-only']
      strictIsolation: false

    # Zone branding
    branding:
      displayName: 'Minimoonoir'
      tagline: 'Guest Stays & Adventures'
      primaryColor: '#8b5cf6'
      accentColor: '#a78bfa'
      heroImageUrl: '/images/zones/minimoonoir-hero.webp'
      logoUrl: '/images/zones/minimoonoir-logo.webp'

    ui:
      color: '#8b5cf6'

    sections:
      - id: 'minimoonoir-welcome'
        name: 'Welcome'
        description: 'Essential information for guests staying with us'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'guest'
          autoApprove: true
        calendar:
          access: 'full'
          canCreate: false
          showBlocksFrom: ['fairfield-family', 'dreamlab']
          blockDisplay:
            showSourceZone: true
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              dreamlab: '#c2410c'
        ui:
          color: '#8b5cf6'
        showStats: true
        allowForumCreation: false

      - id: 'minimoonoir-events'
        name: 'Events & Activities'
        description: 'Plan visits, activities, and local adventures'
        icon: ''
        order: 2
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['minimoonoir', 'minimoonoir-business', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['fairfield-family', 'dreamlab']
          blockDisplay:
            showSourceZone: true
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              dreamlab: '#c2410c'
        ui:
          color: '#a78bfa'
        showStats: true
        allowForumCreation: true

      - id: 'minimoonoir-booking'
        name: 'Stay Booking'
        description: 'Book your stay - 2 guest beds available in main house'
        icon: ''
        order: 3
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['minimoonoir', 'minimoonoir-business', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['fairfield-family', 'dreamlab']
          blockDisplay:
            showSourceZone: true
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              dreamlab: '#c2410c'
        ui:
          color: '#f59e0b'
        showStats: false
        allowForumCreation: false

  # ============================================
  # ZONE 3: DREAMLAB BUSINESS
  # ============================================
  - id: 'dreamlab'
    name: 'DreamLab'
    description: 'Business training and collaboration space'
    icon: ''
    order: 3

    # Zone-level access control - Business isolation
    access:
      visibleToCohorts: ['business', 'minimoonoir-business', 'trainers', 'trainees', 'cross-access']
      hiddenFromCohorts: ['family-only', 'minimoonoir-only']
      strictIsolation: true

    # Zone branding - DreamLab identity
    branding:
      displayName: 'DreamLab'
      tagline: 'Training & Innovation Hub'
      primaryColor: '#ec4899'
      accentColor: '#f472b6'
      heroImageUrl: '/images/zones/dreamlab-hero.webp'
      logoUrl: '/images/zones/dreamlab-logo.webp'

    ui:
      color: '#ec4899'

    sections:
      - id: 'dreamlab-lobby'
        name: 'DreamLab Lobby'
        description: 'Welcome area for business visitors and trainees'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'guest'
          autoApprove: true
          requiredCohorts: ['business', 'minimoonoir-business', 'trainers', 'trainees', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: false
          cohortRestricted: true
          showBlocksFrom: ['fairfield-family', 'minimoonoir']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              minimoonoir: '#6366f1'
        ui:
          color: '#ec4899'
        showStats: true
        allowForumCreation: false

      - id: 'dreamlab-training'
        name: 'Training Rooms'
        description: 'Active training sessions and courses'
        icon: ''
        order: 2
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['trainers', 'trainees', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: true
          cohortRestricted: true
          showBlocksFrom: ['fairfield-family']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
        ui:
          color: '#db2777'
        showStats: true
        allowForumCreation: true
        branding:
          tagline: 'Active Training Sessions'

      - id: 'dreamlab-projects'
        name: 'Projects'
        description: 'Collaborative business projects'
        icon: ''
        order: 3
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['business', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: false
          cohortRestricted: true
        ui:
          color: '#a855f7'
        showStats: true
        allowForumCreation: true

      - id: 'dreamlab-bookings'
        name: 'Facility Booking'
        description: 'Book training rooms and equipment - admin managed'
        icon: ''
        order: 4
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['business', 'trainers', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: false
          cohortRestricted: true
          showBlocksFrom: ['fairfield-family', 'minimoonoir']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              minimoonoir: '#6366f1'
        ui:
          color: '#f97316'
        showStats: false
        allowForumCreation: false

  # ============================================
  # ZONE 4: AI AGENTS (VisionFlow Bridge)
  # ============================================
  - id: 'ai-agents'
    name: 'AI Agents'
    description: 'VisionFlow AI agents - tiered intelligence via Nostr DM'
    icon: ''
    order: 4

    # Zone-level access control
    access:
      visibleToCohorts: ['business', 'trainers', 'trainees', 'minimoonoir-business', 'cross-access']
      hiddenFromCohorts: ['family-only']
      strictIsolation: false

    # Zone branding
    branding:
      displayName: 'VisionFlow AI'
      tagline: 'Intelligent Agents'
      primaryColor: '#0ea5e9'
      accentColor: '#38bdf8'

    ui:
      color: '#0ea5e9'

    sections:
      - id: 'ai-general'
        name: 'General Assistant'
        description: 'Quick answers from VisionFlow z ai - no memory, no agentic tasks'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'guest'
          autoApprove: true
        calendar:
          access: 'none'
          canCreate: false
        ui:
          color: '#0ea5e9'
        showStats: true
        allowForumCreation: false

      - id: 'ai-claude-flow'
        name: 'Claude Flow Agent'
        description: 'Agentic AI with Claude Flow - task execution, reasoning, session memory'
        icon: ''
        order: 2
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['business', 'trainers', 'trainees', 'minimoonoir-business', 'cross-access']
        calendar:
          access: 'none'
          canCreate: false
        ui:
          color: '#8b5cf6'
        showStats: true
        allowForumCreation: false

      - id: 'ai-visionflow'
        name: 'VisionFlow Intelligence'
        description: 'Full VisionFlow AI - knowledge graph, memory, deep intelligence'
        icon: ''
        order: 3
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['cross-access', 'visionflow-full']
        calendar:
          access: 'none'
          canCreate: false
        ui:
          color: '#ec4899'
        showStats: true
        allowForumCreation: false

# Calendar access levels
calendarAccessLevels:
  - id: 'full'
    name: 'Full Access'
    description: 'See all event details'
    canView: true
    canViewDetails: true

  - id: 'availability'
    name: 'Availability Only'
    description: 'See when slots are booked, not event details'
    canView: true
    canViewDetails: false

  - id: 'cohort'
    name: 'Cohort Restricted'
    description: 'Full details only for matching cohort members'
    canView: true
    canViewDetails: 'cohort-match'

  - id: 'none'
    name: 'No Access'
    description: 'Calendar hidden'
    canView: false
    canViewDetails: false

# Channel visibility options
channelVisibility:
  - id: 'public'
    name: 'Public'
    description: 'Visible to all section members'
  - id: 'cohort'
    name: 'Cohort Only'
    description: 'Visible only to specific cohorts'
  - id: 'invite'
    name: 'Invite Only'
    description: 'Private channel, invite required'
`,STORAGE_KEY$1="nostr_bbs_custom_config";let cachedConfig=null;function loadConfig(){if(cachedConfig)return cachedConfig;try{const t=localStorage.getItem(STORAGE_KEY$1);if(t){const e=JSON.parse(t);return validateConfig(e),cachedConfig=e,cachedConfig}}catch(t){console.warn("[Config] Invalid stored config, using default:",t)}try{return cachedConfig=parse$1(defaultConfigYaml),validateConfig(cachedConfig),cachedConfig}catch(t){return console.error("[Config] Failed to parse default config:",t),getDefaultConfig()}}function validateConfig(t){if(!t.app?.name)throw new Error("Missing app.name in configuration");if(!t.categories?.length)throw new Error("No categories defined in configuration");if(!t.roles?.length)throw new Error("No roles defined in configuration");const e=new Set(t.roles.map(n=>n.id));for(const n of t.categories)for(const r of n.sections)if(!e.has(r.access.defaultRole))throw new Error(`Section ${r.id} references unknown role: ${r.access.defaultRole}`)}function getDefaultConfig(){return{app:{name:"Nostr BBS",version:"2.0.0",defaultPath:"/general/welcome",tiers:[{level:1,name:"Category",plural:"Categories"},{level:2,name:"Section",plural:"Sections"},{level:3,name:"Forum",plural:"Forums"}]},roles:[{id:"guest",name:"Guest",level:0,description:"Basic authenticated user"},{id:"member",name:"Member",level:1,description:"Approved section member"},{id:"moderator",name:"Moderator",level:2,description:"Can manage forums and moderate",capabilities:["forum.create","forum.lock","message.pin","message.delete"]},{id:"section-admin",name:"Section Admin",level:3,description:"Section administrator",capabilities:["section.manage","member.approve","member.remove","forum.create","forum.delete","message.pin","message.delete"]},{id:"admin",name:"Admin",level:4,description:"Global administrator",capabilities:["admin.global","category.create","category.delete","section.create","section.delete","section.manage","member.approve","member.remove","forum.create","forum.delete","message.pin","message.delete","user.whitelist"]}],cohorts:[{id:"admin",name:"Administrators",description:"Global administrators"},{id:"approved",name:"Approved Users",description:"Manually approved"},{id:"members",name:"Community Members",description:"Core community members"}],categories:[{id:"general",name:"General",description:"Public discussion areas",icon:"",order:1,sections:[{id:"welcome",name:"Welcome",description:"Welcome area for new visitors",icon:"",order:1,access:{requiresApproval:!1,defaultRole:"guest",autoApprove:!0},calendar:{access:"full",canCreate:!1},ui:{color:"#6366f1"},showStats:!0,allowForumCreation:!1},{id:"announcements",name:"Announcements",description:"Official news and updates",icon:"",order:2,access:{requiresApproval:!1,defaultRole:"guest",autoApprove:!0},calendar:{access:"full",canCreate:!1},ui:{color:"#f59e0b"},showStats:!0,allowForumCreation:!1},{id:"help",name:"Help & Support",description:"Get help with using the platform",icon:"",order:3,access:{requiresApproval:!1,defaultRole:"guest",autoApprove:!0},calendar:{access:"none",canCreate:!1},ui:{color:"#10b981"},showStats:!0,allowForumCreation:!1}]},{id:"community",name:"Community",description:"Members-only discussion spaces",icon:"",order:2,sections:[{id:"discussions",name:"Discussions",description:"General member discussions",icon:"",order:1,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"full",canCreate:!0},ui:{color:"#8b5cf6"},showStats:!0,allowForumCreation:!0},{id:"introductions",name:"Introductions",description:"Introduce yourself",icon:"",order:2,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"none",canCreate:!1},ui:{color:"#06b6d4"},showStats:!0,allowForumCreation:!1},{id:"events",name:"Events",description:"Community events and meetups",icon:"",order:3,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"full",canCreate:!0},ui:{color:"#ec4899"},showStats:!0,allowForumCreation:!0}]},{id:"projects",name:"Projects",description:"Collaborative project spaces",icon:"",order:3,sections:[{id:"active-projects",name:"Active Projects",description:"Currently active project discussions",icon:"",order:1,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"availability",canCreate:!0,cohortRestricted:!0},ui:{color:"#ec4899"},showStats:!0,allowForumCreation:!0},{id:"resources",name:"Resources",description:"Shared files and documentation",icon:"",order:2,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"none",canCreate:!1},ui:{color:"#84cc16"},showStats:!1,allowForumCreation:!1}]}],calendarAccessLevels:[{id:"full",name:"Full Access",description:"All details visible",canView:!0,canViewDetails:!0},{id:"availability",name:"Availability Only",description:"Dates only",canView:!0,canViewDetails:!1},{id:"cohort",name:"Cohort Restricted",description:"Cohort match required",canView:!0,canViewDetails:"cohort-match"},{id:"none",name:"No Access",description:"Hidden",canView:!1,canViewDetails:!1}],channelVisibility:[{id:"public",name:"Public",description:"All section members"},{id:"cohort",name:"Cohort Only",description:"Assigned cohorts"},{id:"invite",name:"Invite Only",description:"Explicit invites"}]}}const config=loadConfig();function getAppConfig(){return config.app}function getCategories(){return config.categories.sort((t,e)=>t.order-e.order)}function getCategory(t){return config.categories.find(e=>e.id===t)}function getSections(){return config.categories.flatMap(t=>t.sections.map(e=>({...e,_categoryId:t.id}))).sort((t,e)=>t.order-e.order)}function getSectionsByCategory(t){const e=getCategory(t);return e?e.sections.sort((n,r)=>n.order-r.order):[]}function getSection(t){for(const e of config.categories){const n=e.sections.find(r=>r.id===t);if(n)return n}}function getSectionWithCategory(t){for(const e of config.categories){const n=e.sections.find(r=>r.id===t);if(n)return{section:n,category:e}}}function getRole(t){return config.roles.find(e=>e.id===t)}function roleHasCapability(t,e){const n=getRole(t);return n?n.id==="admin"?!0:n.capabilities?.includes(e)??!1:!1}function roleIsHigherThan(t,e){const n=getRole(t),r=getRole(e);return!n||!r?!1:n.level>r.level}function getCohorts(){return config.cohorts}function getBreadcrumbs(t,e,n){const r=[{label:"Home",path:"/",icon:""}];if(t){const s=getCategory(t);s&&r.push({label:s.name,path:`/${t}`,icon:s.icon})}if(e){const s=getSection(e);s&&r.push({label:s.name,path:`/${t}/${e}`,icon:s.icon})}return r}function getSectionConfigMap(){const t={};for(const e of getSections())t[e.id]=e;return t}const SECTION_CONFIG=getSectionConfigMap();var ConnectionState=(t=>(t.Disconnected="disconnected",t.Connecting="connecting",t.Connected="connected",t.AuthRequired="auth-required",t.Authenticating="authenticating",t.Authenticated="authenticated",t.AuthFailed="auth-failed",t.Error="error",t))(ConnectionState||{});class RelayManager{_ndk=null;_signer=null;_activeSubscriptions=new Map;_connectionState=writable({state:"disconnected",timestamp:Date.now(),authenticated:!1});_cacheAdapter=null;get ndk(){return this._ndk}get connectionState(){return this._connectionState}updateState(e,n,r,s=!1){this._connectionState.set({state:e,relay:n,error:r,timestamp:Date.now(),authenticated:s})}async initializeNDK(e,n){return this._signer=new NDKPrivateKeySigner$1(e),this._createNDK(n)}async initializeNDKWithNip07(e){return this._signer=new NDKNip07Signer$1,this._createNDK(e)}_createNDK(e){this._cacheAdapter||(this._cacheAdapter=new NDKCacheAdapterDexie({dbName:NDK_CONFIG.cache.name}));const n=new NDK({explicitRelayUrls:[e],signer:this._signer,cacheAdapter:this._cacheAdapter??void 0,enableOutboxModel:!1});return NDK_CONFIG.enableDebug&&(n.pool.on("relay:connect",r=>{console.log(`[NDK] Connected to relay: ${r.url}`)}),n.pool.on("relay:disconnect",r=>{console.log(`[NDK] Disconnected from relay: ${r.url}`)}),n.pool.on("relay:auth",(r,s)=>{console.log(`[NDK] AUTH challenge from ${r.url}: ${s}`)})),n}async handleAuthChallenge(e,n){if(!this._signer)throw new Error("No signer available for authentication");try{this.updateState("authenticating",e.url);const r=await this._signer.user(),s=new NDKEvent$1(this._ndk??void 0);s.kind=22242,s.tags=[["relay",e.url],["challenge",n]],s.content="",s.pubkey=r.pubkey,s.created_at=Math.floor(Date.now()/1e3),await s.sign(this._signer);const a=new Promise((h,y)=>{setTimeout(()=>y(new Error("AUTH timeout")),TIMEOUTS.auth)}),o=new Promise(h=>{setTimeout(()=>h(!0),1e3)}),l=await Promise.race([o,a]);return l&&this.updateState("authenticated",e.url,void 0,!0),l}catch(r){const s=r instanceof Error?r.message:"Unknown error";throw this.updateState("auth-failed",e.url,s),r}}async connectRelayWithNip07(e){try{return this.updateState("connecting",e),this._ndk&&await this.disconnectRelay(),this._ndk=await this.initializeNDKWithNip07(e),this._finishConnect(e)}catch(n){const r=n instanceof Error?n.message:"Connection failed";throw this.updateState("error",e,r),n}}async connectRelay(e,n){try{return this.updateState("connecting",e),this._ndk&&await this.disconnectRelay(),this._ndk=await this.initializeNDK(n,e),this._finishConnect(e)}catch(r){const s=r instanceof Error?r.message:"Connection failed";throw this.updateState("error",e,s),r}}async _finishConnect(e){if(!this._ndk)throw new Error("NDK not initialized");const n=new Promise((a,o)=>{setTimeout(()=>o(new Error("Connection timeout")),TIMEOUTS.connect)});await Promise.race([this._ndk.connect(),n]);const r=Array.from(this._ndk.pool.relays.values())[0];if(!r)throw new Error("No relay connected");r.on("auth",async a=>{this.updateState("auth-required",r.url);try{await this.handleAuthChallenge(r,a)}catch(o){console.error("[NDK] AUTH failed:",o)}});const s=r.connectivity.status>=5?"connected":"disconnected";return this.updateState(s,e,void 0,!1),{state:s,relay:e,timestamp:Date.now(),authenticated:!1}}async publishEvent(e){if(!this._ndk)throw new Error("NDK not initialized. Call connectRelay first.");if(!this._signer)throw new Error("No signer available. Call connectRelay first.");try{e.ndk=this._ndk,e.sig||await e.sign(this._signer);const n=new Promise((a,o)=>{setTimeout(()=>o(new Error("Publish timeout")),TIMEOUTS.publish)}),r=e.publish();return(await Promise.race([r,n])).size>0}catch(n){throw console.error("[NDK] Publish failed:",n),n}}subscribe(e,n){if(!this._ndk)throw new Error("NDK not initialized. Call connectRelay first.");const r=Array.isArray(e)?e:[e],s=this._ndk.subscribe(r,{closeOnEose:n?.closeOnEose??!1,groupable:n?.groupable??!0,subId:n?.subId}),a=n?.subId??`sub_${Date.now()}_${Math.random().toString(36).slice(2)}`;return this._activeSubscriptions.set(a,s),s.on("close",()=>{this._activeSubscriptions.delete(a)}),s}getSubscription(e){return this._activeSubscriptions.get(e)}closeSubscription(e){const n=this._activeSubscriptions.get(e);return n?(n.stop(),this._activeSubscriptions.delete(e),!0):!1}getActiveSubscriptions(){return new Map(this._activeSubscriptions)}async disconnectRelay(){try{if(this._activeSubscriptions.forEach(e=>{e.stop()}),this._activeSubscriptions.clear(),this._ndk){for(const e of this._ndk.pool.relays.values())e.disconnect();this._ndk=null}this._signer=null,this.updateState("disconnected")}catch(e){throw console.error("[NDK] Disconnect error:",e),e}}isConnected(){if(!this._ndk)return!1;for(const e of this._ndk.pool.relays.values())if(e.connectivity.status>=5)return!0;return!1}async getCurrentUser(){if(!this._signer)return null;try{return await this._signer.user()}catch{return null}}getRelayUrls(){return this._ndk?Array.from(this._ndk.pool.relays.values()).map(e=>e.url):[]}}const relayManagerInstance=new RelayManager,ndk=()=>relayManagerInstance.ndk,connectionState=relayManagerInstance.connectionState,connectRelay=(t,e)=>relayManagerInstance.connectRelay(t,e),connectRelayWithNip07=t=>relayManagerInstance.connectRelayWithNip07(t),publishEvent=t=>relayManagerInstance.publishEvent(t),subscribe=(t,e)=>relayManagerInstance.subscribe(t,e),isConnected=()=>relayManagerInstance.isConnected();async function ensureRelayConnected(t){if(!relayManagerInstance.isConnected())if(t.isNip07)await relayManagerInstance.connectRelayWithNip07(RELAY_URL);else if(t.privateKey)await relayManagerInstance.connectRelay(RELAY_URL,t.privateKey);else throw new Error("No signing method available")}const getRelayUrls=()=>relayManagerInstance.getRelayUrls(),reconnectRelay=async()=>{if(relayManagerInstance.getRelayUrls().length===0){console.warn("[Relay] No relay to reconnect to");return}await relayManagerInstance.disconnectRelay()};function setNip07Signer(){const t=relayManagerInstance.ndk;t&&(t.signer=new NDKNip07Signer$1)}function clearSigner(){const t=relayManagerInstance.ndk;t&&(t.signer=void 0)}const relay=Object.freeze(Object.defineProperty({__proto__:null,ConnectionState,clearSigner,connectRelay,connectRelayWithNip07,connectionState,ensureRelayConnected,getRelayUrls,isConnected,ndk,publishEvent,reconnectRelay,setNip07Signer,subscribe},Symbol.toStringTag,{value:"Module"}));var verifiedSymbol=Symbol("verified"),isRecord=t=>t instanceof Object;function validateEvent(t){if(!isRecord(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}new TextDecoder("utf-8");var utf8Encoder=new TextEncoder,JS=class{generateSecretKey(){return schnorr.utils.randomPrivateKey()}getPublicKey(t){return utils$1.bytesToHex(schnorr.getPublicKey(t))}finalizeEvent(t,e){const n=t;return n.pubkey=utils$1.bytesToHex(schnorr.getPublicKey(e)),n.id=getEventHash(n),n.sig=utils$1.bytesToHex(schnorr.sign(getEventHash(n),e)),n[verifiedSymbol]=!0,n}verifyEvent(t){if(typeof t[verifiedSymbol]=="boolean")return t[verifiedSymbol];const e=getEventHash(t);if(e!==t.id)return t[verifiedSymbol]=!1,!1;try{const n=schnorr.verify(t.sig,e,t.pubkey);return t[verifiedSymbol]=n,n}catch{return t[verifiedSymbol]=!1,!1}}};function serializeEvent(t){if(!validateEvent(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function getEventHash(t){let e=sha256_1(utf8Encoder.encode(serializeEvent(t)));return utils$1.bytesToHex(e)}var i=new JS;i.generateSecretKey;i.getPublicKey;i.finalizeEvent;i.verifyEvent;var HTTPAuth=27235,_authorizationScheme="Nostr ";async function getToken(t,e,n,r=!1,s){const a={kind:HTTPAuth,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&a.tags.push(["payload",hashPayload(s)]);const o=await n(a);return(r?_authorizationScheme:"")+base64.encode(utf8Encoder.encode(JSON.stringify(o)))}function hashPayload(t){const e=sha256_1(utf8Encoder.encode(JSON.stringify(t)));return utils$1.bytesToHex(e)}function createSigner(t){return e=>finalizeEvent(e,t)}async function hashRawBody(t){const e=t instanceof ArrayBuffer?new Uint8Array(t):t;return utils$1.bytesToHex(sha256_1(e))}async function createNip98Token(t,e,n,r){const s=r?await hashRawBody(r):void 0;return getToken(e,n,createSigner(t),!0,s)}async function fetchWithNip98(t,e={},n){const r=e.method??"GET";let s;const a=e.body;a==null?s=void 0:typeof a=="string"?s=new TextEncoder().encode(a):a instanceof ArrayBuffer||a instanceof Uint8Array?s=a:s=void 0;const o=await createNip98Token(n,t,r,s);return fetch(t,{...e,headers:{...e.headers,Authorization:`Nostr ${o}`}})}new TextEncoder().encode("dreamlab-nostr-key-v1");const AUTH_API_BASE=(typeof import.meta<"u"&&"https://dreamlab-auth-api.solitary-paper-764d.workers.dev")??"";async function derivePrivkeyFromPrf(t){const e=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]),n=await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(0),info:new TextEncoder().encode("nostr-secp256k1-v1")},e,256),r=new Uint8Array(n);return secp256k1.utils.isValidPrivateKey(r)?r:derivePrivkeyFromPrf(await crypto.subtle.digest("SHA-256",r))}async function registerPasskey(t){const e=await fetch(`${AUTH_API_BASE}/auth/register/options`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({displayName:t})});if(!e.ok)throw new Error(`Registration options failed: ${e.statusText}`);const{options:n,prfSalt:r}=await e.json();if(!r)throw new Error("Server did not return prfSalt in registration options");const s={...decodeCreationOptions(n),extensions:{prf:{eval:{first:base64urlToBuffer(r)}}}},a=await navigator.credentials.create({publicKey:s});if(!a)throw new Error("Passkey creation cancelled or failed");const o=a.getClientExtensionResults();if(!o.prf?.enabled)throw new Error("PRF extension not supported by this authenticator. Use a FIDO2 authenticator with PRF support (not Windows Hello or cross-device QR).");const l=o.prf?.results?.first;if(!l)throw new Error("PRF extension not supported by this authenticator. Please use a modern browser (Chrome 116+, Safari 17.4+).");const h=await derivePrivkeyFromPrf(l),y=getPublicKey(h),p=await fetch(`${AUTH_API_BASE}/auth/register/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:encodeCredentialResponse(a),pubkey:y})});if(!p.ok){const S=await p.json().catch(()=>({}));throw new Error(S.error??`Registration verification failed: ${p.statusText}`)}const{didNostr:m,webId:v,podUrl:_}=await p.json();return{pubkey:y,privkey:h,credentialId:a.id,webId:v??null,podUrl:_??null,didNostr:m}}async function authenticatePasskey(t){const e=await fetch(`${AUTH_API_BASE}/auth/login/options`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pubkey:t??""})});if(!e.ok)throw new Error(`Login options failed: ${e.statusText}`);const{options:n,prfSalt:r}=await e.json();if(!r)throw new Error("Server did not return prfSalt in login options");const s={...decodeRequestOptions(n),extensions:{prf:{eval:{first:base64urlToBuffer(r)}}}},a=await navigator.credentials.get({publicKey:s});if(!a)throw new Error("Passkey authentication cancelled");if(a.authenticatorAttachment==="cross-platform")throw new Error("Cross-device QR authentication will produce a different PRF output and cannot derive your Nostr key. Use the same device/authenticator used during registration.");const l=a.getClientExtensionResults().prf?.results?.first;if(!l)throw new Error("PRF extension not available on this credential");const h=await derivePrivkeyFromPrf(l),y=getPublicKey(h),p=AUTH_API_BASE?`${AUTH_API_BASE}/auth/login/verify`:`${window.location.origin}/auth/login/verify`,m=JSON.stringify({response:encodeAssertionResponse(a),pubkey:y}),v=await fetchWithNip98(p,{method:"POST",headers:{"Content-Type":"application/json"},body:m},h);if(!v.ok){const T=await v.json().catch(()=>({}));throw new Error(T.error??`Login failed: ${v.statusText}`)}const{didNostr:_,webId:S}=await v.json();return{pubkey:y,privkey:h,didNostr:_,webId:S??null}}function base64urlToBuffer(t){const e=t.replace(/-/g,"+").replace(/_/g,"/"),n=e.padEnd(e.length+(4-e.length%4)%4,"="),r=atob(n),s=new Uint8Array(r.length);for(let a=0;a<r.length;a++)s[a]=r.charCodeAt(a);return s.buffer}function bufferToBase64url(t){const e=new Uint8Array(t);let n="";for(let r=0;r<e.length;r++)n+=String.fromCharCode(e[r]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function decodeCreationOptions(t){return{...t,challenge:base64urlToBuffer(t.challenge),user:{...t.user,id:base64urlToBuffer(t.user.id)},excludeCredentials:(t.excludeCredentials??[]).map(e=>({...e,id:base64urlToBuffer(e.id)}))}}function decodeRequestOptions(t){return{...t,challenge:base64urlToBuffer(t.challenge),allowCredentials:(t.allowCredentials??[]).map(e=>({...e,id:base64urlToBuffer(e.id)}))}}function encodeCredentialResponse(t){const e=t.response;return{id:t.id,rawId:bufferToBase64url(t.rawId),response:{clientDataJSON:bufferToBase64url(e.clientDataJSON),attestationObject:bufferToBase64url(e.attestationObject),transports:e.getTransports?.()??[]},type:t.type,clientExtensionResults:t.getClientExtensionResults()}}function encodeAssertionResponse(t){const e=t.response;return{id:t.id,rawId:bufferToBase64url(t.rawId),response:{clientDataJSON:bufferToBase64url(e.clientDataJSON),authenticatorData:bufferToBase64url(e.authenticatorData),signature:bufferToBase64url(e.signature),userHandle:e.userHandle?bufferToBase64url(e.userHandle):void 0},type:t.type,clientExtensionResults:t.getClientExtensionResults()}}const initialState={state:"unauthenticated",pubkey:null,isAuthenticated:!1,publicKey:null,privateKey:null,nickname:null,avatar:null,isPending:!1,error:null,accountStatus:"incomplete",nsecBackedUp:!1,isReady:!1,isNip07:!1,isPasskey:!1,isLocalKey:!1,extensionName:null},STORAGE_KEY="nostr_bbs_keys",COOKIE_KEY="nostr_bbs_auth",KEEP_SIGNED_IN_KEY="nostr_bbs_keep_signed_in";function setCookie(t,e,n){const r=new Date(Date.now()+n*24*60*60*1e3).toUTCString();document.cookie=`${t}=${encodeURIComponent(e)}; expires=${r}; path=/; SameSite=Strict; Secure`}function deleteCookie(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict; Secure`}function shouldKeepSignedIn(){return localStorage.getItem(KEEP_SIGNED_IN_KEY)!=="false"}function createAuthStore(){const{subscribe:t,set:e,update:n}=writable(initialState);let r=null,s=null,a=!1;function o(y){const p={...y};return y.isAuthenticated!==void 0&&(p.state=y.isAuthenticated?"authenticated":"unauthenticated"),y.publicKey!==void 0&&(p.pubkey=y.publicKey),p}function l(){a||(a=!0,window.addEventListener("pagehide",()=>{r&&(r.fill(0),r=null),n(y=>({...y,privateKey:null}))}))}async function h(){const y=localStorage.getItem(STORAGE_KEY);if(!y){n(p=>({...p,...o({isReady:!0})}));return}try{const p=JSON.parse(y);if(p.isNip07&&p.publicKey){if(await waitForNip07(1e3))try{if(await getPublicKeyFromExtension()===p.publicKey){setNip07Signer(),n(_=>({..._,...o({publicKey:p.publicKey??null,nickname:p.nickname??null,avatar:p.avatar??null,isAuthenticated:!0,accountStatus:p.accountStatus??"complete",nsecBackedUp:!0,isNip07:!0,isPasskey:!1,extensionName:getExtensionName(),isReady:!0})}));return}}catch{}n(v=>({...v,...o({publicKey:p.publicKey??null,nickname:p.nickname??null,avatar:p.avatar??null,isAuthenticated:!1,isNip07:!1,isPasskey:!1,error:"Nostr extension not detected. Please unlock your extension or sign in again.",isReady:!0})}));return}if(p.isPasskey&&p.publicKey){n(m=>({...m,...o({publicKey:p.publicKey??null,nickname:p.nickname??null,avatar:p.avatar??null,isAuthenticated:!1,isPasskey:!1,isNip07:!1,isLocalKey:!1,accountStatus:p.accountStatus??"incomplete",nsecBackedUp:p.nsecBackedUp??!1,error:null,isReady:!0})}));return}if(p.isLocalKey&&p.publicKey){const m=sessionStorage.getItem("nostr_bbs_session_privkey")||localStorage.getItem("nostr_bbs_local_privkey");if(m){const{hexToBytes:v}=await __vitePreload(async()=>{const{hexToBytes:_}=await Promise.resolve().then(()=>utils);return{hexToBytes:_}},void 0,import.meta.url);r=v(m),n(_=>({..._,...o({publicKey:p.publicKey??null,privateKey:m,nickname:p.nickname??null,avatar:p.avatar??null,isAuthenticated:!0,accountStatus:p.accountStatus??"complete",nsecBackedUp:p.nsecBackedUp??!1,isNip07:!1,isPasskey:!1,isLocalKey:!0,error:null,isReady:!0})}));return}else{n(v=>({...v,...o({isAuthenticated:!1,isReady:!0,error:"Local session expired. Please log in again."})}));return}}n(m=>({...m,...o({isReady:!0})}))}catch{localStorage.removeItem(STORAGE_KEY),n(p=>({...p,...o({isReady:!0})}))}}return s=h(),l(),{subscribe:t,waitForReady:()=>s??Promise.resolve(),getPrivkey:()=>r,setKeysFromPasskey:(y,p,m={})=>{r=p,l();{const v=localStorage.getItem(STORAGE_KEY);let _={};if(v)try{_=JSON.parse(v)}catch{}const S={publicKey:y,isPasskey:!0,isNip07:!1,nickname:m.nickname??_.nickname??null,avatar:m.avatar??_.avatar??null,accountStatus:m.accountStatus??_.accountStatus??"incomplete",nsecBackedUp:m.nsecBackedUp??_.nsecBackedUp??!1};localStorage.setItem(STORAGE_KEY,JSON.stringify(S)),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,y,30)}n(v=>({...v,...o({publicKey:y,privateKey:utils$1.bytesToHex(p),nickname:m.nickname??v.nickname,avatar:m.avatar??v.avatar,isAuthenticated:!0,isPending:!1,error:null,accountStatus:m.accountStatus??v.accountStatus,nsecBackedUp:m.nsecBackedUp??v.nsecBackedUp,isNip07:!1,isPasskey:!0})}))},registerWithPasskey:async y=>{n(p=>({...p,isPending:!0,error:null,state:"authenticating"}));try{const p=await registerPasskey(y);r=p.privkey;const m=localStorage.getItem(STORAGE_KEY);let v=y,_=null;if(m)try{const T=JSON.parse(m);v=T.nickname??y,_=T.avatar??null}catch{}const S={publicKey:p.pubkey,isPasskey:!0,isNip07:!1,nickname:v,avatar:_,accountStatus:"incomplete",nsecBackedUp:!1};return localStorage.setItem(STORAGE_KEY,JSON.stringify(S)),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,p.pubkey,30),n(T=>({...T,...o({publicKey:p.pubkey,privateKey:utils$1.bytesToHex(p.privkey),nickname:v,avatar:_,isAuthenticated:!0,isPending:!1,error:null,accountStatus:"incomplete",nsecBackedUp:!1,isNip07:!1,isPasskey:!0})})),p}catch(p){const m=p instanceof Error?p.message:"Passkey registration failed";throw n(v=>({...v,isPending:!1,error:m,state:"unauthenticated"})),p}},loginWithPasskey:async y=>{n(p=>({...p,isPending:!0,error:null,state:"authenticating"}));try{const p=await authenticatePasskey(y);r=p.privkey,l();const m=localStorage.getItem(STORAGE_KEY);let v={};if(m)try{v=JSON.parse(m)}catch{}const _={publicKey:p.pubkey,isPasskey:!0,isNip07:!1,nickname:v.nickname??null,avatar:v.avatar??null,accountStatus:v.accountStatus??"incomplete",nsecBackedUp:v.nsecBackedUp??!1};return localStorage.setItem(STORAGE_KEY,JSON.stringify(_)),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,p.pubkey,30),n(S=>({...S,...o({publicKey:p.pubkey,privateKey:utils$1.bytesToHex(p.privkey),nickname:_.nickname,avatar:_.avatar,isAuthenticated:!0,isPending:!1,error:null,accountStatus:_.accountStatus,nsecBackedUp:_.nsecBackedUp,isNip07:!1,isPasskey:!0})})),p}catch(p){const m=p instanceof Error?p.message:"Passkey authentication failed";throw n(v=>({...v,isPending:!1,error:m,state:"unauthenticated"})),p}},loginWithLocalKey:async(y,p=!1)=>{n(m=>({...m,isPending:!0,error:null,state:"authenticating"}));try{const{restoreFromNsecOrHex:m}=await __vitePreload(async()=>{const{restoreFromNsecOrHex:q}=await import("./DDGWR2uk.js");return{restoreFromNsecOrHex:q}},[],import.meta.url),{hexToBytes:v}=await __vitePreload(async()=>{const{hexToBytes:q}=await Promise.resolve().then(()=>utils);return{hexToBytes:q}},void 0,import.meta.url),{publicKey:_,privateKey:S}=m(y);r=v(S);const T=localStorage.getItem(STORAGE_KEY);let k={};if(T)try{k=JSON.parse(T)}catch{}const O={publicKey:_,isPasskey:!1,isNip07:!1,isLocalKey:!0,nickname:k.nickname??null,avatar:k.avatar??null,accountStatus:k.accountStatus??"complete",nsecBackedUp:!0};return localStorage.setItem(STORAGE_KEY,JSON.stringify(O)),p?(localStorage.setItem("nostr_bbs_local_privkey",S),sessionStorage.removeItem("nostr_bbs_session_privkey")):(sessionStorage.setItem("nostr_bbs_session_privkey",S),localStorage.removeItem("nostr_bbs_local_privkey")),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,_,30),n(q=>({...q,...o({publicKey:_,privateKey:S,nickname:O.nickname,avatar:O.avatar,isAuthenticated:!0,isPending:!1,error:null,accountStatus:O.accountStatus,nsecBackedUp:!0,isNip07:!1,isPasskey:!1,isLocalKey:!0})})),{publicKey:_}}catch(m){const v=m instanceof Error?m.message:"Local key authentication failed";throw n(_=>({..._,isPending:!1,error:v,state:"unauthenticated"})),m}},registerWithLocalKey:async y=>{n(p=>({...p,isPending:!0,error:null,state:"authenticating"}));try{const{generateSimpleKeys:p}=await __vitePreload(async()=>{const{generateSimpleKeys:T}=await import("./DDGWR2uk.js");return{generateSimpleKeys:T}},[],import.meta.url),{hexToBytes:m}=await __vitePreload(async()=>{const{hexToBytes:T}=await Promise.resolve().then(()=>utils);return{hexToBytes:T}},void 0,import.meta.url),{publicKey:v,privateKey:_}=p();r=m(_);const S={publicKey:v,isPasskey:!1,isNip07:!1,isLocalKey:!0,nickname:y,avatar:null,accountStatus:"incomplete",nsecBackedUp:!1};return localStorage.setItem(STORAGE_KEY,JSON.stringify(S)),sessionStorage.setItem("nostr_bbs_session_privkey",_),localStorage.removeItem("nostr_bbs_local_privkey"),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,v,30),n(T=>({...T,...o({publicKey:v,privateKey:_,nickname:y,avatar:null,isAuthenticated:!0,isPending:!1,error:null,accountStatus:"incomplete",nsecBackedUp:!1,isNip07:!1,isPasskey:!1,isLocalKey:!0})})),{pubkey:v,privkeyHex:_}}catch(p){const m=p instanceof Error?p.message:"Local key registration failed";throw n(v=>({...v,isPending:!1,error:m,state:"unauthenticated"})),p}},loginWithExtension:async()=>{if(!await waitForNip07(2e3))throw new Error("No NIP-07 extension found. Please install Alby, nos2x, or another Nostr signer.");try{const p=await getPublicKeyFromExtension(),m=getExtensionName(),v={publicKey:p,isNip07:!0,isPasskey:!1,extensionName:m,accountStatus:"complete",nsecBackedUp:!0};return localStorage.setItem(STORAGE_KEY,JSON.stringify(v)),setNip07Signer(),n(_=>({..._,...o({publicKey:p,isAuthenticated:!0,isPending:!1,error:null,accountStatus:"complete",nsecBackedUp:!0,isNip07:!0,isPasskey:!1,extensionName:m})})),{publicKey:p}}catch(p){const m=p instanceof Error?p.message:"Failed to connect to extension";throw n(v=>({...v,error:m})),p}},hasExtension:()=>hasNip07Extension(),setKeys:async(y,p,m="incomplete",v=!1)=>{{const _=localStorage.getItem(STORAGE_KEY);let S={};if(_)try{S=JSON.parse(_)}catch{}const T={publicKey:y,isNip07:!1,isPasskey:!1,nickname:S.nickname??null,avatar:S.avatar??null,accountStatus:m,nsecBackedUp:v};localStorage.setItem(STORAGE_KEY,JSON.stringify(T)),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,y,30)}n(_=>({..._,...o({publicKey:y,isAuthenticated:!0,isPending:!1,error:null,accountStatus:m,nsecBackedUp:v,isNip07:!1,isPasskey:!1})}))},confirmNsecBackup:()=>{n(y=>({...y,nsecBackedUp:!0}));{const y=localStorage.getItem(STORAGE_KEY);if(y)try{const p=JSON.parse(y);p.nsecBackedUp=!0,localStorage.setItem(STORAGE_KEY,JSON.stringify(p))}catch{}}},completeSignup:()=>{n(y=>({...y,accountStatus:"complete"}));{const y=localStorage.getItem(STORAGE_KEY);if(y)try{const p=JSON.parse(y);p.accountStatus="complete",localStorage.setItem(STORAGE_KEY,JSON.stringify(p))}catch{}}},setProfile:(y,p)=>{{const m=localStorage.getItem(STORAGE_KEY);if(m)try{const v=JSON.parse(m);v.nickname=y,v.avatar=p,localStorage.setItem(STORAGE_KEY,JSON.stringify(v))}catch{}}n(m=>({...m,nickname:y,avatar:p}))},setPending:y=>{n(p=>({...p,isPending:y}))},setError:y=>{n(p=>({...p,error:y}))},clearError:()=>{n(y=>({...y,error:null}))},logout:async()=>{r&&(r.fill(0),r=null),e(initialState);{clearSigner(),localStorage.removeItem(STORAGE_KEY),localStorage.removeItem("nostr_bbs_local_privkey"),sessionStorage.removeItem("nostr_bbs_session_privkey"),deleteCookie(COOKIE_KEY);const[{whitelistStatusStore:y},{sectionStore:p},{clearWhitelistCache:m},{channelStore:v},{adminStore:_},{profileCache:S}]=await Promise.all([__vitePreload(()=>import("./CF3XGpNG.js"),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url),__vitePreload(()=>import("./aZ5XzadJ.js").then(k=>k.b),__vite__mapDeps([7,4,1,2,0,3,5,6]),import.meta.url),__vitePreload(()=>import("./BPZifr_e.js"),__vite__mapDeps([3,4]),import.meta.url),__vitePreload(()=>import("./DSxRyr52.js"),__vite__mapDeps([8,1,2]),import.meta.url),__vitePreload(()=>import("./DFQe3-5X.js"),__vite__mapDeps([9,1,2]),import.meta.url),__vitePreload(()=>import("./D7m-JnSU.js"),__vite__mapDeps([5,1,2,6]),import.meta.url)]);y.set(null),p.clear(),m(),v.clearChannels(),_.reset(),S.clear();const{goto:T}=await __vitePreload(async()=>{const{goto:k}=await import("./CTVLmyHZ.js").then(O=>O.n);return{goto:k}},__vite__mapDeps([10,1,2]),import.meta.url);T(`${base}/`)}},reset:()=>{r&&(r.fill(0),r=null),e(initialState)}}}const authStore=createAuthStore(),isAuthenticated=derived(authStore,t=>t.isAuthenticated);derived(authStore,t=>t.isReady);const isReadOnly=derived(authStore,t=>t.accountStatus==="incomplete");derived(authStore,t=>t.accountStatus);const auth=Object.freeze(Object.defineProperty({__proto__:null,authStore,isAuthenticated,isReadOnly},Symbol.toStringTag,{value:"Module"}));export{updateServiceWorker as $,hmac as A,secp256k1 as B,mod as C,Dexie as D,ConnectionState as E,connectionState as F,waitForNip07 as G,getRelayUrls as H,connectRelayWithNip07 as I,connectRelay as J,reconnectRelay as K,subscribe as L,publishEvent as M,NDKEvent$1 as N,checkIfPWA as O,isPWAInstalled as P,initPWA as Q,RELAY_URL as R,SECTION_CONFIG as S,registerServiceWorker as T,getQueuedMessages as U,isOnline as V,triggerBackgroundSync as W,canInstall as X,triggerInstall as Y,updateAvailable as Z,_md as _,authStore as a,queuedMessageCount as a0,getRole as a1,roleHasCapability as a2,roleIsHigherThan as a3,NDK_CONFIG as a4,TIMEOUTS as a5,loadConfig as a6,getSectionConfigMap as a7,index as a8,relay as a9,auth as aa,getSectionWithCategory as b,getBreadcrumbs as c,getCategories as d,ensureRelayConnected as e,getSection as f,getAppConfig as g,isConnected as h,isAuthenticated as i,nip19_exports$2 as j,fetchWithNip98 as k,getCategory as l,getSections as m,ndk as n,getCohorts as o,isReadOnly as p,nip44_exports as q,getPublicKey as r,finalizeEvent as s,generateSecretKey as t,utils$1 as u,getSectionsByCategory as v,NDK as w,pbkdf2Async_1 as x,sha512 as y,sha256 as z};
