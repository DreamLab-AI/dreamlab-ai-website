const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DUe_N5ek.js","./DxD0Wn3l.js","./CmsKOCeN.js","./xKPZ-4ZK.js","./0ZVSoAEn.js","./BToyndCo.js"])))=>i.map(i=>d[i]);
import{_ as w}from"./CmsKOCeN.js";import{w as R,d as g}from"./xKPZ-4ZK.js";import{m as D}from"./DxD0Wn3l.js";import{currentPubkey as _,isAdminVerified as S}from"./CF3XGpNG.js";import{B as p}from"./0ZVSoAEn.js";const N="Nostr-BBS-nostr-notifications";function E(){try{const s=localStorage.getItem(N);if(s){const o=JSON.parse(s),a=Date.now()-7*24*60*60*1e3;return{notifications:o.notifications.filter(t=>t.timestamp>a),lastChecked:o.lastChecked||Date.now()}}}catch(s){console.error("Failed to load notifications from storage:",s)}return{notifications:[],lastChecked:Date.now()}}function I(s){try{localStorage.setItem(N,JSON.stringify(s))}catch(o){console.error("Failed to save notifications to storage:",o)}}function O(){const s=E(),{subscribe:o,set:a,update:e}=R(s);return o(t=>{I(t)}),{subscribe:o,addNotification(t,i,n){const c={id:Math.random().toString(36).substring(2,15),type:t,message:i,channelId:n?.channelId,channelName:n?.channelName,senderPubkey:n?.senderPubkey,senderName:n?.senderName,timestamp:Date.now(),read:!1,url:n?.url};if(e(u=>({notifications:[c,...u.notifications],lastChecked:u.lastChecked})),"Notification"in window&&Notification.permission==="granted")try{new Notification("Nostr-BBS",{body:i,icon:"/favicon.png",tag:c.id})}catch(u){console.error("Failed to show browser notification:",u)}},markAsRead(t){e(i=>({notifications:i.notifications.map(n=>n.id===t?{...n,read:!0}:n),lastChecked:i.lastChecked}))},markAllAsRead(){e(t=>({notifications:t.notifications.map(i=>({...i,read:!0})),lastChecked:Date.now()}))},clearAll(){a({notifications:[],lastChecked:Date.now()})},removeNotification(t){e(i=>({notifications:i.notifications.filter(n=>n.id!==t),lastChecked:i.lastChecked}))},clearOld(){const t=Date.now()-6048e5;e(i=>({notifications:i.notifications.filter(n=>n.timestamp>t),lastChecked:i.lastChecked}))},async requestPermission(){return"Notification"in window?Notification.permission==="granted"?"granted":Notification.permission!=="denied"?await Notification.requestPermission():Notification.permission:"denied"},addMentionNotification(t){this.addNotification("mention",`${t.senderName} mentioned you in ${t.channelName}`,{channelId:t.channelId,channelName:t.channelName,senderPubkey:t.senderPubkey,senderName:t.senderName,url:`/channels/${t.channelId}`})}}}const A=O(),C=g(A,s=>s.notifications.filter(o=>!o.read));g(C,s=>s.length);g(A,s=>s.notifications.slice(0,10));function Q(s,o,a){const e=p(_);return!(s===e||o===a)}A.clearOld();const M="nostr_bbs_rate_limits",q={sectionAccessRequest:{maxAttempts:5,windowMs:60*1e3,backoffMultiplier:2,maxBackoffMs:300*1e3},cohortChange:{maxAttempts:3,windowMs:60*60*1e3,backoffMultiplier:3,maxBackoffMs:24*60*60*1e3},adminAction:{maxAttempts:10,windowMs:60*1e3,backoffMultiplier:1.5,maxBackoffMs:60*1e3}};function P(){try{const s=sessionStorage.getItem(M);return s?JSON.parse(s):{}}catch{return{}}}function T(s){try{sessionStorage.setItem(M,JSON.stringify(s))}catch{console.warn("[RateLimit] Failed to save state")}}function F(s,o){const a=q[o],e=P(),t=Date.now(),i=e[s];if(!i)return{allowed:!0};if(i.backoffUntil>t){const n=i.backoffUntil-t;return{allowed:!1,waitMs:n,reason:`Rate limited. Please wait ${Math.ceil(n/1e3)} seconds.`}}if(t-i.firstAttempt>a.windowMs)return{allowed:!0};if(i.attempts>=a.maxAttempts){const n=Math.min(a.windowMs*Math.pow(a.backoffMultiplier,i.consecutiveFailures),a.maxBackoffMs);return{allowed:!1,waitMs:n,reason:`Too many attempts. Please wait ${Math.ceil(n/1e3)} seconds.`}}return{allowed:!0}}function k(s,o,a){const e=q[o],t=P(),i=Date.now();let n=t[s];if((!n||i-n.firstAttempt>e.windowMs)&&(n={attempts:0,firstAttempt:i,lastAttempt:i,consecutiveFailures:0,backoffUntil:0}),n.attempts++,n.lastAttempt=i,a)n.consecutiveFailures=0,n.backoffUntil=0;else if(n.consecutiveFailures++,n.attempts>=e.maxAttempts){const c=Math.min(e.windowMs*Math.pow(e.backoffMultiplier,n.consecutiveFailures),e.maxBackoffMs);n.backoffUntil=i+c}t[s]=n,T(t)}const L=1059,x=13,b="nostr_bbs_section_access",v=D().filter(s=>s.access.autoApprove).map(s=>({section:s.id,status:"approved"})),y={access:v,pendingRequests:[],stats:[],loading:!1,error:null};function $(){try{const s=localStorage.getItem(b);if(s){const o=JSON.parse(s),a=o.access||[],e=new Set(a.map(i=>i.section)),t=v.filter(i=>!e.has(i.section));return t.length>0&&(o.access=[...t,...a]),{...y,...o}}}catch(s){console.error("[Sections] Failed to load from storage:",s)}return y}function B(s){try{localStorage.setItem(b,JSON.stringify({access:s.access,stats:s.stats}))}catch(o){console.error("[Sections] Failed to save to storage:",o)}}function U(){const{subscribe:s,set:o,update:a}=R($());return s(e=>B(e)),{subscribe:s,getAccessStatus(e){return p({subscribe:s}).access.find(n=>n.section===e)?.status||"none"},canAccessSection(e){return this.getAccessStatus(e)==="approved"},async requestSectionAccess(e,t){const i=p(_);if(!i)return{success:!1,error:"Not authenticated"};const n=`section_access:${i}:${e}`,c=F(n,"sectionAccessRequest");if(!c.allowed)return console.warn("[Sections] Rate limited:",c.reason),{success:!1,error:c.reason||"Too many requests. Please wait.",waitMs:c.waitMs};const u=this.getAccessStatus(e);if(u==="approved")return{success:!1,error:"Already have access to this section"};if(u==="pending")return{success:!1,error:"Request already pending"};if(v.some(r=>r.section===e))return a(r=>({...r,access:[...r.access.filter(l=>l.section!==e),{section:e,status:"approved",approvedAt:Date.now()}]})),k(n,"sectionAccessRequest",!0),{success:!0};a(r=>({...r,access:[...r.access.filter(l=>l.section!==e),{section:e,status:"pending",requestedAt:Date.now()}]}));const{requestSectionAccess:f}=await w(async()=>{const{requestSectionAccess:r}=await import("./DUe_N5ek.js");return{requestSectionAccess:r}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),d=await f(e,t);return d.success?(k(n,"sectionAccessRequest",!0),{success:!0}):(k(n,"sectionAccessRequest",!1),a(r=>({...r,access:r.access.filter(l=>!(l.section===e&&l.status==="pending"))})),{success:!1,error:d.error})},async approveRequest(e){if(!p(S))return{success:!1,error:"Admin access required"};a(c=>({...c,pendingRequests:c.pendingRequests.filter(u=>u.id!==e.id)}));const{approveSectionAccess:i}=await w(async()=>{const{approveSectionAccess:c}=await import("./DUe_N5ek.js");return{approveSectionAccess:c}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),n=await i(e);return n.success?{success:!0}:(a(c=>({...c,pendingRequests:[e,...c.pendingRequests]})),{success:!1,error:n.error})},async denyRequest(e,t){if(!p(S))return{success:!1,error:"Admin access required"};if(a(n=>({...n,pendingRequests:n.pendingRequests.filter(c=>c.id!==e.id)})),t)try{const{ndk:n}=await w(async()=>{const{ndk:d}=await import("./DxD0Wn3l.js").then(r=>r.a9);return{ndk:d}},__vite__mapDeps([1,2,3,4,5]),import.meta.url),{NDKEvent:c}=await w(async()=>{const{NDKEvent:d}=await import("./DxD0Wn3l.js").then(r=>r.a8);return{NDKEvent:d}},__vite__mapDeps([1,2,3,4,5]),import.meta.url),u=n();if(!u)return console.error("[Sections] NDK not initialized for DM"),{success:!0};const f=u.signer;if(f){const d=`Your access request for ${e.section} has been denied. Reason: ${t}`,r=u.getUser({pubkey:e.requesterPubkey}),l=new c(u);l.kind=x,l.tags=[["p",e.requesterPubkey]],l.content=d,l.created_at=Math.floor(Date.now()/1e3),await l.sign(f);const m=new c(u);m.kind=L,m.tags=[["p",e.requesterPubkey]],m.content=await f.encrypt(r,JSON.stringify(l.rawEvent())),m.created_at=Math.floor(Date.now()/1e3),await m.sign(f),await m.publish()}}catch(n){console.error("[Sections] Failed to send denial DM:",n)}return{success:!0}},addPendingRequest(e){a(t=>({...t,pendingRequests:[e,...t.pendingRequests.filter(i=>i.id!==e.id)]})),A.addNotification("join-request",`New access request for ${e.section}`,{senderPubkey:e.requesterPubkey,url:"/admin?tab=section-requests"})},setAccess(e){a(t=>({...t,access:[...t.access.filter(i=>i.section!==e.section),e]}))},updateStats(e){a(t=>({...t,stats:[...t.stats.filter(i=>i.section!==e.section),e]}))},getStats(e){return p({subscribe:s}).stats.find(i=>i.section===e)},clear(){o(y),localStorage.removeItem(b)},async refresh(){a(e=>({...e,loading:!0,error:null}));try{const e=p(_),t=p(S),{fetchSectionStats:i,fetchUserAccess:n,fetchPendingRequests:c}=await w(async()=>{const{fetchSectionStats:r,fetchUserAccess:l,fetchPendingRequests:m}=await import("./DUe_N5ek.js");return{fetchSectionStats:r,fetchUserAccess:l,fetchPendingRequests:m}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),[u,f,d]=await Promise.all([i(),e?n(e):Promise.resolve([]),t?c():Promise.resolve([])]);a(r=>({...r,stats:u,access:f.length>0?f:r.access,pendingRequests:t?d:r.pendingRequests,loading:!1}))}catch(e){const t=e instanceof Error?e.message:"Failed to refresh";a(i=>({...i,loading:!1,error:t}))}}}}const h=U(),K=g(h,s=>s.access.filter(o=>o.status==="approved").map(o=>o.section)),J=g(h,s=>s.access.filter(o=>o.status==="pending").map(o=>o.section)),V=g(h,s=>s.pendingRequests.length);function G(s,o,a){return h.canAccessSection(s)?o==="public":!1}const X=Object.freeze(Object.defineProperty({__proto__:null,accessibleSections:K,canSeeChannel:G,pendingRequestCount:V,pendingSections:J,sectionStore:h},Symbol.toStringTag,{value:"Module"}));export{Q as a,X as b,A as n,h as s};
