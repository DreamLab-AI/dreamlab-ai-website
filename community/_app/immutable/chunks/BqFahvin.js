import{n as g,h as v,N as M,b as _}from"./DxD0Wn3l.js";import{v as R,c as I,R as N,a as F}from"./BzOJhCVF.js";const C=8e3,m={CREATE:40,METADATA:41,MESSAGE:42,HIDE_MESSAGE:43,MUTE_USER:44};async function H(e){if(!g()?.signer)throw new Error("No signer configured. Please login first.");const l=R(e.name);if(!l.valid)throw new Error(`Invalid channel name: ${l.errors.join(", ")}`);const i=I("channelCreate");if(!i.allowed)throw new N(`Channel creation rate limit exceeded. Try again in ${i.retryAfter} seconds.`,i.retryAfter);if(!v())throw new Error("Not connected to relays. Please wait for connection.");const d={name:e.name,about:e.description},t=new M(g());t.kind=m.CREATE,t.content=JSON.stringify(d),e.visibility&&e.visibility!=="public"&&t.tags.push(["visibility",e.visibility]),e.cohorts&&e.cohorts.length>0&&t.tags.push(["cohort",e.cohorts.join(",")]),e.encrypted&&t.tags.push(["encrypted","true"]);const a=e.section||"dreamlab-lobby";t.tags.push(["section",a]);const n=e.accessType||"gated";return t.tags.push(["access-type",n]),await t.sign(),await t.publish(),{id:t.id,name:e.name,description:e.description,visibility:e.visibility||"public",accessType:n,cohorts:e.cohorts||[],encrypted:e.encrypted||!1,section:a,createdAt:t.created_at||Math.floor(Date.now()/1e3),creatorPubkey:t.pubkey}}function x(e,c){const{userCohorts:l,userPubkey:i,isAdmin:d=!1}=c;return d||e.creatorPubkey===i?!0:k(e,l,i,d)?e.accessType==="open"||e.cohorts.length===0?!0:e.cohorts.some(t=>l.includes(t)):!1}async function A(e){const c=g();if(!c||!v())return null;const l={kinds:[m.CREATE],ids:[e],limit:1},i=new Promise(t=>{setTimeout(()=>t(new Set),C)}),d=await Promise.race([c.fetchEvents(l),i]);for(const t of d)try{const a=JSON.parse(t.content),n=t.tags.find(s=>s[0]==="visibility"),o=t.tags.find(s=>s[0]==="access-type"),r=t.tags.find(s=>s[0]==="cohort"),u=t.tags.find(s=>s[0]==="encrypted"),b=t.tags.find(s=>s[0]==="section");return{id:t.id,name:a.name||"Unnamed Channel",description:a.about,visibility:n?.[1]||"public",accessType:o?.[1]||"gated",cohorts:r?.[1]?.split(",").filter(Boolean)||[],encrypted:u?.[1]==="true",section:b?.[1]||"dreamlab-lobby",createdAt:t.created_at||0,creatorPubkey:t.pubkey}}catch(a){console.error("Failed to parse channel event:",a)}return null}async function L(e,c,l,i){if(!g()?.signer)throw new Error("No signer configured. Please login first.");const t=F(c);if(!t.valid)throw new Error(`Invalid message: ${t.errors.join(", ")}`);const a=I("message");if(!a.allowed)throw new N(`Message rate limit exceeded. Try again in ${a.retryAfter} seconds.`,a.retryAfter);if(!v())throw new Error("Not connected to relays. Please wait for connection.");if(i){const r=await A(e);if(!r)throw new Error("Channel not found. Cannot verify posting permissions.");if(!x(r,i))throw new Error("You do not have permission to post in this channel.")}else console.warn("[channels] sendChannelMessage called without authContext — posting permission checks skipped. Pass authContext to enforce security.");const n={},o=new M(g());if(o.kind=m.MESSAGE,o.content=c,o.tags.push(["e",e,"","root"]),n.replyTo&&o.tags.push(["e",n.replyTo,"","reply"]),n.additionalTags)for(const r of n.additionalTags)o.tags.push(r);return await o.sign(),await o.publish(),o.id}function P(e,c,l){if(l)return!0;const i=_(e.section);if(!i)return!0;const{category:d}=i;return!d.access||c.includes("cross-access")?!0:d.access.hiddenFromCohorts?.length&&d.access.hiddenFromCohorts.some(a=>c.includes(a))?!1:d.access.visibleToCohorts?.length?d.access.visibleToCohorts.some(t=>c.includes(t)):!0}function k(e,c,l,i){return i||l&&e.creatorPubkey===l||e.visibility==="public"||e.cohorts.length===0?!0:e.cohorts.length>0&&c.length>0?e.cohorts.some(t=>c.includes(t)):!1}async function O(e={}){const{userCohorts:c=[],userPubkey:l,isAdmin:i=!1,limit:d=100}=e,t=g();if(!t)return[];if(!v())return[];const a={kinds:[m.CREATE],limit:d},n=new Promise(s=>{setTimeout(()=>s(new Set),C)}),o=await Promise.race([t.fetchEvents(a),n]),r=[];for(const s of o)try{const f=JSON.parse(s.content),w=s.tags.find(h=>h[0]==="visibility"),p=s.tags.find(h=>h[0]==="access-type"),S=s.tags.find(h=>h[0]==="cohort"),T=s.tags.find(h=>h[0]==="encrypted"),y=s.tags.find(h=>h[0]==="section"),E={id:s.id,name:f.name||"Unnamed Channel",description:f.about,visibility:w?.[1]||"public",accessType:p?.[1]||"gated",cohorts:S?.[1]?.split(",").filter(Boolean)||[],encrypted:T?.[1]==="true",section:y?.[1]||"dreamlab-lobby",createdAt:s.created_at||0,creatorPubkey:s.pubkey};k(E,c,l,i)&&P(E,c,i)&&r.push(E)}catch(f){console.error("Failed to parse channel event:",f)}const u=r.map(s=>s.id),b=new Map;if(u.length>0)try{const s={kinds:[m.MESSAGE],"#e":u,limit:u.length*2},f=new Promise(p=>{setTimeout(()=>p(new Set),C)}),w=await Promise.race([t.fetchEvents(s),f]);for(const p of w){const T=p.tags.find(y=>y[0]==="e"&&(y[3]==="root"||!y[3]))?.[1];if(T){const y=p.created_at||0,E=b.get(T)||0;y>E&&b.set(T,y)}}}catch(s){console.warn("Failed to fetch last activity for channel sorting:",s)}return r.sort((s,f)=>{const w=b.get(s.id)||s.createdAt;return(b.get(f.id)||f.createdAt)-w}),r}async function U(e,c=50,l){const i=g();if(!i)return[];if(!v())return[];if(l){const n=await A(e);if(n){const{userCohorts:o,userPubkey:r,isAdmin:u=!1}=l;if(!k(n,o,r,u)||!P(n,o,u))return[]}}else console.warn("[channels] fetchChannelMessages called without authContext — channel access checks skipped. Pass authContext to enforce security.");const d={kinds:[m.MESSAGE],"#e":[e],limit:c},t=await i.fetchEvents(d),a=[];for(const n of t){const o=n.tags.find(r=>r[0]==="e"&&r[3]==="reply");a.push({id:n.id,content:n.content,pubkey:n.pubkey,createdAt:n.created_at||0,replyTo:o?.[1],tags:n.tags.map(r=>[...r])})}return a.sort((n,o)=>n.createdAt-o.createdAt),a}async function $(e,c,l){const i={unsubscribe:()=>{}},d=g();if(!d)return i;if(l){const n=await A(e);if(n){const{userCohorts:o,userPubkey:r,isAdmin:u=!1}=l;if(!k(n,o,r,u)||!P(n,o,u))return i}}else console.warn("[channels] subscribeToChannel called without authContext — channel access checks skipped. Pass authContext to enforce security.");const t={kinds:[m.MESSAGE],"#e":[e],since:Math.floor(Date.now()/1e3)},a=d.subscribe(t,{closeOnEose:!1});return a.on("event",n=>{const o=n.tags.find(r=>r[0]==="e"&&r[3]==="reply");c({id:n.id,content:n.content,pubkey:n.pubkey,createdAt:n.created_at||0,replyTo:o?.[1],tags:n.tags.map(r=>[...r])})}),{unsubscribe:()=>{a.stop()}}}export{A as a,U as b,H as c,L as d,O as f,$ as s};
