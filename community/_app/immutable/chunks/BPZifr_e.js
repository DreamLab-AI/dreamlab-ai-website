const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DxD0Wn3l.js","./CmsKOCeN.js","./xKPZ-4ZK.js","./0ZVSoAEn.js","./BToyndCo.js","./D31DSQKd.js","./Bk9P-LIi.js"])))=>i.map(i=>d[i]);
import{_ as f}from"./CmsKOCeN.js";import{k as R,R as U}from"./DxD0Wn3l.js";const p=new Map,T=5*60*1e3;function w(){return U.replace("wss://","https://").replace("ws://","http://")}async function m(t){if(!t)return d(t);const e=p.get(t);if(e&&e.expiresAt>Date.now())return{...e.status,source:"cache"};try{if(!/^[0-9a-f]{64}$/i.test(t))return console.warn("[Whitelist] Invalid pubkey format, using fallback"),d(t);const s=w(),a=await fetch(`${s}/api/check-whitelist?pubkey=${encodeURIComponent(t)}`,{method:"GET",headers:{Accept:"application/json"}});if(a.ok){const o=await a.json(),n={isWhitelisted:o.isWhitelisted??!1,isAdmin:o.isAdmin??!1,cohorts:o.cohorts??[],verifiedAt:o.verifiedAt??Date.now(),source:"relay"};return _(t,n),n}console.warn("[Whitelist] API call failed, using fallback");const r=d(t);return _(t,r),r}catch(s){return console.warn("[Whitelist] Verification failed, using fallback:",s),d(t)}}function d(t){const e="11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c".split(",").map(a=>a.trim()).filter(Boolean),s=e.length>0&&e.includes(t);return{isWhitelisted:s,isAdmin:s,cohorts:s?["admin"]:[],verifiedAt:Date.now(),source:"fallback"}}function _(t,e){p.set(t,{status:e,expiresAt:Date.now()+T})}function A(t){t?p.delete(t):p.clear()}async function L(t){return(await m(t)).isAdmin}async function S(t,e){return(await m(t)).cohorts.includes(e)}async function D(t){return(await m(t)).cohorts}async function W(t){const e=await m(t);return{isApproved:e.isWhitelisted,isAdmin:e.isAdmin}}async function I(t,e){try{const{ndk:s,connectRelay:a,isConnected:r}=await f(async()=>{const{ndk:u,connectRelay:h,isConnected:E}=await import("./DxD0Wn3l.js").then(g=>g.a9);return{ndk:u,connectRelay:h,isConnected:E}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),{RELAY_URL:o}=await f(async()=>{const{RELAY_URL:u}=await import("./D31DSQKd.js").then(h=>h.i);return{RELAY_URL:u}},__vite__mapDeps([5,0,1,2,3,4]),import.meta.url),{NDKEvent:n}=await f(async()=>{const{NDKEvent:u}=await import("./DxD0Wn3l.js").then(h=>h.a8);return{NDKEvent:u}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),{KIND_USER_REGISTRATION:i}=await f(async()=>{const{KIND_USER_REGISTRATION:u}=await import("./Bk9P-LIi.js");return{KIND_USER_REGISTRATION:u}},__vite__mapDeps([6,0,1,2,3,4]),import.meta.url);r()||await a(o,t);const c=s();if(!c?.signer)return{success:!1,error:"Failed to set up signer"};const l=new n(c);return l.kind=i,l.content="New user registration request",l.tags=[["t","registration"]],e&&l.tags.push(["name",e]),await l.sign(),await l.publish(),{success:!0}}catch(s){return console.error("[Registration] Failed to publish registration request:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}async function P(t,e,s){try{const r=`${w()}/api/whitelist/add`,o=JSON.stringify({pubkey:t,cohorts:["approved"],adminPubkey:e}),n={method:"POST",headers:{"Content-Type":"application/json"},body:o},i=s?await R(r,n,s):await fetch(r,n);return i.ok?(A(t),{success:!0}):{success:!1,error:(await i.json().catch(()=>({}))).error||`HTTP ${i.status}`}}catch(a){return console.error("[Whitelist] Failed to approve registration:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function C(t){const e=w(),s=new URLSearchParams;t?.limit&&s.set("limit",String(t.limit)),t?.offset&&s.set("offset",String(t.offset)),t?.cohort&&s.set("cohort",t.cohort);const a=`${e}/api/whitelist/list?${s}`;try{const r=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});if(r.ok){const n=await r.json();return{users:n.users||[],total:n.total||0,limit:n.limit||20,offset:n.offset||0}}const o=await r.text().catch(()=>"Unable to read error response");throw console.error("[Whitelist] Failed to fetch users:",r.status,o),new Error(`API returned ${r.status}: ${o.slice(0,100)}`)}catch(r){throw console.error("[Whitelist] Failed to fetch users:",r),r}}async function O(t,e,s,a){try{const o=`${w()}/api/whitelist/update-cohorts`,n=JSON.stringify({pubkey:t,cohorts:e,adminPubkey:s}),i={method:"POST",headers:{"Content-Type":"application/json"},body:n},c=a?await R(o,i,a):await fetch(o,i);return c.ok?(A(t),{success:!0}):{success:!1,error:(await c.json().catch(()=>({}))).error||`HTTP ${c.status}`}}catch(r){return console.error("[Whitelist] Failed to update cohorts:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}export{P as approveUserRegistration,W as checkWhitelistStatus,A as clearWhitelistCache,d as createFallbackStatus,C as fetchWhitelistUsers,D as getUserCohorts,I as publishRegistrationRequest,O as updateUserCohorts,L as verifyAdminStatus,S as verifyCohortMembership,m as verifyWhitelistStatus};
