import{w as D,d as R}from"./xKPZ-4ZK.js";import{n as U,a as y}from"./DxD0Wn3l.js";import{KIND_USER_REGISTRATION as K}from"./Bk9P-LIi.js";import{B as v}from"./0ZVSoAEn.js";class Q{queue=[];activeCount=0;maxConcurrent;constructor(t=5){this.maxConcurrent=t}async execute(t){return new Promise((c,f)=>{this.queue.push({fn:t,resolve:c,reject:f}),this.processQueue()})}async processQueue(){if(this.activeCount>=this.maxConcurrent||this.queue.length===0)return;const t=this.queue.shift();if(t){this.activeCount++;try{const c=await t.fn();t.resolve(c)}catch(c){t.reject(c)}finally{this.activeCount--,this.processQueue()}}}get queueSize(){return this.queue.length}get active(){return this.activeCount}clear(){for(const t of this.queue)t.reject(new Error("Queue cleared"));this.queue=[]}}const E=5*60*1e3,z=500,H=5,O=new Q(H);function $(){const{subscribe:l,update:t,set:c}=D({profiles:new Map});async function f(e){const n=v({subscribe:l}).profiles.get(e),u=Date.now();if(n&&u-n.lastFetched<E&&!n.isFetching||n?.isFetching)return n;const h={pubkey:e,profile:null,displayName:m(e),avatar:null,nip05:null,about:null,lastFetched:0,isFetching:!0};t(s=>{const r=new Map(s.profiles);return r.set(e,h),{...s,profiles:r}});try{const s=U();if(!s){console.debug("[ProfileCache] NDK not initialized, returning placeholder for",e.slice(0,8));const o={pubkey:e,profile:null,displayName:m(e),avatar:null,nip05:null,about:null,lastFetched:0,isFetching:!1};return t(a=>{const d=new Map(a.profiles);return d.set(e,o),{...a,profiles:d}}),o}const r=await O.execute(async()=>{const o=s.getUser({pubkey:e});return await o.fetchProfile(),o.profile||null}),p=v(y),g=p.publicKey===e,C=g?p.nickname:null,x=g?p.avatar:null;let F=null;if(!r?.displayName&&!r?.name&&!C)try{const o=await s.fetchEvents({kinds:[K],authors:[e],limit:1}),a=Array.from(o)[0];a&&(F=a.tags.find(w=>w[0]==="name")?.[1]||null)}catch{}const N={pubkey:e,profile:r||null,displayName:C||r?.displayName||r?.name||F||m(e),avatar:x||r?.image||r?.picture||null,nip05:r?.nip05||null,about:r?.about||null,lastFetched:u,isFetching:!1};return t(o=>{const a=new Map(o.profiles);if(a.size>=z){const d=Array.from(a.entries()).sort((w,I)=>w[1].lastFetched-I[1].lastFetched)[0]?.[0];d&&a.delete(d)}return a.set(e,N),{...o,profiles:a}}),N}catch(s){console.error(`Failed to fetch profile for ${e}:`,s);const r={pubkey:e,profile:null,displayName:m(e),avatar:null,nip05:null,about:null,lastFetched:u,isFetching:!1};return t(p=>{const g=new Map(p.profiles);return g.set(e,r),{...p,profiles:g}}),r}}function M(e){return v({subscribe:l}).profiles.get(e)||null}async function A(e){const i=[...new Set(e)];await Promise.all(i.map(n=>f(n)))}function q(){c({profiles:new Map})}function S(e){t(i=>{const n=new Map(i.profiles);return n.delete(e),{...i,profiles:n}})}function T(e,i,n){t(u=>{const h=new Map(u.profiles),s=h.get(e),r={pubkey:e,profile:s?.profile||null,displayName:i||m(e),avatar:n||null,nip05:s?.nip05||null,about:s?.about||null,lastFetched:Date.now(),isFetching:!1};return h.set(e,r),{...u,profiles:h}})}function _(){const e=Date.now();t(i=>{const n=new Map(i.profiles);for(const[u,h]of n.entries())e-h.lastFetched>=E&&n.delete(u);return{...i,profiles:n}})}return setInterval(_,60*1e3),{subscribe:l,getProfile:f,getCachedSync:M,prefetchProfiles:A,clear:q,remove:S,updateCurrentUserProfile:T}}function m(l){return l.length<=16?l:`${l.slice(0,8)}...${l.slice(-4)}`}const P=$();function Z(l){return R(P,(t,c)=>{const f=t.profiles.get(l);f?c(f):P.getProfile(l).then(c)},{pubkey:l,profile:null,displayName:m(l),avatar:null,nip05:null,about:null,lastFetched:0,isFetching:!1})}export{Z as createProfileStore,P as profileCache};
