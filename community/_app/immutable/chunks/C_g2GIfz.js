const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DxD0Wn3l.js","./CmsKOCeN.js","./xKPZ-4ZK.js","./0ZVSoAEn.js","./BToyndCo.js"])))=>i.map(i=>d[i]);
import{_}from"./CmsKOCeN.js";import{d as k,w as z}from"./xKPZ-4ZK.js";import{q as b,r as h,s as I,t as F}from"./DxD0Wn3l.js";import{i as x,a as V,c as W,R as U}from"./BzOJhCVF.js";import{m as E}from"./B4OHgsDO.js";import{profileCache as $}from"./D7m-JnSU.js";import{B as j}from"./0ZVSoAEn.js";const L=14,N=1059,A=13,O=2*24*60*60;async function G(r,l,i,e,a){if(!x(l))throw new Error("Invalid recipient public key");const t=V(r);if(!t.valid)throw new Error(`Invalid message: ${t.errors.join(", ")}`);const p=W("dm");if(!p.allowed)throw new U(`DM rate limit exceeded. Try again in ${p.retryAfter} seconds.`,p.retryAfter);const n=h(i),o=Math.floor(Date.now()/1e3),f={kind:L,pubkey:n,created_at:o,tags:[["p",l]],content:r},d=b.v2.utils.getConversationKey(i,l),m=b.v2.encrypt(JSON.stringify(f),d),c=I({kind:A,pubkey:n,created_at:o,tags:[],content:m},i),g=F(),y=h(g),v=Math.floor(Math.random()*(2*O))-O,M=o+v,C=b.v2.utils.getConversationKey(g,l),w=b.v2.encrypt(JSON.stringify(c),C),J=I({kind:N,pubkey:y,created_at:M,tags:[["p",l]],content:w},g);await e.publish(J)}function D(r,l){try{if(r.kind!==N)return null;const i=b.v2.utils.getConversationKey(l,r.pubkey),e=b.v2.decrypt(r.content,i),a=JSON.parse(e);if(a.kind!==A)return null;const t=b.v2.utils.getConversationKey(l,a.pubkey),p=b.v2.decrypt(a.content,t),n=JSON.parse(p);return n.kind!==L?null:{content:n.content,senderPubkey:n.pubkey,timestamp:n.created_at}}catch(i){return console.error("Failed to decrypt DM:",i),null}}function K(r){return{kinds:[N],"#p":[r]}}const R={conversations:new Map,currentConversation:null,messages:[],isLoading:!1,error:null,isSubscribed:!1};function q(){const{subscribe:r,set:l,update:i}=z(R);return{subscribe:r,fetchConversations:async(e,a)=>{i(t=>({...t,isLoading:!0,error:null}));try{const t=h(a),p=K(t),{ndk:n}=await _(async()=>{const{ndk:s}=await import("./DxD0Wn3l.js").then(c=>c.a9);return{ndk:s}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),o=n();if(!o)throw new Error("NDK not initialized");const u=await o.fetchEvents(p),f=Array.from(u).map(s=>({id:s.id,kind:s.kind,pubkey:s.pubkey,created_at:s.created_at,tags:s.tags,content:s.content,sig:s.sig})),d=new Map,m=new Map;for(const s of f){const c=D(s,a);if(!c)continue;const g=c.senderPubkey,y={id:s.id,senderPubkey:c.senderPubkey,recipientPubkey:t,content:c.content,timestamp:c.timestamp,isSent:!1,isRead:!1};m.has(g)||m.set(g,[]),m.get(g).push(y);const v=d.get(g);(!v||c.timestamp>v.lastMessageTimestamp)&&d.set(g,{pubkey:g,name:S(g),lastMessage:c.content.substring(0,50)+(c.content.length>50?"...":""),lastMessageTimestamp:c.timestamp,unreadCount:(v?.unreadCount??0)+1,isPinned:v?.isPinned??!1})}if(typeof window<"u"){const s={};m.forEach((c,g)=>{s[g]=c}),localStorage.setItem("dm_messages",JSON.stringify(s))}i(s=>({...s,conversations:d,isLoading:!1}))}catch(t){i(p=>({...p,isLoading:!1,error:t instanceof Error?t.message:"Failed to fetch conversations"}))}},selectConversation:e=>{i(a=>{const t=a.conversations.get(e);if(!t)return a;const p={...t,unreadCount:0},n=new Map(a.conversations);n.set(e,p);let o=[];if(typeof window<"u"){const u=localStorage.getItem("dm_messages");if(u)try{o=JSON.parse(u)[e]||[],o.sort((d,m)=>d.timestamp-m.timestamp)}catch(f){console.error("Failed to load messages:",f)}}return{...a,currentConversation:e,conversations:n,messages:o}})},sendDM:async(e,a,t)=>{const n=j({subscribe:r}).currentConversation;if(!n)throw new Error("No conversation selected");try{const o=h(t),{ndk:u}=await _(async()=>{const{ndk:s}=await import("./DxD0Wn3l.js").then(c=>c.a9);return{ndk:s}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),f=u();if(!f)throw new Error("NDK not initialized");await G(e,n,t,{publish:async s=>{const c=(await _(async()=>{const{NDKEvent:y}=await import("./DxD0Wn3l.js").then(v=>v.a8);return{NDKEvent:y}},__vite__mapDeps([0,1,2,3,4]),import.meta.url)).NDKEvent;await new c(f,s).publish()}});const m={id:`temp-${Date.now()}`,senderPubkey:o,recipientPubkey:n,content:e,timestamp:Math.floor(Date.now()/1e3),isSent:!0,isRead:!0};i(s=>{const c=[...s.messages,m],g=s.conversations.get(n);if(g){const y={...g,lastMessage:e.substring(0,50)+(e.length>50?"...":""),lastMessageTimestamp:m.timestamp},v=new Map(s.conversations);if(v.set(n,y),typeof window<"u"){const M=localStorage.getItem("dm_messages");let C={};if(M)try{C=JSON.parse(M)}catch(w){console.error("Failed to parse stored messages:",w)}C[n]=c,localStorage.setItem("dm_messages",JSON.stringify(C))}return{...s,conversations:v,messages:c}}return{...s,messages:c}})}catch(o){throw i(u=>({...u,error:o instanceof Error?o.message:"Failed to send message"})),o}},startConversation:(e,a)=>{i(t=>{if(t.conversations.get(e))return{...t,currentConversation:e,messages:[]};const n={pubkey:e,name:a??S(e),lastMessage:"",lastMessageTimestamp:0,unreadCount:0,isPinned:!1},o=new Map(t.conversations);return o.set(e,n),{...t,conversations:o,currentConversation:e,messages:[]}})},subscribeToIncoming:async e=>{const a=h(e),t=K(a),{ndk:p}=await _(async()=>{const{ndk:u}=await import("./DxD0Wn3l.js").then(f=>f.a9);return{ndk:u}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),n=p();if(!n)throw new Error("NDK not initialized");const o=n.subscribe(t,{closeOnEose:!1});return o.on("event",u=>{const f={id:u.id,kind:u.kind,pubkey:u.pubkey,created_at:u.created_at,tags:u.tags,content:u.content,sig:u.sig},d=D(f,e);if(d){const m=d.senderPubkey;i(s=>{const c={id:f.id,senderPubkey:d.senderPubkey,recipientPubkey:a,content:d.content,timestamp:d.timestamp,isSent:!1,isRead:s.currentConversation===m},g=s.currentConversation===m?[...s.messages,c]:s.messages;if(typeof window<"u"){const C=localStorage.getItem("dm_messages");let w={};if(C)try{w=JSON.parse(C)}catch(T){console.error("Failed to parse stored messages:",T)}w[m]||(w[m]=[]),w[m].push(c),localStorage.setItem("dm_messages",JSON.stringify(w))}const y=s.conversations.get(m),v=y?{...y,lastMessage:d.content.substring(0,50)+(d.content.length>50?"...":""),lastMessageTimestamp:d.timestamp,unreadCount:s.currentConversation===m?y.unreadCount:y.unreadCount+1}:{pubkey:m,name:S(m),lastMessage:d.content.substring(0,50)+(d.content.length>50?"...":""),lastMessageTimestamp:d.timestamp,unreadCount:1,isPinned:!1},M=new Map(s.conversations);return M.set(m,v),{...s,conversations:M,messages:g,isSubscribed:!0}})}}),i(u=>({...u,isSubscribed:!0})),()=>{o.stop(),i(u=>({...u,isSubscribed:!1}))}},handleIncomingDM:(e,a)=>{const t=D(e,a);if(!t)return;const p=h(a),n=t.senderPubkey;i(o=>{const u={id:e.id,senderPubkey:t.senderPubkey,recipientPubkey:p,content:t.content,timestamp:t.timestamp,isSent:!1,isRead:o.currentConversation===n},f=o.currentConversation===n?[...o.messages,u]:o.messages,d=o.conversations.get(n),m=d?{...d,lastMessage:t.content.substring(0,50)+(t.content.length>50?"...":""),lastMessageTimestamp:t.timestamp,unreadCount:o.currentConversation===n?d.unreadCount:d.unreadCount+1}:{pubkey:n,name:S(n),lastMessage:t.content.substring(0,50)+(t.content.length>50?"...":""),lastMessageTimestamp:t.timestamp,unreadCount:1,isPinned:!1},s=new Map(o.conversations);return s.set(n,m),{...o,conversations:s,messages:f}})},clearConversation:()=>{i(e=>({...e,currentConversation:null,messages:[]}))},forceLoadingComplete:()=>{i(e=>({...e,isLoading:!1}))},clearError:()=>{i(e=>({...e,error:null}))},reset:()=>{l(R)}}}function B(r){return r.length<=16?r:`${r.substring(0,8)}...${r.substring(r.length-8)}`}function S(r){const l=$.getCachedSync(r);return l?.displayName?l.displayName:B(r)}const P=q(),te=k([P,E],([r,l])=>Array.from(r.conversations.values()).filter(e=>!l.mutedUsers.has(e.pubkey)).sort((e,a)=>e.isPinned&&!a.isPinned?-1:!e.isPinned&&a.isPinned?1:a.lastMessageTimestamp-e.lastMessageTimestamp));k([P,E],([r,l])=>Array.from(r.conversations.values()).filter(e=>l.mutedUsers.has(e.pubkey)).sort((e,a)=>a.lastMessageTimestamp-e.lastMessageTimestamp));k(P,r=>{let l=0;for(const i of r.conversations.values())l+=i.unreadCount;return l});k(P,r=>r.currentConversation?r.conversations.get(r.currentConversation)??null:null);export{P as d,te as s};
