import{d as c,w as u}from"./C7Jxsl90.js";import{c as m}from"./BFkiipW6.js";import{B as h}from"./CwRy9Tox.js";const l="Nostr-BBS-nostr-notifications";function N(){try{const i=localStorage.getItem(l);if(i){const o=JSON.parse(i),r=Date.now()-7*24*60*60*1e3;return{notifications:o.notifications.filter(e=>e.timestamp>r),lastChecked:o.lastChecked||Date.now()}}}catch(i){console.error("Failed to load notifications from storage:",i)}return{notifications:[],lastChecked:Date.now()}}function k(i){try{localStorage.setItem(l,JSON.stringify(i))}catch(o){console.error("Failed to save notifications to storage:",o)}}function g(){const i=N(),{subscribe:o,set:r,update:a}=u(i);return o(e=>{k(e)}),{subscribe:o,addNotification(e,t,n){const f={id:Math.random().toString(36).substring(2,15),type:e,message:t,channelId:n?.channelId,channelName:n?.channelName,senderPubkey:n?.senderPubkey,senderName:n?.senderName,timestamp:Date.now(),read:!1,url:n?.url};if(a(s=>({notifications:[f,...s.notifications],lastChecked:s.lastChecked})),"Notification"in window&&Notification.permission==="granted")try{new Notification("Nostr-BBS",{body:t,icon:"/favicon.png",tag:f.id})}catch(s){console.error("Failed to show browser notification:",s)}},markAsRead(e){a(t=>({notifications:t.notifications.map(n=>n.id===e?{...n,read:!0}:n),lastChecked:t.lastChecked}))},markAllAsRead(){a(e=>({notifications:e.notifications.map(t=>({...t,read:!0})),lastChecked:Date.now()}))},clearAll(){r({notifications:[],lastChecked:Date.now()})},removeNotification(e){a(t=>({notifications:t.notifications.filter(n=>n.id!==e),lastChecked:t.lastChecked}))},clearOld(){const e=Date.now()-6048e5;a(t=>({notifications:t.notifications.filter(n=>n.timestamp>e),lastChecked:t.lastChecked}))},async requestPermission(){return"Notification"in window?Notification.permission==="granted"?"granted":Notification.permission!=="denied"?await Notification.requestPermission():Notification.permission:"denied"},addMentionNotification(e){this.addNotification("mention",`${e.senderName} mentioned you in ${e.channelName}`,{channelId:e.channelId,channelName:e.channelName,senderPubkey:e.senderPubkey,senderName:e.senderName,url:`/channels/${e.channelId}`})}}}const d=g(),w=c(d,i=>i.notifications.filter(o=>!o.read));c(w,i=>i.length);c(d,i=>i.notifications.slice(0,10));function b(i,o,r){const a=h(m);return!(i===a||o===r)}d.clearOld();export{d as n,b as s};
