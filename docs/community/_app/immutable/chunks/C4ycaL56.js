import{w as y}from"./C7Jxsl90.js";import{ndk as I}from"./Cne-Q8lD.js";import{a as D}from"./CPJguzua.js";import{KIND_USER_REGISTRATION as R}from"./a4QaBgto.js";import{B as C}from"./CwRy9Tox.js";class U{queue=[];activeCount=0;maxConcurrent;constructor(t=5){this.maxConcurrent=t}async execute(t){return new Promise((u,g)=>{this.queue.push({fn:t,resolve:u,reject:g}),this.processQueue()})}async processQueue(){if(this.activeCount>=this.maxConcurrent||this.queue.length===0)return;const t=this.queue.shift();if(t){this.activeCount++;try{const u=await t.fn();t.resolve(u)}catch(u){t.reject(u)}finally{this.activeCount--,this.processQueue()}}}get queueSize(){return this.queue.length}get active(){return this.activeCount}clear(){for(const t of this.queue)t.reject(new Error("Queue cleared"));this.queue=[]}}const N=5*60*1e3,K=500,Q=5,z=new U(Q);function H(){const{subscribe:a,update:t,set:u}=y({profiles:new Map});async function g(e){const n=C({subscribe:a}).profiles.get(e),c=Date.now();if(n&&c-n.lastFetched<N&&!n.isFetching||n?.isFetching)return n;const f={pubkey:e,profile:null,displayName:d(e),avatar:null,nip05:null,about:null,lastFetched:0,isFetching:!0};t(s=>{const r=new Map(s.profiles);return r.set(e,f),{...s,profiles:r}});try{const s=I();if(!s){console.debug("[ProfileCache] NDK not initialized, returning placeholder for",e.slice(0,8));const i={pubkey:e,profile:null,displayName:d(e),avatar:null,nip05:null,about:null,lastFetched:0,isFetching:!1};return t(l=>{const p=new Map(l.profiles);return p.set(e,i),{...l,profiles:p}}),i}const r=await z.execute(async()=>{const i=s.getUser({pubkey:e});return await i.fetchProfile(),i.profile||null}),h=C(D),m=h.publicKey===e,v=m?h.nickname:null,x=m?h.avatar:null;let F=null;if(!r?.displayName&&!r?.name&&!v)try{const i=await s.fetchEvents({kinds:[R],authors:[e],limit:1}),l=Array.from(i)[0];l&&(F=l.tags.find(w=>w[0]==="name")?.[1]||null)}catch{}const E={pubkey:e,profile:r||null,displayName:v||r?.displayName||r?.name||F||d(e),avatar:x||r?.image||r?.picture||null,nip05:r?.nip05||null,about:r?.about||null,lastFetched:c,isFetching:!1};return t(i=>{const l=new Map(i.profiles);if(l.size>=K){const p=Array.from(l.entries()).sort((w,S)=>w[1].lastFetched-S[1].lastFetched)[0]?.[0];p&&l.delete(p)}return l.set(e,E),{...i,profiles:l}}),E}catch(s){console.error(`Failed to fetch profile for ${e}:`,s);const r={pubkey:e,profile:null,displayName:d(e),avatar:null,nip05:null,about:null,lastFetched:c,isFetching:!1};return t(h=>{const m=new Map(h.profiles);return m.set(e,r),{...h,profiles:m}}),r}}function M(e){return C({subscribe:a}).profiles.get(e)||null}async function A(e){const o=[...new Set(e)];await Promise.all(o.map(n=>g(n)))}function P(){u({profiles:new Map})}function q(e){t(o=>{const n=new Map(o.profiles);return n.delete(e),{...o,profiles:n}})}function T(e,o,n){t(c=>{const f=new Map(c.profiles),s=f.get(e),r={pubkey:e,profile:s?.profile||null,displayName:o||d(e),avatar:n||null,nip05:s?.nip05||null,about:s?.about||null,lastFetched:Date.now(),isFetching:!1};return f.set(e,r),{...c,profiles:f}})}function _(){const e=Date.now();t(o=>{const n=new Map(o.profiles);for(const[c,f]of n.entries())e-f.lastFetched>=N&&n.delete(c);return{...o,profiles:n}})}return setInterval(_,60*1e3),{subscribe:a,getProfile:g,getCachedSync:M,prefetchProfiles:A,clear:P,remove:q,updateCurrentUserProfile:T}}function d(a){return a.length<=16?a:`${a.slice(0,8)}...${a.slice(-4)}`}const G=H();export{G as p};
