const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ofNpoJHj.js","./BVL4R8vY.js","./CmsKOCeN.js","./CEc-lP5l.js","./CwRy9Tox.js","./BToyndCo.js","./CsmHjMo3.js"])))=>i.map(i=>d[i]);
import{_}from"./CmsKOCeN.js";import{d as k,w as z}from"./CEc-lP5l.js";import{n as b,p as h,q as I,r as F}from"./BVL4R8vY.js";import{i as x,a as V,c as W,R as U}from"./BzOJhCVF.js";import{m as E}from"./D6fDNJPE.js";import{p as $}from"./CF7zP8uE.js";import{B as j}from"./CwRy9Tox.js";const A=14,N=1059,L=13,O=2*24*60*60;async function G(r,l,i,e,a){if(!x(l))throw new Error("Invalid recipient public key");const t=V(r);if(!t.valid)throw new Error(`Invalid message: ${t.errors.join(", ")}`);const p=W("dm");if(!p.allowed)throw new U(`DM rate limit exceeded. Try again in ${p.retryAfter} seconds.`,p.retryAfter);const n=h(i),o=Math.floor(Date.now()/1e3),f={kind:A,pubkey:n,created_at:o,tags:[["p",l]],content:r},u=b.v2.utils.getConversationKey(i,l),d=b.v2.encrypt(JSON.stringify(f),u),m=I({kind:L,pubkey:n,created_at:o,tags:[],content:d},i),g=F(),y=h(g),v=Math.floor(Math.random()*(2*O))-O,M=o+v,C=b.v2.utils.getConversationKey(g,l),w=b.v2.encrypt(JSON.stringify(m),C),J=I({kind:N,pubkey:y,created_at:M,tags:[["p",l]],content:w},g);await e.publish(J)}function D(r,l){try{if(r.kind!==N)return null;const i=b.v2.utils.getConversationKey(l,r.pubkey),e=b.v2.decrypt(r.content,i),a=JSON.parse(e);if(a.kind!==L)return null;const t=b.v2.utils.getConversationKey(l,a.pubkey),p=b.v2.decrypt(a.content,t),n=JSON.parse(p);return n.kind!==A?null:{content:n.content,senderPubkey:n.pubkey,timestamp:n.created_at}}catch(i){return console.error("Failed to decrypt DM:",i),null}}function K(r){return{kinds:[N],"#p":[r]}}const R={conversations:new Map,currentConversation:null,messages:[],isLoading:!1,error:null,isSubscribed:!1};function q(){const{subscribe:r,set:l,update:i}=z(R);return{subscribe:r,fetchConversations:async(e,a)=>{i(t=>({...t,isLoading:!0,error:null}));try{const t=h(a),p=K(t),{ndk:n}=await _(async()=>{const{ndk:s}=await import("./ofNpoJHj.js");return{ndk:s}},__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url),o=n();if(!o)throw new Error("NDK not initialized");const c=await o.fetchEvents(p),f=Array.from(c).map(s=>({id:s.id,kind:s.kind,pubkey:s.pubkey,created_at:s.created_at,tags:s.tags,content:s.content,sig:s.sig})),u=new Map,d=new Map;for(const s of f){const m=D(s,a);if(!m)continue;const g=m.senderPubkey,y={id:s.id,senderPubkey:m.senderPubkey,recipientPubkey:t,content:m.content,timestamp:m.timestamp,isSent:!1,isRead:!1};d.has(g)||d.set(g,[]),d.get(g).push(y);const v=u.get(g);(!v||m.timestamp>v.lastMessageTimestamp)&&u.set(g,{pubkey:g,name:S(g),lastMessage:m.content.substring(0,50)+(m.content.length>50?"...":""),lastMessageTimestamp:m.timestamp,unreadCount:(v?.unreadCount??0)+1,isPinned:v?.isPinned??!1})}if(typeof window<"u"){const s={};d.forEach((m,g)=>{s[g]=m}),localStorage.setItem("dm_messages",JSON.stringify(s))}i(s=>({...s,conversations:u,isLoading:!1}))}catch(t){i(p=>({...p,isLoading:!1,error:t instanceof Error?t.message:"Failed to fetch conversations"}))}},selectConversation:e=>{i(a=>{const t=a.conversations.get(e);if(!t)return a;const p={...t,unreadCount:0},n=new Map(a.conversations);n.set(e,p);let o=[];if(typeof window<"u"){const c=localStorage.getItem("dm_messages");if(c)try{o=JSON.parse(c)[e]||[],o.sort((u,d)=>u.timestamp-d.timestamp)}catch(f){console.error("Failed to load messages:",f)}}return{...a,currentConversation:e,conversations:n,messages:o}})},sendDM:async(e,a,t)=>{const n=j({subscribe:r}).currentConversation;if(!n)throw new Error("No conversation selected");try{const o=h(t),{ndk:c}=await _(async()=>{const{ndk:s}=await import("./ofNpoJHj.js");return{ndk:s}},__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url),f=c();if(!f)throw new Error("NDK not initialized");await G(e,n,t,{publish:async s=>{const m=(await _(async()=>{const{NDKEvent:y}=await import("./BVL4R8vY.js").then(v=>v.X);return{NDKEvent:y}},__vite__mapDeps([1,2,3,4,5]),import.meta.url)).NDKEvent;await new m(f,s).publish()}});const d={id:`temp-${Date.now()}`,senderPubkey:o,recipientPubkey:n,content:e,timestamp:Math.floor(Date.now()/1e3),isSent:!0,isRead:!0};i(s=>{const m=[...s.messages,d],g=s.conversations.get(n);if(g){const y={...g,lastMessage:e.substring(0,50)+(e.length>50?"...":""),lastMessageTimestamp:d.timestamp},v=new Map(s.conversations);if(v.set(n,y),typeof window<"u"){const M=localStorage.getItem("dm_messages");let C={};if(M)try{C=JSON.parse(M)}catch(w){console.error("Failed to parse stored messages:",w)}C[n]=m,localStorage.setItem("dm_messages",JSON.stringify(C))}return{...s,conversations:v,messages:m}}return{...s,messages:m}})}catch(o){throw i(c=>({...c,error:o instanceof Error?o.message:"Failed to send message"})),o}},startConversation:(e,a)=>{i(t=>{if(t.conversations.get(e))return{...t,currentConversation:e,messages:[]};const n={pubkey:e,name:a??S(e),lastMessage:"",lastMessageTimestamp:0,unreadCount:0,isPinned:!1},o=new Map(t.conversations);return o.set(e,n),{...t,conversations:o,currentConversation:e,messages:[]}})},subscribeToIncoming:async e=>{const a=h(e),t=K(a),{ndk:p}=await _(async()=>{const{ndk:c}=await import("./ofNpoJHj.js");return{ndk:c}},__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url),n=p();if(!n)throw new Error("NDK not initialized");const o=n.subscribe(t,{closeOnEose:!1});return o.on("event",c=>{const f={id:c.id,kind:c.kind,pubkey:c.pubkey,created_at:c.created_at,tags:c.tags,content:c.content,sig:c.sig},u=D(f,e);if(u){const d=u.senderPubkey;i(s=>{const m={id:f.id,senderPubkey:u.senderPubkey,recipientPubkey:a,content:u.content,timestamp:u.timestamp,isSent:!1,isRead:s.currentConversation===d},g=s.currentConversation===d?[...s.messages,m]:s.messages;if(typeof window<"u"){const C=localStorage.getItem("dm_messages");let w={};if(C)try{w=JSON.parse(C)}catch(T){console.error("Failed to parse stored messages:",T)}w[d]||(w[d]=[]),w[d].push(m),localStorage.setItem("dm_messages",JSON.stringify(w))}const y=s.conversations.get(d),v=y?{...y,lastMessage:u.content.substring(0,50)+(u.content.length>50?"...":""),lastMessageTimestamp:u.timestamp,unreadCount:s.currentConversation===d?y.unreadCount:y.unreadCount+1}:{pubkey:d,name:S(d),lastMessage:u.content.substring(0,50)+(u.content.length>50?"...":""),lastMessageTimestamp:u.timestamp,unreadCount:1,isPinned:!1},M=new Map(s.conversations);return M.set(d,v),{...s,conversations:M,messages:g,isSubscribed:!0}})}}),i(c=>({...c,isSubscribed:!0})),()=>{o.stop(),i(c=>({...c,isSubscribed:!1}))}},handleIncomingDM:(e,a)=>{const t=D(e,a);if(!t)return;const p=h(a),n=t.senderPubkey;i(o=>{const c={id:e.id,senderPubkey:t.senderPubkey,recipientPubkey:p,content:t.content,timestamp:t.timestamp,isSent:!1,isRead:o.currentConversation===n},f=o.currentConversation===n?[...o.messages,c]:o.messages,u=o.conversations.get(n),d=u?{...u,lastMessage:t.content.substring(0,50)+(t.content.length>50?"...":""),lastMessageTimestamp:t.timestamp,unreadCount:o.currentConversation===n?u.unreadCount:u.unreadCount+1}:{pubkey:n,name:S(n),lastMessage:t.content.substring(0,50)+(t.content.length>50?"...":""),lastMessageTimestamp:t.timestamp,unreadCount:1,isPinned:!1},s=new Map(o.conversations);return s.set(n,d),{...o,conversations:s,messages:f}})},clearConversation:()=>{i(e=>({...e,currentConversation:null,messages:[]}))},clearError:()=>{i(e=>({...e,error:null}))},reset:()=>{l(R)}}}function B(r){return r.length<=16?r:`${r.substring(0,8)}...${r.substring(r.length-8)}`}function S(r){const l=$.getCachedSync(r);return l?.displayName?l.displayName:B(r)}const P=q(),te=k([P,E],([r,l])=>Array.from(r.conversations.values()).filter(e=>!l.mutedUsers.has(e.pubkey)).sort((e,a)=>e.isPinned&&!a.isPinned?-1:!e.isPinned&&a.isPinned?1:a.lastMessageTimestamp-e.lastMessageTimestamp));k([P,E],([r,l])=>Array.from(r.conversations.values()).filter(e=>l.mutedUsers.has(e.pubkey)).sort((e,a)=>a.lastMessageTimestamp-e.lastMessageTimestamp));k(P,r=>{let l=0;for(const i of r.conversations.values())l+=i.unreadCount;return l});k(P,r=>r.currentConversation?r.conversations.get(r.currentConversation)??null:null);export{P as d,te as s};
