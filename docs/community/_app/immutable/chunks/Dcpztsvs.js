import{d as oe,w as _e}from"./DjSB8mDa.js";import{d as B}from"./BxB7wYhR.js";import{B as J,s as de,n as F,d as y,i as A,l as c,c as z,e as E,h as H,o as me,z as G,b as M,u as C,g as R,x as K,v as P,j as W,r as ge,A as Q,a as q,q as N,f as V,t as I,y as j}from"./CwRy9Tox.js";import{e as U}from"./BFk-VQ8S.js";import{S as ve,i as pe}from"./D-vqeeah.js";const Z={stats:new Map,isLoading:!1,error:null};function ye(){const{subscribe:a,set:e,update:l}=_e(Z);async function n(r){const t=await B.getChannelMessagesWithAuthors(r);if(t.length===0)return{channelId:r,messageCount:0,uniquePosters:0,avgMessagesPerDay:0,peakHour:0,topPosters:[],activityByDay:[],activityByHour:[],memberGrowth:[],lastUpdated:Date.now()};const o=t.length,w=new Set(t.map(d=>d.pubkey)).size,m=t.map(d=>d.created_at*1e3),p=Math.min(...m),f=Math.max(...m),v=Math.max(1,(f-p)/(1e3*60*60*24)),u=o/v,h=new Array(24).fill(0);t.forEach(d=>{const S=new Date(d.created_at*1e3).getHours();h[S]++});const s=h.map((d,S)=>({hour:S,count:d})),g=h.indexOf(Math.max(...h)),i=Date.now(),b=new Map;for(let d=29;d>=0;d--){const L=new Date(i-d*24*60*60*1e3).toISOString().split("T")[0];b.set(L,0)}t.forEach(d=>{const S=new Date(d.created_at*1e3).toISOString().split("T")[0];b.has(S)&&b.set(S,(b.get(S)||0)+1)});const O=Array.from(b.entries()).map(([d,S])=>({date:d,count:S,timestamp:new Date(d).getTime()})),k=new Map;t.forEach(d=>{k.set(d.pubkey,(k.get(d.pubkey)||0)+1)});const ce=Array.from(k.entries()).sort((d,S)=>S[1]-d[1]).slice(0,5),ue=await Promise.all(ce.map(async([d,S])=>{const L=await B.getUser(d);return{pubkey:d,name:L?.name||L?.displayName||void 0,avatar:L?.avatar||void 0,messageCount:S,percentage:S/o*100}})),fe=await B.getChannel(r),X=[];if(fe){const d=new Map;t.forEach(D=>{(!d.has(D.pubkey)||D.created_at<d.get(D.pubkey))&&d.set(D.pubkey,D.created_at)});const S=Array.from(d.values()).sort((D,T)=>D-T),L=new Map;S.forEach((D,T)=>{const he=new Date(D*1e3).toISOString().split("T")[0];L.set(he,T+1)}),X.push(...Array.from(L.entries()).map(([D,T])=>({date:D,memberCount:T,timestamp:new Date(D).getTime()})))}return{channelId:r,messageCount:o,uniquePosters:w,avgMessagesPerDay:u,peakHour:g,topPosters:ue,activityByDay:O,activityByHour:s,memberGrowth:X,lastUpdated:Date.now()}}return{subscribe:a,async refreshStats(r){l(t=>({...t,isLoading:!0,error:null}));try{const t=await n(r);l(o=>{const _=new Map(o.stats);return _.set(r,t),{...o,stats:_,isLoading:!1}})}catch(t){const o=t instanceof Error?t.message:"Failed to calculate statistics";console.error("refreshStats error:",t),l(_=>({..._,error:o,isLoading:!1}))}},async getStats(r){const o=J({subscribe:a}).stats.get(r);return o&&Date.now()-o.lastUpdated<5*60*1e3?o:(await this.refreshStats(r),J({subscribe:a}).stats.get(r)||null)},async getPlatformStats(){l(r=>({...r,isLoading:!0,error:null}));try{const r=await B.channels.toArray(),t=await B.messages.toArray(),o=await B.users.toArray(),_=[];for(const f of r){const v=await n(f.id);_.push(v)}const w=Date.now()/1e3-7*24*60*60,m=new Set(t.filter(f=>f.created_at>w).map(f=>f.channelId)).size,p={totalChannels:r.length,totalMessages:t.filter(f=>!f.deleted).length,totalUsers:o.length,activeChannels:m,channelStats:_,lastUpdated:Date.now()};return l(f=>({...f,isLoading:!1})),p}catch(r){const t=r instanceof Error?r.message:"Failed to calculate platform statistics";throw console.error("getPlatformStats error:",r),l(o=>({...o,error:t,isLoading:!1})),r}},clearError(){l(r=>({...r,error:null}))},clear(){e(Z)}}}const ie=ye();oe(ie,a=>a.isLoading);oe(ie,a=>a.error);function Y(a){const e=a.slice(),l=e[1][e[2]];return e[12]=l,e}function x(a,e,l){const n=a.slice();return n[13]=e[l],n[15]=l,n}function $(a,e,l){const n=a.slice();n[12]=e[l],n[15]=l;const r=n[12].count/n[5]*n[0];n[16]=r;const t=n[15]*60+15;n[17]=t;const o=n[0]-n[16];return n[18]=o,n}function ee(a,e,l){const n=a.slice();return n[13]=e[l],n}function we(a){let e,l,n,r,t,o,_,w=U([0,.25,.5,.75,1]),m=[];for(let s=0;s<5;s+=1)m[s]=te(ee(a,w,s));let p=U(a[1]),f=[];for(let s=0;s<p.length;s+=1)f[s]=ae($(a,p,s));let v=U([0,.25,.5,.75,1]),u=[];for(let s=0;s<5;s+=1)u[s]=se(x(a,v,s));let h=a[2]!==null&&re(Y(a));return{c(){e=P("svg"),l=P("g");for(let s=0;s<5;s+=1)m[s].c();n=P("g");for(let s=0;s<f.length;s+=1)f[s].c();r=P("g");for(let s=0;s<5;s+=1)u[s].c();o=W(),h&&h.c(),_=K(),this.h()},l(s){e=C(s,"svg",{width:!0,viewBox:!0,preserveAspectRatio:!0});var g=E(e);l=C(g,"g",{class:!0});var i=E(l);for(let k=0;k<5;k+=1)m[k].l(i);i.forEach(y),n=C(g,"g",{class:!0});var b=E(n);for(let k=0;k<f.length;k+=1)f[k].l(b);b.forEach(y),r=C(g,"g",{class:!0});var O=E(r);for(let k=0;k<5;k+=1)u[k].l(O);O.forEach(y),g.forEach(y),o=R(s),h&&h.l(s),_=K(),this.h()},h(){c(l,"class","grid"),c(n,"class","bars"),c(r,"class","y-axis"),c(e,"width","100%"),c(e,"viewBox",t="0 0 "+a[1].length*60+" "+(a[0]+40)),c(e,"preserveAspectRatio","xMidYMid meet")},m(s,g){A(s,e,g),M(e,l);for(let i=0;i<5;i+=1)m[i]&&m[i].m(l,null);M(e,n);for(let i=0;i<f.length;i+=1)f[i]&&f[i].m(n,null);M(e,r);for(let i=0;i<5;i+=1)u[i]&&u[i].m(r,null);A(s,o,g),h&&h.m(s,g),A(s,_,g)},p(s,g){if(g&3){w=U([0,.25,.5,.75,1]);let i;for(i=0;i<5;i+=1){const b=ee(s,w,i);m[i]?m[i].p(b,g):(m[i]=te(b),m[i].c(),m[i].m(l,null))}for(;i<5;i+=1)m[i].d(1)}if(g&231){p=U(s[1]);let i;for(i=0;i<p.length;i+=1){const b=$(s,p,i);f[i]?f[i].p(b,g):(f[i]=ae(b),f[i].c(),f[i].m(n,null))}for(;i<f.length;i+=1)f[i].d(1);f.length=p.length}if(g&33){v=U([0,.25,.5,.75,1]);let i;for(i=0;i<5;i+=1){const b=x(s,v,i);u[i]?u[i].p(b,g):(u[i]=se(b),u[i].c(),u[i].m(r,null))}for(;i<5;i+=1)u[i].d(1)}g&3&&t!==(t="0 0 "+s[1].length*60+" "+(s[0]+40))&&c(e,"viewBox",t),s[2]!==null?h?h.p(Y(s),g):(h=re(Y(s)),h.c(),h.m(_.parentNode,_)):h&&(h.d(1),h=null)},d(s){s&&(y(e),y(o),y(_)),G(m,s),G(f,s),G(u,s),h&&h.d(s)}}}function be(a){let e,l="<p>No activity data available</p>";return{c(){e=H("div"),e.innerHTML=l,this.h()},l(n){e=z(n,"DIV",{class:!0,"data-svelte-h":!0}),me(e)!=="svelte-12hkj1a"&&(e.innerHTML=l),this.h()},h(){c(e,"class","empty-state svelte-1iitpnv")},m(n,r){A(n,e,r)},p:F,d(n){n&&y(e)}}}function te(a){let e,l,n,r;return{c(){e=P("line"),this.h()},l(t){e=C(t,"line",{x1:!0,y1:!0,x2:!0,y2:!0,stroke:!0,"stroke-width":!0,"stroke-dasharray":!0}),E(e).forEach(y),this.h()},h(){c(e,"x1","0"),c(e,"y1",l=a[0]-a[13]*a[0]),c(e,"x2",n=a[1].length*60),c(e,"y2",r=a[0]-a[13]*a[0]),c(e,"stroke","#e5e7eb"),c(e,"stroke-width","1"),c(e,"stroke-dasharray","4 4")},m(t,o){A(t,e,o)},p(t,o){o&1&&l!==(l=t[0]-t[13]*t[0])&&c(e,"y1",l),o&2&&n!==(n=t[1].length*60)&&c(e,"x2",n),o&1&&r!==(r=t[0]-t[13]*t[0])&&c(e,"y2",r)},d(t){t&&y(e)}}}function ae(a){let e,l,n,r,t,o=le(a[12].date)+"",_,w,m,p;function f(...u){return a[10](a[15],a[17],...u)}function v(...u){return a[11](a[15],a[17],...u)}return{c(){e=P("rect"),t=P("text"),_=I(o),this.h()},l(u){e=C(u,"rect",{x:!0,y:!0,width:!0,height:!0,class:!0,fill:!0,rx:!0,role:!0}),E(e).forEach(y),t=C(u,"text",{x:!0,y:!0,"text-anchor":!0,class:!0,fill:!0,"font-size":!0});var h=E(t);_=V(h,o),h.forEach(y),this.h()},h(){c(e,"x",a[17]),c(e,"y",l=a[18]),c(e,"width","30"),c(e,"height",n=a[16]),c(e,"class","bar svelte-1iitpnv"),c(e,"fill",r=a[2]===a[15]?"#2563eb":"#60a5fa"),c(e,"rx","4"),c(e,"role","presentation"),Q(e,"hovered",a[2]===a[15]),c(t,"x",a[17]+15),c(t,"y",w=a[0]+20),c(t,"text-anchor","middle"),c(t,"class","label svelte-1iitpnv"),c(t,"fill","#6b7280"),c(t,"font-size","12")},m(u,h){A(u,e,h),A(u,t,h),M(t,_),m||(p=[N(e,"mouseenter",f),N(e,"mousemove",v),N(e,"mouseleave",a[7])],m=!0)},p(u,h){a=u,h&35&&l!==(l=a[18])&&c(e,"y",l),h&35&&n!==(n=a[16])&&c(e,"height",n),h&4&&r!==(r=a[2]===a[15]?"#2563eb":"#60a5fa")&&c(e,"fill",r),h&4&&Q(e,"hovered",a[2]===a[15]),h&2&&o!==(o=le(a[12].date)+"")&&q(_,o),h&1&&w!==(w=a[0]+20)&&c(t,"y",w)},d(u){u&&(y(e),y(t)),m=!1,ge(p)}}}function se(a){let e,l=Math.round(a[5]*a[13])+"",n,r;return{c(){e=P("text"),n=I(l),this.h()},l(t){e=C(t,"text",{x:!0,y:!0,"text-anchor":!0,class:!0,fill:!0,"font-size":!0});var o=E(e);n=V(o,l),o.forEach(y),this.h()},h(){c(e,"x","-5"),c(e,"y",r=a[0]-a[13]*a[0]+4),c(e,"text-anchor","end"),c(e,"class","axis-label svelte-1iitpnv"),c(e,"fill","#9ca3af"),c(e,"font-size","10")},m(t,o){A(t,e,o),M(e,n)},p(t,o){o&32&&l!==(l=Math.round(t[5]*t[13])+"")&&q(n,l),o&1&&r!==(r=t[0]-t[13]*t[0]+4)&&c(e,"y",r)},d(t){t&&y(e)}}}function re(a){let e,l,n=ne(a[12].date)+"",r,t,o,_=a[12].count+"",w,m,p=a[12].count===1?"message":"messages",f;return{c(){e=H("div"),l=H("div"),r=I(n),t=W(),o=H("div"),w=I(_),m=W(),f=I(p),this.h()},l(v){e=z(v,"DIV",{class:!0,style:!0});var u=E(e);l=z(u,"DIV",{class:!0});var h=E(l);r=V(h,n),h.forEach(y),t=R(u),o=z(u,"DIV",{class:!0});var s=E(o);w=V(s,_),m=R(s),f=V(s,p),s.forEach(y),u.forEach(y),this.h()},h(){c(l,"class","tooltip-date svelte-1iitpnv"),c(o,"class","tooltip-count svelte-1iitpnv"),c(e,"class","tooltip svelte-1iitpnv"),j(e,"left",a[3]+"px"),j(e,"top",a[4]-60+"px")},m(v,u){A(v,e,u),M(e,l),M(l,r),M(e,t),M(e,o),M(o,w),M(o,m),M(o,f)},p(v,u){u&6&&n!==(n=ne(v[12].date)+"")&&q(r,n),u&6&&_!==(_=v[12].count+"")&&q(w,_),u&6&&p!==(p=v[12].count===1?"message":"messages")&&q(f,p),u&8&&j(e,"left",v[3]+"px"),u&16&&j(e,"top",v[4]-60+"px")},d(v){v&&y(e)}}}function Se(a){let e;function l(t,o){return t[1].length===0?be:we}let n=l(a),r=n(a);return{c(){e=H("div"),r.c(),this.h()},l(t){e=z(t,"DIV",{class:!0});var o=E(e);r.l(o),o.forEach(y),this.h()},h(){c(e,"class","activity-graph svelte-1iitpnv")},m(t,o){A(t,e,o),r.m(e,null)},p(t,[o]){n===(n=l(t))&&r?r.p(t,o):(r.d(1),r=n(t),r&&(r.c(),r.m(e,null)))},i:F,o:F,d(t){t&&y(e),r.d()}}}function ne(a){return new Date(a).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function le(a){return new Date(a).toLocaleDateString("en-US",{weekday:"short"})}function ke(a,e,l){let n,r,{data:t=[]}=e,{days:o=7}=e,{height:_=200}=e,w=null,m=0,p=0;function f(s,g,i){l(2,w=g),l(3,m=i),l(4,p=s.clientY)}function v(){l(2,w=null)}const u=(s,g,i)=>f(i,s,g+15),h=(s,g,i)=>f(i,s,g+15);return a.$$set=s=>{"data"in s&&l(8,t=s.data),"days"in s&&l(9,o=s.days),"height"in s&&l(0,_=s.height)},a.$$.update=()=>{a.$$.dirty&768&&l(1,n=t.slice(-o)),a.$$.dirty&2&&l(5,r=Math.max(...n.map(s=>s.count),1))},[_,n,w,m,p,r,f,v,t,o,u,h]}class Ce extends ve{constructor(e){super(),pe(this,e,ke,Se,de,{data:8,days:9,height:0})}}export{Ce as A,ie as c};
