import{N as b}from"./I2mpdA09.js";import{ndk as y,isConnected as g}from"./DRx8R66N.js";import{v as C,c as m,R as w,a as N}from"./BzOJhCVF.js";const h={CREATE:40,MESSAGE:42};async function _(e){if(!y()?.signer)throw new Error("No signer configured. Please login first.");const i=C(e.name);if(!i.valid)throw new Error(`Invalid channel name: ${i.errors.join(", ")}`);const a=m("channelCreate");if(!a.allowed)throw new w(`Channel creation rate limit exceeded. Try again in ${a.retryAfter} seconds.`,a.retryAfter);if(!g())throw new Error("Not connected to relays. Please wait for connection.");const n={name:e.name,about:e.description},t=new b(y());t.kind=h.CREATE,t.content=JSON.stringify(n),e.visibility&&e.visibility!=="public"&&t.tags.push(["visibility",e.visibility]),e.cohorts&&e.cohorts.length>0&&t.tags.push(["cohort",e.cohorts.join(",")]),e.encrypted&&t.tags.push(["encrypted","true"]);const s=e.section||"public-lobby";t.tags.push(["section",s]);const r=e.accessType||"gated";return t.tags.push(["access-type",r]),await t.sign(),await t.publish(),{id:t.id,name:e.name,description:e.description,visibility:e.visibility||"public",accessType:r,cohorts:e.cohorts||[],encrypted:e.encrypted||!1,section:s,createdAt:t.created_at||Math.floor(Date.now()/1e3),creatorPubkey:t.pubkey}}function S(e,d){const{userCohorts:i,userPubkey:a,isAdmin:n=!1}=d;return n||e.creatorPubkey===a?!0:T(e,i,a,n)?e.accessType==="open"||e.cohorts.length===0?!0:e.cohorts.some(t=>i.includes(t)):!1}async function I(e){const d=y();if(!d||!g())return null;const i={kinds:[h.CREATE],ids:[e],limit:1},a=await d.fetchEvents(i);for(const n of a)try{const t=JSON.parse(n.content),s=n.tags.find(l=>l[0]==="visibility"),r=n.tags.find(l=>l[0]==="access-type"),o=n.tags.find(l=>l[0]==="cohort"),c=n.tags.find(l=>l[0]==="encrypted"),u=n.tags.find(l=>l[0]==="section");return{id:n.id,name:t.name||"Unnamed Channel",description:t.about,visibility:s?.[1]||"public",accessType:r?.[1]||"gated",cohorts:o?.[1]?.split(",").filter(Boolean)||[],encrypted:c?.[1]==="true",section:u?.[1]||"public-lobby",createdAt:n.created_at||0,creatorPubkey:n.pubkey}}catch(t){console.error("Failed to parse channel event:",t)}return null}async function L(e,d,i,a){if(!y()?.signer)throw new Error("No signer configured. Please login first.");const t=N(d);if(!t.valid)throw new Error(`Invalid message: ${t.errors.join(", ")}`);const s=m("message");if(!s.allowed)throw new w(`Message rate limit exceeded. Try again in ${s.retryAfter} seconds.`,s.retryAfter);if(!g())throw new Error("Not connected to relays. Please wait for connection.");if(a){const c=await I(e);if(!c)throw new Error("Channel not found. Cannot verify posting permissions.");if(!S(c,a))throw new Error("You do not have permission to post in this channel.")}const r={},o=new b(y());if(o.kind=h.MESSAGE,o.content=d,o.tags.push(["e",e,"","root"]),r.replyTo&&o.tags.push(["e",r.replyTo,"","reply"]),r.additionalTags)for(const c of r.additionalTags)o.tags.push(c);return await o.sign(),await o.publish(),o.id}function T(e,d,i,a){return a||i&&e.creatorPubkey===i||e.visibility==="public"||e.cohorts.length===0?!0:e.cohorts.length>0&&d.length>0?e.cohorts.some(t=>d.includes(t)):!1}async function D(e={}){const{userCohorts:d=[],userPubkey:i,isAdmin:a=!1,limit:n=100}=e,t=y();if(!t)return[];if(!g())return[];const s={kinds:[h.CREATE],limit:n},r=await t.fetchEvents(s),o=[];for(const c of r)try{const u=JSON.parse(c.content),l=c.tags.find(f=>f[0]==="visibility"),v=c.tags.find(f=>f[0]==="access-type"),E=c.tags.find(f=>f[0]==="cohort"),k=c.tags.find(f=>f[0]==="encrypted"),A=c.tags.find(f=>f[0]==="section"),p={id:c.id,name:u.name||"Unnamed Channel",description:u.about,visibility:l?.[1]||"public",accessType:v?.[1]||"gated",cohorts:E?.[1]?.split(",").filter(Boolean)||[],encrypted:k?.[1]==="true",section:A?.[1]||"public-lobby",createdAt:c.created_at||0,creatorPubkey:c.pubkey};T(p,d,i,a)&&o.push(p)}catch(u){console.error("Failed to parse channel event:",u)}return o.sort((c,u)=>u.createdAt-c.createdAt),o}async function G(e,d=50){const i=y();if(!i)return[];if(!g())return[];const a={kinds:[h.MESSAGE],"#e":[e],limit:d},n=await i.fetchEvents(a),t=[];for(const s of n){const r=s.tags.find(o=>o[0]==="e"&&o[3]==="reply");t.push({id:s.id,content:s.content,pubkey:s.pubkey,createdAt:s.created_at||0,replyTo:r?.[1],tags:s.tags.map(o=>[...o])})}return t.sort((s,r)=>s.createdAt-r.createdAt),t}function O(e,d){const i=y();if(!i)return{unsubscribe:()=>{}};const a={kinds:[h.MESSAGE],"#e":[e],since:Math.floor(Date.now()/1e3)},n=i.subscribe(a,{closeOnEose:!1});return n.on("event",t=>{const s=t.tags.find(r=>r[0]==="e"&&r[3]==="reply");d({id:t.id,content:t.content,pubkey:t.pubkey,createdAt:t.created_at||0,replyTo:s?.[1],tags:t.tags.map(r=>[...r])})}),{unsubscribe:()=>{n.stop()}}}export{G as a,L as b,_ as c,D as f,O as s};
