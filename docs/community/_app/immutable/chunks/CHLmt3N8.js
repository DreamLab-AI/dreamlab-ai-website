const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CQ8JIY5d.js","./DnuYX42J.js","./CwRy9Tox.js","./Box6chXe.js"])))=>i.map(i=>d[i]);
import{_ as __vitePreload}from"./CmsKOCeN.js";import{d as derived,w as writable,b as base}from"./Box6chXe.js";import{B as get_store_value}from"./CwRy9Tox.js";import{p as parse$1}from"./BToyndCo.js";const PBKDF2_ITERATIONS=6e5,SALT_LENGTH=16,IV_LENGTH=12,KEY_LENGTH=256;async function deriveKey(t,e){const r=new TextEncoder().encode(t),s=await crypto.subtle.importKey("raw",r,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:PBKDF2_ITERATIONS,hash:"SHA-256"},s,{name:"AES-GCM",length:KEY_LENGTH},!1,["encrypt","decrypt"])}async function encryptPrivateKey(t,e){const n=new TextEncoder,r=crypto.getRandomValues(new Uint8Array(SALT_LENGTH)),s=crypto.getRandomValues(new Uint8Array(IV_LENGTH)),o=await deriveKey(e,r),a=n.encode(t),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,a),u=new Uint8Array(r.length+s.length+l.byteLength);return u.set(r,0),u.set(s,r.length),u.set(new Uint8Array(l),r.length+s.length),btoa(String.fromCharCode(...u))}async function decryptPrivateKey(t,e){const n=new TextDecoder,r=new Uint8Array(atob(t).split("").map(u=>u.charCodeAt(0))),s=r.slice(0,SALT_LENGTH),o=r.slice(SALT_LENGTH,SALT_LENGTH+IV_LENGTH),a=r.slice(SALT_LENGTH+IV_LENGTH),l=await deriveKey(e,s);try{const u=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},l,a);return n.decode(u)}catch{throw new Error("Invalid password or corrupted data")}}function isEncryptionAvailable(){return typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof crypto.getRandomValues<"u"}const installPrompt=writable(null),updateAvailable=writable(!1),isOnline=writable(typeof navigator<"u"?navigator.onLine:!0),swRegistration=writable(null),isPWAInstalled=writable(!1);function checkIfPWA(){return typeof window>"u"?!1:!!(window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches||window.matchMedia("(display-mode: minimal-ui)").matches||navigator.standalone===!0||document.referrer.includes("android-app://"))}const PWA_MODE_KEY="nostr_bbs_pwa_mode",queuedMessageCount=writable(0);function initPWA(){if(typeof window>"u")return;window.addEventListener("online",()=>{isOnline.set(!0),triggerBackgroundSync()}),window.addEventListener("offline",()=>{isOnline.set(!1)}),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),installPrompt.set(e)}),window.addEventListener("appinstalled",()=>{isPWAInstalled.set(!0),installPrompt.set(null),localStorage.setItem(PWA_MODE_KEY,"true")}),(checkIfPWA()||localStorage.getItem(PWA_MODE_KEY)==="true")&&(isPWAInstalled.set(!0),localStorage.setItem(PWA_MODE_KEY,"true")),navigator.serviceWorker?.addEventListener("message",e=>{const{type:n,count:r}=e.data;n==="SYNC_COMPLETE"&&(console.log(`[PWA] Background sync completed: ${r} messages`),queuedMessageCount.set(0))})}async function triggerInstall(){const t=get_store_value(installPrompt);if(!t)return console.warn("[PWA] Install prompt not available"),!1;try{await t.prompt();const{outcome:e}=await t.userChoice;return e==="accepted"?(isPWAInstalled.set(!0),installPrompt.set(null),!0):!1}catch(e){return console.error("[PWA] Install prompt failed:",e),!1}}const UPDATE_CHECK_INTERVAL_PWA=60*60*1e3,UPDATE_CHECK_INTERVAL_BROWSER=4*60*60*1e3;let updateCheckInterval=null;async function registerServiceWorker(){if(typeof navigator>"u"||!("serviceWorker"in navigator))return console.warn("[PWA] Service workers not supported"),null;try{const t=`${base}/service-worker.js`,e=`${base}/`,n=await navigator.serviceWorker.register(t,{scope:e});return console.log("[PWA] Service worker registered:",n),swRegistration.set(n),n.addEventListener("updatefound",()=>{const r=n.installing;r&&(console.log("[PWA] New service worker installing..."),r.addEventListener("statechange",()=>{r.state==="installed"&&(navigator.serviceWorker.controller?(console.log("[PWA] New version available"),updateAvailable.set(!0)):console.log("[PWA] Service worker installed for the first time"))}))}),startUpdateChecks(n),n}catch(t){return console.error("[PWA] Service worker registration failed:",t),null}}function startUpdateChecks(t){updateCheckInterval&&clearInterval(updateCheckInterval);const n=checkIfPWA()||localStorage.getItem(PWA_MODE_KEY)==="true"?UPDATE_CHECK_INTERVAL_PWA:UPDATE_CHECK_INTERVAL_BROWSER;updateCheckInterval=setInterval(()=>{checkForUpdates(t)},n),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&checkForUpdates(t)})}async function checkForUpdates(t){const e=t||get_store_value(swRegistration);if(e)try{await e.update(),console.log("[PWA] Update check completed")}catch(n){console.error("[PWA] Update check failed:",n)}}async function updateServiceWorker(){const t=get_store_value(swRegistration);if(!t?.waiting){console.warn("[PWA] No waiting service worker");return}t.waiting.postMessage({type:"SKIP_WAITING"}),navigator.serviceWorker.addEventListener("controllerchange",()=>{window.location.reload()})}async function getQueuedMessages(){const t=get_store_value(swRegistration);return t?.active?new Promise((e,n)=>{const r=new MessageChannel;r.port1.onmessage=s=>{s.data.messages?(queuedMessageCount.set(s.data.messages.length),e(s.data.messages)):n(new Error(s.data.error))},t.active.postMessage({type:"GET_QUEUE"},[r.port2])}):[]}async function triggerBackgroundSync(){const t=get_store_value(swRegistration);if(!t||!("sync"in t)){console.warn("[PWA] Background sync not supported");return}try{const e=t.sync;e&&(await e.register("sync-messages"),console.log("[PWA] Background sync registered"))}catch(e){console.error("[PWA] Background sync failed:",e)}}const canInstall=derived([installPrompt,isPWAInstalled],([t,e])=>t!==null&&!e);function hasNip07Extension(){return typeof window.nostr<"u"}async function waitForNip07(t=2e3){return hasNip07Extension()?!0:new Promise(e=>{const n=Date.now(),r=()=>{hasNip07Extension()?e(!0):Date.now()-n>t?e(!1):setTimeout(r,100)};r()})}async function getPublicKeyFromExtension(){if(!window.nostr)throw new Error("No NIP-07 extension available");try{const t=await window.nostr.getPublicKey();if(!/^[0-9a-f]{64}$/i.test(t))throw new Error("Invalid public key format from extension");return t}catch(t){throw t instanceof Error&&t.message.includes("User rejected")?new Error("Extension access denied by user"):t}}function getExtensionName(){if(!window.nostr)return"Unknown";const t=window.nostr;return t?._name?t._name:t?.isAlby?"Alby":t?.nos2x?"nos2x":"Browser Extension"}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var lib$1={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},utils$2={};Object.defineProperty(utils$2,"__esModule",{value:!0});utils$2._fast_remove_single=void 0;function _fast_remove_single(t,e){e!==-1&&(e===0?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}utils$2._fast_remove_single=_fast_remove_single;var bakeCollection={};(function(exports$1){Object.defineProperty(exports$1,"__esModule",{value:!0}),exports$1.bakeCollectionVariadic=exports$1.bakeCollectionAwait=exports$1.bakeCollection=exports$1.BAKED_EMPTY_FUNC=void 0,exports$1.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(t){var e="";if(t===0)return e;for(var n=0;n<t-1;++n)e+="arg"+String(n)+", ";return e+="arg"+String(t-1),e}function generateBodyPartsCode(t,e){for(var n="",r="",s=0;s<e;++s)n+="var f".concat(s," = collection[").concat(s,`];
`),r+="f".concat(s,"(").concat(t,`)
`);return{funcDefCode:n,funcCallCode:r}}function generateBodyPartsVariadicCode(t){for(var e="",n="",r=0;r<t;++r)e+="var f".concat(r," = collection[").concat(r,`];
`),n+="f".concat(r,`.apply(undefined, arguments)
`);return{funcDefCode:e,funcCallCode:n}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,o;r<s;r++)(o||!(r in e))&&(o||(o=Array.prototype.slice.call(e,0,r)),o[r]=e[r]);return t.concat(o||Array.prototype.slice.call(e))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=void 0;var utils_1$1=utils$2,bake_collection_1=bakeCollection;function push_norebuild(t,e){var n=this.length;if(n>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++}function push_rebuild(t,e){var n=this.length;if(n>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function removeLast_norebuild(t){this.length!==0&&(this.length===1?this._tasks===t&&(this.length=0):((0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(t){if(this.length!==0){if(this.length===1)if(this._tasks===t&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length)}function insert_rebuild(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function t(e,n,r,s){n===void 0&&(n=!0),r===void 0&&(r=null),s===void 0&&(s=!1),this.awaitTasks=s,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=e,this.firstEmitBuildStrategy=!0,s?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(n),r?typeof r=="function"?(this._tasks=r,this.length=1):(this._tasks=r,this.length=r.length):(this._tasks=null,this.length=0),n&&this.rebuild()}return t}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(t){this.argsNum<t&&(this.argsNum=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(t){t?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(t){t.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):t.length===1?(this.length=1,this.call=t[0],this._tasks=t[0]):(this.length=t.length,this._tasks=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,o,a){a===void 0&&(a=o);var l=Object.getOwnPropertyDescriptor(s,o);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,a,l)}:function(r,s,o,a){a===void 0&&(a=o),r[a]=s[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var o in r)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&e(s,r,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(taskCollection,t)})(taskCollection$1);var utils$1={};Object.defineProperty(utils$1,"__esModule",{value:!0});utils$1.nullObj=void 0;function nullObj(){var t={};return t.__proto__=null,t}utils$1.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,o;r<s;r++)(o||!(r in e))&&(o||(o=Array.prototype.slice.call(e,0,r)),o[r]=e[r]);return t.concat(o||Array.prototype.slice.call(e))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils$2,utils_2=utils$1;function emit(t,e,n,r,s,o){var a=this.events[t];if(a){if(a.length===0)return!1;if(a.argsNum<6)a.call(e,n,r,s,o);else{for(var l=new Array(a.argsNum),u=0,p=l.length;u<p;++u)l[u]=arguments[u+1];a.call.apply(void 0,l)}return!0}return!1}function emitHasOnce(t,e,n,r,s,o){var a=this.events[t],l;if(a!==void 0){if(a.length===0)return!1;if(a.argsNum<6)a.call(e,n,r,s,o);else{l=new Array(a.argsNum);for(var u=0,p=l.length;u<p;++u)l[u]=arguments[u+1];a.call.apply(void 0,l)}}var y=this.onceEvents[t];if(y){if(typeof y=="function")if(this.onceEvents[t]=void 0,arguments.length<6)y(e,n,r,s,o);else{if(l===void 0){l=new Array(arguments.length-1);for(var u=0,p=l.length;u<p;++u)l[u]=arguments[u+1]}y.apply(void 0,l)}else{var b=y;if(this.onceEvents[t]=void 0,arguments.length<6)for(var u=0;u<b.length;++u)b[u](e,n,r,s,o);else{if(l===void 0){l=new Array(arguments.length-1);for(var u=0,p=l.length;u<p;++u)l[u]=arguments[u+1]}for(var u=0;u<b.length;++u)b[u].apply(void 0,l)}}return!0}return a!==void 0}var EventEmitter=function(){function t(){this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(t.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),t}();ee.EventEmitter=EventEmitter;function once(t,e){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[t]){case"undefined":this.onceEvents[t]=e,typeof t=="symbol"&&this._symbolKeys.add(t);break;case"function":this.onceEvents[t]=[this.onceEvents[t],e];break;case"object":this.onceEvents[t].push(e)}return this}function addListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[t];return r?(r.push(e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeListener(t,e){var n=this.events[t];n&&n.removeLast(e);var r=this.onceEvents[t];return r&&(typeof r=="function"?this.onceEvents[t]=void 0:typeof r=="object"&&(r.length===1&&r[0]===e?this.onceEvents[t]=void 0:(0,utils_1._fast_remove_single)(r,r.lastIndexOf(e)))),this}function addListenerBound(t,e,n,r){n===void 0&&(n=this),r===void 0&&(r=e.length),this.boundFuncs||(this.boundFuncs=new Map);var s=e.bind(n);return this.boundFuncs.set(e,s),this.addListener(t,s,r)}function removeListenerBound(t,e){var n,r,s=(n=this.boundFuncs)===null||n===void 0?void 0:n.get(e);return(r=this.boundFuncs)===null||r===void 0||r.delete(e),this.removeListener(t,s)}function hasListeners(t){return this.events[t]&&!!this.events[t].length}function prependListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[t];return!r||!(r instanceof task_collection_1.TaskCollection)?(r=this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)):(r.insert(0,e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))),this}function prependOnceListener(t,e){this.emit===emit&&(this.emit=emitHasOnce);var n=this.onceEvents[t];return n?typeof n!="object"?(this.onceEvents[t]=[e,n],typeof t=="symbol"&&this._symbolKeys.add(t)):(n.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" once event!'))):(this.onceEvents[t]=[e],typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeAllListeners(t){return t===void 0?(this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set):(this.events[t]=void 0,this.onceEvents[t]=void 0,typeof t=="symbol"&&this._symbolKeys.delete(t)),this}function setMaxListeners(t){return this.maxListeners=t,this}function getMaxListeners(){return this.maxListeners}function listeners(t){return this.emit===emit?this.events[t]?this.events[t].tasksAsArray().slice():[]:this.events[t]&&this.onceEvents[t]?__spreadArray(__spreadArray([],this.events[t].tasksAsArray(),!0),typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t],!0):this.events[t]?this.events[t].tasksAsArray():this.onceEvents[t]?typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t]:[]}function eventNames(){var t=this;if(this.emit===emit){var e=Object.keys(this.events);return __spreadArray(__spreadArray([],e,!0),Array.from(this._symbolKeys),!0).filter(function(r){return r in t.events&&t.events[r]&&t.events[r].length})}else{var e=Object.keys(this.events).filter(function(s){return t.events[s]&&t.events[s].length}),n=Object.keys(this.onceEvents).filter(function(s){return t.onceEvents[s]&&t.onceEvents[s].length});return __spreadArray(__spreadArray(__spreadArray([],e,!0),n,!0),Array.from(this._symbolKeys).filter(function(s){return s in t.events&&t.events[s]&&t.events[s].length||s in t.onceEvents&&t.onceEvents[s]&&t.onceEvents[s].length}),!0)}}function listenerCount(t){return this.emit===emit?this.events[t]&&this.events[t].length||0:(this.events[t]&&this.events[t].length||0)+(this.onceEvents[t]&&this.onceEvents[t].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,o,a){a===void 0&&(a=o);var l=Object.getOwnPropertyDescriptor(s,o);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,a,l)}:function(r,s,o,a){a===void 0&&(a=o),r[a]=s[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var o in r)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&e(s,r,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(types,t),n(ee,t)})(lib$1);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var t=1e3,e=t*60,n=e*60,r=n*24,s=r*7,o=r*365.25;ms=function(y,b){b=b||{};var w=typeof y;if(w==="string"&&y.length>0)return a(y);if(w==="number"&&isFinite(y))return b.long?u(y):l(y);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(y))};function a(y){if(y=String(y),!(y.length>100)){var b=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(y);if(b){var w=parseFloat(b[1]),_=(b[2]||"ms").toLowerCase();switch(_){case"years":case"year":case"yrs":case"yr":case"y":return w*o;case"weeks":case"week":case"w":return w*s;case"days":case"day":case"d":return w*r;case"hours":case"hour":case"hrs":case"hr":case"h":return w*n;case"minutes":case"minute":case"mins":case"min":case"m":return w*e;case"seconds":case"second":case"secs":case"sec":case"s":return w*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return w;default:return}}}}function l(y){var b=Math.abs(y);return b>=r?Math.round(y/r)+"d":b>=n?Math.round(y/n)+"h":b>=e?Math.round(y/e)+"m":b>=t?Math.round(y/t)+"s":y+"ms"}function u(y){var b=Math.abs(y);return b>=r?p(y,b,r,"day"):b>=n?p(y,b,n,"hour"):b>=e?p(y,b,e,"minute"):b>=t?p(y,b,t,"second"):y+" ms"}function p(y,b,w,_){var x=b>=w*1.5;return Math.round(y/w)+" "+_+(x?"s":"")}return ms}function setup(t){n.debug=n,n.default=n,n.coerce=u,n.disable=a,n.enable=s,n.enabled=l,n.humanize=requireMs(),n.destroy=p,Object.keys(t).forEach(y=>{n[y]=t[y]}),n.names=[],n.skips=[],n.formatters={};function e(y){let b=0;for(let w=0;w<y.length;w++)b=(b<<5)-b+y.charCodeAt(w),b|=0;return n.colors[Math.abs(b)%n.colors.length]}n.selectColor=e;function n(y){let b,w=null,_,x;function T(...k){if(!T.enabled)return;const B=T,G=Number(new Date),z=G-(b||G);B.diff=z,B.prev=b,B.curr=G,b=G,k[0]=n.coerce(k[0]),typeof k[0]!="string"&&k.unshift("%O");let Q=0;k[0]=k[0].replace(/%([a-zA-Z%])/g,(ie,te)=>{if(ie==="%%")return"%";Q++;const oe=n.formatters[te];if(typeof oe=="function"){const ne=k[Q];ie=oe.call(B,ne),k.splice(Q,1),Q--}return ie}),n.formatArgs.call(B,k),(B.log||n.log).apply(B,k)}return T.namespace=y,T.useColors=n.useColors(),T.color=n.selectColor(y),T.extend=r,T.destroy=n.destroy,Object.defineProperty(T,"enabled",{enumerable:!0,configurable:!1,get:()=>w!==null?w:(_!==n.namespaces&&(_=n.namespaces,x=n.enabled(y)),x),set:k=>{w=k}}),typeof n.init=="function"&&n.init(T),T}function r(y,b){const w=n(this.namespace+(typeof b>"u"?":":b)+y);return w.log=this.log,w}function s(y){n.save(y),n.namespaces=y,n.names=[],n.skips=[];const b=(typeof y=="string"?y:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const w of b)w[0]==="-"?n.skips.push(w.slice(1)):n.names.push(w)}function o(y,b){let w=0,_=0,x=-1,T=0;for(;w<y.length;)if(_<b.length&&(b[_]===y[w]||b[_]==="*"))b[_]==="*"?(x=_,T=w,_++):(w++,_++);else if(x!==-1)_=x+1,T++,w=T;else return!1;for(;_<b.length&&b[_]==="*";)_++;return _===b.length}function a(){const y=[...n.names,...n.skips.map(b=>"-"+b)].join(",");return n.enable(""),y}function l(y){for(const b of n.skips)if(o(y,b))return!1;for(const b of n.names)if(o(y,b))return!0;return!1}function u(y){return y instanceof Error?y.stack||y.message:y}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}var common=setup;(function(t,e){var n={};e.formatArgs=s,e.save=o,e.load=a,e.useColors=r,e.storage=l(),e.destroy=(()=>{let p=!1;return()=>{p||(p=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let p;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(p=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(p[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(p){if(p[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+p[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const y="color: "+this.color;p.splice(1,0,y,"color: inherit");let b=0,w=0;p[0].replace(/%[a-zA-Z%]/g,_=>{_!=="%%"&&(b++,_==="%c"&&(w=b))}),p.splice(w,0,y)}e.log=console.debug||console.log||(()=>{});function o(p){try{p?e.storage.setItem("debug",p):e.storage.removeItem("debug")}catch{}}function a(){let p;try{p=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!p&&typeof process<"u"&&"env"in process&&(p=n.DEBUG),p}function l(){try{return localStorage}catch{}}t.exports=common(e);const{formatters:u}=t.exports;u.j=function(p){try{return JSON.stringify(p)}catch(y){return"[UnexpectedJSONParseError]: "+y.message}}})(browser,browser.exports);var browserExports=browser.exports;const createDebug2=getDefaultExportFromCjs(browserExports);var sha256$1={},sha2={},_md={},utils={},crypto$1={};Object.defineProperty(crypto$1,"__esModule",{value:!0});crypto$1.crypto=void 0;crypto$1.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;(function(t){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(t,"__esModule",{value:!0}),t.wrapXOFConstructorWithOpts=t.wrapConstructorWithOpts=t.wrapConstructor=t.Hash=t.nextTick=t.swap32IfBE=t.byteSwapIfBE=t.swap8IfBE=t.isLE=void 0,t.isBytes=n,t.anumber=r,t.abytes=s,t.ahash=o,t.aexists=a,t.aoutput=l,t.u8=u,t.u32=p,t.clean=y,t.createView=b,t.rotr=w,t.rotl=_,t.byteSwap=x,t.byteSwap32=T,t.bytesToHex=G,t.hexToBytes=ye,t.asyncLoop=te,t.utf8ToBytes=oe,t.bytesToUtf8=ne,t.toBytes=me,t.kdfInputToBytes=O,t.concatBytes=F,t.checkOpts=j,t.createHasher=V,t.createOptHasher=W,t.createXOFer=Z,t.randomBytes=ae;const e=crypto$1;function n(A){return A instanceof Uint8Array||ArrayBuffer.isView(A)&&A.constructor.name==="Uint8Array"}function r(A){if(!Number.isSafeInteger(A)||A<0)throw new Error("positive integer expected, got "+A)}function s(A,...J){if(!n(A))throw new Error("Uint8Array expected");if(J.length>0&&!J.includes(A.length))throw new Error("Uint8Array expected of length "+J+", got length="+A.length)}function o(A){if(typeof A!="function"||typeof A.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");r(A.outputLen),r(A.blockLen)}function a(A,J=!0){if(A.destroyed)throw new Error("Hash instance has been destroyed");if(J&&A.finished)throw new Error("Hash#digest() has already been called")}function l(A,J){s(A);const X=J.outputLen;if(A.length<X)throw new Error("digestInto() expects output buffer of length at least "+X)}function u(A){return new Uint8Array(A.buffer,A.byteOffset,A.byteLength)}function p(A){return new Uint32Array(A.buffer,A.byteOffset,Math.floor(A.byteLength/4))}function y(...A){for(let J=0;J<A.length;J++)A[J].fill(0)}function b(A){return new DataView(A.buffer,A.byteOffset,A.byteLength)}function w(A,J){return A<<32-J|A>>>J}function _(A,J){return A<<J|A>>>32-J>>>0}t.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function x(A){return A<<24&4278190080|A<<8&16711680|A>>>8&65280|A>>>24&255}t.swap8IfBE=t.isLE?A=>A:A=>x(A),t.byteSwapIfBE=t.swap8IfBE;function T(A){for(let J=0;J<A.length;J++)A[J]=x(A[J]);return A}t.swap32IfBE=t.isLE?A=>A:T;const k=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",B=Array.from({length:256},(A,J)=>J.toString(16).padStart(2,"0"));function G(A){if(s(A),k)return A.toHex();let J="";for(let X=0;X<A.length;X++)J+=B[A[X]];return J}const z={_0:48,_9:57,A:65,F:70,a:97,f:102};function Q(A){if(A>=z._0&&A<=z._9)return A-z._0;if(A>=z.A&&A<=z.F)return A-(z.A-10);if(A>=z.a&&A<=z.f)return A-(z.a-10)}function ye(A){if(typeof A!="string")throw new Error("hex string expected, got "+typeof A);if(k)return Uint8Array.fromHex(A);const J=A.length,X=J/2;if(J%2)throw new Error("hex string expected, got unpadded hex of length "+J);const de=new Uint8Array(X);for(let ve=0,we=0;ve<X;ve++,we+=2){const Ce=Q(A.charCodeAt(we)),Re=Q(A.charCodeAt(we+1));if(Ce===void 0||Re===void 0){const De=A[we]+A[we+1];throw new Error('hex string expected, got non-hex character "'+De+'" at index '+we)}de[ve]=Ce*16+Re}return de}const ie=async()=>{};t.nextTick=ie;async function te(A,J,X){let de=Date.now();for(let ve=0;ve<A;ve++){X(ve);const we=Date.now()-de;we>=0&&we<J||(await(0,t.nextTick)(),de+=we)}}function oe(A){if(typeof A!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(A))}function ne(A){return new TextDecoder().decode(A)}function me(A){return typeof A=="string"&&(A=oe(A)),s(A),A}function O(A){return typeof A=="string"&&(A=oe(A)),s(A),A}function F(...A){let J=0;for(let de=0;de<A.length;de++){const ve=A[de];s(ve),J+=ve.length}const X=new Uint8Array(J);for(let de=0,ve=0;de<A.length;de++){const we=A[de];X.set(we,ve),ve+=we.length}return X}function j(A,J){if(J!==void 0&&{}.toString.call(J)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(A,J)}class H{}t.Hash=H;function V(A){const J=de=>A().update(me(de)).digest(),X=A();return J.outputLen=X.outputLen,J.blockLen=X.blockLen,J.create=()=>A(),J}function W(A){const J=(de,ve)=>A(ve).update(me(de)).digest(),X=A({});return J.outputLen=X.outputLen,J.blockLen=X.blockLen,J.create=de=>A(de),J}function Z(A){const J=(de,ve)=>A(ve).update(me(de)).digest(),X=A({});return J.outputLen=X.outputLen,J.blockLen=X.blockLen,J.create=de=>A(de),J}t.wrapConstructor=V,t.wrapConstructorWithOpts=W,t.wrapXOFConstructorWithOpts=Z;function ae(A=32){if(e.crypto&&typeof e.crypto.getRandomValues=="function")return e.crypto.getRandomValues(new Uint8Array(A));if(e.crypto&&typeof e.crypto.randomBytes=="function")return Uint8Array.from(e.crypto.randomBytes(A));throw new Error("crypto.getRandomValues must be defined")}})(utils);Object.defineProperty(_md,"__esModule",{value:!0});_md.SHA512_IV=_md.SHA384_IV=_md.SHA224_IV=_md.SHA256_IV=_md.HashMD=void 0;_md.setBigUint64=setBigUint64$1;_md.Chi=Chi;_md.Maj=Maj;const utils_ts_1$4=utils;function setBigUint64$1(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),o=BigInt(4294967295),a=Number(n>>s&o),l=Number(n&o),u=r?4:0,p=r?0:4;t.setUint32(e+u,a,r),t.setUint32(e+p,l,r)}function Chi(t,e,n){return t&e^~t&n}function Maj(t,e,n){return t&e^t&n^e&n}class HashMD extends utils_ts_1$4.Hash{constructor(e,n,r,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(e),this.view=(0,utils_ts_1$4.createView)(this.buffer)}update(e){(0,utils_ts_1$4.aexists)(this),e=(0,utils_ts_1$4.toBytes)(e),(0,utils_ts_1$4.abytes)(e);const{view:n,buffer:r,blockLen:s}=this,o=e.length;for(let a=0;a<o;){const l=Math.min(s-this.pos,o-a);if(l===s){const u=(0,utils_ts_1$4.createView)(e);for(;s<=o-a;a+=s)this.process(u,a);continue}r.set(e.subarray(a,a+l),this.pos),this.pos+=l,a+=l,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){(0,utils_ts_1$4.aexists)(this),(0,utils_ts_1$4.aoutput)(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:o}=this;let{pos:a}=this;n[a++]=128,(0,utils_ts_1$4.clean)(this.buffer.subarray(a)),this.padOffset>s-a&&(this.process(r,0),a=0);for(let b=a;b<s;b++)n[b]=0;setBigUint64$1(r,s-8,BigInt(this.length*8),o),this.process(r,0);const l=(0,utils_ts_1$4.createView)(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const p=u/4,y=this.get();if(p>y.length)throw new Error("_sha2: outputLen bigger than state");for(let b=0;b<p;b++)l.setUint32(4*b,y[b],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:o,destroyed:a,pos:l}=this;return e.destroyed=a,e.finished=o,e.length=s,e.pos=l,s%n&&e.buffer.set(r),e}clone(){return this._cloneInto()}}_md.HashMD=HashMD;_md.SHA256_IV=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);_md.SHA224_IV=Uint32Array.from([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]);_md.SHA384_IV=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]);_md.SHA512_IV=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var _u64={};Object.defineProperty(_u64,"__esModule",{value:!0});_u64.toBig=_u64.shrSL=_u64.shrSH=_u64.rotrSL=_u64.rotrSH=_u64.rotrBL=_u64.rotrBH=_u64.rotr32L=_u64.rotr32H=_u64.rotlSL=_u64.rotlSH=_u64.rotlBL=_u64.rotlBH=_u64.add5L=_u64.add5H=_u64.add4L=_u64.add4H=_u64.add3L=_u64.add3H=void 0;_u64.add=add$1;_u64.fromBig=fromBig;_u64.split=split;const U32_MASK64=BigInt(2**32-1),_32n=BigInt(32);function fromBig(t,e=!1){return e?{h:Number(t&U32_MASK64),l:Number(t>>_32n&U32_MASK64)}:{h:Number(t>>_32n&U32_MASK64)|0,l:Number(t&U32_MASK64)|0}}function split(t,e=!1){const n=t.length;let r=new Uint32Array(n),s=new Uint32Array(n);for(let o=0;o<n;o++){const{h:a,l}=fromBig(t[o],e);[r[o],s[o]]=[a,l]}return[r,s]}const toBig=(t,e)=>BigInt(t>>>0)<<_32n|BigInt(e>>>0);_u64.toBig=toBig;const shrSH=(t,e,n)=>t>>>n;_u64.shrSH=shrSH;const shrSL=(t,e,n)=>t<<32-n|e>>>n;_u64.shrSL=shrSL;const rotrSH=(t,e,n)=>t>>>n|e<<32-n;_u64.rotrSH=rotrSH;const rotrSL=(t,e,n)=>t<<32-n|e>>>n;_u64.rotrSL=rotrSL;const rotrBH=(t,e,n)=>t<<64-n|e>>>n-32;_u64.rotrBH=rotrBH;const rotrBL=(t,e,n)=>t>>>n-32|e<<64-n;_u64.rotrBL=rotrBL;const rotr32H=(t,e)=>e;_u64.rotr32H=rotr32H;const rotr32L=(t,e)=>t;_u64.rotr32L=rotr32L;const rotlSH=(t,e,n)=>t<<n|e>>>32-n;_u64.rotlSH=rotlSH;const rotlSL=(t,e,n)=>e<<n|t>>>32-n;_u64.rotlSL=rotlSL;const rotlBH=(t,e,n)=>e<<n-32|t>>>64-n;_u64.rotlBH=rotlBH;const rotlBL=(t,e,n)=>t<<n-32|e>>>64-n;_u64.rotlBL=rotlBL;function add$1(t,e,n,r){const s=(e>>>0)+(r>>>0);return{h:t+n+(s/2**32|0)|0,l:s|0}}const add3L=(t,e,n)=>(t>>>0)+(e>>>0)+(n>>>0);_u64.add3L=add3L;const add3H=(t,e,n,r)=>e+n+r+(t/2**32|0)|0;_u64.add3H=add3H;const add4L=(t,e,n,r)=>(t>>>0)+(e>>>0)+(n>>>0)+(r>>>0);_u64.add4L=add4L;const add4H=(t,e,n,r,s)=>e+n+r+s+(t/2**32|0)|0;_u64.add4H=add4H;const add5L=(t,e,n,r,s)=>(t>>>0)+(e>>>0)+(n>>>0)+(r>>>0)+(s>>>0);_u64.add5L=add5L;const add5H=(t,e,n,r,s,o)=>e+n+r+s+o+(t/2**32|0)|0;_u64.add5H=add5H;const u64$1={fromBig,split,toBig,shrSH,shrSL,rotrSH,rotrSL,rotrBH,rotrBL,rotr32H,rotr32L,rotlSH,rotlSL,rotlBH,rotlBL,add:add$1,add3L,add3H,add4L,add4H,add5H,add5L};_u64.default=u64$1;Object.defineProperty(sha2,"__esModule",{value:!0});sha2.sha512_224=sha2.sha512_256=sha2.sha384=sha512=sha2.sha512=sha2.sha224=sha256=sha2.sha256=sha2.SHA512_256=sha2.SHA512_224=sha2.SHA384=sha2.SHA512=sha2.SHA224=sha2.SHA256=void 0;const _md_ts_1=_md,u64=_u64,utils_ts_1$3=utils,SHA256_K=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_W=new Uint32Array(64);class SHA256 extends _md_ts_1.HashMD{constructor(e=32){super(64,e,8,!1),this.A=_md_ts_1.SHA256_IV[0]|0,this.B=_md_ts_1.SHA256_IV[1]|0,this.C=_md_ts_1.SHA256_IV[2]|0,this.D=_md_ts_1.SHA256_IV[3]|0,this.E=_md_ts_1.SHA256_IV[4]|0,this.F=_md_ts_1.SHA256_IV[5]|0,this.G=_md_ts_1.SHA256_IV[6]|0,this.H=_md_ts_1.SHA256_IV[7]|0}get(){const{A:e,B:n,C:r,D:s,E:o,F:a,G:l,H:u}=this;return[e,n,r,s,o,a,l,u]}set(e,n,r,s,o,a,l,u){this.A=e|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=o|0,this.F=a|0,this.G=l|0,this.H=u|0}process(e,n){for(let b=0;b<16;b++,n+=4)SHA256_W[b]=e.getUint32(n,!1);for(let b=16;b<64;b++){const w=SHA256_W[b-15],_=SHA256_W[b-2],x=(0,utils_ts_1$3.rotr)(w,7)^(0,utils_ts_1$3.rotr)(w,18)^w>>>3,T=(0,utils_ts_1$3.rotr)(_,17)^(0,utils_ts_1$3.rotr)(_,19)^_>>>10;SHA256_W[b]=T+SHA256_W[b-7]+x+SHA256_W[b-16]|0}let{A:r,B:s,C:o,D:a,E:l,F:u,G:p,H:y}=this;for(let b=0;b<64;b++){const w=(0,utils_ts_1$3.rotr)(l,6)^(0,utils_ts_1$3.rotr)(l,11)^(0,utils_ts_1$3.rotr)(l,25),_=y+w+(0,_md_ts_1.Chi)(l,u,p)+SHA256_K[b]+SHA256_W[b]|0,T=((0,utils_ts_1$3.rotr)(r,2)^(0,utils_ts_1$3.rotr)(r,13)^(0,utils_ts_1$3.rotr)(r,22))+(0,_md_ts_1.Maj)(r,s,o)|0;y=p,p=u,u=l,l=a+_|0,a=o,o=s,s=r,r=_+T|0}r=r+this.A|0,s=s+this.B|0,o=o+this.C|0,a=a+this.D|0,l=l+this.E|0,u=u+this.F|0,p=p+this.G|0,y=y+this.H|0,this.set(r,s,o,a,l,u,p,y)}roundClean(){(0,utils_ts_1$3.clean)(SHA256_W)}destroy(){this.set(0,0,0,0,0,0,0,0),(0,utils_ts_1$3.clean)(this.buffer)}}sha2.SHA256=SHA256;class SHA224 extends SHA256{constructor(){super(28),this.A=_md_ts_1.SHA224_IV[0]|0,this.B=_md_ts_1.SHA224_IV[1]|0,this.C=_md_ts_1.SHA224_IV[2]|0,this.D=_md_ts_1.SHA224_IV[3]|0,this.E=_md_ts_1.SHA224_IV[4]|0,this.F=_md_ts_1.SHA224_IV[5]|0,this.G=_md_ts_1.SHA224_IV[6]|0,this.H=_md_ts_1.SHA224_IV[7]|0}}sha2.SHA224=SHA224;const K512=u64.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(t=>BigInt(t))),SHA512_Kh=K512[0],SHA512_Kl=K512[1],SHA512_W_H=new Uint32Array(80),SHA512_W_L=new Uint32Array(80);class SHA512 extends _md_ts_1.HashMD{constructor(e=64){super(128,e,16,!1),this.Ah=_md_ts_1.SHA512_IV[0]|0,this.Al=_md_ts_1.SHA512_IV[1]|0,this.Bh=_md_ts_1.SHA512_IV[2]|0,this.Bl=_md_ts_1.SHA512_IV[3]|0,this.Ch=_md_ts_1.SHA512_IV[4]|0,this.Cl=_md_ts_1.SHA512_IV[5]|0,this.Dh=_md_ts_1.SHA512_IV[6]|0,this.Dl=_md_ts_1.SHA512_IV[7]|0,this.Eh=_md_ts_1.SHA512_IV[8]|0,this.El=_md_ts_1.SHA512_IV[9]|0,this.Fh=_md_ts_1.SHA512_IV[10]|0,this.Fl=_md_ts_1.SHA512_IV[11]|0,this.Gh=_md_ts_1.SHA512_IV[12]|0,this.Gl=_md_ts_1.SHA512_IV[13]|0,this.Hh=_md_ts_1.SHA512_IV[14]|0,this.Hl=_md_ts_1.SHA512_IV[15]|0}get(){const{Ah:e,Al:n,Bh:r,Bl:s,Ch:o,Cl:a,Dh:l,Dl:u,Eh:p,El:y,Fh:b,Fl:w,Gh:_,Gl:x,Hh:T,Hl:k}=this;return[e,n,r,s,o,a,l,u,p,y,b,w,_,x,T,k]}set(e,n,r,s,o,a,l,u,p,y,b,w,_,x,T,k){this.Ah=e|0,this.Al=n|0,this.Bh=r|0,this.Bl=s|0,this.Ch=o|0,this.Cl=a|0,this.Dh=l|0,this.Dl=u|0,this.Eh=p|0,this.El=y|0,this.Fh=b|0,this.Fl=w|0,this.Gh=_|0,this.Gl=x|0,this.Hh=T|0,this.Hl=k|0}process(e,n){for(let z=0;z<16;z++,n+=4)SHA512_W_H[z]=e.getUint32(n),SHA512_W_L[z]=e.getUint32(n+=4);for(let z=16;z<80;z++){const Q=SHA512_W_H[z-15]|0,ye=SHA512_W_L[z-15]|0,ie=u64.rotrSH(Q,ye,1)^u64.rotrSH(Q,ye,8)^u64.shrSH(Q,ye,7),te=u64.rotrSL(Q,ye,1)^u64.rotrSL(Q,ye,8)^u64.shrSL(Q,ye,7),oe=SHA512_W_H[z-2]|0,ne=SHA512_W_L[z-2]|0,me=u64.rotrSH(oe,ne,19)^u64.rotrBH(oe,ne,61)^u64.shrSH(oe,ne,6),O=u64.rotrSL(oe,ne,19)^u64.rotrBL(oe,ne,61)^u64.shrSL(oe,ne,6),F=u64.add4L(te,O,SHA512_W_L[z-7],SHA512_W_L[z-16]),j=u64.add4H(F,ie,me,SHA512_W_H[z-7],SHA512_W_H[z-16]);SHA512_W_H[z]=j|0,SHA512_W_L[z]=F|0}let{Ah:r,Al:s,Bh:o,Bl:a,Ch:l,Cl:u,Dh:p,Dl:y,Eh:b,El:w,Fh:_,Fl:x,Gh:T,Gl:k,Hh:B,Hl:G}=this;for(let z=0;z<80;z++){const Q=u64.rotrSH(b,w,14)^u64.rotrSH(b,w,18)^u64.rotrBH(b,w,41),ye=u64.rotrSL(b,w,14)^u64.rotrSL(b,w,18)^u64.rotrBL(b,w,41),ie=b&_^~b&T,te=w&x^~w&k,oe=u64.add5L(G,ye,te,SHA512_Kl[z],SHA512_W_L[z]),ne=u64.add5H(oe,B,Q,ie,SHA512_Kh[z],SHA512_W_H[z]),me=oe|0,O=u64.rotrSH(r,s,28)^u64.rotrBH(r,s,34)^u64.rotrBH(r,s,39),F=u64.rotrSL(r,s,28)^u64.rotrBL(r,s,34)^u64.rotrBL(r,s,39),j=r&o^r&l^o&l,H=s&a^s&u^a&u;B=T|0,G=k|0,T=_|0,k=x|0,_=b|0,x=w|0,{h:b,l:w}=u64.add(p|0,y|0,ne|0,me|0),p=l|0,y=u|0,l=o|0,u=a|0,o=r|0,a=s|0;const V=u64.add3L(me,F,H);r=u64.add3H(V,ne,O,j),s=V|0}({h:r,l:s}=u64.add(this.Ah|0,this.Al|0,r|0,s|0)),{h:o,l:a}=u64.add(this.Bh|0,this.Bl|0,o|0,a|0),{h:l,l:u}=u64.add(this.Ch|0,this.Cl|0,l|0,u|0),{h:p,l:y}=u64.add(this.Dh|0,this.Dl|0,p|0,y|0),{h:b,l:w}=u64.add(this.Eh|0,this.El|0,b|0,w|0),{h:_,l:x}=u64.add(this.Fh|0,this.Fl|0,_|0,x|0),{h:T,l:k}=u64.add(this.Gh|0,this.Gl|0,T|0,k|0),{h:B,l:G}=u64.add(this.Hh|0,this.Hl|0,B|0,G|0),this.set(r,s,o,a,l,u,p,y,b,w,_,x,T,k,B,G)}roundClean(){(0,utils_ts_1$3.clean)(SHA512_W_H,SHA512_W_L)}destroy(){(0,utils_ts_1$3.clean)(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}sha2.SHA512=SHA512;class SHA384 extends SHA512{constructor(){super(48),this.Ah=_md_ts_1.SHA384_IV[0]|0,this.Al=_md_ts_1.SHA384_IV[1]|0,this.Bh=_md_ts_1.SHA384_IV[2]|0,this.Bl=_md_ts_1.SHA384_IV[3]|0,this.Ch=_md_ts_1.SHA384_IV[4]|0,this.Cl=_md_ts_1.SHA384_IV[5]|0,this.Dh=_md_ts_1.SHA384_IV[6]|0,this.Dl=_md_ts_1.SHA384_IV[7]|0,this.Eh=_md_ts_1.SHA384_IV[8]|0,this.El=_md_ts_1.SHA384_IV[9]|0,this.Fh=_md_ts_1.SHA384_IV[10]|0,this.Fl=_md_ts_1.SHA384_IV[11]|0,this.Gh=_md_ts_1.SHA384_IV[12]|0,this.Gl=_md_ts_1.SHA384_IV[13]|0,this.Hh=_md_ts_1.SHA384_IV[14]|0,this.Hl=_md_ts_1.SHA384_IV[15]|0}}sha2.SHA384=SHA384;const T224_IV=Uint32Array.from([2352822216,424955298,1944164710,2312950998,502970286,855612546,1738396948,1479516111,258812777,2077511080,2011393907,79989058,1067287976,1780299464,286451373,2446758561]),T256_IV=Uint32Array.from([573645204,4230739756,2673172387,3360449730,596883563,1867755857,2520282905,1497426621,2519219938,2827943907,3193839141,1401305490,721525244,746961066,246885852,2177182882]);class SHA512_224 extends SHA512{constructor(){super(28),this.Ah=T224_IV[0]|0,this.Al=T224_IV[1]|0,this.Bh=T224_IV[2]|0,this.Bl=T224_IV[3]|0,this.Ch=T224_IV[4]|0,this.Cl=T224_IV[5]|0,this.Dh=T224_IV[6]|0,this.Dl=T224_IV[7]|0,this.Eh=T224_IV[8]|0,this.El=T224_IV[9]|0,this.Fh=T224_IV[10]|0,this.Fl=T224_IV[11]|0,this.Gh=T224_IV[12]|0,this.Gl=T224_IV[13]|0,this.Hh=T224_IV[14]|0,this.Hl=T224_IV[15]|0}}sha2.SHA512_224=SHA512_224;class SHA512_256 extends SHA512{constructor(){super(32),this.Ah=T256_IV[0]|0,this.Al=T256_IV[1]|0,this.Bh=T256_IV[2]|0,this.Bl=T256_IV[3]|0,this.Ch=T256_IV[4]|0,this.Cl=T256_IV[5]|0,this.Dh=T256_IV[6]|0,this.Dl=T256_IV[7]|0,this.Eh=T256_IV[8]|0,this.El=T256_IV[9]|0,this.Fh=T256_IV[10]|0,this.Fl=T256_IV[11]|0,this.Gh=T256_IV[12]|0,this.Gl=T256_IV[13]|0,this.Hh=T256_IV[14]|0,this.Hl=T256_IV[15]|0}}sha2.SHA512_256=SHA512_256;var sha256=sha2.sha256=(0,utils_ts_1$3.createHasher)(()=>new SHA256);sha2.sha224=(0,utils_ts_1$3.createHasher)(()=>new SHA224);var sha512=sha2.sha512=(0,utils_ts_1$3.createHasher)(()=>new SHA512);sha2.sha384=(0,utils_ts_1$3.createHasher)(()=>new SHA384);sha2.sha512_256=(0,utils_ts_1$3.createHasher)(()=>new SHA512_256);sha2.sha512_224=(0,utils_ts_1$3.createHasher)(()=>new SHA512_224);Object.defineProperty(sha256$1,"__esModule",{value:!0});sha256$1.sha224=sha256$1.SHA224=sha256_1=sha256$1.sha256=sha256$1.SHA256=void 0;const sha2_ts_1$1=sha2;sha256$1.SHA256=sha2_ts_1$1.SHA256;var sha256_1=sha256$1.sha256=sha2_ts_1$1.sha256;sha256$1.SHA224=sha2_ts_1$1.SHA224;sha256$1.sha224=sha2_ts_1$1.sha224;var hmac={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.hmac=t.HMAC=void 0;const e=utils;class n extends e.Hash{constructor(o,a){super(),this.finished=!1,this.destroyed=!1,(0,e.ahash)(o);const l=(0,e.toBytes)(a);if(this.iHash=o.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const u=this.blockLen,p=new Uint8Array(u);p.set(l.length>u?o.create().update(l).digest():l);for(let y=0;y<p.length;y++)p[y]^=54;this.iHash.update(p),this.oHash=o.create();for(let y=0;y<p.length;y++)p[y]^=106;this.oHash.update(p),(0,e.clean)(p)}update(o){return(0,e.aexists)(this),this.iHash.update(o),this}digestInto(o){(0,e.aexists)(this),(0,e.abytes)(o,this.outputLen),this.finished=!0,this.iHash.digestInto(o),this.oHash.update(o),this.oHash.digestInto(o),this.destroy()}digest(){const o=new Uint8Array(this.oHash.outputLen);return this.digestInto(o),o}_cloneInto(o){o||(o=Object.create(Object.getPrototypeOf(this),{}));const{oHash:a,iHash:l,finished:u,destroyed:p,blockLen:y,outputLen:b}=this;return o=o,o.finished=u,o.destroyed=p,o.blockLen=y,o.outputLen=b,o.oHash=a._cloneInto(o.oHash),o.iHash=l._cloneInto(o.iHash),o}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}t.HMAC=n;const r=(s,o,a)=>new n(s,o).update(a).digest();t.hmac=r,t.hmac.create=(s,o)=>new n(s,o)})(hmac);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1),_2n$2=BigInt(2);function isBytes$1(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function abytes(t){if(!isBytes$1(t))throw new Error("Uint8Array expected")}function abool(t,e){if(typeof e!="boolean")throw new Error(t+" boolean expected, got "+e)}const hexes$1=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$1(t){abytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes$1[t[n]];return e}function numberToHexUnpadded(t){const e=t.toString(16);return e.length&1?"0"+e:e}function hexToNumber(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?_0n$4:BigInt("0x"+t)}const asciis$1={_0:48,_9:57,A:65,F:70,a:97,f:102};function asciiToBase16$1(t){if(t>=asciis$1._0&&t<=asciis$1._9)return t-asciis$1._0;if(t>=asciis$1.A&&t<=asciis$1.F)return t-(asciis$1.A-10);if(t>=asciis$1.a&&t<=asciis$1.f)return t-(asciis$1.a-10)}function hexToBytes$1(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let s=0,o=0;s<n;s++,o+=2){const a=asciiToBase16$1(t.charCodeAt(o)),l=asciiToBase16$1(t.charCodeAt(o+1));if(a===void 0||l===void 0){const u=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+u+'" at index '+o)}r[s]=a*16+l}return r}function bytesToNumberBE(t){return hexToNumber(bytesToHex$1(t))}function bytesToNumberLE(t){return abytes(t),hexToNumber(bytesToHex$1(Uint8Array.from(t).reverse()))}function numberToBytesBE(t,e){return hexToBytes$1(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE(t,e){return numberToBytesBE(t,e).reverse()}function numberToVarBytesBE(t){return hexToBytes$1(numberToHexUnpadded(t))}function ensureBytes(t,e,n){let r;if(typeof e=="string")try{r=hexToBytes$1(e)}catch(o){throw new Error(t+" must be hex string or Uint8Array, cause: "+o)}else if(isBytes$1(e))r=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(t+" of length "+n+" expected, got "+s);return r}function concatBytes(...t){let e=0;for(let r=0;r<t.length;r++){const s=t[r];abytes(s),e+=s.length}const n=new Uint8Array(e);for(let r=0,s=0;r<t.length;r++){const o=t[r];n.set(o,s),s+=o.length}return n}function equalBytes$1(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}function utf8ToBytes$1(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}const isPosBig=t=>typeof t=="bigint"&&_0n$4<=t;function inRange(t,e,n){return isPosBig(t)&&isPosBig(e)&&isPosBig(n)&&e<=t&&t<n}function aInRange(t,e,n,r){if(!inRange(e,n,r))throw new Error("expected valid "+t+": "+n+" <= n < "+r+", got "+e)}function bitLen(t){let e;for(e=0;t>_0n$4;t>>=_1n$4,e+=1);return e}function bitGet(t,e){return t>>BigInt(e)&_1n$4}function bitSet(t,e,n){return t|(n?_1n$4:_0n$4)<<BigInt(e)}const bitMask=t=>(_2n$2<<BigInt(t-1))-_1n$4,u8n=t=>new Uint8Array(t),u8fr=t=>Uint8Array.from(t);function createHmacDrbg(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=u8n(t),s=u8n(t),o=0;const a=()=>{r.fill(1),s.fill(0),o=0},l=(...b)=>n(s,r,...b),u=(b=u8n())=>{s=l(u8fr([0]),b),r=l(),b.length!==0&&(s=l(u8fr([1]),b),r=l())},p=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let b=0;const w=[];for(;b<e;){r=l();const _=r.slice();w.push(_),b+=r.length}return concatBytes(...w)};return(b,w)=>{a(),u(b);let _;for(;!(_=w(p()));)u();return a(),_}}const validatorFns={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||isBytes$1(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function validateObject(t,e,n={}){const r=(s,o,a)=>{const l=validatorFns[o];if(typeof l!="function")throw new Error("invalid validator function");const u=t[s];if(!(a&&u===void 0)&&!l(u,t))throw new Error("param "+String(s)+" is invalid. Expected "+o+", got "+u)};for(const[s,o]of Object.entries(e))r(s,o,!1);for(const[s,o]of Object.entries(n))r(s,o,!0);return t}const notImplemented=()=>{throw new Error("not implemented")};function memoized(t){const e=new WeakMap;return(n,...r)=>{const s=e.get(n);if(s!==void 0)return s;const o=t(n,...r);return e.set(n,o),o}}const ut=Object.freeze(Object.defineProperty({__proto__:null,aInRange,abool,abytes,bitGet,bitLen,bitMask,bitSet,bytesToHex:bytesToHex$1,bytesToNumberBE,bytesToNumberLE,concatBytes,createHmacDrbg,ensureBytes,equalBytes:equalBytes$1,hexToBytes:hexToBytes$1,hexToNumber,inRange,isBytes:isBytes$1,memoized,notImplemented,numberToBytesBE,numberToBytesLE,numberToHexUnpadded,numberToVarBytesBE,utf8ToBytes:utf8ToBytes$1,validateObject},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$1=BigInt(2),_3n$1=BigInt(3),_4n=BigInt(4),_5n=BigInt(5),_8n=BigInt(8);function mod(t,e){const n=t%e;return n>=_0n$3?n:e+n}function pow(t,e,n){if(e<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(n<=_0n$3)throw new Error("invalid modulus");if(n===_1n$3)return _0n$3;let r=_1n$3;for(;e>_0n$3;)e&_1n$3&&(r=r*t%n),t=t*t%n,e>>=_1n$3;return r}function pow2(t,e,n){let r=t;for(;e-- >_0n$3;)r*=r,r%=n;return r}function invert(t,e){if(t===_0n$3)throw new Error("invert: expected non-zero number");if(e<=_0n$3)throw new Error("invert: expected positive modulus, got "+e);let n=mod(t,e),r=e,s=_0n$3,o=_1n$3;for(;n!==_0n$3;){const l=r/n,u=r%n,p=s-o*l;r=n,n=u,s=o,o=p}if(r!==_1n$3)throw new Error("invert: does not exist");return mod(s,e)}function tonelliShanks(t){const e=(t-_1n$3)/_2n$1;let n,r,s;for(n=t-_1n$3,r=0;n%_2n$1===_0n$3;n/=_2n$1,r++);for(s=_2n$1;s<t&&pow(s,e,t)!==t-_1n$3;s++)if(s>1e3)throw new Error("Cannot find square root: likely non-prime P");if(r===1){const a=(t+_1n$3)/_4n;return function(u,p){const y=u.pow(p,a);if(!u.eql(u.sqr(y),p))throw new Error("Cannot find square root");return y}}const o=(n+_1n$3)/_2n$1;return function(l,u){if(l.pow(u,e)===l.neg(l.ONE))throw new Error("Cannot find square root");let p=r,y=l.pow(l.mul(l.ONE,s),n),b=l.pow(u,o),w=l.pow(u,n);for(;!l.eql(w,l.ONE);){if(l.eql(w,l.ZERO))return l.ZERO;let _=1;for(let T=l.sqr(w);_<p&&!l.eql(T,l.ONE);_++)T=l.sqr(T);const x=l.pow(y,_1n$3<<BigInt(p-_-1));y=l.sqr(x),b=l.mul(b,x),w=l.mul(w,y),p=_}return b}}function FpSqrt(t){if(t%_4n===_3n$1){const e=(t+_1n$3)/_4n;return function(r,s){const o=r.pow(s,e);if(!r.eql(r.sqr(o),s))throw new Error("Cannot find square root");return o}}if(t%_8n===_5n){const e=(t-_5n)/_8n;return function(r,s){const o=r.mul(s,_2n$1),a=r.pow(o,e),l=r.mul(s,a),u=r.mul(r.mul(l,_2n$1),a),p=r.mul(l,r.sub(u,r.ONE));if(!r.eql(r.sqr(p),s))throw new Error("Cannot find square root");return p}}return tonelliShanks(t)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS.reduce((r,s)=>(r[s]="function",r),e);return validateObject(t,n)}function FpPow(t,e,n){if(n<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(n===_0n$3)return t.ONE;if(n===_1n$3)return e;let r=t.ONE,s=e;for(;n>_0n$3;)n&_1n$3&&(r=t.mul(r,s)),s=t.sqr(s),n>>=_1n$3;return r}function FpInvertBatch(t,e){const n=new Array(e.length),r=e.reduce((o,a,l)=>t.is0(a)?o:(n[l]=o,t.mul(o,a)),t.ONE),s=t.inv(r);return e.reduceRight((o,a,l)=>t.is0(a)?o:(n[l]=t.mul(o,n[l]),t.mul(o,a)),s),n}function nLength(t,e){const n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Field(t,e,n=!1,r={}){if(t<=_0n$3)throw new Error("invalid field: expected ORDER > 0, got "+t);const{nBitLength:s,nByteLength:o}=nLength(t,e);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let a;const l=Object.freeze({ORDER:t,isLE:n,BITS:s,BYTES:o,MASK:bitMask(s),ZERO:_0n$3,ONE:_1n$3,create:u=>mod(u,t),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return _0n$3<=u&&u<t},is0:u=>u===_0n$3,isOdd:u=>(u&_1n$3)===_1n$3,neg:u=>mod(-u,t),eql:(u,p)=>u===p,sqr:u=>mod(u*u,t),add:(u,p)=>mod(u+p,t),sub:(u,p)=>mod(u-p,t),mul:(u,p)=>mod(u*p,t),pow:(u,p)=>FpPow(l,u,p),div:(u,p)=>mod(u*invert(p,t),t),sqrN:u=>u*u,addN:(u,p)=>u+p,subN:(u,p)=>u-p,mulN:(u,p)=>u*p,inv:u=>invert(u,t),sqrt:r.sqrt||(u=>(a||(a=FpSqrt(t)),a(l,u))),invertBatch:u=>FpInvertBatch(l,u),cmov:(u,p,y)=>y?p:u,toBytes:u=>n?numberToBytesLE(u,o):numberToBytesBE(u,o),fromBytes:u=>{if(u.length!==o)throw new Error("Field.fromBytes: expected "+o+" bytes, got "+u.length);return n?bytesToNumberLE(u):bytesToNumberBE(u)}});return Object.freeze(l)}function getFieldBytesLength(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength(t){const e=getFieldBytesLength(t);return e+Math.ceil(e/2)}function mapHashToField(t,e,n=!1){const r=t.length,s=getFieldBytesLength(e),o=getMinHashLength(e);if(r<16||r<o||r>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+r);const a=n?bytesToNumberLE(t):bytesToNumberBE(t),l=mod(a,e-_1n$3)+_1n$3;return n?numberToBytesLE(l,s):numberToBytesBE(l,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1);function constTimeNegate(t,e){const n=e.negate();return t?n:e}function validateW(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function calcWOpts(t,e){validateW(t,e);const n=Math.ceil(e/t)+1,r=2**(t-1);return{windows:n,windowSize:r}}function validateMSMPoints(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((n,r)=>{if(!(n instanceof e))throw new Error("invalid point at index "+r)})}function validateMSMScalars(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((n,r)=>{if(!e.isValid(n))throw new Error("invalid scalar at index "+r)})}const pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function getW(t){return pointWindowSizes.get(t)||1}function wNAF(t,e){return{constTimeNegate,hasPrecomputes(n){return getW(n)!==1},unsafeLadder(n,r,s=t.ZERO){let o=n;for(;r>_0n$2;)r&_1n$2&&(s=s.add(o)),o=o.double(),r>>=_1n$2;return s},precomputeWindow(n,r){const{windows:s,windowSize:o}=calcWOpts(r,e),a=[];let l=n,u=l;for(let p=0;p<s;p++){u=l,a.push(u);for(let y=1;y<o;y++)u=u.add(l),a.push(u);l=u.double()}return a},wNAF(n,r,s){const{windows:o,windowSize:a}=calcWOpts(n,e);let l=t.ZERO,u=t.BASE;const p=BigInt(2**n-1),y=2**n,b=BigInt(n);for(let w=0;w<o;w++){const _=w*a;let x=Number(s&p);s>>=b,x>a&&(x-=y,s+=_1n$2);const T=_,k=_+Math.abs(x)-1,B=w%2!==0,G=x<0;x===0?u=u.add(constTimeNegate(B,r[T])):l=l.add(constTimeNegate(G,r[k]))}return{p:l,f:u}},wNAFUnsafe(n,r,s,o=t.ZERO){const{windows:a,windowSize:l}=calcWOpts(n,e),u=BigInt(2**n-1),p=2**n,y=BigInt(n);for(let b=0;b<a;b++){const w=b*l;if(s===_0n$2)break;let _=Number(s&u);if(s>>=y,_>l&&(_-=p,s+=_1n$2),_===0)continue;let x=r[w+Math.abs(_)-1];_<0&&(x=x.negate()),o=o.add(x)}return o},getPrecomputes(n,r,s){let o=pointPrecomputes.get(r);return o||(o=this.precomputeWindow(r,n),n!==1&&pointPrecomputes.set(r,s(o))),o},wNAFCached(n,r,s){const o=getW(n);return this.wNAF(o,this.getPrecomputes(o,n,s),r)},wNAFCachedUnsafe(n,r,s,o){const a=getW(n);return a===1?this.unsafeLadder(n,r,o):this.wNAFUnsafe(a,this.getPrecomputes(a,n,s),r,o)},setWindowSize(n,r){validateW(r,e),pointWindowSizes.set(n,r),pointPrecomputes.delete(n)}}}function pippenger(t,e,n,r){if(validateMSMPoints(n,t),validateMSMScalars(r,e),n.length!==r.length)throw new Error("arrays of points and scalars must have equal length");const s=t.ZERO,o=bitLen(BigInt(n.length)),a=o>12?o-3:o>4?o-2:o?2:1,l=(1<<a)-1,u=new Array(l+1).fill(s),p=Math.floor((e.BITS-1)/a)*a;let y=s;for(let b=p;b>=0;b-=a){u.fill(s);for(let _=0;_<r.length;_++){const x=r[_],T=Number(x>>BigInt(b)&BigInt(l));u[T]=u[T].add(n[_])}let w=s;for(let _=u.length-1,x=s;_>0;_--)x=x.add(u[_]),w=w.add(x);if(y=y.add(w),b!==0)for(let _=0;_<a;_++)y=y.double()}return y}function validateBasic(t){return validateField(t.Fp),validateObject(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validateSigVerOpts(t){t.lowS!==void 0&&abool("lowS",t.lowS),t.prehash!==void 0&&abool("prehash",t.prehash)}function validatePointOpts(t){const e=validateBasic(t);validateObject(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=e;if(n){if(!r.eql(s,r.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:b2n,hexToBytes:h2b}=ut;class DERErr extends Error{constructor(e=""){super(e)}}const DER={Err:DERErr,_tlv:{encode:(t,e)=>{const{Err:n}=DER;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length&1)throw new n("tlv.encode: unpadded data");const r=e.length/2,s=numberToHexUnpadded(r);if(s.length/2&128)throw new n("tlv.encode: long form length too big");const o=r>127?numberToHexUnpadded(s.length/2|128):"";return numberToHexUnpadded(t)+o+s+e},decode(t,e){const{Err:n}=DER;let r=0;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length<2||e[r++]!==t)throw new n("tlv.decode: wrong tlv");const s=e[r++],o=!!(s&128);let a=0;if(!o)a=s;else{const u=s&127;if(!u)throw new n("tlv.decode(long): indefinite length not supported");if(u>4)throw new n("tlv.decode(long): byte length is too big");const p=e.subarray(r,r+u);if(p.length!==u)throw new n("tlv.decode: length bytes not complete");if(p[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(const y of p)a=a<<8|y;if(r+=u,a<128)throw new n("tlv.decode(long): not minimal encoding")}const l=e.subarray(r,r+a);if(l.length!==a)throw new n("tlv.decode: wrong value length");return{v:l,l:e.subarray(r+a)}}},_int:{encode(t){const{Err:e}=DER;if(t<_0n$1)throw new e("integer: negative integers are not allowed");let n=numberToHexUnpadded(t);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return n},decode(t){const{Err:e}=DER;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return b2n(t)}},toSig(t){const{Err:e,_int:n,_tlv:r}=DER,s=typeof t=="string"?h2b(t):t;abytes(s);const{v:o,l:a}=r.decode(48,s);if(a.length)throw new e("invalid signature: left bytes after parsing");const{v:l,l:u}=r.decode(2,o),{v:p,l:y}=r.decode(2,u);if(y.length)throw new e("invalid signature: left bytes after parsing");return{r:n.decode(l),s:n.decode(p)}},hexFromSig(t){const{_tlv:e,_int:n}=DER,r=e.encode(2,n.encode(t.r)),s=e.encode(2,n.encode(t.s)),o=r+s;return e.encode(48,o)}},_0n$1=BigInt(0),_1n$1=BigInt(1);BigInt(2);const _3n=BigInt(3);BigInt(4);function weierstrassPoints(t){const e=validatePointOpts(t),{Fp:n}=e,r=Field(e.n,e.nBitLength),s=e.toBytes||((T,k,B)=>{const G=k.toAffine();return concatBytes(Uint8Array.from([4]),n.toBytes(G.x),n.toBytes(G.y))}),o=e.fromBytes||(T=>{const k=T.subarray(1),B=n.fromBytes(k.subarray(0,n.BYTES)),G=n.fromBytes(k.subarray(n.BYTES,2*n.BYTES));return{x:B,y:G}});function a(T){const{a:k,b:B}=e,G=n.sqr(T),z=n.mul(G,T);return n.add(n.add(z,n.mul(T,k)),B)}if(!n.eql(n.sqr(e.Gy),a(e.Gx)))throw new Error("bad generator point: equation left != right");function l(T){return inRange(T,_1n$1,e.n)}function u(T){const{allowedPrivateKeyLengths:k,nByteLength:B,wrapPrivateKey:G,n:z}=e;if(k&&typeof T!="bigint"){if(isBytes$1(T)&&(T=bytesToHex$1(T)),typeof T!="string"||!k.includes(T.length))throw new Error("invalid private key");T=T.padStart(B*2,"0")}let Q;try{Q=typeof T=="bigint"?T:bytesToNumberBE(ensureBytes("private key",T,B))}catch{throw new Error("invalid private key, expected hex or "+B+" bytes, got "+typeof T)}return G&&(Q=mod(Q,z)),aInRange("private key",Q,_1n$1,z),Q}function p(T){if(!(T instanceof w))throw new Error("ProjectivePoint expected")}const y=memoized((T,k)=>{const{px:B,py:G,pz:z}=T;if(n.eql(z,n.ONE))return{x:B,y:G};const Q=T.is0();k==null&&(k=Q?n.ONE:n.inv(z));const ye=n.mul(B,k),ie=n.mul(G,k),te=n.mul(z,k);if(Q)return{x:n.ZERO,y:n.ZERO};if(!n.eql(te,n.ONE))throw new Error("invZ was invalid");return{x:ye,y:ie}}),b=memoized(T=>{if(T.is0()){if(e.allowInfinityPoint&&!n.is0(T.py))return;throw new Error("bad point: ZERO")}const{x:k,y:B}=T.toAffine();if(!n.isValid(k)||!n.isValid(B))throw new Error("bad point: x or y not FE");const G=n.sqr(B),z=a(k);if(!n.eql(G,z))throw new Error("bad point: equation left != right");if(!T.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class w{constructor(k,B,G){if(this.px=k,this.py=B,this.pz=G,k==null||!n.isValid(k))throw new Error("x required");if(B==null||!n.isValid(B))throw new Error("y required");if(G==null||!n.isValid(G))throw new Error("z required");Object.freeze(this)}static fromAffine(k){const{x:B,y:G}=k||{};if(!k||!n.isValid(B)||!n.isValid(G))throw new Error("invalid affine point");if(k instanceof w)throw new Error("projective point not allowed");const z=Q=>n.eql(Q,n.ZERO);return z(B)&&z(G)?w.ZERO:new w(B,G,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(k){const B=n.invertBatch(k.map(G=>G.pz));return k.map((G,z)=>G.toAffine(B[z])).map(w.fromAffine)}static fromHex(k){const B=w.fromAffine(o(ensureBytes("pointHex",k)));return B.assertValidity(),B}static fromPrivateKey(k){return w.BASE.multiply(u(k))}static msm(k,B){return pippenger(w,r,k,B)}_setWindowSize(k){x.setWindowSize(this,k)}assertValidity(){b(this)}hasEvenY(){const{y:k}=this.toAffine();if(n.isOdd)return!n.isOdd(k);throw new Error("Field doesn't support isOdd")}equals(k){p(k);const{px:B,py:G,pz:z}=this,{px:Q,py:ye,pz:ie}=k,te=n.eql(n.mul(B,ie),n.mul(Q,z)),oe=n.eql(n.mul(G,ie),n.mul(ye,z));return te&&oe}negate(){return new w(this.px,n.neg(this.py),this.pz)}double(){const{a:k,b:B}=e,G=n.mul(B,_3n),{px:z,py:Q,pz:ye}=this;let ie=n.ZERO,te=n.ZERO,oe=n.ZERO,ne=n.mul(z,z),me=n.mul(Q,Q),O=n.mul(ye,ye),F=n.mul(z,Q);return F=n.add(F,F),oe=n.mul(z,ye),oe=n.add(oe,oe),ie=n.mul(k,oe),te=n.mul(G,O),te=n.add(ie,te),ie=n.sub(me,te),te=n.add(me,te),te=n.mul(ie,te),ie=n.mul(F,ie),oe=n.mul(G,oe),O=n.mul(k,O),F=n.sub(ne,O),F=n.mul(k,F),F=n.add(F,oe),oe=n.add(ne,ne),ne=n.add(oe,ne),ne=n.add(ne,O),ne=n.mul(ne,F),te=n.add(te,ne),O=n.mul(Q,ye),O=n.add(O,O),ne=n.mul(O,F),ie=n.sub(ie,ne),oe=n.mul(O,me),oe=n.add(oe,oe),oe=n.add(oe,oe),new w(ie,te,oe)}add(k){p(k);const{px:B,py:G,pz:z}=this,{px:Q,py:ye,pz:ie}=k;let te=n.ZERO,oe=n.ZERO,ne=n.ZERO;const me=e.a,O=n.mul(e.b,_3n);let F=n.mul(B,Q),j=n.mul(G,ye),H=n.mul(z,ie),V=n.add(B,G),W=n.add(Q,ye);V=n.mul(V,W),W=n.add(F,j),V=n.sub(V,W),W=n.add(B,z);let Z=n.add(Q,ie);return W=n.mul(W,Z),Z=n.add(F,H),W=n.sub(W,Z),Z=n.add(G,z),te=n.add(ye,ie),Z=n.mul(Z,te),te=n.add(j,H),Z=n.sub(Z,te),ne=n.mul(me,W),te=n.mul(O,H),ne=n.add(te,ne),te=n.sub(j,ne),ne=n.add(j,ne),oe=n.mul(te,ne),j=n.add(F,F),j=n.add(j,F),H=n.mul(me,H),W=n.mul(O,W),j=n.add(j,H),H=n.sub(F,H),H=n.mul(me,H),W=n.add(W,H),F=n.mul(j,W),oe=n.add(oe,F),F=n.mul(Z,W),te=n.mul(V,te),te=n.sub(te,F),F=n.mul(V,j),ne=n.mul(Z,ne),ne=n.add(ne,F),new w(te,oe,ne)}subtract(k){return this.add(k.negate())}is0(){return this.equals(w.ZERO)}wNAF(k){return x.wNAFCached(this,k,w.normalizeZ)}multiplyUnsafe(k){const{endo:B,n:G}=e;aInRange("scalar",k,_0n$1,G);const z=w.ZERO;if(k===_0n$1)return z;if(this.is0()||k===_1n$1)return this;if(!B||x.hasPrecomputes(this))return x.wNAFCachedUnsafe(this,k,w.normalizeZ);let{k1neg:Q,k1:ye,k2neg:ie,k2:te}=B.splitScalar(k),oe=z,ne=z,me=this;for(;ye>_0n$1||te>_0n$1;)ye&_1n$1&&(oe=oe.add(me)),te&_1n$1&&(ne=ne.add(me)),me=me.double(),ye>>=_1n$1,te>>=_1n$1;return Q&&(oe=oe.negate()),ie&&(ne=ne.negate()),ne=new w(n.mul(ne.px,B.beta),ne.py,ne.pz),oe.add(ne)}multiply(k){const{endo:B,n:G}=e;aInRange("scalar",k,_1n$1,G);let z,Q;if(B){const{k1neg:ye,k1:ie,k2neg:te,k2:oe}=B.splitScalar(k);let{p:ne,f:me}=this.wNAF(ie),{p:O,f:F}=this.wNAF(oe);ne=x.constTimeNegate(ye,ne),O=x.constTimeNegate(te,O),O=new w(n.mul(O.px,B.beta),O.py,O.pz),z=ne.add(O),Q=me.add(F)}else{const{p:ye,f:ie}=this.wNAF(k);z=ye,Q=ie}return w.normalizeZ([z,Q])[0]}multiplyAndAddUnsafe(k,B,G){const z=w.BASE,Q=(ie,te)=>te===_0n$1||te===_1n$1||!ie.equals(z)?ie.multiplyUnsafe(te):ie.multiply(te),ye=Q(this,B).add(Q(k,G));return ye.is0()?void 0:ye}toAffine(k){return y(this,k)}isTorsionFree(){const{h:k,isTorsionFree:B}=e;if(k===_1n$1)return!0;if(B)return B(w,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:k,clearCofactor:B}=e;return k===_1n$1?this:B?B(w,this):this.multiplyUnsafe(e.h)}toRawBytes(k=!0){return abool("isCompressed",k),this.assertValidity(),s(w,this,k)}toHex(k=!0){return abool("isCompressed",k),bytesToHex$1(this.toRawBytes(k))}}w.BASE=new w(e.Gx,e.Gy,n.ONE),w.ZERO=new w(n.ZERO,n.ONE,n.ZERO);const _=e.nBitLength,x=wNAF(w,e.endo?Math.ceil(_/2):_);return{CURVE:e,ProjectivePoint:w,normPrivateKeyToScalar:u,weierstrassEquation:a,isWithinCurveOrder:l}}function validateOpts(t){const e=validateBasic(t);return validateObject(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function weierstrass(t){const e=validateOpts(t),{Fp:n,n:r}=e,s=n.BYTES+1,o=2*n.BYTES+1;function a(H){return mod(H,r)}function l(H){return invert(H,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:p,weierstrassEquation:y,isWithinCurveOrder:b}=weierstrassPoints({...e,toBytes(H,V,W){const Z=V.toAffine(),ae=n.toBytes(Z.x),A=concatBytes;return abool("isCompressed",W),W?A(Uint8Array.from([V.hasEvenY()?2:3]),ae):A(Uint8Array.from([4]),ae,n.toBytes(Z.y))},fromBytes(H){const V=H.length,W=H[0],Z=H.subarray(1);if(V===s&&(W===2||W===3)){const ae=bytesToNumberBE(Z);if(!inRange(ae,_1n$1,n.ORDER))throw new Error("Point is not on curve");const A=y(ae);let J;try{J=n.sqrt(A)}catch(ve){const we=ve instanceof Error?": "+ve.message:"";throw new Error("Point is not on curve"+we)}const X=(J&_1n$1)===_1n$1;return(W&1)===1!==X&&(J=n.neg(J)),{x:ae,y:J}}else if(V===o&&W===4){const ae=n.fromBytes(Z.subarray(0,n.BYTES)),A=n.fromBytes(Z.subarray(n.BYTES,2*n.BYTES));return{x:ae,y:A}}else{const ae=s,A=o;throw new Error("invalid Point, expected length of "+ae+", or uncompressed "+A+", got "+V)}}}),w=H=>bytesToHex$1(numberToBytesBE(H,e.nByteLength));function _(H){const V=r>>_1n$1;return H>V}function x(H){return _(H)?a(-H):H}const T=(H,V,W)=>bytesToNumberBE(H.slice(V,W));class k{constructor(V,W,Z){this.r=V,this.s=W,this.recovery=Z,this.assertValidity()}static fromCompact(V){const W=e.nByteLength;return V=ensureBytes("compactSignature",V,W*2),new k(T(V,0,W),T(V,W,2*W))}static fromDER(V){const{r:W,s:Z}=DER.toSig(ensureBytes("DER",V));return new k(W,Z)}assertValidity(){aInRange("r",this.r,_1n$1,r),aInRange("s",this.s,_1n$1,r)}addRecoveryBit(V){return new k(this.r,this.s,V)}recoverPublicKey(V){const{r:W,s:Z,recovery:ae}=this,A=ie(ensureBytes("msgHash",V));if(ae==null||![0,1,2,3].includes(ae))throw new Error("recovery id invalid");const J=ae===2||ae===3?W+e.n:W;if(J>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const X=ae&1?"03":"02",de=u.fromHex(X+w(J)),ve=l(J),we=a(-A*ve),Ce=a(Z*ve),Re=u.BASE.multiplyAndAddUnsafe(de,we,Ce);if(!Re)throw new Error("point at infinify");return Re.assertValidity(),Re}hasHighS(){return _(this.s)}normalizeS(){return this.hasHighS()?new k(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes$1(this.toDERHex())}toDERHex(){return DER.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes$1(this.toCompactHex())}toCompactHex(){return w(this.r)+w(this.s)}}const B={isValidPrivateKey(H){try{return p(H),!0}catch{return!1}},normPrivateKeyToScalar:p,randomPrivateKey:()=>{const H=getMinHashLength(e.n);return mapHashToField(e.randomBytes(H),e.n)},precompute(H=8,V=u.BASE){return V._setWindowSize(H),V.multiply(BigInt(3)),V}};function G(H,V=!0){return u.fromPrivateKey(H).toRawBytes(V)}function z(H){const V=isBytes$1(H),W=typeof H=="string",Z=(V||W)&&H.length;return V?Z===s||Z===o:W?Z===2*s||Z===2*o:H instanceof u}function Q(H,V,W=!0){if(z(H))throw new Error("first arg must be private key");if(!z(V))throw new Error("second arg must be public key");return u.fromHex(V).multiply(p(H)).toRawBytes(W)}const ye=e.bits2int||function(H){if(H.length>8192)throw new Error("input is too large");const V=bytesToNumberBE(H),W=H.length*8-e.nBitLength;return W>0?V>>BigInt(W):V},ie=e.bits2int_modN||function(H){return a(ye(H))},te=bitMask(e.nBitLength);function oe(H){return aInRange("num < 2^"+e.nBitLength,H,_0n$1,te),numberToBytesBE(H,e.nByteLength)}function ne(H,V,W=me){if(["recovered","canonical"].some(Ke=>Ke in W))throw new Error("sign() legacy options not supported");const{hash:Z,randomBytes:ae}=e;let{lowS:A,prehash:J,extraEntropy:X}=W;A==null&&(A=!0),H=ensureBytes("msgHash",H),validateSigVerOpts(W),J&&(H=ensureBytes("prehashed msgHash",Z(H)));const de=ie(H),ve=p(V),we=[oe(ve),oe(de)];if(X!=null&&X!==!1){const Ke=X===!0?ae(n.BYTES):X;we.push(ensureBytes("extraEntropy",Ke))}const Ce=concatBytes(...we),Re=de;function De(Ke){const pe=ye(Ke);if(!b(pe))return;const wt=l(pe),We=u.BASE.multiply(pe).toAffine(),xe=a(We.x);if(xe===_0n$1)return;const je=a(wt*a(Re+xe*ve));if(je===_0n$1)return;let Qe=(We.x===xe?0:2)|Number(We.y&_1n$1),qe=je;return A&&_(je)&&(qe=x(je),Qe^=1),new k(xe,qe,Qe)}return{seed:Ce,k2sig:De}}const me={lowS:e.lowS,prehash:!1},O={lowS:e.lowS,prehash:!1};function F(H,V,W=me){const{seed:Z,k2sig:ae}=ne(H,V,W),A=e;return createHmacDrbg(A.hash.outputLen,A.nByteLength,A.hmac)(Z,ae)}u.BASE._setWindowSize(8);function j(H,V,W,Z=O){const ae=H;V=ensureBytes("msgHash",V),W=ensureBytes("publicKey",W);const{lowS:A,prehash:J,format:X}=Z;if(validateSigVerOpts(Z),"strict"in Z)throw new Error("options.strict was renamed to lowS");if(X!==void 0&&X!=="compact"&&X!=="der")throw new Error("format must be compact or der");const de=typeof ae=="string"||isBytes$1(ae),ve=!de&&!X&&typeof ae=="object"&&ae!==null&&typeof ae.r=="bigint"&&typeof ae.s=="bigint";if(!de&&!ve)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let we,Ce;try{if(ve&&(we=new k(ae.r,ae.s)),de){try{X!=="compact"&&(we=k.fromDER(ae))}catch(Qe){if(!(Qe instanceof DER.Err))throw Qe}!we&&X!=="der"&&(we=k.fromCompact(ae))}Ce=u.fromHex(W)}catch{return!1}if(!we||A&&we.hasHighS())return!1;J&&(V=e.hash(V));const{r:Re,s:De}=we,Ke=ie(V),pe=l(De),wt=a(Ke*pe),We=a(Re*pe),xe=u.BASE.multiplyAndAddUnsafe(Ce,wt,We)?.toAffine();return xe?a(xe.x)===Re:!1}return{CURVE:e,getPublicKey:G,getSharedSecret:Q,sign:F,verify:j,ProjectivePoint:u,Signature:k,utils:B}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash(t){return{hash:t,hmac:(e,...n)=>hmac.hmac(t,e,utils.concatBytes(...n)),randomBytes:utils.randomBytes}}function createCurve(t,e){const n=r=>weierstrass({...t,...getHash(r)});return{...n(e),create:n}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n=BigInt(1),_2n=BigInt(2),divNearest=(t,e)=>(t+e/_2n)/e;function sqrtMod(t){const e=secp256k1P,n=BigInt(3),r=BigInt(6),s=BigInt(11),o=BigInt(22),a=BigInt(23),l=BigInt(44),u=BigInt(88),p=t*t*t%e,y=p*p*t%e,b=pow2(y,n,e)*y%e,w=pow2(b,n,e)*y%e,_=pow2(w,_2n,e)*p%e,x=pow2(_,s,e)*_%e,T=pow2(x,o,e)*x%e,k=pow2(T,l,e)*T%e,B=pow2(k,u,e)*k%e,G=pow2(B,l,e)*T%e,z=pow2(G,n,e)*y%e,Q=pow2(z,a,e)*x%e,ye=pow2(Q,r,e)*p%e,ie=pow2(ye,_2n,e);if(!Fpk1.eql(Fpk1.sqr(ie),t))throw new Error("Cannot find square root");return ie}const Fpk1=Field(secp256k1P,void 0,void 0,{sqrt:sqrtMod}),secp256k1=createCurve({a:BigInt(0),b:BigInt(7),Fp:Fpk1,n:secp256k1N,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=secp256k1N,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_1n*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=n,a=BigInt("0x100000000000000000000000000000000"),l=divNearest(o*t,e),u=divNearest(-r*t,e);let p=mod(t-l*n-u*s,e),y=mod(-l*r-u*o,e);const b=p>a,w=y>a;if(b&&(p=e-p),w&&(y=e-y),p>a||y>a)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:b,k1:p,k2neg:w,k2:y}}}},sha256_1),_0n=BigInt(0),TAGGED_HASH_PREFIXES={};function taggedHash(t,...e){let n=TAGGED_HASH_PREFIXES[t];if(n===void 0){const r=sha256_1(Uint8Array.from(t,s=>s.charCodeAt(0)));n=concatBytes(r,r),TAGGED_HASH_PREFIXES[t]=n}return sha256_1(concatBytes(n,...e))}const pointToBytes=t=>t.toRawBytes(!0).slice(1),numTo32b=t=>numberToBytesBE(t,32),modP=t=>mod(t,secp256k1P),modN=t=>mod(t,secp256k1N),Point=secp256k1.ProjectivePoint,GmulAdd=(t,e,n)=>Point.BASE.multiplyAndAddUnsafe(t,e,n);function schnorrGetExtPubKey(t){let e=secp256k1.utils.normPrivateKeyToScalar(t),n=Point.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:modN(-e),bytes:pointToBytes(n)}}function lift_x(t){aInRange("x",t,_1n,secp256k1P);const e=modP(t*t),n=modP(e*t+BigInt(7));let r=sqrtMod(n);r%_2n!==_0n&&(r=modP(-r));const s=new Point(t,r,_1n);return s.assertValidity(),s}const num=bytesToNumberBE;function challenge(...t){return modN(num(taggedHash("BIP0340/challenge",...t)))}function schnorrGetPublicKey(t){return schnorrGetExtPubKey(t).bytes}function schnorrSign(t,e,n=utils.randomBytes(32)){const r=ensureBytes("message",t),{bytes:s,scalar:o}=schnorrGetExtPubKey(e),a=ensureBytes("auxRand",n,32),l=numTo32b(o^num(taggedHash("BIP0340/aux",a))),u=taggedHash("BIP0340/nonce",l,s,r),p=modN(num(u));if(p===_0n)throw new Error("sign failed: k is zero");const{bytes:y,scalar:b}=schnorrGetExtPubKey(p),w=challenge(y,s,r),_=new Uint8Array(64);if(_.set(y,0),_.set(numTo32b(modN(b+w*o)),32),!schnorrVerify(_,r,s))throw new Error("sign: Invalid signature produced");return _}function schnorrVerify(t,e,n){const r=ensureBytes("signature",t,64),s=ensureBytes("message",e),o=ensureBytes("publicKey",n,32);try{const a=lift_x(num(o)),l=num(r.subarray(0,32));if(!inRange(l,_1n,secp256k1P))return!1;const u=num(r.subarray(32,64));if(!inRange(u,_1n,secp256k1N))return!1;const p=challenge(numTo32b(l),pointToBytes(a),s),y=GmulAdd(a,u,modN(-p));return!(!y||!y.hasEvenY()||y.toAffine().x!==l)}catch{return!1}}const schnorr={getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,utils:{randomPrivateKey:secp256k1.utils.randomPrivateKey,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,taggedHash,mod}};/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function assertNumber(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function chain(...t){const e=(s,o)=>a=>s(o(a)),n=Array.from(t).reverse().reduce((s,o)=>s?e(s,o.encode):o.encode,void 0),r=t.reduce((s,o)=>s?e(s,o.decode):o.decode,void 0);return{encode:n,decode:r}}function alphabet(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(n=>{if(assertNumber(n),n<0||n>=t.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${t.length})`);return t[n]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const r=t.indexOf(n);if(r===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${t}`);return r})}}}function join(t=""){if(typeof t!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of e)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return e.join(t)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(t)}}}function padding(t,e="="){if(assertNumber(t),typeof e!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let r of n)if(typeof r!="string")throw new Error(`padding.encode: non-string input=${r}`);for(;n.length*t%8;)n.push(e);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let s of n)if(typeof s!="string")throw new Error(`padding.decode: non-string input=${s}`);let r=n.length;if(r*t%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;r>0&&n[r-1]===e;r--)if(!((r-1)*t%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,r)}}}function normalize$1(t){if(typeof t!="function")throw new Error("normalize fn should be function");return{encode:e=>e,decode:e=>t(e)}}function convertRadix(t,e,n){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(t))throw new Error("convertRadix: data should be array");if(!t.length)return[];let r=0;const s=[],o=Array.from(t);for(o.forEach(a=>{if(assertNumber(a),a<0||a>=e)throw new Error(`Wrong integer: ${a}`)});;){let a=0,l=!0;for(let u=r;u<o.length;u++){const p=o[u],y=e*a+p;if(!Number.isSafeInteger(y)||e*a/e!==a||y-p!==e*a)throw new Error("convertRadix: carry overflow");if(a=y%n,o[u]=Math.floor(y/n),!Number.isSafeInteger(o[u])||o[u]*n+a!==y)throw new Error("convertRadix: carry overflow");if(l)o[u]?l=!1:r=u;else continue}if(s.push(a),l)break}for(let a=0;a<t.length-1&&t[a]===0;a++)s.push(0);return s.reverse()}const gcd=(t,e)=>e?gcd(e,t%e):t,radix2carry=(t,e)=>t+(e-gcd(t,e));function convertRadix2(t,e,n,r){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(radix2carry(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${radix2carry(e,n)}`);let s=0,o=0;const a=2**n-1,l=[];for(const u of t){if(assertNumber(u),u>=2**e)throw new Error(`convertRadix2: invalid data word=${u} from=${e}`);if(s=s<<e|u,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=n;o-=n)l.push((s>>o-n&a)>>>0);s&=2**o-1}if(s=s<<n-o&a,!r&&o>=e)throw new Error("Excess padding");if(!r&&s)throw new Error(`Non-zero padding: ${s}`);return r&&o>0&&l.push(s>>>0),l}function radix(t){return assertNumber(t),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return convertRadix(Array.from(e),2**8,t)},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(convertRadix(e,t,2**8))}}}function radix2(t,e=!1){if(assertNumber(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(radix2carry(8,t)>32||radix2carry(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return convertRadix2(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(convertRadix2(n,t,8,e))}}}function unsafeWrapper(t){if(typeof t!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch{}}}const base16=chain(radix2(4),alphabet("0123456789ABCDEF"),join("")),base32=chain(radix2(5),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),padding(5),join(""));chain(radix2(5),alphabet("0123456789ABCDEFGHIJKLMNOPQRSTUV"),padding(5),join(""));chain(radix2(5),alphabet("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),join(""),normalize$1(t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const base64=chain(radix2(6),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),padding(6),join("")),base64url=chain(radix2(6),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),padding(6),join("")),genBase58=t=>chain(radix(58),alphabet(t),join("")),base58=genBase58("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");genBase58("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");genBase58("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const XMR_BLOCK_LEN=[0,2,3,5,6,7,9,10,11],base58xmr={encode(t){let e="";for(let n=0;n<t.length;n+=8){const r=t.subarray(n,n+8);e+=base58.encode(r).padStart(XMR_BLOCK_LEN[r.length],"1")}return e},decode(t){let e=[];for(let n=0;n<t.length;n+=11){const r=t.slice(n,n+11),s=XMR_BLOCK_LEN.indexOf(r.length),o=base58.decode(r);for(let a=0;a<o.length-s;a++)if(o[a]!==0)throw new Error("base58xmr: wrong padding");e=e.concat(Array.from(o.slice(o.length-s)))}return Uint8Array.from(e)}},BECH_ALPHABET=chain(alphabet("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),join("")),POLYMOD_GENERATORS=[996825010,642813549,513874426,1027748829,705979059];function bech32Polymod(t){const e=t>>25;let n=(t&33554431)<<5;for(let r=0;r<POLYMOD_GENERATORS.length;r++)(e>>r&1)===1&&(n^=POLYMOD_GENERATORS[r]);return n}function bechChecksum(t,e,n=1){const r=t.length;let s=1;for(let o=0;o<r;o++){const a=t.charCodeAt(o);if(a<33||a>126)throw new Error(`Invalid prefix (${t})`);s=bech32Polymod(s)^a>>5}s=bech32Polymod(s);for(let o=0;o<r;o++)s=bech32Polymod(s)^t.charCodeAt(o)&31;for(let o of e)s=bech32Polymod(s)^o;for(let o=0;o<6;o++)s=bech32Polymod(s);return s^=n,BECH_ALPHABET.encode(convertRadix2([s%2**30],30,5,!1))}function genBech32(t){const e=t==="bech32"?1:734539939,n=radix2(5),r=n.decode,s=n.encode,o=unsafeWrapper(r);function a(y,b,w=90){if(typeof y!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof y}`);if(!Array.isArray(b)||b.length&&typeof b[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof b}`);const _=y.length+7+b.length;if(w!==!1&&_>w)throw new TypeError(`Length ${_} exceeds limit ${w}`);return y=y.toLowerCase(),`${y}1${BECH_ALPHABET.encode(b)}${bechChecksum(y,b,e)}`}function l(y,b=90){if(typeof y!="string")throw new Error(`bech32.decode input should be string, not ${typeof y}`);if(y.length<8||b!==!1&&y.length>b)throw new TypeError(`Wrong string length: ${y.length} (${y}). Expected (8..${b})`);const w=y.toLowerCase();if(y!==w&&y!==y.toUpperCase())throw new Error("String must be lowercase or uppercase");y=w;const _=y.lastIndexOf("1");if(_===0||_===-1)throw new Error('Letter "1" must be present between prefix and data only');const x=y.slice(0,_),T=y.slice(_+1);if(T.length<6)throw new Error("Data must be at least 6 characters long");const k=BECH_ALPHABET.decode(T).slice(0,-6),B=bechChecksum(x,k,e);if(!T.endsWith(B))throw new Error(`Invalid checksum in ${y}: expected "${B}"`);return{prefix:x,words:k}}const u=unsafeWrapper(l);function p(y){const{prefix:b,words:w}=l(y,!1);return{prefix:b,words:w,bytes:r(w)}}return{encode:a,decode:l,decodeToBytes:p,decodeUnsafe:u,fromWords:r,fromWordsUnsafe:o,toWords:s}}const bech32$1=genBech32("bech32");genBech32("bech32m");const utf8$1={encode:t=>new TextDecoder().decode(t),decode:t=>new TextEncoder().encode(t)},hex$1=chain(radix2(4),alphabet("0123456789abcdef"),join(""),normalize$1(t=>{if(typeof t!="string"||t.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()})),CODERS={utf8:utf8$1,hex:hex$1,base16,base32,base64,base64url,base58,base58xmr};`${Object.keys(CODERS).join(", ")}`;function number(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function bool(t){if(typeof t!="boolean")throw new Error(`boolean expected, not ${t}`)}function isBytes(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function bytes(t,...e){if(!isBytes(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}function exists(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output(t,e){bytes(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const u32=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),createView=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE)throw new Error("Non little-endian hardware is not supported");const hexes=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex(t){bytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes[t[n]];return e}const asciis={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16(t){if(t>=asciis._0&&t<=asciis._9)return t-asciis._0;if(t>=asciis._A&&t<=asciis._F)return t-(asciis._A-10);if(t>=asciis._a&&t<=asciis._f)return t-(asciis._a-10)}function hexToBytes(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let s=0,o=0;s<n;s++,o+=2){const a=asciiToBase16(t.charCodeAt(o)),l=asciiToBase16(t.charCodeAt(o+1));if(a===void 0||l===void 0){const u=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+u+'" at index '+o)}r[s]=a*16+l}return r}function utf8ToBytes(t){if(typeof t!="string")throw new Error(`string expected, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes(t){if(typeof t=="string")t=utf8ToBytes(t);else if(isBytes(t))t=t.slice();else throw new Error(`Uint8Array expected, got ${typeof t}`);return t}function checkOpts(t,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(t,e)}function equalBytes(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}const wrapCipher=(t,e)=>(Object.assign(e,t),e);function setBigUint64(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const s=BigInt(32),o=BigInt(4294967295),a=Number(n>>s&o),l=Number(n&o),u=4,p=0;t.setUint32(e+u,a,r),t.setUint32(e+p,l,r)}const BLOCK_SIZE=16,POLY=283;function mul2(t){return t<<1^POLY&-(t>>7)}function mul(t,e){let n=0;for(;e>0;e>>=1)n^=t&-(e&1),t=mul2(t);return n}const sbox=(()=>{let t=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=mul2(r))t[n]=r;const e=new Uint8Array(256);e[0]=99;for(let n=0;n<255;n++){let r=t[255-n];r|=r<<8,e[t[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return e})(),invSbox=sbox.map((t,e)=>sbox.indexOf(e)),rotr32_8=t=>t<<24|t>>>8,rotl32_8=t=>t<<8|t>>>24;function genTtable(t,e){if(t.length!==256)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map((p,y)=>e(t[y])),r=n.map(rotl32_8),s=r.map(rotl32_8),o=s.map(rotl32_8),a=new Uint32Array(256*256),l=new Uint32Array(256*256),u=new Uint16Array(256*256);for(let p=0;p<256;p++)for(let y=0;y<256;y++){const b=p*256+y;a[b]=n[p]^r[y],l[b]=s[p]^o[y],u[b]=t[p]<<8|t[y]}return{sbox:t,sbox2:u,T0:n,T1:r,T2:s,T3:o,T01:a,T23:l}}const tableEncoding=genTtable(sbox,t=>mul(t,3)<<24|t<<16|t<<8|mul(t,2)),tableDecoding=genTtable(invSbox,t=>mul(t,11)<<24|mul(t,13)<<16|mul(t,9)<<8|mul(t,14)),xPowers=(()=>{const t=new Uint8Array(16);for(let e=0,n=1;e<16;e++,n=mul2(n))t[e]=n;return t})();function expandKeyLE(t){bytes(t);const e=t.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:n}=tableEncoding,r=u32(t),s=r.length,o=l=>applySbox(n,l,l,l,l),a=new Uint32Array(e+28);a.set(r);for(let l=s;l<a.length;l++){let u=a[l-1];l%s===0?u=o(rotr32_8(u))^xPowers[l/s-1]:s>6&&l%s===4&&(u=o(u)),a[l]=a[l-s]^u}return a}function expandKeyDecLE(t){const e=expandKeyLE(t),n=e.slice(),r=e.length,{sbox2:s}=tableEncoding,{T0:o,T1:a,T2:l,T3:u}=tableDecoding;for(let p=0;p<r;p+=4)for(let y=0;y<4;y++)n[p+y]=e[r-p-4+y];e.fill(0);for(let p=4;p<r-4;p++){const y=n[p],b=applySbox(s,y,y,y,y);n[p]=o[b&255]^a[b>>>8&255]^l[b>>>16&255]^u[b>>>24]}return n}function apply0123(t,e,n,r,s,o){return t[n<<8&65280|r>>>8&255]^e[s>>>8&65280|o>>>24&255]}function applySbox(t,e,n,r,s){return t[e&255|n&65280]|t[r>>>16&255|s>>>16&65280]<<16}function encrypt$4(t,e,n,r,s){const{sbox2:o,T01:a,T23:l}=tableEncoding;let u=0;e^=t[u++],n^=t[u++],r^=t[u++],s^=t[u++];const p=t.length/4-2;for(let x=0;x<p;x++){const T=t[u++]^apply0123(a,l,e,n,r,s),k=t[u++]^apply0123(a,l,n,r,s,e),B=t[u++]^apply0123(a,l,r,s,e,n),G=t[u++]^apply0123(a,l,s,e,n,r);e=T,n=k,r=B,s=G}const y=t[u++]^applySbox(o,e,n,r,s),b=t[u++]^applySbox(o,n,r,s,e),w=t[u++]^applySbox(o,r,s,e,n),_=t[u++]^applySbox(o,s,e,n,r);return{s0:y,s1:b,s2:w,s3:_}}function decrypt$4(t,e,n,r,s){const{sbox2:o,T01:a,T23:l}=tableDecoding;let u=0;e^=t[u++],n^=t[u++],r^=t[u++],s^=t[u++];const p=t.length/4-2;for(let x=0;x<p;x++){const T=t[u++]^apply0123(a,l,e,s,r,n),k=t[u++]^apply0123(a,l,n,e,s,r),B=t[u++]^apply0123(a,l,r,n,e,s),G=t[u++]^apply0123(a,l,s,r,n,e);e=T,n=k,r=B,s=G}const y=t[u++]^applySbox(o,e,s,r,n),b=t[u++]^applySbox(o,n,e,s,r),w=t[u++]^applySbox(o,r,n,e,s),_=t[u++]^applySbox(o,s,r,n,e);return{s0:y,s1:b,s2:w,s3:_}}function getDst(t,e){if(!e)return new Uint8Array(t);if(bytes(e),e.length<t)throw new Error(`aes: wrong destination length, expected at least ${t}, got: ${e.length}`);return e}function validateBlockDecrypt(t){if(bytes(t),t.length%BLOCK_SIZE!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${BLOCK_SIZE}`)}function validateBlockEncrypt(t,e,n){let r=t.length;const s=r%BLOCK_SIZE;if(!e&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const o=u32(t);if(e){let u=BLOCK_SIZE-s;u||(u=BLOCK_SIZE),r=r+u}const a=getDst(r,n),l=u32(a);return{b:o,o:l,out:a}}function validatePCKS(t,e){if(!e)return t;const n=t.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const r=t[n-1];if(r<=0||r>16)throw new Error(`aes/pcks5: wrong padding byte: ${r}`);const s=t.subarray(0,-r);for(let o=0;o<r;o++)if(t[n-o-1]!==r)throw new Error("aes/pcks5: wrong padding");return s}function padPCKS(t){const e=new Uint8Array(16),n=u32(e);e.set(t);const r=BLOCK_SIZE-t.length;for(let s=BLOCK_SIZE-r;s<BLOCK_SIZE;s++)e[s]=r;return n}const cbc=wrapCipher({blockSize:16,nonceLength:16},function t(e,n,r={}){bytes(e),bytes(n,16);const s=!r.disablePadding;return{encrypt:(o,a)=>{const l=expandKeyLE(e),{b:u,o:p,out:y}=validateBlockEncrypt(o,s,a),b=u32(n);let w=b[0],_=b[1],x=b[2],T=b[3],k=0;for(;k+4<=u.length;)w^=u[k+0],_^=u[k+1],x^=u[k+2],T^=u[k+3],{s0:w,s1:_,s2:x,s3:T}=encrypt$4(l,w,_,x,T),p[k++]=w,p[k++]=_,p[k++]=x,p[k++]=T;if(s){const B=padPCKS(o.subarray(k*4));w^=B[0],_^=B[1],x^=B[2],T^=B[3],{s0:w,s1:_,s2:x,s3:T}=encrypt$4(l,w,_,x,T),p[k++]=w,p[k++]=_,p[k++]=x,p[k++]=T}return l.fill(0),y},decrypt:(o,a)=>{validateBlockDecrypt(o);const l=expandKeyDecLE(e),u=u32(n),p=getDst(o.length,a),y=u32(o),b=u32(p);let w=u[0],_=u[1],x=u[2],T=u[3];for(let k=0;k+4<=y.length;){const B=w,G=_,z=x,Q=T;w=y[k+0],_=y[k+1],x=y[k+2],T=y[k+3];const{s0:ye,s1:ie,s2:te,s3:oe}=decrypt$4(l,w,_,x,T);b[k++]=ye^B,b[k++]=ie^G,b[k++]=te^z,b[k++]=oe^Q}return l.fill(0),validatePCKS(p,s)}}}),u8to16=(t,e)=>t[e++]&255|(t[e++]&255)<<8;class Poly1305{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=toBytes(e),bytes(e,32);const n=u8to16(e,0),r=u8to16(e,2),s=u8to16(e,4),o=u8to16(e,6),a=u8to16(e,8),l=u8to16(e,10),u=u8to16(e,12),p=u8to16(e,14);this.r[0]=n&8191,this.r[1]=(n>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|a<<12)&255,this.r[5]=a>>>1&8190,this.r[6]=(a>>>14|l<<2)&8191,this.r[7]=(l>>>11|u<<5)&8065,this.r[8]=(u>>>8|p<<8)&8191,this.r[9]=p>>>5&127;for(let y=0;y<8;y++)this.pad[y]=u8to16(e,16+2*y)}process(e,n,r=!1){const s=r?0:2048,{h:o,r:a}=this,l=a[0],u=a[1],p=a[2],y=a[3],b=a[4],w=a[5],_=a[6],x=a[7],T=a[8],k=a[9],B=u8to16(e,n+0),G=u8to16(e,n+2),z=u8to16(e,n+4),Q=u8to16(e,n+6),ye=u8to16(e,n+8),ie=u8to16(e,n+10),te=u8to16(e,n+12),oe=u8to16(e,n+14);let ne=o[0]+(B&8191),me=o[1]+((B>>>13|G<<3)&8191),O=o[2]+((G>>>10|z<<6)&8191),F=o[3]+((z>>>7|Q<<9)&8191),j=o[4]+((Q>>>4|ye<<12)&8191),H=o[5]+(ye>>>1&8191),V=o[6]+((ye>>>14|ie<<2)&8191),W=o[7]+((ie>>>11|te<<5)&8191),Z=o[8]+((te>>>8|oe<<8)&8191),ae=o[9]+(oe>>>5|s),A=0,J=A+ne*l+me*(5*k)+O*(5*T)+F*(5*x)+j*(5*_);A=J>>>13,J&=8191,J+=H*(5*w)+V*(5*b)+W*(5*y)+Z*(5*p)+ae*(5*u),A+=J>>>13,J&=8191;let X=A+ne*u+me*l+O*(5*k)+F*(5*T)+j*(5*x);A=X>>>13,X&=8191,X+=H*(5*_)+V*(5*w)+W*(5*b)+Z*(5*y)+ae*(5*p),A+=X>>>13,X&=8191;let de=A+ne*p+me*u+O*l+F*(5*k)+j*(5*T);A=de>>>13,de&=8191,de+=H*(5*x)+V*(5*_)+W*(5*w)+Z*(5*b)+ae*(5*y),A+=de>>>13,de&=8191;let ve=A+ne*y+me*p+O*u+F*l+j*(5*k);A=ve>>>13,ve&=8191,ve+=H*(5*T)+V*(5*x)+W*(5*_)+Z*(5*w)+ae*(5*b),A+=ve>>>13,ve&=8191;let we=A+ne*b+me*y+O*p+F*u+j*l;A=we>>>13,we&=8191,we+=H*(5*k)+V*(5*T)+W*(5*x)+Z*(5*_)+ae*(5*w),A+=we>>>13,we&=8191;let Ce=A+ne*w+me*b+O*y+F*p+j*u;A=Ce>>>13,Ce&=8191,Ce+=H*l+V*(5*k)+W*(5*T)+Z*(5*x)+ae*(5*_),A+=Ce>>>13,Ce&=8191;let Re=A+ne*_+me*w+O*b+F*y+j*p;A=Re>>>13,Re&=8191,Re+=H*u+V*l+W*(5*k)+Z*(5*T)+ae*(5*x),A+=Re>>>13,Re&=8191;let De=A+ne*x+me*_+O*w+F*b+j*y;A=De>>>13,De&=8191,De+=H*p+V*u+W*l+Z*(5*k)+ae*(5*T),A+=De>>>13,De&=8191;let Ke=A+ne*T+me*x+O*_+F*w+j*b;A=Ke>>>13,Ke&=8191,Ke+=H*y+V*p+W*u+Z*l+ae*(5*k),A+=Ke>>>13,Ke&=8191;let pe=A+ne*k+me*T+O*x+F*_+j*w;A=pe>>>13,pe&=8191,pe+=H*b+V*y+W*p+Z*u+ae*l,A+=pe>>>13,pe&=8191,A=(A<<2)+A|0,A=A+J|0,J=A&8191,A=A>>>13,X+=A,o[0]=J,o[1]=X,o[2]=de,o[3]=ve,o[4]=we,o[5]=Ce,o[6]=Re,o[7]=De,o[8]=Ke,o[9]=pe}finalize(){const{h:e,pad:n}=this,r=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let l=2;l<10;l++)e[l]+=s,s=e[l]>>>13,e[l]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,r[0]=e[0]+5,s=r[0]>>>13,r[0]&=8191;for(let l=1;l<10;l++)r[l]=e[l]+s,s=r[l]>>>13,r[l]&=8191;r[9]-=8192;let o=(s^1)-1;for(let l=0;l<10;l++)r[l]&=o;o=~o;for(let l=0;l<10;l++)e[l]=e[l]&o|r[l];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let a=e[0]+n[0];e[0]=a&65535;for(let l=1;l<8;l++)a=(e[l]+n[l]|0)+(a>>>16)|0,e[l]=a&65535}update(e){exists(this);const{buffer:n,blockLen:r}=this;e=toBytes(e);const s=e.length;for(let o=0;o<s;){const a=Math.min(r-this.pos,s-o);if(a===r){for(;r<=s-o;o+=r)this.process(e,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){exists(this),output(e,this),this.finished=!0;const{buffer:n,h:r}=this;let{pos:s}=this;if(s){for(n[s++]=1;s<16;s++)n[s]=0;this.process(n,0,!0)}this.finalize();let o=0;for(let a=0;a<8;a++)e[o++]=r[a]>>>0,e[o++]=r[a]>>>8;return e}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}}function wrapConstructorWithKey(t){const e=(r,s)=>t(s).update(toBytes(r)).digest(),n=t(new Uint8Array(32));return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=r=>t(r),e}const poly1305=wrapConstructorWithKey(t=>new Poly1305(t)),_utf8ToBytes=t=>Uint8Array.from(t.split("").map(e=>e.charCodeAt(0))),sigma16=_utf8ToBytes("expand 16-byte k"),sigma32=_utf8ToBytes("expand 32-byte k"),sigma16_32=u32(sigma16),sigma32_32=u32(sigma32);sigma32_32.slice();function rotl(t,e){return t<<e|t>>>32-e}function isAligned32(t){return t.byteOffset%4===0}const BLOCK_LEN=64,BLOCK_LEN32=16,MAX_COUNTER=2**32-1,U32_EMPTY=new Uint32Array;function runCipher(t,e,n,r,s,o,a,l){const u=s.length,p=new Uint8Array(BLOCK_LEN),y=u32(p),b=isAligned32(s)&&isAligned32(o),w=b?u32(s):U32_EMPTY,_=b?u32(o):U32_EMPTY;for(let x=0;x<u;a++){if(t(e,n,r,y,a,l),a>=MAX_COUNTER)throw new Error("arx: counter overflow");const T=Math.min(BLOCK_LEN,u-x);if(b&&T===BLOCK_LEN){const k=x/4;if(x%4!==0)throw new Error("arx: invalid block position");for(let B=0,G;B<BLOCK_LEN32;B++)G=k+B,_[G]=w[G]^y[B];x+=BLOCK_LEN;continue}for(let k=0,B;k<T;k++)B=x+k,o[B]=s[B]^p[k];x+=T}}function createCipher(t,e){const{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:o,rounds:a}=checkOpts({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof t!="function")throw new Error("core must be a function");return number(s),number(a),bool(o),bool(n),(l,u,p,y,b=0)=>{bytes(l),bytes(u),bytes(p);const w=p.length;if(y||(y=new Uint8Array(w)),bytes(y),number(b),b<0||b>=MAX_COUNTER)throw new Error("arx: counter overflow");if(y.length<w)throw new Error(`arx: output (${y.length}) is shorter than data (${w})`);const _=[];let x=l.length,T,k;if(x===32)T=l.slice(),_.push(T),k=sigma32_32;else if(x===16&&n)T=new Uint8Array(32),T.set(l),T.set(l,16),k=sigma16_32,_.push(T);else throw new Error(`arx: invalid 32-byte key, got length=${x}`);isAligned32(u)||(u=u.slice(),_.push(u));const B=u32(T);if(r){if(u.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(k,B,u32(u.subarray(0,16)),B),u=u.subarray(16)}const G=16-s;if(G!==u.length)throw new Error(`arx: nonce must be ${G} or 16 bytes`);if(G!==12){const Q=new Uint8Array(12);Q.set(u,o?0:12-u.length),u=Q,_.push(u)}const z=u32(u);for(runCipher(t,k,B,z,p,y,b,a);_.length>0;)_.pop().fill(0);return y}}function chachaCore(t,e,n,r,s,o=20){let a=t[0],l=t[1],u=t[2],p=t[3],y=e[0],b=e[1],w=e[2],_=e[3],x=e[4],T=e[5],k=e[6],B=e[7],G=s,z=n[0],Q=n[1],ye=n[2],ie=a,te=l,oe=u,ne=p,me=y,O=b,F=w,j=_,H=x,V=T,W=k,Z=B,ae=G,A=z,J=Q,X=ye;for(let ve=0;ve<o;ve+=2)ie=ie+me|0,ae=rotl(ae^ie,16),H=H+ae|0,me=rotl(me^H,12),ie=ie+me|0,ae=rotl(ae^ie,8),H=H+ae|0,me=rotl(me^H,7),te=te+O|0,A=rotl(A^te,16),V=V+A|0,O=rotl(O^V,12),te=te+O|0,A=rotl(A^te,8),V=V+A|0,O=rotl(O^V,7),oe=oe+F|0,J=rotl(J^oe,16),W=W+J|0,F=rotl(F^W,12),oe=oe+F|0,J=rotl(J^oe,8),W=W+J|0,F=rotl(F^W,7),ne=ne+j|0,X=rotl(X^ne,16),Z=Z+X|0,j=rotl(j^Z,12),ne=ne+j|0,X=rotl(X^ne,8),Z=Z+X|0,j=rotl(j^Z,7),ie=ie+O|0,X=rotl(X^ie,16),W=W+X|0,O=rotl(O^W,12),ie=ie+O|0,X=rotl(X^ie,8),W=W+X|0,O=rotl(O^W,7),te=te+F|0,ae=rotl(ae^te,16),Z=Z+ae|0,F=rotl(F^Z,12),te=te+F|0,ae=rotl(ae^te,8),Z=Z+ae|0,F=rotl(F^Z,7),oe=oe+j|0,A=rotl(A^oe,16),H=H+A|0,j=rotl(j^H,12),oe=oe+j|0,A=rotl(A^oe,8),H=H+A|0,j=rotl(j^H,7),ne=ne+me|0,J=rotl(J^ne,16),V=V+J|0,me=rotl(me^V,12),ne=ne+me|0,J=rotl(J^ne,8),V=V+J|0,me=rotl(me^V,7);let de=0;r[de++]=a+ie|0,r[de++]=l+te|0,r[de++]=u+oe|0,r[de++]=p+ne|0,r[de++]=y+me|0,r[de++]=b+O|0,r[de++]=w+F|0,r[de++]=_+j|0,r[de++]=x+H|0,r[de++]=T+V|0,r[de++]=k+W|0,r[de++]=B+Z|0,r[de++]=G+ae|0,r[de++]=z+A|0,r[de++]=Q+J|0,r[de++]=ye+X|0}function hchacha(t,e,n,r){let s=t[0],o=t[1],a=t[2],l=t[3],u=e[0],p=e[1],y=e[2],b=e[3],w=e[4],_=e[5],x=e[6],T=e[7],k=n[0],B=n[1],G=n[2],z=n[3];for(let ye=0;ye<20;ye+=2)s=s+u|0,k=rotl(k^s,16),w=w+k|0,u=rotl(u^w,12),s=s+u|0,k=rotl(k^s,8),w=w+k|0,u=rotl(u^w,7),o=o+p|0,B=rotl(B^o,16),_=_+B|0,p=rotl(p^_,12),o=o+p|0,B=rotl(B^o,8),_=_+B|0,p=rotl(p^_,7),a=a+y|0,G=rotl(G^a,16),x=x+G|0,y=rotl(y^x,12),a=a+y|0,G=rotl(G^a,8),x=x+G|0,y=rotl(y^x,7),l=l+b|0,z=rotl(z^l,16),T=T+z|0,b=rotl(b^T,12),l=l+b|0,z=rotl(z^l,8),T=T+z|0,b=rotl(b^T,7),s=s+p|0,z=rotl(z^s,16),x=x+z|0,p=rotl(p^x,12),s=s+p|0,z=rotl(z^s,8),x=x+z|0,p=rotl(p^x,7),o=o+y|0,k=rotl(k^o,16),T=T+k|0,y=rotl(y^T,12),o=o+y|0,k=rotl(k^o,8),T=T+k|0,y=rotl(y^T,7),a=a+b|0,B=rotl(B^a,16),w=w+B|0,b=rotl(b^w,12),a=a+b|0,B=rotl(B^a,8),w=w+B|0,b=rotl(b^w,7),l=l+u|0,G=rotl(G^l,16),_=_+G|0,u=rotl(u^_,12),l=l+u|0,G=rotl(G^l,8),_=_+G|0,u=rotl(u^_,7);let Q=0;r[Q++]=s,r[Q++]=o,r[Q++]=a,r[Q++]=l,r[Q++]=k,r[Q++]=B,r[Q++]=G,r[Q++]=z}const chacha20=createCipher(chachaCore,{counterRight:!1,counterLength:4,allowShortKeys:!1}),xchacha20=createCipher(chachaCore,{counterRight:!1,counterLength:8,extendNonceFn:hchacha,allowShortKeys:!1}),ZEROS16=new Uint8Array(16),updatePadded=(t,e)=>{t.update(e);const n=e.length%16;n&&t.update(ZEROS16.subarray(n))},ZEROS32=new Uint8Array(32);function computeTag(t,e,n,r,s){const o=t(e,n,ZEROS32),a=poly1305.create(o);s&&updatePadded(a,s),updatePadded(a,r);const l=new Uint8Array(16),u=createView(l);setBigUint64(u,0,BigInt(s?s.length:0),!0),setBigUint64(u,8,BigInt(r.length),!0),a.update(l);const p=a.digest();return o.fill(0),p}const _poly1305_aead=t=>(e,n,r)=>(bytes(e,32),bytes(n),{encrypt:(o,a)=>{const l=o.length,u=l+16;a?bytes(a,u):a=new Uint8Array(u),t(e,n,o,a,1);const p=computeTag(t,e,n,a.subarray(0,-16),r);return a.set(p,l),a},decrypt:(o,a)=>{const l=o.length,u=l-16;if(l<16)throw new Error("encrypted data must be at least 16 bytes");a?bytes(a,u):a=new Uint8Array(u);const p=o.subarray(0,-16),y=o.subarray(-16),b=computeTag(t,e,n,p,r);if(!equalBytes(y,b))throw new Error("invalid tag");return t(e,n,p,a,1),a}}),xchacha20poly1305=wrapCipher({blockSize:64,nonceLength:24,tagLength:16},_poly1305_aead(xchacha20));var hkdf$1={};Object.defineProperty(hkdf$1,"__esModule",{value:!0});hkdf$1.hkdf=void 0;var extract_1=hkdf$1.extract=extract,expand_1=hkdf$1.expand=expand;const hmac_ts_1$1=hmac,utils_ts_1$2=utils;function extract(t,e,n){return(0,utils_ts_1$2.ahash)(t),n===void 0&&(n=new Uint8Array(t.outputLen)),(0,hmac_ts_1$1.hmac)(t,(0,utils_ts_1$2.toBytes)(n),(0,utils_ts_1$2.toBytes)(e))}const HKDF_COUNTER=Uint8Array.from([0]),EMPTY_BUFFER=Uint8Array.of();function expand(t,e,n,r=32){(0,utils_ts_1$2.ahash)(t),(0,utils_ts_1$2.anumber)(r);const s=t.outputLen;if(r>255*s)throw new Error("Length should be <= 255*HashLen");const o=Math.ceil(r/s);n===void 0&&(n=EMPTY_BUFFER);const a=new Uint8Array(o*s),l=hmac_ts_1$1.hmac.create(t,e),u=l._cloneInto(),p=new Uint8Array(l.outputLen);for(let y=0;y<o;y++)HKDF_COUNTER[0]=y+1,u.update(y===0?EMPTY_BUFFER:p).update(n).update(HKDF_COUNTER).digestInto(p),a.set(p,s*y),l._cloneInto(u);return l.destroy(),u.destroy(),(0,utils_ts_1$2.clean)(p,HKDF_COUNTER),a.slice(0,r)}const hkdf=(t,e,n,r,s)=>expand(t,extract(t,e,n),r,s);hkdf$1.hkdf=hkdf;var __defProp$2=Object.defineProperty,__export=(t,e)=>{for(var n in e)__defProp$2(t,n,{get:e[n],enumerable:!0})},verifiedSymbol=Symbol("verified"),isRecord=t=>t instanceof Object;function validateEvent(t){if(!isRecord(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}var utils_exports={};__export(utils_exports,{Queue:()=>Queue$1,QueueNode:()=>QueueNode,binarySearch:()=>binarySearch,bytesToHex:()=>utils.bytesToHex,hexToBytes:()=>utils.hexToBytes,insertEventIntoAscendingList:()=>insertEventIntoAscendingList,insertEventIntoDescendingList:()=>insertEventIntoDescendingList,normalizeURL:()=>normalizeURL,utf8Decoder:()=>utf8Decoder$1,utf8Encoder:()=>utf8Encoder$1});var utf8Decoder$1=new TextDecoder("utf-8"),utf8Encoder$1=new TextEncoder;function normalizeURL(t){try{t.indexOf("://")===-1&&(t="wss://"+t);let e=new URL(t);return e.protocol==="http:"?e.protocol="ws:":e.protocol==="https:"&&(e.protocol="wss:"),e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}catch{throw new Error(`Invalid URL: ${t}`)}}function insertEventIntoDescendingList(t,e){const[n,r]=binarySearch(t,s=>e.id===s.id?0:e.created_at===s.created_at?-1:s.created_at-e.created_at);return r||t.splice(n,0,e),t}function insertEventIntoAscendingList(t,e){const[n,r]=binarySearch(t,s=>e.id===s.id?0:e.created_at===s.created_at?-1:e.created_at-s.created_at);return r||t.splice(n,0,e),t}function binarySearch(t,e){let n=0,r=t.length-1;for(;n<=r;){const s=Math.floor((n+r)/2),o=e(t[s]);if(o===0)return[s,!0];o<0?r=s-1:n=s+1}return[n,!1]}var QueueNode=class{value;next=null;prev=null;constructor(t){this.value=t}},Queue$1=class{first;last;constructor(){this.first=null,this.last=null}enqueue(e){const n=new QueueNode(e);return this.last?this.last===this.first?(this.last=n,this.last.prev=this.first,this.first.next=n):(n.prev=this.last,this.last.next=n,this.last=n):(this.first=n,this.last=n),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const n=this.first;return this.first=null,this.last=null,n.value}const e=this.first;return this.first=e.next,this.first&&(this.first.prev=null),e.value}},JS=class{generateSecretKey(){return schnorr.utils.randomPrivateKey()}getPublicKey(t){return utils.bytesToHex(schnorr.getPublicKey(t))}finalizeEvent(t,e){const n=t;return n.pubkey=utils.bytesToHex(schnorr.getPublicKey(e)),n.id=getEventHash$2(n),n.sig=utils.bytesToHex(schnorr.sign(getEventHash$2(n),e)),n[verifiedSymbol]=!0,n}verifyEvent(t){if(typeof t[verifiedSymbol]=="boolean")return t[verifiedSymbol];const e=getEventHash$2(t);if(e!==t.id)return t[verifiedSymbol]=!1,!1;try{const n=schnorr.verify(t.sig,e,t.pubkey);return t[verifiedSymbol]=n,n}catch{return t[verifiedSymbol]=!1,!1}}};function serializeEvent(t){if(!validateEvent(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function getEventHash$2(t){let e=sha256_1(utf8Encoder$1.encode(serializeEvent(t)));return utils.bytesToHex(e)}var i=new JS,generateSecretKey=i.generateSecretKey,getPublicKey=i.getPublicKey,finalizeEvent=i.finalizeEvent,verifyEvent=i.verifyEvent,kinds_exports={};__export(kinds_exports,{Application:()=>Application,BadgeAward:()=>BadgeAward,BadgeDefinition:()=>BadgeDefinition,BlockedRelaysList:()=>BlockedRelaysList,BlossomServerList:()=>BlossomServerList,BookmarkList:()=>BookmarkList,Bookmarksets:()=>Bookmarksets,Calendar:()=>Calendar,CalendarEventRSVP:()=>CalendarEventRSVP,ChannelCreation:()=>ChannelCreation,ChannelHideMessage:()=>ChannelHideMessage,ChannelMessage:()=>ChannelMessage,ChannelMetadata:()=>ChannelMetadata,ChannelMuteUser:()=>ChannelMuteUser,ChatMessage:()=>ChatMessage,ClassifiedListing:()=>ClassifiedListing,ClientAuth:()=>ClientAuth,Comment:()=>Comment,CommunitiesList:()=>CommunitiesList,CommunityDefinition:()=>CommunityDefinition,CommunityPostApproval:()=>CommunityPostApproval,Contacts:()=>Contacts,CreateOrUpdateProduct:()=>CreateOrUpdateProduct,CreateOrUpdateStall:()=>CreateOrUpdateStall,Curationsets:()=>Curationsets,Date:()=>Date2,DirectMessageRelaysList:()=>DirectMessageRelaysList,DraftClassifiedListing:()=>DraftClassifiedListing,DraftLong:()=>DraftLong,Emojisets:()=>Emojisets,EncryptedDirectMessage:()=>EncryptedDirectMessage,EventDeletion:()=>EventDeletion,FavoriteRelays:()=>FavoriteRelays,FileMessage:()=>FileMessage,FileMetadata:()=>FileMetadata,FileServerPreference:()=>FileServerPreference,Followsets:()=>Followsets,ForumThread:()=>ForumThread,GenericRepost:()=>GenericRepost,Genericlists:()=>Genericlists,GiftWrap:()=>GiftWrap,GroupMetadata:()=>GroupMetadata,HTTPAuth:()=>HTTPAuth,Handlerinformation:()=>Handlerinformation,Handlerrecommendation:()=>Handlerrecommendation,Highlights:()=>Highlights,InterestsList:()=>InterestsList,Interestsets:()=>Interestsets,JobFeedback:()=>JobFeedback,JobRequest:()=>JobRequest,JobResult:()=>JobResult,Label:()=>Label,LightningPubRPC:()=>LightningPubRPC,LiveChatMessage:()=>LiveChatMessage,LiveEvent:()=>LiveEvent,LongFormArticle:()=>LongFormArticle,Metadata:()=>Metadata,Mutelist:()=>Mutelist,NWCWalletInfo:()=>NWCWalletInfo,NWCWalletRequest:()=>NWCWalletRequest,NWCWalletResponse:()=>NWCWalletResponse,NormalVideo:()=>NormalVideo,NostrConnect:()=>NostrConnect,OpenTimestamps:()=>OpenTimestamps,Photo:()=>Photo,Pinlist:()=>Pinlist,Poll:()=>Poll,PollResponse:()=>PollResponse,PrivateDirectMessage:()=>PrivateDirectMessage,ProblemTracker:()=>ProblemTracker,ProfileBadges:()=>ProfileBadges,PublicChatsList:()=>PublicChatsList,Reaction:()=>Reaction,RecommendRelay:()=>RecommendRelay,RelayList:()=>RelayList,RelayReview:()=>RelayReview,Relaysets:()=>Relaysets,Report:()=>Report,Reporting:()=>Reporting,Repost:()=>Repost,Seal:()=>Seal,SearchRelaysList:()=>SearchRelaysList,ShortTextNote:()=>ShortTextNote,ShortVideo:()=>ShortVideo,Time:()=>Time,UserEmojiList:()=>UserEmojiList,UserStatuses:()=>UserStatuses,Voice:()=>Voice,VoiceComment:()=>VoiceComment,Zap:()=>Zap,ZapGoal:()=>ZapGoal,ZapRequest:()=>ZapRequest,classifyKind:()=>classifyKind,isAddressableKind:()=>isAddressableKind,isEphemeralKind:()=>isEphemeralKind,isKind:()=>isKind,isRegularKind:()=>isRegularKind,isReplaceableKind:()=>isReplaceableKind});function isRegularKind(t){return t<1e4&&t!==0&&t!==3}function isReplaceableKind(t){return t===0||t===3||1e4<=t&&t<2e4}function isEphemeralKind(t){return 2e4<=t&&t<3e4}function isAddressableKind(t){return 3e4<=t&&t<4e4}function classifyKind(t){return isRegularKind(t)?"regular":isReplaceableKind(t)?"replaceable":isEphemeralKind(t)?"ephemeral":isAddressableKind(t)?"parameterized":"unknown"}function isKind(t,e){const n=e instanceof Array?e:[e];return validateEvent(t)&&n.includes(t.kind)||!1}var Metadata=0,ShortTextNote=1,RecommendRelay=2,Contacts=3,EncryptedDirectMessage=4,EventDeletion=5,Repost=6,Reaction=7,BadgeAward=8,ChatMessage=9,ForumThread=11,Seal=13,PrivateDirectMessage=14,FileMessage=15,GenericRepost=16,Photo=20,NormalVideo=21,ShortVideo=22,ChannelCreation=40,ChannelMetadata=41,ChannelMessage=42,ChannelHideMessage=43,ChannelMuteUser=44,OpenTimestamps=1040,GiftWrap=1059,Poll=1068,FileMetadata=1063,Comment=1111,LiveChatMessage=1311,Voice=1222,VoiceComment=1244,ProblemTracker=1971,Report=1984,Reporting=1984,Label=1985,CommunityPostApproval=4550,JobRequest=5999,JobResult=6999,JobFeedback=7e3,ZapGoal=9041,ZapRequest=9734,Zap=9735,Highlights=9802,PollResponse=1018,Mutelist=1e4,Pinlist=10001,RelayList=10002,BookmarkList=10003,CommunitiesList=10004,PublicChatsList=10005,BlockedRelaysList=10006,SearchRelaysList=10007,FavoriteRelays=10012,InterestsList=10015,UserEmojiList=10030,DirectMessageRelaysList=10050,FileServerPreference=10096,BlossomServerList=10063,NWCWalletInfo=13194,LightningPubRPC=21e3,ClientAuth=22242,NWCWalletRequest=23194,NWCWalletResponse=23195,NostrConnect=24133,HTTPAuth=27235,Followsets=3e4,Genericlists=30001,Relaysets=30002,Bookmarksets=30003,Curationsets=30004,ProfileBadges=30008,BadgeDefinition=30009,Interestsets=30015,CreateOrUpdateStall=30017,CreateOrUpdateProduct=30018,LongFormArticle=30023,DraftLong=30024,Emojisets=30030,Application=30078,LiveEvent=30311,UserStatuses=30315,ClassifiedListing=30402,DraftClassifiedListing=30403,Date2=31922,Time=31923,Calendar=31924,CalendarEventRSVP=31925,RelayReview=31987,Handlerrecommendation=31989,Handlerinformation=31990,CommunityDefinition=34550,GroupMetadata=39e3;function matchFilter(t,e){if(t.ids&&t.ids.indexOf(e.id)===-1||t.kinds&&t.kinds.indexOf(e.kind)===-1||t.authors&&t.authors.indexOf(e.pubkey)===-1)return!1;for(let n in t)if(n[0]==="#"){let r=n.slice(1),s=t[`#${r}`];if(s&&!e.tags.find(([o,a])=>o===n.slice(1)&&s.indexOf(a)!==-1))return!1}return!(t.since&&e.created_at<t.since||t.until&&e.created_at>t.until)}function matchFilters(t,e){for(let n=0;n<t.length;n++)if(matchFilter(t[n],e))return!0;return!1}var fakejson_exports={};__export(fakejson_exports,{getHex64:()=>getHex64,getInt:()=>getInt,getSubscriptionId:()=>getSubscriptionId,matchEventId:()=>matchEventId,matchEventKind:()=>matchEventKind,matchEventPubkey:()=>matchEventPubkey});function getHex64(t,e){let n=e.length+3,r=t.indexOf(`"${e}":`)+n,s=t.slice(r).indexOf('"')+r+1;return t.slice(s,s+64)}function getInt(t,e){let n=e.length,r=t.indexOf(`"${e}":`)+n+3,s=t.slice(r),o=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,o),10)}function getSubscriptionId(t){let e=t.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let n=t.slice(e+7+1).indexOf('"');if(n===-1)return null;let r=e+7+1+n,s=t.slice(r+1,80).indexOf('"');if(s===-1)return null;let o=r+1+s;return t.slice(r+1,o)}function matchEventId(t,e){return e===getHex64(t,"id")}function matchEventPubkey(t,e){return e===getHex64(t,"pubkey")}function matchEventKind(t,e){return e===getInt(t,"kind")}var nip42_exports={};__export(nip42_exports,{makeAuthEvent:()=>makeAuthEvent});function makeAuthEvent(t,e){return{kind:ClientAuth,created_at:Math.floor(Date.now()/1e3),tags:[["relay",t],["challenge",e]],content:""}}var _WebSocket;try{_WebSocket=WebSocket}catch{}var _WebSocket2;try{_WebSocket2=WebSocket}catch{}var nip19_exports$2={};__export(nip19_exports$2,{BECH32_REGEX:()=>BECH32_REGEX$2,Bech32MaxSize:()=>Bech32MaxSize$2,NostrTypeGuard:()=>NostrTypeGuard$1,decode:()=>decode$1,decodeNostrURI:()=>decodeNostrURI$1,encodeBytes:()=>encodeBytes$2,naddrEncode:()=>naddrEncode$1,neventEncode:()=>neventEncode$1,noteEncode:()=>noteEncode$1,nprofileEncode:()=>nprofileEncode$1,npubEncode:()=>npubEncode$1,nsecEncode:()=>nsecEncode$1});var NostrTypeGuard$1={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize$2=5e3,BECH32_REGEX$2=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array$1(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI$1(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode$1(t)}catch{return{type:"invalid",data:null}}}function decode$1(t){let{prefix:e,words:n}=bech32$1.decode(t,Bech32MaxSize$2),r=new Uint8Array(bech32$1.fromWords(n));switch(e){case"nprofile":{let s=parseTLV$1(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:utils.bytesToHex(s[0][0]),relays:s[1]?s[1].map(o=>utf8Decoder$1.decode(o)):[]}}}case"nevent":{let s=parseTLV$1(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:utils.bytesToHex(s[0][0]),relays:s[1]?s[1].map(o=>utf8Decoder$1.decode(o)):[],author:s[2]?.[0]?utils.bytesToHex(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(utils.bytesToHex(s[3][0]),16):void 0}}}case"naddr":{let s=parseTLV$1(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder$1.decode(s[0][0]),pubkey:utils.bytesToHex(s[2][0]),kind:parseInt(utils.bytesToHex(s[3][0]),16),relays:s[1]?s[1].map(o=>utf8Decoder$1.decode(o)):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:utils.bytesToHex(r)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV$1(t){let e={},n=t;for(;n.length>0;){let r=n[0],s=n[1],o=n.slice(2,2+s);if(n=n.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(o)}return e}function nsecEncode$1(t){return encodeBytes$2("nsec",t)}function npubEncode$1(t){return encodeBytes$2("npub",utils.hexToBytes(t))}function noteEncode$1(t){return encodeBytes$2("note",utils.hexToBytes(t))}function encodeBech32$2(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize$2)}function encodeBytes$2(t,e){return encodeBech32$2(t,e)}function nprofileEncode$1(t){let e=encodeTLV$1({0:[utils.hexToBytes(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder$1.encode(n))});return encodeBech32$2("nprofile",e)}function neventEncode$1(t){let e;t.kind!==void 0&&(e=integerToUint8Array$1(t.kind));let n=encodeTLV$1({0:[utils.hexToBytes(t.id)],1:(t.relays||[]).map(r=>utf8Encoder$1.encode(r)),2:t.author?[utils.hexToBytes(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32$2("nevent",n)}function naddrEncode$1(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV$1({0:[utf8Encoder$1.encode(t.identifier)],1:(t.relays||[]).map(r=>utf8Encoder$1.encode(r)),2:[utils.hexToBytes(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32$2("naddr",n)}function encodeTLV$1(t){let e=[];return Object.entries(t).reverse().forEach(([n,r])=>{r.forEach(s=>{let o=new Uint8Array(s.length+2);o.set([parseInt(n)],0),o.set([s.length],1),o.set(s,2),e.push(o)})}),utils.concatBytes(...e)}var nip04_exports={};__export(nip04_exports,{decrypt:()=>decrypt$3,encrypt:()=>encrypt$3});function encrypt$3(t,e,n){const r=t instanceof Uint8Array?utils.bytesToHex(t):t,s=secp256k1.getSharedSecret(r,"02"+e),o=getNormalizedX(s);let a=Uint8Array.from(utils.randomBytes(16)),l=utf8Encoder$1.encode(n),u=cbc(o,a).encrypt(l),p=base64.encode(new Uint8Array(u)),y=base64.encode(new Uint8Array(a.buffer));return`${p}?iv=${y}`}function decrypt$3(t,e,n){const r=t instanceof Uint8Array?utils.bytesToHex(t):t;let[s,o]=n.split("?iv="),a=secp256k1.getSharedSecret(r,"02"+e),l=getNormalizedX(a),u=base64.decode(o),p=base64.decode(s),y=cbc(l,u).decrypt(p);return utf8Decoder$1.decode(y)}function getNormalizedX(t){return t.slice(1,33)}var nip05_exports={};__export(nip05_exports,{NIP05_REGEX:()=>NIP05_REGEX$2,isNip05:()=>isNip05,isValid:()=>isValid,queryProfile:()=>queryProfile,searchDomain:()=>searchDomain,useFetchImplementation:()=>useFetchImplementation});var NIP05_REGEX$2=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,isNip05=t=>NIP05_REGEX$2.test(t||""),_fetch;try{_fetch=fetch}catch(t){}function useFetchImplementation(t){_fetch=t}async function searchDomain(t,e=""){try{const n=`https://${t}/.well-known/nostr.json?name=${e}`,r=await _fetch(n,{redirect:"manual"});if(r.status!==200)throw Error("Wrong response code");return(await r.json()).names}catch{return{}}}async function queryProfile(t){const e=t.match(NIP05_REGEX$2);if(!e)return null;const[,n="_",r]=e;try{const s=`https://${r}/.well-known/nostr.json?name=${n}`,o=await _fetch(s,{redirect:"manual"});if(o.status!==200)throw Error("Wrong response code");const a=await o.json(),l=a.names[n];return l?{pubkey:l,relays:a.relays?.[l]}:null}catch{return null}}async function isValid(t,e){const n=await queryProfile(e);return n?n.pubkey===t:!1}var nip10_exports={};__export(nip10_exports,{parse:()=>parse});function parse(t){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let n,r;for(let s=t.tags.length-1;s>=0;s--){const o=t.tags[s];if(o[0]==="e"&&o[1]){const[a,l,u,p,y]=o,b={id:l,relays:u?[u]:[],author:y};if(p==="root"){e.root=b;continue}if(p==="reply"){e.reply=b;continue}if(p==="mention"){e.mentions.push(b);continue}n?r=b:n=b,e.mentions.push(b);continue}if(o[0]==="q"&&o[1]){const[a,l,u]=o;e.quotes.push({id:l,relays:u?[u]:[]})}if(o[0]==="p"&&o[1]){e.profiles.push({pubkey:o[1],relays:o[2]?[o[2]]:[]});continue}}return e.root||(e.root=r||n||e.reply),e.reply||(e.reply=n||e.root),[e.reply,e.root].forEach(s=>{if(!s)return;let o=e.mentions.indexOf(s);if(o!==-1&&e.mentions.splice(o,1),s.author){let a=e.profiles.find(l=>l.pubkey===s.author);a&&a.relays&&(s.relays||(s.relays=[]),a.relays.forEach(l=>{s.relays?.indexOf(l)===-1&&s.relays.push(l)}),a.relays=s.relays)}}),e.mentions.forEach(s=>{if(s.author){let o=e.profiles.find(a=>a.pubkey===s.author);o&&o.relays&&(s.relays||(s.relays=[]),o.relays.forEach(a=>{s.relays.indexOf(a)===-1&&s.relays.push(a)}),o.relays=s.relays)}}),e}var nip11_exports={};__export(nip11_exports,{fetchRelayInformation:()=>fetchRelayInformation$1,useFetchImplementation:()=>useFetchImplementation2});var _fetch2;try{_fetch2=fetch}catch{}function useFetchImplementation2(t){_fetch2=t}async function fetchRelayInformation$1(t){return await(await fetch(t.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var nip13_exports={};__export(nip13_exports,{fastEventHash:()=>fastEventHash,getPow:()=>getPow,minePow:()=>minePow});function getPow(t){let e=0;for(let n=0;n<64;n+=8){const r=parseInt(t.substring(n,n+8),16);if(r===0)e+=32;else{e+=Math.clz32(r);break}}return e}function minePow(t,e){let n=0;const r=t,s=["nonce",n.toString(),e.toString()];for(r.tags.push(s);;){const o=Math.floor(new Date().getTime()/1e3);if(o!==r.created_at&&(n=0,r.created_at=o),s[1]=(++n).toString(),r.id=fastEventHash(r),getPow(r.id)>=e)break}return r}function fastEventHash(t){return utils.bytesToHex(sha256_1(utf8Encoder$1.encode(JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]))))}var nip17_exports={};__export(nip17_exports,{unwrapEvent:()=>unwrapEvent2,unwrapManyEvents:()=>unwrapManyEvents2,wrapEvent:()=>wrapEvent2,wrapManyEvents:()=>wrapManyEvents2});var nip59_exports={};__export(nip59_exports,{createRumor:()=>createRumor,createSeal:()=>createSeal,createWrap:()=>createWrap,unwrapEvent:()=>unwrapEvent,unwrapManyEvents:()=>unwrapManyEvents,wrapEvent:()=>wrapEvent$1,wrapManyEvents:()=>wrapManyEvents});var nip44_exports={};__export(nip44_exports,{decrypt:()=>decrypt2,encrypt:()=>encrypt2,getConversationKey:()=>getConversationKey,v2:()=>v2});var minPlaintextSize=1,maxPlaintextSize=65535;function getConversationKey(t,e){const n=secp256k1.getSharedSecret(t,"02"+e).subarray(1,33);return extract_1(sha256_1,n,"nip44-v2")}function getMessageKeys(t,e){const n=expand_1(sha256_1,t,e,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function calcPaddedLen(t){if(!Number.isSafeInteger(t)||t<1)throw new Error("expected positive integer");if(t<=32)return 32;const e=1<<Math.floor(Math.log2(t-1))+1,n=e<=256?32:e/8;return n*(Math.floor((t-1)/n)+1)}function writeU16BE(t){if(!Number.isSafeInteger(t)||t<minPlaintextSize||t>maxPlaintextSize)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),e}function pad(t){const e=utf8Encoder$1.encode(t),n=e.length,r=writeU16BE(n),s=new Uint8Array(calcPaddedLen(n)-n);return utils.concatBytes(r,e,s)}function unpad(t){const e=new DataView(t.buffer).getUint16(0),n=t.subarray(2,2+e);if(e<minPlaintextSize||e>maxPlaintextSize||n.length!==e||t.length!==2+calcPaddedLen(e))throw new Error("invalid padding");return utf8Decoder$1.decode(n)}function hmacAad(t,e,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const r=utils.concatBytes(n,e);return hmac.hmac(sha256_1,t,r)}function decodePayload(t){if(typeof t!="string")throw new Error("payload must be a valid string");const e=t.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(t[0]==="#")throw new Error("unknown encryption version");let n;try{n=base64.decode(t)}catch(o){throw new Error("invalid base64: "+o.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const s=n[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function encrypt2(t,e,n=utils.randomBytes(32)){const{chacha_key:r,chacha_nonce:s,hmac_key:o}=getMessageKeys(e,n),a=pad(t),l=chacha20(r,s,a),u=hmacAad(o,l,n);return base64.encode(utils.concatBytes(new Uint8Array([2]),n,l,u))}function decrypt2(t,e){const{nonce:n,ciphertext:r,mac:s}=decodePayload(t),{chacha_key:o,chacha_nonce:a,hmac_key:l}=getMessageKeys(e,n),u=hmacAad(l,r,n);if(!equalBytes(u,s))throw new Error("invalid MAC");const p=chacha20(o,a,r);return unpad(p)}var v2={utils:{getConversationKey,calcPaddedLen},encrypt:encrypt2,decrypt:decrypt2},TWO_DAYS=2*24*60*60,now=()=>Math.round(Date.now()/1e3),randomNow=()=>Math.round(now()-Math.random()*TWO_DAYS),nip44ConversationKey=(t,e)=>getConversationKey(t,e),nip44Encrypt=(t,e,n)=>encrypt2(JSON.stringify(t),nip44ConversationKey(e,n)),nip44Decrypt=(t,e)=>JSON.parse(decrypt2(t.content,nip44ConversationKey(e,t.pubkey)));function createRumor(t,e){const n={created_at:now(),content:"",tags:[],...t,pubkey:getPublicKey(e)};return n.id=getEventHash$2(n),n}function createSeal(t,e,n){return finalizeEvent({kind:Seal,content:nip44Encrypt(t,e,n),created_at:randomNow(),tags:[]},e)}function createWrap(t,e){const n=generateSecretKey();return finalizeEvent({kind:GiftWrap,content:nip44Encrypt(t,n,e),created_at:randomNow(),tags:[["p",e]]},n)}function wrapEvent$1(t,e,n){const r=createRumor(t,e),s=createSeal(r,e,n);return createWrap(s,n)}function wrapManyEvents(t,e,n){if(!n||n.length===0)throw new Error("At least one recipient is required.");const r=getPublicKey(e),s=[wrapEvent$1(t,e,r)];return n.forEach(o=>{s.push(wrapEvent$1(t,e,o))}),s}function unwrapEvent(t,e){const n=nip44Decrypt(t,e);return nip44Decrypt(n,e)}function unwrapManyEvents(t,e){let n=[];return t.forEach(r=>{n.push(unwrapEvent(r,e))}),n.sort((r,s)=>r.created_at-s.created_at),n}function createEvent(t,e,n,r){const s={created_at:Math.ceil(Date.now()/1e3),kind:PrivateDirectMessage,tags:[],content:e};return(Array.isArray(t)?t:[t]).forEach(({publicKey:a,relayUrl:l})=>{s.tags.push(l?["p",a,l]:["p",a])}),r&&s.tags.push(["e",r.eventId,r.relayUrl||"","reply"]),n&&s.tags.push(["subject",n]),s}function wrapEvent2(t,e,n,r,s){const o=createEvent(e,n,r,s);return wrapEvent$1(o,t,e.publicKey)}function wrapManyEvents2(t,e,n,r,s){if(!e||e.length===0)throw new Error("At least one recipient is required.");return[{publicKey:getPublicKey(t)},...e].map(a=>wrapEvent2(t,a,n,r,s))}var unwrapEvent2=unwrapEvent,unwrapManyEvents2=unwrapManyEvents,nip18_exports={};__export(nip18_exports,{finishRepostEvent:()=>finishRepostEvent,getRepostedEvent:()=>getRepostedEvent,getRepostedEventPointer:()=>getRepostedEventPointer});function finishRepostEvent(t,e,n,r){let s;const o=[...t.tags??[],["e",e.id,n],["p",e.pubkey]];return e.kind===ShortTextNote?s=Repost:(s=GenericRepost,o.push(["k",String(e.kind)])),finalizeEvent({kind:s,tags:o,content:t.content===""||e.tags?.find(a=>a[0]==="-")?"":JSON.stringify(e),created_at:t.created_at},r)}function getRepostedEventPointer(t){if(![Repost,GenericRepost].includes(t.kind))return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const s=t.tags[r];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&n===void 0&&(n=s))}if(e!==void 0)return{id:e[1],relays:[e[2],n?.[2]].filter(r=>typeof r=="string"),author:n?.[1]}}function getRepostedEvent(t,{skipVerification:e}={}){const n=getRepostedEventPointer(t);if(n===void 0||t.content==="")return;let r;try{r=JSON.parse(t.content)}catch{return}if(r.id===n.id&&!(!e&&!verifyEvent(r)))return r}var nip21_exports={};__export(nip21_exports,{NOSTR_URI_REGEX:()=>NOSTR_URI_REGEX,parse:()=>parse2,test:()=>test});var NOSTR_URI_REGEX=new RegExp(`nostr:(${BECH32_REGEX$2.source})`);function test(t){return typeof t=="string"&&new RegExp(`^${NOSTR_URI_REGEX.source}$`).test(t)}function parse2(t){const e=t.match(new RegExp(`^${NOSTR_URI_REGEX.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${t}`);return{uri:e[0],value:e[1],decoded:decode$1(e[1])}}var nip25_exports={};__export(nip25_exports,{finishReactionEvent:()=>finishReactionEvent,getReactedEventPointer:()=>getReactedEventPointer});function finishReactionEvent(t,e,n){const r=e.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return finalizeEvent({...t,kind:Reaction,tags:[...t.tags??[],...r,["e",e.id],["p",e.pubkey]],content:t.content??"+"},n)}function getReactedEventPointer(t){if(t.kind!==Reaction)return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const s=t.tags[r];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&n===void 0&&(n=s))}if(!(e===void 0||n===void 0))return{id:e[1],relays:[e[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var nip27_exports={};__export(nip27_exports,{parse:()=>parse3});var noCharacter=/\W/m,noURLCharacter=/[^\w\/] |[^\w\/]$|$|,| /m,MAX_HASHTAG_LENGTH=42;function*parse3(t){let e=[];if(typeof t!="string"){for(let o=0;o<t.tags.length;o++){const a=t.tags[o];a[0]==="emoji"&&a.length>=3&&e.push({type:"emoji",shortcode:a[1],url:a[2]})}t=t.content}const n=t.length;let r=0,s=0;e:for(;s<n;){const o=t.indexOf(":",s),a=t.indexOf("#",s);if(o===-1&&a===-1)break e;if(o===-1||a>=0&&a<o){if(a===0||t[a-1]===" "){const l=t.slice(a+1,a+MAX_HASHTAG_LENGTH).match(noCharacter),u=l?a+1+l.index:n;yield{type:"text",text:t.slice(r,a)},yield{type:"hashtag",value:t.slice(a+1,u)},s=u,r=s;continue e}s=a+1;continue e}if(t.slice(o-5,o)==="nostr"){const l=t.slice(o+60).match(noCharacter),u=l?o+60+l.index:n;try{let p,{data:y,type:b}=decode$1(t.slice(o+1,u));switch(b){case"npub":p={pubkey:y};break;case"note":p={id:y};break;case"nsec":s=u+1;continue;default:p=y}r!==o-5&&(yield{type:"text",text:t.slice(r,o-5)}),yield{type:"reference",pointer:p},s=u,r=s;continue e}catch{s=o+1;continue e}}else if(t.slice(o-5,o)==="https"||t.slice(o-4,o)==="http"){const l=t.slice(o+4).match(noURLCharacter),u=l?o+4+l.index:n,p=t[o-1]==="s"?5:4;try{let y=new URL(t.slice(o-p,u));if(y.hostname.indexOf(".")===-1)throw new Error("invalid url");if(r!==o-p&&(yield{type:"text",text:t.slice(r,o-p)}),/\.(png|jpe?g|gif|webp|heic|svg)$/i.test(y.pathname)){yield{type:"image",url:y.toString()},s=u,r=s;continue e}if(/\.(mp4|avi|webm|mkv|mov)$/i.test(y.pathname)){yield{type:"video",url:y.toString()},s=u,r=s;continue e}if(/\.(mp3|aac|ogg|opus|wav|flac)$/i.test(y.pathname)){yield{type:"audio",url:y.toString()},s=u,r=s;continue e}yield{type:"url",url:y.toString()},s=u,r=s;continue e}catch{s=u+1;continue e}}else if(t.slice(o-3,o)==="wss"||t.slice(o-2,o)==="ws"){const l=t.slice(o+4).match(noURLCharacter),u=l?o+4+l.index:n,p=t[o-1]==="s"?3:2;try{let y=new URL(t.slice(o-p,u));if(y.hostname.indexOf(".")===-1)throw new Error("invalid ws url");r!==o-p&&(yield{type:"text",text:t.slice(r,o-p)}),yield{type:"relay",url:y.toString()},s=u,r=s;continue e}catch{s=u+1;continue e}}else{for(let l=0;l<e.length;l++){const u=e[l];if(t[o+u.shortcode.length+1]===":"&&t.slice(o+1,o+u.shortcode.length+1)===u.shortcode){r!==o&&(yield{type:"text",text:t.slice(r,o)}),yield u,s=o+u.shortcode.length+2,r=s;continue e}}s=o+1;continue e}}r!==n&&(yield{type:"text",text:t.slice(r)})}var nip28_exports={};__export(nip28_exports,{channelCreateEvent:()=>channelCreateEvent,channelHideMessageEvent:()=>channelHideMessageEvent,channelMessageEvent:()=>channelMessageEvent,channelMetadataEvent:()=>channelMetadataEvent,channelMuteUserEvent:()=>channelMuteUserEvent});var channelCreateEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelCreation,tags:[...t.tags??[]],content:n,created_at:t.created_at},e)},channelMetadataEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMetadata,tags:[["e",t.channel_create_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMessageEvent=(t,e)=>{const n=[["e",t.channel_create_event_id,t.relay_url,"root"]];return t.reply_to_channel_message_event_id&&n.push(["e",t.reply_to_channel_message_event_id,t.relay_url,"reply"]),finalizeEvent({kind:ChannelMessage,tags:[...n,...t.tags??[]],content:t.content,created_at:t.created_at},e)},channelHideMessageEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelHideMessage,tags:[["e",t.channel_message_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMuteUserEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMuteUser,tags:[["p",t.pubkey_to_mute],...t.tags??[]],content:n,created_at:t.created_at},e)},nip30_exports={};__export(nip30_exports,{EMOJI_SHORTCODE_REGEX:()=>EMOJI_SHORTCODE_REGEX,matchAll:()=>matchAll,regex:()=>regex,replaceAll:()=>replaceAll});var EMOJI_SHORTCODE_REGEX=/:(\w+):/,regex=()=>new RegExp(`\\B${EMOJI_SHORTCODE_REGEX.source}\\B`,"g");function*matchAll(t){const e=t.matchAll(regex());for(const n of e)try{const[r,s]=n;yield{shortcode:r,name:s,start:n.index,end:n.index+r.length}}catch{}}function replaceAll(t,e){return t.replaceAll(regex(),(n,r)=>e({shortcode:n,name:r}))}var nip39_exports={};__export(nip39_exports,{useFetchImplementation:()=>useFetchImplementation3,validateGithub:()=>validateGithub});var _fetch3;try{_fetch3=fetch}catch{}function useFetchImplementation3(t){_fetch3=t}async function validateGithub(t,e,n){try{return await(await _fetch3(`https://gist.github.com/${e}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${t}`}catch{return!1}}var nip47_exports={};__export(nip47_exports,{makeNwcRequestEvent:()=>makeNwcRequestEvent,parseConnectionString:()=>parseConnectionString});function parseConnectionString(t){const{host:e,pathname:n,searchParams:r}=new URL(t),s=n||e,o=r.get("relay"),a=r.get("secret");if(!s||!o||!a)throw new Error("invalid connection string");return{pubkey:s,relay:o,secret:a}}async function makeNwcRequestEvent(t,e,n){const s=encrypt$3(e,t,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),o={kind:NWCWalletRequest,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",t]]};return finalizeEvent(o,e)}var nip54_exports={};__export(nip54_exports,{normalizeIdentifier:()=>normalizeIdentifier});function normalizeIdentifier(t){return t=t.trim().toLowerCase(),t=t.normalize("NFKC"),Array.from(t).map(e=>/\p{Letter}/u.test(e)||/\p{Number}/u.test(e)?e:"-").join("")}var nip57_exports={};__export(nip57_exports,{getSatoshisAmountFromBolt11:()=>getSatoshisAmountFromBolt11,getZapEndpoint:()=>getZapEndpoint,makeZapReceipt:()=>makeZapReceipt,makeZapRequest:()=>makeZapRequest,useFetchImplementation:()=>useFetchImplementation4,validateZapRequest:()=>validateZapRequest});var _fetch4;try{_fetch4=fetch}catch{}function useFetchImplementation4(t){_fetch4=t}async function getZapEndpoint(t){try{let e="",{lud06:n,lud16:r}=JSON.parse(t.content);if(r){let[a,l]=r.split("@");e=new URL(`/.well-known/lnurlp/${a}`,`https://${l}`).toString()}else if(n){let{words:a}=bech32$1.decode(n,1e3),l=bech32$1.fromWords(a);e=utf8Decoder$1.decode(l)}else return null;let o=await(await _fetch4(e)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function makeZapRequest(t){let e={kind:9734,created_at:Math.round(Date.now()/1e3),content:t.comment||"",tags:[["p","pubkey"in t?t.pubkey:t.event.pubkey],["amount",t.amount.toString()],["relays",...t.relays]]};if("event"in t){if(e.tags.push(["e",t.event.id]),isReplaceableKind(t.event.kind)){const n=["a",`${t.event.kind}:${t.event.pubkey}:`];e.tags.push(n)}else if(isAddressableKind(t.event.kind)){let n=t.event.tags.find(([s,o])=>s==="d"&&o);if(!n)throw new Error("d tag not found or is empty");const r=["a",`${t.event.kind}:${t.event.pubkey}:${n[1]}`];e.tags.push(r)}e.tags.push(["k",t.event.kind.toString()])}return e}function validateZapRequest(t){let e;try{e=JSON.parse(t)}catch{return"Invalid zap request JSON."}if(!validateEvent(e))return"Zap request is not a valid Nostr event.";if(!verifyEvent(e))return"Invalid signature on zap request.";let n=e.tags.find(([o,a])=>o==="p"&&a);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=e.tags.find(([o,a])=>o==="e"&&a);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([o,a])=>o==="relays"&&a)?null:"Zap request doesn't have a 'relays' tag."}function makeZapReceipt({zapRequest:t,preimage:e,bolt11:n,paidAt:r}){let s=JSON.parse(t),o=s.tags.filter(([l])=>l==="e"||l==="p"||l==="a"),a={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...o,["P",s.pubkey],["bolt11",n],["description",t]]};return e&&a.tags.push(["preimage",e]),a}function getSatoshisAmountFromBolt11(t){if(t.length<50)return 0;t=t.substring(0,50);const e=t.lastIndexOf("1");if(e===-1)return 0;const n=t.substring(0,e);if(!n.startsWith("lnbc"))return 0;const r=n.substring(4);if(r.length<1)return 0;const s=r[r.length-1],o=s.charCodeAt(0)-48,a=o>=0&&o<=9;let l=r.length-1;if(a&&l++,l<1)return 0;const u=parseInt(r.substring(0,l));switch(s){case"m":return u*1e5;case"u":return u*100;case"n":return u/10;case"p":return u/1e4;default:return u*1e8}}var nip77_exports={};__export(nip77_exports,{Negentropy:()=>Negentropy,NegentropyStorageVector:()=>NegentropyStorageVector,NegentropySync:()=>NegentropySync});var PROTOCOL_VERSION=97,ID_SIZE=32,FINGERPRINT_SIZE=16,Mode={Skip:0,Fingerprint:1,IdList:2},WrappedBuffer=class{_raw;length;constructor(t){typeof t=="number"?(this._raw=new Uint8Array(t),this.length=0):t instanceof Uint8Array?(this._raw=new Uint8Array(t),this.length=t.length):(this._raw=new Uint8Array(512),this.length=0)}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(t){if(t instanceof WrappedBuffer&&(t=t.unwrap()),typeof t.length!="number")throw Error("bad length");const e=t.length+this.length;if(this.capacity<e){const n=this._raw,r=Math.max(this.capacity*2,e);this._raw=new Uint8Array(r),this._raw.set(n)}this._raw.set(t,this.length),this.length+=t.length}shift(){const t=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,t}shiftN(t=1){const e=this._raw.subarray(0,t);return this._raw=this._raw.subarray(t),this.length-=t,e}};function decodeVarInt(t){let e=0;for(;;){if(t.length===0)throw Error("parse ends prematurely");let n=t.shift();if(e=e<<7|n&127,!(n&128))break}return e}function encodeVarInt(t){if(t===0)return new WrappedBuffer(new Uint8Array([0]));let e=[];for(;t!==0;)e.push(t&127),t>>>=7;e.reverse();for(let n=0;n<e.length-1;n++)e[n]|=128;return new WrappedBuffer(new Uint8Array(e))}function getByte(t){return getBytes(t,1)[0]}function getBytes(t,e){if(t.length<e)throw Error("parse ends prematurely");return t.shiftN(e)}var Accumulator=class{buf;constructor(){this.setToZero()}setToZero(){this.buf=new Uint8Array(ID_SIZE)}add(t){let e=0,n=0,r=new DataView(this.buf.buffer),s=new DataView(t.buffer);for(let o=0;o<8;o++){let a=o*4,l=r.getUint32(a,!0),u=s.getUint32(a,!0),p=l;p+=e,p+=u,p>4294967295&&(n=1),r.setUint32(a,p&4294967295,!0),e=n,n=0}}negate(){let t=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let r=n*4;t.setUint32(r,~t.getUint32(r,!0))}let e=new Uint8Array(ID_SIZE);e[0]=1,this.add(e)}getFingerprint(t){let e=new WrappedBuffer;return e.extend(this.buf),e.extend(encodeVarInt(t)),sha256_1(e.unwrap()).subarray(0,FINGERPRINT_SIZE)}},NegentropyStorageVector=class{items;sealed;constructor(){this.items=[],this.sealed=!1}insert(t,e){if(this.sealed)throw Error("already sealed");const n=hexToBytes(e);if(n.byteLength!==ID_SIZE)throw Error("bad id size for added item");this.items.push({timestamp:t,id:n})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(itemCompare);for(let t=1;t<this.items.length;t++)if(itemCompare(this.items[t-1],this.items[t])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(t){if(this._checkSealed(),t>=this.items.length)throw Error("out of range");return this.items[t]}iterate(t,e,n){this._checkSealed(),this._checkBounds(t,e);for(let r=t;r<e&&n(this.items[r],r);++r);}findLowerBound(t,e,n){return this._checkSealed(),this._checkBounds(t,e),this._binarySearch(this.items,t,e,r=>itemCompare(r,n)<0)}fingerprint(t,e){let n=new Accumulator;return n.setToZero(),this.iterate(t,e,r=>(n.add(r.id),!0)),n.getFingerprint(e-t)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(t,e){if(t>e||e>this.items.length)throw Error("bad range")}_binarySearch(t,e,n,r){let s=n-e;for(;s>0;){let o=e,a=Math.floor(s/2);o+=a,r(t[o])?(e=++o,s-=a+1):s=a}return e}},Negentropy=class{storage;frameSizeLimit;lastTimestampIn;lastTimestampOut;constructor(t,e=6e4){if(e<4096)throw Error("frameSizeLimit too small");this.storage=t,this.frameSizeLimit=e,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(t,e){return{timestamp:t,id:e||new Uint8Array(0)}}initiate(){let t=new WrappedBuffer;return t.extend(new Uint8Array([PROTOCOL_VERSION])),this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),t),bytesToHex(t.unwrap())}reconcile(t,e,n){const r=new WrappedBuffer(hexToBytes(t));this.lastTimestampIn=this.lastTimestampOut=0;let s=new WrappedBuffer;s.extend(new Uint8Array([PROTOCOL_VERSION]));let o=getByte(r);if(o<96||o>111)throw Error("invalid negentropy protocol version byte");if(o!==PROTOCOL_VERSION)throw Error("unsupported negentropy protocol version requested: "+(o-96));let a=this.storage.size(),l=this._bound(0),u=0,p=!1;for(;r.length!==0;){let y=new WrappedBuffer,b=()=>{p&&(p=!1,y.extend(this.encodeBound(l)),y.extend(encodeVarInt(Mode.Skip)))},w=this.decodeBound(r),_=decodeVarInt(r),x=u,T=this.storage.findLowerBound(u,a,w);if(_===Mode.Skip)p=!0;else if(_===Mode.Fingerprint){let k=getBytes(r,FINGERPRINT_SIZE),B=this.storage.fingerprint(x,T);compareUint8Array(k,B)!==0?(b(),this.splitRange(x,T,w,y)):p=!0}else if(_===Mode.IdList){let k=decodeVarInt(r),B={};for(let G=0;G<k;G++){let z=getBytes(r,ID_SIZE);B[bytesToHex(z)]=z}if(p=!0,this.storage.iterate(x,T,G=>{let z=G.id;const Q=bytesToHex(z);return B[Q]?delete B[bytesToHex(z)]:e?.(Q),!0}),n)for(let G of Object.values(B))n(bytesToHex(G))}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(s.length+y.length)){let k=this.storage.fingerprint(T,a);s.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),s.extend(encodeVarInt(Mode.Fingerprint)),s.extend(k);break}else s.extend(y);u=T,l=w}return s.length===1?null:bytesToHex(s.unwrap())}splitRange(t,e,n,r){let s=e-t,o=16;if(s<o*2)r.extend(this.encodeBound(n)),r.extend(encodeVarInt(Mode.IdList)),r.extend(encodeVarInt(s)),this.storage.iterate(t,e,a=>(r.extend(a.id),!0));else{let a=Math.floor(s/o),l=s%o,u=t;for(let p=0;p<o;p++){let y=a+(p<l?1:0),b=this.storage.fingerprint(u,u+y);u+=y;let w;if(u===e)w=n;else{let _,x;this.storage.iterate(u-1,u+1,(T,k)=>(k===u-1?_=T:x=T,!0)),w=this.getMinimalBound(_,x)}r.extend(this.encodeBound(w)),r.extend(encodeVarInt(Mode.Fingerprint)),r.extend(b)}}}exceededFrameSizeLimit(t){return t>this.frameSizeLimit-200}decodeTimestampIn(t){let e=decodeVarInt(t);return e=e===0?Number.MAX_VALUE:e-1,this.lastTimestampIn===Number.MAX_VALUE||e===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(e+=this.lastTimestampIn,this.lastTimestampIn=e,e)}decodeBound(t){let e=this.decodeTimestampIn(t),n=decodeVarInt(t);if(n>ID_SIZE)throw Error("bound key too long");let r=getBytes(t,n);return{timestamp:e,id:r}}encodeTimestampOut(t){if(t===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,encodeVarInt(0);let e=t;return t-=this.lastTimestampOut,this.lastTimestampOut=e,encodeVarInt(t+1)}encodeBound(t){let e=new WrappedBuffer;return e.extend(this.encodeTimestampOut(t.timestamp)),e.extend(encodeVarInt(t.id.length)),e.extend(t.id),e}getMinimalBound(t,e){if(e.timestamp!==t.timestamp)return this._bound(e.timestamp);{let n=0,r=e.id,s=t.id;for(let o=0;o<ID_SIZE&&r[o]===s[o];o++)n++;return this._bound(e.timestamp,e.id.subarray(0,n+1))}}};function compareUint8Array(t,e){for(let n=0;n<t.byteLength;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return t.byteLength>e.byteLength?1:t.byteLength<e.byteLength?-1:0}function itemCompare(t,e){return t.timestamp===e.timestamp?compareUint8Array(t.id,e.id):t.timestamp-e.timestamp}var NegentropySync=class{relay;storage;neg;filter;subscription;onhave;onneed;constructor(t,e,n,r={}){this.relay=t,this.storage=e,this.neg=new Negentropy(e),this.onhave=r.onhave,this.onneed=r.onneed,this.filter=n,this.subscription=this.relay.prepareSubscription([{}],{label:r.label||"negentropy"}),this.subscription.oncustom=s=>{switch(s[0]){case"NEG-MSG":{s.length<3&&console.warn(`got invalid NEG-MSG from ${this.relay.url}: ${s}`);try{const o=this.neg.reconcile(s[2],this.onhave,this.onneed);o?this.relay.send(`["NEG-MSG", "${this.subscription.id}", "${o}"]`):(this.close(),r.onclose?.())}catch(o){console.error("negentropy reconcile error:",o),r?.onclose?.(`reconcile error: ${o}`)}break}case"NEG-CLOSE":{const o=s[2];console.warn("negentropy error:",o),r.onclose?.(o);break}case"NEG-ERR":r.onclose?.()}}}async start(){const t=this.neg.initiate();this.relay.send(`["NEG-OPEN","${this.subscription.id}",${JSON.stringify(this.filter)},"${t}"]`)}close(){this.relay.send(`["NEG-CLOSE","${this.subscription.id}"]`),this.subscription.close()}},nip98_exports={};__export(nip98_exports,{getToken:()=>getToken,hashPayload:()=>hashPayload,unpackEventFromToken:()=>unpackEventFromToken,validateEvent:()=>validateEvent2,validateEventKind:()=>validateEventKind,validateEventMethodTag:()=>validateEventMethodTag,validateEventPayloadTag:()=>validateEventPayloadTag,validateEventTimestamp:()=>validateEventTimestamp,validateEventUrlTag:()=>validateEventUrlTag,validateToken:()=>validateToken});var _authorizationScheme="Nostr ";async function getToken(t,e,n,r=!1,s){const o={kind:HTTPAuth,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&o.tags.push(["payload",hashPayload(s)]);const a=await n(o);return(r?_authorizationScheme:"")+base64.encode(utf8Encoder$1.encode(JSON.stringify(a)))}async function validateToken(t,e,n){const r=await unpackEventFromToken(t).catch(o=>{throw o});return await validateEvent2(r,e,n).catch(o=>{throw o})}async function unpackEventFromToken(t){if(!t)throw new Error("Missing token");t=t.replace(_authorizationScheme,"");const e=utf8Decoder$1.decode(base64.decode(t));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function validateEventTimestamp(t){return t.created_at?Math.round(new Date().getTime()/1e3)-t.created_at<60:!1}function validateEventKind(t){return t.kind===HTTPAuth}function validateEventUrlTag(t,e){const n=t.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===e:!1}function validateEventMethodTag(t,e){const n=t.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===e.toLowerCase():!1}function hashPayload(t){const e=sha256_1(utf8Encoder$1.encode(JSON.stringify(t)));return utils.bytesToHex(e)}function validateEventPayloadTag(t,e){const n=t.tags.find(s=>s[0]==="payload");if(!n)return!1;const r=hashPayload(e);return n.length>0&&n[1]===r}async function validateEvent2(t,e,n,r){if(!verifyEvent(t))throw new Error("Invalid nostr event, signature invalid");if(!validateEventKind(t))throw new Error("Invalid nostr event, kind invalid");if(!validateEventTimestamp(t))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!validateEventUrlTag(t,e))throw new Error("Invalid nostr event, url tag invalid");if(!validateEventMethodTag(t,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!validateEventPayloadTag(t,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(e,n,r){const{entryExpirationTimeInMS:s=null,next:o=null,prev:a=null,onEntryEvicted:l,onEntryMarkedAsMostRecentlyUsed:u,clone:p,cloneFn:y}=r??{};if(typeof s=="number"&&(s<=0||Number.isNaN(s)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=p??!1,this.cloneFn=y??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(n):n,this.created=Date.now(),this.entryExpirationTimeInMS=s,this.next=o,this.prev=a,this.onEntryEvicted=l,this.onEntryMarkedAsMostRecentlyUsed=u}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:n,isExpired:r}=this;this.onEntryEvicted({key:e,value:n,isExpired:r})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:n}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:n})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(e){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:n=25,entryExpirationTimeInMS:r=null,onEntryEvicted:s,onEntryMarkedAsMostRecentlyUsed:o,cloneFn:a,clone:l}=e??{};if(Number.isNaN(n)||n<=0)throw new Error("maxSize must be greater than 0.");if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=n,this.entryExpirationTimeInMS=r,this.onEntryEvicted=s,this.onEntryMarkedAsMostRecentlyUsed=o,this.clone=l,this.cloneFn=a}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(e){if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=e,this.enforceSizeLimit()}set(e,n,r){const s=this.lookupTable.get(e);s&&this.removeNodeFromListAndLookupTable(s);const o=new LRUCacheNode_1.LRUCacheNode(e,n,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...r});return this.setNodeAsHead(o),this.lookupTable.set(e,o),this.enforceSizeLimit(),this}get(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):(this.setNodeAsHead(n),n.value):null}peek(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):n.value:null}delete(e){const n=this.lookupTable.get(e);return n?this.removeNodeFromListAndLookupTable(n):!1}has(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(e){let n=this.head;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}const r=this.mapNodeToEntry(n);if(e(r))return this.setNodeAsHead(n),r;n=n.next}return null}forEach(e){let n=this.head,r=0;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}e(n.value,n.key,r),n=n.next,r++}}*values(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.value,e=e.next}}*keys(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.key,e=e.next}}*entries(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}*[Symbol.iterator](){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}enforceSizeLimit(){let e=this.tail;for(;e!==null&&this.size>this.maxSizeInternal;){const n=e.prev;this.removeNodeFromListAndLookupTable(e),e=n}}mapNodeToEntry({key:e,value:n}){return{key:e,value:n}}setNodeAsHead(e){this.removeNodeFromList(e),this.head?(e.next=this.head,this.head.prev=e,this.head=e):(this.head=e,this.tail=e),e.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(e){e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.head===e&&(this.head=e.next),this.tail===e&&(this.tail=e.prev),e.next=null,e.prev=null}removeNodeFromListAndLookupTable(e){return e.invokeOnEvicted(),this.removeNodeFromList(e),this.lookupTable.delete(e.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const e=[];for(const n of this.lookupTable.values())n.isExpired&&e.push(n);e.forEach(n=>this.removeNodeFromListAndLookupTable(n))}}LRUCache$1.LRUCache=LRUCache;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,o,a){a===void 0&&(a=o);var l=Object.getOwnPropertyDescriptor(s,o);(!l||("get"in l?!s.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,a,l)}:function(r,s,o,a){a===void 0&&(a=o),r[a]=s[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var o in r)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&e(s,r,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(LRUCache$1,t)})(dist);var scrypt$1={},pbkdf2$1={};Object.defineProperty(pbkdf2$1,"__esModule",{value:!0});pbkdf2$1.pbkdf2=pbkdf2;var pbkdf2Async_1=pbkdf2$1.pbkdf2Async=pbkdf2Async;const hmac_ts_1=hmac,utils_ts_1$1=utils;function pbkdf2Init(t,e,n,r){(0,utils_ts_1$1.ahash)(t);const s=(0,utils_ts_1$1.checkOpts)({dkLen:32,asyncTick:10},r),{c:o,dkLen:a,asyncTick:l}=s;if((0,utils_ts_1$1.anumber)(o),(0,utils_ts_1$1.anumber)(a),(0,utils_ts_1$1.anumber)(l),o<1)throw new Error("iterations (c) should be >= 1");const u=(0,utils_ts_1$1.kdfInputToBytes)(e),p=(0,utils_ts_1$1.kdfInputToBytes)(n),y=new Uint8Array(a),b=hmac_ts_1.hmac.create(t,u),w=b._cloneInto().update(p);return{c:o,dkLen:a,asyncTick:l,DK:y,PRF:b,PRFSalt:w}}function pbkdf2Output(t,e,n,r,s){return t.destroy(),e.destroy(),r&&r.destroy(),(0,utils_ts_1$1.clean)(s),n}function pbkdf2(t,e,n,r){const{c:s,dkLen:o,DK:a,PRF:l,PRFSalt:u}=pbkdf2Init(t,e,n,r);let p;const y=new Uint8Array(4),b=(0,utils_ts_1$1.createView)(y),w=new Uint8Array(l.outputLen);for(let _=1,x=0;x<o;_++,x+=l.outputLen){const T=a.subarray(x,x+l.outputLen);b.setInt32(0,_,!1),(p=u._cloneInto(p)).update(y).digestInto(w),T.set(w.subarray(0,T.length));for(let k=1;k<s;k++){l._cloneInto(p).update(w).digestInto(w);for(let B=0;B<T.length;B++)T[B]^=w[B]}}return pbkdf2Output(l,u,a,p,w)}async function pbkdf2Async(t,e,n,r){const{c:s,dkLen:o,asyncTick:a,DK:l,PRF:u,PRFSalt:p}=pbkdf2Init(t,e,n,r);let y;const b=new Uint8Array(4),w=(0,utils_ts_1$1.createView)(b),_=new Uint8Array(u.outputLen);for(let x=1,T=0;T<o;x++,T+=u.outputLen){const k=l.subarray(T,T+u.outputLen);w.setInt32(0,x,!1),(y=p._cloneInto(y)).update(b).digestInto(_),k.set(_.subarray(0,k.length)),await(0,utils_ts_1$1.asyncLoop)(s-1,a,()=>{u._cloneInto(y).update(_).digestInto(_);for(let B=0;B<k.length;B++)k[B]^=_[B]})}return pbkdf2Output(u,p,l,y,_)}Object.defineProperty(scrypt$1,"__esModule",{value:!0});var scrypt_2=scrypt$1.scrypt=scrypt;scrypt$1.scryptAsync=scryptAsync;const pbkdf2_ts_1=pbkdf2$1,sha2_ts_1=sha2,utils_ts_1=utils;function XorAndSalsa(t,e,n,r,s,o){let a=t[e++]^n[r++],l=t[e++]^n[r++],u=t[e++]^n[r++],p=t[e++]^n[r++],y=t[e++]^n[r++],b=t[e++]^n[r++],w=t[e++]^n[r++],_=t[e++]^n[r++],x=t[e++]^n[r++],T=t[e++]^n[r++],k=t[e++]^n[r++],B=t[e++]^n[r++],G=t[e++]^n[r++],z=t[e++]^n[r++],Q=t[e++]^n[r++],ye=t[e++]^n[r++],ie=a,te=l,oe=u,ne=p,me=y,O=b,F=w,j=_,H=x,V=T,W=k,Z=B,ae=G,A=z,J=Q,X=ye;for(let de=0;de<8;de+=2)me^=(0,utils_ts_1.rotl)(ie+ae|0,7),H^=(0,utils_ts_1.rotl)(me+ie|0,9),ae^=(0,utils_ts_1.rotl)(H+me|0,13),ie^=(0,utils_ts_1.rotl)(ae+H|0,18),V^=(0,utils_ts_1.rotl)(O+te|0,7),A^=(0,utils_ts_1.rotl)(V+O|0,9),te^=(0,utils_ts_1.rotl)(A+V|0,13),O^=(0,utils_ts_1.rotl)(te+A|0,18),J^=(0,utils_ts_1.rotl)(W+F|0,7),oe^=(0,utils_ts_1.rotl)(J+W|0,9),F^=(0,utils_ts_1.rotl)(oe+J|0,13),W^=(0,utils_ts_1.rotl)(F+oe|0,18),ne^=(0,utils_ts_1.rotl)(X+Z|0,7),j^=(0,utils_ts_1.rotl)(ne+X|0,9),Z^=(0,utils_ts_1.rotl)(j+ne|0,13),X^=(0,utils_ts_1.rotl)(Z+j|0,18),te^=(0,utils_ts_1.rotl)(ie+ne|0,7),oe^=(0,utils_ts_1.rotl)(te+ie|0,9),ne^=(0,utils_ts_1.rotl)(oe+te|0,13),ie^=(0,utils_ts_1.rotl)(ne+oe|0,18),F^=(0,utils_ts_1.rotl)(O+me|0,7),j^=(0,utils_ts_1.rotl)(F+O|0,9),me^=(0,utils_ts_1.rotl)(j+F|0,13),O^=(0,utils_ts_1.rotl)(me+j|0,18),Z^=(0,utils_ts_1.rotl)(W+V|0,7),H^=(0,utils_ts_1.rotl)(Z+W|0,9),V^=(0,utils_ts_1.rotl)(H+Z|0,13),W^=(0,utils_ts_1.rotl)(V+H|0,18),ae^=(0,utils_ts_1.rotl)(X+J|0,7),A^=(0,utils_ts_1.rotl)(ae+X|0,9),J^=(0,utils_ts_1.rotl)(A+ae|0,13),X^=(0,utils_ts_1.rotl)(J+A|0,18);s[o++]=a+ie|0,s[o++]=l+te|0,s[o++]=u+oe|0,s[o++]=p+ne|0,s[o++]=y+me|0,s[o++]=b+O|0,s[o++]=w+F|0,s[o++]=_+j|0,s[o++]=x+H|0,s[o++]=T+V|0,s[o++]=k+W|0,s[o++]=B+Z|0,s[o++]=G+ae|0,s[o++]=z+A|0,s[o++]=Q+J|0,s[o++]=ye+X|0}function BlockMix(t,e,n,r,s){let o=r+0,a=r+16*s;for(let l=0;l<16;l++)n[a+l]=t[e+(2*s-1)*16+l];for(let l=0;l<s;l++,o+=16,e+=16)XorAndSalsa(n,a,t,e,n,o),l>0&&(a+=16),XorAndSalsa(n,o,t,e+=16,n,a)}function scryptInit(t,e,n){const r=(0,utils_ts_1.checkOpts)({dkLen:32,asyncTick:10,maxmem:1073742848},n),{N:s,r:o,p:a,dkLen:l,asyncTick:u,maxmem:p,onProgress:y}=r;if((0,utils_ts_1.anumber)(s),(0,utils_ts_1.anumber)(o),(0,utils_ts_1.anumber)(a),(0,utils_ts_1.anumber)(l),(0,utils_ts_1.anumber)(u),(0,utils_ts_1.anumber)(p),y!==void 0&&typeof y!="function")throw new Error("progressCb should be function");const b=128*o,w=b/4,_=Math.pow(2,32);if(s<=1||s&s-1||s>_)throw new Error("Scrypt: N must be larger than 1, a power of 2, and less than 2^32");if(a<0||a>(_-1)*32/b)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(l<0||l>(_-1)*32)throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");if(b*(s+a)>p)throw new Error("Scrypt: memused is bigger than maxMem. Expected 128 * r * (N + p) > maxmem of "+p);const T=(0,pbkdf2_ts_1.pbkdf2)(sha2_ts_1.sha256,t,e,{c:1,dkLen:b*a}),k=(0,utils_ts_1.u32)(T),B=(0,utils_ts_1.u32)(new Uint8Array(b*s)),G=(0,utils_ts_1.u32)(new Uint8Array(b));let z=()=>{};if(y){const Q=2*s*a,ye=Math.max(Math.floor(Q/1e4),1);let ie=0;z=()=>{ie++,y&&(!(ie%ye)||ie===Q)&&y(ie/Q)}}return{N:s,r:o,p:a,dkLen:l,blockSize32:w,V:B,B32:k,B:T,tmp:G,blockMixCb:z,asyncTick:u}}function scryptOutput(t,e,n,r,s){const o=(0,pbkdf2_ts_1.pbkdf2)(sha2_ts_1.sha256,t,n,{c:1,dkLen:e});return(0,utils_ts_1.clean)(n,r,s),o}function scrypt(t,e,n){const{N:r,r:s,p:o,dkLen:a,blockSize32:l,V:u,B32:p,B:y,tmp:b,blockMixCb:w}=scryptInit(t,e,n);(0,utils_ts_1.swap32IfBE)(p);for(let _=0;_<o;_++){const x=l*_;for(let T=0;T<l;T++)u[T]=p[x+T];for(let T=0,k=0;T<r-1;T++)BlockMix(u,k,u,k+=l,s),w();BlockMix(u,(r-1)*l,p,x,s),w();for(let T=0;T<r;T++){const k=p[x+l-16]%r;for(let B=0;B<l;B++)b[B]=p[x+B]^u[k*l+B];BlockMix(b,0,p,x,s),w()}}return(0,utils_ts_1.swap32IfBE)(p),scryptOutput(t,a,y,u,b)}async function scryptAsync(t,e,n){const{N:r,r:s,p:o,dkLen:a,blockSize32:l,V:u,B32:p,B:y,tmp:b,blockMixCb:w,asyncTick:_}=scryptInit(t,e,n);(0,utils_ts_1.swap32IfBE)(p);for(let x=0;x<o;x++){const T=l*x;for(let B=0;B<l;B++)u[B]=p[T+B];let k=0;await(0,utils_ts_1.asyncLoop)(r-1,_,()=>{BlockMix(u,k,u,k+=l,s),w()}),BlockMix(u,(r-1)*l,p,T,s),w(),await(0,utils_ts_1.asyncLoop)(r,_,()=>{const B=p[T+l-16]%r;for(let G=0;G<l;G++)b[G]=p[T+G]^u[B*l+G];BlockMix(b,0,p,T,s),w()})}return(0,utils_ts_1.swap32IfBE)(p),scryptOutput(t,a,y,u,b)}var Bech32MaxSize$1=5e3;function encodeBech32$1(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize$1)}function encodeBytes$1(t,e){return encodeBech32$1(t,e)}function encrypt$2(t,e,n=16,r=2){let s=utils.randomBytes(16),o=2**n,a=scrypt_2(e.normalize("NFKC"),s,{N:o,r:8,p:1,dkLen:32}),l=utils.randomBytes(24),u=Uint8Array.from([r]),y=xchacha20poly1305(a,l,u).encrypt(t),b=utils.concatBytes(Uint8Array.from([2]),Uint8Array.from([n]),s,l,u,y);return encodeBytes$1("ncryptsec",b)}function decrypt$2(t,e){let{prefix:n,words:r}=bech32$1.decode(t,Bech32MaxSize$1);if(n!=="ncryptsec")throw new Error(`invalid prefix ${n}, expected 'ncryptsec'`);let s=new Uint8Array(bech32$1.fromWords(r)),o=s[0];if(o!==2)throw new Error(`invalid version ${o}, expected 0x02`);let l=2**s[1],u=s.slice(2,18),p=s.slice(18,42),y=s[42],b=Uint8Array.from([y]),w=s.slice(43),_=scrypt_2(e.normalize("NFKC"),u,{N:l,r:8,p:1,dkLen:32});return xchacha20poly1305(_,p,b).decrypt(w)}const nip49_star=Object.freeze(Object.defineProperty({__proto__:null,decrypt:decrypt$2,encrypt:encrypt$2},Symbol.toStringTag,{value:"Module"}));var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder=new TextEncoder,NostrTypeGuard={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode(t)}catch{return{type:"invalid",data:null}}}function decode(t){let{prefix:e,words:n}=bech32$1.decode(t,Bech32MaxSize),r=new Uint8Array(bech32$1.fromWords(n));switch(e){case"nprofile":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:utils.bytesToHex(s[0][0]),relays:s[1]?s[1].map(o=>utf8Decoder.decode(o)):[]}}}case"nevent":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:utils.bytesToHex(s[0][0]),relays:s[1]?s[1].map(o=>utf8Decoder.decode(o)):[],author:s[2]?.[0]?utils.bytesToHex(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(utils.bytesToHex(s[3][0]),16):void 0}}}case"naddr":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(s[0][0]),pubkey:utils.bytesToHex(s[2][0]),kind:parseInt(utils.bytesToHex(s[3][0]),16),relays:s[1]?s[1].map(o=>utf8Decoder.decode(o)):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:utils.bytesToHex(r)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV(t){let e={},n=t;for(;n.length>0;){let r=n[0],s=n[1],o=n.slice(2,2+s);if(n=n.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(o)}return e}function nsecEncode(t){return encodeBytes("nsec",t)}function npubEncode(t){return encodeBytes("npub",utils.hexToBytes(t))}function noteEncode(t){return encodeBytes("note",utils.hexToBytes(t))}function encodeBech32(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize)}function encodeBytes(t,e){return encodeBech32(t,e)}function nprofileEncode(t){let e=encodeTLV({0:[utils.hexToBytes(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder.encode(n))});return encodeBech32("nprofile",e)}function neventEncode(t){let e;t.kind!==void 0&&(e=integerToUint8Array(t.kind));let n=encodeTLV({0:[utils.hexToBytes(t.id)],1:(t.relays||[]).map(r=>utf8Encoder.encode(r)),2:t.author?[utils.hexToBytes(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32("nevent",n)}function naddrEncode(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV({0:[utf8Encoder.encode(t.identifier)],1:(t.relays||[]).map(r=>utf8Encoder.encode(r)),2:[utils.hexToBytes(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32("naddr",n)}function encodeTLV(t){let e=[];return Object.entries(t).reverse().forEach(([n,r])=>{r.forEach(s=>{let o=new Uint8Array(s.length+2);o.set([parseInt(n)],0),o.set([s.length],1),o.set(s,2),e.push(o)})}),utils.concatBytes(...e)}const nip19_star=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX:BECH32_REGEX$1,Bech32MaxSize,NostrTypeGuard,decode,decodeNostrURI,encodeBytes,naddrEncode,neventEncode,noteEncode,nprofileEncode,npubEncode,nsecEncode},Symbol.toStringTag,{value:"Module"}));var lib={};(function(t){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(t,"__esModule",{value:!0}),t.bytes=t.stringToBytes=t.str=t.bytesToString=t.hex=t.utf8=t.bech32m=t.bech32=t.base58check=t.base58xmr=t.base58xrp=t.base58flickr=t.base58=t.base64url=t.base64=t.base32crockford=t.base32hex=t.base32=t.base16=t.utils=t.assertNumber=void 0;function e(O){if(!Number.isSafeInteger(O))throw new Error(`Wrong integer: ${O}`)}t.assertNumber=e;function n(...O){const F=(V,W)=>Z=>V(W(Z)),j=Array.from(O).reverse().reduce((V,W)=>V?F(V,W.encode):W.encode,void 0),H=O.reduce((V,W)=>V?F(V,W.decode):W.decode,void 0);return{encode:j,decode:H}}function r(O){return{encode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return F.map(j=>{if(e(j),j<0||j>=O.length)throw new Error(`Digit index outside alphabet: ${j} (alphabet: ${O.length})`);return O[j]})},decode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="string")throw new Error("alphabet.decode input should be array of strings");return F.map(j=>{if(typeof j!="string")throw new Error(`alphabet.decode: not string element=${j}`);const H=O.indexOf(j);if(H===-1)throw new Error(`Unknown letter: "${j}". Allowed: ${O}`);return H})}}}function s(O=""){if(typeof O!="string")throw new Error("join separator should be string");return{encode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="string")throw new Error("join.encode input should be array of strings");for(let j of F)if(typeof j!="string")throw new Error(`join.encode: non-string input=${j}`);return F.join(O)},decode:F=>{if(typeof F!="string")throw new Error("join.decode input should be string");return F.split(O)}}}function o(O,F="="){if(e(O),typeof F!="string")throw new Error("padding chr should be string");return{encode(j){if(!Array.isArray(j)||j.length&&typeof j[0]!="string")throw new Error("padding.encode input should be array of strings");for(let H of j)if(typeof H!="string")throw new Error(`padding.encode: non-string input=${H}`);for(;j.length*O%8;)j.push(F);return j},decode(j){if(!Array.isArray(j)||j.length&&typeof j[0]!="string")throw new Error("padding.encode input should be array of strings");for(let V of j)if(typeof V!="string")throw new Error(`padding.decode: non-string input=${V}`);let H=j.length;if(H*O%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;H>0&&j[H-1]===F;H--)if(!((H-1)*O%8))throw new Error("Invalid padding: string has too much padding");return j.slice(0,H)}}}function a(O){if(typeof O!="function")throw new Error("normalize fn should be function");return{encode:F=>F,decode:F=>O(F)}}function l(O,F,j){if(F<2)throw new Error(`convertRadix: wrong from=${F}, base cannot be less than 2`);if(j<2)throw new Error(`convertRadix: wrong to=${j}, base cannot be less than 2`);if(!Array.isArray(O))throw new Error("convertRadix: data should be array");if(!O.length)return[];let H=0;const V=[],W=Array.from(O);for(W.forEach(Z=>{if(e(Z),Z<0||Z>=F)throw new Error(`Wrong integer: ${Z}`)});;){let Z=0,ae=!0;for(let A=H;A<W.length;A++){const J=W[A],X=F*Z+J;if(!Number.isSafeInteger(X)||F*Z/F!==Z||X-J!==F*Z)throw new Error("convertRadix: carry overflow");if(Z=X%j,W[A]=Math.floor(X/j),!Number.isSafeInteger(W[A])||W[A]*j+Z!==X)throw new Error("convertRadix: carry overflow");if(ae)W[A]?ae=!1:H=A;else continue}if(V.push(Z),ae)break}for(let Z=0;Z<O.length-1&&O[Z]===0;Z++)V.push(0);return V.reverse()}const u=(O,F)=>F?u(F,O%F):O,p=(O,F)=>O+(F-u(O,F));function y(O,F,j,H){if(!Array.isArray(O))throw new Error("convertRadix2: data should be array");if(F<=0||F>32)throw new Error(`convertRadix2: wrong from=${F}`);if(j<=0||j>32)throw new Error(`convertRadix2: wrong to=${j}`);if(p(F,j)>32)throw new Error(`convertRadix2: carry overflow from=${F} to=${j} carryBits=${p(F,j)}`);let V=0,W=0;const Z=2**j-1,ae=[];for(const A of O){if(e(A),A>=2**F)throw new Error(`convertRadix2: invalid data word=${A} from=${F}`);if(V=V<<F|A,W+F>32)throw new Error(`convertRadix2: carry overflow pos=${W} from=${F}`);for(W+=F;W>=j;W-=j)ae.push((V>>W-j&Z)>>>0);V&=2**W-1}if(V=V<<j-W&Z,!H&&W>=F)throw new Error("Excess padding");if(!H&&V)throw new Error(`Non-zero padding: ${V}`);return H&&W>0&&ae.push(V>>>0),ae}function b(O){return e(O),{encode:F=>{if(!(F instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return l(Array.from(F),2**8,O)},decode:F=>{if(!Array.isArray(F)||F.length&&typeof F[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(l(F,O,2**8))}}}function w(O,F=!1){if(e(O),O<=0||O>32)throw new Error("radix2: bits should be in (0..32]");if(p(8,O)>32||p(O,8)>32)throw new Error("radix2: carry overflow");return{encode:j=>{if(!(j instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return y(Array.from(j),8,O,!F)},decode:j=>{if(!Array.isArray(j)||j.length&&typeof j[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(y(j,O,8,F))}}}function _(O){if(typeof O!="function")throw new Error("unsafeWrapper fn should be function");return function(...F){try{return O.apply(null,F)}catch{}}}function x(O,F){if(e(O),typeof F!="function")throw new Error("checksum fn should be function");return{encode(j){if(!(j instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const H=F(j).slice(0,O),V=new Uint8Array(j.length+O);return V.set(j),V.set(H,j.length),V},decode(j){if(!(j instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const H=j.slice(0,-O),V=F(H).slice(0,O),W=j.slice(-O);for(let Z=0;Z<O;Z++)if(V[Z]!==W[Z])throw new Error("Invalid checksum");return H}}}t.utils={alphabet:r,chain:n,checksum:x,radix:b,radix2:w,join:s,padding:o},t.base16=n(w(4),r("0123456789ABCDEF"),s("")),t.base32=n(w(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),o(5),s("")),t.base32hex=n(w(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),o(5),s("")),t.base32crockford=n(w(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),a(O=>O.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),t.base64=n(w(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),o(6),s("")),t.base64url=n(w(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),o(6),s(""));const T=O=>n(b(58),r(O),s(""));t.base58=T("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.base58flickr=T("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),t.base58xrp=T("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const k=[0,2,3,5,6,7,9,10,11];t.base58xmr={encode(O){let F="";for(let j=0;j<O.length;j+=8){const H=O.subarray(j,j+8);F+=t.base58.encode(H).padStart(k[H.length],"1")}return F},decode(O){let F=[];for(let j=0;j<O.length;j+=11){const H=O.slice(j,j+11),V=k.indexOf(H.length),W=t.base58.decode(H);for(let Z=0;Z<W.length-V;Z++)if(W[Z]!==0)throw new Error("base58xmr: wrong padding");F=F.concat(Array.from(W.slice(W.length-V)))}return Uint8Array.from(F)}};const B=O=>n(x(4,F=>O(O(F))),t.base58);t.base58check=B;const G=n(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),z=[996825010,642813549,513874426,1027748829,705979059];function Q(O){const F=O>>25;let j=(O&33554431)<<5;for(let H=0;H<z.length;H++)(F>>H&1)===1&&(j^=z[H]);return j}function ye(O,F,j=1){const H=O.length;let V=1;for(let W=0;W<H;W++){const Z=O.charCodeAt(W);if(Z<33||Z>126)throw new Error(`Invalid prefix (${O})`);V=Q(V)^Z>>5}V=Q(V);for(let W=0;W<H;W++)V=Q(V)^O.charCodeAt(W)&31;for(let W of F)V=Q(V)^W;for(let W=0;W<6;W++)V=Q(V);return V^=j,G.encode(y([V%2**30],30,5,!1))}function ie(O){const F=O==="bech32"?1:734539939,j=w(5),H=j.decode,V=j.encode,W=_(H);function Z(X,de,ve=90){if(typeof X!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof X}`);if(!Array.isArray(de)||de.length&&typeof de[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof de}`);const we=X.length+7+de.length;if(ve!==!1&&we>ve)throw new TypeError(`Length ${we} exceeds limit ${ve}`);return X=X.toLowerCase(),`${X}1${G.encode(de)}${ye(X,de,F)}`}function ae(X,de=90){if(typeof X!="string")throw new Error(`bech32.decode input should be string, not ${typeof X}`);if(X.length<8||de!==!1&&X.length>de)throw new TypeError(`Wrong string length: ${X.length} (${X}). Expected (8..${de})`);const ve=X.toLowerCase();if(X!==ve&&X!==X.toUpperCase())throw new Error("String must be lowercase or uppercase");X=ve;const we=X.lastIndexOf("1");if(we===0||we===-1)throw new Error('Letter "1" must be present between prefix and data only');const Ce=X.slice(0,we),Re=X.slice(we+1);if(Re.length<6)throw new Error("Data must be at least 6 characters long");const De=G.decode(Re).slice(0,-6),Ke=ye(Ce,De,F);if(!Re.endsWith(Ke))throw new Error(`Invalid checksum in ${X}: expected "${Ke}"`);return{prefix:Ce,words:De}}const A=_(ae);function J(X){const{prefix:de,words:ve}=ae(X,!1);return{prefix:de,words:ve,bytes:H(ve)}}return{encode:Z,decode:ae,decodeToBytes:J,decodeUnsafe:A,fromWords:H,fromWordsUnsafe:W,toWords:V}}t.bech32=ie("bech32"),t.bech32m=ie("bech32m"),t.utf8={encode:O=>new TextDecoder().decode(O),decode:O=>new TextEncoder().encode(O)},t.hex=n(w(4),r("0123456789abcdef"),s(""),a(O=>{if(typeof O!="string"||O.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof O} with length ${O.length}`);return O.toLowerCase()}));const te={utf8:t.utf8,hex:t.hex,base16:t.base16,base32:t.base32,base64:t.base64,base64url:t.base64url,base58:t.base58,base58xmr:t.base58xmr},oe=`Invalid encoding type. Available types: ${Object.keys(te).join(", ")}`,ne=(O,F)=>{if(typeof O!="string"||!te.hasOwnProperty(O))throw new TypeError(oe);if(!(F instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return te[O].encode(F)};t.bytesToString=ne,t.str=t.bytesToString;const me=(O,F)=>{if(!te.hasOwnProperty(O))throw new TypeError(oe);if(typeof F!="string")throw new TypeError("stringToBytes() expects string");return te[O].decode(F)};t.stringToBytes=me,t.bytes=t.stringToBytes})(lib);const{bech32,hex,utf8}=lib;BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let t=0,e=Object.keys(TAGCODES);t<e.length;t++)e[t],TAGCODES[e[t]].toString();var __defProp$1=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__getOwnPropNames$1=Object.getOwnPropertyNames,__hasOwnProp$1=Object.prototype.hasOwnProperty,__copyProps$1=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of __getOwnPropNames$1(e))!__hasOwnProp$1.call(t,s)&&s!==n&&__defProp$1(t,s,{get:()=>e[s],enumerable:!(r=__getOwnPropDesc$1(e,s))||r.enumerable});return t},__reExport$1=(t,e,n)=>(__copyProps$1(t,e,"default"),n);function getRelaysForSync$1(t,e,n="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);if(r)return n==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor$1(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync$1(t,e,n)}function getTopRelaysForAuthors$1(t,e){const n=new Map;return e.forEach(s=>{const o=getRelaysForSync$1(t,s);o&&o.forEach(a=>{const l=n.get(a)||0;n.set(a,l+1)})}),Array.from(n.entries()).sort((s,o)=>o[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys$1(t,e,n="read"){const r=new Map,s=new Set;return e.forEach(o=>{const a=getRelaysForSync$1(t,o,n);a&&a.size>0?(a.forEach(l=>{(r.get(l)||new Set).add(o)}),r.set(o,a)):s.add(o)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys$1(t,e,n,{count:r,preferredRelays:s}={}){r??=2,s??=new Set;const o=t.pool,a=o.connectedRelays();a.forEach(w=>{s?.add(w.url)});const l=new Map,{pubkeysToRelays:u,authorsMissingRelays:p}=getAllRelaysForAllPubkeys$1(t,e,n),y=getTopRelaysForAuthors$1(t,e),b=(w,_)=>{const x=l.get(_)||[];x.push(w),l.set(_,x)};for(const[w,_]of u.entries()){let x=r;const T=new Set;for(const k of a)_.has(k.url)&&(b(w,k.url),T.add(k.url),x--);for(const k of _)T.has(k)||l.has(k)&&(b(w,k),T.add(k),x--);if(!(x<=0))for(const k of y){if(x<=0)break;T.has(k)||_.has(k)&&(b(w,k),T.add(k),x--)}}for(const w of p)o.permanentAndConnectedRelays().forEach(_=>{const x=l.get(_.url)||[];x.push(w),l.set(_.url,x)});return l}function getRelaysForFilterWithAuthors(t,e,n=2){return chooseRelayCombinationForPubkeys$1(t,e,"write",{count:n})}function tryNormalizeRelayUrl(t){try{return normalizeRelayUrl$1(t)}catch{return}}function normalizeRelayUrl$1(t){let e=normalizeUrl$1(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function normalize(t){const e=new Set;for(const n of t)try{e.add(normalizeRelayUrl$1(n))}catch{}return Array.from(e)}var DATA_URL_DEFAULT_MIME_TYPE$1="text/plain",DATA_URL_DEFAULT_CHARSET$1="us-ascii",testParameter$1=(t,e)=>e.some(n=>n instanceof RegExp?n.test(t):n===t),supportedProtocols$1=new Set(["https:","http:","file:"]),hasCustomProtocol$1=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols$1.has(e)}catch{return!1}},normalizeDataURL$1=(t,{stripHash:e})=>{const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);const r=n.groups?.type??"",s=n.groups?.data??"";let o=n.groups?.hash??"";const a=r.split(";");o=e?"":o;let l=!1;a[a.length-1]==="base64"&&(a.pop(),l=!0);const u=a.shift()?.toLowerCase()??"",y=[...a.map(b=>{let[w,_=""]=b.split("=").map(x=>x.trim());return w==="charset"&&(_=_.toLowerCase(),_===DATA_URL_DEFAULT_CHARSET$1)?"":`${w}${_?`=${_}`:""}`}).filter(Boolean)];return l&&y.push("base64"),(y.length>0||u&&u!==DATA_URL_DEFAULT_MIME_TYPE$1)&&y.unshift(u),`data:${y.join(";")},${l?s.trim():s}${o?`#${o}`:""}`};function normalizeUrl$1(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL$1(t,e);if(hasCustomProtocol$1(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(t);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let l=0,u="";for(;;){const y=a.exec(s.pathname);if(!y)break;const b=y[0],w=y.index,_=s.pathname.slice(l,w);u+=_.replace(/\/{2,}/g,"/"),u+=b,l=w+b.length}const p=s.pathname.slice(l,s.pathname.length);u+=p.replace(/\/{2,}/g,"/"),s.pathname=u}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let a=s.pathname.split("/");const l=a[a.length-1];testParameter$1(l,e.removeDirectoryIndex)&&(a=a.slice(0,-1),s.pathname=`${a.slice(1).join("/")}/`)}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const a of[...s.searchParams.keys()])testParameter$1(a,e.removeQueryParameters)&&s.searchParams.delete(a);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const a of[...s.searchParams.keys()])testParameter$1(a,e.keepQueryParameters)||s.searchParams.delete(a);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const o=t;return t=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!o.endsWith("/")&&s.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var NDKRelayKeepalive$1=class{constructor(e=3e4,n){this.onSilenceDetected=n,this.timeout=e}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const e=Date.now()-this.lastActivity;if(e>=this.timeout)this.onSilenceDetected();else{const n=this.timeout-e;this.timer=setTimeout(()=>{this.onSilenceDetected()},n)}},this.timeout)}};async function probeRelayConnection$1(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(n=>{let r=!1;const s=setTimeout(()=>{r||(r=!0,t.send(["CLOSE",e]),n(!1))},5e3),o=()=>{r||(r=!0,clearTimeout(s),t.send(["CLOSE",e]),n(!0))};t.once("message",o),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS$1=5,FLAPPING_THRESHOLD_MS$1=1e3,NDKRelayConnectivity$1=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;pendingAuthPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(e,n){this.ndkRelay=e,this._status=1;const r=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${r}`),this.ndk=n,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive$1(12e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection$1({send:n=>this.send(JSON.stringify(n)),once:(n,r)=>{const s=o=>{try{const a=JSON.parse(o.data);(a[0]==="EOSE"||a[0]==="EVENT"||a[0]==="NOTICE")&&(r(),this.ws?.removeEventListener("message",s))}catch{}};this.ws?.addEventListener("message",s)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const e=Date.now(),n=e-this.lastSleepCheck;n>15e3&&(this.debug(`Detected possible sleep/wake (${n}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=e},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection$1({send:e=>this.send(JSON.stringify(e)),once:(e,n)=>{const r=s=>{try{const o=JSON.parse(s.data);(o[0]==="EOSE"||o[0]==="EVENT"||o[0]==="NOTICE")&&(n(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}}).then(e=>{e||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(e,n=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),e??=this.timeoutMs,!this.timeoutMs&&e&&(this.timeoutMs=e),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(n),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(r){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,r),this._status=1,n?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),r}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(e){this.debug("Failed to disconnect",e),this._status=1}}onConnectionError(e){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),e&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this.clearPendingPublishes(new Error(`Relay ${this.ndkRelay.url} disconnected`)),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(e){this.netDebug?.(e.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const n=JSON.parse(e.data),[r,s,...o]=n,a=this.ndkRelay.getProtocolHandler(r);if(a){a(this.ndkRelay,n);return}switch(r){case"EVENT":{const l=this.openSubs.get(s),u=n[2];if(!l){this.debug(`Received event for unknown subscription ${s}`);return}l.onevent(u);return}case"COUNT":{const l=n[2],u=this.openCountRequests.get(s);u&&(u.resolve(l.count),this.openCountRequests.delete(s));return}case"EOSE":{const l=this.openSubs.get(s);if(!l)return;l.oneose(s);return}case"OK":{const l=n[2],u=n[3],p=this.openEventPublishes.get(s),y=p?.pop();if(!p||!y){this.debug("Received OK for unknown event publish",s);return}l?(y.resolve(u),this.pendingAuthPublishes.delete(s)):u&&(u.toLowerCase().includes("auth-required")||u.toLowerCase().includes("not authorized")||u.toLowerCase().includes("blocked: not authorized"))?this.pendingAuthPublishes.get(s)?(this.debug("Publish failed due to auth-required, will retry after auth",s),p.push(y),this.openEventPublishes.set(s,p)):y.reject(new Error(u)):(y.reject(new Error(u)),this.pendingAuthPublishes.delete(s)),p.length===0?this.openEventPublishes.delete(s):!l&&!(u?.toLowerCase().includes("auth-required")||u?.toLowerCase().includes("not authorized")||u?.toLowerCase().includes("blocked: not authorized"))&&this.openEventPublishes.set(s,p);return}case"CLOSED":{const l=this.openSubs.get(s);if(!l)return;l.onclosed(n[2]);return}case"NOTICE":this.onNotice(n[1]);return;case"AUTH":{this.onAuthRequested(n[1]);return}}}catch(n){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${n.message}`,n?.stack);return}}async onAuthRequested(e){const n=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!n}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,n){if(this._status>=5){this._status=7;let r;try{r=await n(this.ndkRelay,e)}catch(s){this.debug("Authentication policy threw an error",s),r=!1}if(this.debug("Authentication policy returned",!!r),r instanceof NDKEvent$1||r===!0){r instanceof NDKEvent$1&&await this.auth(r);const s=async()=>{if(this._status>=5&&this._status<8){const o=new NDKEvent$1(this.ndk);o.kind=22242,o.tags=[["relay",this.ndkRelay.url],["challenge",e]],await o.sign(),this.auth(o).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful"),this.retryPendingAuthPublishes()}).catch(a=>{this._status=6,this.ndkRelay.emit("auth:failed",a),this.debug("Authentication failed",a),this.rejectPendingAuthPublishes(a)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};r===!0&&(this.ndk?.signer?s().catch(o=>{console.error("Error authenticating",o)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",s))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",e)}onError(e){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,e)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const e=this._connectionStats.durations;if(e.length%3!==0)return!1;const r=e.reduce((l,u)=>l+u,0)/e.length,s=e.map(l=>(l-r)**2).reduce((l,u)=>l+u,0)/e.length;return Math.sqrt(s)<FLAPPING_THRESHOLD_MS$1}async onNotice(e){this.ndkRelay.emit("notice",e)}handleReconnection(e=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let n;if(this.wasIdle){const r=[0,1e3,2e3,5e3,1e4,3e4];n=r[Math.min(e,r.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${e}, delay ${n}ms`)}else this.connectedAt?n=Math.max(0,6e4-(Date.now()-this.connectedAt)):(n=Math.min(1e3*2**e,3e4),this.debug(`Using standard backoff, attempt ${e}, delay ${n}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(r=>{e<MAX_RECONNECT_ATTEMPTS$1?this.handleReconnection(e+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},n),this.ndkRelay.emit("delayed-connect",n),this.debug("Reconnecting in",n),this._connectionStats.nextReconnectAt=Date.now()+n}async send(e){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(e),this.netDebug?.(e,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${e}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(e){const n=new Promise((r,s)=>{const o=this.openEventPublishes.get(e.id)??[];o.push({resolve:r,reject:s}),this.openEventPublishes.set(e.id,o)});return this.send(`["AUTH",${JSON.stringify(e.rawEvent())}]`),n}clearPendingPublishes(e){this.rejectPendingAuthPublishes(e);for(const[n,r]of this.openEventPublishes.entries()){for(;r.length>0;){const s=r.shift();s&&s.reject(e)}this.openEventPublishes.delete(n)}}retryPendingAuthPublishes(){if(this.pendingAuthPublishes.size!==0){this.debug(`Retrying ${this.pendingAuthPublishes.size} pending publishes after auth`);for(const[e,n]of this.pendingAuthPublishes.entries())this.debug(`Retrying publish for event ${e}`),this.send(`["EVENT",${JSON.stringify(n)}]`);this.pendingAuthPublishes.clear()}}rejectPendingAuthPublishes(e){if(this.pendingAuthPublishes.size!==0){this.debug(`Rejecting ${this.pendingAuthPublishes.size} pending publishes due to auth failure`);for(const[n]of this.pendingAuthPublishes.entries()){const r=this.openEventPublishes.get(n);if(r&&r.length>0){const s=r.pop();s&&s.reject(new Error(`Authentication failed: ${e.message}`)),r.length===0&&this.openEventPublishes.delete(n)}}this.pendingAuthPublishes.clear()}}async publish(e){const n=new Promise((r,s)=>{const o=this.openEventPublishes.get(e.id)??[];o.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${e.id} twice`),o.push({resolve:r,reject:s}),this.openEventPublishes.set(e.id,o)});return this.pendingAuthPublishes.set(e.id,e),this.send(`["EVENT",${JSON.stringify(e)}]`),n}async count(e,n){this.serial++;const r=n?.id||`count:${this.serial}`,s=new Promise((o,a)=>{this.openCountRequests.set(r,{resolve:o,reject:a})});return this.send(`["COUNT","${r}",${JSON.stringify(e).substring(1)}`),s}close(e,n){this.send(`["CLOSE","${e}"]`);const r=this.openSubs.get(e);this.openSubs.delete(e),r&&r.onclose(n)}req(e){`${this.send(`["REQ","${e.subId}",${JSON.stringify(e.executeFilters).substring(1)}`)}`,this.openSubs.set(e.subId,e)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}};async function fetchRelayInformation(t){const e=t.replace(/^wss:\/\//,"https://").replace(/^ws:\/\//,"http://"),n=await fetch(e,{headers:{Accept:"application/nostr+json"}});if(!n.ok)throw new Error(`Failed to fetch relay information: ${n.status} ${n.statusText}`);return await n.json()}var NDKRelayPublisher$1=class{ndkRelay;debug;constructor(e){this.ndkRelay=e,this.debug=e.debug.extend("publisher")}async publish(e,n=2500){let r;const s=()=>new Promise((b,w)=>{try{this.publishEvent(e).then(_=>{this.ndkRelay.emit("published",e),e.emit("relay:published",this.ndkRelay),b(!0)}).catch(w)}catch(_){w(_)}}),o=new Promise((b,w)=>{r=setTimeout(()=>{r=void 0,w(new Error(`Timeout: ${n}ms`))},n)}),a=()=>{s().then(b=>l(b)).catch(b=>u(b))};let l,u;const p=b=>{throw this.ndkRelay.debug("Publish failed",b,e.id),this.ndkRelay.emit("publish:failed",e,b),e.emit("relay:publish:failed",this.ndkRelay,b),b},y=()=>{r&&clearTimeout(r),this.ndkRelay.removeListener("connect",a)};return this.ndkRelay.status>=5?Promise.race([s(),o]).catch(p).finally(y):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((b,w)=>{l=b,u=w,this.ndkRelay.on("connect",a)}),o]).catch(p).finally(y))}async publishEvent(e){return this.ndkRelay.connectivity.publish(e.rawEvent())}};function filterFingerprint$1(t,e){const n=[];for(const s of t){const o=Object.entries(s||{}).map(([a,l])=>["since","until"].includes(a)?`${a}:${l}`:a).sort().join("-");n.push(o)}let r=e?"+":"";return r+=n.join("|"),r}function mergeFilters$1(t){const e=[],n={};return t.filter(r=>!!r.limit).forEach(r=>e.push(r)),t=t.filter(r=>!r.limit),t.length===0?e:(t.forEach(r=>{Object.entries(r).forEach(([s,o])=>{Array.isArray(o)?n[s]===void 0?n[s]=[...o]:n[s]=Array.from(new Set([...n[s],...o])):n[s]=o})}),[...e,n])}var MAX_ITEMS=3;function formatArray(t,e){const r=(e?t.slice(0,MAX_ITEMS).map(e):t.slice(0,MAX_ITEMS)).join(",");return t.length>MAX_ITEMS?`${r}+${t.length-MAX_ITEMS}`:r}function formatFilters(t){return t.map(e=>{const n=[];e.ids?.length&&n.push(`ids:[${formatArray(e.ids,r=>String(r).slice(0,8))}]`),e.kinds?.length&&n.push(`kinds:[${formatArray(e.kinds)}]`),e.authors?.length&&n.push(`authors:[${formatArray(e.authors,r=>String(r).slice(0,8))}]`),e.since&&n.push(`since:${e.since}`),e.until&&n.push(`until:${e.until}`),e.limit&&n.push(`limit:${e.limit}`),e.search&&n.push(`search:"${String(e.search).slice(0,20)}"`);for(const[r,s]of Object.entries(e))r.startsWith("#")&&Array.isArray(s)&&s.length>0&&n.push(`${r}:[${formatArray(s,o=>String(o).slice(0,8))}]`);return`{${n.join(" ")}}`}).join(", ")}var NDKRelaySubscription$1=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(e,n,r){this.relay=e,this.topSubManager=r,this.debug=e.debug.extend(`sub[${this.id}]`),this.fingerprint=n||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(e){this.subIdParts.add(e)}addItem(e,n){if(this.debug("Adding item",{filters:formatFilters(n),internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,itemsSize:this.items.size}),!this.items.has(e.internalId))switch(e.on("close",this.removeItem.bind(this,e)),this.items.set(e.internalId,{subscription:e,filters:n}),this.status!==3&&e.subId&&(!this._subId||this._subId.length<25)&&(this.status===0||this.status===1)&&this.addSubIdPart(e.subId),this.status){case 0:this.evaluateExecutionPlan(e);break;case 3:break;case 1:this.evaluateExecutionPlan(e);break;case 4:throw this.debug("Subscription is closed, cannot add new items",{filters:formatFilters(n),subId:e.subId,internalId:e.internalId}),new Error("Cannot add new items to a closed subscription")}}removeItem(e){if(this.items.delete(e.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const e=this.status;if(this.status=4,e===3)try{this.relay.close(this.subId)}catch(n){this.debug("Error closing subscription",n,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:e,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(e){if(!e.isGroupable()){this.status=1,this.execute();return}if(e.filters.find(s=>!!s.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const n=e.groupableDelay,r=e.groupableDelayType;if(!n)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(n,r);else{const s=this.delayType,o=this.fireTime-Date.now();if(s==="at-least"&&r==="at-least")o<n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else if(s==="at-least"&&r==="at-most")o>n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else if(s==="at-most"&&r==="at-most")o>n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else if(s==="at-most"&&r==="at-least")o>n&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(n,r));else throw new Error(`Unknown delay type combination ${s} ${r}`)}}schedule(e,n){this.status=1;const r=Date.now();this.fireTime=r+e,this.delayType=n;const s=setTimeout(this.execute.bind(this),e);n==="at-least"&&(this.executionTimer=s)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size,filters:formatFilters(this.compileFilters())}),this.status=1,this.execute()}};finalizeSubId(){if(this.subIdParts.size>0){let n=Array.from(this.subIdParts).map(r=>r.substring(0,10)).join("-");n.length>20&&(n=n.substring(0,20)),this._subId=n}else this._subId=this.fingerprint.slice(0,15);this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const e=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:e}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",e,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(e){this.topSubManager.dispatchEvent(e,this.relay)}oneose(e){if(this.eosed=!0,e!==this.subId){this.debug("Received EOSE for an abandoned subscription",e,this.subId),this.relay.close(e);return}this.items.size===0&&this.close();for(const{subscription:n}of this.items.values())n.eoseReceived(this.relay),n.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:formatFilters(n.filters),internalId:n.internalId,status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.removeItem(n))}onclose(e){this.status=4}onclosed(e){if(e)for(const{subscription:n}of this.items.values())n.closedReceived(this.relay,e)}compileFilters(){const e=[],n=Array.from(this.items.values()).map(s=>s.filters);if(!n[0])return this.debug(" No filters to merge",{itemsSize:this.items.size}),[];const r=n[0].length;for(let s=0;s<r;s++){const o=n.map(l=>l[s]),a=mergeFilters$1(o);e.push(...a)}return e}},NDKRelaySubscriptionManager$1=class{relay;subscriptions;generalSubManager;constructor(e,n){this.relay=e,this.subscriptions=new Map,this.generalSubManager=n}addSubscription(e,n){let r;if(!e.isGroupable())r=this.createSubscription(e,n);else{const s=filterFingerprint$1(n,e.closeOnEose);s&&(r=(this.subscriptions.get(s)||[]).find(a=>a.status<3)),r??=this.createSubscription(e,n,s)}r.addItem(e,n)}createSubscription(e,n,r){const s=new NDKRelaySubscription$1(this.relay,r||null,this.generalSubManager);s.onClose=this.onRelaySubscriptionClose.bind(this);const o=this.subscriptions.get(s.fingerprint)??[];return this.subscriptions.set(s.fingerprint,[...o,s]),s}onRelaySubscriptionClose(e){let n=this.subscriptions.get(e.fingerprint)??[];n?n.length===1?this.subscriptions.delete(e.fingerprint):(n=n.filter(r=>r.id!==e.id),this.subscriptions.set(e.fingerprint,n)):console.warn("Unexpectedly did not find a subscription with fingerprint",e.fingerprint)}},NDKRelay$1=class Fr extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;protocolHandlers=new Map;_relayInfo;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,n,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let s=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const o=n/100;s=Math.max(e.lowestValidationRatio,e.validationRatio-o)}return s<e.validationRatio?s:e.validationRatio};constructor(e,n,r){super(),this.url=normalizeRelayUrl$1(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity$1(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager$1(this,r.subManager),this.publisher=new NDKRelayPublisher$1(this),this.authPolicy=n,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??Fr.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,n=!0){return this.connectivity.connect(e,n)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,n){this.subs.addSubscription(e,n)}async publish(e,n=2500){return this.publisher.publish(e,n)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close;registerProtocolHandler(e,n){this.protocolHandlers.set(e,n)}unregisterProtocolHandler(e){this.protocolHandlers.delete(e)}getProtocolHandler(e){return this.protocolHandlers.get(e)}async fetchInfo(e=!1){const r=this.connectivity.ndk;if(!e&&r?.cacheAdapter?.getRelayStatus){const s=await r.cacheAdapter.getRelayStatus(this.url);if(s?.nip11&&Date.now()-s.nip11.fetchedAt<864e5)return this._relayInfo=s.nip11.data,s.nip11.data}return!e&&this._relayInfo?this._relayInfo:(this._relayInfo=await fetchRelayInformation(this.url),r?.cacheAdapter?.updateRelayStatus&&await r.cacheAdapter.updateRelayStatus(this.url,{nip11:{data:this._relayInfo,fetchedAt:Date.now()}}),this._relayInfo)}get info(){return this._relayInfo}},NDKPublishError$1=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(e,n,r,s){super(e),this.errors=n,this.publishedToRelays=r,this.intendedRelaySet=s}get relayErrors(){const e=[];for(const[n,r]of this.errors)e.push(`${n.url}: ${r}`);return e.join(`
`)}},NDKRelaySet$1=class Or{relays;debug;ndk;pool;constructor(e,n,r){this.relays=e,this.ndk=n,this.pool=r??n.pool,this.debug=n.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,n,r=!0,s){if(s=s??n.pool,!s)throw new Error("No pool provided");const o=new Set;for(const a of e){const l=s.relays.get(normalizeRelayUrl$1(a));if(l)l.status<5&&r&&l.connect(),o.add(l);else{const u=new NDKRelay$1(normalizeRelayUrl$1(a),n?.relayAuthDefaultPolicy,n);s.useTemporaryRelay(u,void 0,`requested from fromRelayUrls ${e}`),o.add(u)}}return new Or(new Set(o),n,s)}async publish(e,n,r=1){const s=new Set,o=new Map,a=e.isEphemeral();e.publishStatus="pending";const l=u=>{s.add(u)};e.on("relay:published",l);try{const u=Array.from(this.relays).map(p=>new Promise(y=>{const b=n?setTimeout(()=>{s.has(p)||(o.set(p,new Error(`Publish timeout after ${n}ms`)),y(!1))},n):null;p.publish(e,n).then(w=>{b&&clearTimeout(b),w?(s.add(p),y(!0)):y(!1)}).catch(w=>{b&&clearTimeout(b),a||o.set(p,w),y(!1)})}));if(await Promise.all(u),s.size<r){if(!a){const p=new NDKPublishError$1("Not enough relays received the event ("+s.size+" published, "+r+" required)",o,s,this);throw e.publishStatus="error",e.publishError=p,this.ndk?.emit("event:publish-failed",e,p,this.relayUrls),p}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:s});return s}finally{e.off("relay:published",l)}}get size(){return this.relays.size}},d$2=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent$1(t,e,n){const r=new Set,s=await getWriteRelaysFor$1(t,e.pubkey);s&&s.forEach(l=>{const u=t.pool?.getRelay(l);u&&r.add(u)});let o=e.tags.filter(l=>["a","e"].includes(l[0])).map(l=>l[2]).filter(l=>l?.startsWith("wss://")).filter(l=>{try{return new URL(l),!0}catch{return!1}}).map(l=>normalizeRelayUrl$1(l));o=Array.from(new Set(o)).slice(0,5),o.forEach(l=>{const u=t.pool?.getRelay(l,!0,!0);u&&(d$2("Adding relay hint %s",l),r.add(u))});const a=e.getMatchingTags("p").map(l=>l[1]);return a.length<5?Array.from(chooseRelayCombinationForPubkeys$1(t,a,"read",{preferredRelays:new Set(s)}).keys()).forEach(u=>{const p=t.pool?.getRelay(u,!1,!0);p&&(d$2("Adding p-tagged relay %s",u),r.add(p))}):d$2("Too many p-tags to consider %d",a.length),t.pool?.permanentAndConnectedRelays().forEach(l=>r.add(l)),n&&r.size<n&&t.explicitRelayUrls?.filter(u=>!Array.from(r).some(p=>p.url===u)).slice(0,n-r.size)?.forEach(u=>{const p=t.pool?.getRelay(u,!1,!0);p&&(d$2("Adding explicit relay %s",u),r.add(p))}),new NDKRelaySet$1(r,t)}function calculateRelaySetsFromFilter(t,e,n,r){const s=new Map,o=new Set;if(e.forEach(a=>{a.authors&&a.authors.forEach(l=>o.add(l))}),o.size>0){const a=getRelaysForFilterWithAuthors(t,Array.from(o),r);for(const l of a.keys())s.set(l,[]);for(const l of e)if(l.authors)for(const[u,p]of a.entries()){const y=l.authors.filter(b=>p.includes(b));s.set(u,[...s.get(u),{...l,authors:y}])}else for(const u of a.keys())s.set(u,[...s.get(u),l])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(a=>{s.set(a,e)});return s.size===0&&n.permanentAndConnectedRelays().slice(0,5).forEach(a=>{s.set(a.url,e)}),s}function calculateRelaySetsFromFilters(t,e,n,r){return calculateRelaySetsFromFilter(t,e,n,r)}function isValidHex64(t){if(typeof t!="string"||t.length!==64)return!1;for(let e=0;e<64;e++){const n=t.charCodeAt(e);if(!(n>=48&&n<=57||n>=97&&n<=102||n>=65&&n<=70))return!1}return!0}function isValidPubkey(t){return isValidHex64(t)}function isValidNip05(t){if(typeof t!="string")return!1;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)===46)return!0;return!1}function mergeTags$1(t,e){const n=new Map,r=a=>a.join(","),s=(a,l)=>a.every((u,p)=>u===l[p]),o=a=>{for(const[l,u]of n)if(s(u,a)||s(a,u)){a.length>=u.length&&n.set(l,a);return}n.set(r(a),a)};return t.concat(e).forEach(o),Array.from(n.values())}var hashtagRegex$1=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags$1(t){const e=t.match(hashtagRegex$1),n=new Set,r=new Set;if(e)for(const s of e)n.has(s.slice(1))||(r.add(s.slice(1)),n.add(s.slice(1)));return Array.from(r)}async function generateContentTags$1(t,e=[],n,r){if(n?.skipContentTagging)return{content:t,tags:e};const s=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,o=[],a=l=>{e.find(u=>["q",l[0]].includes(u[0])&&u[1]===l[1])||e.push(l)};if(t=t.replace(s,l=>{try{const u=l.split(/(@|nostr:)/)[2],{type:p,data:y}=nip19_exports$2.decode(u);let b;if(n?.filters){const w=!n.filters.includeTypes||n.filters.includeTypes.includes(p),_=n.filters.excludeTypes?.includes(p);if(!w||_)return l}switch(p){case"npub":n?.pTags!==!1&&(b=["p",y]);break;case"nprofile":n?.pTags!==!1&&(b=["p",y.pubkey]);break;case"note":o.push(new Promise(async w=>{const _=await maybeGetEventRelayUrl$1(u);a(["q",y,_]),w()}));break;case"nevent":o.push(new Promise(async w=>{const{id:_,author:x}=y;let{relays:T}=y;(!T||T.length===0)&&(T=[await maybeGetEventRelayUrl$1(u)]),a(["q",_,T[0]]),x&&n?.pTags!==!1&&n?.pTagOnQTags!==!1&&a(["p",x]),w()}));break;case"naddr":o.push(new Promise(async w=>{const _=[y.kind,y.pubkey,y.identifier].join(":");let x=y.relays??[];x.length===0&&(x=[await maybeGetEventRelayUrl$1(u)]),a(["q",_,x[0]]),n?.pTags!==!1&&n?.pTagOnQTags!==!1&&n?.pTagOnATags!==!1&&a(["p",y.pubkey]),w()}));break;default:return l}return b&&a(b),`nostr:${u}`}catch{return l}}),await Promise.all(o),!n?.filters?.excludeTypes?.includes("hashtag")){const l=generateHashtags$1(t).map(u=>["t",u]);e=mergeTags$1(e,l)}if(n?.pTags!==!1&&n?.copyPTagsFromTarget&&r){const l=r.getMatchingTags("p");for(const u of l)!u[1]||!isValidPubkey(u[1])||e.find(p=>p[0]==="p"&&p[1]===u[1])||e.push(u)}return{content:t,tags:e}}async function maybeGetEventRelayUrl$1(t){return""}async function encrypt$1(t,e,n="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const o=t||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(n==="nip44"&&await isEncryptionEnabled$1(s,"nip44")&&(r=await s.encrypt(o,this.content,"nip44")),(!r||n==="nip04")&&await isEncryptionEnabled$1(s,"nip04")&&(r=await s.encrypt(o,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function decrypt$1(t,e,n){if(this.ndk?.cacheAdapter?.getDecryptedEvent){const l=await this.ndk.cacheAdapter.getDecryptedEvent(this.id);if(l){this.content=l.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const o=t||this.author;if(!o)throw new Error("No sender provided and no author available");const a=n||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled$1(s,"nip04")&&this.content.search("\\?iv=")&&(r=await s.decrypt(o,this.content,"nip04")),!r&&a==="nip44"&&await isEncryptionEnabled$1(s,"nip44")&&(r=await s.decrypt(o,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this.id,this)}async function isEncryptionEnabled$1(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function eventHasETagMarkers$1(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag$1(t,e){e??=t.tagType();const n=t.tags.find(isTagRootTag$1);if(!n){if(eventHasETagMarkers$1(t))return;const r=t.getMatchingTags(e);if(r.length<3)return r[0]}return n}var nip22RootTags$1=new Set(["A","E","I"]),nip22ReplyTags$1=new Set(["a","e","i"]);function getReplyTag$1(t,e){if(t.kind===1111){let s;for(const o of t.tags)if(nip22RootTags$1.has(o[0]))s=o;else if(nip22ReplyTags$1.has(o[0])){s=o;break}return s}e??=t.tagType();let n=!1,r;for(const s of t.tags)if(s[0]===e){if((s[3]??"").length>0&&(n=!0),n&&s[3]==="reply")return s;n&&s[3]==="root"&&(r=s),n||(r=s)}return r}function isTagRootTag$1(t){return t[0]==="E"||t[3]==="root"}async function fetchTaggedEvent$1(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(n.length===0)return;const[r,s,o]=n[0],a=o!==""?this.ndk.pool.getRelay(o):void 0;return await this.ndk.fetchEvent(s,{},a)}async function fetchRootEvent$1(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag$1(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent$1(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag$1(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function isReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT$1=2;function encode$1(t=DEFAULT_RELAY_COUNT$1){let e=[];return this.onRelays.length>0?e=this.onRelays.map(n=>n.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost$1(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new NDKEvent$1(this.ndk,{kind:getKind$1(this)});return this.isProtected||(n.content=JSON.stringify(this.rawEvent())),n.tag(this),this.kind!==1&&n.tags.push(["k",`${this.kind}`]),e&&await n.sign(e),t&&await n.publish(),n}function getKind$1(t){return t.kind===1?6:16}function getEventDetails(t){return"inspect"in t&&typeof t.inspect=="string"?t.inspect:JSON.stringify(t)}function validateForSerialization(t){if(typeof t.kind!="number")throw new Error(`Can't serialize event with invalid properties: kind (must be number, got ${typeof t.kind}). Event: ${getEventDetails(t)}`);if(typeof t.content!="string")throw new Error(`Can't serialize event with invalid properties: content (must be string, got ${typeof t.content}). Event: ${getEventDetails(t)}`);if(typeof t.created_at!="number")throw new Error(`Can't serialize event with invalid properties: created_at (must be number, got ${typeof t.created_at}). Event: ${getEventDetails(t)}`);if(typeof t.pubkey!="string")throw new Error(`Can't serialize event with invalid properties: pubkey (must be string, got ${typeof t.pubkey}). Event: ${getEventDetails(t)}`);if(!Array.isArray(t.tags))throw new Error(`Can't serialize event with invalid properties: tags (must be array, got ${typeof t.tags}). Event: ${getEventDetails(t)}`);for(let e=0;e<t.tags.length;e++){const n=t.tags[e];if(!Array.isArray(n))throw new Error(`Can't serialize event with invalid properties: tags[${e}] (must be array, got ${typeof n}). Event: ${getEventDetails(t)}`);for(let r=0;r<n.length;r++)if(typeof n[r]!="string")throw new Error(`Can't serialize event with invalid properties: tags[${e}][${r}] (must be string, got ${typeof n[r]}). Event: ${getEventDetails(t)}`)}}function serialize$1(t=!1,e=!1){validateForSerialization(this);const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}function deserialize$1(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],s=e[7];r&&r.length===128?(n.sig=r,s&&s.length===64&&(n.id=s)):r&&r.length===64&&(n.id=r,s&&s.length===128&&(n.sig=s))}return n}var worker,processingQueue$1={};function signatureVerificationInit(t){worker=t,worker.onmessage=e=>{if(!Array.isArray(e.data)||e.data.length!==2){console.error("[NDK]  Signature verification worker received incompatible message format.",`

 Expected format: [eventId, boolean]`,`
 Received:`,e.data,`

 This likely means:`,`
  1. You have a STALE worker.js file that needs updating`,`
  2. Version mismatch between @nostr-dev-kit/ndk and deployed worker`,`
  3. Wrong worker is being used for signature verification`,`

 Solution: Update your worker files:`,`
  cp node_modules/@nostr-dev-kit/ndk/dist/workers/sig-verification.js public/`,`
  cp node_modules/@nostr-dev-kit/cache-sqlite-wasm/dist/worker.js public/`,`

 Or use Vite/bundler imports instead of static files:`,`
  import SigWorker from "@nostr-dev-kit/ndk/workers/sig-verification?worker"`);return}const[n,r]=e.data,s=processingQueue$1[n];if(!s){console.error("No record found for event",n);return}delete processingQueue$1[n];for(const o of s.resolves)o(r)}}async function verifySignatureAsync$1(t,e,n){const r=t.ndk,s=Date.now();let o;return r.signatureVerificationFunction?o=await r.signatureVerificationFunction(t):o=await new Promise(a=>{const l=t.serialize();let u=!1;processingQueue$1[t.id]||(processingQueue$1[t.id]={event:t,resolves:[],relay:n},u=!0),processingQueue$1[t.id].resolves.push(a),u&&worker?.postMessage({serialized:l,id:t.id,sig:t.sig,pubkey:t.pubkey})}),r.signatureVerificationTimeMs+=Date.now()-s,o}var PUBKEY_REGEX$1=/^[a-f0-9]{64}$/;function validate$1(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX$1)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(typeof e[n]=="object")return!1}return!0}var verifiedSignatures$1=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature$1(t){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures$1.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification){const n=this.relay;verifySignatureAsync$1(this,t,n).then(r=>{t&&(this.signatureVerified=r,r&&verifiedSignatures$1.set(this.id,this.sig)),r?n&&n.addValidatedEvent():(n?this.ndk?.reportInvalidSignature(this,n):this.ndk?.reportInvalidSignature(this),verifiedSignatures$1.set(this.id,!1))}).catch(r=>{console.error("signature verification error",this.id,r)})}else{const n=sha256_1(new TextEncoder().encode(this.serialize())),r=schnorr.verify(this.sig,n,this.pubkey);return r?verifiedSignatures$1.set(this.id,this.sig):verifiedSignatures$1.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash$1(){return getEventHashFromSerializedEvent$1(this.serialize())}function getEventHashFromSerializedEvent$1(t){const e=sha256_1(new TextEncoder().encode(t));return utils.bytesToHex(e)}var skipClientTagOnKinds$1=new Set([0,4,1059,13,3,9734,5]),NDKEvent$1=class bt extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,n){super(),this.ndk=e,this.created_at=n?.created_at,this.content=n?.content||"",this.tags=n?.tags||[],this.id=n?.id||"",this.sig=n?.sig,this.pubkey=n?.pubkey||"",this.kind=n?.kind,n instanceof bt&&(this.relay&&(this.relay=n.relay,this.ndk?.subManager.seenEvent(n.id,this.relay)),this.publishStatus=n.publishStatus,this.publishError=n.publishError)}static deserialize(e,n){return new bt(e,deserialize$1(n))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,n,r){const s=["i"],o=["k"];switch(n){case"url":{const a=new URL(e);a.hash="",s.push(a.toString()),o.push(`${a.protocol}//${a.host}`);break}case"hashtag":s.push(`#${e.toLowerCase()}`),o.push("#");break;case"geohash":s.push(`geo:${e.toLowerCase()}`),o.push("geo");break;case"isbn":s.push(`isbn:${e.replace(/-/g,"")}`),o.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${e}`),o.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${e}`),o.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${e}`),o.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${e.split("-").slice(0,4).join("-")}`),o.push("isan");break;case"doi":s.push(`doi:${e.toLowerCase()}`),o.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${n}`)}r&&s.push(r),this.tags.push(s),this.tags.push(o)}tag(e,n,r,s,o){let a=[];if(e.fetchProfile!==void 0){if(s??="p",s==="p"&&o?.pTags===!1)return;const u=[s,e.pubkey];n&&u.push("",n),a.push(u)}else if(e instanceof bt){const u=e;if(r??=u?.pubkey===this.pubkey,a=u.referenceTags(n,r,s,o),o?.pTags!==!1)for(const p of u.getMatchingTags("p"))!p[1]||!isValidPubkey(p[1])||p[1]!==this.pubkey&&(this.tags.find(y=>y[0]==="p"&&y[1]===p[1])||this.tags.push(["p",p[1]]))}else if(Array.isArray(e))a=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags$1(this.tags,a)}async toNostrEvent(e,n){if(!e&&this.pubkey===""){const o=await this.ndk?.signer?.user();this.pubkey=o?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags(n);this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize$1.bind(this);getEventHash=getEventHash$1.bind(this);validate=validate$1.bind(this);verifySignature=verifySignature$1.bind(this);isReplaceable=isReplaceable$1.bind(this);isEphemeral=isEphemeral$1.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable$1.bind(this);encode=encode$1.bind(this);encrypt=encrypt$1.bind(this);decrypt=decrypt$1.bind(this);getMatchingTags(e,n){const r=this.tags.filter(s=>s[0]===e);return n===void 0?r:r.filter(s=>s[3]===n)}hasTag(e,n){return this.tags.some(r=>r[0]===e&&(!n||r[3]===n))}tagValue(e,n){const r=this.getMatchingTags(e,n);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,n){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(s=>{const o=r.includes(s[0]),a=n?s[3]===n:!0;return!(o&&a)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,n){this.ndk?.aiGuardrails?.event?.signing(this),e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,n);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,n,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,n,r)}async publish(e,n,r,s){if(r||(r=1),this.sig||await this.sign(void 0,s),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if(this.ndk.aiGuardrails?.event?.publishing(this),(!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent$1(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const l=this.getMatchingTags("e").map(u=>u[1]);this.ndk.cacheAdapter.deleteEventIds(l)}const o=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent$1(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(l){console.error("Error adding unpublished event to cache",l)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(l=>l[1])),this.ndk.subManager.dispatchEvent(o,void 0,!0);const a=await e.publish(this,n,r);return a.forEach(l=>this.ndk?.subManager.seenEvent(this.id,l)),a}async generateTags(e){let n=[];const r=await generateContentTags$1(this.content,this.tags,e,this),s=r.content;if(n=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const a=this.tagValue("title");let u=[...Array(a?6:16)].map(()=>Math.random().toString(36)[2]).join("");a&&a.length>0&&(u=`${a.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${u}`),n.push(["d",u])}if(this.shouldAddClientTag){const o=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&o.push(this.ndk?.clientNip89),n.push(o)}else this.shouldStripClientTag&&(n=n.filter(o=>o[0]!=="client"));return{content:s||"",tags:n}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds$1.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds$1.has(this.kind)}muted(){return this.ndk?.muteFilter&&this.ndk.muteFilter(this)?"muted":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let n;return this.isParamReplaceable()?n=["a",this.tagAddress()]:n=["e",this.tagId()],this.relay?n.push(this.relay.url):n.push(""),n.push(e??""),this.isParamReplaceable()||n.push(this.pubkey),n}referenceTags(e,n,r,s){let o=[];return this.isParamReplaceable()?o=[[r??"a",this.tagAddress()],[r??"e",this.id]]:o=[[r??"e",this.id]],o=o.map(a=>(a[0]==="e"||e?a.push(this.relay?.url??""):this.relay?.url&&a.push(this.relay?.url),a)),o.forEach(a=>{a[0]==="e"?(a.push(e??""),a.push(this.pubkey)):e&&a.push(e)}),o=[...o,...this.getMatchingTags("h")],!n&&s?.pTags!==!1&&o.push(...this.author.referenceTags()),o}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new bt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),n&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent$1.bind(this);fetchRootEvent=fetchRootEvent$1.bind(this);fetchReplyEvent=fetchReplyEvent$1.bind(this);repost=repost$1.bind(this);async react(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new bt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),n&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,n){const r=new bt(this.ndk);if(this.ndk?.aiGuardrails?.event?.creatingReply(r),this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,n)]:r.tag(this,"root",!1,void 0,n);else{r.kind=1111;const s=["A","E","I","P"],o=this.tags.filter(a=>s.includes(a[0]));if(o.length>0){const a=this.tagValue("K");r.tags.push(...o),a&&r.tags.push(["K",a]);let l;if(this.isParamReplaceable()){l=["a",this.tagAddress()];const u=this.relay?.url??"";u&&l.push(u)}else{l=["e",this.tagId()];const u=this.relay?.url??"";l.push(u),l.push(this.pubkey)}r.tags.push(l)}else{let a,l;const u=this.relay?.url??"";this.isParamReplaceable()?(a=["a",this.tagAddress(),u],l=["A",this.tagAddress(),u]):(a=["e",this.tagId(),u,this.pubkey],l=["E",this.tagId(),u,this.pubkey]),r.tags.push(a),r.tags.push(l),r.tags.push(["K",this.kind?.toString()]),n?.pTags!==!1&&n?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),n?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents$1=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent$1(t){return!untrackedUnpublishedEvents$1.has(t.kind)}var NDKPool$1=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;constructor(e,n,{debug:r,name:s}={}){super(),this.debug=r??n.debug.extend("pool"),s&&(this._name=s),this.ndk=n,this.relayUrls=e,this.ndk.pools&&this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(e){this._relays.clear();for(const n of e){const r=new NDKRelay$1(n,void 0,this.ndk);r.connectivity.netDebug=this.ndk.netDebug,this.addRelay(r)}}_name="unnamed";get name(){return this._name}set name(e){this._name=e,this.debug=this.debug.extend(e)}useTemporaryRelay(e,n=3e4,r){const s=this.relays.has(e.url);s||(this.addRelay(e),this.debug("Adding temporary relay %s for filters %o",e.url,r));const o=this.temporaryRelayTimers.get(e.url);if(o&&clearTimeout(o),!s||o){const a=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(e.url)||this.removeRelay(e.url)},n);this.temporaryRelayTimers.set(e.url,a)}}addRelay(e,n=!0){const r=this.relays.has(e.url),s=e.url.includes("/npub1");let o=!0;const a=e.url;if(r)return;if(this.ndk.relayConnectionFilter&&!this.ndk.relayConnectionFilter(a)){this.debug(`Refusing to add relay ${a}: blocked by relayConnectionFilter`);return}if(s){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const x=this.ndk.cacheAdapter.getRelayStatus(a),T=x instanceof Promise?void 0:x;if(T?.dontConnectBefore){if(T.dontConnectBefore>Date.now()){const k=T.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${k}ms`),setTimeout(()=>{this.addRelay(e,n)},k);return}o=!1}}const l=x=>this.emit("notice",e,x),u=()=>this.handleRelayConnect(a),p=()=>this.handleRelayReady(e),y=()=>{this.recordDisconnection(e),this.emit("relay:disconnect",e)},b=()=>this.handleFlapping(e),w=x=>this.emit("relay:auth",e,x),_=()=>this.emit("relay:authed",e);e.off("notice",l),e.off("connect",u),e.off("ready",p),e.off("disconnect",y),e.off("flapping",b),e.off("auth",w),e.off("authed",_),e.on("notice",l),e.on("connect",u),e.on("ready",p),e.on("disconnect",y),e.on("flapping",b),e.on("auth",w),e.on("authed",_),e.on("delayed-connect",x=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+x})}),this._relays.set(a,e),n&&this.autoConnectRelays.add(a),n&&this.status==="active"&&(this.emit("relay:connecting",e),e.connect(void 0,o).catch(x=>{this.debug(`Failed to connect to relay ${a}`,x)}))}removeRelay(e){const n=this.relays.get(e);if(n)return n.disconnect(),this.relays.delete(e),this.autoConnectRelays.delete(e),this.emit("relay:disconnect",n),!0;const r=this.temporaryRelayTimers.get(e);return r&&(clearTimeout(r),this.temporaryRelayTimers.delete(e)),!1}isRelayConnected(e){const n=normalizeRelayUrl$1(e),r=this.relays.get(n);return r?r.status===5:!1}getRelay(e,n=!0,r=!1,s){let o=this.relays.get(normalizeRelayUrl$1(e));return o||(o=new NDKRelay$1(e,void 0,this.ndk),o.connectivity.netDebug=this.ndk.netDebug,r?this.useTemporaryRelay(o,3e4,s):this.addRelay(o,n)),o}handleRelayConnect(e){const n=this.relays.get(e);if(!n){console.error("NDK BUG: relay not found in pool",{relayUrl:e});return}this.emit("relay:connect",n),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.emit("relay:ready",e)}async connect(e){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}ms`:""}...`);const n=Array.from(this.autoConnectRelays.keys()).map(a=>this.relays.get(a)).filter(a=>!!a);for(const a of n)a.status!==5&&a.status!==4&&(this.emit("relay:connecting",a),a.connect().catch(l=>{this.debug(`Failed to connect to relay ${a.url}: ${l??"No reason specified"}`)}));const r=()=>n.every(a=>a.status===5),s=new Promise(a=>{if(r()){a();return}const l=[];for(const u of n){const p=()=>{if(r()){for(let y=0;y<n.length;y++)n[y].off("connect",l[y]);a()}};l.push(p),u.on("connect",p)}}),o=typeof e=="number"?new Promise(a=>setTimeout(a,e)):new Promise(()=>{});await Promise.race([s,o])}checkOnFlappingRelays(){const e=this.flappingRelays.size,n=this.relays.size;if(e/n>=.8)for(const r of this.flappingRelays)this.backoffTimes.set(r,0)}recordDisconnection(e){const n=Date.now();this.disconnectionTimes.set(e.url,n);for(const[r,s]of this.disconnectionTimes.entries())n-s>1e4&&this.disconnectionTimes.delete(r);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const e=Date.now(),n=[];for(const r of this.disconnectionTimes.values())e-r<5e3&&n.push(r);n.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${n.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){if(this.systemEventDetector){this.debug("System-wide reconnection already in progress, skipping");return}this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const e of this.relays.values())e.connectivity&&(e.connectivity.resetReconnectionState(),e.status!==5&&e.status!==4&&e.connect().catch(n=>{this.debug(`Failed to reconnect relay ${e.url} after system event: ${n}`)}));this.disconnectionTimes.clear()}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let n=this.backoffTimes.get(e.url)||5e3;n=n*2,this.backoffTimes.set(e.url,n),this.debug(`Backoff time for ${e.url} is ${n}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},n),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){const e={total:0,connected:0,disconnected:0,connecting:0};for(const n of this.relays.values())e.total++,n.status===5?e.connected++:n.status===1?e.disconnected++:n.status===4&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5&&!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}},NDKDVMJobFeedback=class Br extends NDKEvent$1{static kinds=[7e3];constructor(e,n){super(e,n),this.kind??=7e3}static async from(e){const n=new Br(e.ndk,e.rawEvent());return n.encrypted&&await n.dvmDecrypt(),n}get status(){return this.tagValue("status")}set status(e){this.removeTag("status"),e!==void 0&&this.tags.push(["status",e])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();const e=JSON.parse(this.content);this.tags.push(...e)}},NDKCashuMintList$1=class Lr extends NDKEvent$1{static kind=10019;static kinds=[10019];_p2pk;constructor(e,n){super(e,n),this.kind??=10019}static from(e){return new Lr(e.ndk,e)}set relays(e){this.tags=this.tags.filter(n=>n[0]!=="relay");for(const n of e)this.tags.push(["relay",n])}get relays(){const e=[];for(const n of this.tags)n[0]==="relay"&&e.push(n[1]);return e}set mints(e){this.tags=this.tags.filter(n=>n[0]!=="mint");for(const n of e)this.tags.push(["mint",n])}get mints(){const e=[];for(const n of this.tags)n[0]==="mint"&&e.push(n[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet$1.fromRelayUrls(this.relays,this.ndk)}},NDKArticle=class Mr extends NDKEvent$1{static kind=30023;static kinds=[30023];constructor(e,n){super(e,n),this.kind??=30023}static from(e){return new Mr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e){let n=Number.parseInt(e);return n>1e12&&(n=Math.floor(n/1e3)),n}}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(e){e?this.tags.push(["url",e]):this.removeTag("url")}},NDKBlossomList=class Hr extends NDKEvent$1{static kinds=[10063];constructor(e,n){super(e,n),this.kind??=10063}static from(e){return new Hr(e.ndk,e.rawEvent())}get servers(){return this.tags.filter(e=>e[0]==="server").map(e=>e[1])}set servers(e){this.tags=this.tags.filter(n=>n[0]!=="server");for(const n of e)this.tags.push(["server",n])}get default(){const e=this.servers;return e.length>0?e[0]:void 0}set default(e){if(!e)return;const r=this.servers.filter(s=>s!==e);this.servers=[e,...r]}addServer(e){if(!e)return;const n=this.servers;n.includes(e)||(this.servers=[...n,e])}removeServer(e){if(!e)return;const n=this.servers;this.servers=n.filter(r=>r!==e)}},NDKFedimintMint=class Vr extends NDKEvent$1{static kind=38173;static kinds=[38173];constructor(e,n){super(e,n),this.kind??=38173}static async from(e){return new Vr(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get inviteCodes(){return this.getMatchingTags("u").map(e=>e[1])}set inviteCodes(e){this.removeTag("u");for(const n of e)this.tags.push(["u",n])}get modules(){return this.getMatchingTags("modules").map(e=>e[1])}set modules(e){this.removeTag("modules");for(const n of e)this.tags.push(["modules",n])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKCashuMintAnnouncement=class zr extends NDKEvent$1{static kind=38172;static kinds=[38172];constructor(e,n){super(e,n),this.kind??=38172}static async from(e){return new zr(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get url(){return this.tagValue("u")}set url(e){this.removeTag("u"),e&&this.tags.push(["u",e])}get nuts(){return this.getMatchingTags("nuts").map(e=>e[1])}set nuts(e){this.removeTag("nuts");for(const n of e)this.tags.push(["nuts",n])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKMintRecommendation=class jr extends NDKEvent$1{static kind=38e3;static kinds=[38e3];constructor(e,n){super(e,n),this.kind??=38e3}static async from(e){return new jr(e.ndk,e)}get recommendedKind(){const e=this.tagValue("k");return e?Number(e):void 0}set recommendedKind(e){this.removeTag("k"),e&&this.tags.push(["k",e.toString()])}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get urls(){return this.getMatchingTags("u").map(e=>e[1])}set urls(e){this.removeTag("u");for(const n of e)this.tags.push(["u",n])}get mintEventPointers(){return this.getMatchingTags("a").map(e=>({kind:Number(e[1].split(":")[0]),identifier:e[1].split(":")[2],relay:e[2]}))}addMintEventPointer(e,n,r,s){const o=["a",`${e}:${n}:${r}`];s&&o.push(s),this.tags.push(o)}get review(){return this.content}set review(e){this.content=e}},NDKClassified=class Wr extends NDKEvent$1{static kinds=[30402];constructor(e,n){super(e,n),this.kind??=30402}static from(e){return new Wr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}get location(){return this.tagValue("location")}set location(e){this.removeTag("location"),e&&this.tags.push(["location",e])}get price(){const e=this.tags.find(n=>n[0]==="price");if(e)return{amount:Number.parseFloat(e[1]),currency:e[2],frequency:e[3]}}set price(e){if(typeof e=="string"&&(e={amount:Number.parseFloat(e)}),e?.amount){const n=["price",e.amount.toString()];e.currency&&n.push(e.currency),e.frequency&&n.push(e.frequency),this.tags.push(n)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},NDKDraft=class qr extends NDKEvent$1{_event;static kind=31234;static kinds=[31234,1234];counterparty;constructor(e,n){super(e,n),this.kind??=31234}static from(e){return new qr(e.ndk,e)}set identifier(e){this.removeTag("d"),this.tags.push(["d",e])}get identifier(){return this.dTag}set event(e){e instanceof NDKEvent$1?this._event=e:this._event=new NDKEvent$1(void 0,e),this.prepareEvent()}set checkpoint(e){e?(this.tags.push(e.tagReference()),this.kind=1234):(this.removeTag("a"),this.kind=31234)}get isCheckpoint(){return this.kind===1234}get isProposal(){const e=this.tagValue("p");return!!e&&e!==this.pubkey}async getEvent(e){if(this._event)return this._event;if(e??=this.ndk?.signer,!e)throw new Error("No signer available");if(this.content&&this.content.length>0)try{const n=e.pubkey,s=[this.tagValue("p"),this.pubkey].filter(Boolean).find(l=>l!==n);let o;o=new NDKUser$1({pubkey:s??n}),await this.decrypt(o,e);const a=JSON.parse(this.content);return this._event=await wrapEvent(new NDKEvent$1(this.ndk,a)),this._event}catch(n){console.error(n);return}else return null}prepareEvent(){if(!this._event)throw new Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event.rawEvent())}async save({signer:e,publish:n,relaySet:r}){if(e??=this.ndk?.signer,!e)throw new Error("No signer available");const s=this.counterparty||await e.user();if(await this.encrypt(s,e),this.counterparty){const o=this.counterparty.pubkey;this.removeTag("p"),this.tags.push(["p",o])}if(n!==!1)return this.publishReplaceable(r)}};function mapImetaTag(t){const e={};if(t.length===2){const r=t[1].split(" ");for(let s=0;s<r.length;s+=2){const o=r[s],a=r[s+1];o==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(a)):e[o]=a}return e}const n=t.slice(1);for(const r of n){const s=r.split(" "),o=s[0],a=s.slice(1).join(" ");o==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(a)):e[o]=a}return e}function imetaTagToTag(t){const e=["imeta"];for(const[n,r]of Object.entries(t))if(Array.isArray(r))for(const s of r)e.push(`${n} ${s}`);else r&&e.push(`${n} ${r}`);return e}var NDKFollowPack=class Gr extends NDKEvent$1{static kind=39089;static kinds=[39089,39092];constructor(e,n){super(e,n),this.kind??=39089}static from(e){return new Gr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){const e=this.tags.find(n=>n[0]==="imeta");if(e){const n=mapImetaTag(e);if(n.url)return n.url}return this.tagValue("image")}set image(e){this.tags=this.tags.filter(n=>n[0]!=="imeta"&&n[0]!=="image"),typeof e=="string"?e!==void 0&&this.tags.push(["image",e]):e&&typeof e=="object"&&(this.tags.push(imetaTagToTag(e)),e.url&&this.tags.push(["image",e.url]))}get pubkeys(){return Array.from(new Set(this.tags.filter(e=>e[0]==="p"&&e[1]&&isValidPubkey(e[1])).map(e=>e[1])))}set pubkeys(e){this.tags=this.tags.filter(n=>n[0]!=="p");for(const n of e)this.tags.push(["p",n])}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}},NDKHighlight=class Jr extends NDKEvent$1{_article;static kind=9802;static kinds=[9802];constructor(e,n){super(e,n),this.kind??=9802}static from(e){return new Jr(e.ndk,e)}get url(){return this.tagValue("r")}set context(e){e===void 0?this.tags=this.tags.filter(([n,r])=>n!=="context"):(this.tags=this.tags.filter(([n,r])=>n!=="context"),this.tags.push(["context",e]))}get context(){return this.tags.find(([e,n])=>e==="context")?.[1]??void 0}get article(){return this._article}set article(e){this._article=e,typeof e=="string"?this.tags.push(["r",e]):this.tag(e)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){if(this._article!==void 0)return this._article;let e;const n=this.getArticleTag();if(n){switch(n[0]){case"a":{const[r,s,o]=n[1].split(":");e=nip19_exports$2.naddrEncode({kind:Number.parseInt(r),pubkey:s,identifier:o});break}case"e":e=nip19_exports$2.noteEncode(n[1]);break;case"r":this._article=n[1];break}if(e){let r=await this.ndk?.fetchEvent(e);r&&(r.kind===30023&&(r=NDKArticle.from(r)),this._article=r)}return this._article}}},NDKImage=class Yr extends NDKEvent$1{static kind=20;static kinds=[20];_imetas;constructor(e,n){super(e,n),this.kind??=20}static from(e){return new Yr(e.ndk,e.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag).filter(e=>!!e.url),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(n=>n[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}},NDKList=class Zr extends NDKEvent$1{_encryptedTags;static kinds=[30001,10004,10050,10030,10015,10001,10002,10007,10006,10003];encryptedTagsLength;constructor(e,n){super(e,n),this.kind??=30001}static from(e){return new Zr(e.ndk,e)}get title(){const e=this.tagValue("title")||this.tagValue("name");return e||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(e){this.removeTag(["title","name"]),e&&this.tags.push(["title",e])}get name(){return this.title}set name(e){this.title=e}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const n=await this.ndk.signer.user();try{if(this.content.length>0)try{const r=await this.ndk.signer.decrypt(n,this.content),s=JSON.parse(r);return s?.[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=s):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{}}catch{}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(n=>n[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,n=void 0,r=!1,s="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let o;if(e instanceof NDKEvent$1)o=[e.tagReference(n)];else if(e instanceof NDKUser$1)o=e.referenceTags();else if(e instanceof NDKRelay$1)o=e.referenceTags();else if(Array.isArray(e))o=[e];else throw new Error("Invalid object type");if(n&&o[0].push(n),r){const a=await this.ndk.signer.user(),l=await this.encryptedTags();s==="top"?l.unshift(...o):l.push(...o),this._encryptedTags=l,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(l),await this.encrypt(a)}else s==="top"?this.tags.unshift(...o):this.tags.push(...o);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(e,n=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const r=this.tags.findIndex(l=>l[1]===e);r>=0&&this.tags.splice(r,1);const s=await this.ndk.signer.user(),o=await this.encryptedTags(),a=o.findIndex(l=>l[1]===e);if(a>=0&&(o.splice(a,1),this._encryptedTags=o,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(o),await this.encrypt(s)),n)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,n){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(n){const r=await this.ndk.signer.user(),s=await this.encryptedTags();s.splice(e,1),this._encryptedTags=s,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(s),await this.encrypt(r)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(e){return this.items.some(n=>n[1]===e)}filterForItems(){const e=new Set,n=new Map,r=[];for(const s of this.items)if(s[0]==="e"&&s[1])e.add(s[1]);else if(s[0]==="a"&&s[1]){const[o,a,l]=s[1].split(":");if(!o||!a)continue;const u=`${o}:${a}`,p=n.get(u)||[];p.push(l||""),n.set(u,p)}if(e.size>0&&r.push({ids:Array.from(e)}),n.size>0)for(const[s,o]of n.entries()){const[a,l]=s.split(":");r.push({kinds:[Number.parseInt(a)],authors:[l],"#d":o})}return r}},NDKAppHandlerEvent=class Xr extends NDKEvent$1{profile;static kinds=[31990];constructor(e,n){super(e,n),this.kind??=31990}static from(e){const n=new Xr(e.ndk,e.rawEvent());return n.isValid?n:null}get isValid(){const e=new Map,n=s=>[s[0],s[2]].join(":").toLowerCase(),r=["web","android","ios"];for(const s of this.tags)if(r.includes(s[0])){const o=n(s);if(e.has(o)&&e.get(o)!==s[1].toLowerCase())return!1;e.set(o,s[1].toLowerCase())}return!0}async fetchProfile(){if(this.profile===void 0&&this.content.length>0)try{const e=JSON.parse(this.content);if(e?.name)return e;this.profile=null}catch{this.profile=null}return new Promise((e,n)=>{const r=this.author;r.fetchProfile().then(()=>{e(r.profile)}).catch(n)})}},NDKNutzap=class Qn extends NDKEvent$1{debug;_proofs=[];static kind=9321;static kinds=[Qn.kind];constructor(e,n){super(e,n),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(s=>JSON.parse(s[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const n=new Qn(e.ndk,e);if(!(!n._proofs||!n._proofs.length))return n}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(n=>n[0]!=="proof");for(const n of e)this.tags.push(["proof",JSON.stringify(n)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const n=JSON.parse(e.secret);let r;if(typeof n=="string"?(r=JSON.parse(n),this.debug("stringified payload",e.secret)):typeof n=="object"&&(r=n),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(n){this.debug("error parsing p2pk pubkey",n,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((n,r)=>n+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(n=>n[0]!=="p"),e instanceof NDKEvent$1&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser$1({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,n=0,r=0;for(const s of this.tags)s[0]==="e"&&e++,s[0]==="p"&&n++,s[0]==="u"&&r++;return n===1&&r===1&&e<=1&&this.proofs.length>0}},NDKProject=class Qr extends NDKEvent$1{static kind=31933;static kinds=[31933];_signer;constructor(e,n){super(e,n),this.kind=31933}static from(e){return new Qr(e.ndk,e.rawEvent())}set repo(e){this.removeTag("repo"),e&&this.tags.push(["repo",e])}set hashtags(e){this.removeTag("hashtags"),e.filter(n=>n.length>0).length&&this.tags.push(["hashtags",...e])}get hashtags(){const e=this.tags.find(n=>n[0]==="hashtags");return e?e.slice(1):[]}get repo(){return this.tagValue("repo")}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get picture(){return this.tagValue("picture")}set picture(e){this.removeTag("picture"),e&&this.tags.push(["picture",e])}set description(e){this.content=e}get description(){return this.content}get slug(){return this.dTag??"empty-dtag"}async getSigner(){if(this._signer)return this._signer;const e=this.tagValue("key");if(!e)this._signer=NDKPrivateKeySigner$1.generate(),await this.encryptAndSaveNsec();else{const n=await this.ndk?.signer?.decrypt(this.ndk.activeUser,e);if(!n)throw new Error("Failed to decrypt project key or missing signer context.");this._signer=new NDKPrivateKeySigner$1(n)}return this._signer}async getNsec(){return(await this.getSigner()).privateKey}async setNsec(e){this._signer=new NDKPrivateKeySigner$1(e),await this.encryptAndSaveNsec()}async encryptAndSaveNsec(){if(!this._signer)throw new Error("Signer is not set.");const e=this._signer.privateKey,n=await this.ndk?.signer?.encrypt(this.ndk.activeUser,e);n&&(this.removeTag("key"),this.tags.push(["key",n]))}},NDKProjectTemplate=class ei extends NDKEvent$1{static kind=30717;static kinds=[30717];constructor(e,n){super(e,n),this.kind=30717}static from(e){return new ei(e.ndk,e.rawEvent())}get templateId(){return this.dTag??""}set templateId(e){this.dTag=e}get name(){return this.tagValue("title")??""}set name(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get description(){return this.tagValue("description")??""}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get repoUrl(){return this.tagValue("uri")??""}set repoUrl(e){this.removeTag("uri"),e&&this.tags.push(["uri",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get command(){return this.tagValue("command")}set command(e){this.removeTag("command"),e&&this.tags.push(["command",e])}get agentConfig(){const e=this.tagValue("agent");if(e)try{return JSON.parse(e)}catch{return}}set agentConfig(e){this.removeTag("agent"),e&&this.tags.push(["agent",JSON.stringify(e)])}get templateTags(){return this.getMatchingTags("t").map(e=>e[1]).filter(Boolean)}set templateTags(e){this.tags=this.tags.filter(n=>n[0]!=="t"),e.forEach(n=>{n&&this.tags.push(["t",n])})}},READ_MARKER="read",WRITE_MARKER="write",NDKRelayList=class ti extends NDKEvent$1{static kinds=[10002];constructor(e,n){super(e,n),this.kind??=10002}static from(e){return new ti(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===READ_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set readRelayUrls(e){for(const n of e)this.tags.push(["r",n,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===WRITE_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set writeRelayUrls(e){for(const n of e)this.tags.push(["r",n,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(const n of e)this.tags.push(["r",n])}get relays(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").map(e=>e[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet$1(new Set(this.relays.map(e=>this.ndk?.pool.getRelay(e)).filter(e=>!!e)),this.ndk)}};function relayListFromKind3(t,e){try{const n=JSON.parse(e.content),r=new NDKRelayList(t),s=new Set,o=new Set;for(let[a,l]of Object.entries(n)){try{a=normalizeRelayUrl$1(a)}catch{continue}if(!l)s.add(a),o.add(a);else{const u=l;u.write&&o.add(a),u.read&&s.add(a)}}return r.readRelayUrls=Array.from(s),r.writeRelayUrls=Array.from(o),r}catch{}}var NDKRepost=class ni extends NDKEvent$1{_repostedEvents;static kinds=[6,16];static from(e){return new ni(e.ndk,e.rawEvent())}async repostedEvents(e,n){const r=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const s of this.repostedEventIds()){const o=filterForId(s),a=await this.ndk.fetchEvent(o,n);a&&r.push(e?e.from(a):a)}return r}repostedEventIds(){return this.tags.filter(e=>e[0]==="e"||e[0]==="a").map(e=>e[1])}};function filterForId(t){if(t.match(/:/)){const[e,n,r]=t.split(":");return{kinds:[Number.parseInt(e)],authors:[n],"#d":[r]}}return{ids:[t]}}var NDKSimpleGroupMemberList=class ri extends NDKEvent$1{relaySet;memberSet=new Set;static kind=39002;static kinds=[39002];constructor(e,n){super(e,n),this.kind??=39002,this.memberSet=new Set(this.members)}static from(e){return new ri(e.ndk,e)}get members(){return this.getMatchingTags("p").map(e=>e[1])}hasMember(e){return this.memberSet.has(e)}async publish(e,n,r){return e??=this.relaySet,super.publishReplaceable(e,n,r)}},NDKSimpleGroupMetadata=class ii extends NDKEvent$1{static kind=39e3;static kinds=[39e3];constructor(e,n){super(e,n),this.kind??=39e3}static from(e){return new ii(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){if(this.getMatchingTags("public").length>0)return"public";if(this.getMatchingTags("public").length>0)return"private"}set scope(e){this.removeTag("public"),this.removeTag("private"),e==="public"?this.tags.push(["public",""]):e==="private"&&this.tags.push(["private",""])}get access(){if(this.getMatchingTags("open").length>0)return"open";if(this.getMatchingTags("closed").length>0)return"closed"}set access(e){this.removeTag("open"),this.removeTag("closed"),e==="open"?this.tags.push(["open",""]):e==="closed"&&this.tags.push(["closed",""])}};function strToPosition(t){const[e,n]=t.split(",").map(Number);return{x:e,y:n}}function strToDimension(t){const[e,n]=t.split("x").map(Number);return{width:e,height:n}}var NDKStorySticker=class si{static Text="text";static Pubkey="pubkey";static Event="event";static Prompt="prompt";static Countdown="countdown";type;value;position;dimension;properties;constructor(e){if(Array.isArray(e)){const n=e;if(n[0]!=="sticker"||n.length<5)throw new Error("Invalid sticker tag");this.type=n[1],this.value=n[2],this.position=strToPosition(n[3]),this.dimension=strToDimension(n[4]);const r={};for(let s=5;s<n.length;s++){const[o,...a]=n[s].split(" ");r[o]=a.join(" ")}Object.keys(r).length>0&&(this.properties=r)}else this.type=e,this.value=void 0,this.position={x:0,y:0},this.dimension={width:0,height:0}}static fromTag(e){try{return new si(e)}catch{return null}}get style(){return this.properties?.style}set style(e){e?this.properties={...this.properties,style:e}:delete this.properties?.style}get rotation(){return this.properties?.rot?Number.parseFloat(this.properties.rot):void 0}set rotation(e){e!==void 0?this.properties={...this.properties,rot:e.toString()}:delete this.properties?.rot}get isValid(){return this.hasValidDimensions()&&this.hasValidPosition()}hasValidDimensions=()=>typeof this.dimension.width=="number"&&typeof this.dimension.height=="number"&&!Number.isNaN(this.dimension.width)&&!Number.isNaN(this.dimension.height);hasValidPosition=()=>typeof this.position.x=="number"&&typeof this.position.y=="number"&&!Number.isNaN(this.position.x)&&!Number.isNaN(this.position.y);toTag(){if(!this.isValid){const r=[this.hasValidDimensions()?void 0:"dimensions is invalid",this.hasValidPosition()?void 0:"position is invalid"].filter(Boolean);throw new Error(`Invalid sticker: ${r.join(", ")}`)}let e;switch(this.type){case"event":e=this.value.tagId();break;case"pubkey":e=this.value.pubkey;break;default:e=this.value}const n=["sticker",this.type,e,coordinates(this.position),dimension(this.dimension)];if(this.properties)for(const[r,s]of Object.entries(this.properties))n.push(`${r} ${s}`);return n}},NDKStory=class oi extends NDKEvent$1{static kind=23;static kinds=[23];_imeta;_dimensions;constructor(e,n){if(super(e,n),this.kind??=23,n)for(const r of n.tags)switch(r[0]){case"imeta":this._imeta=mapImetaTag(r);break;case"dim":this.dimensions=strToDimension(r[1]);break}}static from(e){return new oi(e.ndk,e)}get isValid(){return!!this.imeta}get imeta(){return this._imeta}set imeta(e){this._imeta=e,this.tags=this.tags.filter(n=>n[0]!=="imeta"),e&&this.tags.push(imetaTagToTag(e))}get dimensions(){const e=this.tagValue("dim");if(e)return strToDimension(e)}set dimensions(e){this.removeTag("dim"),e&&this.tags.push(["dim",`${e.width}x${e.height}`])}get duration(){const e=this.tagValue("dur");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("dur"),e!==void 0&&this.tags.push(["dur",e.toString()])}get stickers(){const e=[];for(const n of this.tags){if(n[0]!=="sticker"||n.length<5)continue;const r=NDKStorySticker.fromTag(n);r&&e.push(r)}return e}addSticker(e){let n;if(e instanceof NDKStorySticker)n=e;else{const r=["sticker",e.type,typeof e.value=="string"?e.value:"",coordinates(e.position),dimension(e.dimension)];if(e.properties)for(const[s,o]of Object.entries(e.properties))r.push(`${s} ${o}`);n=new NDKStorySticker(r),n.value=e.value}n.type==="pubkey"?this.tag(n.value):n.type==="event"&&this.tag(n.value),this.tags.push(n.toTag())}removeSticker(e){const n=this.stickers;if(e<0||e>=n.length)return;let r=0;for(let s=0;s<this.tags.length;s++)if(this.tags[s][0]==="sticker"){if(r===e){this.tags.splice(s,1);break}r++}}},coordinates=t=>`${t.x},${t.y}`,dimension=t=>`${t.width}x${t.height}`,NDKSubscriptionReceipt=class ai extends NDKEvent$1{debug;static kinds=[7003];constructor(e,n){super(e,n),this.kind??=7003,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new ai(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get subscriber(){const e=this.getMatchingTags("P")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set subscriber(e){this.removeTag("P"),e&&this.tags.push(["P",e.pubkey])}set subscriptionStart(e){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(e,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){return this.getMatchingTags("tier")?.[0]?.[1]}get isValid(){const e=this.validPeriod;if(!e||e.start>e.end)return!1;const n=this.getMatchingTags("p"),r=this.getMatchingTags("P");return!(n.length!==1||r.length!==1)}get validPeriod(){const e=this.getMatchingTags("valid")?.[0];if(e)try{return{start:new Date(Number.parseInt(e[1])*1e3),end:new Date(Number.parseInt(e[2])*1e3)}}catch{return}}set validPeriod(e){this.removeTag("valid"),e&&this.tags.push(["valid",Math.floor(e.start.getTime()/1e3).toString(),Math.floor(e.end.getTime()/1e3).toString()])}get startPeriod(){return this.validPeriod?.start}get endPeriod(){return this.validPeriod?.end}isActive(e){e??=new Date;const n=this.validPeriod;return!(!n||e<n.start||e>n.end)}},possibleIntervalFrequencies=["daily","weekly","monthly","quarterly","yearly"];function newAmount(t,e,n){return["amount",t.toString(),e,n]}function parseTagToSubscriptionAmount(t){const e=Number.parseInt(t[1]);if(Number.isNaN(e)||e===void 0||e===null||e<=0)return;const n=t[2];if(n===void 0||n==="")return;const r=t[3];if(r!==void 0&&possibleIntervalFrequencies.includes(r))return{amount:e,currency:n,term:r}}var NDKSubscriptionTier=class ci extends NDKArticle{static kind=37001;static kinds=[37001];constructor(e,n){const r=n?.kind??37001;super(e,n),this.kind=r}static from(e){return new ci(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(e=>e[1]).filter(e=>e!==void 0)}addPerk(e){this.tags.push(["perk",e])}get amounts(){return this.getMatchingTags("amount").map(e=>parseTagToSubscriptionAmount(e)).filter(e=>e!==void 0)}addAmount(e,n,r){this.tags.push(newAmount(e,n,r))}set relayUrl(e){this.tags.push(["r",e])}get relayUrls(){return this.getMatchingTags("r").map(e=>e[1]).filter(e=>e!==void 0)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(e){this.removeTag("p"),e&&this.tags.push(["p",e])}get isValid(){return this.title!==void 0&&this.amounts.length>0}},NDKSubscriptionStart=class li extends NDKEvent$1{debug;static kinds=[7001];constructor(e,n){super(e,n),this.kind??=7001,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new li(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get amount(){const e=this.getMatchingTags("amount")?.[0];if(e)return parseTagToSubscriptionAmount(e)}set amount(e){this.removeTag("amount"),e&&this.tags.push(newAmount(e.amount,e.currency,e.term))}get tierId(){const e=this.getMatchingTags("e")?.[0],n=this.getMatchingTags("a")?.[0];if(!(!e||!n))return e[1]??n[1]}set tier(e){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),e&&(this.tag(e),this.removeTag("p"),this.tags.push(["p",e.pubkey]),this.tags.push(["event",JSON.stringify(e.rawEvent())]))}async fetchTier(){const e=this.tagValue("event");if(e)try{const s=JSON.parse(e);return new NDKSubscriptionTier(this.ndk,s)}catch{this.debug("Failed to parse event tag")}const n=this.tierId;if(!n)return;const r=await this.ndk?.fetchEvent(n);if(r)return NDKSubscriptionTier.from(r)}get isValid(){return this.getMatchingTags("amount").length!==1?(this.debug("Invalid # of amount tag"),!1):this.amount?this.getMatchingTags("p").length!==1?(this.debug("Invalid # of p tag"),!1):this.recipient?!0:(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},NDKTask=class ui extends NDKEvent$1{static kind=1934;static kinds=[1934];constructor(e,n){super(e,n),this.kind=1934}static from(e){return new ui(e.ndk,e.rawEvent())}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get title(){return this.tagValue("title")}set project(e){this.removeTag("a"),this.tags.push(e.tagReference())}get projectSlug(){const e=this.getMatchingTags("a")[0];return e?e[1].split(/:/)?.[2]:void 0}},NDKThread=class hi extends NDKEvent$1{static kind=11;static kinds=[11];constructor(e,n){super(e,n),this.kind??=11}static from(e){return new hi(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}},NDKVideo=class di extends NDKEvent$1{static kind=21;static kinds=[34235,34236,22,21];_imetas;static from(e){return new di(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get thumbnail(){let e;return this.imetas&&this.imetas.length>0&&(e=this.imetas[0].image?.[0]),e??this.tagValue("thumb")}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(n=>n[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}async generateTags(){if(super.generateTags(),!this.kind&&this.imetas?.[0]?.dim){const[e,n]=this.imetas[0].dim.split("x"),r=e&&n&&Number.parseInt(e)<Number.parseInt(n);this.duration&&this.duration<120&&r?this.kind=22:this.kind=21}return super.generateTags()}get duration(){const e=this.tagValue("duration");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("duration"),e!==void 0&&this.tags.push(["duration",Math.floor(e).toString()])}},NDKWiki=class fi extends NDKArticle{static kind=30818;static kinds=[30818];static from(e){return new fi(e.ndk,e.rawEvent())}get isDefered(){return this.hasTag("a","defer")}get deferedId(){return this.tagValue("a","defer")}set defer(e){this.removeTag("a","defer"),this.tag(e,"defer")}},NDKWikiMergeRequest=class pi extends NDKEvent$1{static kinds=[818];static from(e){return new pi(e.ndk,e.rawEvent())}get targetId(){return this.tagValue("a")}set target(e){this.tags=this.tags.filter(n=>{if(n[0]==="a"||n[0]==="e"&&n[3]!=="source")return!0}),this.tag(e)}get sourceId(){return this.tagValue("e","source")}set source(e){this.removeTag("e","source"),this.tag(e,"source",!1,"e")}},registeredEventClasses=new Set;function wrapEvent(t){const e=new Map,r=[...[NDKImage,NDKVideo,NDKCashuMintList$1,NDKArticle,NDKHighlight,NDKDraft,NDKWiki,NDKWikiMergeRequest,NDKNutzap,NDKProject,NDKTask,NDKProjectTemplate,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKSubscriptionTier,NDKSubscriptionStart,NDKSubscriptionReceipt,NDKList,NDKRelayList,NDKStory,NDKBlossomList,NDKFollowPack,NDKThread,NDKRepost,NDKClassified,NDKAppHandlerEvent,NDKDVMJobFeedback,NDKCashuMintAnnouncement,NDKFedimintMint,NDKMintRecommendation],...registeredEventClasses];for(const o of r)for(const a of o.kinds)e.set(a,o);const s=e.get(t.kind);return s?s.from(t):t}function checkMissingKind(t,e){(t.kind===void 0||t.kind===null)&&e("event-missing-kind",`Cannot sign event without 'kind'.

 Event data:
    content: ${t.content?`"${t.content.substring(0,50)}${t.content.length>50?"...":""}"`:"(empty)"}
    tags: ${t.tags.length} tag${t.tags.length!==1?"s":""}
    kind: ${t.kind} 

Set event.kind before signing.`,"Example: event.kind = 1; // for text note",!1)}function checkContentIsObject(t,e){if(typeof t.content=="object"){const n=JSON.stringify(t.content,null,2).substring(0,200);e("event-content-is-object",`Event content is an object. Content must be a string.

 Your content (${typeof t.content}):
${n}${JSON.stringify(t.content).length>200?"...":""}

 event.content = { ... }  // WRONG
 event.content = JSON.stringify({ ... })  // CORRECT`,"Use JSON.stringify() for structured data: event.content = JSON.stringify(data)",!1)}}function checkCreatedAtMilliseconds(t,e){if(t.created_at&&t.created_at>1e10){const n=Math.floor(t.created_at/1e3),r=new Date(t.created_at).toISOString();e("event-created-at-milliseconds",`Event created_at is in milliseconds, not seconds.

 Your value:
    created_at: ${t.created_at} 
    Interpreted as: ${r}
    Should be: ${n} 

Nostr timestamps MUST be in seconds since Unix epoch.`,"Use Math.floor(Date.now() / 1000) instead of Date.now()",!1)}}function checkInvalidPTags(t,e){t.getMatchingTags("p").forEach((r,s)=>{if(r[1]&&!/^[0-9a-f]{64}$/i.test(r[1])){const o=JSON.stringify(r);e("tag-invalid-p-tag",`p-tag[${s}] has invalid pubkey.

 Your tag:
   ${o}

 Invalid value: "${r[1]}"
    Length: ${r[1].length} (expected 64)
    Format: ${r[1].startsWith("npub")?"bech32 (npub)":"unknown"}

p-tags MUST contain 64-character hex pubkeys.`,r[1].startsWith("npub")?`Use ndkUser.pubkey instead of npub:
    event.tags.push(['p', ndkUser.pubkey])
    event.tags.push(['p', 'npub1...'])`:"p-tags must contain valid hex pubkeys (64 characters, 0-9a-f)",!1)}})}function checkInvalidETags(t,e){t.getMatchingTags("e").forEach((r,s)=>{if(r[1]&&!/^[0-9a-f]{64}$/i.test(r[1])){const o=JSON.stringify(r),a=r[1].startsWith("note")||r[1].startsWith("nevent");e("tag-invalid-e-tag",`e-tag[${s}] has invalid event ID.

 Your tag:
   ${o}

 Invalid value: "${r[1]}"
    Length: ${r[1].length} (expected 64)
    Format: ${a?"bech32 (note/nevent)":"unknown"}

e-tags MUST contain 64-character hex event IDs.`,a?`Use event.id instead of bech32:
    event.tags.push(['e', referencedEvent.id])
    event.tags.push(['e', 'note1...'])`:"e-tags must contain valid hex event IDs (64 characters, 0-9a-f)",!1)}})}function checkManualReplyMarkers(t,e,n){if(t.kind!==1||n.has(t))return;const r=t.tags.filter(s=>s[0]==="e"&&(s[3]==="reply"||s[3]==="root"));if(r.length>0){const s=r.map((o,a)=>`   ${a+1}. ${JSON.stringify(o)}`).join(`
`);e("event-manual-reply-markers",`Event has ${r.length} e-tag(s) with manual reply/root markers.

 Your tags with markers:
${s}

  Manual reply markers detected! This will cause incorrect threading.`,`Reply events MUST be created using .reply():

    CORRECT:
   const replyEvent = originalEvent.reply();
   replyEvent.content = 'good point!';
   await replyEvent.publish();

    WRONG:
   event.tags.push(['e', eventId, '', 'reply']);

NDK handles all reply threading automatically - never add reply/root markers manually.`)}}function checkHashtagsWithPrefix(t,e){t.getMatchingTags("t").forEach((r,s)=>{if(r[1]&&r[1].startsWith("#")){const o=JSON.stringify(r);e("tag-hashtag-with-prefix",`t-tag[${s}] contains hashtag with # prefix.

 Your tag:
   ${o}

 Invalid value: "${r[1]}"

Hashtag tags should NOT include the # symbol.`,`Remove the # prefix from hashtag tags:
    event.tags.push(['t', 'nostr'])
    event.tags.push(['t', '#nostr'])`,!1)}})}function checkReplaceableWithOldTimestamp(t,e){if(t.kind===void 0||t.kind===null||!t.created_at||!t.isReplaceable())return;const n=Math.floor(Date.now()/1e3),r=n-t.created_at;if(r>10){const o=Math.floor(r/60),a=o>0?`${o} minute${o!==1?"s":""}`:`${r} seconds`;e("event-replaceable-old-timestamp",`Publishing a replaceable event with an old created_at timestamp.

 Event details:
    kind: ${t.kind} (replaceable)
    created_at: ${t.created_at}
    age: ${a} old
    current time: ${n}

  This is wrong and will be rejected by relays.`,`For replaceable events, use publishReplaceable():

    CORRECT:
   await event.publishReplaceable();
   // Automatically updates created_at to now

    WRONG:
   await event.publish();
   // Uses old created_at`)}}function signing(t,e,n,r){checkMissingKind(t,e),checkContentIsObject(t,e),checkCreatedAtMilliseconds(t,e),checkInvalidPTags(t,e),checkInvalidETags(t,e),checkHashtagsWithPrefix(t,e),checkManualReplyMarkers(t,n,r)}function publishing(t,e){checkReplaceableWithOldTimestamp(t,e)}function isNip33Pattern(t){const e=Array.isArray(t)?t:[t];if(e.length!==1)return!1;const n=e[0];return n.kinds&&Array.isArray(n.kinds)&&n.kinds.length===1&&n.authors&&Array.isArray(n.authors)&&n.authors.length===1&&n["#d"]&&Array.isArray(n["#d"])&&n["#d"].length===1}function isReplaceableEventFilter(t){const e=Array.isArray(t)?t:[t];return e.length===0?!1:e.every(n=>!n.kinds||!Array.isArray(n.kinds)||n.kinds.length===0||!n.authors||!Array.isArray(n.authors)||n.authors.length===0?!1:n.kinds.every(s=>s===0||s===3||s>=1e4&&s<=19999))}function formatFilter(t){return JSON.stringify(t,null,2).split(`
`).map((n,r)=>r===0?n:`   ${n}`).join(`
`)}function fetchingEvents(t,e,n,r,s){if(s(),e?.cacheUsage==="ONLY_CACHE")return;const o=Array.isArray(t)?t:[t],a=o.map(formatFilter).join(`

   ---

   `);if(isNip33Pattern(t))o[0],n("fetch-events-usage",`For fetching a NIP-33 addressable event, use fetchEvent() with the naddr directly.

 Your filter:
   `+a+`

   BAD:  const decoded = nip19.decode(naddr);
           const events = await ndk.fetchEvents({
             kinds: [decoded.data.kind],
             authors: [decoded.data.pubkey],
             "#d": [decoded.data.identifier]
           });
           const event = Array.from(events)[0];

   GOOD: const event = await ndk.fetchEvent(naddr);
   GOOD: const event = await ndk.fetchEvent('naddr1...');

fetchEvent() handles naddr decoding automatically and returns the event directly.`);else{if(isReplaceableEventFilter(t))return;{if(!r())return;let l="";const u=o.some(b=>b.limit!==void 0),p=new Set(o.flatMap(b=>b.kinds||[])).size,y=new Set(o.flatMap(b=>b.authors||[])).size;if(u){const b=Math.max(...o.map(w=>w.limit||0));l+=`
    Limit: ${b} event${b!==1?"s":""}`}p>0&&(l+=`
    Kinds: ${p} type${p!==1?"s":""}`),y>0&&(l+=`
    Authors: ${y} author${y!==1?"s":""}`),n("fetch-events-usage",`fetchEvents() is a BLOCKING operation that waits for EOSE.
In most cases, you should use subscribe() instead.

 Your filter`+(o.length>1?"s":"")+`:
   `+a+(l?`

 Filter analysis:`+l:"")+`

   BAD:  const events = await ndk.fetchEvents(filter);
   GOOD: ndk.subscribe(filter, { onEvent: (e) => ... });

Only use fetchEvents() when you MUST block until data arrives.`,"For one-time queries, use fetchEvent() instead of fetchEvents() when expecting a single result.")}}}var GuardrailCheckId={NDK_NO_CACHE:"ndk-no-cache",FILTER_BECH32_IN_ARRAY:"filter-bech32-in-array",FILTER_INVALID_HEX:"filter-invalid-hex",FILTER_ONLY_LIMIT:"filter-only-limit",FILTER_EMPTY:"filter-empty",FILTER_SINCE_AFTER_UNTIL:"filter-since-after-until",FILTER_INVALID_A_TAG:"filter-invalid-a-tag",FILTER_HASHTAG_WITH_PREFIX:"filter-hashtag-with-prefix"};function checkCachePresence(t,e){e(GuardrailCheckId.NDK_NO_CACHE)&&setTimeout(()=>{if(!t.cacheAdapter){const s=`
 AI_GUARDRAILS WARNING: NDK initialized without a cache adapter. Apps perform significantly better with caching.

 ${typeof window<"u"?"Consider using @nostr-dev-kit/ndk-cache-dexie or @nostr-dev-kit/ndk-cache-sqlite-wasm":"Consider using @nostr-dev-kit/ndk-cache-redis or @nostr-dev-kit/ndk-cache-sqlite"}

 To disable this check:
   ndk.aiGuardrails.skip('${GuardrailCheckId.NDK_NO_CACHE}')
   or set: ndk.aiGuardrails = { skip: new Set(['${GuardrailCheckId.NDK_NO_CACHE}']) }`;console.warn(s)}},2500)}var AIGuardrails=class{enabled=!1;skipSet=new Set;extensions=new Map;_nextCallDisabled=null;_replyEvents=new WeakSet;_fetchEventsCount=0;_subscribeCount=0;constructor(t=!1){this.setMode(t)}register(t,e){this.extensions.has(t)&&console.warn(`AIGuardrails: Extension '${t}' already registered, overwriting`);const n={};for(const[r,s]of Object.entries(e))typeof s=="function"&&(n[r]=(...o)=>{this.enabled&&s(...o,this.shouldCheck.bind(this),this.error.bind(this),this.warn.bind(this))});this.extensions.set(t,n),this[t]=n}setMode(t){typeof t=="boolean"?(this.enabled=t,this.skipSet.clear()):t&&typeof t=="object"&&(this.enabled=!0,this.skipSet=t.skip||new Set)}isEnabled(){return this.enabled}shouldCheck(t){return!(!this.enabled||this.skipSet.has(t)||this._nextCallDisabled==="all"||this._nextCallDisabled&&this._nextCallDisabled.has(t))}skip(t){this.skipSet.add(t)}enable(t){this.skipSet.delete(t)}getSkipped(){return Array.from(this.skipSet)}captureAndClearNextCallDisabled(){const t=this._nextCallDisabled;return this._nextCallDisabled=null,t}incrementFetchEventsCount(){this._fetchEventsCount++}incrementSubscribeCount(){this._subscribeCount++}shouldWarnAboutFetchEventsRatio(){const t=this._fetchEventsCount+this._subscribeCount;return t<=6?!1:this._fetchEventsCount/t>.5}error(t,e,n,r=!0){if(!this.shouldCheck(t))return;const s=this.formatMessage(t,"ERROR",e,n,r);throw console.error(s),new Error(s)}warn(t,e,n){if(!this.shouldCheck(t))return;const r=this.formatMessage(t,"WARNING",e,n,!0);throw console.error(r),new Error(r)}formatMessage(t,e,n,r,s=!0){let o=`
 AI_GUARDRAILS ${e}: ${n}`;return r&&(o+=`

 ${r}`),s&&(o+=`

 To disable this check:
   ndk.guardrailOff('${t}').yourMethod()  // For one call`,o+=`
   ndk.aiGuardrails.skip('${t}')  // Permanently`,o+=`
   or set: ndk.aiGuardrails = { skip: new Set(['${t}']) }`),o}ndkInstantiated(t){this.enabled&&checkCachePresence(t,this.shouldCheck.bind(this))}ndk={fetchingEvents:(t,e)=>{this.enabled&&fetchingEvents(t,e,this.warn.bind(this),this.shouldWarnAboutFetchEventsRatio.bind(this),this.incrementFetchEventsCount.bind(this))}};event={signing:t=>{this.enabled&&signing(t,this.error.bind(this),this.warn.bind(this),this._replyEvents)},publishing:t=>{this.enabled&&publishing(t,this.warn.bind(this))},received:(t,e)=>{this.enabled},creatingReply:t=>{this.enabled&&this._replyEvents.add(t)}};subscription={created:(t,e)=>{this.enabled&&this.incrementSubscribeCount()}};relay={connected:t=>{this.enabled}}};function processFilters(t,e="validate",n,r){if(e==="ignore")return t;const s=[],o=t.map((a,l)=>(r?.aiGuardrails.isEnabled()&&runAIGuardrailsForFilter(a,l,r),processFilter(a,e,l,s,n)));if(e==="validate"&&s.length>0)throw new Error(`Invalid filter(s) detected:
${s.join(`
`)}`);return o}function processFilter(t,e,n,r,s){const o=e==="validate",a=o?t:{...t};if(t.ids){const l=[];t.ids.forEach((u,p)=>{u===void 0?o?r.push(`Filter[${n}].ids[${p}] is undefined`):s?.(`Fixed: Removed undefined value at ids[${p}]`):typeof u!="string"?o?r.push(`Filter[${n}].ids[${p}] is not a string (got ${typeof u})`):s?.(`Fixed: Removed non-string value at ids[${p}] (was ${typeof u})`):isValidHex64(u)?l.push(u):o?r.push(`Filter[${n}].ids[${p}] is not a valid 64-char hex string: "${u}"`):s?.(`Fixed: Removed invalid hex string at ids[${p}]`)}),o||(a.ids=l.length>0?l:void 0)}if(t.authors){const l=[];t.authors.forEach((u,p)=>{u===void 0?o?r.push(`Filter[${n}].authors[${p}] is undefined`):s?.(`Fixed: Removed undefined value at authors[${p}]`):typeof u!="string"?o?r.push(`Filter[${n}].authors[${p}] is not a string (got ${typeof u})`):s?.(`Fixed: Removed non-string value at authors[${p}] (was ${typeof u})`):isValidHex64(u)?l.push(u):o?r.push(`Filter[${n}].authors[${p}] is not a valid 64-char hex pubkey: "${u}"`):s?.(`Fixed: Removed invalid hex pubkey at authors[${p}]`)}),o||(a.authors=l.length>0?l:void 0)}if(t.kinds){const l=[];t.kinds.forEach((u,p)=>{u===void 0?o?r.push(`Filter[${n}].kinds[${p}] is undefined`):s?.(`Fixed: Removed undefined value at kinds[${p}]`):typeof u!="number"?o?r.push(`Filter[${n}].kinds[${p}] is not a number (got ${typeof u})`):s?.(`Fixed: Removed non-number value at kinds[${p}] (was ${typeof u})`):Number.isInteger(u)?u<0||u>65535?o?r.push(`Filter[${n}].kinds[${p}] is out of valid range (0-65535): ${u}`):s?.(`Fixed: Removed out-of-range kind at kinds[${p}]: ${u}`):l.push(u):o?r.push(`Filter[${n}].kinds[${p}] is not an integer: ${u}`):s?.(`Fixed: Removed non-integer value at kinds[${p}]: ${u}`)}),o||(a.kinds=l.length>0?l:void 0)}for(const l in t)if(l.startsWith("#")&&l.length===2){const u=t[l];if(Array.isArray(u)){const p=[];u.forEach((y,b)=>{y===void 0?o?r.push(`Filter[${n}].${l}[${b}] is undefined`):s?.(`Fixed: Removed undefined value at ${l}[${b}]`):typeof y!="string"?o?r.push(`Filter[${n}].${l}[${b}] is not a string (got ${typeof y})`):s?.(`Fixed: Removed non-string value at ${l}[${b}] (was ${typeof y})`):(l==="#e"||l==="#p")&&!isValidHex64(y)?o?r.push(`Filter[${n}].${l}[${b}] is not a valid 64-char hex string: "${y}"`):s?.(`Fixed: Removed invalid hex string at ${l}[${b}]`):p.push(y)}),o||(a[l]=p.length>0?p:void 0)}}return o||Object.keys(a).forEach(l=>{a[l]===void 0&&delete a[l]}),a}function runAIGuardrailsForFilter(t,e,n){const r=n.aiGuardrails,s=JSON.stringify(t,null,2);if(Object.keys(t).length===1&&t.limit!==void 0&&r.error(GuardrailCheckId.FILTER_ONLY_LIMIT,`Filter[${e}] contains only 'limit' without any filtering criteria.

 Your filter:
${s}

  This will fetch random events from relays without any criteria.`,`Add filtering criteria:
    { kinds: [1], limit: 10 }
    { authors: [pubkey], limit: 10 }
    { limit: 10 }`),Object.keys(t).length===0&&r.error(GuardrailCheckId.FILTER_EMPTY,`Filter[${e}] is empty.

 Your filter:
${s}

  This will request ALL events from relays, which is never what you want.`,"Add filtering criteria like 'kinds', 'authors', or tags.",!1),t.since!==void 0&&t.until!==void 0&&t.since>t.until){const a=new Date(t.since*1e3).toISOString(),l=new Date(t.until*1e3).toISOString();r.error(GuardrailCheckId.FILTER_SINCE_AFTER_UNTIL,`Filter[${e}] has 'since' AFTER 'until'.

 Your filter:
${s}

 since: ${t.since} (${a})
 until: ${t.until} (${l})

No events can match this time range!`,"'since' must be BEFORE 'until'. Both are Unix timestamps in seconds.",!1)}const o=/^n(addr|event|ote|pub|profile)1/;t.ids&&t.ids.forEach((a,l)=>{typeof a=="string"&&(o.test(a)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].ids[${l}] contains bech32: "${a}". IDs must be hex, not bech32.`,'Use filterFromId() to decode bech32 first: import { filterFromId } from "@nostr-dev-kit/ndk"',!1):isValidHex64(a)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].ids[${l}] is not a valid 64-char hex string: "${a}"`,`Event IDs must be 64-character hexadecimal strings. Invalid IDs often come from corrupted data in user-generated lists. Always validate hex strings before using them in filters:

   const validIds = ids.filter(id => /^[0-9a-f]{64}$/i.test(id));`,!1))}),t.authors&&t.authors.forEach((a,l)=>{typeof a=="string"&&(o.test(a)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].authors[${l}] contains bech32: "${a}". Authors must be hex pubkeys, not npub.`,"Use ndkUser.pubkey instead. Example: { authors: [ndkUser.pubkey] }",!1):isValidHex64(a)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].authors[${l}] is not a valid 64-char hex pubkey: "${a}"`,`Kind:3 follow lists can contain invalid entries like labels ("Follow List"), partial strings ("highlig"), or other corrupted data. You MUST validate all pubkeys before using them in filters.

   Example:
   const validPubkeys = pubkeys.filter(p => /^[0-9a-f]{64}$/i.test(p));
   ndk.subscribe({ authors: validPubkeys, kinds: [1] });`,!1))});for(const a in t)if(a.startsWith("#")&&a.length===2){const l=t[a];Array.isArray(l)&&l.forEach((u,p)=>{typeof u=="string"&&(a==="#e"||a==="#p")&&(o.test(u)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].${a}[${p}] contains bech32: "${u}". Tag values must be decoded.`,"Use filterFromId() or nip19.decode() to get the hex value first.",!1):isValidHex64(u)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].${a}[${p}] is not a valid 64-char hex string: "${u}"`,`${a==="#e"?"Event IDs":"Public keys"} in tag filters must be 64-character hexadecimal strings. Kind:3 follow lists and other user-generated content can contain invalid data. Always filter before using:

   const validValues = values.filter(v => /^[0-9a-f]{64}$/i.test(v));`,!1))})}t["#a"]&&t["#a"]?.forEach((l,u)=>{if(typeof l=="string")if(!/^\d+:[0-9a-f]{64}:.*$/.test(l))r.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${u}] has invalid format: "${l}". Must be "kind:pubkey:d-tag".`,'Example: "30023:fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52:my-article"',!1);else{const p=Number.parseInt(l.split(":")[0],10);(p<3e4||p>39999)&&r.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${u}] uses non-addressable kind ${p}: "${l}". #a filters are only for addressable events (kinds 30000-39999).`,`Addressable events include:
    30000-30039: Parameterized Replaceable Events (profiles, settings, etc.)
    30040-39999: Other addressable events

For regular events (kind ${p}), use:
    #e filter for specific event IDs
    kinds + authors filters for event queries`,!1)}}),t["#t"]&&t["#t"]?.forEach((l,u)=>{typeof l=="string"&&l.startsWith("#")&&r.error(GuardrailCheckId.FILTER_HASHTAG_WITH_PREFIX,`Filter[${e}].#t[${u}] contains hashtag with # prefix: "${l}". Hashtag values should NOT include the # symbol.`,`Remove the # prefix from hashtag filters:
    { "#t": ["nostr"] }
    { "#t": ["#nostr"] }`,!1)})}function queryFullyFilled(t){return!!(filterIncludesIds(t.filter)&&resultHasAllRequestedIds(t))}function filterIncludesIds(t){return!!t.ids}function resultHasAllRequestedIds(t){const e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}function filterFromId(t){let e;if(t.match(NIP33_A_REGEX)){const[n,r,s]=t.split(":"),o={authors:[r],kinds:[Number.parseInt(n)]};return s&&(o["#d"]=[s]),o}if(t.match(BECH32_REGEX))try{switch(e=nip19_exports$2.decode(t),e.type){case"nevent":{const n={ids:[e.data.id]};return e.data.author&&(n.authors=[e.data.author]),e.data.kind&&(n.kinds=[e.data.kind]),n}case"note":return{ids:[e.data]};case"naddr":{const n={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(n["#d"]=[e.data.identifier]),n}}}catch(n){console.error("Error decoding",t,n)}return{ids:[t]}}function isNip33AValue(t){return t.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(t,e){try{const n=nip19_exports$2.decode(t);if(["naddr","nevent"].includes(n?.type)){const r=n.data;if(r?.relays)return r.relays.map(s=>new NDKRelay$1(s,e.relayAuthDefaultPolicy,e))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"],includeMuted:!1},NDKSubscription=class extends lib$1.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;exclusiveRelay=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;mostRecentCacheEventTimestamp;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;cacheUnconstrainFilter;constructor(t,e,n,r){super(),this.ndk=t,this.opts={...defaultOpts,...n||{}},this.pool=this.opts.pool||t.pool;const s=Array.isArray(e)?e:[e],o=t.filterValidationMode==="validate"?"validate":t.filterValidationMode==="fix"?"fix":"ignore";if(this.filters=processFilters(s,o,t.debug,t),this.filters.length===0)throw new Error("Subscription must have at least one filter");this.subId=r||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.debug=t.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.opts.relaySet?this.relaySet=this.opts.relaySet:this.opts.relayUrls&&(this.relaySet=NDKRelaySet$1.fromRelayUrls(this.opts.relayUrls,this.ndk)),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter,this.exclusiveRelay=this.opts.exclusiveRelay||!1,this.opts.onEvent&&this.on("event",this.opts.onEvent),this.opts.onEose&&this.on("eose",this.opts.onEose),this.opts.onClose&&this.on("close",this.opts.onClose)}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters?.keys()).filter(e=>!this.eosesSeen.has(this.pool.getRelay(e,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts.addSinceFromCache?!0:this.opts?.cacheUsage==="ONLY_RELAY"?!1:(this.filters.some(e=>e.kinds?.some(n=>kindIsEphemeral(n))),!0)}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.addSinceFromCache?!0:!!this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&this.opts.cacheUsage!=="PARALLEL"}start(t=!0){let e;const n=s=>{for(const o of s)o.created_at&&(!this.mostRecentCacheEventTimestamp||o.created_at>this.mostRecentCacheEventTimestamp)&&(this.mostRecentCacheEventTimestamp=o.created_at),this.eventReceived(o,void 0,!0,!1);t||(e=s)},r=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(e=this.startWithCache(),e instanceof Promise?this.shouldWaitForCache()?(e.then(s=>{if(n(s),queryFullyFilled(this)){this.emit("eose",this);return}r()}),null):(e.then(s=>{n(s),this.shouldQueryRelays()||this.emit("eose",this)}),this.shouldQueryRelays()&&r(),null):(n(e),queryFullyFilled(this)?this.emit("eose",this):r(),e)):(r(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{if(this.relayFilters?.has(t.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor).get(t.url)&&(this.relayFilters?.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some(t=>t.authors?.length)}startWithCache(){return this.ndk.cacheAdapter?.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){let t=this.filters;if(this.opts.addSinceFromCache&&this.mostRecentCacheEventTimestamp){const e=this.mostRecentCacheEventTimestamp+1;t=t.map(n=>({...n,since:Math.max(n.since||0,e)}))}if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,t,this.pool,this.opts.relayGoalPerAuthor);else{this.relayFilters=new Map;for(const e of this.relaySet.relays)this.relayFilters.set(e.url,t)}for(const[e,n]of this.relayFilters)this.pool.getRelay(e,!0,!0,n).subscribe(this,n)}refreshRelayConnections(){if(this.relaySet&&this.relaySet.relays.size>0)return;const t=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor);for(const[e,n]of t)this.relayFilters?.has(e)||(this.relayFilters?.set(e,n),this.pool.getRelay(e,!0,!0,n).subscribe(this,n))}eventReceived(t,e,n=!1,r=!1){const s=t.id,o=this.eventFirstSeen.has(s);let a;if(t instanceof NDKEvent$1&&(a=t),o){const l=Date.now()-(this.eventFirstSeen.get(s)||0);if(this.emit("event:dup",t,e,l,this,n,r),this.opts?.onEventDup&&this.opts.onEventDup(t,e,l,this,n,r),!n&&!r&&e&&this.ndk.cacheAdapter?.setEventDup&&!this.opts.dontSaveToCache&&(a??=t instanceof NDKEvent$1?t:new NDKEvent$1(this.ndk,t),this.ndk.cacheAdapter.setEventDup(a,e)),e){const u=verifiedSignatures$1.get(s);if(u&&typeof u=="string")if(t.sig===u)e.addValidatedEvent();else{const p=t instanceof NDKEvent$1?t:new NDKEvent$1(this.ndk,t);this.ndk.reportInvalidSignature(p,e)}}}else{if(a??=new NDKEvent$1(this.ndk,t),a.ndk=this.ndk,a.relay=e,!n&&!r){if(!this.skipValidation&&!a.isValid){this.debug("Event failed validation %s from relay %s",s,e?.url);return}if(e)if(e.shouldValidateEvent()&&!this.skipVerification)if(a.relay=e,this.ndk.asyncSigVerification)a.verifySignature(!0);else{if(!a.verifySignature(!0)){this.debug("Event failed signature validation",t),this.ndk.reportInvalidSignature(a,e);return}e.addValidatedEvent()}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(a,this.filters,e)}if(!this.opts.includeMuted&&this.ndk.muteFilter&&this.ndk.muteFilter(a)){this.debug("Event muted, skipping");return}(!r||this.skipOptimisticPublishEvent!==!0)&&(this.emitEvent(this.opts?.wrap??!1,a,e,n,r),this.eventFirstSeen.set(s,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(t,e,n,r,s){const o=t?wrapEvent(e):e;o instanceof Promise?o.then(a=>this.emitEvent(!1,a,n,r,s)):o&&this.emit("event",o,n,this,r,s)}closedReceived(t,e){this.emit("closed",t,e)}eoseTimeout;eosed=!1;eoseReceived(t){this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const n=this.eosesSeen.size===this.relayFilters?.size,r=queryFullyFilled(this),s=o=>{this.debug("Performing EOSE: %s %d",o,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,this.opts?.closeOnEose&&this.stop())};if(r||n)s("query filled or seen all");else if(this.relayFilters){let o=1e3;const a=new Set(this.pool.connectedRelays().map(p=>p.url)),l=Array.from(this.relayFilters.keys()).filter(p=>a.has(p));if(l.length===0){this.debug("No connected relays, waiting for all relays to connect",Array.from(this.relayFilters.keys()).join(", "));return}const u=this.eosesSeen.size/l.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:u,seen:this.eosesSeen.size,total:l.length}),this.eosesSeen.size>=2&&u>=.5){if(o=o*(1-u),o===0){s("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const p=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,e!==void 0&&e<20?this.eoseTimeout=setTimeout(p,o):s(`send eose timeout: ${o}`)};this.eoseTimeout=setTimeout(p,o)}}}},kindIsEphemeral=t=>t>=2e4&&t<3e4;async function follows$1(t,e,n=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(r){const s=new Set;return r.tags.forEach(o=>{o[0]==="p"&&o[1]&&isValidPubkey(o[1])&&s.add(o[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(s)),[...s].reduce((o,a)=>{const l=new NDKUser$1({pubkey:a});return l.ndk=this.ndk,o.add(l),o},new Set)}return new Set}var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For$1(t,e,n=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter?.loadNip05){const u=await t.cacheAdapter.loadNip05(e);if(u!=="missing"){if(u){const p=new NDKUser$1({pubkey:u.pubkey,relayUrls:u.relays,nip46Urls:u.nip46});return p.ndk=t,p}if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX$1);if(!s)return null;const[o,a="_",l]=s;try{const u=await n(`https://${l}/.well-known/nostr.json?name=${a}`,r),{names:p,relays:y,nip46:b}=parseNIP05Result$1(await u.json()),w=p[a.toLowerCase()];let _=null;return w&&(_={pubkey:w,relays:y?.[w],nip46:b?.[w]}),t?.cacheAdapter?.saveNip05&&t.cacheAdapter.saveNip05(e,_),_}catch(u){return t?.cacheAdapter?.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,u),null}}})}function parseNIP05Result$1(t){const e={names:{}};for(const[n,r]of Object.entries(t.names))typeof n=="string"&&typeof r=="string"&&(e.names[n.toLowerCase()]=r);if(t.relays){e.relays={};for(const[n,r]of Object.entries(t.relays))typeof n=="string"&&Array.isArray(r)&&(e.relays[n]=r.filter(s=>typeof s=="string"))}if(t.nip46){e.nip46={};for(const[n,r]of Object.entries(t.nip46))typeof n=="string"&&Array.isArray(r)&&(e.nip46[n]=r.filter(s=>typeof s=="string"))}return e}function profileFromEvent$1(t){const e={};let n;try{n=JSON.parse(t.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const r of Object.keys(n))switch(r){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.picture=n.picture||n.image,e.image=e.picture;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"website":e.website=n.website;break;default:e[r]=n[r];break}return e.created_at=t.created_at,e}function serializeProfile$1(t){const e={};for(const[n,r]of Object.entries(t))switch(n){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[n]=r;break}return JSON.stringify(e)}var NDKUser$1=class yi{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const n=nip19_exports$2.decode(e.nprofile);n.type==="nprofile"&&(this._pubkey=n.data.pubkey,n.data.relays&&n.data.relays.length>0&&this.relayUrls.push(...n.data.relays))}catch(n){console.error("Failed to decode nprofile",n)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(n=>n.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const n=async a=>{if(!e)return a;let l;const u=new Promise((p,y)=>{l=setTimeout(()=>y(new Error("Timeout")),e)});try{const p=await Promise.race([a,u]);return l&&clearTimeout(l),p}catch(p){if(p instanceof Error&&p.message==="Timeout")try{return await a}catch{return}return}},[r,s]=await Promise.all([n(this.fetchProfile()),n(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),o=new Map;if(s){const a=NDKCashuMintList$1.from(s);a.mints.length>0&&o.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(r){const{lud06:a,lud16:l}=r;o.set("nip57",{lud06:a,lud16:l})}return o}static async fromNip05(e,n,r=!1){if(!n)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const o=await getNip05For$1(n,e,n?.httpFetch,s);if(o){const a=new yi({pubkey:o.pubkey,relayUrls:o.relays,nip46Urls:o.nip46});return a.ndk=n,a}}async fetchProfile(e,n=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let s=null;if(this.ndk.cacheAdapter.fetchProfileSync?s=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(s=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),s)return this.profile=s,s}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=profileFromEvent$1(r),n&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows$1.bind(this);async followSet(e,n,r=3){const s=await this.follows(e,n,r);return new Set(Array.from(s).map(o=>o.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const n=[["p",this.pubkey]];return e&&n[0].push("",e),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent$1(this.ndk,{kind:0,content:serializeProfile$1(this.profile)}).publish()}async follow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=typeof e=="string"?e:e.pubkey;if(Array.from(n).some(l=>typeof l=="string"?l===s:l.pubkey===s))return!1;n.add(e);const a=new NDKEvent$1(this.ndk,{kind:r});for(const l of n)typeof l=="string"?a.tags.push(["p",l]):a.tag(l);return await a.publish(),!0}async unfollow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=typeof e=="string"?e:e.pubkey,o=new Set;let a=!1;for(const u of n)(typeof u=="string"?u:u.pubkey)!==s?o.add(u):a=!0;if(!a)return!1;const l=new NDKEvent$1(this.ndk,{kind:r});for(const u of o)typeof u=="string"?l.tags.push(["p",u]):l.tag(u);return await l.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For$1(this.ndk,e);return n===null?null:n.pubkey===this.pubkey}},signerRegistry$1=new Map;function registerSigner$1(t,e){signerRegistry$1.set(t,e)}var NDKPrivateKeySigner$1=class yn{_user;_privateKey;_pubkey;constructor(e,n){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:s}=nip19_exports$2.decode(e);if(r==="nsec")this._privateKey=s;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=utils.hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),n&&(this._user=n.getUser({pubkey:this._pubkey})),this._user??=new NDKUser$1({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return utils.bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}encryptToNcryptsec(e,n=16,r=2){if(!this._privateKey)throw new Error("Private key not available");return encrypt$2(this._privateKey,e,n,r)}static generate(){const e=generateSecretKey();return new yn(e)}static fromNcryptsec(e,n,r){const s=decrypt$2(e,n);return new yn(s,r)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&n.push("nip04"),(!e||e==="nip44")&&n.push("nip44"),n}async encrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const s=e.pubkey;if(r==="nip44"){const o=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.encrypt(n,o)}return await nip04_exports.encrypt(this._privateKey,s,n)}async decrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const s=e.pubkey;if(r==="nip44"){const o=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.decrypt(n,o)}return await nip04_exports.decrypt(this._privateKey,s,n)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new yn(r.payload,n)}};registerSigner$1("private-key",NDKPrivateKeySigner$1);function dedup(t,e){return t.created_at>e.created_at?t:e}async function getRelayListForUser(t,e){return(await getRelayListForUsers([t],e)).get(t)}async function getRelayListForUsers(t,e,n=!1,r=1e3,s){const o=e.outboxPool||e.pool,a=new Set;for(const w of o.relays.values())a.add(w);if(s)for(const w of s.values())for(const _ of w){const x=o.getRelay(_,!0,!0);x&&a.add(x)}const l=new Map,u=new Map,p=new NDKRelaySet$1(a,e);if(e.cacheAdapter?.locking&&!n){const w=await e.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(t))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(const _ of w)_.kind===10002&&l.set(_.pubkey,NDKRelayList.from(_));for(const _ of w)if(_.kind===3){if(l.has(_.pubkey))continue;const x=relayListFromKind3(e,_);x&&u.set(_.pubkey,x)}t=t.filter(_=>!l.has(_)&&!u.has(_))}if(t.length===0)return l;const y=new Map,b=new Map;return new Promise(w=>{let _=!1;(async()=>{const T={closeOnEose:!0,pool:o,groupable:!0,subId:"ndk-relay-list-fetch",addSinceFromCache:!0,relaySet:p};p&&(T.relaySet=p),e.subscribe({kinds:[3,10002],authors:t},T,{onEvent:z=>{if(z.kind===10002){const Q=y.get(z.pubkey);if(Q&&Q.created_at>z.created_at)return;y.set(z.pubkey,z)}else if(z.kind===3){const Q=b.get(z.pubkey);if(Q&&Q.created_at>z.created_at)return;b.set(z.pubkey,z)}},onEose:()=>{if(!_){_=!0,e.debug(`[getRelayListForUsers] EOSE - relayListEvents: ${y.size}, contactListEvents: ${b.size}`);for(const z of y.values())l.set(z.pubkey,NDKRelayList.from(z));for(const z of t){if(l.has(z))continue;const Q=b.get(z);if(!Q)continue;const ye=relayListFromKind3(e,Q);ye&&l.set(z,ye)}e.debug(`[getRelayListForUsers] Returning ${l.size} relay lists for ${t.length} pubkeys`),w(l)}}});const k=Array.from(a).some(z=>z.status<=2),B=Array.from(a).some(z=>z.status===4);let G=r;(k||B)&&(G=r+3e3),e.debug(`[getRelayListForUsers] Setting fallback timeout to ${G}ms (disconnected: ${k}, connecting: ${B})`,{pubkeys:t}),setTimeout(()=>{_||(_=!0,e.debug(`[getRelayListForUsers] Timeout reached, returning ${l.size} relay lists`),w(l))},G)})()})}var OutboxItem=class{type;relayUrlScores;readRelays;writeRelays;constructor(t){this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib$1.EventEmitter{data;ndk;debug;constructor(t){super(),this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(t,e=!1){const n=[];for(let r=0;r<t.length;r+=400){const s=t.slice(r,r+400),o=s.map(l=>getKeyFromItem(l)).filter(l=>!this.data.has(l));if(o.length===0)continue;for(const l of o)this.data.set(l,new OutboxItem("user"));const a=new Map;for(const l of s)l instanceof NDKUser$1&&l.relayUrls.length>0&&a.set(l.pubkey,l.relayUrls);n.push(new Promise(l=>{getRelayListForUsers(o,this.ndk,e,1e3,a).then(u=>{this.debug(`Received relay lists for ${u.size} pubkeys out of ${o.length} requested`);for(const[p,y]of u){let b=this.data.get(p);if(b??=new OutboxItem("user"),y){if(b.readRelays=new Set(normalize(y.readRelayUrls)),b.writeRelays=new Set(normalize(y.writeRelayUrls)),this.ndk.relayConnectionFilter){for(const w of b.readRelays)this.ndk.relayConnectionFilter(w)||b.readRelays.delete(w);for(const w of b.writeRelays)this.ndk.relayConnectionFilter(w)||b.writeRelays.delete(w)}this.data.set(p,b),this.emit("user:relay-list-updated",p,b),this.debug(`Adding ${b.readRelays.size} read relays and ${b.writeRelays.size} write relays for ${p}`,y?.rawEvent())}}}).finally(l)}))}return Promise.all(n)}track(t,e,n=!0){const r=getKeyFromItem(t);e??=getTypeFromItem(t);let s=this.data.get(r);return s||(s=new OutboxItem(e),t instanceof NDKUser$1&&this.trackUsers([t])),s}};function getKeyFromItem(t){return t instanceof NDKUser$1?t.pubkey:t}function getTypeFromItem(t){return t instanceof NDKUser$1?"user":"kind"}function correctRelaySet(t,e){const n=e.connectedRelays();if(!Array.from(t.relays).some(s=>n.map(o=>o.url).includes(s.url)))for(const s of n)t.addRelay(s);if(n.length===0)for(const s of e.relays.values())t.addRelay(s);return t}var NDKSubscriptionManager=class{subscriptions;seenEvents=new dist.LRUCache({maxSize:1e4,entryExpirationTimeInMS:5*60*1e3});constructor(){this.subscriptions=new Map}add(t){this.subscriptions.set(t.internalId,t),t.onStopped,t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){const n=this.seenEvents.get(t)||[];n.some(r=>r.url===e.url)||n.push(e),this.seenEvents.set(t,n)}dispatchEvent(t,e,n=!1){e&&this.seenEvent(t.id,e);const r=this.subscriptions.values(),s=[];for(const o of r)matchFilters(o.filters,t)&&s.push(o);for(const o of s){if(o.exclusiveRelay&&o.relaySet){let a=!1;if(n?a=!o.skipOptimisticPublishEvent:e?a=o.relaySet.relays.has(e):a=(this.seenEvents.get(t.id)||[]).some(u=>o.relaySet.relays.has(u)),!a){o.debug.extend("exclusive-relay")("Rejected event %s from %s (relay not in exclusive set)",t.id,e?.url||(n?"optimistic":"cache"));continue}}o.eventReceived(t,e,!1,n)}}},debug6=createDebug2("ndk:active-user");async function getUserRelayList(t){if(!this.autoConnectUserRelays)return;const e=await getRelayListForUser(t.pubkey,this);if(e){for(const n of e.relays){let r=this.pool.relays.get(n);r||(r=new NDKRelay$1(n,this.relayAuthDefaultPolicy,this),this.pool.addRelay(r))}return debug6("Connected to %d user relays",e.relays.length),e}}async function setActiveUser(t){if(!this.autoConnectUserRelays)return;const e=this.outboxPool||this.pool;e.connectedRelays.length>0?await getUserRelayList.call(this,t):e.once("connect",async()=>{await getUserRelayList.call(this,t)})}function getEntity(t){try{const e=nip19_exports$2.decode(t);return e.type==="npub"?npub(this,e.data):e.type==="nprofile"?nprofile(this,e.data):e}catch{return null}}function npub(t,e){return t.getUser({pubkey:e})}function nprofile(t,e){const n=t.getUser({pubkey:e.pubkey});return e.relays&&(n.relayUrls=e.relays),n}function isValidHint(t){if(!t||t==="")return!1;try{return new URL(t),!0}catch{return!1}}async function fetchEventFromTag(t,e,n,r={type:"timeout"}){const s=this.debug.extend("fetch-event-from-tag"),[o,a,l]=t;n={},s("fetching event from tag",t,n,r);const u=getRelaysForSync$1(this,e.pubkey);if(u&&u.size>0){s("fetching event from author relays %o",Array.from(u));const T=NDKRelaySet$1.fromRelayUrls(Array.from(u),this),k=await this.fetchEvent(a,n,T);if(k)return k}else s("no author relays found for %s",e.pubkey,e);const p=calculateRelaySetsFromFilters(this,[{ids:[a]}],this.pool);s("fetching event without relay hint",p);const y=await this.fetchEvent(a,n);if(y)return y;if(l&&l!==""){const T=await this.fetchEvent(a,n,this.pool.getRelay(l,!0,!0,[{ids:[a]}]));if(T)return T}let b;const w=isValidHint(l)?this.pool.getRelay(l,!1,!0,[{ids:[a]}]):void 0,_=new Promise(T=>{this.fetchEvent(a,n,w).then(T)});if(!isValidHint(l)||r.type==="none")return _;const x=new Promise(async T=>{const k=r.relaySet,B=r.timeout??1500,G=new Promise(z=>setTimeout(z,B));if(r.type==="timeout"&&await G,b)T(b);else{s("fallback fetch triggered");const z=await this.fetchEvent(a,n,k);T(z)}});switch(r.type){case"timeout":return Promise.race([_,x]);case"eose":return b=await _,b||x}}var Queue=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(t,e){this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);const e=new Promise((n,r)=>{this.queue.push({...t,func:()=>t.func().then(s=>(n(s),s),s=>{throw r(s),s})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const t=this.queue.shift();!t||this.processing.has(t.id)||(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],NDK=class extends lib$1.EventEmitter{_explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;muteFilter;relayConnectionFilter;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=.1;validationRatioFn;filterValidationMode="validate";subManager;aiGuardrails;_signatureVerificationFunction;_signatureVerificationWorker;signatureVerificationTimeMs=0;publishingFailureHandled=!1;pools=[];relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;_wallet;walletConfig;constructor(t={}){super(),this.debug=t.debug||createDebug2("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager,this.pool=new NDKPool$1(t.explicitRelayUrls||[],this),this.pool.name="Main",this.pool.on("relay:auth",async(e,n)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,n)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel!==!1&&(this.outboxPool=new NDKPool$1(t.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new OutboxTracker(this),this.outboxTracker.on("user:relay-list-updated",(e,n)=>{this.debug(`Outbox relay list updated for ${e}`);for(const r of this.subManager.subscriptions.values())r.filters.some(o=>o.authors?.includes(e))&&typeof r.refreshRelayConnections=="function"&&(this.debug(`Refreshing relay connections for subscription ${r.internalId}`),r.refreshRelayConnections())})),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.muteFilter=t.muteFilter,this.relayConnectionFilter=t.relayConnectionFilter,t.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet$1.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),t.signatureVerificationWorker&&(this.signatureVerificationWorker=t.signatureVerificationWorker),t.signatureVerificationFunction&&(this.signatureVerificationFunction=t.signatureVerificationFunction),this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||.1,this.validationRatioFn=t.validationRatioFn||this.defaultValidationRatioFn,this.filterValidationMode=t.filterValidationMode||"validate",this.aiGuardrails=new AIGuardrails(t.aiGuardrails||!1),this.aiGuardrails.ndkInstantiated(this);try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t.map(normalizeRelayUrl$1),this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this._signatureVerificationWorker=t,t?(signatureVerificationInit(t),this.asyncSigVerification=!0):this.asyncSigVerification=!1}set signatureVerificationFunction(t){this._signatureVerificationFunction=t,this.asyncSigVerification=!!t}get signatureVerificationFunction(){return this._signatureVerificationFunction}addExplicitRelay(t,e,n=!0){let r;return typeof t=="string"?r=new NDKRelay$1(t,e,this):r=t,this.pool.addRelay(r,n),this.explicitRelayUrls?.push(r.url),r}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){const e=this._activeUser?.pubkey!==t?.pubkey;this._activeUser=t,e&&this.emit("activeUser:change",t),t&&e&&setActiveUser.call(this,t)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t?.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(t){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await this._signer.relays?.(this)),this._signer.relays&&(await this._signer.relays(this)).forEach(r=>this.pool.addRelay(r)));const e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.cacheAdapter?.initializeAsync&&e.push(this.cacheAdapter.initializeAsync(this)),Promise.allSettled(e).then(()=>{})}reportInvalidSignature(t,e){this.debug(`Invalid signature detected for event ${t.id}${e?` from relay ${e.url}`:""}`),this.emit("event:invalid-sig",t,e)}defaultValidationRatioFn(t,e,n){if(e<10)return this.initialValidationRatio;const r=Math.min(e/100,1),s=this.initialValidationRatio*(1-r)+this.lowestValidationRatio*r;return Math.max(s,this.lowestValidationRatio)}getUser(t){if(typeof t=="string")if(t.startsWith("npub1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="npub")throw new Error(`Invalid npub: ${t}`);return this.getUser({pubkey:r})}else if(t.startsWith("nprofile1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);return this.getUser({pubkey:r.pubkey,relayUrls:r.relays})}else return this.getUser({pubkey:t});const e=new NDKUser$1(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return NDKUser$1.fromNip05(t,this,e)}async fetchUser(t,e=!1){if(isValidNip05(t))return NDKUser$1.fromNip05(t,this,e);if(t.startsWith("npub1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="npub")throw new Error(`Invalid npub: ${t}`);const s=new NDKUser$1({pubkey:r});return s.ndk=this,s}else if(t.startsWith("nprofile1")){const{type:n,data:r}=nip19_exports$2.decode(t);if(n!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);const s=new NDKUser$1({pubkey:r.pubkey,relayUrls:r.relays});return s.ndk=this,s}else{const n=new NDKUser$1({pubkey:t});return n.ndk=this,n}}subscribe(t,e,n=!0,r=!0){let s=e?.relaySet,o=r;n instanceof NDKRelaySet$1?(console.warn("relaySet is deprecated, use opts.relaySet instead. This will be removed in version v2.14.0"),s=n,o=r):(typeof n=="boolean"||typeof n=="object")&&(o=n);let a;const l={relaySet:s,...e};o&&typeof o=="object"&&(o.onEvent&&(l.onEvent=o.onEvent),o.onEose&&(l.onEose=o.onEose),o.onClose&&(l.onClose=o.onClose),o.onEvents&&(a=o.onEvents));const u=new NDKSubscription(this,t,l);this.subManager.add(u),this.aiGuardrails?.subscription?.created(Array.isArray(t)?t:[t],l);const p=u.pool;if(u.relaySet)for(const y of u.relaySet.relays)p.useTemporaryRelay(y,void 0,u.filters);if(this.outboxPool&&u.hasAuthorsFilter()){const y=u.filters.filter(b=>b.authors&&b.authors?.length>0).flatMap(b=>b.authors);this.outboxTracker?.trackUsers(y)}return o&&setTimeout(async()=>{this.cacheAdapter?.initializeAsync&&!this.cacheAdapter.ready&&await this.cacheAdapter.initializeAsync(this);const y=u.start(!a);y&&y.length>0&&a&&a(y)},0),u}fetchEventFromTag=fetchEventFromTag.bind(this);fetchEventSync(t){if(!this.cacheAdapter)throw new Error("Cache adapter not set");let e;typeof t=="string"?e=[filterFromId(t)]:e=t;const n=new NDKSubscription(this,e),r=this.cacheAdapter.query(n);if(r instanceof Promise)throw new Error("Cache adapter is async");return r.map(s=>(s.ndk=this,s))}async fetchEvent(t,e,n){let r,s;if(n instanceof NDKRelay$1?s=new NDKRelaySet$1(new Set([n]),this):n instanceof NDKRelaySet$1&&(s=n),!n&&typeof t=="string"&&!isNip33AValue(t)){const o=relaysFromBech32(t,this);o.length>0&&(s=new NDKRelaySet$1(new Set(o),this),s=correctRelaySet(s,this.pool))}if(typeof t=="string"?r=[filterFromId(t)]:Array.isArray(t)?r=t:r=[t],typeof t!="string"&&this.aiGuardrails?.ndk?.fetchingEvents(r),r.length===0)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise((o,a)=>{let l=null;const u={...e||{},closeOnEose:!0};s&&(u.relaySet=s);const p=setTimeout(()=>{y.stop(),this.aiGuardrails._nextCallDisabled=null,o(l)},1e4),y=this.subscribe(r,u,{onEvent:b=>{b.ndk=this,b.isReplaceable()?(!l||l.created_at<b.created_at)&&(l=b):(clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,o(b))},onEose:()=>{clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,o(l)}})})}async fetchEvents(t,e,n){return this.aiGuardrails?.ndk?.fetchingEvents(t,e),new Promise(r=>{const s=new Map,o={...e||{},closeOnEose:!0};n&&(o.relaySet=n);const a=l=>{let u;l instanceof NDKEvent$1?u=l:u=new NDKEvent$1(void 0,l);const p=u.deduplicationKey(),y=s.get(p);y&&(u=dedup(y,u)),u.ndk=this,s.set(p,u)};this.subscribe(t,{...o,onEvent:a,onEose:()=>{this.aiGuardrails._nextCallDisabled=null,r(new Set(s.values()))}})})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getEntity=getEntity.bind(this);guardrailOff(t){return t?typeof t=="string"?this.aiGuardrails._nextCallDisabled=new Set([t]):this.aiGuardrails._nextCallDisabled=new Set(t):this.aiGuardrails._nextCallDisabled="all",this}set wallet(t){if(!t){this._wallet=void 0,this.walletConfig=void 0;return}this._wallet=t,this.walletConfig??={},this.walletConfig.lnPay=t?.lnPay?.bind(t),this.walletConfig.cashuPay=t?.cashuPay?.bind(t)}get wallet(){return this._wallet}},nip19_exports$1={};__reExport$1(nip19_exports$1,nip19_star);var nip49_exports={};__reExport$1(nip49_exports,nip49_star);function disconnect$1(t,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async n=>{e?.(`Relay ${n.url} requested authentication, disconnecting`),t.removeRelay(n.url)}}async function signAndAuth$1(t,e,n,r,s,o){try{await t.sign(n),s(t)}catch(a){r?.(`Failed to publish auth event to relay ${e.url}`,a),o(t)}}function signIn$1({ndk:t,signer:e,debug:n}={}){return n??=createDebug2("ndk:auth-policies:signIn"),async(r,s)=>{n?.(`Relay ${r.url} requested authentication, signing in`);const o=new NDKEvent$1(t);return o.kind=22242,o.tags=[["relay",r.url],["challenge",s]],e??=t?.signer,new Promise(async(a,l)=>{e?await signAndAuth$1(o,r,e,n,a,l):t?.once("signer:ready",async u=>{await signAndAuth$1(o,r,u,n,a,l)})})}}var NDKRelayAuthPolicies$1={disconnect:disconnect$1,signIn:signIn$1};async function ndkSignerFromPayload$1(t,e){let n;try{n=JSON.parse(t)}catch(s){console.error("Failed to parse signer payload string",t,s);return}if(!n||typeof n.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const r=signerRegistry$1.get(n.type);if(!r)throw new Error(`Unknown signer type: ${n.type}`);try{return await r.fromPayload(t,e)}catch(s){const o=s instanceof Error?s.message:String(s);throw new Error(`Failed to deserialize signer type ${n.type}: ${o}`)}}var NDKNip07Signer$1=class gi{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,n){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=n}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let n;return this.ndk?n=this.ndk.getUser({pubkey:e}):n=new NDKUser$1({pubkey:e}),this._user=n,n}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const n=await window.nostr?.signEvent(e);if(!n)throw new Error("Failed to sign event");return n.sig}async relays(e){await this.waitForExtension();const n=await window.nostr?.getRelays?.()||{},r=[];for(const s of Object.keys(n))n[s].read&&n[s].write&&r.push(s);return r.map(s=>new NDKRelay$1(s,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&window.nostr?.nip04&&n.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&n.push("nip44"),n}async encrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"encrypt",s,n)}async decrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"decrypt",s,n)}async queueEncryption(e,n,r,s){return new Promise((o,a)=>{this.encryptionQueue.push({scheme:e,method:n,counterpartyHexpubkey:r,value:s,resolve:o,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,n=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:s,method:o,counterpartyHexpubkey:a,value:l,resolve:u,reject:p}=r;this.debug("Processing encryption queue item",{method:o,counterpartyHexpubkey:a,value:l});try{const y=await window.nostr?.[s]?.[o](a,l);if(!y)throw new Error("Failed to encrypt/decrypt");u(y)}catch(y){const b=y instanceof Error?y.message:String(y);if(b.includes("call already executing")&&n<5){this.debug("Retrying encryption queue item",{method:o,counterpartyHexpubkey:a,value:l,retries:n}),setTimeout(()=>{this.processEncryptionQueue(r,n+1)},50*n);return}p(y instanceof Error?y:new Error(b))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,n)=>{if(window.nostr){e();return}let r;const s=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(s),e())},100);r=setTimeout(()=>{clearInterval(s),n(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new gi(void 0,n)}};registerSigner$1("nip07",NDKNip07Signer$1);var NDKNostrRpc$1=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(e,n,r,s){if(super(),this.ndk=e,this.signer=n,s){this.pool=new NDKPool$1(s,e,{debug:r.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet$1(new Set,e,this.pool);for(const o of s){const a=this.pool.getRelay(o,!1,!1);a.authPolicy=NDKRelayAuthPolicies$1.signIn({ndk:e,signer:n,debug:r}),this.relaySet.addRelay(a),a.connect()}}this.debug=r.extend("rpc")}subscribe(e){return new Promise(n=>{const r=this.ndk.subscribe(e,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet,onEvent:async s=>{try{const o=await this.parseEvent(s);o.method?this.emit("request",o):(this.emit(`response-${o.id}`,o),this.emit("response",o))}catch(o){this.debug("error parsing event",o,s.rawEvent())}},onEose:()=>{this.debug("eosed"),n(r)}})})}async parseEvent(e){this.encryptionType==="nip44"&&e.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!e.content.includes("?iv=")&&(this.encryptionType="nip44");const n=this.ndk.getUser({pubkey:e.pubkey});n.ndk=this.ndk;let r;try{r=await this.signer.decrypt(n,e.content,this.encryptionType)}catch{const b=this.encryptionType==="nip04"?"nip44":"nip04";r=await this.signer.decrypt(n,e.content,b),this.encryptionType=b}const s=JSON.parse(r),{id:o,method:a,params:l,result:u,error:p}=s;return a?{id:o,pubkey:e.pubkey,method:a,params:l,event:e}:{id:o,result:u,error:p,event:e}}async sendResponse(e,n,r,s=24133,o){const a={id:e,result:r};o&&(a.error=o);const l=await this.signer.user(),u=this.ndk.getUser({pubkey:n}),p=new NDKEvent$1(this.ndk,{kind:s,content:JSON.stringify(a),tags:[["p",n]],pubkey:l.pubkey});p.content=await this.signer.encrypt(u,p.content,this.encryptionType),await p.sign(this.signer),await p.publish(this.relaySet)}async sendRequest(e,n,r=[],s=24133,o){const a=Math.random().toString(36).substring(7),l=await this.signer.user(),u=this.ndk.getUser({pubkey:e}),p={id:a,method:n,params:r},y=new Promise(()=>{const w=_=>{_.result==="auth_url"?(this.once(`response-${a}`,w),this.emit("authUrl",_.error)):o&&o(_)};this.once(`response-${a}`,w)}),b=new NDKEvent$1(this.ndk,{kind:s,content:JSON.stringify(p),tags:[["p",e]],pubkey:l.pubkey});return b.content=await this.signer.encrypt(u,b.content,this.encryptionType),await b.sign(this.signer),await b.publish(this.relaySet),y}};function nostrConnectGenerateSecret$1(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri$1(t,e,n,r){const s={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let o=`nostrconnect://${t}?image=${s.image}&url=${s.url}&name=${s.name}&perms=${s.perms}&secret=${encodeURIComponent(e)}`;return n&&(o+=`&relay=${encodeURIComponent(n)}`),o}var NDKNip46Signer$1=class gn extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,n,r,s,o){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=s,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner$1(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner$1.generate(),n===!1||(n?n.startsWith("bunker://")?this.bunkerFlowInit(n):this.nip05Init(n):this.nostrconnectFlowInit(o)),this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,n,r){return new gn(e,n,r)}static nostrconnect(e,n,r,s){return new gn(e,void 0,r,[n],s)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret$1();const n=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri$1(n,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const n=new URL(e),r=n.hostname||n.pathname.replace(/^\/\//,""),s=n.searchParams.get("pubkey"),o=n.searchParams.getAll("relay"),a=n.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=s,this.relayUrls=o,this.secret=a}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,n)=>{const r=s=>{s.result===this.nostrConnectSecret&&(this._user=s.event.author,this.userPubkey=s.event.pubkey,this.bunkerPubkey=s.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser$1.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,n)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,s=>{s.result==="ack"?this.getPublicKey().then(o=>{this.userPubkey=o,this._user=this.ndk.getUser({pubkey:o}),e(this._user)}):n(s.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,n)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,n,r="nip04"){return this.encryption(e,n,r,"encrypt")}async decrypt(e,n,r="nip04"){return this.encryption(e,n,r,"decrypt")}async encryption(e,n,r,s){return new Promise((a,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${s}`,[e.pubkey,n],24133,u=>{u.error?l(u.error):a(u.result)})})}async sign(e){return new Promise((r,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,o=>{if(o.error)s(o.error);else{const a=JSON.parse(o.result);r(a.sig)}})})}async createAccount(e,n,r){await this.startListening();const s=[];return e&&s.push(e),n&&s.push(n),r&&s.push(r),new Promise((o,a)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",s,24133,l=>{if(l.error)a(l.error);else{const u=l.result;o(u)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,n){if(!n)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const s=r.payload;if(!s||typeof s!="object"||!s.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const o=await ndkSignerFromPayload$1(s.localSignerPayload,n);if(!o)throw new Error("Failed to deserialize local signer for NIP-46");if(!(o instanceof NDKPrivateKeySigner$1))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let a;return a=new gn(n,!1,o,s.relayUrls),a.userPubkey=s.userPubkey,a.bunkerPubkey=s.bunkerPubkey,a.relayUrls=s.relayUrls,a.secret=s.secret,s.userPubkey&&(a._user=new NDKUser$1({pubkey:s.userPubkey}),a._user&&(a._user.ndk=n)),a}};registerSigner$1("nip46",NDKNip46Signer$1);createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");const index=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX,NDKAppHandlerEvent,NDKArticle,NDKBlossomList,NDKCashuMintAnnouncement,NDKCashuMintList:NDKCashuMintList$1,NDKClassified,NDKDVMJobFeedback,NDKDraft,NDKEvent:NDKEvent$1,NDKFedimintMint,NDKFollowPack,NDKHighlight,NDKImage,NDKList,NDKMintRecommendation,NDKNip07Signer:NDKNip07Signer$1,NDKNip46Signer:NDKNip46Signer$1,NDKNostrRpc:NDKNostrRpc$1,NDKNutzap,NDKPool:NDKPool$1,NDKPrivateKeySigner:NDKPrivateKeySigner$1,NDKProject,NDKProjectTemplate,NDKPublishError:NDKPublishError$1,NDKRelay:NDKRelay$1,NDKRelayAuthPolicies:NDKRelayAuthPolicies$1,NDKRelayList,NDKRelaySet:NDKRelaySet$1,NDKRepost,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKStory,NDKStorySticker,NDKSubscription,NDKSubscriptionReceipt,NDKSubscriptionStart,NDKSubscriptionTier,NDKTask,NDKThread,NDKUser:NDKUser$1,NDKVideo,NDKWiki,NDKWikiMergeRequest,NIP33_A_REGEX,calculateRelaySetFromEvent:calculateRelaySetFromEvent$1,default:NDK,defaultOpts,deserialize:deserialize$1,eventHasETagMarkers:eventHasETagMarkers$1,fetchRelayInformation,filterFingerprint:filterFingerprint$1,filterFromId,generateContentTags:generateContentTags$1,generateHashtags:generateHashtags$1,getRelayListForUser,getRelayListForUsers,getReplyTag:getReplyTag$1,getRootTag:getRootTag$1,imetaTagToTag,isNip33AValue,isValidHex64,isValidNip05,isValidPubkey,mapImetaTag,mergeFilters:mergeFilters$1,mergeTags:mergeTags$1,ndkSignerFromPayload:ndkSignerFromPayload$1,newAmount,nip19:nip19_exports$1,nip49:nip49_exports,normalize,normalizeRelayUrl:normalizeRelayUrl$1,normalizeUrl:normalizeUrl$1,parseTagToSubscriptionAmount,possibleIntervalFrequencies,processFilters,profileFromEvent:profileFromEvent$1,queryFullyFilled,registerSigner:registerSigner$1,relayListFromKind3,relaysFromBech32,serialize:serialize$1,serializeProfile:serializeProfile$1,strToDimension,strToPosition,tryNormalizeRelayUrl,wrapEvent},Symbol.toStringTag,{value:"Module"}));var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of __getOwnPropNames(e))!__hasOwnProp.call(t,s)&&s!==n&&__defProp(t,s,{get:()=>e[s],enumerable:!(r=__getOwnPropDesc(e,s))||r.enumerable});return t},__reExport=(t,e,n)=>(__copyProps(t,e,"default"),n);function getRelaysForSync(t,e,n="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);if(r)return n==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync(t,e,n)}function getTopRelaysForAuthors(t,e){const n=new Map;return e.forEach(s=>{const o=getRelaysForSync(t,s);o&&o.forEach(a=>{const l=n.get(a)||0;n.set(a,l+1)})}),Array.from(n.entries()).sort((s,o)=>o[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys(t,e,n="read"){const r=new Map,s=new Set;return e.forEach(o=>{const a=getRelaysForSync(t,o,n);a&&a.size>0?(a.forEach(l=>{(r.get(l)||new Set).add(o)}),r.set(o,a)):s.add(o)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys(t,e,n,{count:r,preferredRelays:s}={}){r??=2,s??=new Set;const o=t.pool,a=o.connectedRelays();a.forEach(w=>{s?.add(w.url)});const l=new Map,{pubkeysToRelays:u,authorsMissingRelays:p}=getAllRelaysForAllPubkeys(t,e,n),y=getTopRelaysForAuthors(t,e),b=(w,_)=>{const x=l.get(_)||[];x.push(w),l.set(_,x)};for(const[w,_]of u.entries()){let x=r;const T=new Set;for(const k of a)_.has(k.url)&&(b(w,k.url),T.add(k.url),x--);for(const k of _)T.has(k)||l.has(k)&&(b(w,k),T.add(k),x--);if(!(x<=0))for(const k of y){if(x<=0)break;T.has(k)||_.has(k)&&(b(w,k),T.add(k),x--)}}for(const w of p)o.permanentAndConnectedRelays().forEach(_=>{const x=l.get(_.url)||[];x.push(w),l.set(_.url,x)});return l}function normalizeRelayUrl(t){let e=normalizeUrl(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(t,e)=>e.some(n=>n instanceof RegExp?n.test(t):n===t),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols.has(e)}catch{return!1}},normalizeDataURL=(t,{stripHash:e})=>{const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);const r=n.groups?.type??"",s=n.groups?.data??"";let o=n.groups?.hash??"";const a=r.split(";");o=e?"":o;let l=!1;a[a.length-1]==="base64"&&(a.pop(),l=!0);const u=a.shift()?.toLowerCase()??"",y=[...a.map(b=>{let[w,_=""]=b.split("=").map(x=>x.trim());return w==="charset"&&(_=_.toLowerCase(),_===DATA_URL_DEFAULT_CHARSET)?"":`${w}${_?`=${_}`:""}`}).filter(Boolean)];return l&&y.push("base64"),(y.length>0||u&&u!==DATA_URL_DEFAULT_MIME_TYPE)&&y.unshift(u),`data:${y.join(";")},${l?s.trim():s}${o?`#${o}`:""}`};function normalizeUrl(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL(t,e);if(hasCustomProtocol(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(t);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let l=0,u="";for(;;){const y=a.exec(s.pathname);if(!y)break;const b=y[0],w=y.index,_=s.pathname.slice(l,w);u+=_.replace(/\/{2,}/g,"/"),u+=b,l=w+b.length}const p=s.pathname.slice(l,s.pathname.length);u+=p.replace(/\/{2,}/g,"/"),s.pathname=u}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let a=s.pathname.split("/");const l=a[a.length-1];testParameter(l,e.removeDirectoryIndex)&&(a=a.slice(0,-1),s.pathname=`${a.slice(1).join("/")}/`)}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const a of[...s.searchParams.keys()])testParameter(a,e.removeQueryParameters)&&s.searchParams.delete(a);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const a of[...s.searchParams.keys()])testParameter(a,e.keepQueryParameters)||s.searchParams.delete(a);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const o=t;return t=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!o.endsWith("/")&&s.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var NDKRelayKeepalive=class{constructor(t=3e4,e){this.onSilenceDetected=e,this.timeout=t}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=Date.now()-this.lastActivity;if(t>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-t;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function probeRelayConnection(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(n=>{let r=!1;const s=setTimeout(()=>{r||(r=!0,t.send(["CLOSE",e]),n(!1))},5e3),o=()=>{r||(r=!0,clearTimeout(s),t.send(["CLOSE",e]),n(!0))};t.once("message",o),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(t,e){this.ndkRelay=t,this._status=1;const n=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${n}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive(3e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection({send:e=>this.send(JSON.stringify(e)),once:(e,n)=>{const r=s=>{try{const o=JSON.parse(s.data);(o[0]==="EOSE"||o[0]==="EVENT"||o[0]==="NOTICE")&&(n(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const t=Date.now(),e=t-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=t},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{const n=r=>{try{const s=JSON.parse(r.data);(s[0]==="EOSE"||s[0]==="EVENT"||s[0]==="NOTICE")&&(e(),this.ws?.removeEventListener("message",n))}catch{}};this.ws?.addEventListener("message",n)}}).then(t=>{t||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(t,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(n){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,n),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),n}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const e=JSON.parse(t.data),[n,r,...s]=e;switch(n){case"EVENT":{const o=this.openSubs.get(r),a=e[2];if(!o){this.debug(`Received event for unknown subscription ${r}`);return}o.onevent(a);return}case"COUNT":{const o=e[2],a=this.openCountRequests.get(r);a&&(a.resolve(o.count),this.openCountRequests.delete(r));return}case"EOSE":{const o=this.openSubs.get(r);if(!o)return;o.oneose(r);return}case"OK":{const o=e[2],a=e[3],l=this.openEventPublishes.get(r),u=l?.pop();if(!l||!u){this.debug("Received OK for unknown event publish",r);return}o?u.resolve(a):u.reject(new Error(a)),l.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,l);return}case"CLOSED":{const o=this.openSubs.get(r);if(!o)return;o.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":{this.onAuthRequested(e[1]);return}}}catch(e){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${e.message}`,e?.stack);return}}async onAuthRequested(t){const e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let n;try{n=await e(this.ndkRelay,t)}catch(r){this.debug("Authentication policy threw an error",r),n=!1}if(this.debug("Authentication policy returned",!!n),n instanceof NDKEvent||n===!0){n instanceof NDKEvent&&await this.auth(n);const r=async()=>{if(this._status>=5&&this._status<8){const s=new NDKEvent(this.ndk);s.kind=22242,s.tags=[["relay",this.ndkRelay.url],["challenge",t]],await s.sign(),this.auth(s).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(o=>{this._status=6,this.ndkRelay.emit("auth:failed",o),this.debug("Authentication failed",o)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};n===!0&&(this.ndk?.signer?r().catch(s=>{console.error("Error authenticating",s)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",r))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const n=t.reduce((a,l)=>a+l,0)/t.length,r=t.map(a=>(a-n)**2).reduce((a,l)=>a+l,0)/t.length;return Math.sqrt(r)<FLAPPING_THRESHOLD_MS}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const n=[0,1e3,2e3,5e3,1e4,3e4];e=n[Math.min(t,n.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${t}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*Math.pow(2,t),3e4),this.debug(`Using standard backoff, attempt ${t}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(n=>{t<MAX_RECONNECT_ATTEMPTS?this.handleReconnection(t+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(t){const e=new Promise((n,r)=>{const s=this.openEventPublishes.get(t.id)??[];s.push({resolve:n,reject:r}),this.openEventPublishes.set(t.id,s)});return this.send(`["AUTH",${JSON.stringify(t.rawEvent())}]`),e}async publish(t){const e=new Promise((n,r)=>{const s=this.openEventPublishes.get(t.id)??[];s.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${t.id} twice`),s.push({resolve:n,reject:r}),this.openEventPublishes.set(t.id,s)});return this.send(`["EVENT",${JSON.stringify(t)}]`),e}async count(t,e){this.serial++;const n=e?.id||`count:${this.serial}`,r=new Promise((s,o)=>{this.openCountRequests.set(n,{resolve:s,reject:o})});return this.send(`["COUNT","${n}",${JSON.stringify(t).substring(1)}`),r}close(t,e){this.send(`["CLOSE","${t}"]`);const n=this.openSubs.get(t);this.openSubs.delete(t),n&&n.onclose(e)}req(t){`${this.send(`["REQ","${t.subId}",${JSON.stringify(t.executeFilters).substring(1)}`)}`,this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},NDKRelayPublisher=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let n;const r=()=>new Promise((y,b)=>{try{this.publishEvent(t).then(w=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),y(!0)}).catch(b)}catch(w){b(w)}}),s=new Promise((y,b)=>{n=setTimeout(()=>{n=void 0,b(new Error(`Timeout: ${e}ms`))},e)}),o=()=>{r().then(y=>a(y)).catch(y=>l(y))};let a,l;const u=y=>{throw this.ndkRelay.debug("Publish failed",y,t.id),this.ndkRelay.emit("publish:failed",t,y),t.emit("relay:publish:failed",this.ndkRelay,y),y},p=()=>{n&&clearTimeout(n),this.ndkRelay.removeListener("connect",o)};return this.ndkRelay.status>=5?Promise.race([r(),s]).catch(u).finally(p):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((y,b)=>{a=y,l=b,this.ndkRelay.on("connect",o)}),s]).catch(u).finally(p))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function filterFingerprint(t,e){const n=[];for(const s of t){const o=Object.entries(s||{}).map(([a,l])=>["since","until"].includes(a)?`${a}:${l}`:a).sort().join("-");n.push(o)}let r=e?"+":"";return r+=n.join("|"),r}function mergeFilters(t){const e=[],n={};return t.filter(r=>!!r.limit).forEach(r=>e.push(r)),t=t.filter(r=>!r.limit),t.length===0?e:(t.forEach(r=>{Object.entries(r).forEach(([s,o])=>{Array.isArray(o)?n[s]===void 0?n[s]=[...o]:n[s]=Array.from(new Set([...n[s],...o])):n[s]=o})}),[...e,n])}var NDKRelaySubscription=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,n){this.relay=t,this.topSubManager=n,this.debug=t.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:e,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",t,e),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}if(t.filters.find(r=>!!r.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=t.groupableDelay,n=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,n);else{const r=this.delayType,s=this.fireTime-Date.now();if(r==="at-least"&&n==="at-least")s<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-least"&&n==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-most"&&n==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(r==="at-most"&&n==="at-least")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else throw new Error(`Unknown delay type combination ${r} ${n}`)}}schedule(t,e){this.status=1;const n=Date.now();this.fireTime=n+t,this.delayType=e;const r=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=r)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",t,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:e.filters,internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(e))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(r=>r.filters);if(!e[0])return this.debug(" No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];const n=e[0].length;for(let r=0;r<n;r++){const s=e.map(o=>o[r]);t.push(...mergeFilters(s))}return t}},NDKRelaySubscriptionManager=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let n;if(!t.isGroupable())n=this.createSubscription(t,e);else{const r=filterFingerprint(e,t.closeOnEose);r&&(n=(this.subscriptions.get(r)||[]).find(o=>o.status<3)),n??=this.createSubscription(t,e,r)}n.addItem(t,e)}createSubscription(t,e,n){const r=new NDKRelaySubscription(this.relay,n||null,this.generalSubManager);r.onClose=this.onRelaySubscriptionClose.bind(this);const s=this.subscriptions.get(r.fingerprint)??[];return this.subscriptions.set(r.fingerprint,[...s,r]),r}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?e.length===1?this.subscriptions.delete(t.fingerprint):(e=e.filter(n=>n.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},NDKRelay=class mi extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,n,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let s=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const o=n/100;s=Math.max(e.lowestValidationRatio,e.validationRatio-o)}return s<e.validationRatio?s:e.validationRatio};constructor(e,n,r){super(),this.url=normalizeRelayUrl(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,r.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=n,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??mi.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,n=!0){return this.connectivity.connect(e,n)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,n){this.subs.addSubscription(e,n)}async publish(e,n=2500){return this.publisher.publish(e,n)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close},NDKPublishError=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,n,r){super(t),this.errors=e,this.publishedToRelays=n,this.intendedRelaySet=r}get relayErrors(){const t=[];for(const[e,n]of this.errors)t.push(`${e.url}: ${n}`);return t.join(`
`)}},NDKRelaySet=class bi{relays;debug;ndk;pool;constructor(e,n,r){this.relays=e,this.ndk=n,this.pool=r??n.pool,this.debug=n.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,n,r=!0,s){if(s=s??n.pool,!s)throw new Error("No pool provided");const o=new Set;for(const a of e){const l=s.relays.get(normalizeRelayUrl(a));if(l)l.status<5&&r&&l.connect(),o.add(l);else{const u=new NDKRelay(normalizeRelayUrl(a),n?.relayAuthDefaultPolicy,n);s.useTemporaryRelay(u,void 0,`requested from fromRelayUrls ${e}`),o.add(u)}}return new bi(new Set(o),n,s)}async publish(e,n,r=1){const s=new Set,o=new Map,a=e.isEphemeral();e.publishStatus="pending";const l=u=>{s.add(u)};e.on("relay:published",l);try{const u=Array.from(this.relays).map(p=>new Promise(y=>{const b=n?setTimeout(()=>{s.has(p)||(o.set(p,new Error(`Publish timeout after ${n}ms`)),y(!1))},n):null;p.publish(e,n).then(w=>{b&&clearTimeout(b),w?(s.add(p),y(!0)):y(!1)}).catch(w=>{b&&clearTimeout(b),a||o.set(p,w),y(!1)})}));if(await Promise.all(u),s.size<r){if(!a){const p=new NDKPublishError("Not enough relays received the event ("+s.size+" published, "+r+" required)",o,s,this);throw e.publishStatus="error",e.publishError=p,this.ndk?.emit("event:publish-failed",e,p,this.relayUrls),p}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:s});return s}finally{e.off("relay:published",l)}}get size(){return this.relays.size}},d$1=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent(t,e,n){const r=new Set,s=await getWriteRelaysFor(t,e.pubkey);s&&s.forEach(l=>{const u=t.pool?.getRelay(l);u&&r.add(u)});let o=e.tags.filter(l=>["a","e"].includes(l[0])).map(l=>l[2]).filter(l=>l?.startsWith("wss://")).filter(l=>{try{return new URL(l),!0}catch{return!1}}).map(l=>normalizeRelayUrl(l));o=Array.from(new Set(o)).slice(0,5),o.forEach(l=>{const u=t.pool?.getRelay(l,!0,!0);u&&(d$1("Adding relay hint %s",l),r.add(u))});const a=e.getMatchingTags("p").map(l=>l[1]);return a.length<5?Array.from(chooseRelayCombinationForPubkeys(t,a,"read",{preferredRelays:new Set(s)}).keys()).forEach(u=>{const p=t.pool?.getRelay(u,!1,!0);p&&(d$1("Adding p-tagged relay %s",u),r.add(p))}):d$1("Too many p-tags to consider %d",a.length),t.pool?.permanentAndConnectedRelays().forEach(l=>r.add(l)),n&&r.size<n&&t.explicitRelayUrls?.filter(u=>!Array.from(r).some(p=>p.url===u)).slice(0,n-r.size)?.forEach(u=>{const p=t.pool?.getRelay(u,!1,!0);p&&(d$1("Adding explicit relay %s",u),r.add(p))}),new NDKRelaySet(r,t)}function mergeTags(t,e){const n=new Map,r=a=>a.join(","),s=(a,l)=>a.every((u,p)=>u===l[p]),o=a=>{for(const[l,u]of n)if(s(u,a)||s(a,u)){a.length>=u.length&&n.set(l,a);return}n.set(r(a),a)};return t.concat(e).forEach(o),Array.from(n.values())}var hashtagRegex=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags(t){const e=t.match(hashtagRegex),n=new Set,r=new Set;if(e)for(const s of e)n.has(s.slice(1))||(r.add(s.slice(1)),n.add(s.slice(1)));return Array.from(r)}async function generateContentTags(t,e=[],n,r){if(n?.skipContentTagging)return{content:t,tags:e};const s=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,o=[],a=l=>{e.find(u=>["q",l[0]].includes(u[0])&&u[1]===l[1])||e.push(l)};if(t=t.replace(s,l=>{try{const u=l.split(/(@|nostr:)/)[2],{type:p,data:y}=nip19_exports$2.decode(u);let b;if(n?.filters){const w=!n.filters.includeTypes||n.filters.includeTypes.includes(p),_=n.filters.excludeTypes?.includes(p);if(!w||_)return l}switch(p){case"npub":n?.pTags!==!1&&(b=["p",y]);break;case"nprofile":n?.pTags!==!1&&(b=["p",y.pubkey]);break;case"note":o.push(new Promise(async w=>{const _=await maybeGetEventRelayUrl(u);a(["q",y,_]),w()}));break;case"nevent":o.push(new Promise(async w=>{const{id:_,author:x}=y;let{relays:T}=y;(!T||T.length===0)&&(T=[await maybeGetEventRelayUrl(u)]),a(["q",_,T[0]]),x&&n?.pTags!==!1&&n?.pTagOnQTags!==!1&&a(["p",x]),w()}));break;case"naddr":o.push(new Promise(async w=>{const _=[y.kind,y.pubkey,y.identifier].join(":");let x=y.relays??[];x.length===0&&(x=[await maybeGetEventRelayUrl(u)]),a(["q",_,x[0]]),n?.pTags!==!1&&n?.pTagOnQTags!==!1&&n?.pTagOnATags!==!1&&a(["p",y.pubkey]),w()}));break;default:return l}return b&&a(b),`nostr:${u}`}catch{return l}}),await Promise.all(o),!n?.filters?.excludeTypes?.includes("hashtag")){const l=generateHashtags(t).map(u=>["t",u]);e=mergeTags(e,l)}if(n?.pTags!==!1&&n?.copyPTagsFromTarget&&r){const l=r.getMatchingTags("p");for(const u of l)e.find(p=>p[0]==="p"&&p[1]===u[1])||e.push(u)}return{content:t,tags:e}}async function maybeGetEventRelayUrl(t){return""}async function encrypt(t,e,n="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const o=t||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(n==="nip44"&&await isEncryptionEnabled(s,"nip44")&&(r=await s.encrypt(o,this.content,"nip44")),(!r||n==="nip04")&&await isEncryptionEnabled(s,"nip04")&&(r=await s.encrypt(o,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function decrypt(t,e,n){if(this.ndk?.cacheAdapter?.getDecryptedEvent){let l=null;if(typeof this.ndk.cacheAdapter.getDecryptedEvent=="function"&&(l=this.ndk.cacheAdapter.getDecryptedEvent(this.id)),l){this.content=l.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const o=t||this.author;if(!o)throw new Error("No sender provided and no author available");const a=n||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled(s,"nip04")&&this.content.search("\\?iv=")&&(r=await s.decrypt(o,this.content,"nip04")),!r&&a==="nip44"&&await isEncryptionEnabled(s,"nip44")&&(r=await s.decrypt(o,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this)}async function isEncryptionEnabled(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function eventHasETagMarkers(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag(t,e){e??=t.tagType();const n=t.tags.find(isTagRootTag);if(!n){if(eventHasETagMarkers(t))return;const r=t.getMatchingTags(e);if(r.length<3)return r[0]}return n}var nip22RootTags=new Set(["A","E","I"]),nip22ReplyTags=new Set(["a","e","i"]);function getReplyTag(t,e){if(t.kind===1111){let s;for(const o of t.tags)if(nip22RootTags.has(o[0]))s=o;else if(nip22ReplyTags.has(o[0])){s=o;break}return s}e??=t.tagType();let n=!1,r;for(const s of t.tags)if(s[0]===e){if((s[3]??"").length>0&&(n=!0),n&&s[3]==="reply")return s;n&&s[3]==="root"&&(r=s),n||(r=s)}return r}function isTagRootTag(t){return t[0]==="E"||t[3]==="root"}async function fetchTaggedEvent(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(n.length===0)return;const[r,s,o]=n[0];let a=o!==""?this.ndk.pool.getRelay(o):void 0;return await this.ndk.fetchEvent(s,{},a)}async function fetchRootEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT=2;function encode(t=DEFAULT_RELAY_COUNT){let e=[];return this.onRelays.length>0?e=this.onRelays.map(n=>n.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new NDKEvent(this.ndk,{kind:getKind(this)});return this.isProtected||(n.content=JSON.stringify(this.rawEvent())),n.tag(this),this.kind!==1&&n.tags.push(["k",`${this.kind}`]),e&&await n.sign(e),t&&await n.publish(),n}function getKind(t){return t.kind===1?6:16}function serialize(t=!1,e=!1){const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}function deserialize(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],s=e[7];r&&r.length===128?(n.sig=r,s&&s.length===64&&(n.id=s)):r&&r.length===64&&(n.id=r,s&&s.length===128&&(n.sig=s))}return n}var processingQueue={};async function verifySignatureAsync(t,e,n){const r=t.ndk,s=Date.now();let o;return r.signatureVerificationFunction?(console.log("[NDK-CORE] Using custom signature verification function async"),o=await r.signatureVerificationFunction(t),console.log("Custom signature verification result",t.id,{result:o})):(console.log("Using worker-based signature verification async"),o=await new Promise(a=>{t.serialize();let l=!1;processingQueue[t.id]||(processingQueue[t.id]={event:t,resolves:[],relay:n},l=!0),processingQueue[t.id].resolves.push(a)})),r.signatureVerificationTimeMs+=Date.now()-s,o}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(typeof e[n]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(t){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification)verifySignatureAsync(this,t,this.relay).then(n=>{t&&(this.signatureVerified=n,n&&verifiedSignatures.set(this.id,this.sig)),n||(this.relay?this.ndk?.reportInvalidSignature(this,this.relay):this.ndk?.reportInvalidSignature(this),verifiedSignatures.set(this.id,!1))}).catch(n=>{console.error("signature verification error",this.id,n)});else{const n=sha256_1(new TextEncoder().encode(this.serialize())),r=schnorr.verify(this.sig,n,this.pubkey);return r?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(t){const e=sha256_1(new TextEncoder().encode(t));return utils.bytesToHex(e)}var skipClientTagOnKinds=new Set([0,4,1059,13,3,9734,5]),NDKEvent=class vt extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,n){super(),this.ndk=e,this.created_at=n?.created_at,this.content=n?.content||"",this.tags=n?.tags||[],this.id=n?.id||"",this.sig=n?.sig,this.pubkey=n?.pubkey||"",this.kind=n?.kind,n instanceof vt&&(this.relay&&(this.relay=n.relay,this.ndk?.subManager.seenEvent(n.id,this.relay)),this.publishStatus=n.publishStatus,this.publishError=n.publishError)}static deserialize(e,n){return new vt(e,deserialize(n))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,n,r){const s=["i"],o=["k"];switch(n){case"url":{const a=new URL(e);a.hash="",s.push(a.toString()),o.push(`${a.protocol}//${a.host}`);break}case"hashtag":s.push(`#${e.toLowerCase()}`),o.push("#");break;case"geohash":s.push(`geo:${e.toLowerCase()}`),o.push("geo");break;case"isbn":s.push(`isbn:${e.replace(/-/g,"")}`),o.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${e}`),o.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${e}`),o.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${e}`),o.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${e.split("-").slice(0,4).join("-")}`),o.push("isan");break;case"doi":s.push(`doi:${e.toLowerCase()}`),o.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${n}`)}r&&s.push(r),this.tags.push(s),this.tags.push(o)}tag(e,n,r,s,o){let a=[];if(e.fetchProfile!==void 0){if(s??="p",s==="p"&&o?.pTags===!1)return;const u=[s,e.pubkey];n&&u.push("",n),a.push(u)}else if(e instanceof vt){const u=e;if(r??=u?.pubkey===this.pubkey,a=u.referenceTags(n,r,s,o),o?.pTags!==!1)for(const p of u.getMatchingTags("p"))p[1]!==this.pubkey&&(this.tags.find(y=>y[0]==="p"&&y[1]===p[1])||this.tags.push(["p",p[1]]))}else if(Array.isArray(e))a=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags(this.tags,a)}async toNostrEvent(e,n){if(!e&&this.pubkey===""){const o=await this.ndk?.signer?.user();this.pubkey=o?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags(n);this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize.bind(this);getEventHash=getEventHash.bind(this);validate=validate.bind(this);verifySignature=verifySignature.bind(this);isReplaceable=isReplaceable.bind(this);isEphemeral=isEphemeral.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable.bind(this);encode=encode.bind(this);encrypt=encrypt.bind(this);decrypt=decrypt.bind(this);getMatchingTags(e,n){const r=this.tags.filter(s=>s[0]===e);return n===void 0?r:r.filter(s=>s[3]===n)}hasTag(e,n){return this.tags.some(r=>r[0]===e&&(!n||r[3]===n))}tagValue(e,n){const r=this.getMatchingTags(e,n);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,n){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(s=>{const o=r.includes(s[0]),a=n?s[3]===n:!0;return!(o&&a)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,n){e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,n);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,n,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,n,r)}async publish(e,n,r,s){if(r||(r=1),this.sig||await this.sign(void 0,s),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const l=this.getMatchingTags("e").map(u=>u[1]);this.ndk.cacheAdapter.deleteEventIds(l)}const o=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(l){console.error("Error adding unpublished event to cache",l)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(l=>l[1])),this.ndk.subManager.dispatchEvent(o,void 0,!0);const a=await e.publish(this,n,r);return a.forEach(l=>this.ndk?.subManager.seenEvent(this.id,l)),a}async generateTags(e){let n=[];const r=await generateContentTags(this.content,this.tags,e,this),s=r.content;if(n=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const a=this.tagValue("title");let u=[...Array(a?6:16)].map(()=>Math.random().toString(36)[2]).join("");a&&a.length>0&&(u=`${a.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${u}`),n.push(["d",u])}if(this.shouldAddClientTag){const o=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&o.push(this.ndk?.clientNip89),n.push(o)}else this.shouldStripClientTag&&(n=n.filter(o=>o[0]!=="client"));return{content:s||"",tags:n}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds.has(this.kind)}muted(){const e=this.ndk?.mutedIds.get(this.pubkey);if(e&&e==="p")return"author";const n=this.tagReference(),r=this.ndk?.mutedIds.get(n[1]);return r&&r===n[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let n;return this.isParamReplaceable()?n=["a",this.tagAddress()]:n=["e",this.tagId()],this.relay?n.push(this.relay.url):n.push(""),n.push(e??""),this.isParamReplaceable()||n.push(this.pubkey),n}referenceTags(e,n,r,s){let o=[];return this.isParamReplaceable()?o=[[r??"a",this.tagAddress()],[r??"e",this.id]]:o=[[r??"e",this.id]],o=o.map(a=>(a[0]==="e"||e?a.push(this.relay?.url??""):this.relay?.url&&a.push(this.relay?.url),a)),o.forEach(a=>{a[0]==="e"?(a.push(e??""),a.push(this.pubkey)):e&&a.push(e)}),o=[...o,...this.getMatchingTags("h")],!n&&s?.pTags!==!1&&o.push(...this.author.referenceTags()),o}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new vt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),n&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent.bind(this);fetchRootEvent=fetchRootEvent.bind(this);fetchReplyEvent=fetchReplyEvent.bind(this);repost=repost.bind(this);async react(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new vt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),n&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,n){const r=new vt(this.ndk);if(this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,n)]:r.tag(this,"root",!1,void 0,n);else{r.kind=1111;const s=["A","E","I","P"],o=this.tags.filter(a=>s.includes(a[0]));if(o.length>0){const a=this.tagValue("K");r.tags.push(...o),a&&r.tags.push(["K",a]);let l;if(this.isParamReplaceable()){l=["a",this.tagAddress()];const u=this.relay?.url??"";u&&l.push(u)}else{l=["e",this.tagId()];const u=this.relay?.url??"";l.push(u),l.push(this.pubkey)}r.tags.push(l)}else{let a,l;const u=this.relay?.url??"";this.isParamReplaceable()?(a=["a",this.tagAddress(),u],l=["A",this.tagAddress(),u]):(a=["e",this.tagId(),u,this.pubkey],l=["E",this.tagId(),u,this.pubkey]),r.tags.push(a),r.tags.push(l),r.tags.push(["K",this.kind?.toString()]),n?.pTags!==!1&&n?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),n?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent(t){return!untrackedUnpublishedEvents.has(t.kind)}var NDKPool=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;poolBlacklistRelayUrls=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;get blacklistRelayUrls(){const t=new Set(this.ndk.blacklistRelayUrls);return this.poolBlacklistRelayUrls.forEach(e=>t.add(e)),t}constructor(t,e,n,{debug:r,name:s}={}){super(),this.debug=r??n.debug.extend("pool"),s&&(this._name=s),this.ndk=n,this.relayUrls=t,this.poolBlacklistRelayUrls=new Set(e),this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const n=new NDKRelay(e,void 0,this.ndk);n.connectivity.netDebug=this.ndk.netDebug,this.addRelay(n)}}_name="unnamed";get name(){return this._name}set name(t){this._name=t,this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,n){const r=this.relays.has(t.url);r||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,n));const s=this.temporaryRelayTimers.get(t.url);if(s&&clearTimeout(s),!r||s){const o=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,o)}}addRelay(t,e=!0){const n=this.relays.has(t.url),r=this.blacklistRelayUrls?.has(t.url),s=t.url.includes("/npub1");let o=!0;const a=t.url;if(n)return;if(r){this.debug(`Refusing to add relay ${a}: blacklisted`);return}if(s){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const x=this.ndk.cacheAdapter.getRelayStatus(a);if(x?.dontConnectBefore){if(x.dontConnectBefore>Date.now()){const T=x.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${T}ms`),setTimeout(()=>{this.addRelay(t,e)},T);return}o=!1}}const l=x=>this.emit("notice",t,x),u=()=>this.handleRelayConnect(a),p=()=>this.handleRelayReady(t),y=()=>{this.recordDisconnection(t),this.emit("relay:disconnect",t)},b=()=>this.handleFlapping(t),w=x=>this.emit("relay:auth",t,x),_=()=>this.emit("relay:authed",t);t.off("notice",l),t.off("connect",u),t.off("ready",p),t.off("disconnect",y),t.off("flapping",b),t.off("auth",w),t.off("authed",_),t.on("notice",l),t.on("connect",u),t.on("ready",p),t.on("disconnect",y),t.on("flapping",b),t.on("auth",w),t.on("authed",_),t.on("delayed-connect",x=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+x})}),this._relays.set(a,t),e&&this.autoConnectRelays.add(a),e&&this.status==="active"&&(this.emit("relay:connecting",t),t.connect(void 0,o).catch(x=>{this.debug(`Failed to connect to relay ${a}`,x)}))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const n=this.temporaryRelayTimers.get(t);return n&&(clearTimeout(n),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=normalizeRelayUrl(t),n=this.relays.get(e);return n?n.status===5:!1}getRelay(t,e=!0,n=!1,r){let s=this.relays.get(normalizeRelayUrl(t));return s||(s=new NDKRelay(t,void 0,this.ndk),s.connectivity.netDebug=this.ndk.netDebug,n?this.useTemporaryRelay(s,3e4,r):this.addRelay(s,e)),s}handleRelayConnect(t){const e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}ms`:""}...`);const e=Array.from(this.autoConnectRelays.keys()).map(o=>this.relays.get(o)).filter(o=>!!o);for(const o of e)o.status!==5&&o.status!==4&&(this.emit("relay:connecting",o),o.connect().catch(a=>{this.debug(`Failed to connect to relay ${o.url}: ${a??"No reason specified"}`)}));const n=()=>e.every(o=>o.status===5),r=new Promise(o=>{if(n()){o();return}const a=[];for(const l of e){const u=()=>{if(n()){for(let p=0;p<e.length;p++)e[p].off("connect",a[p]);o()}};a.push(u),l.on("connect",u)}}),s=typeof t=="number"?new Promise(o=>setTimeout(o,t)):new Promise(()=>{});await Promise.race([r,s])}checkOnFlappingRelays(){const t=this.flappingRelays.size,e=this.relays.size;if(t/e>=.8)for(const n of this.flappingRelays)this.backoffTimes.set(n,0)}recordDisconnection(t){const e=Date.now();this.disconnectionTimes.set(t.url,e);for(const[n,r]of this.disconnectionTimes.entries())e-r>1e4&&this.disconnectionTimes.delete(n);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const t=Date.now(),e=[];for(const n of this.disconnectionTimes.values())t-n<5e3&&e.push(n);e.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${e.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector&&clearTimeout(this.systemEventDetector),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const t of this.relays.values())t.connectivity&&(t.connectivity.resetReconnectionState(),t.status!==5&&t.status!==4&&t.connect().catch(e=>{this.debug(`Failed to reconnect relay ${t.url} after system event: ${e}`)}));this.disconnectionTimes.clear()}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e=e*2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,e.status===5?t.connected++:e.status===1?t.disconnected++:e.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}},NDKCashuMintList=class vi extends NDKEvent{static kind=10019;static kinds=[10019];_p2pk;constructor(e,n){super(e,n),this.kind??=10019}static from(e){return new vi(e.ndk,e)}set relays(e){this.tags=this.tags.filter(n=>n[0]!=="relay");for(const n of e)this.tags.push(["relay",n])}get relays(){const e=[];for(const n of this.tags)n[0]==="relay"&&e.push(n[1]);return e}set mints(e){this.tags=this.tags.filter(n=>n[0]!=="mint");for(const n of e)this.tags.push(["mint",n])}get mints(){const e=[];for(const n of this.tags)n[0]==="mint"&&e.push(n[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}};(class er extends NDKEvent{debug;_proofs=[];static kind=9321;static kinds=[er.kind];constructor(e,n){super(e,n),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(s=>JSON.parse(s[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const n=new er(e.ndk,e);if(!(!n._proofs||!n._proofs.length))return n}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(n=>n[0]!=="proof");for(const n of e)this.tags.push(["proof",JSON.stringify(n)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const n=JSON.parse(e.secret);let r;if(typeof n=="string"?(r=JSON.parse(n),this.debug("stringified payload",e.secret)):typeof n=="object"&&(r=n),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(n){this.debug("error parsing p2pk pubkey",n,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((n,r)=>n+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(n=>n[0]!=="p"),e instanceof NDKEvent&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,n=0,r=0;for(const s of this.tags)s[0]==="e"&&e++,s[0]==="p"&&n++,s[0]==="u"&&r++;return n===1&&r===1&&e<=1&&this.proofs.length>0}});var signerRegistry=new Map;function registerSigner(t,e){signerRegistry.set(t,e)}var NDKPrivateKeySigner=class tr{_user;_privateKey;_pubkey;constructor(e,n){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:s}=nip19_exports$2.decode(e);if(r==="nsec")this._privateKey=s;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=utils.hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),n&&(this._user=n.getUser({pubkey:this._pubkey})),this._user??=new NDKUser({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return utils.bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}static generate(){const e=generateSecretKey();return new tr(e)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&n.push("nip04"),(!e||e==="nip44")&&n.push("nip44"),n}async encrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const s=e.pubkey;if(r==="nip44"){const o=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.encrypt(n,o)}return await nip04_exports.encrypt(this._privateKey,s,n)}async decrypt(e,n,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const s=e.pubkey;if(r==="nip44"){const o=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.decrypt(n,o)}return await nip04_exports.decrypt(this._privateKey,s,n)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new tr(r.payload,n)}};registerSigner("private-key",NDKPrivateKeySigner);async function follows(t,e,n=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(r){const s=new Set;return r.tags.forEach(o=>{o[0]==="p"&&s.add(o[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(s)),[...s].reduce((o,a)=>{const l=new NDKUser({pubkey:a});return l.ndk=this.ndk,o.add(l),o},new Set)}return new Set}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(t,e,n=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter?.loadNip05){const u=await t.cacheAdapter.loadNip05(e);if(u!=="missing"){if(u){const p=new NDKUser({pubkey:u.pubkey,relayUrls:u.relays,nip46Urls:u.nip46});return p.ndk=t,p}if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX);if(!s)return null;const[o,a="_",l]=s;try{const u=await n(`https://${l}/.well-known/nostr.json?name=${a}`,r),{names:p,relays:y,nip46:b}=parseNIP05Result(await u.json()),w=p[a.toLowerCase()];let _=null;return w&&(_={pubkey:w,relays:y?.[w],nip46:b?.[w]}),t?.cacheAdapter?.saveNip05&&t.cacheAdapter.saveNip05(e,_),_}catch(u){return t?.cacheAdapter?.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,u),null}}})}function parseNIP05Result(t){const e={names:{}};for(const[n,r]of Object.entries(t.names))typeof n=="string"&&typeof r=="string"&&(e.names[n.toLowerCase()]=r);if(t.relays){e.relays={};for(const[n,r]of Object.entries(t.relays))typeof n=="string"&&Array.isArray(r)&&(e.relays[n]=r.filter(s=>typeof s=="string"))}if(t.nip46){e.nip46={};for(const[n,r]of Object.entries(t.nip46))typeof n=="string"&&Array.isArray(r)&&(e.nip46[n]=r.filter(s=>typeof s=="string"))}return e}function profileFromEvent(t){const e={};let n;try{n=JSON.parse(t.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const r of Object.keys(n))switch(r){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.picture=n.picture||n.image,e.image=e.picture;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"website":e.website=n.website;break;default:e[r]=n[r];break}return e.created_at=t.created_at,e}function serializeProfile(t){const e={};for(const[n,r]of Object.entries(t))switch(n){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[n]=r;break}return JSON.stringify(e)}var NDKUser=class wi{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const n=nip19_exports$2.decode(e.nprofile);n.type==="nprofile"&&(this._pubkey=n.data.pubkey,n.data.relays&&n.data.relays.length>0&&this.relayUrls.push(...n.data.relays))}catch(n){console.error("Failed to decode nprofile",n)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(n=>n.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const n=async a=>{if(!e)return a;let l;const u=new Promise((p,y)=>{l=setTimeout(()=>y(new Error("Timeout")),e)});try{const p=await Promise.race([a,u]);return l&&clearTimeout(l),p}catch(p){if(p instanceof Error&&p.message==="Timeout")try{return await a}catch{return}return}},[r,s]=await Promise.all([n(this.fetchProfile()),n(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),o=new Map;if(s){const a=NDKCashuMintList.from(s);a.mints.length>0&&o.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(r){const{lud06:a,lud16:l}=r;o.set("nip57",{lud06:a,lud16:l})}return o}static async fromNip05(e,n,r=!1){if(!n)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const o=await getNip05For(n,e,n?.httpFetch,s);if(o){const a=new wi({pubkey:o.pubkey,relayUrls:o.relays,nip46Urls:o.nip46});return a.ndk=n,a}}async fetchProfile(e,n=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let s=null;if(this.ndk.cacheAdapter.fetchProfileSync?s=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(s=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),s)return this.profile=s,s}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=profileFromEvent(r),n&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows.bind(this);async followSet(e,n,r=3){const s=await this.follows(e,n,r);return new Set(Array.from(s).map(o=>o.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const n=[["p",this.pubkey]];return e&&n[0].push("",e),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r)),n.has(e))return!1;n.add(e);const s=new NDKEvent(this.ndk,{kind:r});for(const o of n)s.tag(o);return await s.publish(),!0}async unfollow(e,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=new Set;let o=!1;for(const l of n)l.pubkey!==e.pubkey?s.add(l):o=!0;if(!o)return!1;const a=new NDKEvent(this.ndk,{kind:r});for(const l of s)a.tag(l);return await a.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For(this.ndk,e);return n===null?null:n.pubkey===this.pubkey}};function disconnect(t,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async n=>{e?.(`Relay ${n.url} requested authentication, disconnecting`),t.removeRelay(n.url)}}async function signAndAuth(t,e,n,r,s,o){try{await t.sign(n),s(t)}catch(a){r?.(`Failed to publish auth event to relay ${e.url}`,a),o(t)}}function signIn({ndk:t,signer:e,debug:n}={}){return n??=createDebug2("ndk:auth-policies:signIn"),async(r,s)=>{n?.(`Relay ${r.url} requested authentication, signing in`);const o=new NDKEvent(t);return o.kind=22242,o.tags=[["relay",r.url],["challenge",s]],e??=t?.signer,new Promise(async(a,l)=>{e?await signAndAuth(o,r,e,n,a,l):t?.once("signer:ready",async u=>{await signAndAuth(o,r,u,n,a,l)})})}}var NDKRelayAuthPolicies={disconnect,signIn},NDKNip07Signer=class _i{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,n){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=n}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let n;return this.ndk?n=this.ndk.getUser({pubkey:e}):n=new NDKUser({pubkey:e}),this._user=n,n}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const n=await window.nostr?.signEvent(e);if(!n)throw new Error("Failed to sign event");return n.sig}async relays(e){await this.waitForExtension();const n=await window.nostr?.getRelays?.()||{},r=[];for(const s of Object.keys(n))n[s].read&&n[s].write&&r.push(s);return r.map(s=>new NDKRelay(s,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&window.nostr?.nip04&&n.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&n.push("nip44"),n}async encrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"encrypt",s,n)}async decrypt(e,n,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"decrypt",s,n)}async queueEncryption(e,n,r,s){return new Promise((o,a)=>{this.encryptionQueue.push({scheme:e,method:n,counterpartyHexpubkey:r,value:s,resolve:o,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,n=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:s,method:o,counterpartyHexpubkey:a,value:l,resolve:u,reject:p}=r;this.debug("Processing encryption queue item",{method:o,counterpartyHexpubkey:a,value:l});try{const y=await window.nostr?.[s]?.[o](a,l);if(!y)throw new Error("Failed to encrypt/decrypt");u(y)}catch(y){const b=y instanceof Error?y.message:String(y);if(b.includes("call already executing")&&n<5){this.debug("Retrying encryption queue item",{method:o,counterpartyHexpubkey:a,value:l,retries:n}),setTimeout(()=>{this.processEncryptionQueue(r,n+1)},50*n);return}p(y instanceof Error?y:new Error(b))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,n)=>{if(window.nostr){e();return}let r;const s=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(s),e())},100);r=setTimeout(()=>{clearInterval(s),n(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,n){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new _i(void 0,n)}};registerSigner("nip07",NDKNip07Signer);var NDKNostrRpc=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(t,e,n,r){if(super(),this.ndk=t,this.signer=e,r){this.pool=new NDKPool(r,[],t,{debug:n.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet(new Set,t,this.pool);for(const s of r){const o=this.pool.getRelay(s,!1,!1);o.authPolicy=NDKRelayAuthPolicies.signIn({ndk:t,signer:e,debug:n}),this.relaySet.addRelay(o),o.connect()}}this.debug=n.extend("rpc")}subscribe(t){const e=this.ndk.subscribe(t,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet},!1);return e.on("event",async n=>{try{const r=await this.parseEvent(n);r.method?this.emit("request",r):(this.emit(`response-${r.id}`,r),this.emit("response",r))}catch(r){this.debug("error parsing event",r,n.rawEvent())}}),new Promise(n=>{e.on("eose",()=>{this.debug("eosed"),n(e)}),e.start()})}async parseEvent(t){this.encryptionType==="nip44"&&t.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!t.content.includes("?iv=")&&(this.encryptionType="nip44");const e=this.ndk.getUser({pubkey:t.pubkey});e.ndk=this.ndk;let n;try{n=await this.signer.decrypt(e,t.content,this.encryptionType)}catch{const y=this.encryptionType==="nip04"?"nip44":"nip04";n=await this.signer.decrypt(e,t.content,y),this.encryptionType=y}const r=JSON.parse(n),{id:s,method:o,params:a,result:l,error:u}=r;return o?{id:s,pubkey:t.pubkey,method:o,params:a,event:t}:{id:s,result:l,error:u,event:t}}async sendResponse(t,e,n,r=24133,s){const o={id:t,result:n};s&&(o.error=s);const a=await this.signer.user(),l=this.ndk.getUser({pubkey:e}),u=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(o),tags:[["p",e]],pubkey:a.pubkey});u.content=await this.signer.encrypt(l,u.content,this.encryptionType),await u.sign(this.signer),await u.publish(this.relaySet)}async sendRequest(t,e,n=[],r=24133,s){const o=Math.random().toString(36).substring(7),a=await this.signer.user(),l=this.ndk.getUser({pubkey:t}),u={id:o,method:e,params:n},p=new Promise(()=>{const b=w=>{w.result==="auth_url"?(this.once(`response-${o}`,b),this.emit("authUrl",w.error)):s&&s(w)};this.once(`response-${o}`,b)}),y=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(u),tags:[["p",t]],pubkey:a.pubkey});return y.content=await this.signer.encrypt(l,y.content,this.encryptionType),await y.sign(this.signer),await y.publish(this.relaySet),p}};async function ndkSignerFromPayload(t,e){let n;try{n=JSON.parse(t)}catch(s){console.error("Failed to parse signer payload string",t,s);return}if(!n||typeof n.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const r=signerRegistry.get(n.type);if(!r)throw new Error(`Unknown signer type: ${n.type}`);try{return await r.fromPayload(t,e)}catch(s){const o=s instanceof Error?s.message:String(s);throw new Error(`Failed to deserialize signer type ${n.type}: ${o}`)}}function nostrConnectGenerateSecret(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri(t,e,n,r){const s={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let o=`nostrconnect://${t}?image=${s.image}&url=${s.url}&name=${s.name}&perms=${s.perms}&secret=${encodeURIComponent(e)}`;return n&&(o+=`&relay=${encodeURIComponent(n)}`),o}var NDKNip46Signer=class mn extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,n,r,s,o){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=s,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner.generate(),n===!1||(n?n.startsWith("bunker://")?this.bunkerFlowInit(n):this.nip05Init(n):this.nostrconnectFlowInit(o)),this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,n,r){return new mn(e,n,r)}static nostrconnect(e,n,r,s){return new mn(e,void 0,r,[n],s)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret();const n=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri(n,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const n=new URL(e),r=n.hostname||n.pathname.replace(/^\/\//,""),s=n.searchParams.get("pubkey"),o=n.searchParams.getAll("relay"),a=n.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=s,this.relayUrls=o,this.secret=a}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,n)=>{const r=s=>{s.result===this.nostrConnectSecret&&(this._user=s.event.author,this.userPubkey=s.event.pubkey,this.bunkerPubkey=s.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,n)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,s=>{s.result==="ack"?this.getPublicKey().then(o=>{this.userPubkey=o,this._user=this.ndk.getUser({pubkey:o}),e(this._user)}):n(s.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,n)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,n,r="nip04"){return this.encryption(e,n,r,"encrypt")}async decrypt(e,n,r="nip04"){return this.encryption(e,n,r,"decrypt")}async encryption(e,n,r,s){return new Promise((a,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${s}`,[e.pubkey,n],24133,u=>{u.error?l(u.error):a(u.result)})})}async sign(e){return new Promise((r,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,o=>{if(o.error)s(o.error);else{const a=JSON.parse(o.result);r(a.sig)}})})}async createAccount(e,n,r){await this.startListening();const s=[];return e&&s.push(e),n&&s.push(n),r&&s.push(r),new Promise((o,a)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",s,24133,l=>{if(l.error)a(l.error);else{const u=l.result;o(u)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,n){if(!n)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const s=r.payload;if(!s||typeof s!="object"||!s.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const o=await ndkSignerFromPayload(s.localSignerPayload,n);if(!o)throw new Error("Failed to deserialize local signer for NIP-46");if(!(o instanceof NDKPrivateKeySigner))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let a;return a=new mn(n,!1,o,s.relayUrls),a.userPubkey=s.userPubkey,a.bunkerPubkey=s.bunkerPubkey,a.relayUrls=s.relayUrls,a.secret=s.secret,s.userPubkey&&(a._user=new NDKUser({pubkey:s.userPubkey}),a._user&&(a._user.ndk=n)),a}};registerSigner("nip46",NDKNip46Signer);createDebug2("ndk:active-user");createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");var nip19_exports={};__reExport(nip19_exports,nip19_star);var dexie_min={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(commonjsGlobal,function(){var n=function(c,h){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(f,g){f.__proto__=g}||function(f,g){for(var m in g)Object.prototype.hasOwnProperty.call(g,m)&&(f[m]=g[m])})(c,h)},r=function(){return(r=Object.assign||function(c){for(var h,f=1,g=arguments.length;f<g;f++)for(var m in h=arguments[f])Object.prototype.hasOwnProperty.call(h,m)&&(c[m]=h[m]);return c}).apply(this,arguments)};function s(c,h,f){for(var g,m=0,v=h.length;m<v;m++)!g&&m in h||((g=g||Array.prototype.slice.call(h,0,m))[m]=h[m]);return c.concat(g||Array.prototype.slice.call(h))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:commonjsGlobal,a=Object.keys,l=Array.isArray;function u(c,h){return typeof h!="object"||a(h).forEach(function(f){c[f]=h[f]}),c}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var p=Object.getPrototypeOf,y={}.hasOwnProperty;function b(c,h){return y.call(c,h)}function w(c,h){typeof h=="function"&&(h=h(p(c))),(typeof Reflect>"u"?a:Reflect.ownKeys)(h).forEach(function(f){x(c,f,h[f])})}var _=Object.defineProperty;function x(c,h,f,g){_(c,h,u(f&&b(f,"get")&&typeof f.get=="function"?{get:f.get,set:f.set,configurable:!0}:{value:f,configurable:!0,writable:!0},g))}function T(c){return{from:function(h){return c.prototype=Object.create(h.prototype),x(c.prototype,"constructor",c),{extend:w.bind(null,c.prototype)}}}}var k=Object.getOwnPropertyDescriptor,B=[].slice;function G(c,h,f){return B.call(c,h,f)}function z(c,h){return h(c)}function Q(c){if(!c)throw new Error("Assertion Failed")}function ye(c){o.setImmediate?setImmediate(c):setTimeout(c,0)}function ie(c,h){if(typeof h=="string"&&b(c,h))return c[h];if(!h)return c;if(typeof h!="string"){for(var f=[],g=0,m=h.length;g<m;++g){var v=ie(c,h[g]);f.push(v)}return f}var E=h.indexOf(".");if(E!==-1){var S=c[h.substr(0,E)];return S==null?void 0:ie(S,h.substr(E+1))}}function te(c,h,f){if(c&&h!==void 0&&!("isFrozen"in Object&&Object.isFrozen(c)))if(typeof h!="string"&&"length"in h){Q(typeof f!="string"&&"length"in f);for(var g=0,m=h.length;g<m;++g)te(c,h[g],f[g])}else{var v,E,S=h.indexOf(".");S!==-1?(v=h.substr(0,S),(E=h.substr(S+1))===""?f===void 0?l(c)&&!isNaN(parseInt(v))?c.splice(v,1):delete c[v]:c[v]=f:te(S=!(S=c[v])||!b(c,v)?c[v]={}:S,E,f)):f===void 0?l(c)&&!isNaN(parseInt(h))?c.splice(h,1):delete c[h]:c[h]=f}}function oe(c){var h,f={};for(h in c)b(c,h)&&(f[h]=c[h]);return f}var ne=[].concat;function me(c){return ne.apply([],c)}var at="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(me([8,16,32,64].map(function(c){return["Int","Uint","Float"].map(function(h){return h+c+"Array"})}))).filter(function(c){return o[c]}),O=new Set(at.map(function(c){return o[c]})),F=null;function j(c){return F=new WeakMap,c=function h(f){if(!f||typeof f!="object")return f;var g=F.get(f);if(g)return g;if(l(f)){g=[],F.set(f,g);for(var m=0,v=f.length;m<v;++m)g.push(h(f[m]))}else if(O.has(f.constructor))g=f;else{var E,S=p(f);for(E in g=S===Object.prototype?{}:Object.create(S),F.set(f,g),f)b(f,E)&&(g[E]=h(f[E]))}return g}(c),F=null,c}var H={}.toString;function V(c){return H.call(c).slice(8,-1)}var W=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Z=typeof W=="symbol"?function(c){var h;return c!=null&&(h=c[W])&&h.apply(c)}:function(){return null};function ae(c,h){return h=c.indexOf(h),0<=h&&c.splice(h,1),0<=h}var A={};function J(c){var h,f,g,m;if(arguments.length===1){if(l(c))return c.slice();if(this===A&&typeof c=="string")return[c];if(m=Z(c)){for(f=[];!(g=m.next()).done;)f.push(g.value);return f}if(c==null)return[c];if(typeof(h=c.length)!="number")return[c];for(f=new Array(h);h--;)f[h]=c[h];return f}for(h=arguments.length,f=new Array(h);h--;)f[h]=arguments[h];return f}var X=typeof Symbol<"u"?function(c){return c[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Ct=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],ze=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Ct),de={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ve(c,h){this.name=c,this.message=h}function we(c,h){return c+". Errors: "+Object.keys(h).map(function(f){return h[f].toString()}).filter(function(f,g,m){return m.indexOf(f)===g}).join(`
`)}function Ce(c,h,f,g){this.failures=h,this.failedKeys=g,this.successCount=f,this.message=we(c,h)}function Re(c,h){this.name="BulkError",this.failures=Object.keys(h).map(function(f){return h[f]}),this.failuresByPos=h,this.message=we(c,this.failures)}T(ve).from(Error).extend({toString:function(){return this.name+": "+this.message}}),T(Ce).from(ve),T(Re).from(ve);var De=ze.reduce(function(c,h){return c[h]=h+"Error",c},{}),Ke=ve,pe=ze.reduce(function(c,h){var f=h+"Error";function g(m,v){this.name=f,m?typeof m=="string"?(this.message="".concat(m).concat(v?`
 `+v:""),this.inner=v||null):typeof m=="object"&&(this.message="".concat(m.name," ").concat(m.message),this.inner=m):(this.message=de[h]||f,this.inner=null)}return T(g).from(Ke),c[h]=g,c},{});pe.Syntax=SyntaxError,pe.Type=TypeError,pe.Range=RangeError;var wt=Ct.reduce(function(c,h){return c[h+"Error"]=pe[h],c},{}),We=ze.reduce(function(c,h){return["Syntax","Type","Range"].indexOf(h)===-1&&(c[h+"Error"]=pe[h]),c},{});function xe(){}function je(c){return c}function Qe(c,h){return c==null||c===je?h:function(f){return h(c(f))}}function qe(c,h){return function(){c.apply(this,arguments),h.apply(this,arguments)}}function Ei(c,h){return c===xe?h:function(){var f=c.apply(this,arguments);f!==void 0&&(arguments[0]=f);var g=this.onsuccess,m=this.onerror;this.onsuccess=null,this.onerror=null;var v=h.apply(this,arguments);return g&&(this.onsuccess=this.onsuccess?qe(g,this.onsuccess):g),m&&(this.onerror=this.onerror?qe(m,this.onerror):m),v!==void 0?v:f}}function ki(c,h){return c===xe?h:function(){c.apply(this,arguments);var f=this.onsuccess,g=this.onerror;this.onsuccess=this.onerror=null,h.apply(this,arguments),f&&(this.onsuccess=this.onsuccess?qe(f,this.onsuccess):f),g&&(this.onerror=this.onerror?qe(g,this.onerror):g)}}function Si(c,h){return c===xe?h:function(f){var g=c.apply(this,arguments);u(f,g);var m=this.onsuccess,v=this.onerror;return this.onsuccess=null,this.onerror=null,f=h.apply(this,arguments),m&&(this.onsuccess=this.onsuccess?qe(m,this.onsuccess):m),v&&(this.onerror=this.onerror?qe(v,this.onerror):v),g===void 0?f===void 0?void 0:f:u(g,f)}}function xi(c,h){return c===xe?h:function(){return h.apply(this,arguments)!==!1&&c.apply(this,arguments)}}function bn(c,h){return c===xe?h:function(){var f=c.apply(this,arguments);if(f&&typeof f.then=="function"){for(var g=this,m=arguments.length,v=new Array(m);m--;)v[m]=arguments[m];return f.then(function(){return h.apply(g,v)})}return h.apply(this,arguments)}}We.ModifyError=Ce,We.DexieError=ve,We.BulkError=Re;var Ge=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function nr(c){Ge=c}var Nt={},rr=100,at=typeof Promise>"u"?[]:function(){var c=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[c,p(c),c];var h=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[h,p(h),c]}(),Ct=at[0],ze=at[1],at=at[2],ze=ze&&ze.then,ct=Ct&&Ct.constructor,vn=!!at,$t=function(c,h){Pt.push([c,h]),Ht&&(queueMicrotask(Ai),Ht=!1)},wn=!0,Ht=!0,lt=[],Vt=[],_n=je,et={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:xe,pgp:!1,env:{},finalize:xe},be=et,Pt=[],ht=0,zt=[];function fe(c){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var h=this._PSD=be;if(typeof c!="function"){if(c!==Nt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&kn(this,this._value))}this._state=null,this._value=null,++h.ref,function f(g,m){try{m(function(v){if(g._state===null){if(v===g)throw new TypeError("A promise cannot be resolved with itself.");var E=g._lib&&_t();v&&typeof v.then=="function"?f(g,function(S,N){v instanceof fe?v._then(S,N):v.then(S,N)}):(g._state=!0,g._value=v,sr(g)),E&&Et()}},kn.bind(null,g))}catch(v){kn(g,v)}}(this,c)}var En={get:function(){var c=be,h=Gt;function f(g,m){var v=this,E=!c.global&&(c!==be||h!==Gt),S=E&&!nt(),N=new fe(function(C,D){Sn(v,new ir(ar(g,c,E,S),ar(m,c,E,S),C,D,c))});return this._consoleTask&&(N._consoleTask=this._consoleTask),N}return f.prototype=Nt,f},set:function(c){x(this,"then",c&&c.prototype===Nt?En:{get:function(){return c},set:En.set})}};function ir(c,h,f,g,m){this.onFulfilled=typeof c=="function"?c:null,this.onRejected=typeof h=="function"?h:null,this.resolve=f,this.reject=g,this.psd=m}function kn(c,h){var f,g;Vt.push(h),c._state===null&&(f=c._lib&&_t(),h=_n(h),c._state=!1,c._value=h,g=c,lt.some(function(m){return m._value===g._value})||lt.push(g),sr(c),f&&Et())}function sr(c){var h=c._listeners;c._listeners=[];for(var f=0,g=h.length;f<g;++f)Sn(c,h[f]);var m=c._PSD;--m.ref||m.finalize(),ht===0&&(++ht,$t(function(){--ht==0&&xn()},[]))}function Sn(c,h){if(c._state!==null){var f=c._state?h.onFulfilled:h.onRejected;if(f===null)return(c._state?h.resolve:h.reject)(c._value);++h.psd.ref,++ht,$t(Ti,[f,c,h])}else c._listeners.push(h)}function Ti(c,h,f){try{var g,m=h._value;!h._state&&Vt.length&&(Vt=[]),g=Ge&&h._consoleTask?h._consoleTask.run(function(){return c(m)}):c(m),h._state||Vt.indexOf(m)!==-1||function(v){for(var E=lt.length;E;)if(lt[--E]._value===v._value)return lt.splice(E,1)}(h),f.resolve(g)}catch(v){f.reject(v)}finally{--ht==0&&xn(),--f.psd.ref||f.psd.finalize()}}function Ai(){dt(et,function(){_t()&&Et()})}function _t(){var c=wn;return Ht=wn=!1,c}function Et(){var c,h,f;do for(;0<Pt.length;)for(c=Pt,Pt=[],f=c.length,h=0;h<f;++h){var g=c[h];g[0].apply(null,g[1])}while(0<Pt.length);Ht=wn=!0}function xn(){var c=lt;lt=[],c.forEach(function(g){g._PSD.onunhandled.call(null,g._value,g)});for(var h=zt.slice(0),f=h.length;f;)h[--f]()}function jt(c){return new fe(Nt,!1,c)}function $e(c,h){var f=be;return function(){var g=_t(),m=be;try{return rt(f,!0),c.apply(this,arguments)}catch(v){h&&h(v)}finally{rt(m,!1),g&&Et()}}}w(fe.prototype,{then:En,_then:function(c,h){Sn(this,new ir(null,null,c,h,be))},catch:function(c){if(arguments.length===1)return this.then(null,c);var h=c,f=arguments[1];return typeof h=="function"?this.then(null,function(g){return(g instanceof h?f:jt)(g)}):this.then(null,function(g){return(g&&g.name===h?f:jt)(g)})},finally:function(c){return this.then(function(h){return fe.resolve(c()).then(function(){return h})},function(h){return fe.resolve(c()).then(function(){return jt(h)})})},timeout:function(c,h){var f=this;return c<1/0?new fe(function(g,m){var v=setTimeout(function(){return m(new pe.Timeout(h))},c);f.then(g,m).finally(clearTimeout.bind(null,v))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&x(fe.prototype,Symbol.toStringTag,"Dexie.Promise"),et.env=or(),w(fe,{all:function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(h,f){c.length===0&&h([]);var g=c.length;c.forEach(function(m,v){return fe.resolve(m).then(function(E){c[v]=E,--g||h(c)},f)})})},resolve:function(c){return c instanceof fe?c:c&&typeof c.then=="function"?new fe(function(h,f){c.then(h,f)}):new fe(Nt,!0,c)},reject:jt,race:function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(h,f){c.map(function(g){return fe.resolve(g).then(h,f)})})},PSD:{get:function(){return be},set:function(c){return be=c}},totalEchoes:{get:function(){return Gt}},newPSD:tt,usePSD:dt,scheduler:{get:function(){return $t},set:function(c){$t=c}},rejectionMapper:{get:function(){return _n},set:function(c){_n=c}},follow:function(c,h){return new fe(function(f,g){return tt(function(m,v){var E=be;E.unhandleds=[],E.onunhandled=v,E.finalize=qe(function(){var S,N=this;S=function(){N.unhandleds.length===0?m():v(N.unhandleds[0])},zt.push(function C(){S(),zt.splice(zt.indexOf(C),1)}),++ht,$t(function(){--ht==0&&xn()},[])},E.finalize),c()},h,f,g)})}}),ct&&(ct.allSettled&&x(fe,"allSettled",function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(h){c.length===0&&h([]);var f=c.length,g=new Array(f);c.forEach(function(m,v){return fe.resolve(m).then(function(E){return g[v]={status:"fulfilled",value:E}},function(E){return g[v]={status:"rejected",reason:E}}).then(function(){return--f||h(g)})})})}),ct.any&&typeof AggregateError<"u"&&x(fe,"any",function(){var c=J.apply(null,arguments).map(Jt);return new fe(function(h,f){c.length===0&&f(new AggregateError([]));var g=c.length,m=new Array(g);c.forEach(function(v,E){return fe.resolve(v).then(function(S){return h(S)},function(S){m[E]=S,--g||f(new AggregateError(m))})})})}),ct.withResolvers&&(fe.withResolvers=ct.withResolvers));var Ue={awaits:0,echoes:0,id:0},Ri=0,Wt=[],qt=0,Gt=0,Ni=0;function tt(c,h,f,g){var m=be,v=Object.create(m);return v.parent=m,v.ref=0,v.global=!1,v.id=++Ni,et.env,v.env=vn?{Promise:fe,PromiseProp:{value:fe,configurable:!0,writable:!0},all:fe.all,race:fe.race,allSettled:fe.allSettled,any:fe.any,resolve:fe.resolve,reject:fe.reject}:{},h&&u(v,h),++m.ref,v.finalize=function(){--this.parent.ref||this.parent.finalize()},g=dt(v,c,f,g),v.ref===0&&v.finalize(),g}function kt(){return Ue.id||(Ue.id=++Ri),++Ue.awaits,Ue.echoes+=rr,Ue.id}function nt(){return!!Ue.awaits&&(--Ue.awaits==0&&(Ue.id=0),Ue.echoes=Ue.awaits*rr,!0)}function Jt(c){return Ue.echoes&&c&&c.constructor===ct?(kt(),c.then(function(h){return nt(),h},function(h){return nt(),Pe(h)})):c}function Ci(){var c=Wt[Wt.length-1];Wt.pop(),rt(c,!1)}function rt(c,h){var f,g=be;(h?!Ue.echoes||qt++&&c===be:!qt||--qt&&c===be)||queueMicrotask(h?function(m){++Gt,Ue.echoes&&--Ue.echoes!=0||(Ue.echoes=Ue.awaits=Ue.id=0),Wt.push(be),rt(m,!0)}.bind(null,c):Ci),c!==be&&(be=c,g===et&&(et.env=or()),vn&&(f=et.env.Promise,h=c.env,(g.global||c.global)&&(Object.defineProperty(o,"Promise",h.PromiseProp),f.all=h.all,f.race=h.race,f.resolve=h.resolve,f.reject=h.reject,h.allSettled&&(f.allSettled=h.allSettled),h.any&&(f.any=h.any))))}function or(){var c=o.Promise;return vn?{Promise:c,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:c.all,race:c.race,allSettled:c.allSettled,any:c.any,resolve:c.resolve,reject:c.reject}:{}}function dt(c,h,f,g,m){var v=be;try{return rt(c,!0),h(f,g,m)}finally{rt(v,!1)}}function ar(c,h,f,g){return typeof c!="function"?c:function(){var m=be;f&&kt(),rt(h,!0);try{return c.apply(this,arguments)}finally{rt(m,!1),g&&queueMicrotask(nt)}}}function Tn(c){Promise===ct&&Ue.echoes===0?qt===0?c():enqueueNativeMicroTask(c):setTimeout(c,0)}(""+ze).indexOf("[native code]")===-1&&(kt=nt=xe);var Pe=fe.reject,ft="",Ze="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",cr="String expected.",St=[],Yt="__dbnames",An="readonly",Rn="readwrite";function pt(c,h){return c?h?function(){return c.apply(this,arguments)&&h.apply(this,arguments)}:c:h}var lr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Zt(c){return typeof c!="string"||/\./.test(c)?function(h){return h}:function(h){return h[c]===void 0&&c in h&&delete(h=j(h))[c],h}}function ur(){throw pe.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function Te(c,h){try{var f=hr(c),g=hr(h);if(f!==g)return f==="Array"?1:g==="Array"?-1:f==="binary"?1:g==="binary"?-1:f==="string"?1:g==="string"?-1:f==="Date"?1:g!=="Date"?NaN:-1;switch(f){case"number":case"Date":case"string":return h<c?1:c<h?-1:0;case"binary":return function(m,v){for(var E=m.length,S=v.length,N=E<S?E:S,C=0;C<N;++C)if(m[C]!==v[C])return m[C]<v[C]?-1:1;return E===S?0:E<S?-1:1}(dr(c),dr(h));case"Array":return function(m,v){for(var E=m.length,S=v.length,N=E<S?E:S,C=0;C<N;++C){var D=Te(m[C],v[C]);if(D!==0)return D}return E===S?0:E<S?-1:1}(c,h)}}catch{}return NaN}function hr(c){var h=typeof c;return h!="object"?h:ArrayBuffer.isView(c)?"binary":(c=V(c),c==="ArrayBuffer"?"binary":c)}function dr(c){return c instanceof Uint8Array?c:ArrayBuffer.isView(c)?new Uint8Array(c.buffer,c.byteOffset,c.byteLength):new Uint8Array(c)}function Xt(c,h,f){var g=c.schema.yProps;return g?(h&&0<f.numFailures&&(h=h.filter(function(m,v){return!f.failures[v]})),Promise.all(g.map(function(m){return m=m.updatesTable,h?c.db.table(m).where("k").anyOf(h).delete():c.db.table(m).clear()})).then(function(){return f})):f}var It=(fr.prototype.execute=function(c){var h=this["@@propmod"];if(h.add!==void 0){var f=h.add;if(l(f))return s(s([],l(c)?c:[],!0),f).sort();if(typeof f=="number")return(Number(c)||0)+f;if(typeof f=="bigint")try{return BigInt(c)+f}catch{return BigInt(0)+f}throw new TypeError("Invalid term ".concat(f))}if(h.remove!==void 0){var g=h.remove;if(l(g))return l(c)?c.filter(function(m){return!g.includes(m)}).sort():[];if(typeof g=="number")return Number(c)-g;if(typeof g=="bigint")try{return BigInt(c)-g}catch{return BigInt(0)-g}throw new TypeError("Invalid subtrahend ".concat(g))}return f=(f=h.replacePrefix)===null||f===void 0?void 0:f[0],f&&typeof c=="string"&&c.startsWith(f)?h.replacePrefix[1]+c.substring(f.length):c},fr);function fr(c){this["@@propmod"]=c}function pr(c,h){for(var f=a(h),g=f.length,m=!1,v=0;v<g;++v){var E=f[v],S=h[E],N=ie(c,E);S instanceof It?(te(c,E,S.execute(N)),m=!0):N!==S&&(te(c,E,S),m=!0)}return m}var yr=(Ne.prototype._trans=function(c,h,f){var g=this._tx||be.trans,m=this.name,v=Ge&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(c==="readonly"?"read":"write"," ").concat(this.name));function E(C,D,R){if(!R.schema[m])throw new pe.NotFound("Table "+m+" not part of transaction");return h(R.idbtrans,R)}var S=_t();try{var N=g&&g.db._novip===this.db._novip?g===be.trans?g._promise(c,E,f):tt(function(){return g._promise(c,E,f)},{trans:g,transless:be.transless||be}):function C(D,R,U,$){if(D.idbdb&&(D._state.openComplete||be.letThrough||D._vip)){var P=D._createTransaction(R,U,D._dbSchema);try{P.create(),D._state.PR1398_maxLoop=3}catch(I){return I.name===De.InvalidState&&D.isOpen()&&0<--D._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),D.close({disableAutoOpen:!1}),D.open().then(function(){return C(D,R,U,$)})):Pe(I)}return P._promise(R,function(I,K){return tt(function(){return be.trans=P,$(I,K,P)})}).then(function(I){if(R==="readwrite")try{P.idbtrans.commit()}catch{}return R==="readonly"?I:P._completion.then(function(){return I})})}if(D._state.openComplete)return Pe(new pe.DatabaseClosed(D._state.dbOpenError));if(!D._state.isBeingOpened){if(!D._state.autoOpen)return Pe(new pe.DatabaseClosed);D.open().catch(xe)}return D._state.dbReadyPromise.then(function(){return C(D,R,U,$)})}(this.db,c,[this.name],E);return v&&(N._consoleTask=v,N=N.catch(function(C){return console.trace(C),Pe(C)})),N}finally{S&&Et()}},Ne.prototype.get=function(c,h){var f=this;return c&&c.constructor===Object?this.where(c).first(h):c==null?Pe(new pe.Type("Invalid argument to Table.get()")):this._trans("readonly",function(g){return f.core.get({trans:g,key:c}).then(function(m){return f.hook.reading.fire(m)})}).then(h)},Ne.prototype.where=function(c){if(typeof c=="string")return new this.db.WhereClause(this,c);if(l(c))return new this.db.WhereClause(this,"[".concat(c.join("+"),"]"));var h=a(c);if(h.length===1)return this.where(h[0]).equals(c[h[0]]);var f=this.schema.indexes.concat(this.schema.primKey).filter(function(S){if(S.compound&&h.every(function(C){return 0<=S.keyPath.indexOf(C)})){for(var N=0;N<h.length;++N)if(h.indexOf(S.keyPath[N])===-1)return!1;return!0}return!1}).sort(function(S,N){return S.keyPath.length-N.keyPath.length})[0];if(f&&this.db._maxKey!==ft){var v=f.keyPath.slice(0,h.length);return this.where(v).equals(v.map(function(N){return c[N]}))}!f&&Ge&&console.warn("The query ".concat(JSON.stringify(c)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(h.join("+"),"]"));var g=this.schema.idxByName;function m(S,N){return Te(S,N)===0}var E=h.reduce(function(R,N){var C=R[0],D=R[1],R=g[N],U=c[N];return[C||R,C||!R?pt(D,R&&R.multi?function($){return $=ie($,N),l($)&&$.some(function(P){return m(U,P)})}:function($){return m(U,ie($,N))}):D]},[null,null]),v=E[0],E=E[1];return v?this.where(v.name).equals(c[v.keyPath]).filter(E):f?this.filter(E):this.where(h).equals("")},Ne.prototype.filter=function(c){return this.toCollection().and(c)},Ne.prototype.count=function(c){return this.toCollection().count(c)},Ne.prototype.offset=function(c){return this.toCollection().offset(c)},Ne.prototype.limit=function(c){return this.toCollection().limit(c)},Ne.prototype.each=function(c){return this.toCollection().each(c)},Ne.prototype.toArray=function(c){return this.toCollection().toArray(c)},Ne.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Ne.prototype.orderBy=function(c){return new this.db.Collection(new this.db.WhereClause(this,l(c)?"[".concat(c.join("+"),"]"):c))},Ne.prototype.reverse=function(){return this.toCollection().reverse()},Ne.prototype.mapToClass=function(c){var h,f=this.db,g=this.name;function m(){return h!==null&&h.apply(this,arguments)||this}(this.schema.mappedClass=c).prototype instanceof ur&&(function(N,C){if(typeof C!="function"&&C!==null)throw new TypeError("Class extends value "+String(C)+" is not a constructor or null");function D(){this.constructor=N}n(N,C),N.prototype=C===null?Object.create(C):(D.prototype=C.prototype,new D)}(m,h=c),Object.defineProperty(m.prototype,"db",{get:function(){return f},enumerable:!1,configurable:!0}),m.prototype.table=function(){return g},c=m);for(var v=new Set,E=c.prototype;E;E=p(E))Object.getOwnPropertyNames(E).forEach(function(N){return v.add(N)});function S(N){if(!N)return N;var C,D=Object.create(c.prototype);for(C in N)if(!v.has(C))try{D[C]=N[C]}catch{}return D}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=S,this.hook("reading",S),c},Ne.prototype.defineClass=function(){return this.mapToClass(function(c){u(this,c)})},Ne.prototype.add=function(c,h){var f=this,g=this.schema.primKey,m=g.auto,v=g.keyPath,E=c;return v&&m&&(E=Zt(v)(c)),this._trans("readwrite",function(S){return f.core.mutate({trans:S,type:"add",keys:h!=null?[h]:null,values:[E]})}).then(function(S){return S.numFailures?fe.reject(S.failures[0]):S.lastResult}).then(function(S){if(v)try{te(c,v,S)}catch{}return S})},Ne.prototype.upsert=function(c,h){var f=this,g=this.schema.primKey.keyPath;return this._trans("readwrite",function(m){return f.core.get({trans:m,key:c}).then(function(v){var E=v??{};return pr(E,h),g&&te(E,g,c),f.core.mutate({trans:m,type:"put",values:[E],keys:[c],upsert:!0,updates:{keys:[c],changeSpecs:[h]}}).then(function(S){return S.numFailures?fe.reject(S.failures[0]):!!v})})})},Ne.prototype.update=function(c,h){return typeof c!="object"||l(c)?this.where(":id").equals(c).modify(h):(c=ie(c,this.schema.primKey.keyPath),c===void 0?Pe(new pe.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(c).modify(h))},Ne.prototype.put=function(c,h){var f=this,g=this.schema.primKey,m=g.auto,v=g.keyPath,E=c;return v&&m&&(E=Zt(v)(c)),this._trans("readwrite",function(S){return f.core.mutate({trans:S,type:"put",values:[E],keys:h!=null?[h]:null})}).then(function(S){return S.numFailures?fe.reject(S.failures[0]):S.lastResult}).then(function(S){if(v)try{te(c,v,S)}catch{}return S})},Ne.prototype.delete=function(c){var h=this;return this._trans("readwrite",function(f){return h.core.mutate({trans:f,type:"delete",keys:[c]}).then(function(g){return Xt(h,[c],g)}).then(function(g){return g.numFailures?fe.reject(g.failures[0]):void 0})})},Ne.prototype.clear=function(){var c=this;return this._trans("readwrite",function(h){return c.core.mutate({trans:h,type:"deleteRange",range:lr}).then(function(f){return Xt(c,null,f)})}).then(function(h){return h.numFailures?fe.reject(h.failures[0]):void 0})},Ne.prototype.bulkGet=function(c){var h=this;return this._trans("readonly",function(f){return h.core.getMany({keys:c,trans:f}).then(function(g){return g.map(function(m){return h.hook.reading.fire(m)})})})},Ne.prototype.bulkAdd=function(c,h,f){var g=this,m=Array.isArray(h)?h:void 0,v=(f=f||(m?void 0:h))?f.allKeys:void 0;return this._trans("readwrite",function(E){var C=g.schema.primKey,S=C.auto,C=C.keyPath;if(C&&m)throw new pe.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(m&&m.length!==c.length)throw new pe.InvalidArgument("Arguments objects and keys must have the same length");var N=c.length,C=C&&S?c.map(Zt(C)):c;return g.core.mutate({trans:E,type:"add",keys:m,values:C,wantResults:v}).then(function(P){var R=P.numFailures,U=P.results,$=P.lastResult,P=P.failures;if(R===0)return v?U:$;throw new Re("".concat(g.name,".bulkAdd(): ").concat(R," of ").concat(N," operations failed"),P)})})},Ne.prototype.bulkPut=function(c,h,f){var g=this,m=Array.isArray(h)?h:void 0,v=(f=f||(m?void 0:h))?f.allKeys:void 0;return this._trans("readwrite",function(E){var C=g.schema.primKey,S=C.auto,C=C.keyPath;if(C&&m)throw new pe.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(m&&m.length!==c.length)throw new pe.InvalidArgument("Arguments objects and keys must have the same length");var N=c.length,C=C&&S?c.map(Zt(C)):c;return g.core.mutate({trans:E,type:"put",keys:m,values:C,wantResults:v}).then(function(P){var R=P.numFailures,U=P.results,$=P.lastResult,P=P.failures;if(R===0)return v?U:$;throw new Re("".concat(g.name,".bulkPut(): ").concat(R," of ").concat(N," operations failed"),P)})})},Ne.prototype.bulkUpdate=function(c){var h=this,f=this.core,g=c.map(function(E){return E.key}),m=c.map(function(E){return E.changes}),v=[];return this._trans("readwrite",function(E){return f.getMany({trans:E,keys:g,cache:"clone"}).then(function(S){var N=[],C=[];c.forEach(function(R,U){var $=R.key,P=R.changes,I=S[U];if(I){for(var K=0,L=Object.keys(P);K<L.length;K++){var M=L[K],q=P[M];if(M===h.schema.primKey.keyPath){if(Te(q,$)!==0)throw new pe.Constraint("Cannot update primary key in bulkUpdate()")}else te(I,M,q)}v.push(U),N.push($),C.push(I)}});var D=N.length;return f.mutate({trans:E,type:"put",keys:N,values:C,updates:{keys:g,changeSpecs:m}}).then(function(R){var U=R.numFailures,$=R.failures;if(U===0)return D;for(var P=0,I=Object.keys($);P<I.length;P++){var K,L=I[P],M=v[Number(L)];M!=null&&(K=$[L],delete $[L],$[M]=K)}throw new Re("".concat(h.name,".bulkUpdate(): ").concat(U," of ").concat(D," operations failed"),$)})})})},Ne.prototype.bulkDelete=function(c){var h=this,f=c.length;return this._trans("readwrite",function(g){return h.core.mutate({trans:g,type:"delete",keys:c}).then(function(m){return Xt(h,c,m)})}).then(function(E){var m=E.numFailures,v=E.lastResult,E=E.failures;if(m===0)return v;throw new Re("".concat(h.name,".bulkDelete(): ").concat(m," of ").concat(f," operations failed"),E)})},Ne);function Ne(){}function Dt(c){function h(E,S){if(S){for(var N=arguments.length,C=new Array(N-1);--N;)C[N-1]=arguments[N];return f[E].subscribe.apply(null,C),c}if(typeof E=="string")return f[E]}var f={};h.addEventType=v;for(var g=1,m=arguments.length;g<m;++g)v(arguments[g]);return h;function v(E,S,N){if(typeof E!="object"){var C;S=S||xi;var D={subscribers:[],fire:N=N||xe,subscribe:function(R){D.subscribers.indexOf(R)===-1&&(D.subscribers.push(R),D.fire=S(D.fire,R))},unsubscribe:function(R){D.subscribers=D.subscribers.filter(function(U){return U!==R}),D.fire=D.subscribers.reduce(S,N)}};return f[E]=h[E]=D}a(C=E).forEach(function(R){var U=C[R];if(l(U))v(R,C[R][0],C[R][1]);else{if(U!=="asap")throw new pe.InvalidArgument("Invalid event config");var $=v(R,je,function(){for(var P=arguments.length,I=new Array(P);P--;)I[P]=arguments[P];$.subscribers.forEach(function(K){ye(function(){K.apply(null,I)})})})}})}}function Kt(c,h){return T(h).from({prototype:c}),h}function xt(c,h){return!(c.filter||c.algorithm||c.or)&&(h?c.justLimit:!c.replayFilter)}function Nn(c,h){c.filter=pt(c.filter,h)}function Cn(c,h,f){var g=c.replayFilter;c.replayFilter=g?function(){return pt(g(),h())}:h,c.justLimit=f&&!g}function Qt(c,h){if(c.isPrimKey)return h.primaryKey;var f=h.getIndexByKeyPath(c.index);if(!f)throw new pe.Schema("KeyPath "+c.index+" on object store "+h.name+" is not indexed");return f}function gr(c,h,f){var g=Qt(c,h.schema);return h.openCursor({trans:f,values:!c.keysOnly,reverse:c.dir==="prev",unique:!!c.unique,query:{index:g,range:c.range}})}function en(c,h,f,g){var m=c.replayFilter?pt(c.filter,c.replayFilter()):c.filter;if(c.or){var v={},E=function(S,N,C){var D,R;m&&!m(N,C,function(U){return N.stop(U)},function(U){return N.fail(U)})||((R=""+(D=N.primaryKey))=="[object ArrayBuffer]"&&(R=""+new Uint8Array(D)),b(v,R)||(v[R]=!0,h(S,N,C)))};return Promise.all([c.or._iterate(E,f),mr(gr(c,g,f),c.algorithm,E,!c.keysOnly&&c.valueMapper)])}return mr(gr(c,g,f),pt(c.algorithm,m),h,!c.keysOnly&&c.valueMapper)}function mr(c,h,f,g){var m=$e(g?function(v,E,S){return f(g(v),E,S)}:f);return c.then(function(v){if(v)return v.start(function(){var E=function(){return v.continue()};h&&!h(v,function(S){return E=S},function(S){v.stop(S),E=xe},function(S){v.fail(S),E=xe})||m(v.value,v,function(S){return E=S}),E()})})}var $i=(Ae.prototype._read=function(c,h){var f=this._ctx;return f.error?f.table._trans(null,Pe.bind(null,f.error)):f.table._trans("readonly",c).then(h)},Ae.prototype._write=function(c){var h=this._ctx;return h.error?h.table._trans(null,Pe.bind(null,h.error)):h.table._trans("readwrite",c,"locked")},Ae.prototype._addAlgorithm=function(c){var h=this._ctx;h.algorithm=pt(h.algorithm,c)},Ae.prototype._iterate=function(c,h){return en(this._ctx,c,h,this._ctx.table.core)},Ae.prototype.clone=function(c){var h=Object.create(this.constructor.prototype),f=Object.create(this._ctx);return c&&u(f,c),h._ctx=f,h},Ae.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ae.prototype.each=function(c){var h=this._ctx;return this._read(function(f){return en(h,c,f,h.table.core)})},Ae.prototype.count=function(c){var h=this;return this._read(function(f){var g=h._ctx,m=g.table.core;if(xt(g,!0))return m.count({trans:f,query:{index:Qt(g,m.schema),range:g.range}}).then(function(E){return Math.min(E,g.limit)});var v=0;return en(g,function(){return++v,!1},f,m).then(function(){return v})}).then(c)},Ae.prototype.sortBy=function(c,h){var f=c.split(".").reverse(),g=f[0],m=f.length-1;function v(N,C){return C?v(N[f[C]],C-1):N[g]}var E=this._ctx.dir==="next"?1:-1;function S(N,C){return Te(v(N,m),v(C,m))*E}return this.toArray(function(N){return N.sort(S)}).then(h)},Ae.prototype.toArray=function(c){var h=this;return this._read(function(f){var g=h._ctx;if(g.dir==="next"&&xt(g,!0)&&0<g.limit){var m=g.valueMapper,v=Qt(g,g.table.core.schema);return g.table.core.query({trans:f,limit:g.limit,values:!0,query:{index:v,range:g.range}}).then(function(S){return S=S.result,m?S.map(m):S})}var E=[];return en(g,function(S){return E.push(S)},f,g.table.core).then(function(){return E})},c)},Ae.prototype.offset=function(c){var h=this._ctx;return c<=0||(h.offset+=c,xt(h)?Cn(h,function(){var f=c;return function(g,m){return f===0||(f===1?--f:m(function(){g.advance(f),f=0}),!1)}}):Cn(h,function(){var f=c;return function(){return--f<0}})),this},Ae.prototype.limit=function(c){return this._ctx.limit=Math.min(this._ctx.limit,c),Cn(this._ctx,function(){var h=c;return function(f,g,m){return--h<=0&&g(m),0<=h}},!0),this},Ae.prototype.until=function(c,h){return Nn(this._ctx,function(f,g,m){return!c(f.value)||(g(m),h)}),this},Ae.prototype.first=function(c){return this.limit(1).toArray(function(h){return h[0]}).then(c)},Ae.prototype.last=function(c){return this.reverse().first(c)},Ae.prototype.filter=function(c){var h;return Nn(this._ctx,function(f){return c(f.value)}),(h=this._ctx).isMatch=pt(h.isMatch,c),this},Ae.prototype.and=function(c){return this.filter(c)},Ae.prototype.or=function(c){return new this.db.WhereClause(this._ctx.table,c,this)},Ae.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ae.prototype.desc=function(){return this.reverse()},Ae.prototype.eachKey=function(c){var h=this._ctx;return h.keysOnly=!h.isMatch,this.each(function(f,g){c(g.key,g)})},Ae.prototype.eachUniqueKey=function(c){return this._ctx.unique="unique",this.eachKey(c)},Ae.prototype.eachPrimaryKey=function(c){var h=this._ctx;return h.keysOnly=!h.isMatch,this.each(function(f,g){c(g.primaryKey,g)})},Ae.prototype.keys=function(c){var h=this._ctx;h.keysOnly=!h.isMatch;var f=[];return this.each(function(g,m){f.push(m.key)}).then(function(){return f}).then(c)},Ae.prototype.primaryKeys=function(c){var h=this._ctx;if(h.dir==="next"&&xt(h,!0)&&0<h.limit)return this._read(function(g){var m=Qt(h,h.table.core.schema);return h.table.core.query({trans:g,values:!1,limit:h.limit,query:{index:m,range:h.range}})}).then(function(g){return g.result}).then(c);h.keysOnly=!h.isMatch;var f=[];return this.each(function(g,m){f.push(m.primaryKey)}).then(function(){return f}).then(c)},Ae.prototype.uniqueKeys=function(c){return this._ctx.unique="unique",this.keys(c)},Ae.prototype.firstKey=function(c){return this.limit(1).keys(function(h){return h[0]}).then(c)},Ae.prototype.lastKey=function(c){return this.reverse().firstKey(c)},Ae.prototype.distinct=function(){var c=this._ctx,c=c.index&&c.table.schema.idxByName[c.index];if(!c||!c.multi)return this;var h={};return Nn(this._ctx,function(m){var g=m.primaryKey.toString(),m=b(h,g);return h[g]=!0,!m}),this},Ae.prototype.modify=function(c){var h=this,f=this._ctx;return this._write(function(g){var m=typeof c=="function"?c:function(I){return pr(I,c)},v=f.table.core,C=v.schema.primaryKey,E=C.outbound,S=C.extractKey,N=200,C=h.db._options.modifyChunkSize;C&&(N=typeof C=="object"?C[v.name]||C["*"]||200:C);function D(I,M){var L=M.failures,M=M.numFailures;U+=I-M;for(var q=0,Y=a(L);q<Y.length;q++){var se=Y[q];R.push(L[se])}}var R=[],U=0,$=[],P=c===br;return h.clone().primaryKeys().then(function(I){function K(M){var q=Math.min(N,I.length-M),Y=I.slice(M,M+q);return(P?Promise.resolve([]):v.getMany({trans:g,keys:Y,cache:"immutable"})).then(function(se){var ue=[],re=[],ce=E?[]:null,he=P?Y:[];if(!P)for(var le=0;le<q;++le){var ge=se[le],Ee={value:j(ge),primKey:I[M+le]};m.call(Ee,Ee.value,Ee)!==!1&&(Ee.value==null?he.push(I[M+le]):E||Te(S(ge),S(Ee.value))===0?(re.push(Ee.value),E&&ce.push(I[M+le])):(he.push(I[M+le]),ue.push(Ee.value)))}return Promise.resolve(0<ue.length&&v.mutate({trans:g,type:"add",values:ue}).then(function(ke){for(var Se in ke.failures)he.splice(parseInt(Se),1);D(ue.length,ke)})).then(function(){return(0<re.length||L&&typeof c=="object")&&v.mutate({trans:g,type:"put",keys:ce,values:re,criteria:L,changeSpec:typeof c!="function"&&c,isAdditionalChunk:0<M}).then(function(ke){return D(re.length,ke)})}).then(function(){return(0<he.length||L&&P)&&v.mutate({trans:g,type:"delete",keys:he,criteria:L,isAdditionalChunk:0<M}).then(function(ke){return Xt(f.table,he,ke)}).then(function(ke){return D(he.length,ke)})}).then(function(){return I.length>M+q&&K(M+N)})})}var L=xt(f)&&f.limit===1/0&&(typeof c!="function"||P)&&{index:f.index,range:f.range};return K(0).then(function(){if(0<R.length)throw new Ce("Error modifying one or more objects",R,U,$);return I.length})})})},Ae.prototype.delete=function(){var c=this._ctx,h=c.range;return!xt(c)||c.table.schema.yProps||!c.isPrimKey&&h.type!==3?this.modify(br):this._write(function(f){var g=c.table.core.schema.primaryKey,m=h;return c.table.core.count({trans:f,query:{index:g,range:m}}).then(function(v){return c.table.core.mutate({trans:f,type:"deleteRange",range:m}).then(function(N){var S=N.failures,N=N.numFailures;if(N)throw new Ce("Could not delete some values",Object.keys(S).map(function(C){return S[C]}),v-N);return v-N})})})},Ae);function Ae(){}var br=function(c,h){return h.value=null};function Pi(c,h){return c<h?-1:c===h?0:1}function Ii(c,h){return h<c?-1:c===h?0:1}function He(c,h,f){return c=c instanceof wr?new c.Collection(c):c,c._ctx.error=new(f||TypeError)(h),c}function Tt(c){return new c.Collection(c,function(){return vr("")}).limit(0)}function tn(c,h,f,g){var m,v,E,S,N,C,D,R=f.length;if(!f.every(function(P){return typeof P=="string"}))return He(c,cr);function U(P){m=P==="next"?function(K){return K.toUpperCase()}:function(K){return K.toLowerCase()},v=P==="next"?function(K){return K.toLowerCase()}:function(K){return K.toUpperCase()},E=P==="next"?Pi:Ii;var I=f.map(function(K){return{lower:v(K),upper:m(K)}}).sort(function(K,L){return E(K.lower,L.lower)});S=I.map(function(K){return K.upper}),N=I.map(function(K){return K.lower}),D=(C=P)==="next"?"":g}U("next"),c=new c.Collection(c,function(){return it(S[0],N[R-1]+g)}),c._ondirectionchange=function(P){U(P)};var $=0;return c._addAlgorithm(function(P,I,K){var L=P.key;if(typeof L!="string")return!1;var M=v(L);if(h(M,N,$))return!0;for(var q=null,Y=$;Y<R;++Y){var se=function(ue,re,ce,he,le,ge){for(var Ee=Math.min(ue.length,he.length),ke=-1,Se=0;Se<Ee;++Se){var Ve=re[Se];if(Ve!==he[Se])return le(ue[Se],ce[Se])<0?ue.substr(0,Se)+ce[Se]+ce.substr(Se+1):le(ue[Se],he[Se])<0?ue.substr(0,Se)+he[Se]+ce.substr(Se+1):0<=ke?ue.substr(0,ke)+re[ke]+ce.substr(ke+1):null;le(ue[Se],Ve)<0&&(ke=Se)}return Ee<he.length&&ge==="next"?ue+ce.substr(ue.length):Ee<ue.length&&ge==="prev"?ue.substr(0,ce.length):ke<0?null:ue.substr(0,ke)+he[ke]+ce.substr(ke+1)}(L,M,S[Y],N[Y],E,C);se===null&&q===null?$=Y+1:(q===null||0<E(q,se))&&(q=se)}return I(q!==null?function(){P.continue(q+D)}:K),!1}),c}function it(c,h,f,g){return{type:2,lower:c,upper:h,lowerOpen:f,upperOpen:g}}function vr(c){return{type:1,lower:c,upper:c}}var wr=(Object.defineProperty(Fe.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Fe.prototype.between=function(c,h,f,g){f=f!==!1,g=g===!0;try{return 0<this._cmp(c,h)||this._cmp(c,h)===0&&(f||g)&&(!f||!g)?Tt(this):new this.Collection(this,function(){return it(c,h,!f,!g)})}catch{return He(this,Ze)}},Fe.prototype.equals=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return vr(c)})},Fe.prototype.above=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(c,void 0,!0)})},Fe.prototype.aboveOrEqual=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(c,void 0,!1)})},Fe.prototype.below=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(void 0,c,!1,!0)})},Fe.prototype.belowOrEqual=function(c){return c==null?He(this,Ze):new this.Collection(this,function(){return it(void 0,c)})},Fe.prototype.startsWith=function(c){return typeof c!="string"?He(this,cr):this.between(c,c+ft,!0,!0)},Fe.prototype.startsWithIgnoreCase=function(c){return c===""?this.startsWith(c):tn(this,function(h,f){return h.indexOf(f[0])===0},[c],ft)},Fe.prototype.equalsIgnoreCase=function(c){return tn(this,function(h,f){return h===f[0]},[c],"")},Fe.prototype.anyOfIgnoreCase=function(){var c=J.apply(A,arguments);return c.length===0?Tt(this):tn(this,function(h,f){return f.indexOf(h)!==-1},c,"")},Fe.prototype.startsWithAnyOfIgnoreCase=function(){var c=J.apply(A,arguments);return c.length===0?Tt(this):tn(this,function(h,f){return f.some(function(g){return h.indexOf(g)===0})},c,ft)},Fe.prototype.anyOf=function(){var c=this,h=J.apply(A,arguments),f=this._cmp;try{h.sort(f)}catch{return He(this,Ze)}if(h.length===0)return Tt(this);var g=new this.Collection(this,function(){return it(h[0],h[h.length-1])});g._ondirectionchange=function(v){f=v==="next"?c._ascending:c._descending,h.sort(f)};var m=0;return g._addAlgorithm(function(v,E,S){for(var N=v.key;0<f(N,h[m]);)if(++m===h.length)return E(S),!1;return f(N,h[m])===0||(E(function(){v.continue(h[m])}),!1)}),g},Fe.prototype.notEqual=function(c){return this.inAnyRange([[-1/0,c],[c,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Fe.prototype.noneOf=function(){var c=J.apply(A,arguments);if(c.length===0)return new this.Collection(this);try{c.sort(this._ascending)}catch{return He(this,Ze)}var h=c.reduce(function(f,g){return f?f.concat([[f[f.length-1][1],g]]):[[-1/0,g]]},null);return h.push([c[c.length-1],this.db._maxKey]),this.inAnyRange(h,{includeLowers:!1,includeUppers:!1})},Fe.prototype.inAnyRange=function(L,h){var f=this,g=this._cmp,m=this._ascending,v=this._descending,E=this._min,S=this._max;if(L.length===0)return Tt(this);if(!L.every(function(M){return M[0]!==void 0&&M[1]!==void 0&&m(M[0],M[1])<=0}))return He(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",pe.InvalidArgument);var N=!h||h.includeLowers!==!1,C=h&&h.includeUppers===!0,D,R=m;function U(M,q){return R(M[0],q[0])}try{(D=L.reduce(function(M,q){for(var Y=0,se=M.length;Y<se;++Y){var ue=M[Y];if(g(q[0],ue[1])<0&&0<g(q[1],ue[0])){ue[0]=E(ue[0],q[0]),ue[1]=S(ue[1],q[1]);break}}return Y===se&&M.push(q),M},[])).sort(U)}catch{return He(this,Ze)}var $=0,P=C?function(M){return 0<m(M,D[$][1])}:function(M){return 0<=m(M,D[$][1])},I=N?function(M){return 0<v(M,D[$][0])}:function(M){return 0<=v(M,D[$][0])},K=P,L=new this.Collection(this,function(){return it(D[0][0],D[D.length-1][1],!N,!C)});return L._ondirectionchange=function(M){R=M==="next"?(K=P,m):(K=I,v),D.sort(U)},L._addAlgorithm(function(M,q,Y){for(var se,ue=M.key;K(ue);)if(++$===D.length)return q(Y),!1;return!P(se=ue)&&!I(se)||(f._cmp(ue,D[$][1])===0||f._cmp(ue,D[$][0])===0||q(function(){R===m?M.continue(D[$][0]):M.continue(D[$][1])}),!1)}),L},Fe.prototype.startsWithAnyOf=function(){var c=J.apply(A,arguments);return c.every(function(h){return typeof h=="string"})?c.length===0?Tt(this):this.inAnyRange(c.map(function(h){return[h,h+ft]})):He(this,"startsWithAnyOf() only works with strings")},Fe);function Fe(){}function Je(c){return $e(function(h){return Ut(h),c(h.target.error),!1})}function Ut(c){c.stopPropagation&&c.stopPropagation(),c.preventDefault&&c.preventDefault()}var Ft="storagemutated",$n="x-storagemutated-1",st=Dt(null,Ft),Di=(Ye.prototype._lock=function(){return Q(!be.global),++this._reculock,this._reculock!==1||be.global||(be.lockOwnerFor=this),this},Ye.prototype._unlock=function(){if(Q(!be.global),--this._reculock==0)for(be.global||(be.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var c=this._blockedFuncs.shift();try{dt(c[1],c[0])}catch{}}return this},Ye.prototype._locked=function(){return this._reculock&&be.lockOwnerFor!==this},Ye.prototype.create=function(c){var h=this;if(!this.mode)return this;var f=this.db.idbdb,g=this.db._state.dbOpenError;if(Q(!this.idbtrans),!c&&!f)switch(g&&g.name){case"DatabaseClosedError":throw new pe.DatabaseClosed(g);case"MissingAPIError":throw new pe.MissingAPI(g.message,g);default:throw new pe.OpenFailed(g)}if(!this.active)throw new pe.TransactionInactive;return Q(this._completion._state===null),(c=this.idbtrans=c||(this.db.core||f).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=$e(function(m){Ut(m),h._reject(c.error)}),c.onabort=$e(function(m){Ut(m),h.active&&h._reject(new pe.Abort(c.error)),h.active=!1,h.on("abort").fire(m)}),c.oncomplete=$e(function(){h.active=!1,h._resolve(),"mutatedParts"in c&&st.storagemutated.fire(c.mutatedParts)}),this},Ye.prototype._promise=function(c,h,f){var g=this;if(c==="readwrite"&&this.mode!=="readwrite")return Pe(new pe.ReadOnly("Transaction is readonly"));if(!this.active)return Pe(new pe.TransactionInactive);if(this._locked())return new fe(function(v,E){g._blockedFuncs.push([function(){g._promise(c,h,f).then(v,E)},be])});if(f)return tt(function(){var v=new fe(function(E,S){g._lock();var N=h(E,S,g);N&&N.then&&N.then(E,S)});return v.finally(function(){return g._unlock()}),v._lib=!0,v});var m=new fe(function(v,E){var S=h(v,E,g);S&&S.then&&S.then(v,E)});return m._lib=!0,m},Ye.prototype._root=function(){return this.parent?this.parent._root():this},Ye.prototype.waitFor=function(c){var h,f=this._root(),g=fe.resolve(c);f._waitingFor?f._waitingFor=f._waitingFor.then(function(){return g}):(f._waitingFor=g,f._waitingQueue=[],h=f.idbtrans.objectStore(f.storeNames[0]),function v(){for(++f._spinCount;f._waitingQueue.length;)f._waitingQueue.shift()();f._waitingFor&&(h.get(-1/0).onsuccess=v)}());var m=f._waitingFor;return new fe(function(v,E){g.then(function(S){return f._waitingQueue.push($e(v.bind(null,S)))},function(S){return f._waitingQueue.push($e(E.bind(null,S)))}).finally(function(){f._waitingFor===m&&(f._waitingFor=null)})})},Ye.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new pe.Abort))},Ye.prototype.table=function(c){var h=this._memoizedTables||(this._memoizedTables={});if(b(h,c))return h[c];var f=this.schema[c];if(!f)throw new pe.NotFound("Table "+c+" not part of transaction");return f=new this.db.Table(c,f,this),f.core=this.db.core.table(c),h[c]=f},Ye);function Ye(){}function Pn(c,h,f,g,m,v,E,S){return{name:c,keyPath:h,unique:f,multi:g,auto:m,compound:v,src:(f&&!E?"&":"")+(g?"*":"")+(m?"++":"")+_r(h),type:S}}function _r(c){return typeof c=="string"?c:c?"["+[].join.call(c,"+")+"]":""}function In(c,h,f){return{name:c,primKey:h,indexes:f,mappedClass:null,idxByName:(g=function(m){return[m.name,m]},f.reduce(function(m,v,E){return E=g(v,E),E&&(m[E[0]]=E[1]),m},{}))};var g}var Ot=function(c){try{return c.only([[]]),Ot=function(){return[[]]},[[]]}catch{return Ot=function(){return ft},ft}};function Dn(c){return c==null?function(){}:typeof c=="string"?(h=c).split(".").length===1?function(f){return f[h]}:function(f){return ie(f,h)}:function(f){return ie(f,c)};var h}function Er(c){return[].slice.call(c)}var Ki=0;function Bt(c){return c==null?":id":typeof c=="string"?c:"[".concat(c.join("+"),"]")}function Ui(c,h,N){function g(K){if(K.type===3)return null;if(K.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var $=K.lower,P=K.upper,I=K.lowerOpen,K=K.upperOpen;return $===void 0?P===void 0?null:h.upperBound(P,!!K):P===void 0?h.lowerBound($,!!I):h.bound($,P,!!I,!!K)}function m(U){var $,P=U.name;return{name:P,schema:U,mutate:function(I){var K=I.trans,L=I.type,M=I.keys,q=I.values,Y=I.range;return new Promise(function(se,ue){se=$e(se);var re=K.objectStore(P),ce=re.keyPath==null,he=L==="put"||L==="add";if(!he&&L!=="delete"&&L!=="deleteRange")throw new Error("Invalid operation type: "+L);var le,ge=(M||q||{length:1}).length;if(M&&q&&M.length!==q.length)throw new Error("Given keys array must have same length as given values array.");if(ge===0)return se({numFailures:0,failures:{},results:[],lastResult:void 0});function Ee(Me){++Ve,Ut(Me)}var ke=[],Se=[],Ve=0;if(L==="deleteRange"){if(Y.type===4)return se({numFailures:Ve,failures:Se,results:[],lastResult:void 0});Y.type===3?ke.push(le=re.clear()):ke.push(le=re.delete(g(Y)))}else{var ce=he?ce?[q,M]:[q,null]:[M,null],_e=ce[0],Be=ce[1];if(he)for(var Le=0;Le<ge;++Le)ke.push(le=Be&&Be[Le]!==void 0?re[L](_e[Le],Be[Le]):re[L](_e[Le])),le.onerror=Ee;else for(Le=0;Le<ge;++Le)ke.push(le=re[L](_e[Le])),le.onerror=Ee}function pn(Me){Me=Me.target.result,ke.forEach(function(mt,Xn){return mt.error!=null&&(Se[Xn]=mt.error)}),se({numFailures:Ve,failures:Se,results:L==="delete"?M:ke.map(function(mt){return mt.result}),lastResult:Me})}le.onerror=function(Me){Ee(Me),pn(Me)},le.onsuccess=pn})},getMany:function(I){var K=I.trans,L=I.keys;return new Promise(function(M,q){M=$e(M);for(var Y,se=K.objectStore(P),ue=L.length,re=new Array(ue),ce=0,he=0,le=function(ke){ke=ke.target,re[ke._pos]=ke.result,++he===ce&&M(re)},ge=Je(q),Ee=0;Ee<ue;++Ee)L[Ee]!=null&&((Y=se.get(L[Ee]))._pos=Ee,Y.onsuccess=le,Y.onerror=ge,++ce);ce===0&&M(re)})},get:function(I){var K=I.trans,L=I.key;return new Promise(function(M,q){M=$e(M);var Y=K.objectStore(P).get(L);Y.onsuccess=function(se){return M(se.target.result)},Y.onerror=Je(q)})},query:($=C,function(I){return new Promise(function(K,L){K=$e(K);var M,q,Y,ce=I.trans,se=I.values,ue=I.limit,le=I.query,re=ue===1/0?void 0:ue,he=le.index,le=le.range,ce=ce.objectStore(P),he=he.isPrimaryKey?ce:ce.index(he.name),le=g(le);if(ue===0)return K({result:[]});$?((re=se?he.getAll(le,re):he.getAllKeys(le,re)).onsuccess=function(ge){return K({result:ge.target.result})},re.onerror=Je(L)):(M=0,q=!se&&"openKeyCursor"in he?he.openKeyCursor(le):he.openCursor(le),Y=[],q.onsuccess=function(ge){var Ee=q.result;return Ee?(Y.push(se?Ee.value:Ee.primaryKey),++M===ue?K({result:Y}):void Ee.continue()):K({result:Y})},q.onerror=Je(L))})}),openCursor:function(I){var K=I.trans,L=I.values,M=I.query,q=I.reverse,Y=I.unique;return new Promise(function(se,ue){se=$e(se);var he=M.index,re=M.range,ce=K.objectStore(P),ce=he.isPrimaryKey?ce:ce.index(he.name),he=q?Y?"prevunique":"prev":Y?"nextunique":"next",le=!L&&"openKeyCursor"in ce?ce.openKeyCursor(g(re),he):ce.openCursor(g(re),he);le.onerror=Je(ue),le.onsuccess=$e(function(ge){var Ee,ke,Se,Ve,_e=le.result;_e?(_e.___id=++Ki,_e.done=!1,Ee=_e.continue.bind(_e),ke=(ke=_e.continuePrimaryKey)&&ke.bind(_e),Se=_e.advance.bind(_e),Ve=function(){throw new Error("Cursor not stopped")},_e.trans=K,_e.stop=_e.continue=_e.continuePrimaryKey=_e.advance=function(){throw new Error("Cursor not started")},_e.fail=$e(ue),_e.next=function(){var Be=this,Le=1;return this.start(function(){return Le--?Be.continue():Be.stop()}).then(function(){return Be})},_e.start=function(Be){function Le(){if(le.result)try{Be()}catch(Me){_e.fail(Me)}else _e.done=!0,_e.start=function(){throw new Error("Cursor behind last entry")},_e.stop()}var pn=new Promise(function(Me,mt){Me=$e(Me),le.onerror=Je(mt),_e.fail=mt,_e.stop=function(Xn){_e.stop=_e.continue=_e.continuePrimaryKey=_e.advance=Ve,Me(Xn)}});return le.onsuccess=$e(function(Me){le.onsuccess=Le,Le()}),_e.continue=Ee,_e.continuePrimaryKey=ke,_e.advance=Se,Le(),pn},se(_e)):se(null)},ue)})},count:function(I){var K=I.query,L=I.trans,M=K.index,q=K.range;return new Promise(function(Y,se){var ue=L.objectStore(P),re=M.isPrimaryKey?ue:ue.index(M.name),ue=g(q),re=ue?re.count(ue):re.count();re.onsuccess=$e(function(ce){return Y(ce.target.result)}),re.onerror=Je(se)})}}}var v,E,S,D=(E=N,S=Er((v=c).objectStoreNames),{schema:{name:v.name,tables:S.map(function(U){return E.objectStore(U)}).map(function(U){var $=U.keyPath,K=U.autoIncrement,P=l($),I={},K={name:U.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:$==null,compound:P,keyPath:$,autoIncrement:K,unique:!0,extractKey:Dn($)},indexes:Er(U.indexNames).map(function(L){return U.index(L)}).map(function(Y){var M=Y.name,q=Y.unique,se=Y.multiEntry,Y=Y.keyPath,se={name:M,compound:l(Y),keyPath:Y,unique:q,multiEntry:se,extractKey:Dn(Y)};return I[Bt(Y)]=se}),getIndexByKeyPath:function(L){return I[Bt(L)]}};return I[":id"]=K.primaryKey,$!=null&&(I[Bt($)]=K.primaryKey),K})},hasGetAll:0<S.length&&"getAll"in E.objectStore(S[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),N=D.schema,C=D.hasGetAll,D=N.tables.map(m),R={};return D.forEach(function(U){return R[U.name]=U}),{stack:"dbcore",transaction:c.transaction.bind(c),table:function(U){if(!R[U])throw new Error("Table '".concat(U,"' not found"));return R[U]},MIN_KEY:-1/0,MAX_KEY:Ot(h),schema:N}}function Fi(c,h,f,g){var m=f.IDBKeyRange;return f.indexedDB,{dbcore:(g=Ui(h,m,g),c.dbcore.reduce(function(v,E){return E=E.create,r(r({},v),E(v))},g))}}function nn(c,g){var f=g.db,g=Fi(c._middlewares,f,c._deps,g);c.core=g.dbcore,c.tables.forEach(function(m){var v=m.name;c.core.schema.tables.some(function(E){return E.name===v})&&(m.core=c.core.table(v),c[v]instanceof c.Table&&(c[v].core=m.core))})}function rn(c,h,f,g){f.forEach(function(m){var v=g[m];h.forEach(function(E){var S=function N(C,D){return k(C,D)||(C=p(C))&&N(C,D)}(E,m);(!S||"value"in S&&S.value===void 0)&&(E===c.Transaction.prototype||E instanceof c.Transaction?x(E,m,{get:function(){return this.table(m)},set:function(N){_(this,m,{value:N,writable:!0,configurable:!0,enumerable:!0})}}):E[m]=new c.Table(m,v))})})}function Kn(c,h){h.forEach(function(f){for(var g in f)f[g]instanceof c.Table&&delete f[g]})}function Oi(c,h){return c._cfg.version-h._cfg.version}function Bi(c,h,f,g){var m=c._dbSchema;f.objectStoreNames.contains("$meta")&&!m.$meta&&(m.$meta=In("$meta",Sr("")[0],[]),c._storeNames.push("$meta"));var v=c._createTransaction("readwrite",c._storeNames,m);v.create(f),v._completion.catch(g);var E=v._reject.bind(v),S=be.transless||be;tt(function(){return be.trans=v,be.transless=S,h!==0?(nn(c,f),C=h,((N=v).storeNames.includes("$meta")?N.table("$meta").get("version").then(function(D){return D??C}):fe.resolve(C)).then(function(D){return U=D,$=v,P=f,I=[],D=(R=c)._versions,K=R._dbSchema=on(0,R.idbdb,P),(D=D.filter(function(L){return L._cfg.version>=U})).length!==0?(D.forEach(function(L){I.push(function(){var M=K,q=L._cfg.dbschema;an(R,M,P),an(R,q,P),K=R._dbSchema=q;var Y=Un(M,q);Y.add.forEach(function(he){Fn(P,he[0],he[1].primKey,he[1].indexes)}),Y.change.forEach(function(he){if(he.recreate)throw new pe.Upgrade("Not yet support for changing primary key");var le=P.objectStore(he.name);he.add.forEach(function(ge){return sn(le,ge)}),he.change.forEach(function(ge){le.deleteIndex(ge.name),sn(le,ge)}),he.del.forEach(function(ge){return le.deleteIndex(ge)})});var se=L._cfg.contentUpgrade;if(se&&L._cfg.version>U){nn(R,P),$._memoizedTables={};var ue=oe(q);Y.del.forEach(function(he){ue[he]=M[he]}),Kn(R,[R.Transaction.prototype]),rn(R,[R.Transaction.prototype],a(ue),ue),$.schema=ue;var re,ce=X(se);return ce&&kt(),Y=fe.follow(function(){var he;(re=se($))&&ce&&(he=nt.bind(null,null),re.then(he,he))}),re&&typeof re.then=="function"?fe.resolve(re):Y.then(function(){return re})}}),I.push(function(M){var q,Y,se=L._cfg.dbschema;q=se,Y=M,[].slice.call(Y.db.objectStoreNames).forEach(function(ue){return q[ue]==null&&Y.db.deleteObjectStore(ue)}),Kn(R,[R.Transaction.prototype]),rn(R,[R.Transaction.prototype],R._storeNames,R._dbSchema),$.schema=R._dbSchema}),I.push(function(M){R.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(R.idbdb.version/10)===L._cfg.version?(R.idbdb.deleteObjectStore("$meta"),delete R._dbSchema.$meta,R._storeNames=R._storeNames.filter(function(q){return q!=="$meta"})):M.objectStore("$meta").put(L._cfg.version,"version"))})}),function L(){return I.length?fe.resolve(I.shift()($.idbtrans)).then(L):fe.resolve()}().then(function(){kr(K,P)})):fe.resolve();var R,U,$,P,I,K}).catch(E)):(a(m).forEach(function(D){Fn(f,D,m[D].primKey,m[D].indexes)}),nn(c,f),void fe.follow(function(){return c.on.populate.fire(v)}).catch(E));var N,C})}function Li(c,h){kr(c._dbSchema,h),h.db.version%10!=0||h.objectStoreNames.contains("$meta")||h.db.createObjectStore("$meta").add(Math.ceil(h.db.version/10-1),"version");var f=on(0,c.idbdb,h);an(c,c._dbSchema,h);for(var g=0,m=Un(f,c._dbSchema).change;g<m.length;g++){var v=function(E){if(E.change.length||E.recreate)return console.warn("Unable to patch indexes of table ".concat(E.name," because it has changes on the type of index or primary key.")),{value:void 0};var S=h.objectStore(E.name);E.add.forEach(function(N){Ge&&console.debug("Dexie upgrade patch: Creating missing index ".concat(E.name,".").concat(N.src)),sn(S,N)})}(m[g]);if(typeof v=="object")return v.value}}function Un(c,h){var f,g={del:[],add:[],change:[]};for(f in c)h[f]||g.del.push(f);for(f in h){var m=c[f],v=h[f];if(m){var E={name:f,def:v,recreate:!1,del:[],add:[],change:[]};if(""+(m.primKey.keyPath||"")!=""+(v.primKey.keyPath||"")||m.primKey.auto!==v.primKey.auto)E.recreate=!0,g.change.push(E);else{var S=m.idxByName,N=v.idxByName,C=void 0;for(C in S)N[C]||E.del.push(C);for(C in N){var D=S[C],R=N[C];D?D.src!==R.src&&E.change.push(R):E.add.push(R)}(0<E.del.length||0<E.add.length||0<E.change.length)&&g.change.push(E)}}else g.add.push([f,v])}return g}function Fn(c,h,f,g){var m=c.db.createObjectStore(h,f.keyPath?{keyPath:f.keyPath,autoIncrement:f.auto}:{autoIncrement:f.auto});return g.forEach(function(v){return sn(m,v)}),m}function kr(c,h){a(c).forEach(function(f){h.db.objectStoreNames.contains(f)||(Ge&&console.debug("Dexie: Creating missing table",f),Fn(h,f,c[f].primKey,c[f].indexes))})}function sn(c,h){c.createIndex(h.name,h.keyPath,{unique:h.unique,multiEntry:h.multi})}function on(c,h,f){var g={};return G(h.objectStoreNames,0).forEach(function(m){for(var v=f.objectStore(m),E=Pn(_r(C=v.keyPath),C||"",!0,!1,!!v.autoIncrement,C&&typeof C!="string",!0),S=[],N=0;N<v.indexNames.length;++N){var D=v.index(v.indexNames[N]),C=D.keyPath,D=Pn(D.name,C,!!D.unique,!!D.multiEntry,!1,C&&typeof C!="string",!1);S.push(D)}g[m]=In(m,E,S)}),g}function an(c,h,f){for(var g=f.db.objectStoreNames,m=0;m<g.length;++m){var v=g[m],E=f.objectStore(v);c._hasGetAll="getAll"in E;for(var S=0;S<E.indexNames.length;++S){var N=E.indexNames[S],C=E.index(N).keyPath,D=typeof C=="string"?C:"["+G(C).join("+")+"]";!h[v]||(C=h[v].idxByName[D])&&(C.name=N,delete h[v].idxByName[D],h[v].idxByName[N]=C)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(c._hasGetAll=!1)}function Sr(c){return c.split(",").map(function(h,f){var v=h.split(":"),g=(m=v[1])===null||m===void 0?void 0:m.trim(),m=(h=v[0].trim()).replace(/([&*]|\+\+)/g,""),v=/^\[/.test(m)?m.match(/^\[(.*)\]$/)[1].split("+"):m;return Pn(m,v||null,/\&/.test(h),/\*/.test(h),/\+\+/.test(h),l(v),f===0,g)})}var Mi=(At.prototype._createTableSchema=In,At.prototype._parseIndexSyntax=Sr,At.prototype._parseStoresSpec=function(c,h){var f=this;a(c).forEach(function(g){if(c[g]!==null){var m=f._parseIndexSyntax(c[g]),v=m.shift();if(!v)throw new pe.Schema("Invalid schema for table "+g+": "+c[g]);if(v.unique=!0,v.multi)throw new pe.Schema("Primary key cannot be multiEntry*");m.forEach(function(E){if(E.auto)throw new pe.Schema("Only primary key can be marked as autoIncrement (++)");if(!E.keyPath)throw new pe.Schema("Index must have a name and cannot be an empty string")}),m=f._createTableSchema(g,v,m),h[g]=m}})},At.prototype.stores=function(f){var h=this.db;this._cfg.storesSource=this._cfg.storesSource?u(this._cfg.storesSource,f):f;var f=h._versions,g={},m={};return f.forEach(function(v){u(g,v._cfg.storesSource),m=v._cfg.dbschema={},v._parseStoresSpec(g,m)}),h._dbSchema=m,Kn(h,[h._allTables,h,h.Transaction.prototype]),rn(h,[h._allTables,h,h.Transaction.prototype,this._cfg.tables],a(m),m),h._storeNames=a(m),this},At.prototype.upgrade=function(c){return this._cfg.contentUpgrade=bn(this._cfg.contentUpgrade||xe,c),this},At);function At(){}function On(c,h){var f=c._dbNamesDB;return f||(f=c._dbNamesDB=new Xe(Yt,{addons:[],indexedDB:c,IDBKeyRange:h})).version(1).stores({dbnames:"name"}),f.table("dbnames")}function Bn(c){return c&&typeof c.databases=="function"}function Ln(c){return tt(function(){return be.letThrough=!0,c()})}function Mn(c){return!("from"in c)}var Oe=function(c,h){if(!this){var f=new Oe;return c&&"d"in c&&u(f,c),f}u(this,arguments.length?{d:1,from:c,to:1<arguments.length?h:c}:{d:0})};function Lt(c,h,f){var g=Te(h,f);if(!isNaN(g)){if(0<g)throw RangeError();if(Mn(c))return u(c,{from:h,to:f,d:1});var m=c.l,g=c.r;if(Te(f,c.from)<0)return m?Lt(m,h,f):c.l={from:h,to:f,d:1,l:null,r:null},Tr(c);if(0<Te(h,c.to))return g?Lt(g,h,f):c.r={from:h,to:f,d:1,l:null,r:null},Tr(c);Te(h,c.from)<0&&(c.from=h,c.l=null,c.d=g?g.d+1:1),0<Te(f,c.to)&&(c.to=f,c.r=null,c.d=c.l?c.l.d+1:1),f=!c.r,m&&!c.l&&Mt(c,m),g&&f&&Mt(c,g)}}function Mt(c,h){Mn(h)||function f(g,N){var v=N.from,E=N.to,S=N.l,N=N.r;Lt(g,v,E),S&&f(g,S),N&&f(g,N)}(c,h)}function xr(c,h){var f=cn(h),g=f.next();if(g.done)return!1;for(var m=g.value,v=cn(c),E=v.next(m.from),S=E.value;!g.done&&!E.done;){if(Te(S.from,m.to)<=0&&0<=Te(S.to,m.from))return!0;Te(m.from,S.from)<0?m=(g=f.next(S.from)).value:S=(E=v.next(m.from)).value}return!1}function cn(c){var h=Mn(c)?null:{s:0,n:c};return{next:function(f){for(var g=0<arguments.length;h;)switch(h.s){case 0:if(h.s=1,g)for(;h.n.l&&Te(f,h.n.from)<0;)h={up:h,n:h.n.l,s:1};else for(;h.n.l;)h={up:h,n:h.n.l,s:1};case 1:if(h.s=2,!g||Te(f,h.n.to)<=0)return{value:h.n,done:!1};case 2:if(h.n.r){h.s=3,h={up:h,n:h.n.r,s:0};continue}case 3:h=h.up}return{done:!0}}}}function Tr(c){var h,f,g=(((h=c.r)===null||h===void 0?void 0:h.d)||0)-(((f=c.l)===null||f===void 0?void 0:f.d)||0),m=1<g?"r":g<-1?"l":"";m&&(h=m=="r"?"l":"r",f=r({},c),g=c[m],c.from=g.from,c.to=g.to,c[m]=g[m],f[m]=g[h],(c[h]=f).d=Ar(f)),c.d=Ar(c)}function Ar(f){var h=f.r,f=f.l;return(h?f?Math.max(h.d,f.d):h.d:f?f.d:0)+1}function ln(c,h){return a(h).forEach(function(f){c[f]?Mt(c[f],h[f]):c[f]=function g(m){var v,E,S={};for(v in m)b(m,v)&&(E=m[v],S[v]=!E||typeof E!="object"||O.has(E.constructor)?E:g(E));return S}(h[f])}),c}function Hn(c,h){return c.all||h.all||Object.keys(c).some(function(f){return h[f]&&xr(h[f],c[f])})}w(Oe.prototype,((ze={add:function(c){return Mt(this,c),this},addKey:function(c){return Lt(this,c,c),this},addKeys:function(c){var h=this;return c.forEach(function(f){return Lt(h,f,f)}),this},hasKey:function(c){var h=cn(this).next(c).value;return h&&Te(h.from,c)<=0&&0<=Te(h.to,c)}})[W]=function(){return cn(this)},ze));var yt={},Vn={},zn=!1;function un(c){ln(Vn,c),zn||(zn=!0,setTimeout(function(){zn=!1,jn(Vn,!(Vn={}))},0))}function jn(c,h){h===void 0&&(h=!1);var f=new Set;if(c.all)for(var g=0,m=Object.values(yt);g<m.length;g++)Rr(E=m[g],c,f,h);else for(var v in c){var E,S=/^idb\:\/\/(.*)\/(.*)\//.exec(v);S&&(v=S[1],S=S[2],(E=yt["idb://".concat(v,"/").concat(S)])&&Rr(E,c,f,h))}f.forEach(function(N){return N()})}function Rr(c,h,f,g){for(var m=[],v=0,E=Object.entries(c.queries.query);v<E.length;v++){for(var S=E[v],N=S[0],C=[],D=0,R=S[1];D<R.length;D++){var U=R[D];Hn(h,U.obsSet)?U.subscribers.forEach(function(K){return f.add(K)}):g&&C.push(U)}g&&m.push([N,C])}if(g)for(var $=0,P=m;$<P.length;$++){var I=P[$],N=I[0],C=I[1];c.queries.query[N]=C}}function Hi(c){var h=c._state,f=c._deps.indexedDB;if(h.isBeingOpened||c.idbdb)return h.dbReadyPromise.then(function(){return h.dbOpenError?Pe(h.dbOpenError):c});h.isBeingOpened=!0,h.dbOpenError=null,h.openComplete=!1;var g=h.openCanceller,m=Math.round(10*c.verno),v=!1;function E(){if(h.openCanceller!==g)throw new pe.DatabaseClosed("db.open() was cancelled")}function S(){return new fe(function(U,$){if(E(),!f)throw new pe.MissingAPI;var P=c.name,I=h.autoSchema||!m?f.open(P):f.open(P,m);if(!I)throw new pe.MissingAPI;I.onerror=Je($),I.onblocked=$e(c._fireOnBlocked),I.onupgradeneeded=$e(function(K){var L;D=I.transaction,h.autoSchema&&!c._options.allowEmptyDB?(I.onerror=Ut,D.abort(),I.result.close(),(L=f.deleteDatabase(P)).onsuccess=L.onerror=$e(function(){$(new pe.NoSuchDatabase("Database ".concat(P," doesnt exist")))})):(D.onerror=Je($),K=K.oldVersion>Math.pow(2,62)?0:K.oldVersion,R=K<1,c.idbdb=I.result,v&&Li(c,D),Bi(c,K/10,D,$))},$),I.onsuccess=$e(function(){D=null;var K,L,M,q,Y,se=c.idbdb=I.result,ue=G(se.objectStoreNames);if(0<ue.length)try{var re=se.transaction((q=ue).length===1?q[0]:q,"readonly");if(h.autoSchema)L=se,M=re,(K=c).verno=L.version/10,M=K._dbSchema=on(0,L,M),K._storeNames=G(L.objectStoreNames,0),rn(K,[K._allTables],a(M),M);else if(an(c,c._dbSchema,re),((Y=Un(on(0,(Y=c).idbdb,re),Y._dbSchema)).add.length||Y.change.some(function(ce){return ce.add.length||ce.change.length}))&&!v)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),se.close(),m=se.version+1,v=!0,U(S());nn(c,re)}catch{}St.push(c),se.onversionchange=$e(function(ce){h.vcFired=!0,c.on("versionchange").fire(ce)}),se.onclose=$e(function(){c.close({disableAutoOpen:!1})}),R&&(Y=c._deps,re=P,se=Y.indexedDB,Y=Y.IDBKeyRange,Bn(se)||re===Yt||On(se,Y).put({name:re}).catch(xe)),U()},$)}).catch(function(U){switch(U?.name){case"UnknownError":if(0<h.PR1398_maxLoop)return h.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),S();break;case"VersionError":if(0<m)return m=0,S()}return fe.reject(U)})}var N,C=h.dbReadyResolve,D=null,R=!1;return fe.race([g,(typeof navigator>"u"?fe.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(U){function $(){return indexedDB.databases().finally(U)}N=setInterval($,100),$()}).finally(function(){return clearInterval(N)}):Promise.resolve()).then(S)]).then(function(){return E(),h.onReadyBeingFired=[],fe.resolve(Ln(function(){return c.on.ready.fire(c.vip)})).then(function U(){if(0<h.onReadyBeingFired.length){var $=h.onReadyBeingFired.reduce(bn,xe);return h.onReadyBeingFired=[],fe.resolve(Ln(function(){return $(c.vip)})).then(U)}})}).finally(function(){h.openCanceller===g&&(h.onReadyBeingFired=null,h.isBeingOpened=!1)}).catch(function(U){h.dbOpenError=U;try{D&&D.abort()}catch{}return g===h.openCanceller&&c._close(),Pe(U)}).finally(function(){h.openComplete=!0,C()}).then(function(){var U;return R&&(U={},c.tables.forEach(function($){$.schema.indexes.forEach(function(P){P.name&&(U["idb://".concat(c.name,"/").concat($.name,"/").concat(P.name)]=new Oe(-1/0,[[[]]]))}),U["idb://".concat(c.name,"/").concat($.name,"/")]=U["idb://".concat(c.name,"/").concat($.name,"/:dels")]=new Oe(-1/0,[[[]]])}),st(Ft).fire(U),jn(U,!0)),c})}function Wn(c){function h(v){return c.next(v)}var f=m(h),g=m(function(v){return c.throw(v)});function m(v){return function(N){var S=v(N),N=S.value;return S.done?N:N&&typeof N.then=="function"?N.then(f,g):l(N)?Promise.all(N).then(f,g):f(N)}}return m(h)()}function hn(c,h,f){for(var g=l(c)?c.slice():[c],m=0;m<f;++m)g.push(h);return g}var Vi={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(c){return r(r({},c),{table:function(h){var f=c.table(h),g=f.schema,m={},v=[];function E(R,U,$){var P=Bt(R),I=m[P]=m[P]||[],K=R==null?0:typeof R=="string"?1:R.length,L=0<U,L=r(r({},$),{name:L?"".concat(P,"(virtual-from:").concat($.name,")"):$.name,lowLevelIndex:$,isVirtual:L,keyTail:U,keyLength:K,extractKey:Dn(R),unique:!L&&$.unique});return I.push(L),L.isPrimaryKey||v.push(L),1<K&&E(K===2?R[0]:R.slice(0,K-1),U+1,$),I.sort(function(M,q){return M.keyTail-q.keyTail}),L}h=E(g.primaryKey.keyPath,0,g.primaryKey),m[":id"]=[h];for(var S=0,N=g.indexes;S<N.length;S++){var C=N[S];E(C.keyPath,0,C)}function D(R){var U,$=R.query.index;return $.isVirtual?r(r({},R),{query:{index:$.lowLevelIndex,range:(U=R.query.range,$=$.keyTail,{type:U.type===1?2:U.type,lower:hn(U.lower,U.lowerOpen?c.MAX_KEY:c.MIN_KEY,$),lowerOpen:!0,upper:hn(U.upper,U.upperOpen?c.MIN_KEY:c.MAX_KEY,$),upperOpen:!0})}}):R}return r(r({},f),{schema:r(r({},g),{primaryKey:h,indexes:v,getIndexByKeyPath:function(R){return(R=m[Bt(R)])&&R[0]}}),count:function(R){return f.count(D(R))},query:function(R){return f.query(D(R))},openCursor:function(R){var U=R.query.index,$=U.keyTail,P=U.isVirtual,I=U.keyLength;return P?f.openCursor(D(R)).then(function(L){return L&&K(L)}):f.openCursor(R);function K(L){return Object.create(L,{continue:{value:function(M){M!=null?L.continue(hn(M,R.reverse?c.MAX_KEY:c.MIN_KEY,$)):R.unique?L.continue(L.key.slice(0,I).concat(R.reverse?c.MIN_KEY:c.MAX_KEY,$)):L.continue()}},continuePrimaryKey:{value:function(M,q){L.continuePrimaryKey(hn(M,c.MAX_KEY,$),q)}},primaryKey:{get:function(){return L.primaryKey}},key:{get:function(){var M=L.key;return I===1?M[0]:M.slice(0,I)}},value:{get:function(){return L.value}}})}}})}})}};function qn(c,h,f,g){return f=f||{},g=g||"",a(c).forEach(function(m){var v,E,S;b(h,m)?(v=c[m],E=h[m],typeof v=="object"&&typeof E=="object"&&v&&E?(S=V(v))!==V(E)?f[g+m]=h[m]:S==="Object"?qn(v,E,f,g+m+"."):v!==E&&(f[g+m]=h[m]):v!==E&&(f[g+m]=h[m])):f[g+m]=void 0}),a(h).forEach(function(m){b(c,m)||(f[g+m]=h[m])}),f}function Gn(c,h){return h.type==="delete"?h.keys:h.keys||h.values.map(c.extractKey)}var zi={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(c){return r(r({},c),{table:function(h){var f=c.table(h),g=f.schema.primaryKey;return r(r({},f),{mutate:function(m){var v=be.trans,E=v.table(h).hook,S=E.deleting,N=E.creating,C=E.updating;switch(m.type){case"add":if(N.fire===xe)break;return v._promise("readwrite",function(){return D(m)},!0);case"put":if(N.fire===xe&&C.fire===xe)break;return v._promise("readwrite",function(){return D(m)},!0);case"delete":if(S.fire===xe)break;return v._promise("readwrite",function(){return D(m)},!0);case"deleteRange":if(S.fire===xe)break;return v._promise("readwrite",function(){return function R(U,$,P){return f.query({trans:U,values:!1,query:{index:g,range:$},limit:P}).then(function(I){var K=I.result;return D({type:"delete",keys:K,trans:U}).then(function(L){return 0<L.numFailures?Promise.reject(L.failures[0]):K.length<P?{failures:[],numFailures:0,lastResult:void 0}:R(U,r(r({},$),{lower:K[K.length-1],lowerOpen:!0}),P)})})}(m.trans,m.range,1e4)},!0)}return f.mutate(m);function D(R){var U,$,P,I=be.trans,K=R.keys||Gn(g,R);if(!K)throw new Error("Keys missing");return(R=R.type==="add"||R.type==="put"?r(r({},R),{keys:K}):r({},R)).type!=="delete"&&(R.values=s([],R.values)),R.keys&&(R.keys=s([],R.keys)),U=f,P=K,(($=R).type==="add"?Promise.resolve([]):U.getMany({trans:$.trans,keys:P,cache:"immutable"})).then(function(L){var M=K.map(function(q,Y){var se,ue,re,ce=L[Y],he={onerror:null,onsuccess:null};return R.type==="delete"?S.fire.call(he,q,ce,I):R.type==="add"||ce===void 0?(se=N.fire.call(he,q,R.values[Y],I),q==null&&se!=null&&(R.keys[Y]=q=se,g.outbound||te(R.values[Y],g.keyPath,q))):(se=qn(ce,R.values[Y]),(ue=C.fire.call(he,se,q,ce,I))&&(re=R.values[Y],Object.keys(ue).forEach(function(le){b(re,le)?re[le]=ue[le]:te(re,le,ue[le])}))),he});return f.mutate(R).then(function(q){for(var Y=q.failures,se=q.results,ue=q.numFailures,q=q.lastResult,re=0;re<K.length;++re){var ce=(se||K)[re],he=M[re];ce==null?he.onerror&&he.onerror(Y[re]):he.onsuccess&&he.onsuccess(R.type==="put"&&L[re]?R.values[re]:ce)}return{failures:Y,results:se,numFailures:ue,lastResult:q}}).catch(function(q){return M.forEach(function(Y){return Y.onerror&&Y.onerror(q)}),Promise.reject(q)})})}}})}})}};function Nr(c,h,f){try{if(!h||h.keys.length<c.length)return null;for(var g=[],m=0,v=0;m<h.keys.length&&v<c.length;++m)Te(h.keys[m],c[v])===0&&(g.push(f?j(h.values[m]):h.values[m]),++v);return g.length===c.length?g:null}catch{return null}}var ji={stack:"dbcore",level:-1,create:function(c){return{table:function(h){var f=c.table(h);return r(r({},f),{getMany:function(g){if(!g.cache)return f.getMany(g);var m=Nr(g.keys,g.trans._cache,g.cache==="clone");return m?fe.resolve(m):f.getMany(g).then(function(v){return g.trans._cache={keys:g.keys,values:g.cache==="clone"?j(v):v},v})},mutate:function(g){return g.type!=="add"&&(g.trans._cache=null),f.mutate(g)}})}}}};function Cr(c,h){return c.trans.mode==="readonly"&&!!c.subscr&&!c.trans.explicit&&c.trans.db._options.cache!=="disabled"&&!h.schema.primaryKey.outbound}function $r(c,h){switch(c){case"query":return h.values&&!h.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Wi={stack:"dbcore",level:0,name:"Observability",create:function(c){var h=c.schema.name,f=new Oe(c.MIN_KEY,c.MAX_KEY);return r(r({},c),{transaction:function(g,m,v){if(be.subscr&&m!=="readonly")throw new pe.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(be.querier));return c.transaction(g,m,v)},table:function(g){var m=c.table(g),v=m.schema,E=v.primaryKey,R=v.indexes,S=E.extractKey,N=E.outbound,C=E.autoIncrement&&R.filter(function($){return $.compound&&$.keyPath.includes(E.keyPath)}),D=r(r({},m),{mutate:function($){function P(le){return le="idb://".concat(h,"/").concat(g,"/").concat(le),q[le]||(q[le]=new Oe)}var I,K,L,M=$.trans,q=$.mutatedParts||($.mutatedParts={}),Y=P(""),se=P(":dels"),ue=$.type,he=$.type==="deleteRange"?[$.range]:$.type==="delete"?[$.keys]:$.values.length<50?[Gn(E,$).filter(function(le){return le}),$.values]:[],re=he[0],ce=he[1],he=$.trans._cache;return l(re)?(Y.addKeys(re),(he=ue==="delete"||re.length===ce.length?Nr(re,he):null)||se.addKeys(re),(he||ce)&&(I=P,K=he,L=ce,v.indexes.forEach(function(le){var ge=I(le.name||"");function Ee(Se){return Se!=null?le.extractKey(Se):null}function ke(Se){return le.multiEntry&&l(Se)?Se.forEach(function(Ve){return ge.addKey(Ve)}):ge.addKey(Se)}(K||L).forEach(function(Se,Be){var _e=K&&Ee(K[Be]),Be=L&&Ee(L[Be]);Te(_e,Be)!==0&&(_e!=null&&ke(_e),Be!=null&&ke(Be))})}))):re?(ce={from:(ce=re.lower)!==null&&ce!==void 0?ce:c.MIN_KEY,to:(ce=re.upper)!==null&&ce!==void 0?ce:c.MAX_KEY},se.add(ce),Y.add(ce)):(Y.add(f),se.add(f),v.indexes.forEach(function(le){return P(le.name).add(f)})),m.mutate($).then(function(le){return!re||$.type!=="add"&&$.type!=="put"||(Y.addKeys(le.results),C&&C.forEach(function(ge){for(var Ee=$.values.map(function(_e){return ge.extractKey(_e)}),ke=ge.keyPath.findIndex(function(_e){return _e===E.keyPath}),Se=0,Ve=le.results.length;Se<Ve;++Se)Ee[Se][ke]=le.results[Se];P(ge.name).addKeys(Ee)})),M.mutatedParts=ln(M.mutatedParts||{},q),le})}}),R=function(P){var I=P.query,P=I.index,I=I.range;return[P,new Oe((P=I.lower)!==null&&P!==void 0?P:c.MIN_KEY,(I=I.upper)!==null&&I!==void 0?I:c.MAX_KEY)]},U={get:function($){return[E,new Oe($.key)]},getMany:function($){return[E,new Oe().addKeys($.keys)]},count:R,query:R,openCursor:R};return a(U).forEach(function($){D[$]=function(P){var I=be.subscr,K=!!I,L=Cr(be,m)&&$r($,P)?P.obsSet={}:I;if(K){var M=function(ce){return ce="idb://".concat(h,"/").concat(g,"/").concat(ce),L[ce]||(L[ce]=new Oe)},q=M(""),Y=M(":dels"),I=U[$](P),K=I[0],I=I[1];if(($==="query"&&K.isPrimaryKey&&!P.values?Y:M(K.name||"")).add(I),!K.isPrimaryKey){if($!=="count"){var se=$==="query"&&N&&P.values&&m.query(r(r({},P),{values:!1}));return m[$].apply(this,arguments).then(function(ce){if($==="query"){if(N&&P.values)return se.then(function(Ee){return Ee=Ee.result,q.addKeys(Ee),ce});var he=P.values?ce.result.map(S):ce.result;(P.values?q:Y).addKeys(he)}else if($==="openCursor"){var le=ce,ge=P.values;return le&&Object.create(le,{key:{get:function(){return Y.addKey(le.primaryKey),le.key}},primaryKey:{get:function(){var Ee=le.primaryKey;return Y.addKey(Ee),Ee}},value:{get:function(){return ge&&q.addKey(le.primaryKey),le.value}}})}return ce})}Y.add(f)}}return m[$].apply(this,arguments)}}),D}})}};function Pr(c,h,f){if(f.numFailures===0)return h;if(h.type==="deleteRange")return null;var g=h.keys?h.keys.length:"values"in h&&h.values?h.values.length:1;return f.numFailures===g?null:(h=r({},h),l(h.keys)&&(h.keys=h.keys.filter(function(m,v){return!(v in f.failures)})),"values"in h&&l(h.values)&&(h.values=h.values.filter(function(m,v){return!(v in f.failures)})),h)}function Jn(c,h){return f=c,((g=h).lower===void 0||(g.lowerOpen?0<Te(f,g.lower):0<=Te(f,g.lower)))&&(c=c,(h=h).upper===void 0||(h.upperOpen?Te(c,h.upper)<0:Te(c,h.upper)<=0));var f,g}function Ir(c,h,U,g,m,v){if(!U||U.length===0)return c;var E=h.query.index,S=E.multiEntry,N=h.query.range,C=g.schema.primaryKey.extractKey,D=E.extractKey,R=(E.lowLevelIndex||E).extractKey,U=U.reduce(function($,P){var I=$,K=[];if(P.type==="add"||P.type==="put")for(var L=new Oe,M=P.values.length-1;0<=M;--M){var q,Y=P.values[M],se=C(Y);L.hasKey(se)||(q=D(Y),(S&&l(q)?q.some(function(le){return Jn(le,N)}):Jn(q,N))&&(L.addKey(se),K.push(Y)))}switch(P.type){case"add":var ue=new Oe().addKeys(h.values?$.map(function(ge){return C(ge)}):$),I=$.concat(h.values?K.filter(function(ge){return ge=C(ge),!ue.hasKey(ge)&&(ue.addKey(ge),!0)}):K.map(function(ge){return C(ge)}).filter(function(ge){return!ue.hasKey(ge)&&(ue.addKey(ge),!0)}));break;case"put":var re=new Oe().addKeys(P.values.map(function(ge){return C(ge)}));I=$.filter(function(ge){return!re.hasKey(h.values?C(ge):ge)}).concat(h.values?K:K.map(function(ge){return C(ge)}));break;case"delete":var ce=new Oe().addKeys(P.keys);I=$.filter(function(ge){return!ce.hasKey(h.values?C(ge):ge)});break;case"deleteRange":var he=P.range;I=$.filter(function(ge){return!Jn(C(ge),he)})}return I},c);return U===c?c:(U.sort(function($,P){return Te(R($),R(P))||Te(C($),C(P))}),h.limit&&h.limit<1/0&&(U.length>h.limit?U.length=h.limit:c.length===h.limit&&U.length<h.limit&&(m.dirty=!0)),v?Object.freeze(U):U)}function Dr(c,h){return Te(c.lower,h.lower)===0&&Te(c.upper,h.upper)===0&&!!c.lowerOpen==!!h.lowerOpen&&!!c.upperOpen==!!h.upperOpen}function qi(c,h){return function(f,g,m,v){if(f===void 0)return g!==void 0?-1:0;if(g===void 0)return 1;if((g=Te(f,g))===0){if(m&&v)return 0;if(m)return 1;if(v)return-1}return g}(c.lower,h.lower,c.lowerOpen,h.lowerOpen)<=0&&0<=function(f,g,m,v){if(f===void 0)return g!==void 0?1:0;if(g===void 0)return-1;if((g=Te(f,g))===0){if(m&&v)return 0;if(m)return-1;if(v)return 1}return g}(c.upper,h.upper,c.upperOpen,h.upperOpen)}function Gi(c,h,f,g){c.subscribers.add(f),g.addEventListener("abort",function(){var m,v;c.subscribers.delete(f),c.subscribers.size===0&&(m=c,v=h,setTimeout(function(){m.subscribers.size===0&&ae(v,m)},3e3))})}var Ji={stack:"dbcore",level:0,name:"Cache",create:function(c){var h=c.schema.name;return r(r({},c),{transaction:function(f,g,m){var v,E,S=c.transaction(f,g,m);return g==="readwrite"&&(E=(v=new AbortController).signal,m=function(N){return function(){if(v.abort(),g==="readwrite"){for(var C=new Set,D=0,R=f;D<R.length;D++){var U=R[D],$=yt["idb://".concat(h,"/").concat(U)];if($){var P=c.table(U),I=$.optimisticOps.filter(function(ge){return ge.trans===S});if(S._explicit&&N&&S.mutatedParts)for(var K=0,L=Object.values($.queries.query);K<L.length;K++)for(var M=0,q=(ue=L[K]).slice();M<q.length;M++)Hn((re=q[M]).obsSet,S.mutatedParts)&&(ae(ue,re),re.subscribers.forEach(function(ge){return C.add(ge)}));else if(0<I.length){$.optimisticOps=$.optimisticOps.filter(function(ge){return ge.trans!==S});for(var Y=0,se=Object.values($.queries.query);Y<se.length;Y++)for(var ue,re,ce,he=0,le=(ue=se[Y]).slice();he<le.length;he++)(re=le[he]).res!=null&&S.mutatedParts&&(N&&!re.dirty?(ce=Object.isFrozen(re.res),ce=Ir(re.res,re.req,I,P,re,ce),re.dirty?(ae(ue,re),re.subscribers.forEach(function(ge){return C.add(ge)})):ce!==re.res&&(re.res=ce,re.promise=fe.resolve({result:ce}))):(re.dirty&&ae(ue,re),re.subscribers.forEach(function(ge){return C.add(ge)})))}}}C.forEach(function(ge){return ge()})}}},S.addEventListener("abort",m(!1),{signal:E}),S.addEventListener("error",m(!1),{signal:E}),S.addEventListener("complete",m(!0),{signal:E})),S},table:function(f){var g=c.table(f),m=g.schema.primaryKey;return r(r({},g),{mutate:function(v){var E=be.trans;if(m.outbound||E.db._options.cache==="disabled"||E.explicit||E.idbtrans.mode!=="readwrite")return g.mutate(v);var S=yt["idb://".concat(h,"/").concat(f)];return S?(E=g.mutate(v),v.type!=="add"&&v.type!=="put"||!(50<=v.values.length||Gn(m,v).some(function(N){return N==null}))?(S.optimisticOps.push(v),v.mutatedParts&&un(v.mutatedParts),E.then(function(N){0<N.numFailures&&(ae(S.optimisticOps,v),(N=Pr(0,v,N))&&S.optimisticOps.push(N),v.mutatedParts&&un(v.mutatedParts))}),E.catch(function(){ae(S.optimisticOps,v),v.mutatedParts&&un(v.mutatedParts)})):E.then(function(N){var C=Pr(0,r(r({},v),{values:v.values.map(function(D,R){var U;return N.failures[R]?D:(D=(U=m.keyPath)!==null&&U!==void 0&&U.includes(".")?j(D):r({},D),te(D,m.keyPath,N.results[R]),D)})}),N);S.optimisticOps.push(C),queueMicrotask(function(){return v.mutatedParts&&un(v.mutatedParts)})}),E):g.mutate(v)},query:function(v){if(!Cr(be,g)||!$r("query",v))return g.query(v);var E=((C=be.trans)===null||C===void 0?void 0:C.db._options.cache)==="immutable",R=be,S=R.requery,N=R.signal,C=function(P,I,K,L){var M=yt["idb://".concat(P,"/").concat(I)];if(!M)return[];if(!(I=M.queries[K]))return[null,!1,M,null];var q=I[(L.query?L.query.index.name:null)||""];if(!q)return[null,!1,M,null];switch(K){case"query":var Y=q.find(function(se){return se.req.limit===L.limit&&se.req.values===L.values&&Dr(se.req.query.range,L.query.range)});return Y?[Y,!0,M,q]:[q.find(function(se){return("limit"in se.req?se.req.limit:1/0)>=L.limit&&(!L.values||se.req.values)&&qi(se.req.query.range,L.query.range)}),!1,M,q];case"count":return Y=q.find(function(se){return Dr(se.req.query.range,L.query.range)}),[Y,!!Y,M,q]}}(h,f,"query",v),D=C[0],R=C[1],U=C[2],$=C[3];return D&&R?D.obsSet=v.obsSet:(R=g.query(v).then(function(P){var I=P.result;if(D&&(D.res=I),E){for(var K=0,L=I.length;K<L;++K)Object.freeze(I[K]);Object.freeze(I)}else P.result=j(I);return P}).catch(function(P){return $&&D&&ae($,D),Promise.reject(P)}),D={obsSet:v.obsSet,promise:R,subscribers:new Set,type:"query",req:v,dirty:!1},$?$.push(D):($=[D],(U=U||(yt["idb://".concat(h,"/").concat(f)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[v.query.index.name||""]=$)),Gi(D,$,S,N),D.promise.then(function(P){return{result:Ir(P.result,v,U?.optimisticOps,g,D,E)}})}})}})}};function dn(c,h){return new Proxy(c,{get:function(f,g,m){return g==="db"?h:Reflect.get(f,g,m)}})}var Xe=(Ie.prototype.version=function(c){if(isNaN(c)||c<.1)throw new pe.Type("Given version is not a positive number");if(c=Math.round(10*c)/10,this.idbdb||this._state.isBeingOpened)throw new pe.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,c);var h=this._versions,f=h.filter(function(g){return g._cfg.version===c})[0];return f||(f=new this.Version(c),h.push(f),h.sort(Oi),f.stores({}),this._state.autoSchema=!1,f)},Ie.prototype._whenReady=function(c){var h=this;return this.idbdb&&(this._state.openComplete||be.letThrough||this._vip)?c():new fe(function(f,g){if(h._state.openComplete)return g(new pe.DatabaseClosed(h._state.dbOpenError));if(!h._state.isBeingOpened){if(!h._state.autoOpen)return void g(new pe.DatabaseClosed);h.open().catch(xe)}h._state.dbReadyPromise.then(f,g)}).then(c)},Ie.prototype.use=function(c){var h=c.stack,f=c.create,g=c.level,m=c.name;return m&&this.unuse({stack:h,name:m}),c=this._middlewares[h]||(this._middlewares[h]=[]),c.push({stack:h,create:f,level:g??10,name:m}),c.sort(function(v,E){return v.level-E.level}),this},Ie.prototype.unuse=function(c){var h=c.stack,f=c.name,g=c.create;return h&&this._middlewares[h]&&(this._middlewares[h]=this._middlewares[h].filter(function(m){return g?m.create!==g:!!f&&m.name!==f})),this},Ie.prototype.open=function(){var c=this;return dt(et,function(){return Hi(c)})},Ie.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var c=this._state,h=St.indexOf(this);if(0<=h&&St.splice(h,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}c.isBeingOpened||(c.dbReadyPromise=new fe(function(f){c.dbReadyResolve=f}),c.openCanceller=new fe(function(f,g){c.cancelOpen=g}))},Ie.prototype.close=function(f){var h=(f===void 0?{disableAutoOpen:!0}:f).disableAutoOpen,f=this._state;h?(f.isBeingOpened&&f.cancelOpen(new pe.DatabaseClosed),this._close(),f.autoOpen=!1,f.dbOpenError=new pe.DatabaseClosed):(this._close(),f.autoOpen=this._options.autoOpen||f.isBeingOpened,f.openComplete=!1,f.dbOpenError=null)},Ie.prototype.delete=function(c){var h=this;c===void 0&&(c={disableAutoOpen:!0});var f=0<arguments.length&&typeof arguments[0]!="object",g=this._state;return new fe(function(m,v){function E(){h.close(c);var S=h._deps.indexedDB.deleteDatabase(h.name);S.onsuccess=$e(function(){var N,C,D;N=h._deps,C=h.name,D=N.indexedDB,N=N.IDBKeyRange,Bn(D)||C===Yt||On(D,N).delete(C).catch(xe),m()}),S.onerror=Je(v),S.onblocked=h._fireOnBlocked}if(f)throw new pe.InvalidArgument("Invalid closeOptions argument to db.delete()");g.isBeingOpened?g.dbReadyPromise.then(E):E()})},Ie.prototype.backendDB=function(){return this.idbdb},Ie.prototype.isOpen=function(){return this.idbdb!==null},Ie.prototype.hasBeenClosed=function(){var c=this._state.dbOpenError;return c&&c.name==="DatabaseClosed"},Ie.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ie.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ie.prototype,"tables",{get:function(){var c=this;return a(this._allTables).map(function(h){return c._allTables[h]})},enumerable:!1,configurable:!0}),Ie.prototype.transaction=function(){var c=function(h,f,g){var m=arguments.length;if(m<2)throw new pe.InvalidArgument("Too few arguments");for(var v=new Array(m-1);--m;)v[m-1]=arguments[m];return g=v.pop(),[h,me(v),g]}.apply(this,arguments);return this._transaction.apply(this,c)},Ie.prototype._transaction=function(c,h,f){var g=this,m=be.trans;m&&m.db===this&&c.indexOf("!")===-1||(m=null);var v,E,S=c.indexOf("?")!==-1;c=c.replace("!","").replace("?","");try{if(E=h.map(function(C){if(C=C instanceof g.Table?C.name:C,typeof C!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return C}),c=="r"||c===An)v=An;else{if(c!="rw"&&c!=Rn)throw new pe.InvalidArgument("Invalid transaction mode: "+c);v=Rn}if(m){if(m.mode===An&&v===Rn){if(!S)throw new pe.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");m=null}m&&E.forEach(function(C){if(m&&m.storeNames.indexOf(C)===-1){if(!S)throw new pe.SubTransaction("Table "+C+" not included in parent transaction.");m=null}}),S&&m&&!m.active&&(m=null)}}catch(C){return m?m._promise(null,function(D,R){R(C)}):Pe(C)}var N=function C(D,R,U,$,P){return fe.resolve().then(function(){var I=be.transless||be,K=D._createTransaction(R,U,D._dbSchema,$);if(K.explicit=!0,I={trans:K,transless:I},$)K.idbtrans=$.idbtrans;else try{K.create(),K.idbtrans._explicit=!0,D._state.PR1398_maxLoop=3}catch(q){return q.name===De.InvalidState&&D.isOpen()&&0<--D._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),D.close({disableAutoOpen:!1}),D.open().then(function(){return C(D,R,U,null,P)})):Pe(q)}var L,M=X(P);return M&&kt(),I=fe.follow(function(){var q;(L=P.call(K,K))&&(M?(q=nt.bind(null,null),L.then(q,q)):typeof L.next=="function"&&typeof L.throw=="function"&&(L=Wn(L)))},I),(L&&typeof L.then=="function"?fe.resolve(L).then(function(q){return K.active?q:Pe(new pe.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):I.then(function(){return L})).then(function(q){return $&&K._resolve(),K._completion.then(function(){return q})}).catch(function(q){return K._reject(q),Pe(q)})})}.bind(null,this,v,E,m,f);return m?m._promise(v,N,"lock"):be.trans?dt(be.transless,function(){return g._whenReady(N)}):this._whenReady(N)},Ie.prototype.table=function(c){if(!b(this._allTables,c))throw new pe.InvalidTable("Table ".concat(c," does not exist"));return this._allTables[c]},Ie);function Ie(c,h){var f=this;this._middlewares={},this.verno=0;var g=Ie.dependencies;this._options=h=r({addons:Ie.addons,autoOpen:!0,indexedDB:g.indexedDB,IDBKeyRange:g.IDBKeyRange,cache:"cloned"},h),this._deps={indexedDB:h.indexedDB,IDBKeyRange:h.IDBKeyRange},g=h.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var m,v,E,S,N,C={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:xe,dbReadyPromise:null,cancelOpen:xe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:h.autoOpen};C.dbReadyPromise=new fe(function(R){C.dbReadyResolve=R}),C.openCanceller=new fe(function(R,U){C.cancelOpen=U}),this._state=C,this.name=c,this.on=Dt(this,"populate","blocked","versionchange","close",{ready:[bn,xe]}),this.once=function(R,U){var $=function(){for(var P=[],I=0;I<arguments.length;I++)P[I]=arguments[I];f.on(R).unsubscribe($),U.apply(f,P)};return f.on(R,$)},this.on.ready.subscribe=z(this.on.ready.subscribe,function(R){return function(U,$){Ie.vip(function(){var P,I=f._state;I.openComplete?(I.dbOpenError||fe.resolve().then(U),$&&R(U)):I.onReadyBeingFired?(I.onReadyBeingFired.push(U),$&&R(U)):(R(U),P=f,$||R(function K(){P.on.ready.unsubscribe(U),P.on.ready.unsubscribe(K)}))})}}),this.Collection=(m=this,Kt($i.prototype,function(L,K){this.db=m;var $=lr,P=null;if(K)try{$=K()}catch(M){P=M}var I=L._ctx,K=I.table,L=K.hook.reading.fire;this._ctx={table:K,index:I.index,isPrimKey:!I.index||K.schema.primKey.keyPath&&I.index===K.schema.primKey.name,range:$,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:P,or:I.or,valueMapper:L!==je?L:null}})),this.Table=(v=this,Kt(yr.prototype,function(R,U,$){this.db=v,this._tx=$,this.name=R,this.schema=U,this.hook=v._allTables[R]?v._allTables[R].hook:Dt(null,{creating:[Ei,xe],reading:[Qe,je],updating:[Si,xe],deleting:[ki,xe]})})),this.Transaction=(E=this,Kt(Di.prototype,function(R,U,$,P,I){var K=this;R!=="readonly"&&U.forEach(function(L){L=(L=$[L])===null||L===void 0?void 0:L.yProps,L&&(U=U.concat(L.map(function(M){return M.updatesTable})))}),this.db=E,this.mode=R,this.storeNames=U,this.schema=$,this.chromeTransactionDurability=P,this.idbtrans=null,this.on=Dt(this,"complete","error","abort"),this.parent=I||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new fe(function(L,M){K._resolve=L,K._reject=M}),this._completion.then(function(){K.active=!1,K.on.complete.fire()},function(L){var M=K.active;return K.active=!1,K.on.error.fire(L),K.parent?K.parent._reject(L):M&&K.idbtrans&&K.idbtrans.abort(),Pe(L)})})),this.Version=(S=this,Kt(Mi.prototype,function(R){this.db=S,this._cfg={version:R,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(N=this,Kt(wr.prototype,function(R,U,$){if(this.db=N,this._ctx={table:R,index:U===":id"?null:U,or:$},this._cmp=this._ascending=Te,this._descending=function(P,I){return Te(I,P)},this._max=function(P,I){return 0<Te(P,I)?P:I},this._min=function(P,I){return Te(P,I)<0?P:I},this._IDBKeyRange=N._deps.IDBKeyRange,!this._IDBKeyRange)throw new pe.MissingAPI})),this.on("versionchange",function(R){0<R.newVersion?console.warn("Another connection wants to upgrade database '".concat(f.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(f.name,"'. Closing db now to resume the delete request.")),f.close({disableAutoOpen:!1})}),this.on("blocked",function(R){!R.newVersion||R.newVersion<R.oldVersion?console.warn("Dexie.delete('".concat(f.name,"') was blocked")):console.warn("Upgrade '".concat(f.name,"' blocked by other connection holding version ").concat(R.oldVersion/10))}),this._maxKey=Ot(h.IDBKeyRange),this._createTransaction=function(R,U,$,P){return new f.Transaction(R,U,$,f._options.chromeTransactionDurability,P)},this._fireOnBlocked=function(R){f.on("blocked").fire(R),St.filter(function(U){return U.name===f.name&&U!==f&&!U._state.vcFired}).map(function(U){return U.on("versionchange").fire(R)})},this.use(ji),this.use(Ji),this.use(Wi),this.use(Vi),this.use(zi);var D=new Proxy(this,{get:function(R,U,$){if(U==="_vip")return!0;if(U==="table")return function(I){return dn(f.table(I),D)};var P=Reflect.get(R,U,$);return P instanceof yr?dn(P,D):U==="tables"?P.map(function(I){return dn(I,D)}):U==="_createTransaction"?function(){return dn(P.apply(this,arguments),D)}:P}});this.vip=D,g.forEach(function(R){return R(f)})}var fn,ze=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Yi=(Yn.prototype.subscribe=function(c,h,f){return this._subscribe(c&&typeof c!="function"?c:{next:c,error:h,complete:f})},Yn.prototype[ze]=function(){return this},Yn);function Yn(c){this._subscribe=c}try{fn={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{fn={indexedDB:null,IDBKeyRange:null}}function Kr(c){var h,f=!1,g=new Yi(function(m){var v=X(c),E,S=!1,N={},C={},D={get closed(){return S},unsubscribe:function(){S||(S=!0,E&&E.abort(),R&&st.storagemutated.unsubscribe($))}};m.start&&m.start(D);var R=!1,U=function(){return Tn(P)},$=function(I){ln(N,I),Hn(C,N)&&U()},P=function(){var I,K,L;!S&&fn.indexedDB&&(N={},I={},E&&E.abort(),E=new AbortController,L=function(M){var q=_t();try{v&&kt();var Y=tt(c,M);return Y=v?Y.finally(nt):Y}finally{q&&Et()}}(K={subscr:I,signal:E.signal,requery:U,querier:c,trans:null}),Promise.resolve(L).then(function(M){f=!0,h=M,S||K.signal.aborted||(N={},function(q){for(var Y in q)if(b(q,Y))return;return 1}(C=I)||R||(st(Ft,$),R=!0),Tn(function(){return!S&&m.next&&m.next(M)}))},function(M){f=!1,["DatabaseClosedError","AbortError"].includes(M?.name)||S||Tn(function(){S||m.error&&m.error(M)})}))};return setTimeout(U,0),D});return g.hasValue=function(){return f},g.getValue=function(){return h},g}var gt=Xe;function Zn(c){var h=ot;try{ot=!0,st.storagemutated.fire(c),jn(c,!0)}finally{ot=h}}w(gt,r(r({},We),{delete:function(c){return new gt(c,{addons:[]}).delete()},exists:function(c){return new gt(c,{addons:[]}).open().then(function(h){return h.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(c){try{return h=gt.dependencies,f=h.indexedDB,h=h.IDBKeyRange,(Bn(f)?Promise.resolve(f.databases()).then(function(g){return g.map(function(m){return m.name}).filter(function(m){return m!==Yt})}):On(f,h).toCollection().primaryKeys()).then(c)}catch{return Pe(new pe.MissingAPI)}var h,f},defineClass:function(){return function(c){u(this,c)}},ignoreTransaction:function(c){return be.trans?dt(be.transless,c):c()},vip:Ln,async:function(c){return function(){try{var h=Wn(c.apply(this,arguments));return h&&typeof h.then=="function"?h:fe.resolve(h)}catch(f){return Pe(f)}}},spawn:function(c,h,f){try{var g=Wn(c.apply(f,h||[]));return g&&typeof g.then=="function"?g:fe.resolve(g)}catch(m){return Pe(m)}},currentTransaction:{get:function(){return be.trans||null}},waitFor:function(c,h){return h=fe.resolve(typeof c=="function"?gt.ignoreTransaction(c):c).timeout(h||6e4),be.trans?be.trans.waitFor(h):h},Promise:fe,debug:{get:function(){return Ge},set:function(c){nr(c)}},derive:T,extend:u,props:w,override:z,Events:Dt,on:st,liveQuery:Kr,extendObservabilitySet:ln,getByKeyPath:ie,setByKeyPath:te,delByKeyPath:function(c,h){typeof h=="string"?te(c,h,void 0):"length"in h&&[].map.call(h,function(f){te(c,f,void 0)})},shallowClone:oe,deepClone:j,getObjectDiff:qn,cmp:Te,asap:ye,minKey:-1/0,addons:[],connections:St,errnames:De,dependencies:fn,cache:yt,semVer:"4.2.1",version:"4.2.1".split(".").map(function(c){return parseInt(c)}).reduce(function(c,h,f){return c+h/Math.pow(10,2*f)})})),gt.maxKey=Ot(gt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(st(Ft,function(c){ot||(c=new CustomEvent($n,{detail:c}),ot=!0,dispatchEvent(c),ot=!1)}),addEventListener($n,function(c){c=c.detail,ot||Zn(c)}));var Rt,ot=!1,Ur=function(){};return typeof BroadcastChannel<"u"&&((Ur=function(){(Rt=new BroadcastChannel($n)).onmessage=function(c){return c.data&&Zn(c.data)}})(),typeof Rt.unref=="function"&&Rt.unref(),st(Ft,function(c){ot||Rt.postMessage(c)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(c){if(!Xe.disableBfCache&&c.persisted){Ge&&console.debug("Dexie: handling persisted pagehide"),Rt?.close();for(var h=0,f=St;h<f.length;h++)f[h].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(c){!Xe.disableBfCache&&c.persisted&&(Ge&&console.debug("Dexie: handling persisted pageshow"),Ur(),Zn({all:new Oe(-1/0,[[]])}))})),fe.rejectionMapper=function(c,h){return!c||c instanceof ve||c instanceof TypeError||c instanceof SyntaxError||!c.name||!wt[c.name]?c:(h=new wt[c.name](h||c.message,c),"stack"in c&&x(h,"stack",{get:function(){return this.inner.stack}}),h)},nr(Ge),r(Xe,Object.freeze({__proto__:null,Dexie:Xe,liveQuery:Kr,Entity:ur,cmp:Te,PropModification:It,replacePrefix:function(c,h){return new It({replacePrefix:[c,h]})},add:function(c){return new It({add:c})},remove:function(c){return new It({remove:c})},default:Xe,RangeSet:Oe,mergeRanges:Mt,rangesOverlap:xr}),{default:Xe}),Xe})})(dexie_min);var dexie_minExports=dexie_min.exports;const _Dexie=getDefaultExportFromCjs(dexie_minExports),DexieSymbol=Symbol.for("Dexie"),Dexie=globalThis[DexieSymbol]||(globalThis[DexieSymbol]=_Dexie);if(_Dexie.semVer!==Dexie.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${_Dexie.semVer} and ${Dexie.semVer}`);const{liveQuery,mergeRanges,rangesOverlap,RangeSet,cmp,Entity,PropModification,replacePrefix,add,remove,DexieYProvider}=Dexie;async function eventTagsWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.add(r.tagValue,r.eventId,!1)}var eventTagsDump=(t,e)=>async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);if(a)for(const l of a)s.push({tagValue:o,eventId:l})}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await t.bulkPut(s)),n.clear()};async function eventsWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.id,r,!1)}var eventsDump=(t,e)=>async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);a&&s.push(a)}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await t.bulkPut(s)),n.clear()};async function nip05WarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.nip05,r,!1)}var nip05Dump=(t,e)=>async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);a&&s.push({nip05:o,...a})}s.length&&(e(`Saving ${s.length} NIP-05 cache entries to database`),await t.bulkPut(s)),n.clear()},Database=class extends Dexie{profiles;events;eventTags;nip05;lnurl;relayStatus;unpublishedEvents;constructor(t){super(t),this.version(15).stores({profiles:"&pubkey",events:"&id, kind",eventTags:"&tagValue",nip05:"&nip05",lnurl:"&pubkey",relayStatus:"&url",unpublishedEvents:"&id"})}},db;function createDatabase(t){db=new Database(t)}var d=createDebug2("ndk:dexie-adapter:profiles");async function profilesWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n){const s=r;t.set(r.pubkey,s,!1)}d("Loaded %d profiles from database",t.size())}var profilesDump=(t,e)=>async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);a&&s.push(a)}s.length&&(e(`Saving ${s.length} users to database`),await t.bulkPut(s)),n.clear()};async function relayInfoWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.url,{url:r.url,updatedAt:r.updatedAt,lastConnectedAt:r.lastConnectedAt,dontConnectBefore:r.dontConnectBefore},!1)}var relayInfoDump=(t,e)=>async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);a&&s.push({url:o,updatedAt:a.updatedAt,lastConnectedAt:a.lastConnectedAt,dontConnectBefore:a.dontConnectBefore})}s.length>0&&(e(`Saving ${s.length} relay status cache entries to database`),await t.bulkPut(s)),n.clear()},WRITE_STATUS_THRESHOLD=3;async function unpublishedEventsWarmUp(t,e){await e.each(n=>{t.set(n.event.id,n,!1)})}function unpublishedEventsDump(t,e){return async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);a&&s.push(a)}s.length>0&&(e(`Saving ${s.length} unpublished events cache entries to database`),await t.bulkPut(s)),n.clear()}}async function discardUnpublishedEvent(t,e){await t.delete(e)}async function getUnpublishedEvents(t){const e=[];return await t.each(n=>{e.push({event:new NDKEvent(void 0,n.event),relays:Object.keys(n.relays),lastTryAt:n.lastTryAt})}),e}function addUnpublishedEvent(t,e){const n={};e.forEach(s=>n[s]=!1),this.unpublishedEvents.set(t.id,{id:t.id,event:t.rawEvent(),relays:n});const r=s=>{const o=s.url,a=this.unpublishedEvents.get(t.id);if(!a){t.off("publushed",r);return}a.relays[o]=!0,this.unpublishedEvents.set(t.id,a);const l=Object.values(a.relays).filter(p=>p).length,u=Object.values(a.relays).length-l;(l>=WRITE_STATUS_THRESHOLD||u===0)&&(this.unpublishedEvents.delete(t.id),t.off("published",r))};t.on("published",r)}async function zapperWarmUp(t,e){const n=await e.limit(t.maxSize).toArray();for(const r of n)t.set(r.pubkey,{document:r.document,fetchedAt:r.fetchedAt},!1)}var zapperDump=(t,e)=>async(n,r)=>{const s=[];for(const o of n){const a=r.get(o);a&&s.push({pubkey:o,...a})}s.length&&(e(`Saving ${s.length} zapper cache entries to database`),await t.bulkPut(s)),n.clear()},CacheHandler=class{cache;dirtyKeys=new Set;options;debug;indexes;isSet=!1;maxSize=0;constructor(t){this.debug=t.debug,this.options=t,this.maxSize=t.maxSize,t.maxSize>0&&(this.cache=new dist.LRUCache({maxSize:t.maxSize}),setInterval(()=>this.dump().catch(console.error),1e3*10)),this.indexes=new Map}getSet(t){return this.cache?.get(t)}getAllWithFilter(t){const e=new Map;return this.cache?.forEach((n,r)=>{t(r,n)&&e.set(r,n)}),e}get(t){return this.cache?.get(t)}async getWithFallback(t,e){let n=this.get(t);return n||(n=await e.get(t),n&&this.set(t,n)),n}async getManyWithFallback(t,e){const n=[],r=[];for(const s of t){const o=this.get(s);o?n.push(o):r.push(s)}if(n.length>0&&this.debug(`Cache hit for keys ${n.length} and miss for ${r.length} keys`),r.length>0){const s=Date.now(),o=await e.bulkGet(r),a=Date.now();let l=0;for(const u of o)u&&(this.set(u.id,u),n.push(u),l++);this.debug(`Time spent querying database: ${a-s}ms for ${r.length} keys, which added ${l} entries to the cache`)}return n}add(t,e,n=!0){const r=this.get(t)??new Set;r.add(e),this.cache?.set(t,r),n&&this.dirtyKeys.add(t)}set(t,e,n=!0){this.cache?.set(t,e),n&&this.dirtyKeys.add(t);for(const[r,s]of this.indexes.entries()){const o=e[r];if(o){const a=s.get(o)||new Set;a.add(t),s.set(o,a)}}}size(){return this.cache?.size||0}delete(t){this.cache?.delete(t),this.dirtyKeys.add(t)}async dump(){this.dirtyKeys.size>0&&this.cache&&(await this.options.dump(this.dirtyKeys,this.cache),this.dirtyKeys.clear())}addIndex(t){this.indexes.set(t,new dist.LRUCache({maxSize:this.options.maxSize}))}getFromIndex(t,e){const n=new Set,r=this.indexes.get(t);if(r){const s=r.get(e);if(s)for(const o of s.values()){const a=this.get(o);a&&n.add(a)}}return n}},INDEXABLE_TAGS_LIMIT=10,NDKCacheAdapterDexie=class{debug;locking=!1;ready=!1;profiles;zappers;nip05s;events;eventTags;relayInfo;unpublishedEvents;warmedUp=!1;warmUpPromise;devMode=!1;saveSig;_onReady;constructor(t={}){createDatabase(t.dbName||"ndk"),this.debug=t.debug||createDebug2("ndk:dexie-adapter"),this.saveSig=t.saveSig||!1,this.profiles=new CacheHandler({maxSize:t.profileCacheSize||1e5,dump:profilesDump(db.profiles,this.debug),debug:this.debug}),this.zappers=new CacheHandler({maxSize:t.zapperCacheSize||200,dump:zapperDump(db.lnurl,this.debug),debug:this.debug}),this.nip05s=new CacheHandler({maxSize:t.nip05CacheSize||1e3,dump:nip05Dump(db.nip05,this.debug),debug:this.debug}),this.events=new CacheHandler({maxSize:t.eventCacheSize||5e4,dump:eventsDump(db.events,this.debug),debug:this.debug}),this.events.addIndex("pubkey"),this.events.addIndex("kind"),this.eventTags=new CacheHandler({maxSize:t.eventTagsCacheSize||1e5,dump:eventTagsDump(db.eventTags,this.debug),debug:this.debug}),this.relayInfo=new CacheHandler({maxSize:500,debug:this.debug,dump:relayInfoDump(db.relayStatus,this.debug)}),this.unpublishedEvents=new CacheHandler({maxSize:5e3,debug:this.debug,dump:unpublishedEventsDump(db.unpublishedEvents,this.debug)});const e=(r,s)=>{const o=Date.now();return s().then(()=>{const a=Date.now();this.debug(r,"took",a-o,"ms")})},n=Date.now();this.warmUpPromise=Promise.allSettled([e("profilesWarmUp",()=>profilesWarmUp(this.profiles,db.profiles)),e("zapperWarmUp",()=>zapperWarmUp(this.zappers,db.lnurl)),e("nip05WarmUp",()=>nip05WarmUp(this.nip05s,db.nip05)),e("relayInfoWarmUp",()=>relayInfoWarmUp(this.relayInfo,db.relayStatus)),e("unpublishedEventsWarmUp",()=>unpublishedEventsWarmUp(this.unpublishedEvents,db.unpublishedEvents)),e("eventsWarmUp",()=>eventsWarmUp(this.events,db.events)),e("eventTagsWarmUp",()=>eventTagsWarmUp(this.eventTags,db.eventTags))]),this.warmUpPromise.then(()=>{const r=Date.now();this.warmedUp=!0,this.ready=!0,this.locking=!0,this.debug("Warm up completed, time",r-n,"ms"),this._onReady&&this._onReady()})}onReady(t){this._onReady=t}async query(t){if(!this.warmedUp){const r=Date.now();await this.warmUpPromise,this.debug("froze query for",Date.now()-r,"ms",t.filters)}const e=Date.now();t.filters.map(r=>this.processFilter(r,t));const n=Date.now()-e;return n>100&&this.debug("query took",n,"ms",t.filter),[]}async fetchProfile(t){return this.profiles?await this.profiles.getWithFallback(t,db.profiles):null}fetchProfileSync(t){return this.profiles?this.profiles.get(t):null}async getProfiles(t){if(this.profiles)return this.profiles.getAllWithFilter(t)}saveProfile(t,e){const n=this.profiles.get(t);if(n?.created_at&&e.created_at&&n.created_at>=e.created_at)return;const r=Math.floor(Date.now()/1e3);this.profiles.set(t,{pubkey:t,...e,cachedAt:r}),this.debug("Saved profile for pubkey",t,e)}async loadNip05(t,e=3600){const n=this.nip05s?.get(t);if(n){if(n.profile===null)return n.fetchedAt+e*1e3<Date.now()?"missing":null;try{return JSON.parse(n.profile)}catch{return"missing"}}const r=await db.nip05.get({nip05:t});if(!r)return"missing";const s=Date.now();if(r.profile===null)return r.fetchedAt+e*1e3<s?"missing":null;try{return JSON.parse(r.profile)}catch{return"missing"}}async saveNip05(t,e){try{const n=e?JSON.stringify(e):null;this.nip05s.set(t,{profile:n,fetchedAt:Date.now()})}catch(n){console.error("Failed to save NIP-05 profile for nip05:",t,n)}}async loadUsersLNURLDoc(t,e=86400,n=3600){const r=this.zappers?.get(t);if(r){if(r.document===null)return r.fetchedAt+n*1e3<Date.now()?"missing":null;try{return JSON.parse(r.document)}catch{return"missing"}}const s=await db.lnurl.get({pubkey:t});if(!s)return"missing";const o=Date.now();if(s.fetchedAt+e*1e3<o)return"missing";if(s.document===null)return s.fetchedAt+n*1e3<o?"missing":null;try{return JSON.parse(s.document)}catch{return"missing"}}async saveUsersLNURLDoc(t,e){try{const n=e?JSON.stringify(e):null;this.zappers?.set(t,{document:n,fetchedAt:Date.now()})}catch(n){console.error("Failed to save LNURL document for pubkey:",t,n)}}processFilter(t,e){const n={...t};n.limit=void 0;const r=new Set(Object.keys(n||{}));r.delete("since"),r.delete("limit"),r.delete("until");try{if(this.byNip33Query(r,t,e)||this.byAuthors(t,e)||this.byIdsQuery(t,e)||this.byTags(t,e)||this.byKinds(r,t,e))return}catch(s){console.error(s)}}async deleteEventIds(t){t.forEach(e=>this.events.delete(e)),await db.events.where({id:t}).delete()}addUnpublishedEvent=addUnpublishedEvent.bind(this);getUnpublishedEvents=()=>getUnpublishedEvents(db.unpublishedEvents);discardUnpublishedEvent=t=>discardUnpublishedEvent(db.unpublishedEvents,t);async setEvent(t,e,n){if(t.kind===0){if(!this.profiles)return;try{const s=profileFromEvent(t);this.saveProfile(t.pubkey,s)}catch{this.debug(`Failed to save profile for pubkey: ${t.pubkey}`)}}let r=!0;if(t.isParamReplaceable()){const s=this.events.get(t.tagId());s&&t.created_at&&s.createdAt>t.created_at&&(r=!1)}if(r){const s={id:t.tagId(),pubkey:t.pubkey,kind:t.kind,createdAt:t.created_at??Date.now(),relay:n?.url,event:t.serialize(this.saveSig,!0)};this.saveSig&&t.sig&&(s.sig=t.sig),this.events.set(t.tagId(),s);const o=getIndexableTags(t);for(const a of o)this.eventTags.add(a[0]+a[1],t.tagId())}}updateRelayStatus(t,e){const n={url:t,updatedAt:Date.now(),...e};this.relayInfo.set(t,n)}getRelayStatus(t){const e=this.relayInfo.get(t);if(e)return{lastConnectedAt:e.lastConnectedAt,dontConnectBefore:e.dontConnectBefore}}byAuthors(t,e){if(!t.authors)return!1;let n=0;for(const r of t.authors){let s=Array.from(this.events.getFromIndex("pubkey",r));t.kinds&&(s=s.filter(o=>t.kinds?.includes(o.kind))),foundEvents(e,s,t),n+=s.length}return!0}byIdsQuery(t,e){if(t.ids){for(const n of t.ids){const r=this.events.get(n);r&&foundEvent(e,r,r.relay,t)}return!0}return!1}byNip33Query(t,e,n){const r=["#d","authors","kinds"];if(t.size===r.length&&r.every(o=>t.has(o))&&e.kinds&&e.authors){for(const o of e.kinds)if(o>=3e4&&o<4e4)for(const l of e.authors)for(const u of e["#d"]){const p=`${o}:${l}:${u}`,y=this.events.get(p);y&&foundEvent(n,y,y.relay,e)}return!0}return!1}byTags(t,e){const n=Object.entries(t).filter(([r])=>r.startsWith("#")&&r.length===2).map(([r,s])=>[r[1],s]);if(n.length===0)return!1;for(const[r,s]of n)for(const o of s){const a=r+o,l=this.eventTags.getSet(a);l&&l.forEach(u=>{const p=this.events.get(u);p&&(!t.kinds||t.kinds.includes(p.kind))&&foundEvent(e,p,p.relay,t)})}return!0}byKinds(t,e,n){if(!e.kinds||t.size!==1||!t.has("kinds"))return!1;const r=e.limit||500;let s=0;const o=new Set,a=[...e.kinds].sort((l,u)=>(this.events.indexes.get("kind")?.get(l)?.size||0)-(this.events.indexes.get("kind")?.get(u)?.size||0));for(const l of a){const u=this.events.getFromIndex("kind",l);for(const p of u)if(!o.has(p.id)&&(o.add(p.id),foundEvent(n,p,p.relay,e),s++,s>=r))break;if(s>=r)break}return!0}};function foundEvents(t,e,n){n?.limit&&e.length>n.limit&&(e=e.sort((r,s)=>s.createdAt-r.createdAt).slice(0,n.limit));for(const r of e)foundEvent(t,r,r.relay,n)}function foundEvent(t,e,n,r){try{const s=deserialize(e.event);if(r&&!matchFilter(r,s))return;const o=new NDKEvent(void 0,s),a=n?t.pool.getRelay(n,!1):void 0;o.relay=a,t.eventReceived(o,a,!0)}catch(s){console.error("failed to deserialize event",s)}}function getIndexableTags(t){const e=[];if(t.kind===3)return[];for(const n of t.tags)if(n[0].length===1&&(e.push(n),e.length>=INDEXABLE_TAGS_LIMIT))return[];return e}const STORAGE_KEY$2="Nostr-BBS-settings",PRIVATE_RELAY_URL="wss://nostr-relay-617806532906.us-central1.run.app";function getPrivateRelayUrl(){return PRIVATE_RELAY_URL}function getDefaultSettings(){return{relayMode:"private",privateRelayUrl:getPrivateRelayUrl(),federatedRelays:["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol","wss://relay.primal.net"]}}function loadSettings(){try{const t=localStorage.getItem(STORAGE_KEY$2);if(t){const e=JSON.parse(t);return{...getDefaultSettings(),...e,privateRelayUrl:getPrivateRelayUrl()}}}catch(t){console.error("Failed to load settings:",t)}return getDefaultSettings()}function saveSettings(t){try{localStorage.setItem(STORAGE_KEY$2,JSON.stringify(t))}catch(e){console.error("Failed to save settings:",e)}}function createSettingsStore(){const{subscribe:t,set:e,update:n}=writable(getDefaultSettings());return e(loadSettings()),{subscribe:t,setRelayMode:r=>{n(s=>{const o={...s,relayMode:r};return saveSettings(o),o})},setPrivateRelayUrl:r=>{n(s=>{const o={...s,privateRelayUrl:r};return saveSettings(o),o})},setFederatedRelays:r=>{n(s=>{const o={...s,federatedRelays:r};return saveSettings(o),o})},reset:()=>{const r=getDefaultSettings();e(r),saveSettings(r)}}}const settingsStore=createSettingsStore();function getActiveRelays(){const t=get_store_value(settingsStore);return t.relayMode==="private"?[getPrivateRelayUrl()]:t.federatedRelays}let ndkInstance=null,isConnected=!1,currentRelayUrls=[];function getNDK(){const t=getActiveRelays(),e=JSON.stringify(t)!==JSON.stringify(currentRelayUrls);if(!ndkInstance||e){if(ndkInstance&&isConnected){try{ndkInstance.pool.relays.forEach(r=>r.disconnect())}catch(r){console.warn("Error disconnecting old NDK instance:",r)}isConnected=!1}const n=new NDKCacheAdapterDexie({dbName:"Nostr-BBS-cache"});ndkInstance=new NDK({explicitRelayUrls:t,cacheAdapter:n}),currentRelayUrls=[...t]}return ndkInstance}getNDK();async function connectNDK(){const t=getNDK();isConnected||(await t.connect(),isConnected=!0)}function setNip07Signer(){const t=getNDK(),e=new NDKNip07Signer$1;t.signer=e}function clearSigner(){ndkInstance&&(ndkInstance.signer=void 0)}settingsStore.subscribe(()=>{const t=getActiveRelays();JSON.stringify(t)!==JSON.stringify(currentRelayUrls)&&console.log("Relay configuration changed, will reconnect on next operation")});const initialState={state:"unauthenticated",pubkey:null,isAuthenticated:!1,publicKey:null,privateKey:null,nickname:null,avatar:null,isPending:!1,error:null,isEncrypted:!1,accountStatus:"incomplete",nsecBackedUp:!1,isReady:!1,isNip07:!1,extensionName:null},STORAGE_KEY$1="nostr_bbs_keys",SESSION_KEY="nostr_bbs_session",COOKIE_KEY="nostr_bbs_auth",KEEP_SIGNED_IN_KEY="nostr_bbs_keep_signed_in",PWA_AUTH_KEY="nostr_bbs_pwa_auth";function isRunningAsPWA(){return get_store_value(isPWAInstalled)||checkIfPWA()||localStorage.getItem("nostr_bbs_pwa_mode")==="true"}function setCookie(t,e,n){const r=new Date(Date.now()+n*24*60*60*1e3).toUTCString();document.cookie=`${t}=${encodeURIComponent(e)}; expires=${r}; path=/; SameSite=Strict; Secure`}function deleteCookie(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict; Secure`}function shouldKeepSignedIn(){return localStorage.getItem(KEEP_SIGNED_IN_KEY)!=="false"}function getSessionKey(){let t=sessionStorage.getItem(SESSION_KEY);if(!t){const e=new Uint8Array(32);crypto.getRandomValues(e),t=btoa(String.fromCharCode(...e)),sessionStorage.setItem(SESSION_KEY,t)}return t}function createAuthStore(){const{subscribe:t,set:e,update:n}=writable(initialState);let r=null;function s(a){const l={...a};return a.isAuthenticated!==void 0&&(l.state=a.isAuthenticated?"authenticated":"unauthenticated"),a.publicKey!==void 0&&(l.pubkey=a.publicKey),l}async function o(){const a=localStorage.getItem(PWA_AUTH_KEY);if(a&&isRunningAsPWA())try{const u=JSON.parse(a);if(u.publicKey&&u.privateKey){console.log("[Auth] Restoring PWA persistent session"),n(p=>({...p,...s({publicKey:u.publicKey,privateKey:u.privateKey,nickname:u.nickname||null,avatar:u.avatar||null,isAuthenticated:!0,isEncrypted:!1,nsecBackedUp:u.nsecBackedUp||!1,isReady:!0})}));return}}catch{}const l=localStorage.getItem(STORAGE_KEY$1);if(!l){n(u=>({...u,...s({isReady:!0})}));return}try{const u=JSON.parse(l);if(u.isNip07){if(await waitForNip07(1e3))try{if(await getPublicKeyFromExtension()===u.publicKey){setNip07Signer(),n(b=>({...b,...s({publicKey:u.publicKey,privateKey:null,nickname:u.nickname||null,avatar:u.avatar||null,isAuthenticated:!0,isEncrypted:!1,accountStatus:u.accountStatus||"complete",nsecBackedUp:!0,isNip07:!0,extensionName:getExtensionName(),isReady:!0})}));return}}catch{}n(y=>({...y,...s({publicKey:u.publicKey,nickname:u.nickname||null,avatar:u.avatar||null,isAuthenticated:!1,isNip07:!1,error:"Nostr extension not detected. Please unlock your extension or login with nsec.",isReady:!0})}));return}if(u.encryptedPrivateKey&&isEncryptionAvailable()){const p=getSessionKey();try{const y=await decryptPrivateKey(u.encryptedPrivateKey,p);n(b=>({...b,...s({publicKey:u.publicKey,privateKey:y,nickname:u.nickname||null,avatar:u.avatar||null,isAuthenticated:!0,isEncrypted:!0,accountStatus:u.accountStatus||"incomplete",nsecBackedUp:u.nsecBackedUp||!1,isReady:!0})}))}catch{isRunningAsPWA()&&u.publicKey?n(y=>({...y,...s({publicKey:u.publicKey,nickname:u.nickname||null,avatar:u.avatar||null,isAuthenticated:!1,isEncrypted:!0,error:"Please unlock to enable persistent PWA login.",isReady:!0})})):n(y=>({...y,...s({publicKey:u.publicKey,nickname:u.nickname||null,avatar:u.avatar||null,isAuthenticated:!1,isEncrypted:!0,error:"Session expired. Please enter your password to unlock.",isReady:!0})}))}}else u.privateKey?n(p=>({...p,...s({...u,isAuthenticated:!0,isEncrypted:!1,accountStatus:u.accountStatus||"incomplete",nsecBackedUp:u.nsecBackedUp||!1,isReady:!0})})):n(p=>({...p,...s({isReady:!0})}))}catch{localStorage.removeItem(STORAGE_KEY$1),n(u=>({...u,...s({isReady:!0})}))}}return r=o(),{subscribe:t,waitForReady:()=>r||Promise.resolve(),loginWithExtension:async()=>{if(!await waitForNip07(2e3))throw new Error("No NIP-07 extension found. Please install Alby, nos2x, or another Nostr signer.");try{const l=await getPublicKeyFromExtension(),u=getExtensionName(),p={publicKey:l,isNip07:!0,extensionName:u,accountStatus:"complete",nsecBackedUp:!0};return localStorage.setItem(STORAGE_KEY$1,JSON.stringify(p)),setNip07Signer(),n(y=>({...y,...s({publicKey:l,privateKey:null,isAuthenticated:!0,isPending:!1,error:null,isEncrypted:!1,accountStatus:"complete",nsecBackedUp:!0,isNip07:!0,extensionName:u})})),{publicKey:l}}catch(l){const u=l instanceof Error?l.message:"Failed to connect to extension";throw n(p=>({...p,error:u})),l}},hasExtension:()=>hasNip07Extension(),setKeys:async(a,l,u="incomplete",p=!1)=>{const y=getSessionKey(),b={publicKey:a,privateKey:l,isAuthenticated:!0,isPending:!1,error:null,isEncrypted:isEncryptionAvailable(),accountStatus:u,nsecBackedUp:p};{const w=localStorage.getItem(STORAGE_KEY$1);let _={};if(w)try{_=JSON.parse(w)}catch{}const x={publicKey:a,nickname:_.nickname||null,avatar:_.avatar||null,accountStatus:u,nsecBackedUp:p};if(isEncryptionAvailable()?x.encryptedPrivateKey=await encryptPrivateKey(l,y):x.privateKey=l,localStorage.setItem(STORAGE_KEY$1,JSON.stringify(x)),shouldKeepSignedIn()&&setCookie(COOKIE_KEY,a,30),isRunningAsPWA()){const T={publicKey:a,privateKey:l,nickname:_.nickname||null,avatar:_.avatar||null,nsecBackedUp:_.nsecBackedUp||!1};localStorage.setItem(PWA_AUTH_KEY,JSON.stringify(T)),console.log("[Auth] PWA persistent auth stored")}}n(w=>({...w,...s(b)}))},confirmNsecBackup:()=>{n(a=>({...a,nsecBackedUp:!0}));{const a=localStorage.getItem(STORAGE_KEY$1);if(a)try{const l=JSON.parse(a);l.nsecBackedUp=!0,localStorage.setItem(STORAGE_KEY$1,JSON.stringify(l))}catch{}}},completeSignup:()=>{n(a=>({...a,accountStatus:"complete"}));{const a=localStorage.getItem(STORAGE_KEY$1);if(a)try{const l=JSON.parse(a);l.accountStatus="complete",localStorage.setItem(STORAGE_KEY$1,JSON.stringify(l))}catch{}}},unlock:async a=>{const l=localStorage.getItem(STORAGE_KEY$1);if(!l)return!1;try{const u=JSON.parse(l);if(!u.encryptedPrivateKey)return!1;const p=await decryptPrivateKey(u.encryptedPrivateKey,a),y=getSessionKey(),b=await encryptPrivateKey(p,y);if(u.encryptedPrivateKey=b,localStorage.setItem(STORAGE_KEY$1,JSON.stringify(u)),isRunningAsPWA()){const w={publicKey:u.publicKey,privateKey:p,nickname:u.nickname||null,avatar:u.avatar||null,nsecBackedUp:u.nsecBackedUp||!1};localStorage.setItem(PWA_AUTH_KEY,JSON.stringify(w)),console.log("[Auth] PWA persistent auth stored after unlock")}return n(w=>({...w,...s({privateKey:p,publicKey:u.publicKey,isAuthenticated:!0,error:null})})),!0}catch{return n(u=>({...u,error:"Invalid password"})),!1}},setProfile:(a,l)=>{{const u=localStorage.getItem(STORAGE_KEY$1);if(u)try{const p=JSON.parse(u);p.nickname=a,p.avatar=l,localStorage.setItem(STORAGE_KEY$1,JSON.stringify(p))}catch{}}n(u=>({...u,nickname:a,avatar:l}))},setPending:a=>{n(l=>({...l,isPending:a}))},setError:a=>{n(l=>({...l,error:a}))},clearError:()=>{n(a=>({...a,error:null}))},logout:async()=>{e(initialState);{clearSigner(),localStorage.removeItem(STORAGE_KEY$1),localStorage.removeItem(PWA_AUTH_KEY),sessionStorage.removeItem(SESSION_KEY),deleteCookie(COOKIE_KEY);const{goto:a}=await __vitePreload(async()=>{const{goto:l}=await import("./CQ8JIY5d.js").then(u=>u.n);return{goto:l}},__vite__mapDeps([0,1,2,3]),import.meta.url);a(`${base}/`)}},reset:()=>e(initialState)}}const authStore=createAuthStore(),isAuthenticated=derived(authStore,t=>t.isAuthenticated);derived(authStore,t=>t.isReady);const isReadOnly=derived(authStore,t=>t.accountStatus==="incomplete");derived(authStore,t=>t.accountStatus);const auth=Object.freeze(Object.defineProperty({__proto__:null,authStore,isAuthenticated,isReadOnly},Symbol.toStringTag,{value:"Module"})),defaultConfigYaml=`# Fairfield Multi-Tenant Configuration
# Zone-based isolation for Family, Minimoonoir, and DreamLab
# Each zone has its own branding, visibility rules, and access control

# Application metadata
app:
  name: 'DreamLab Community'
  version: '2.0.0'
  defaultPath: '/dreamlab/dreamlab-lobby'

# Superuser configuration
superuser:
  pubkey: '11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c'
  name: 'Instance Owner'
  relayUrl: 'wss://nostr-relay-617806532906.us-central1.run.app'

# Deployment URLs
deployment:
  relayUrl: 'wss://nostr-relay-617806532906.us-central1.run.app'
  embeddingApiUrl: 'https://embedding-api-617806532906.us-central1.run.app'
  gcsEmbeddingsUrl: 'https://storage.googleapis.com/minimoonoir-vectors'
  frontendUrl: 'https://dreamlab-ai.github.io/fairfield'

# Role definitions (hierarchical from lowest to highest)
roles:
  - id: 'guest'
    name: 'Guest'
    level: 0
    description: 'Basic authenticated user'

  - id: 'member'
    name: 'Member'
    level: 1
    description: 'Approved zone member'

  - id: 'moderator'
    name: 'Moderator'
    level: 2
    description: 'Can manage channels and moderate content'
    capabilities:
      - 'forum.create'
      - 'forum.delete'
      - 'message.pin'
      - 'message.delete'

  - id: 'section-admin'
    name: 'Section Admin'
    level: 3
    description: 'Administrator for a specific section'
    capabilities:
      - 'section.manage'
      - 'member.approve'
      - 'member.remove'
      - 'forum.create'
      - 'forum.delete'
      - 'message.pin'
      - 'message.delete'

  - id: 'admin'
    name: 'Admin'
    level: 4
    description: 'Global administrator with cross-zone access'
    capabilities:
      - 'admin.global'
      - 'section.create'
      - 'section.delete'
      - 'section.manage'
      - 'member.approve'
      - 'member.remove'
      - 'forum.create'
      - 'forum.delete'
      - 'message.pin'
      - 'message.delete'
      - 'user.whitelist'

# Cohort definitions - Zone membership groups
cohorts:
  # Administrative cohorts
  - id: 'admin'
    name: 'Administrators'
    description: 'Global system administrators'

  # Cross-zone access (owners who see everything)
  - id: 'cross-access'
    name: 'Cross-Zone Access'
    description: 'Users who can access all zones (owners)'

  # Zone-specific cohorts
  - id: 'family'
    name: 'Family Members'
    description: 'Direct family with access to family zone'

  - id: 'family-only'
    name: 'Family Only'
    description: 'Family members who should NOT see business content'

  - id: 'minimoonoir'
    name: 'Minimoonoir Guests'
    description: 'Friends and guests staying at Fairfield'

  - id: 'minimoonoir-only'
    name: 'Minimoonoir Only'
    description: 'Guests who should NOT see business content'

  - id: 'minimoonoir-business'
    name: 'Minimoonoir with Business Access'
    description: 'Guests who can also access business/training boards'

  - id: 'business'
    name: 'Business Partners'
    description: 'DreamLab business collaborators and trainees'

  - id: 'business-only'
    name: 'Business Only'
    description: 'Business users who should NOT see family/friends content'

  - id: 'trainers'
    name: 'Trainers'
    description: 'Training providers and facilitators'

  - id: 'trainees'
    name: 'Trainees'
    description: 'Users receiving training'

# 3-Tier Structure: Categories (Zones)  Sections  Forums
categories:
  # ============================================
  # ZONE 1: FAMILY (Completely Isolated)
  # ============================================
  - id: 'fairfield-family'
    name: 'Fairfield Family'
    description: 'Private family zone - visible only to family members'
    icon: ''
    order: 1

    # Zone-level access control
    access:
      visibleToCohorts: ['family', 'cross-access']
      hiddenFromCohorts: ['business-only']
      strictIsolation: true

    # Zone branding
    branding:
      displayName: 'Fairfield Home'
      tagline: 'Our Family Space'
      primaryColor: '#4a7c59'
      accentColor: '#8fbc8f'
      heroImageUrl: '/images/zones/family-hero.webp'
      logoUrl: '/images/zones/family-logo.webp'

    ui:
      color: '#4a7c59'

    sections:
      - id: 'family-home'
        name: 'Home'
        description: 'Main family discussion area'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['family', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['minimoonoir', 'dreamlab']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              minimoonoir: '#6366f1'
              dreamlab: '#c2410c'
        ui:
          color: '#4a7c59'
        showStats: true
        allowForumCreation: true

      - id: 'family-events'
        name: 'Family Events'
        description: 'Birthdays, gatherings, and family occasions'
        icon: ''
        order: 2
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['family', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['minimoonoir', 'dreamlab']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              minimoonoir: '#6366f1'
              dreamlab: '#c2410c'
        ui:
          color: '#6b8e23'
        showStats: true
        allowForumCreation: true

      - id: 'family-photos'
        name: 'Photos & Memories'
        description: 'Photo sharing and family memories'
        icon: ''
        order: 3
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['family', 'cross-access']
        calendar:
          access: 'none'
          canCreate: false
        ui:
          color: '#8b4513'
        showStats: false
        allowForumCreation: false

  # ============================================
  # ZONE 2: MINIMOONOIR (Friends & Visitors)
  # ============================================
  - id: 'minimoonoir'
    name: 'Minimoonoir'
    description: 'For friends and visitors staying with us'
    icon: ''
    order: 2

    # Zone-level access control
    access:
      visibleToCohorts: ['minimoonoir', 'minimoonoir-business', 'cross-access']
      hiddenFromCohorts: ['business-only']
      strictIsolation: false

    # Zone branding
    branding:
      displayName: 'Minimoonoir'
      tagline: 'Guest Stays & Adventures'
      primaryColor: '#8b5cf6'
      accentColor: '#a78bfa'
      heroImageUrl: '/images/zones/minimoonoir-hero.webp'
      logoUrl: '/images/zones/minimoonoir-logo.webp'

    ui:
      color: '#8b5cf6'

    sections:
      - id: 'minimoonoir-welcome'
        name: 'Welcome'
        description: 'Essential information for guests staying with us'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'guest'
          autoApprove: true
        calendar:
          access: 'full'
          canCreate: false
          showBlocksFrom: ['fairfield-family', 'dreamlab']
          blockDisplay:
            showSourceZone: true
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              dreamlab: '#c2410c'
        ui:
          color: '#8b5cf6'
        showStats: true
        allowForumCreation: false

      - id: 'minimoonoir-events'
        name: 'Events & Activities'
        description: 'Plan visits, activities, and local adventures'
        icon: ''
        order: 2
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['minimoonoir', 'minimoonoir-business', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['fairfield-family', 'dreamlab']
          blockDisplay:
            showSourceZone: true
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              dreamlab: '#c2410c'
        ui:
          color: '#a78bfa'
        showStats: true
        allowForumCreation: true

      - id: 'minimoonoir-booking'
        name: 'Stay Booking'
        description: 'Book your stay - 2 guest beds available in main house'
        icon: ''
        order: 3
        access:
          requiresApproval: false
          defaultRole: 'member'
          autoApprove: true
          requiredCohorts: ['minimoonoir', 'minimoonoir-business', 'cross-access']
        calendar:
          access: 'full'
          canCreate: true
          showBlocksFrom: ['fairfield-family', 'dreamlab']
          blockDisplay:
            showSourceZone: true
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              dreamlab: '#c2410c'
        ui:
          color: '#f59e0b'
        showStats: false
        allowForumCreation: false

  # ============================================
  # ZONE 3: DREAMLAB BUSINESS
  # ============================================
  - id: 'dreamlab'
    name: 'DreamLab'
    description: 'Business training and collaboration space'
    icon: ''
    order: 3

    # Zone-level access control - Business isolation
    access:
      visibleToCohorts: ['business', 'minimoonoir-business', 'trainers', 'trainees', 'cross-access']
      hiddenFromCohorts: ['family-only', 'minimoonoir-only']
      strictIsolation: true

    # Zone branding - DreamLab identity
    branding:
      displayName: 'DreamLab'
      tagline: 'Training & Innovation Hub'
      primaryColor: '#ec4899'
      accentColor: '#f472b6'
      heroImageUrl: '/images/zones/dreamlab-hero.webp'
      logoUrl: '/images/zones/dreamlab-logo.webp'

    ui:
      color: '#ec4899'

    sections:
      - id: 'dreamlab-lobby'
        name: 'DreamLab Lobby'
        description: 'Welcome area for business visitors and trainees'
        icon: ''
        order: 1
        access:
          requiresApproval: false
          defaultRole: 'guest'
          autoApprove: true
          requiredCohorts: ['business', 'minimoonoir-business', 'trainers', 'trainees', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: false
          cohortRestricted: true
          showBlocksFrom: ['fairfield-family', 'minimoonoir']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              minimoonoir: '#6366f1'
        ui:
          color: '#ec4899'
        showStats: true
        allowForumCreation: false

      - id: 'dreamlab-training'
        name: 'Training Rooms'
        description: 'Active training sessions and courses'
        icon: ''
        order: 2
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['trainers', 'trainees', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: true
          cohortRestricted: true
          showBlocksFrom: ['fairfield-family']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
        ui:
          color: '#db2777'
        showStats: true
        allowForumCreation: true
        branding:
          tagline: 'Active Training Sessions'

      - id: 'dreamlab-projects'
        name: 'Projects'
        description: 'Collaborative business projects'
        icon: ''
        order: 3
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['business', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: false
          cohortRestricted: true
        ui:
          color: '#a855f7'
        showStats: true
        allowForumCreation: true

      - id: 'dreamlab-bookings'
        name: 'Facility Booking'
        description: 'Book training rooms and equipment - admin managed'
        icon: ''
        order: 4
        access:
          requiresApproval: true
          defaultRole: 'member'
          autoApprove: false
          requiredCohorts: ['business', 'trainers', 'cross-access']
        calendar:
          access: 'cohort'
          canCreate: false
          cohortRestricted: true
          showBlocksFrom: ['fairfield-family', 'minimoonoir']
          blockDisplay:
            showSourceZone: false
            showReason: false
            zoneColours:
              fairfield-family: '#991b1b'
              minimoonoir: '#6366f1'
        ui:
          color: '#f97316'
        showStats: false
        allowForumCreation: false

# Calendar access levels
calendarAccessLevels:
  - id: 'full'
    name: 'Full Access'
    description: 'See all event details'
    canView: true
    canViewDetails: true

  - id: 'availability'
    name: 'Availability Only'
    description: 'See when slots are booked, not event details'
    canView: true
    canViewDetails: false

  - id: 'cohort'
    name: 'Cohort Restricted'
    description: 'Full details only for matching cohort members'
    canView: true
    canViewDetails: 'cohort-match'

  - id: 'none'
    name: 'No Access'
    description: 'Calendar hidden'
    canView: false
    canViewDetails: false

# Channel visibility options
channelVisibility:
  - id: 'public'
    name: 'Public'
    description: 'Visible to all section members'
  - id: 'cohort'
    name: 'Cohort Only'
    description: 'Visible only to specific cohorts'
  - id: 'invite'
    name: 'Invite Only'
    description: 'Private channel, invite required'
`,STORAGE_KEY="nostr_bbs_custom_config";let cachedConfig=null;function loadConfig(){if(cachedConfig)return cachedConfig;try{const t=localStorage.getItem(STORAGE_KEY);if(t){const e=JSON.parse(t);return validateConfig(e),cachedConfig=e,cachedConfig}}catch(t){console.warn("[Config] Invalid stored config, using default:",t)}try{return cachedConfig=parse$1(defaultConfigYaml),validateConfig(cachedConfig),cachedConfig}catch(t){return console.error("[Config] Failed to parse default config:",t),getDefaultConfig()}}function validateConfig(t){if(!t.app?.name)throw new Error("Missing app.name in configuration");if(!t.categories?.length)throw new Error("No categories defined in configuration");if(!t.roles?.length)throw new Error("No roles defined in configuration");const e=new Set(t.roles.map(n=>n.id));for(const n of t.categories)for(const r of n.sections)if(!e.has(r.access.defaultRole))throw new Error(`Section ${r.id} references unknown role: ${r.access.defaultRole}`)}function getDefaultConfig(){return{app:{name:"Nostr BBS",version:"2.0.0",defaultPath:"/general/welcome",tiers:[{level:1,name:"Category",plural:"Categories"},{level:2,name:"Section",plural:"Sections"},{level:3,name:"Forum",plural:"Forums"}]},roles:[{id:"guest",name:"Guest",level:0,description:"Basic authenticated user"},{id:"member",name:"Member",level:1,description:"Approved section member"},{id:"moderator",name:"Moderator",level:2,description:"Can manage forums and moderate",capabilities:["forum.create","forum.lock","message.pin","message.delete"]},{id:"section-admin",name:"Section Admin",level:3,description:"Section administrator",capabilities:["section.manage","member.approve","member.remove","forum.create","forum.delete","message.pin","message.delete"]},{id:"admin",name:"Admin",level:4,description:"Global administrator",capabilities:["admin.global","category.create","category.delete","section.create","section.delete","section.manage","member.approve","member.remove","forum.create","forum.delete","message.pin","message.delete","user.whitelist"]}],cohorts:[{id:"admin",name:"Administrators",description:"Global administrators"},{id:"approved",name:"Approved Users",description:"Manually approved"},{id:"members",name:"Community Members",description:"Core community members"}],categories:[{id:"general",name:"General",description:"Public discussion areas",icon:"",order:1,sections:[{id:"welcome",name:"Welcome",description:"Welcome area for new visitors",icon:"",order:1,access:{requiresApproval:!1,defaultRole:"guest",autoApprove:!0},calendar:{access:"full",canCreate:!1},ui:{color:"#6366f1"},showStats:!0,allowForumCreation:!1},{id:"announcements",name:"Announcements",description:"Official news and updates",icon:"",order:2,access:{requiresApproval:!1,defaultRole:"guest",autoApprove:!0},calendar:{access:"full",canCreate:!1},ui:{color:"#f59e0b"},showStats:!0,allowForumCreation:!1},{id:"help",name:"Help & Support",description:"Get help with using the platform",icon:"",order:3,access:{requiresApproval:!1,defaultRole:"guest",autoApprove:!0},calendar:{access:"none",canCreate:!1},ui:{color:"#10b981"},showStats:!0,allowForumCreation:!1}]},{id:"community",name:"Community",description:"Members-only discussion spaces",icon:"",order:2,sections:[{id:"discussions",name:"Discussions",description:"General member discussions",icon:"",order:1,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"full",canCreate:!0},ui:{color:"#8b5cf6"},showStats:!0,allowForumCreation:!0},{id:"introductions",name:"Introductions",description:"Introduce yourself",icon:"",order:2,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"none",canCreate:!1},ui:{color:"#06b6d4"},showStats:!0,allowForumCreation:!1},{id:"events",name:"Events",description:"Community events and meetups",icon:"",order:3,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"full",canCreate:!0},ui:{color:"#ec4899"},showStats:!0,allowForumCreation:!0}]},{id:"projects",name:"Projects",description:"Collaborative project spaces",icon:"",order:3,sections:[{id:"active-projects",name:"Active Projects",description:"Currently active project discussions",icon:"",order:1,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"availability",canCreate:!0,cohortRestricted:!0},ui:{color:"#ec4899"},showStats:!0,allowForumCreation:!0},{id:"resources",name:"Resources",description:"Shared files and documentation",icon:"",order:2,access:{requiresApproval:!0,defaultRole:"member",autoApprove:!1},calendar:{access:"none",canCreate:!1},ui:{color:"#84cc16"},showStats:!1,allowForumCreation:!1}]}],calendarAccessLevels:[{id:"full",name:"Full Access",description:"All details visible",canView:!0,canViewDetails:!0},{id:"availability",name:"Availability Only",description:"Dates only",canView:!0,canViewDetails:!1},{id:"cohort",name:"Cohort Restricted",description:"Cohort match required",canView:!0,canViewDetails:"cohort-match"},{id:"none",name:"No Access",description:"Hidden",canView:!1,canViewDetails:!1}],channelVisibility:[{id:"public",name:"Public",description:"All section members"},{id:"cohort",name:"Cohort Only",description:"Assigned cohorts"},{id:"invite",name:"Invite Only",description:"Explicit invites"}]}}const config=loadConfig();function getAppConfig(){return config.app}function getCategories(){return config.categories.sort((t,e)=>t.order-e.order)}function getCategory(t){return config.categories.find(e=>e.id===t)}function getSections(){return config.categories.flatMap(t=>t.sections.map(e=>({...e,_categoryId:t.id}))).sort((t,e)=>t.order-e.order)}function getSectionsByCategory(t){const e=getCategory(t);return e?e.sections.sort((n,r)=>n.order-r.order):[]}function getSection(t){for(const e of config.categories){const n=e.sections.find(r=>r.id===t);if(n)return n}}function getSectionWithCategory(t){for(const e of config.categories){const n=e.sections.find(r=>r.id===t);if(n)return{section:n,category:e}}}function getRole(t){return config.roles.find(e=>e.id===t)}function getBreadcrumbs(t,e,n){const r=[{label:"Home",path:"/",icon:""}];if(t){const s=getCategory(t);s&&r.push({label:s.name,path:`/${t}`,icon:s.icon})}if(e){const s=getSection(e);s&&r.push({label:s.name,path:`/${t}/${e}`,icon:s.icon})}return r}function getSectionConfigMap(){const t={};for(const e of getSections())t[e.id]=e;return t}const SECTION_CONFIG=getSectionConfigMap();export{hmac as A,secp256k1 as B,mod as C,Dexie as D,settingsStore as E,getActiveRelays as F,checkIfPWA as G,isPWAInstalled as H,initPWA as I,registerServiceWorker as J,getQueuedMessages as K,isOnline as L,triggerBackgroundSync as M,NDKEvent$1 as N,canInstall as O,triggerInstall as P,updateAvailable as Q,updateServiceWorker as R,SECTION_CONFIG as S,queuedMessageCount as T,getRole as U,loadConfig as V,getSectionConfigMap as W,index as X,auth as Y,_md as _,authStore as a,getSectionWithCategory as b,getBreadcrumbs as c,getCategories as d,getSection as e,nip19_exports$2 as f,getAppConfig as g,NDKPrivateKeySigner$1 as h,isAuthenticated as i,NDKCacheAdapterDexie as j,NDK as k,getCategory as l,getSections as m,nip44_exports as n,isReadOnly as o,getPublicKey as p,finalizeEvent as q,generateSecretKey as r,getSectionsByCategory as s,connectNDK as t,utils as u,getNDK as v,waitForNip07 as w,pbkdf2Async_1 as x,sha512 as y,sha256 as z};
