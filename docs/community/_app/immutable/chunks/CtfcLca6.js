import{ndk as g}from"./BTawUe4R.js";import"./C_zicc2g.js";import{e as h}from"./Do1Y_WLx.js";function v(t){if(!t.tags.find(e=>e[0]==="event"&&e[1]==="true"))return null;const r=t.tags.find(e=>e[0]==="event_start"),o=t.tags.find(e=>e[0]==="event_end");if(!r)return null;const s=t.tags.find(e=>e[0]==="event_location"),c=t.tags.find(e=>e[0]==="event_recurrence"),n=t.tags.find(e=>e[0]==="event_recurrence_end"),u=t.tags.find(e=>e[0]==="event_timezone");return{isEvent:!0,startDate:parseInt(r[1],10),endDate:parseInt(o?o[1]:r[1],10),location:s?.[1],recurrence:c?.[1]||"none",recurrenceEnd:n?parseInt(n[1],10):void 0,timezone:u?.[1]}}async function m(t){const i=g();if(!i)return null;try{const r={kinds:[40],ids:[t],limit:1},o=await i.fetchEvents(r),s=Array.from(o)[0];if(s){const c=s.tags.find(n=>n[0]==="section");if(c?.[1])return c[1]}return"public-lobby"}catch(r){return console.error("Failed to get channel section:",r),null}}async function k(t){const i=g();if(!i)return console.error("NDK not initialized"),[];try{const r={kinds:[9],limit:500},o=await i.fetchEvents(r),s=[];for(const c of o){const n=v(c);if(!n)continue;const e=c.tags.find(a=>a[0]==="h")?.[1];if(!e||await m(e)!==t)continue;const d={id:c.id,title:c.content.slice(0,100),description:c.content,start:n.startDate,end:n.endDate,location:n.location,channelId:e,sectionId:t,messageId:c.id,createdBy:c.pubkey,authorPubkey:c.pubkey,recurrence:n.recurrence,recurrenceEnd:n.recurrenceEnd,tags:c.tags.filter(a=>a[0]==="t").map(a=>a[1])};if(s.push(d),n.recurrence&&n.recurrence!=="none"){const a=p(d,n);s.push(...a)}}return s.sort((c,n)=>c.start-n.start)}catch(r){return console.error("Failed to fetch section events:",r),[]}}function p(t,i){const r=[],o=Math.floor(Date.now()/1e3),s=o+365*24*60*60,c=i.recurrenceEnd||s;let n=t.start,u=t.end;const e=u-n;let l=0;const d=52,f={none:0,daily:24*60*60,weekly:7*24*60*60,biweekly:14*24*60*60,monthly:30*24*60*60,yearly:365*24*60*60}[i.recurrence];if(!f)return r;for(;n+f<=c&&l<d;)n+=f,u=n+e,l++,n>o&&r.push({...t,id:`${t.id}-recurring-${l}`,start:n,end:u});return r}function w(t,i){const r=h(i);if(!r)return"none";const o=r.calendar;if(o.access==="none")return"none";if(o.cohortRestricted){const s=r.access.requiredCohorts||[];if(s.length>0&&!s.some(n=>t.includes(n)))return"availability"}return o.access}export{k as f,w as g};
