const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BTawUe4R.js","./Do1Y_WLx.js","./CmsKOCeN.js","./DjSB8mDa.js","./CwRy9Tox.js","./BToyndCo.js","./C_zicc2g.js","./DXx1QiHK.js","./CZb6OUdE.js"])))=>i.map(i=>d[i]);
import{_ as u}from"./CmsKOCeN.js";const f=new Map,E=5*60*1e3,g="wss://nostr-relay-617806532906.us-central1.run.app";function d(){return g.replace("wss://","https://").replace("ws://","http://")}async function m(t){if(!t)return h(t);const r=f.get(t);if(r&&r.expiresAt>Date.now())return{...r.status,source:"cache"};try{if(!/^[0-9a-f]{64}$/i.test(t))return console.warn("[Whitelist] Invalid pubkey format, using fallback"),h(t);const e=d(),s=await fetch(`${e}/api/check-whitelist?pubkey=${encodeURIComponent(t)}`,{method:"GET",headers:{Accept:"application/json"}});if(s.ok){const o=await s.json(),n={isWhitelisted:o.isWhitelisted??!1,isAdmin:o.isAdmin??!1,cohorts:o.cohorts??[],verifiedAt:o.verifiedAt??Date.now(),source:"relay"};return w(t,n),n}console.warn("[Whitelist] API call failed, using fallback");const a=h(t);return w(t,a),a}catch(e){return console.warn("[Whitelist] Verification failed, using fallback:",e),h(t)}}function h(t){const r="11ed64225dd5e2c5e18f61ad43d5ad9272d08739d3a20dd25886197b0738663c".split(",").map(s=>s.trim()).filter(Boolean),e=r.length>0&&r.includes(t);return{isWhitelisted:e,isAdmin:e,cohorts:e?["admin"]:[],verifiedAt:Date.now(),source:"fallback"}}function w(t,r){f.set(t,{status:r,expiresAt:Date.now()+E})}function _(t){t?f.delete(t):f.clear()}async function T(t,r){return(await m(t)).cohorts.includes(r)}async function v(t){const r=await m(t);return{isApproved:r.isWhitelisted,isAdmin:r.isAdmin}}async function y(t,r){try{const{ndk:e,connectRelay:s,isConnected:a}=await u(async()=>{const{ndk:i,connectRelay:l,isConnected:A}=await import("./BTawUe4R.js");return{ndk:i,connectRelay:l,isConnected:A}},__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url),{RELAY_URL:o}=await u(async()=>{const{RELAY_URL:i}=await import("./DXx1QiHK.js").then(l=>l.i);return{RELAY_URL:i}},__vite__mapDeps([7,6,1,2,3,4,5]),import.meta.url),{NDKEvent:n}=await u(async()=>{const{NDKEvent:i}=await import("./Do1Y_WLx.js").then(l=>l.X);return{NDKEvent:i}},__vite__mapDeps([1,2,3,4,5]),import.meta.url),{KIND_USER_REGISTRATION:R}=await u(async()=>{const{KIND_USER_REGISTRATION:i}=await import("./CZb6OUdE.js");return{KIND_USER_REGISTRATION:i}},__vite__mapDeps([8,1,2,3,4,5]),import.meta.url);a()||await s(o,t);const p=e();if(!p?.signer)return{success:!1,error:"Failed to set up signer"};const c=new n(p);return c.kind=R,c.content="New user registration request",c.tags=[["t","registration"]],r&&c.tags.push(["name",r]),await c.sign(),await c.publish(),{success:!0}}catch(e){return console.error("[Registration] Failed to publish registration request:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function L(t,r){try{const e=d(),s=await fetch(`${e}/api/whitelist/add`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pubkey:t,cohorts:["approved"],adminPubkey:r})});return s.ok?(_(t),{success:!0}):{success:!1,error:(await s.json().catch(()=>({}))).error||`HTTP ${s.status}`}}catch(e){return console.error("[Whitelist] Failed to approve registration:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function D(t){const r=d(),e=new URLSearchParams;t?.limit&&e.set("limit",String(t.limit)),t?.offset&&e.set("offset",String(t.offset)),t?.cohort&&e.set("cohort",t.cohort);const s=`${r}/api/whitelist/list?${e}`;try{const a=await fetch(s,{method:"GET",headers:{Accept:"application/json"}});if(a.ok){const n=await a.json();return{users:n.users||[],total:n.total||0,limit:n.limit||20,offset:n.offset||0}}const o=await a.text().catch(()=>"Unable to read error response");throw console.error("[Whitelist] Failed to fetch users:",a.status,o),new Error(`API returned ${a.status}: ${o.slice(0,100)}`)}catch(a){throw console.error("[Whitelist] Failed to fetch users:",a),a}}async function S(t,r,e){try{const s=d(),a=await fetch(`${s}/api/whitelist/update-cohorts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pubkey:t,cohorts:r,adminPubkey:e})});return a.ok?(_(t),{success:!0}):{success:!1,error:(await a.json().catch(()=>({}))).error||`HTTP ${a.status}`}}catch(s){return console.error("[Whitelist] Failed to update cohorts:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}export{m as a,L as b,v as c,D as f,y as p,S as u,T as v};
