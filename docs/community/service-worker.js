const l=self.__WB_MANIFEST,i="v2",p=`nostr-bbs-static-${i}`,h=`nostr-bbs-dynamic-${i}`,d=`nostr-bbs-profiles-${i}`,m=`nostr-bbs-fonts-${i}`,f=`nostr-bbs-api-${i}`,W=100,y=200,S=50,b=(l==null?void 0:l.length)>0?l.map(e=>e.url):["/","/index.html","/manifest.json","/favicon.ico"],C="nostr-bbs-queue",r="outgoing-messages",A=1;async function u(){return new Promise((e,t)=>{const s=indexedDB.open(C,A);s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result),s.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(r)||a.createObjectStore(r,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1})}})}async function _(e){const t=await u();return new Promise((s,n)=>{const o=t.transaction([r],"readwrite").objectStore(r).add(e);o.onsuccess=()=>s(),o.onerror=()=>n(o.error)})}async function E(){const e=await u();return new Promise((t,s)=>{const c=e.transaction([r],"readonly").objectStore(r).getAll();c.onsuccess=()=>t(c.result),c.onerror=()=>s(c.error)})}async function k(e){const t=await u();return new Promise((s,n)=>{const o=t.transaction([r],"readwrite").objectStore(r).delete(e);o.onsuccess=()=>s(),o.onerror=()=>n(o.error)})}async function M(){const e=await u();return new Promise((t,s)=>{const c=e.transaction([r],"readwrite").objectStore(r).clear();c.onsuccess=()=>t(),c.onerror=()=>s(c.error)})}self.addEventListener("install",e=>{console.log("[SW] Installing service worker..."),e.waitUntil((async()=>{await(await caches.open(p)).addAll(b),await self.skipWaiting()})())});self.addEventListener("activate",e=>{console.log("[SW] Activating service worker...");const t=[p,h,d,m,f];e.waitUntil((async()=>{const s=await caches.keys();await Promise.all(s.filter(n=>n.startsWith("nostr-bbs-")&&!t.includes(n)).map(n=>(console.log("[SW] Deleting old cache:",n),caches.delete(n)))),await self.clients.claim(),console.log("[SW] Service worker activated and claimed all clients")})())});function U(e){const t=e.pathname,s=e.hostname;return e.protocol==="wss:"||e.protocol==="ws:"?"network-only":s.includes("fonts.googleapis.com")||s.includes("fonts.gstatic.com")||t.endsWith(".woff2")||t.endsWith(".woff")||t.endsWith(".ttf")||t.endsWith(".otf")||t.endsWith(".js")||t.endsWith(".css")||t.endsWith(".html")||t.endsWith(".ico")||t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".webp")||t.endsWith(".svg")||t.endsWith(".json")||t.endsWith(".webmanifest")?"cache-first":t==="/"||t.startsWith("/chat")||t.startsWith("/dm")||t.startsWith("/settings")||t.startsWith("/events")||t.startsWith("/login")||t.startsWith("/signup")||t.includes("/avatar")||t.includes("/profile")||t.includes("/metadata")||t.includes("/user")||t.startsWith("/api")?"stale-while-revalidate":"network-first"}async function I(e,t){const s=await caches.match(e);if(s)return s;try{const n=await fetch(e);return n.ok&&(await caches.open(t)).put(e,n.clone()),n}catch(n){return console.error("[SW] Cache-first fetch failed:",n),new Response("Offline",{status:503})}}async function N(e,t){try{const s=await fetch(e);return s.ok&&(await caches.open(t)).put(e,s.clone()),s}catch{console.log("[SW] Network failed, trying cache...");const n=await caches.match(e);return n||new Response("Offline",{status:503})}}async function P(e,t){const s=await caches.match(e),n=fetch(e).then(a=>(a.ok&&caches.open(t).then(o=>o.put(e,a.clone())),a)).catch(()=>s||new Response("Offline",{status:503}));return s||n}function j(e){const t=e.hostname,s=e.pathname;return t.includes("fonts.googleapis.com")||t.includes("fonts.gstatic.com")||s.endsWith(".woff2")||s.endsWith(".woff")?m:s.includes("/avatar")||s.includes("/profile")||s.includes("/metadata")?d:s.startsWith("/api")?f:s.endsWith(".js")||s.endsWith(".css")||s.endsWith(".html")||s.endsWith(".png")||s.endsWith(".jpg")||s.endsWith(".svg")?p:h}async function w(e,t){const s=await caches.open(e),n=await s.keys();if(n.length>t){const a=n.slice(0,n.length-t);await Promise.all(a.map(c=>s.delete(c)))}}self.addEventListener("fetch",e=>{const t=new URL(e.request.url);if(e.request.method!=="GET")return;const s=U(t);if(s==="network-only")return;const n=j(t);e.respondWith((async()=>{switch(s){case"cache-first":return I(e.request,n);case"network-first":return N(e.request,n);case"stale-while-revalidate":return P(e.request,n);default:return fetch(e.request)}})()),e.waitUntil((async()=>{n===h?await w(h,W):n===d?await w(d,y):n===f&&await w(f,S)})())});self.addEventListener("sync",e=>{const t=e;t.tag==="sync-messages"&&t.waitUntil((async()=>{console.log("[SW] Background sync triggered");try{const s=await E();for(const a of s)try{(await Promise.allSettled(a.relayUrls.map(g=>fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(["EVENT",a.event])})))).some(g=>g.status==="fulfilled")&&await k(a.id)}catch(c){console.error("[SW] Failed to sync message:",c)}(await self.clients.matchAll()).forEach(a=>{a.postMessage({type:"SYNC_COMPLETE",count:s.length})})}catch(s){console.error("[SW] Background sync failed:",s)}})())});self.addEventListener("message",e=>{const{type:t,payload:s}=e.data;switch(t){case"QUEUE_MESSAGE":_(s).then(()=>{var n;(n=e.ports[0])==null||n.postMessage({success:!0})}).catch(n=>{var a;(a=e.ports[0])==null||a.postMessage({success:!1,error:n.message})});break;case"GET_QUEUE":E().then(n=>{var a;(a=e.ports[0])==null||a.postMessage({messages:n})}).catch(n=>{var a;(a=e.ports[0])==null||a.postMessage({error:n.message})});break;case"CLEAR_QUEUE":M().then(()=>{var n;(n=e.ports[0])==null||n.postMessage({success:!0})}).catch(n=>{var a;(a=e.ports[0])==null||a.postMessage({success:!1,error:n.message})});break;case"SKIP_WAITING":self.skipWaiting();break}});self.addEventListener("push",e=>{if(!e.data)return;const t=e.data.json();e.waitUntil(self.registration.showNotification(t.title,{body:t.body,icon:"/icon-192x192.png",badge:"/icon-192x192.png",tag:t.tag||"nostr-bbs",data:t.url}))});self.addEventListener("notificationclick",e=>{e.notification.close(),e.waitUntil(self.clients.matchAll({type:"window"}).then(t=>{const s=e.notification.data||"/";for(const n of t)if(n.url===s&&"focus"in n)return n.focus();if(self.clients.openWindow)return self.clients.openWindow(s)}))});console.log("[SW] Service worker loaded");
